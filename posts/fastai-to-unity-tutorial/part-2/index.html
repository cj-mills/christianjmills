<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christian Mills">
<meta name="dcterms.date" content="2022-06-07">
<meta name="description" content="Classify images in a Unity project with the Barracuda inference library.">

<title>Christian Mills - Fastai to Unity Beginner Tutorial Pt. 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../images/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Christian Mills - Fastai to Unity Beginner Tutorial Pt. 2">
<meta property="og:description" content="Classify images in a Unity project with the Barracuda inference library.">
<meta property="og:image" content="christianjmills.com/posts/fastai-to-unity-tutorial/part-2/images/logo.png">
<meta property="og:site-name" content="Christian Mills">
<meta name="twitter:title" content="Christian Mills - Fastai to Unity Beginner Tutorial Pt. 2">
<meta name="twitter:description" content="Classify images in a Unity project with the Barracuda inference library.">
<meta name="twitter:image" content="christianjmills.com/posts/fastai-to-unity-tutorial/part-2/images/logo.png">
<meta name="twitter:creator" content="@cdotjdotmills">
<meta name="twitter:site" content="@cdotjdotmills">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Christian Mills</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series/tutorials/index.html" rel="" target="">
 <span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series/notes/index.html" rel="" target="">
 <span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../services.html" rel="" target="">
 <span class="menu-text">Services</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:christian@christianjmills.com" rel="" target=""><i class="bi bi-envelope-fill" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cj-mills" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/cdotjdotmills" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../blog.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#set-up-unity-hub" id="toc-set-up-unity-hub" class="nav-link" data-scroll-target="#set-up-unity-hub">Set Up Unity Hub</a></li>
  <li><a href="#install-unity-editor" id="toc-install-unity-editor" class="nav-link" data-scroll-target="#install-unity-editor">Install Unity Editor</a></li>
  <li><a href="#create-new-project" id="toc-create-new-project" class="nav-link" data-scroll-target="#create-new-project">Create New Project</a></li>
  <li><a href="#install-barracuda-package" id="toc-install-barracuda-package" class="nav-link" data-scroll-target="#install-barracuda-package">Install Barracuda Package</a></li>
  <li><a href="#import-assets" id="toc-import-assets" class="nav-link" data-scroll-target="#import-assets">Import Assets</a></li>
  <li><a href="#create-image-classifier-script" id="toc-create-image-classifier-script" class="nav-link" data-scroll-target="#create-image-classifier-script">Create Image Classifier Script</a>
  <ul>
  <li><a href="#define-public-variables" id="toc-define-public-variables" class="nav-link" data-scroll-target="#define-public-variables">Define public variables</a></li>
  <li><a href="#define-private-variables" id="toc-define-private-variables" class="nav-link" data-scroll-target="#define-private-variables">Define private variables</a></li>
  <li><a href="#define-initialization-methods" id="toc-define-initialization-methods" class="nav-link" data-scroll-target="#define-initialization-methods">Define Initialization Methods</a></li>
  <li><a href="#define-start-method" id="toc-define-start-method" class="nav-link" data-scroll-target="#define-start-method">Define Start method</a></li>
  <li><a href="#define-processing-methods" id="toc-define-processing-methods" class="nav-link" data-scroll-target="#define-processing-methods">Define Processing Methods</a></li>
  <li><a href="#define-update-method" id="toc-define-update-method" class="nav-link" data-scroll-target="#define-update-method">Define Update method</a></li>
  <li><a href="#define-gui-methods" id="toc-define-gui-methods" class="nav-link" data-scroll-target="#define-gui-methods">Define GUI Methods</a></li>
  <li><a href="#define-ondisable-method" id="toc-define-ondisable-method" class="nav-link" data-scroll-target="#define-ondisable-method">Define OnDisable Method</a></li>
  </ul></li>
  <li><a href="#create-processing-shaders" id="toc-create-processing-shaders" class="nav-link" data-scroll-target="#create-processing-shaders">Create Processing Shaders</a>
  <ul>
  <li><a href="#create-compute-shader" id="toc-create-compute-shader" class="nav-link" data-scroll-target="#create-compute-shader">Create Compute Shader</a></li>
  <li><a href="#create-image-effect-shader" id="toc-create-image-effect-shader" class="nav-link" data-scroll-target="#create-image-effect-shader">Create Image Effect Shader</a></li>
  </ul></li>
  <li><a href="#set-up-unity-scene" id="toc-set-up-unity-scene" class="nav-link" data-scroll-target="#set-up-unity-scene">Set up Unity Scene</a></li>
  <li><a href="#test-in-editor" id="toc-test-in-editor" class="nav-link" data-scroll-target="#test-in-editor">Test in Editor</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Fastai to Unity Beginner Tutorial Pt. 2</h1>
  <div class="quarto-categories">
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">unity</div>
    <div class="quarto-category">barracuda</div>
    <div class="quarto-category">tutorial</div>
  </div>
  </div>

<div>
  <div class="description">
    Classify images in a Unity project with the <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/manual/index.html">Barracuda</a> inference library.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christian Mills </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 7, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#set-up-unity-hub">Set Up Unity Hub</a></li>
<li><a href="#install-unity-editor">Install Unity Editor</a></li>
<li><a href="#create-new-project">Create New Project</a></li>
<li><a href="#install-barracuda-package">Install Barracuda Package</a></li>
<li><a href="#import-assets">Import Assets</a></li>
<li><a href="#create-image-classifier-script">Create Image Classifier Script</a></li>
<li><a href="#create-processing-shaders">Create Processing Shaders</a></li>
<li><a href="#set-up-unity-scene">Set up Unity Scene</a></li>
<li><a href="#test-in-editor">Test in Editor</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p><a href="../part-1">Part 1</a> covered training an image classification model using the fastai library and exporting it to ONNX. In this post, we’ll cover implementing a trained image classification model in a Unity project using the Barracuda library.</p>
</section>
<section id="set-up-unity-hub" class="level2">
<h2 class="anchored" data-anchor-id="set-up-unity-hub">Set Up Unity Hub</h2>
<p>Before creating a project, we need to install <a href="https://unity3d.com/get-unity/download">Unity Hub</a>, create a <a href="https://id.unity.com/">UnityID account</a>, and activate a (free) Unity license. The beginner Unity tutorial linked below covers all these steps and how to create a simple flappy bird-style game.</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=8rdfcq-jePw&amp;t=113s">Make Your First Video Game - Ultimate Beginner Unity3D Tutorial</a></li>
</ul>
<p>The link opens to the part covering how to install Unity for the first time, but I recommend watching the entire tutorial for those new to Unity.</p>
</section>
<section id="install-unity-editor" class="level2">
<h2 class="anchored" data-anchor-id="install-unity-editor">Install Unity Editor</h2>
<p>Once we have Unity Hub installed and an activated license, we need to install a version of the Unity Editor. We will use the latest 2022.1+ release as early versions have some issues building WebGL projects with Barracuda. The tutorial uses 2022.1.3.f1, which you can install directly from the link below.</p>
<ul>
<li><strong>Unity download archive:</strong> <a href="unityhub://2022.1.3f1/1cedbfe38737">Unity 2022.1.3</a></li>
</ul>
<p>Open Unity Hub and select the <code>Installs</code> section in the side panel. Then click the <code>Install Editor</code> button in the upper right-hand corner.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-installs.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Click the <code>Install</code> button next to the latest <code>2022.1</code> version under <code>Other Versions</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-installs-select-2022-1-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Scroll down the <code>Add modules</code> selection menu and click the check box next to <code>WebGL Build Support</code>. Feel free to add any additional target platforms here as well. Click the <code>Install</code> button after selecting all desired modules.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-install-2022-1-3-with-webgl.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Unity Hub will begin downloading and installing the selected editor version. If the install fails the first time, click the retry button, and it should complete successfully.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-install-editor-failed-message.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="create-new-project" class="level2">
<h2 class="anchored" data-anchor-id="create-new-project">Create New Project</h2>
<p>Go back to the Projects section after the editor finishes installing and click New Project.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-new-project.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Select the target editor version from the Editor Version dropdown menu.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-new-project-select-unity-version.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Select the 2D Core template.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-new-project-select-2D-template.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Pick a name for the project and a location for the project folder.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-new-project-name-project.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Finally, click Create Project in the lower right-hand corner.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-hub-new-project-click-create-project.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="install-barracuda-package" class="level2">
<h2 class="anchored" data-anchor-id="install-barracuda-package">Install Barracuda Package</h2>
<p>Inside the editor window, we’ll first install the Barracuda package. Select <code>Window → Package Manager</code> from the top menu.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-open-package-manager.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>In the Package Manager window, click the little <code>+</code> sign in the upper left-hand corner and select <code>Add package from git URL...</code> from the dropdown menu.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-package-manager-add-from-git.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Enter <code>com.unity.barracuda</code> into the text box and click <code>Add</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-package-manager-add-barracuda.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Wait for the Barracuda package to install and close the Package Manager window.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-package-manager-installing-barracuda-please-wait.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="import-assets" class="level2">
<h2 class="anchored" data-anchor-id="import-assets">Import Assets</h2>
<p>Next, we’ll import any ONNX, JSON, and test image files into the Assets folder. Right-click a space in the Assets section and select <code>Create → Folder</code> from the popup menu.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-folder.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Name the new folder Models.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-models-folder.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Drag and drop any ONNX files and JSON class label files from the operating system’s file explorer into the Models folder. Sample files are available in the Google Drive link below.</p>
<ul>
<li><strong>Google Drive:</strong> <a href="https://drive.google.com/drive/folders/1VCDqvkBiHOJX5Xe64Ay3Y2ARz4ZBmqCw?usp=sharing">Model Assets</a></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-import-model-assets.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>We can click on an ONNX file to examine it in the Inspector tab on the right-hand side of the editor window.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-inspect-model-asset.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>When <a href="https://netron.app/">Netron</a> is available, we can double-click on the ONNX file to open it in Netron.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-inspect-model-asset-netron.png" class="img-fluid figure-img"></p>
</figure>
</div>
<div style="overflow-y:auto; max-height:500px">
<pre><code>&lt;img src="./images/asl-and-some-words-resnet18.png" alt="asl-and-some-words-resnet18"&gt;</code></pre>
</div>
<p>Next, create an Images folder and drop any test images into it.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-images-folder.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Maybe stick with symmetrical hand signs (e.g., Play) since the model expects mirrored input images.</p>
<p><strong>Google Drive:</strong> <a href="https://drive.google.com/drive/folders/1MyMQZzLx_PoCl3vArCjMqRWQkVyf99Cz?usp=sharing">Image Assets</a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-import-image-assets.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Unity automatically imports images as a Sprite (2D and UI) <a href="https://docs.unity3d.com/Manual/TextureTypes.html">texture type</a>. We don’t need to change it for our purposes.</p>
</section>
<section id="create-image-classifier-script" class="level2">
<h2 class="anchored" data-anchor-id="create-image-classifier-script">Create Image Classifier Script</h2>
<p>Now we can start coding. We’ll store C# scripts in a new Scripts folder. Right-click a space inside it and select <code>Create → C# Script</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-c-sharp-script.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>We’ll name the script <code>ImageClassifier</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-image-classifier-script.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Default script code</strong></p>
<p>By default, C# scripts contain the following code.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Collections</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Collections</span><span class="op">.</span><span class="fu">Generic</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> UnityEngine<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ImageClassifier <span class="op">:</span> MonoBehaviour</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start is called before the first frame update</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">Start</span><span class="op">()</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update is called once per frame</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">Update</span><span class="op">()</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Add required namespaces</strong></p>
<ul>
<li><a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.html">Unity.Barracuda</a>: Provides access to the Barracuda API.</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system?view=net-5.0">System</a>: Contains fundamental classes and base classes that define commonly-used value and reference data types, events and event handlers, interfaces, attributes, and processing exceptions.</li>
<li><a href="https://docs.unity3d.com/Packages/com.unity.ugui@1.0/api/UnityEngine.UI.html">UnityEngine.UI</a>: Provides access to UI elements.</li>
<li><a href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.core@5.9/api/UnityEngine.Rendering.html">UnityEngine.Rendering</a>: Provides access to the elements of the rendering pipeline.</li>
</ul>
<hr>
<div class="sourceCode" id="cb3"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Collections</span><span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Collections</span><span class="op">.</span><span class="fu">Generic</span><span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> UnityEngine<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Unity<span class="op">.</span><span class="fu">Barracuda</span><span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> UnityEngine<span class="op">.</span><span class="fu">Rendering</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> UnityEngine<span class="op">.</span><span class="fu">UI</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="define-public-variables" class="level3">
<h3 class="anchored" data-anchor-id="define-public-variables">Define public variables</h3>
<p>We’ll add the required public variables above the Start method. We will be able to access these variables in the Inspector tab. We can add <a href="https://docs.unity3d.com/ScriptReference/HeaderAttribute.html">Header</a> attributes to organize the public variables in the Inspector tab and use <a href="https://docs.unity3d.com/ScriptReference/TooltipAttribute.html">Tooltip</a> attributes to provide information about variables.</p>
<p><strong>Define scene object variables</strong></p>
<p>First, we need a variable to access the screen object that displays either a test image or webcam input.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Scene Objects"</span><span class="op">)]</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The Screen object for the scene"</span><span class="op">)]</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Transform screen<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define data processing variables</strong></p>
<p>Next, we’ll define the variables for processing model input. We can set the default target input resolution to 216 and use it to scale the source resolution while maintaining the original aspect ratio.</p>
<p>The only preprocessing step we need to implement is normalizing images using the ImageNet stats. The fastest way to do this is with shaders. Shaders are programs that run on the GPU. We will implement ImageNet normalization in a <a href="https://docs.unity3d.com/Manual/class-ComputeShader.html">Compute Shader</a> and a <a href="https://docs.unity3d.com/Manual/SL-VertexFragmentShaderExamples.html">Fragment shader</a> to account for platform support. We attach a Fragment shader to a <a href="https://docs.unity3d.com/Manual/Materials.html">Material</a>, so that is what we’ll pass into the script.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Data Processing"</span><span class="op">)]</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The target minimum model input dimensions"</span><span class="op">)]</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> targetDim <span class="op">=</span> <span class="dv">216</span><span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The compute shader for GPU processing"</span><span class="op">)]</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> ComputeShader processingShader<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The material with the fragment shader for GPU processing"</span><span class="op">)]</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Material processingMaterial<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define Barracuda variables</strong></p>
<p>We’ll add the required private variables right below the public variables. We pass in ONNX files as an <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.NNModel.html">NNModel</a> object.</p>
<p>We’ll be adding a SoftMax and an Argmax layer to the end of the model, so we need to define names for those. We need to indicate the output layer we want to modify with the new layers. In our case, there is only one output layer.</p>
<p>By default, Barracuda uses a channels-last order for Tensors. However, switching to channels first can significantly improve performance on some GPUs.</p>
<p>We can choose from <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.WorkerFactory.Type.html">several</a> different inference backends (Although we’ll only want to use two in practice). The Auto option will automatically pick the best backend for the target platform.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Barracuda"</span><span class="op">)]</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The Barracuda/ONNX asset file"</span><span class="op">)]</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> NNModel modelAsset<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The name for the custom softmax output layer"</span><span class="op">)]</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">string</span> softmaxLayer <span class="op">=</span> <span class="st">"softmaxLayer"</span><span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The name for the custom softmax output layer"</span><span class="op">)]</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">string</span> argmaxLayer <span class="op">=</span> <span class="st">"argmaxLayer"</span><span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The target output layer index"</span><span class="op">)]</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> outputLayerIndex <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"EXPERIMENTAL: Indicate whether to order tensor data channels first"</span><span class="op">)]</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> useNCHW <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The model execution backend"</span><span class="op">)]</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> WorkerFactory<span class="op">.</span><span class="fu">Type</span> workerType <span class="op">=</span> WorkerFactory<span class="op">.</span><span class="fu">Type</span><span class="op">.</span><span class="fu">Auto</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define output processing variables</strong></p>
<p>As mentioned in a <a href="../../deep-learning-unity-intro/">previous post</a>, reading model output from the GPU to the CPU can cause a significant performance bottleneck. Therefore, we will add the option to read the model output asynchronously at the cost of a few frames of latency. Unfortunately, this feature does not work with the inference backend used for WebGL builds.</p>
<p>We pass in the JSON file containing the class labels as a <a href="https://docs.unity3d.com/ScriptReference/TextAsset.html">TextAsset</a>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Output Processing"</span><span class="op">)]</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Asynchronously download model output from the GPU to the CPU."</span><span class="op">)]</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> useAsyncGPUReadback <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"A json file containing the class labels"</span><span class="op">)]</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> TextAsset classLabels<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for debugging</strong></p>
<p>Next, we’ll add a Boolean variable to toggle printing debug messages to the console. These messages get printed to the console in the browser as well.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Debugging"</span><span class="op">)]</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Print debugging messages to the console"</span><span class="op">)]</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> printDebugMessages <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define webcam variables</strong></p>
<p>We need to specify a desired resolution and framerate when using a webcam as input.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Webcam"</span><span class="op">)]</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Use a webcam as input"</span><span class="op">)]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> useWebcam <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The requested webcam dimensions"</span><span class="op">)]</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Vector2Int webcamDims <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector2Int</span><span class="op">(</span><span class="dv">1280</span><span class="op">,</span> <span class="dv">720</span><span class="op">);</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The requested webcam framerate"</span><span class="op">)]</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">60</span><span class="op">)]</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> webcamFPS <span class="op">=</span> <span class="dv">60</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for user interface</strong></p>
<p>We’ll make a simple GUI that displays the predicted class, the current framerate, and controls for selecting webcam devices.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"GUI"</span><span class="op">)]</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Display predicted class"</span><span class="op">)]</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> displayPredictedClass <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Display fps"</span><span class="op">)]</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> displayFPS <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The on-screen text color"</span><span class="op">)]</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Color textColor <span class="op">=</span> Color<span class="op">.</span><span class="fu">red</span><span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The scale value for the on-screen font size"</span><span class="op">)]</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">99</span><span class="op">)]</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> fontScale <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The number of seconds to wait between refreshing the fps value"</span><span class="op">)]</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Range</span><span class="op">(</span><span class="fl">0.01f</span><span class="op">,</span> <span class="fl">1.0f</span><span class="op">)]</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">float</span> fpsRefreshRate <span class="op">=</span> <span class="fl">0.1f</span><span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The toggle for using a webcam as the input source"</span><span class="op">)]</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Toggle useWebcamToggle<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The dropdown menu that lists available webcam devices"</span><span class="op">)]</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Dropdown webcamDropdown<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-private-variables" class="level3">
<h3 class="anchored" data-anchor-id="define-private-variables">Define private variables</h3>
<p>We’ll add the required private variables right below the public variables.</p>
<p><strong>Define private webcam variables</strong></p>
<p>We’ll keep a list of available webcam devices so users can switch between them. Unity renders webcam input to a <a href="https://docs.unity3d.com/ScriptReference/WebCamTexture.html">WebcamTexture</a>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// List of available webcam devices</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> WebCamDevice<span class="op">[]</span> webcamDevices<span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Live video input from a webcam</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> WebCamTexture webcamTexture<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">// The name of the current webcam  device</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">string</span> currentWebcam<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define input variables</strong></p>
<p>We’ll update the dimensions and content of the screen object based on the test image or webcam.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The test image dimensions</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Vector2Int imageDims<span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">// The test image texture</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Texture imageTexture<span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">// The current screen object dimensions</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Vector2Int screenDims<span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">// The model input texture</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> RenderTexture inputTexture<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define Barracuda variables</strong></p>
<p>We execute models in Barracuda using an <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.IWorker.html">IWorker</a>interface and store data in <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.Tensor.html">Tensor</a> objects.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The main interface to execute models</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> IWorker engine<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores the input data for the model</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Tensor input<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for handling asynchronous GPU readback</strong></p>
<p>When using asynchronous GPU readback, we need one Texture that stores data on the GPU and one that stores data on the CPU.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores the raw model output on the GPU when using useAsyncGPUReadback</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> RenderTexture outputTextureGPU<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores the raw model output on the CPU when using useAsyncGPUReadback</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Texture2D outputTextureCPU<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for tracking class labels</strong></p>
<p>We need to create a little class that indicates the structure of the JSON content. Our JSON file only contains a single array of strings. We can store this array in a dedicated variable.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A class for reading in class labels from a JSON file</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ClassLabels <span class="op">{</span> <span class="kw">public</span> <span class="dt">string</span><span class="op">[]</span> classes<span class="op">;</span> <span class="op">}</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">// The ordered list of class names</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">string</span><span class="op">[]</span> classes<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores the predicted class index</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">int</span> classIndex<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for tracking the framerate</strong></p>
<p>Lastly, we need to define a couple of variables for the custom fps counter.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The current frame rate value</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">int</span> fps <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Controls when the frame rate value updates</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">float</span> fpsTimer <span class="op">=</span> 0f<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-initialization-methods" class="level3">
<h3 class="anchored" data-anchor-id="define-initialization-methods">Define Initialization Methods</h3>
<p>We first need to define some methods to initialize webcams, the screen object, any GUI dropdown menus, and the in-game camera.</p>
<p><strong>Define method to initialize a webcam device</strong></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Initialize the selected webcam device</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"deviceName"</span><span class="kw">&gt;</span><span class="co">The name of the selected webcam device</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">InitializeWebcam</span><span class="op">(</span><span class="dt">string</span> deviceName<span class="op">)</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stop any webcams already playing</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>webcamTexture <span class="op">&amp;&amp;</span> webcamTexture<span class="op">.</span><span class="fu">isPlaying</span><span class="op">)</span> webcamTexture<span class="op">.</span><span class="fu">Stop</span><span class="op">();</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create a new WebCamTexture</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    webcamTexture <span class="op">=</span> <span class="kw">new</span> <span class="fu">WebCamTexture</span><span class="op">(</span>deviceName<span class="op">,</span> webcamDims<span class="op">.</span><span class="fu">x</span><span class="op">,</span> webcamDims<span class="op">.</span><span class="fu">y</span><span class="op">,</span> webcamFPS<span class="op">);</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start the webcam</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    webcamTexture<span class="op">.</span><span class="fu">Play</span><span class="op">();</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if webcam is playing</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    useWebcam <span class="op">=</span> webcamTexture<span class="op">.</span><span class="fu">isPlaying</span><span class="op">;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update toggle value</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    useWebcamToggle<span class="op">.</span><span class="fu">SetIsOnWithoutNotify</span><span class="op">(</span>useWebcam<span class="op">);</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>useWebcam <span class="op">?</span> <span class="st">"Webcam is playing"</span> <span class="op">:</span> <span class="st">"Webcam not playing, option disabled"</span><span class="op">);</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to initialize the in-scene screen object</strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Resize and position an in-scene screen object</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">InitializeScreen</span><span class="op">()</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the texture for the screen object</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    screen<span class="op">.</span><span class="fu">gameObject</span><span class="op">.</span><span class="fu">GetComponent</span><span class="op">&lt;</span>MeshRenderer<span class="op">&gt;().</span><span class="fu">material</span><span class="op">.</span><span class="fu">mainTexture</span> <span class="op">=</span> useWebcam <span class="op">?</span> webcamTexture <span class="op">:</span> imageTexture<span class="op">;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the screen dimensions</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    screenDims <span class="op">=</span> useWebcam <span class="op">?</span> <span class="kw">new</span> <span class="fu">Vector2Int</span><span class="op">(</span>webcamTexture<span class="op">.</span><span class="fu">width</span><span class="op">,</span> webcamTexture<span class="op">.</span><span class="fu">height</span><span class="op">)</span> <span class="op">:</span> imageDims<span class="op">;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Flip the screen around the Y-Axis when using webcam</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> yRotation <span class="op">=</span> useWebcam <span class="op">?</span> 180f <span class="op">:</span> 0f<span class="op">;</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Invert the scale value for the Z-Axis when using webcam</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> zScale <span class="op">=</span> useWebcam <span class="op">?</span> <span class="op">-</span>1f <span class="op">:</span> 1f<span class="op">;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set screen rotation</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    screen<span class="op">.</span><span class="fu">rotation</span> <span class="op">=</span> Quaternion<span class="op">.</span><span class="fu">Euler</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> yRotation<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust the screen dimensions</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    screen<span class="op">.</span><span class="fu">localScale</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector3</span><span class="op">(</span>screenDims<span class="op">.</span><span class="fu">x</span><span class="op">,</span> screenDims<span class="op">.</span><span class="fu">y</span><span class="op">,</span> zScale<span class="op">);</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust the screen position</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    screen<span class="op">.</span><span class="fu">position</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector3</span><span class="op">(</span>screenDims<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> screenDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to initialize GUI dropdown menu options</strong></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Initialize the GUI dropdown list</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">InitializeDropdown</span><span class="op">()</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create list of webcam device names</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> webcamNames <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;();</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> <span class="op">(</span>WebCamDevice device <span class="kw">in</span> webcamDevices<span class="op">)</span> webcamNames<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>device<span class="op">.</span><span class="fu">name</span><span class="op">);</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove default dropdown options</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    webcamDropdown<span class="op">.</span><span class="fu">ClearOptions</span><span class="op">();</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add webcam device names to dropdown menu</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    webcamDropdown<span class="op">.</span><span class="fu">AddOptions</span><span class="op">(</span>webcamNames<span class="op">);</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the value for the dropdown to the current webcam device</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    webcamDropdown<span class="op">.</span><span class="fu">SetValueWithoutNotify</span><span class="op">(</span>webcamNames<span class="op">.</span><span class="fu">IndexOf</span><span class="op">(</span>currentWebcam<span class="op">));</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to initialize the in-scene camera object</strong></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Resize and position the main camera based on an in-scene screen object</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"screenDims"</span><span class="kw">&gt;</span><span class="co">The dimensions of an in-scene screen object</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">InitializeCamera</span><span class="op">(</span>Vector2Int screenDims<span class="op">,</span> <span class="dt">string</span> cameraName <span class="op">=</span> <span class="st">"Main Camera"</span><span class="op">)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get a reference to the Main Camera GameObject</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    GameObject camera <span class="op">=</span> GameObject<span class="op">.</span><span class="fu">Find</span><span class="op">(</span>cameraName<span class="op">);</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust the camera position to account for updates to the screenDims</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    camera<span class="op">.</span><span class="fu">transform</span><span class="op">.</span><span class="fu">position</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector3</span><span class="op">(</span>screenDims<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> screenDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="op">-</span>10f<span class="op">);</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render objects with no perspective (i.e. 2D)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    camera<span class="op">.</span><span class="fu">GetComponent</span><span class="op">&lt;</span>Camera<span class="op">&gt;().</span><span class="fu">orthographic</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust the camera size to account for updates to the screenDims</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    camera<span class="op">.</span><span class="fu">GetComponent</span><span class="op">&lt;</span>Camera<span class="op">&gt;().</span><span class="fu">orthographicSize</span> <span class="op">=</span> screenDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to initialize a Barracuda inference interface</strong></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Initialize an interface to execute the specified model using the specified backend</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"model"</span><span class="kw">&gt;</span><span class="co">The target model representation</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"workerType"</span><span class="kw">&gt;</span><span class="co">The target compute backend</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"useNCHW"</span><span class="kw">&gt;</span><span class="co">EXPERIMENTAL: The channel order for the compute backend</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> IWorker <span class="fu">InitializeWorker</span><span class="op">(</span>Model model<span class="op">,</span> WorkerFactory<span class="op">.</span><span class="fu">Type</span> workerType<span class="op">,</span> <span class="dt">bool</span> useNCHW <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validate the selected worker type</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    workerType <span class="op">=</span> WorkerFactory<span class="op">.</span><span class="fu">ValidateType</span><span class="op">(</span>workerType<span class="op">);</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the channel order of the compute backend to channel-first</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>useNCHW<span class="op">)</span> ComputeInfo<span class="op">.</span><span class="fu">channelsOrder</span> <span class="op">=</span> ComputeInfo<span class="op">.</span><span class="fu">ChannelsOrder</span><span class="op">.</span><span class="fu">NCHW</span><span class="op">;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create a worker to execute the model using the selected backend</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> WorkerFactory<span class="op">.</span><span class="fu">CreateWorker</span><span class="op">(</span>workerType<span class="op">,</span> model<span class="op">);</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-start-method" class="level3">
<h3 class="anchored" data-anchor-id="define-start-method">Define Start method</h3>
<p>The <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.Start.html">Start</a> method is <a href="https://docs.unity3d.com/Manual/ExecutionOrder.html">called</a> once before the first frame update, so we’ll perform any required setup steps here.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Start is called before the first frame update</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">Start</span><span class="op">()</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the source image texture</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    imageTexture <span class="op">=</span> screen<span class="op">.</span><span class="fu">gameObject</span><span class="op">.</span><span class="fu">GetComponent</span><span class="op">&lt;</span>MeshRenderer<span class="op">&gt;().</span><span class="fu">material</span><span class="op">.</span><span class="fu">mainTexture</span><span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the source image dimensions as a Vector2Int</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    imageDims <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector2Int</span><span class="op">(</span>imageTexture<span class="op">.</span><span class="fu">width</span><span class="op">,</span> imageTexture<span class="op">.</span><span class="fu">height</span><span class="op">);</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize list of available webcam devices</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    webcamDevices <span class="op">=</span> WebCamTexture<span class="op">.</span><span class="fu">devices</span><span class="op">;</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> <span class="op">(</span>WebCamDevice device <span class="kw">in</span> webcamDevices<span class="op">)</span> Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>device<span class="op">.</span><span class="fu">name</span><span class="op">);</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    currentWebcam <span class="op">=</span> webcamDevices<span class="op">[</span><span class="dv">0</span><span class="op">].</span><span class="fu">name</span><span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    useWebcam <span class="op">=</span> webcamDevices<span class="op">.</span><span class="fu">Length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> useWebcam <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize webcam</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>useWebcam<span class="op">)</span> <span class="fu">InitializeWebcam</span><span class="op">(</span>currentWebcam<span class="op">);</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize and position the screen object using the source image dimensions</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeScreen</span><span class="op">();</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize and position the main camera using the source image dimensions</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeCamera</span><span class="op">(</span>screenDims<span class="op">);</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get an object oriented representation of the model</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    Model m_RunTimeModel <span class="op">=</span> ModelLoader<span class="op">.</span><span class="fu">Load</span><span class="op">(</span>modelAsset<span class="op">);</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the name of the target output layer</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">string</span> outputLayer <span class="op">=</span> m_RunTimeModel<span class="op">.</span><span class="fu">outputs</span><span class="op">[</span>outputLayerIndex<span class="op">];</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create a model builder to modify the m_RunTimeModel</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    ModelBuilder modelBuilder <span class="op">=</span> <span class="kw">new</span> <span class="fu">ModelBuilder</span><span class="op">(</span>m_RunTimeModel<span class="op">);</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add a new Softmax layer</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    modelBuilder<span class="op">.</span><span class="fu">Softmax</span><span class="op">(</span>softmaxLayer<span class="op">,</span> outputLayer<span class="op">);</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add a new Argmax layer</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    modelBuilder<span class="op">.</span><span class="fu">Reduce</span><span class="op">(</span>Layer<span class="op">.</span><span class="fu">Type</span><span class="op">.</span><span class="fu">ArgMax</span><span class="op">,</span> argmaxLayer<span class="op">,</span> softmaxLayer<span class="op">);</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the interface for executing the model</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    engine <span class="op">=</span> <span class="fu">InitializeWorker</span><span class="op">(</span>modelBuilder<span class="op">.</span><span class="fu">model</span><span class="op">,</span> workerType<span class="op">,</span> useNCHW<span class="op">);</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the GPU output texture</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    outputTextureGPU <span class="op">=</span> RenderTexture<span class="op">.</span><span class="fu">GetTemporary</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> RenderTextureFormat<span class="op">.</span><span class="fu">ARGBHalf</span><span class="op">);</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the CPU output texture</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    outputTextureCPU <span class="op">=</span> <span class="kw">new</span> <span class="fu">Texture2D</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> TextureFormat<span class="op">.</span><span class="fu">RGBAHalf</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize list of class labels from JSON file</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    classes <span class="op">=</span> JsonUtility<span class="op">.</span><span class="fu">FromJson</span><span class="op">&lt;</span>ClassLabels<span class="op">&gt;(</span>classLabels<span class="op">.</span><span class="fu">text</span><span class="op">).</span><span class="fu">classes</span><span class="op">;</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the webcam dropdown list</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeDropdown</span><span class="op">();</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-processing-methods" class="level3">
<h3 class="anchored" data-anchor-id="define-processing-methods">Define Processing Methods</h3>
<p>Next, we need to define methods to process images using the Compute Shader, calculate the input resolution, handle asynchronous GPU readback, and process raw model output.</p>
<p><strong>Define method to process images using a compute shader</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Process the provided image using the specified function on the GPU</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"image"</span><span class="kw">&gt;</span><span class="co">The target image RenderTexture</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"computeShader"</span><span class="kw">&gt;</span><span class="co">The target ComputerShader</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"functionName"</span><span class="kw">&gt;</span><span class="co">The target ComputeShader function</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">ProcessImageGPU</span><span class="op">(</span>RenderTexture image<span class="op">,</span> ComputeShader computeShader<span class="op">,</span> <span class="dt">string</span> functionName<span class="op">)</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Specify the number of threads on the GPU</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> numthreads <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the index for the specified function in the ComputeShader</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> kernelHandle <span class="op">=</span> computeShader<span class="op">.</span><span class="fu">FindKernel</span><span class="op">(</span>functionName<span class="op">);</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define a temporary HDR RenderTexture</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    RenderTexture result <span class="op">=</span> RenderTexture<span class="op">.</span><span class="fu">GetTemporary</span><span class="op">(</span>image<span class="op">.</span><span class="fu">width</span><span class="op">,</span> image<span class="op">.</span><span class="fu">height</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> RenderTextureFormat<span class="op">.</span><span class="fu">ARGBHalf</span><span class="op">);</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Enable random write access</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span><span class="fu">enableRandomWrite</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create the HDR RenderTexture</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span><span class="fu">Create</span><span class="op">();</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the value for the Result variable in the ComputeShader</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    computeShader<span class="op">.</span><span class="fu">SetTexture</span><span class="op">(</span>kernelHandle<span class="op">,</span> <span class="st">"Result"</span><span class="op">,</span> result<span class="op">);</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the value for the InputImage variable in the ComputeShader</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    computeShader<span class="op">.</span><span class="fu">SetTexture</span><span class="op">(</span>kernelHandle<span class="op">,</span> <span class="st">"InputImage"</span><span class="op">,</span> image<span class="op">);</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execute the ComputeShader</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    computeShader<span class="op">.</span><span class="fu">Dispatch</span><span class="op">(</span>kernelHandle<span class="op">,</span> result<span class="op">.</span><span class="fu">width</span> <span class="op">/</span> numthreads<span class="op">,</span> result<span class="op">.</span><span class="fu">height</span> <span class="op">/</span> numthreads<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy the result into the source RenderTexture</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    Graphics<span class="op">.</span><span class="fu">Blit</span><span class="op">(</span>result<span class="op">,</span> image<span class="op">);</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Release the temporary RenderTexture</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    RenderTexture<span class="op">.</span><span class="fu">ReleaseTemporary</span><span class="op">(</span>result<span class="op">);</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to calculate input resolution</strong></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Scale the source image resolution to the target input dimensions</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// while maintaing the source aspect ratio.</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"imageDims"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"targetDims"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Vector2Int <span class="fu">CalculateInputDims</span><span class="op">(</span>Vector2Int imageDims<span class="op">,</span> <span class="dt">int</span> targetDim<span class="op">)</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clamp the minimum dimension value to 64px</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    targetDim <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>targetDim<span class="op">,</span> <span class="dv">64</span><span class="op">);</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    Vector2Int inputDims <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector2Int</span><span class="op">();</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate the input dimensions using the target minimum dimension</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>imageDims<span class="op">.</span><span class="fu">x</span> <span class="op">&gt;=</span> imageDims<span class="op">.</span><span class="fu">y</span><span class="op">)</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>imageDims<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> <span class="op">((</span><span class="dt">float</span><span class="op">)</span>imageDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>targetDim<span class="op">));</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        inputDims<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> targetDim<span class="op">;</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> targetDim<span class="op">;</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        inputDims<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>imageDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="op">((</span><span class="dt">float</span><span class="op">)</span>imageDims<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>targetDim<span class="op">));</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> inputDims<span class="op">;</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to handle asynchronous GPU readback</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Called once AsyncGPUReadback has been completed</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"request"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">OnCompleteReadback</span><span class="op">(</span>AsyncGPUReadbackRequest request<span class="op">)</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>request<span class="op">.</span><span class="fu">hasError</span><span class="op">)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span><span class="st">"GPU readback error detected."</span><span class="op">);</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span><span class="op">;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Make sure the Texture2D is not null</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>outputTextureCPU<span class="op">)</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fill Texture2D with raw data from the AsyncGPUReadbackRequest</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        outputTextureCPU<span class="op">.</span><span class="fu">LoadRawTextureData</span><span class="op">(</span>request<span class="op">.</span><span class="fu">GetData</span><span class="op">&lt;</span><span class="dt">uint</span><span class="op">&gt;());</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Apply changes to Textur2D</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        outputTextureCPU<span class="op">.</span><span class="fu">Apply</span><span class="op">();</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to process raw model output</strong></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Process the raw model output to get the predicted class index</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"engine"</span><span class="kw">&gt;</span><span class="co">The interface for executing the model</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">int</span> <span class="fu">ProcessOutput</span><span class="op">(</span>IWorker engine<span class="op">)</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> classIndex <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get raw model output</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    Tensor output <span class="op">=</span> engine<span class="op">.</span><span class="fu">PeekOutput</span><span class="op">(</span>argmaxLayer<span class="op">);</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>useAsyncGPUReadback<span class="op">)</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Copy model output to a RenderTexture</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        output<span class="op">.</span><span class="fu">ToRenderTexture</span><span class="op">(</span>outputTextureGPU<span class="op">);</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Asynchronously download model output from the GPU to the CPU</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        AsyncGPUReadback<span class="op">.</span><span class="fu">Request</span><span class="op">(</span>outputTextureGPU<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> TextureFormat<span class="op">.</span><span class="fu">RGBAHalf</span><span class="op">,</span> OnCompleteReadback<span class="op">);</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the predicted class index</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        classIndex <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>outputTextureCPU<span class="op">.</span><span class="fu">GetPixel</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">).</span><span class="fu">r</span><span class="op">;</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if index is valid</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>classIndex <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> classIndex <span class="op">&gt;=</span> classes<span class="op">.</span><span class="fu">Length</span><span class="op">)</span> Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span><span class="st">"Output texture not initialized"</span><span class="op">);</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the predicted class index</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        classIndex <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span>output<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>printDebugMessages<span class="op">)</span> Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Class Index: {classIndex}"</span><span class="op">);</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dispose Tensor and associated memories.</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    output<span class="op">.</span><span class="fu">Dispose</span><span class="op">();</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> classIndex<span class="op">;</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-update-method" class="level3">
<h3 class="anchored" data-anchor-id="define-update-method">Define Update method</h3>
<p>We’ll place anything we want to run every frame in the <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.Update.html">Update</a> method.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Update is called once per frame</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">Update</span><span class="op">()</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    useWebcam <span class="op">=</span> webcamDevices<span class="op">.</span><span class="fu">Length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> useWebcam <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>useWebcam<span class="op">)</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize webcam if it is not already playing</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(!</span>webcamTexture <span class="op">||</span> <span class="op">!</span>webcamTexture<span class="op">.</span><span class="fu">isPlaying</span><span class="op">)</span> <span class="fu">InitializeWebcam</span><span class="op">(</span>currentWebcam<span class="op">);</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Skip the rest of the method if the webcam is not initialized</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>webcamTexture<span class="op">.</span><span class="fu">width</span> <span class="op">&lt;=</span> <span class="dv">16</span><span class="op">)</span> <span class="kw">return</span><span class="op">;</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Make sure screen dimensions match webcam resolution when using webcam</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>screenDims<span class="op">.</span><span class="fu">x</span> <span class="op">!=</span> webcamTexture<span class="op">.</span><span class="fu">width</span><span class="op">)</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Resize and position the screen object using the source image dimensions</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">InitializeScreen</span><span class="op">();</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Resize and position the main camera using the source image dimensions</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">InitializeCamera</span><span class="op">(</span>screenDims<span class="op">);</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span>webcamTexture <span class="op">&amp;&amp;</span> webcamTexture<span class="op">.</span><span class="fu">isPlaying</span><span class="op">)</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Stop the current webcam</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>        webcamTexture<span class="op">.</span><span class="fu">Stop</span><span class="op">();</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resize and position the screen object using the source image dimensions</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">InitializeScreen</span><span class="op">();</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resize and position the main camera using the source image dimensions</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">InitializeCamera</span><span class="op">(</span>screenDims<span class="op">);</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Scale the source image resolution</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>    Vector2Int inputDims <span class="op">=</span> <span class="fu">CalculateInputDims</span><span class="op">(</span>screenDims<span class="op">,</span> targetDim<span class="op">);</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>printDebugMessages<span class="op">)</span> Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Input Dims: {inputDims.x} x {inputDims.y}"</span><span class="op">);</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the input texture with the calculated input dimensions</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    inputTexture <span class="op">=</span> RenderTexture<span class="op">.</span><span class="fu">GetTemporary</span><span class="op">(</span>inputDims<span class="op">.</span><span class="fu">x</span><span class="op">,</span> inputDims<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> RenderTextureFormat<span class="op">.</span><span class="fu">ARGBHalf</span><span class="op">);</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>printDebugMessages<span class="op">)</span> Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Input Dims: {inputTexture.width}x{inputTexture.height}"</span><span class="op">);</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy the source texture into model input texture</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    Graphics<span class="op">.</span><span class="fu">Blit</span><span class="op">((</span>useWebcam <span class="op">?</span> webcamTexture <span class="op">:</span> imageTexture<span class="op">),</span> inputTexture<span class="op">);</span></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Disable asynchronous GPU readback when not using a Compute Shader backend</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>    useAsyncGPUReadback <span class="op">=</span> engine<span class="op">.</span><span class="fu">Summary</span><span class="op">().</span><span class="fu">Contains</span><span class="op">(</span><span class="st">"Unity.Barracuda.ComputeVarsWithSharedModel"</span><span class="op">)</span> <span class="op">?</span> useAsyncGPUReadback <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>SystemInfo<span class="op">.</span><span class="fu">supportsComputeShaders</span><span class="op">)</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Normalize the input pixel data</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ProcessImageGPU</span><span class="op">(</span>inputTexture<span class="op">,</span> processingShader<span class="op">,</span> <span class="st">"NormalizeImageNet"</span><span class="op">);</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize a Tensor using the inputTexture</span></span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>        input <span class="op">=</span> <span class="kw">new</span> <span class="fu">Tensor</span><span class="op">(</span>inputTexture<span class="op">,</span> channels<span class="op">:</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Define a temporary HDR RenderTexture</span></span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>        RenderTexture result <span class="op">=</span> RenderTexture<span class="op">.</span><span class="fu">GetTemporary</span><span class="op">(</span>inputTexture<span class="op">.</span><span class="fu">width</span><span class="op">,</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>                                                          inputTexture<span class="op">.</span><span class="fu">height</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> RenderTextureFormat<span class="op">.</span><span class="fu">ARGBHalf</span><span class="op">);</span></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>        RenderTexture<span class="op">.</span><span class="fu">active</span> <span class="op">=</span> result<span class="op">;</span></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Apply preprocessing steps</span></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>        Graphics<span class="op">.</span><span class="fu">Blit</span><span class="op">(</span>inputTexture<span class="op">,</span> result<span class="op">,</span> processingMaterial<span class="op">);</span></span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize a Tensor using the inputTexture</span></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>        input <span class="op">=</span> <span class="kw">new</span> <span class="fu">Tensor</span><span class="op">(</span>result<span class="op">,</span> channels<span class="op">:</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>        RenderTexture<span class="op">.</span><span class="fu">ReleaseTemporary</span><span class="op">(</span>result<span class="op">);</span></span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Execute the model with the input Tensor</span></span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>    engine<span class="op">.</span><span class="fu">Execute</span><span class="op">(</span>input<span class="op">);</span></span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Dispose Tensor and associated memories.</span></span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>    input<span class="op">.</span><span class="fu">Dispose</span><span class="op">();</span></span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Release the input texture</span></span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>    RenderTexture<span class="op">.</span><span class="fu">ReleaseTemporary</span><span class="op">(</span>inputTexture<span class="op">);</span></span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the predicted class index</span></span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>    classIndex <span class="op">=</span> <span class="fu">ProcessOutput</span><span class="op">(</span>engine<span class="op">);</span></span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if index is valid</span></span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> validIndex <span class="op">=</span> classIndex <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> classIndex <span class="op">&lt;</span> classes<span class="op">.</span><span class="fu">Length</span><span class="op">;</span></span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>printDebugMessages<span class="op">)</span> Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>validIndex <span class="op">?</span> $<span class="st">"Predicted Class: {classes[classIndex]}"</span> <span class="op">:</span> <span class="st">"Invalid index"</span><span class="op">);</span></span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unload assets when running in a web browser</span></span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>Application<span class="op">.</span><span class="fu">platform</span> <span class="op">==</span> RuntimePlatform<span class="op">.</span><span class="fu">WebGLPlayer</span><span class="op">)</span> Resources<span class="op">.</span><span class="fu">UnloadUnusedAssets</span><span class="op">();</span></span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-gui-methods" class="level3">
<h3 class="anchored" data-anchor-id="define-gui-methods">Define GUI Methods</h3>
<p>We need some methods to handle user interactions with the GUI and display the predicted class and current framerate.</p>
<p><strong>Define method to update webcam usage from GUI</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// This method is called when the value for the webcam toggle changes</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"useWebcam"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">UpdateWebcamToggle</span><span class="op">(</span><span class="dt">bool</span> useWebcam<span class="op">)</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">useWebcam</span> <span class="op">=</span> useWebcam<span class="op">;</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to update webcam device from GUI</strong></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// The method is called when the selected value for the webcam dropdown changes</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">UpdateWebcamDevice</span><span class="op">()</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    currentWebcam <span class="op">=</span> webcamDevices<span class="op">[</span>webcamDropdown<span class="op">.</span><span class="fu">value</span><span class="op">].</span><span class="fu">name</span><span class="op">;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Selected Webcam: {currentWebcam}"</span><span class="op">);</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize webcam if it is not already playing</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>useWebcam<span class="op">)</span> <span class="fu">InitializeWebcam</span><span class="op">(</span>currentWebcam<span class="op">);</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize and position the screen object using the source image dimensions</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeScreen</span><span class="op">();</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize and position the main camera using the source image dimensions</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeCamera</span><span class="op">(</span>screenDims<span class="op">);</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define OnGUI method</strong></p>
<p>We’ll display the predicted class and current frame rate in the <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.OnGUI.html">OnGUI</a> method.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">// OnGUI is called for rendering and handling GUI events.</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnGUI</span><span class="op">()</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define styling information for GUI elements</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    GUIStyle style <span class="op">=</span> <span class="kw">new</span> GUIStyle</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        fontSize <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>Screen<span class="op">.</span><span class="fu">width</span> <span class="op">*</span> <span class="op">(</span>1f <span class="op">/</span> <span class="op">(</span>100f <span class="op">-</span> fontScale<span class="op">)))</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    style<span class="op">.</span><span class="fu">normal</span><span class="op">.</span><span class="fu">textColor</span> <span class="op">=</span> textColor<span class="op">;</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define screen spaces for GUI elements</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    Rect slot1 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rect</span><span class="op">(</span><span class="dv">10</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">500</span><span class="op">);</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    Rect slot2 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rect</span><span class="op">(</span><span class="dv">10</span><span class="op">,</span> style<span class="op">.</span><span class="fu">fontSize</span> <span class="op">*</span> <span class="fl">1.5f</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">500</span><span class="op">);</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Verify predicted class index is valid</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> validIndex <span class="op">=</span> classIndex <span class="op">&gt;=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> classIndex <span class="op">&lt;</span> classes<span class="op">.</span><span class="fu">Length</span><span class="op">;</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">string</span> content <span class="op">=</span> $<span class="st">"Predicted Class: {(validIndex ? classes[classIndex] : "</span>Invalid index<span class="st">")}"</span><span class="op">;</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>displayPredictedClass<span class="op">)</span> GUI<span class="op">.</span><span class="fu">Label</span><span class="op">(</span>slot1<span class="op">,</span> <span class="kw">new</span> <span class="fu">GUIContent</span><span class="op">(</span>content<span class="op">),</span> style<span class="op">);</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update framerate value</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>Time<span class="op">.</span><span class="fu">unscaledTime</span> <span class="op">&gt;</span> fpsTimer<span class="op">)</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>        fps <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>1f <span class="op">/</span> Time<span class="op">.</span><span class="fu">unscaledDeltaTime</span><span class="op">);</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>        fpsTimer <span class="op">=</span> Time<span class="op">.</span><span class="fu">unscaledTime</span> <span class="op">+</span> fpsRefreshRate<span class="op">;</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust screen position when not showing predicted class</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    Rect fpsRect <span class="op">=</span> displayPredictedClass <span class="op">?</span> slot2 <span class="op">:</span> slot1<span class="op">;</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>displayFPS<span class="op">)</span> GUI<span class="op">.</span><span class="fu">Label</span><span class="op">(</span>fpsRect<span class="op">,</span> <span class="kw">new</span> <span class="fu">GUIContent</span><span class="op">(</span>$<span class="st">"FPS: {fps}"</span><span class="op">),</span> style<span class="op">);</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-ondisable-method" class="level3">
<h3 class="anchored" data-anchor-id="define-ondisable-method">Define OnDisable Method</h3>
<p>We’ll perform any clean-up steps in the <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.OnDisable.html">OnDisable</a>method.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">// OnDisable is called when the MonoBehavior becomes disabled</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">OnDisable</span><span class="op">()</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Release the resources allocated for the outputTextureGPU</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    RenderTexture<span class="op">.</span><span class="fu">ReleaseTemporary</span><span class="op">(</span>outputTextureGPU<span class="op">);</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Release the resources allocated for the inference engine</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    engine<span class="op">.</span><span class="fu">Dispose</span><span class="op">();</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="create-processing-shaders" class="level2">
<h2 class="anchored" data-anchor-id="create-processing-shaders">Create Processing Shaders</h2>
<p>Now we need to create the Shaders for normalizing input images. We’ll store the shaders in a new Shaders folder.</p>
<section id="create-compute-shader" class="level3">
<h3 class="anchored" data-anchor-id="create-compute-shader">Create Compute Shader</h3>
<p>Right-click a space in the Shaders folder and select <code>Create → Shader → Compute Shader</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-compute-shader.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Name the Compute Shader <code>ProcessingShader</code> and open it in the code editor.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-processing-shader.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Default Compute Shader Code</strong></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Each #kernel tells which function to compile; you can have many kernels</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>#pragma kernel CSMain</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a RenderTexture with enableRandomWrite flag and set it</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">// with cs.SetTexture</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>RWTexture2D<span class="op">&lt;</span>float4<span class="op">&gt;</span> Result<span class="op">;</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">numthreads</span><span class="op">(</span><span class="dv">8</span><span class="op">,</span><span class="dv">8</span><span class="op">,</span><span class="dv">1</span><span class="op">)]</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">CSMain</span> <span class="op">(</span>uint3 id <span class="op">:</span> SV_DispatchThreadID<span class="op">)</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// </span><span class="al">TODO</span><span class="co">: insert actual code here!</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    Result<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">]</span> <span class="op">=</span> <span class="fu">float4</span><span class="op">(</span>id<span class="op">.</span><span class="fu">x</span> <span class="op">&amp;</span> id<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="op">(</span>id<span class="op">.</span><span class="fu">x</span> <span class="op">&amp;</span> <span class="dv">15</span><span class="op">)/</span><span class="fl">15.0</span><span class="op">,</span> <span class="op">(</span>id<span class="op">.</span><span class="fu">y</span> <span class="op">&amp;</span> <span class="dv">15</span><span class="op">)/</span><span class="fl">15.0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We need to add a new Texture2D variable to store the pixel data for the input image. We’ll remove the default method and create a new one called <code>NormalizeImageNet</code>. We need to replace the default method name in the #pragma kernel line at the top.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Each #kernel tells which function to compile; you can have many kernels</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>#pragma kernel NormalizeImageNet</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">// The pixel data for the input image</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>Texture2D<span class="op">&lt;</span>float4<span class="op">&gt;</span> InputImage<span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">// The pixel data for the processed image</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>RWTexture2D<span class="op">&lt;</span>float4<span class="op">&gt;</span> Result<span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply the ImageNet normalization stats from PyTorch to an image</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">numthreads</span><span class="op">(</span><span class="dv">8</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">1</span><span class="op">)]</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">NormalizeImageNet</span><span class="op">(</span>uint3 id <span class="op">:</span> SV_DispatchThreadID<span class="op">)</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the pixel color values for the processed image</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    Result<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">]</span> <span class="op">=</span> <span class="fu">float4</span><span class="op">(</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Normalize the red color channel values</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>InputImage<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">].</span><span class="fu">r</span> <span class="op">-</span> <span class="fl">0.4850f</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2290f</span><span class="op">,</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Normalize the green color channel values</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>InputImage<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">].</span><span class="fu">g</span> <span class="op">-</span> <span class="fl">0.4560f</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2240f</span><span class="op">,</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Normalize the blue color channel values</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>InputImage<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">].</span><span class="fu">b</span> <span class="op">-</span> <span class="fl">0.4060f</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2250f</span><span class="op">,</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ignore the alpha/transparency channel</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        InputImage<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">].</span><span class="fu">a</span><span class="op">);</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-image-effect-shader" class="level3">
<h3 class="anchored" data-anchor-id="create-image-effect-shader">Create Image Effect Shader</h3>
<p>Right-click a space in the Shaders folder and select <code>Create → Shader → Image Effect Shader</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-image-effect-shader.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Name the new shader <code>NormalizeImageNet</code> and open it in the code editor.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-normalize-imagenet-shader.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Default Image Effect Shader Code</strong></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>Shader <span class="st">"Hidden/NormalizeImageNet"</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    Properties</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">_MainTex</span> <span class="op">(</span><span class="st">"Texture"</span><span class="op">,</span> 2D<span class="op">)</span> <span class="op">=</span> <span class="st">"white"</span> <span class="op">{}</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    SubShader</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// No culling or depth</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        Cull Off ZWrite Off ZTest Always</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>        Pass</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>            CGPROGRAM</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>            #pragma vertex vert</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>            #pragma fragment frag</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>            #include <span class="st">"UnityCG.cginc"</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> appdata</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>                float4 vertex <span class="op">:</span> POSITION<span class="op">;</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>                float2 uv <span class="op">:</span> TEXCOORD0<span class="op">;</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> v2f</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>                float2 uv <span class="op">:</span> TEXCOORD0<span class="op">;</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>                float4 vertex <span class="op">:</span> SV_POSITION<span class="op">;</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>            v2f <span class="fu">vert</span> <span class="op">(</span>appdata v<span class="op">)</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>                v2f o<span class="op">;</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>                o<span class="op">.</span><span class="fu">vertex</span> <span class="op">=</span> <span class="fu">UnityObjectToClipPos</span><span class="op">(</span>v<span class="op">.</span><span class="fu">vertex</span><span class="op">);</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>                o<span class="op">.</span><span class="fu">uv</span> <span class="op">=</span> v<span class="op">.</span><span class="fu">uv</span><span class="op">;</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> o<span class="op">;</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>            sampler2D _MainTex<span class="op">;</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>            fixed4 <span class="fu">frag</span> <span class="op">(</span>v2f i<span class="op">)</span> <span class="op">:</span> SV_Target</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>                fixed4 col <span class="op">=</span> <span class="fu">tex2D</span><span class="op">(</span>_MainTex<span class="op">,</span> i<span class="op">.</span><span class="fu">uv</span><span class="op">);</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>                <span class="co">// just invert the colors</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>                col<span class="op">.</span><span class="fu">rgb</span> <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> col<span class="op">.</span><span class="fu">rgb</span><span class="op">;</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> col<span class="op">;</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>            ENDCG</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The string at the top of the file indicates the path to access the shader in the Unity Editor. We can replace the Hidden folder name with Processing Shaders to keep things more organized. We’ll replace the fixed4 frag method with the normalization steps.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>Shader <span class="st">"Processing Shaders/NormalizeImageNet"</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    Properties</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">_MainTex</span><span class="op">(</span><span class="st">"Texture"</span><span class="op">,</span> 2D<span class="op">)</span> <span class="op">=</span> <span class="st">"white"</span> <span class="op">{}</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    SubShader</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// No culling or depth</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        Cull Off ZWrite Off ZTest Always</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        Pass</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>            CGPROGRAM</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>            #pragma vertex vert</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>            #pragma fragment frag</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>            #include <span class="st">"UnityCG.cginc"</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> appdata</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>                float4 vertex <span class="op">:</span> POSITION<span class="op">;</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>                float2 uv <span class="op">:</span> TEXCOORD0<span class="op">;</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">struct</span> v2f</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>                float2 uv <span class="op">:</span> TEXCOORD0<span class="op">;</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>                float4 vertex <span class="op">:</span> SV_POSITION<span class="op">;</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>            v2f <span class="fu">vert</span><span class="op">(</span>appdata v<span class="op">)</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>                v2f o<span class="op">;</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>                o<span class="op">.</span><span class="fu">vertex</span> <span class="op">=</span> <span class="fu">UnityObjectToClipPos</span><span class="op">(</span>v<span class="op">.</span><span class="fu">vertex</span><span class="op">);</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>                o<span class="op">.</span><span class="fu">uv</span> <span class="op">=</span> v<span class="op">.</span><span class="fu">uv</span><span class="op">;</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> o<span class="op">;</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>            sampler2D _MainTex<span class="op">;</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Set the pixel color values for the processed image</span></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>            float4 <span class="fu">frag</span><span class="op">(</span>v2f i<span class="op">)</span> <span class="op">:</span> SV_Target</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>                float4 col <span class="op">=</span> <span class="fu">tex2D</span><span class="op">(</span>_MainTex<span class="op">,</span> i<span class="op">.</span><span class="fu">uv</span><span class="op">);</span></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Normalize the red color channel values</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>                col<span class="op">.</span><span class="fu">r</span> <span class="op">=</span> <span class="op">(</span>col<span class="op">.</span><span class="fu">r</span> <span class="op">-</span> <span class="fl">0.4850</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2290</span><span class="op">;</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Normalize the green color channel values</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>                col<span class="op">.</span><span class="fu">g</span> <span class="op">=</span> <span class="op">(</span>col<span class="op">.</span><span class="fu">g</span> <span class="op">-</span> <span class="fl">0.4560</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2240</span><span class="op">;</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Normalize the blue color channel values</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>                col<span class="op">.</span><span class="fu">b</span> <span class="op">=</span> <span class="op">(</span>col<span class="op">.</span><span class="fu">b</span> <span class="op">-</span> <span class="fl">0.4060</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2250</span><span class="op">;</span></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> col<span class="op">;</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>            ENDCG</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Create Normalize ImageNet Material</strong></p>
<p>Next, we need to create a new material to use the NormalizeImageNet shader. Right-click a space in the Shaders folder and select Create → Material.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-material.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>We can name it <code>NormalizeImageNet</code> as well.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-normalize-imagenet-material.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>With the new Material selected, open the Shader dropdown menu at the top of the Inspector tab. Type in the Material’s name and press enter.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-change-material-shader.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
</section>
<section id="set-up-unity-scene" class="level2">
<h2 class="anchored" data-anchor-id="set-up-unity-scene">Set up Unity Scene</h2>
<p>We can, at last, start setting up our Unity scene. We need a screen to display the webcam feed, an empty object to attach the <code>ImageClassifier</code> script, a dropdown menu for selecting webcam devices, and a toggle to switch between the test image and a webcam feed.</p>
<p><strong>Create Screen object</strong></p>
<p>Right-click a space in the Hierarchy tab and select 3D Object → Quad. We can name the new object Screen.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-quad.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Next, drag and drop a test image from the Assets → Images folder onto the Screen object in the Scene view. Note that the Screen looks a bit dim. We need to change the shader for the Screen’s Material so that it does not require an external light source.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-attach-image-to-screen.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Select the Screen in the Hierarchy tab and open the Shader dropdown menu in the Inspector tab. Type Unlit/Texture into the search box and press enter.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-update-screen-material-shader.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Create Inference Manager object</strong></p>
<p>Right-click a space in the Hierarchy tab and select Create Empty. Name the empty object <code>InferenceManager</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-create-empty-gameobject.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>With the <code>InferenceManager</code> object selected, drag the <code>ImageClassifier</code> script into the Inspector tab.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-attach-image-classifier-script.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Now we can assign the Screen, compute shader, Material, ONNX file, and class labels file in the Inspector tab by dragging them into their respective fields.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-assign-image-classifier-script-assets.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Add GUI prefab</strong></p>
<p>We still need to create the GUI toggle and dropdown menu. To save time, I made a <a href="https://docs.unity3d.com/Manual/Prefabs.html">Prefab</a> that we can drop into the Scene.</p>
<ul>
<li><strong>Google Drive:</strong> <a href="https://drive.google.com/drive/folders/1ZP02X7vkhLzyouHjKNpD9bI6BU8YDjlM?usp=sharing">Canvas Prefab</a></li>
</ul>
<p>Unity provides a free <a href="https://assetstore.unity.com/packages/essentials/ui-samples-25468">UI Sample</a>package for anyone that wants to try creating a custom UI, and there are plenty of <a href="https://assetstore.unity.com/?category=tools%2Fgui\2d%2Fgui\3d%2Fgui&amp;orderBy=1">options</a> on the Asset Store.</p>
<p>Drag and drop the Canvas prefab into a new folder called Prefabs.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-import-canvas-prefab.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>From there, drag the prefab into the Hierarchy tab. We can see the GUI by switching to the Game view.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-add-canvas-to-hierarchy-tab.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Configure Webcam Toggle On Value Changed function</strong></p>
<p>Next, we need to pair the <code>WebcamToggle</code> with the <code>UpdateWebcamToggle</code> function in the <code>ImageClassifier</code> script. Expand the Canvas object and select the <code>WebcamToggle</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-select-webcamtoggle.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Click and drag the <code>InferenceManager</code> into the <code>On Value Changed</code> field.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-webcamtoggle-assign-inference-manager.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Open the <code>No Function</code> dropdown menu and select <code>ImageClassifier → UpdateWebcamToggle</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-webcamtoggle-assign-inference-manager-function.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Configure Webcam Dropdown On Value Changed function</strong></p>
<p>We can follow the same steps to pair the <code>WebcamDropdown</code> with the <code>UpdateWebcamDevice</code> function in the <code>ImageClassifier</code> script.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-webcamdropdown-assign-inference-manager.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>This time select <code>ImageClassifier → UpdateWebcamDevice</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-webcamdropdown-assign-inference-manager-function.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Assign GUI objects to Inference Manager</strong></p>
<p>We can now assign the <code>WebcamToggle</code> and <code>WebcamDropdown</code> objects to their respective fields for the <code>ImageClassifier</code> script.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-inference-manager-assign-gui-objects.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p><strong>Add Event System</strong></p>
<p>Before we can use the GUI, we need to add an Event System. Right-click a space in the Hierarchy tab and select <code>UI → Event System</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-add-eventsystem.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="test-in-editor" class="level2">
<h2 class="anchored" data-anchor-id="test-in-editor">Test in Editor</h2>
<p>We can finally test the project in the editor. Click the play button in the top-middle of the Editor window.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-click-play-button.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>The predicted class should be <code>Play</code>, the dropdown menu should update with available webcam devices, and the Screen object should fill the preview window while maintaining the source aspect ratio. GPU utilization should hover near 100% when using asynchronous GPU readback.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-test-in-editor.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This post covered implementing an image classification model in a Unity project using the Barracuda library. Part 3 will cover building the Unity project to run in a web browser and hosting it using GitHub Pages.</p>
<p><strong>Previous:</strong> <a href="../part-1/">Fastai to Unity Tutorial Pt. 1</a></p>
<p><strong>Next:</strong> <a href="../part-3/">Fastai to Unity Tutorial Pt. 3</a></p>
<p><strong>Project Resources:</strong> <a href="https://github.com/cj-mills/fastai-to-unity-tutorial">GitHub Repository</a></p>


</section>

</main> <!-- /main -->
<!-- Cloudflare Web Analytics --><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;56b8d2f624604c4891327b3c0d9f6703&quot;}"></script><!-- End Cloudflare Web Analytics -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="cj-mills/christianjmills" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Copyright 2023, Christian J. Mills
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>