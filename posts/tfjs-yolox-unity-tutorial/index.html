<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christian Mills">
<meta name="dcterms.date" content="2022-10-16">
<meta name="description" content="Create a TensorFlow.js plugin for the Unity game engine to perform object detection with a YOLOX model.">

<title>Christian Mills - Using TensorFlow.js for In-Browser Object Detection in Unity</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Christian Mills - Using TensorFlow.js for In-Browser Object Detection in Unity">
<meta property="og:description" content="Create a TensorFlow.js plugin for the Unity game engine to perform object detection with a YOLOX model.">
<meta property="og:image" content="christianjmills.com/images/empty.gif">
<meta property="og:site_name" content="Christian Mills">
<meta name="twitter:title" content="Christian Mills - Using TensorFlow.js for In-Browser Object Detection in Unity">
<meta name="twitter:description" content="Create a TensorFlow.js plugin for the Unity game engine to perform object detection with a YOLOX model.">
<meta name="twitter:image" content="christianjmills.com/images/empty.gif">
<meta name="twitter:creator" content="@cdotjdotmills">
<meta name="twitter:site" content="@cdotjdotmills">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Christian Mills</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../series/tutorials/index.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../series/notes/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../services.html"> 
<span class="menu-text">Services</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:christian@christianjmills.com"> <i class="bi bi-envelope-fill" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cj-mills"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/cdotjdotmills"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#convert-model-to-tfjs" id="toc-convert-model-to-tfjs" class="nav-link" data-scroll-target="#convert-model-to-tfjs">Convert Model to TFJS</a></li>
  <li><a href="#import-assets" id="toc-import-assets" class="nav-link" data-scroll-target="#import-assets">Import Assets</a></li>
  <li><a href="#update-javascript-utility-file" id="toc-update-javascript-utility-file" class="nav-link" data-scroll-target="#update-javascript-utility-file">Update JavaScript Utility File</a></li>
  <li><a href="#update-jslib-plugin" id="toc-update-jslib-plugin" class="nav-link" data-scroll-target="#update-jslib-plugin">Update jslib Plugin</a></li>
  <li><a href="#import-plugin-functions" id="toc-import-plugin-functions" class="nav-link" data-scroll-target="#import-plugin-functions">Import Plugin Functions</a></li>
  <li><a href="#create-object-detector-script" id="toc-create-object-detector-script" class="nav-link" data-scroll-target="#create-object-detector-script">Create Object Detector Script</a>
  <ul>
  <li><a href="#define-public-variables" id="toc-define-public-variables" class="nav-link" data-scroll-target="#define-public-variables">Define public variables</a></li>
  <li><a href="#define-private-variables" id="toc-define-private-variables" class="nav-link" data-scroll-target="#define-private-variables">Define private variables</a></li>
  <li><a href="#define-initialization-methods" id="toc-define-initialization-methods" class="nav-link" data-scroll-target="#define-initialization-methods">Define Initialization Methods</a></li>
  <li><a href="#define-awake-method-unchanged" id="toc-define-awake-method-unchanged" class="nav-link" data-scroll-target="#define-awake-method-unchanged">Define Awake method (unchanged)</a></li>
  <li><a href="#define-start-method" id="toc-define-start-method" class="nav-link" data-scroll-target="#define-start-method">Define Start method</a></li>
  <li><a href="#define-processing-methods" id="toc-define-processing-methods" class="nav-link" data-scroll-target="#define-processing-methods">Define Processing Methods</a></li>
  <li><a href="#define-update-method" id="toc-define-update-method" class="nav-link" data-scroll-target="#define-update-method">Define Update method</a></li>
  <li><a href="#define-gui-methods" id="toc-define-gui-methods" class="nav-link" data-scroll-target="#define-gui-methods">Define GUI Methods</a></li>
  </ul></li>
  <li><a href="#update-unity-scene" id="toc-update-unity-scene" class="nav-link" data-scroll-target="#update-unity-scene">Update Unity Scene</a></li>
  <li><a href="#test-in-browser" id="toc-test-in-browser" class="nav-link" data-scroll-target="#test-in-browser">Test in Browser</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Using TensorFlow.js for In-Browser Object Detection in Unity</h1>
  <div class="quarto-categories">
    <div class="quarto-category">unity</div>
    <div class="quarto-category">tensorflow</div>
    <div class="quarto-category">webgl</div>
    <div class="quarto-category">yolox</div>
    <div class="quarto-category">object-detection</div>
    <div class="quarto-category">tutorial</div>
  </div>
  </div>

<div>
  <div class="description">
    Create a TensorFlow.js plugin for the Unity game engine to perform object detection with a YOLOX model.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christian Mills </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 16, 2022</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#convert-model-to-tfjs">Convert Model to TFJS</a></li>
<li><a href="#import-assets">Import Assets</a></li>
<li><a href="#update-javascript-utility-file">Update JavaScript Utility File</a></li>
<li><a href="#update-jslib-plugin">Update jslib Plugin</a></li>
<li><a href="#import-plugin-functions">Import Plugin Functions</a></li>
<li><a href="#create-object-detector-script">Create Object Detector Script</a></li>
<li><a href="#update-unity-scene">Update Unity Scene</a></li>
<li><a href="#test-in-browser">Test in Browser</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This follow-up post shows you how to modify an existing Unity project from a <a href="http://../tensorflow-js-unity-tutorial/part-1/">previous tutorial</a> to use <a href="https://www.tensorflow.org/js">TensorFlow.js</a> for in-browser object detection. We will begin by converting a pre-existing model to the TensorFlow.js format and importing it into <a href="https://unity.com/">Unity</a>. Next, we will update the JavaScript utility file and the jslib plugin from the original project. After setting up the plugin, we will create a script to implement the object detector in Unity and update our scene to use it. Finally, we will test the project in-browser to ensure it works properly.</p>
<p><strong>In-Browser Demo:</strong> <a href="https://cj-mills.github.io/hand-gesture-detector-webgl-demo/">Hand Gesture Detector</a></p>
<p><strong>Project Resources</strong></p>
<ul>
<li><a href="https://github.com/cj-mills/tfjs-yolox-unity-tutorial">GitHub Repository</a>: The final Unity project for this tutorial.</li>
<li><a href="https://drive.google.com/drive/folders/1sTU5fiG6mmq19fWzpmptBNJNN4qhN_yi?usp=sharing">Colormaps</a>: A JSON colormap file that maps each object class to a distinct color.</li>
<li><a href="https://drive.google.com/drive/folders/1kuSyQcW032Is1o1a3n8w9LGzdL_d44aC?usp=sharing">TFJSModels</a>: A YOLOX model in TensorFlow.js format.</li>
<li><a href="../tensorflow-js-unity-tutorial/part-1/">In-Browser Hand Gesture Recognition for Unity with Fastai and TensorFlow.js</a>: The previous tutorial.</li>
</ul>
</section>
<section id="convert-model-to-tfjs" class="level2">
<h2 class="anchored" data-anchor-id="convert-model-to-tfjs">Convert Model to TFJS</h2>
<p>We first need a YOLOX model in TensorFlow.js format. We can use the <a href="../tensorflow-js-unity-tutorial/part-1/#export-the-model">same steps</a> from the original tutorial to convert the YOLOX model from a <a href="../icevision-openvino-unity-tutorial/part-1/">previous tutorial</a>. The YOLOX model detects the same hand gestures as the image classifier from the original tutorial.</p>
<p>A link to the model conversion notebook is below, along with links for running the notebook on <a href="https://colab.research.google.com/?utm_source=scs-index">Google Colab</a> and <a href="https://www.kaggle.com/docs/notebooks">Kaggle</a>.</p>
<table class="table">
<thead>
<tr class="header">
<th>Jupyter Notebook</th>
<th>Colab</th>
<th>Kaggle</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="https://github.com/cj-mills/tfjs-yolox-unity-tutorial/blob/main/notebooks/ONNX-to-TF-to-TFJS.ipynb">GitHub Repository</a></td>
<td><a href="https://colab.research.google.com/github/cj-mills/tfjs-yolox-unity-tutorial/blob/main/notebooks/ONNX-to-TF-to-TFJS-Colab.ipynb">Open In Colab</a></td>
<td><a href="https://kaggle.com/kernels/welcome?src=https://github.com/cj-mills/tfjs-yolox-unity-tutorial/blob/main/notebooks/ONNX-to-TF-to-TFJS-Kaggle.ipynb">Open in Kaggle</a></td>
</tr>
</tbody>
</table>
</section>
<section id="import-assets" class="level2">
<h2 class="anchored" data-anchor-id="import-assets">Import Assets</h2>
<p>Open the Unity project from the original tutorial in the Unity Editor. Alternatively, you can create a copy of the project and rename it to something more appropriate. We will first import the colormap and TensorFlow.js model into the <code>Assets</code> folder.</p>
<p><strong>Import color map</strong></p>
<p>We’ll store the colormap JSON file in a new folder called <code>Colormaps</code>. Drag and drop the JSON colormap file from the operating system’s file explorer into the <code>Colormaps</code> folder.</p>
<ul>
<li><strong>Google Drive:</strong> <a href="https://drive.google.com/drive/folders/1sTU5fiG6mmq19fWzpmptBNJNN4qhN_yi?usp=sharing">Colormaps</a></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-import-colormaps.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Import TFJS model</strong></p>
<p>We need to replace the existing TensorFlow.js models in the <code>StreamingAssets</code> folder with the YOLOX model.</p>
<ul>
<li><strong>Google Drive:</strong> <a href="https://drive.google.com/drive/folders/1kuSyQcW032Is1o1a3n8w9LGzdL_d44aC?usp=sharing">TFJSModels</a></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-update-tfjs-models-folder.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="update-javascript-utility-file" class="level2">
<h2 class="anchored" data-anchor-id="update-javascript-utility-file">Update JavaScript Utility File</h2>
<p>We’ll update the function in the utils.js file in the <code>StreamingAssets</code> folder to return the raw model output.</p>
<p><strong>Update function to perform inference asynchronously with YOLOX model</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform inference with the provided model and input data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">PerformInferenceAsync</span>(model<span class="op">,</span> float32Data<span class="op">,</span> shape) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> outputData <span class="op">=</span> tf<span class="op">.</span><span class="fu">tidy</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> input_tensor <span class="op">=</span> tf<span class="op">.</span><span class="fu">tensor</span>(float32Data<span class="op">,</span> shape<span class="op">,</span> <span class="st">'float32'</span>)<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Make a prediction.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> model<span class="op">.</span><span class="fu">predict</span>(input_tensor)<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="cf">await</span> outputData<span class="op">.</span><span class="fu">data</span>()<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="update-jslib-plugin" class="level2">
<h2 class="anchored" data-anchor-id="update-jslib-plugin">Update jslib Plugin</h2>
<p>We also need to make a few updates to the <code>WebGLPlugin.jslib</code> file.</p>
<p><strong>Update function to Initialize TFJS model</strong></p>
<p>We’ll update the <code>InitTFJSModel</code> function to take the path to the YOLOX <code>model.json</code> file and the normalization stats to the plugin.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Load a TFJS YOLOX model</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>InitTFJSModel<span class="op">:</span> <span class="kw">async</span> <span class="kw">function</span> (model_path<span class="op">,</span> mean<span class="op">,</span> std_dev) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert bytes to the text</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> model_path_str <span class="op">=</span> <span class="fu">UTF8ToString</span>(model_path)<span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load the TensorFlow.js model at the provided file path</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">model</span> <span class="op">=</span> <span class="cf">await</span> tf<span class="op">.</span><span class="fu">loadGraphModel</span>(model_path_str<span class="op">,</span> { <span class="dt">fromTFHub</span><span class="op">:</span> <span class="kw">false</span> })<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check the model input shape</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> input_shape <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">model</span><span class="op">.</span><span class="at">inputs</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">shape</span><span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Input Shape: </span><span class="sc">${</span>input_shape<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Store normalization stats</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">mean</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Float32Array</span>(buffer<span class="op">,</span> mean<span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">std_dev</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Float32Array</span>(buffer<span class="op">,</span> std_dev<span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define function to update output array</strong></p>
<p>The size of the raw model output depends on the input resolution. That means we need to update the output array each time we update the input resolution.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Update the array which stores the raw model output</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>UpdateOutputArray<span class="op">:</span> <span class="kw">function</span> (array_data<span class="op">,</span> size) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">delete</span> <span class="kw">this</span><span class="op">.</span><span class="at">output_array</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">output_array</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Float32Array</span>(buffer<span class="op">,</span> array_data<span class="op">,</span> size)<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`New output size JS: </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">output_array</span><span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Update inference function for YOLOX model</strong></p>
<p>Lastly, we need to update the <code>PerformInference</code> function to normalize the input data and fill the shared output array with the raw model output.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform inference with the provided image data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>PerformInference<span class="op">:</span> <span class="kw">function</span> (image_data<span class="op">,</span> size<span class="op">,</span> width<span class="op">,</span> height) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only perform inference after loading a model</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">typeof</span> <span class="kw">this</span><span class="op">.</span><span class="at">model</span> <span class="op">==</span> <span class="st">'undefined'</span>) {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">"Model not defined yet"</span>)<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize an array with the raw image data</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> uintArray <span class="op">=</span> <span class="kw">new</span> <span class="bu">Uint8ClampedArray</span>(buffer<span class="op">,</span> image_data<span class="op">,</span> size<span class="op">,</span> width<span class="op">,</span> height)<span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Channels-last order</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> [input_array] <span class="op">=</span> <span class="kw">new</span> <span class="bu">Array</span>(<span class="kw">new</span> <span class="bu">Array</span>())<span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Flip input image from Unity</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> row <span class="op">=</span> height <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> row <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">;</span> row<span class="op">--</span>) {</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> slice <span class="op">=</span> uintArray<span class="op">.</span><span class="fu">slice</span>(row <span class="op">*</span> width <span class="op">*</span> <span class="dv">3</span><span class="op">,</span> (row <span class="op">*</span> width <span class="op">*</span> <span class="dv">3</span>) <span class="op">+</span> (width <span class="op">*</span> <span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (<span class="kw">let</span> col <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> col <span class="op">&lt;</span> slice<span class="op">.</span><span class="at">length</span><span class="op">;</span> col <span class="op">+=</span> <span class="dv">3</span>) {</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            input_array<span class="op">.</span><span class="fu">push</span>(((slice[col <span class="op">+</span> <span class="dv">0</span>] <span class="op">/</span> <span class="fl">255.0</span>) <span class="op">-</span> <span class="kw">this</span><span class="op">.</span><span class="at">mean</span>[<span class="dv">0</span>]) <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">std_dev</span>[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            input_array<span class="op">.</span><span class="fu">push</span>(((slice[col <span class="op">+</span> <span class="dv">1</span>] <span class="op">/</span> <span class="fl">255.0</span>) <span class="op">-</span> <span class="kw">this</span><span class="op">.</span><span class="at">mean</span>[<span class="dv">1</span>]) <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">std_dev</span>[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>            input_array<span class="op">.</span><span class="fu">push</span>(((slice[col <span class="op">+</span> <span class="dv">2</span>] <span class="op">/</span> <span class="fl">255.0</span>) <span class="op">-</span> <span class="kw">this</span><span class="op">.</span><span class="at">mean</span>[<span class="dv">2</span>]) <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="at">std_dev</span>[<span class="dv">2</span>])<span class="op">;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the input array with the preprocessed input data</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> float32Data <span class="op">=</span> <span class="bu">Float32Array</span><span class="op">.</span><span class="fu">from</span>(input_array)<span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> shape <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> height<span class="op">,</span> width<span class="op">,</span> <span class="dv">3</span>]<span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pass preprocessed input to the model</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">PerformInferenceAsync</span>(<span class="kw">this</span><span class="op">.</span><span class="at">model</span><span class="op">,</span> float32Data<span class="op">,</span> shape)<span class="op">.</span><span class="fu">then</span>(output <span class="kw">=&gt;</span> {</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (output_array<span class="op">.</span><span class="at">length</span> <span class="op">==</span> output<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="at">output_array</span><span class="op">.</span><span class="fu">set</span>(output)<span class="op">;</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> {</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Model output size JS: </span><span class="sc">${</span>output<span class="op">.</span><span class="at">length</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="at">output_array</span><span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That’s it for the changes to the plugin code. Next, we need to update the script where we import the functions in Unity.</p>
</section>
<section id="import-plugin-functions" class="level2">
<h2 class="anchored" data-anchor-id="import-plugin-functions">Import Plugin Functions</h2>
<p>We need to update the import line for <code>InitTFJSModel</code> and import the new <code>UpdateOutputArray</code> function in the <code>WebGLPlugin.cs</code> script.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Runtime</span><span class="op">.</span><span class="fu">InteropServices</span><span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// Class with JavaScript plugin functions for WebGL.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> WebGLPlugin</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Import "GetExternalJS" plugin function</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">DllImport</span><span class="op">(</span><span class="st">"__Internal"</span><span class="op">)]</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">extern</span> <span class="dt">void</span> <span class="fu">GetExternalJS</span><span class="op">();</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Import "SetTFJSBackend" plugin function</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">DllImport</span><span class="op">(</span><span class="st">"__Internal"</span><span class="op">)]</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">extern</span> <span class="dt">void</span> <span class="fu">SetTFJSBackend</span><span class="op">(</span><span class="dt">string</span> backend<span class="op">);</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Import "InitTFJSModel" plugin function</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">DllImport</span><span class="op">(</span><span class="st">"__Internal"</span><span class="op">)]</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">extern</span> <span class="dt">void</span> <span class="fu">InitTFJSModel</span><span class="op">(</span><span class="dt">string</span> model_path<span class="op">,</span> <span class="dt">float</span><span class="op">[]</span> mean<span class="op">,</span> <span class="dt">float</span><span class="op">[]</span> std<span class="op">);</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Import "UpdateOutputArray" plugin function</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">DllImport</span><span class="op">(</span><span class="st">"__Internal"</span><span class="op">)]</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">extern</span> <span class="dt">void</span> <span class="fu">UpdateOutputArray</span><span class="op">(</span><span class="dt">float</span><span class="op">[]</span> output_data<span class="op">,</span> <span class="dt">int</span> size<span class="op">);</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Import "PerformInference" plugin function</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">DllImport</span><span class="op">(</span><span class="st">"__Internal"</span><span class="op">)]</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">extern</span> <span class="dt">bool</span> <span class="fu">PerformInference</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> image_data<span class="op">,</span> <span class="dt">int</span> size<span class="op">,</span> <span class="dt">int</span> width<span class="op">,</span> <span class="dt">int</span> height<span class="op">);</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Changing the import line for <code>InitTFJSModel</code> will cause an error in the <code>ImageClassifier</code> script, but we will resolve this in the next section.</p>
</section>
<section id="create-object-detector-script" class="level2">
<h2 class="anchored" data-anchor-id="create-object-detector-script">Create Object Detector Script</h2>
<p>We’ll replace the <code>ImageClassifier</code> script from the original tutorial with a new script called <code>ObjectDetector</code>. It will handle getting input images, sending them to the model, processing the model output, and drawing bounding boxes around detected objects. Delete the existing <code>ImageClassifier</code> script.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/create-object-detector-script.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Add required namespaces</strong></p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system?view=net-5.0">System</a>: Contains fundamental classes and base classes that define commonly-used value and reference data types, events and event handlers, interfaces, attributes, and processing exceptions.</li>
<li><a href="https://docs.unity3d.com/Packages/com.unity.ugui@1.0/api/UnityEngine.UI.html">UnityEngine.UI</a>: Provides access to UI elements.</li>
<li><a href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.core@5.9/api/UnityEngine.Rendering.html">UnityEngine.Rendering</a>: Provides access to the elements of the rendering pipeline.</li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.io?view=net-7.0">System.IO</a>: Contains types that allow reading and writing to files and data streams, and types that provide basic file and directory support.</li>
<li><a href="https://docs.unity3d.com/Packages/com.unity.multiplayer-hlapi@1.0/api/UnityEngine.Networking.html">UnityEngine.Networking</a>: Provides access to the <a href="https://docs.unity3d.com/ScriptReference/Networking.UnityWebRequest.html">UnityWebRequest</a> module to communicate with http services.</li>
<li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.linq?view=net-7.0">System.Linq</a>: Provides classes and interfaces that support queries that use Language-Integrated Query (LINQ).</li>
</ul>
<hr>
<div class="sourceCode" id="cb6"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Collections</span><span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Collections</span><span class="op">.</span><span class="fu">Generic</span><span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> UnityEngine<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> UnityEngine<span class="op">.</span><span class="fu">UI</span><span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">IO</span><span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> UnityEngine<span class="op">.</span><span class="fu">Networking</span><span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Linq</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Add code to create a list of available TFJS models</strong></p>
<p>We can use the <a href="../tensorflow-js-unity-tutorial/part-2/#create-image-classifier-script">same code</a> to create a list of available TFJS models used in the <code>ImageClassifier</code> script. This code will go right below the namespaces.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">#if</span> UNITY_EDITOR</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> UnityEditor<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>InitializeOnLoad<span class="op">]</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Startup</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// A helper class that stores the name and file path for a TensorFlow.js model</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>System<span class="op">.</span><span class="fu">Serializable</span><span class="op">]</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> ModelData</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">string</span> name<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">string</span> path<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="fu">ModelData</span><span class="op">(</span><span class="dt">string</span> name<span class="op">,</span> <span class="dt">string</span> path<span class="op">)</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">path</span> <span class="op">=</span> path<span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// A helper class that stores a list of TensorFlow.js model names and file paths</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span>System<span class="op">.</span><span class="fu">Serializable</span><span class="op">]</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> ModelList</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> List<span class="op">&lt;</span>ModelData<span class="op">&gt;</span> models<span class="op">;</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="fu">ModelList</span><span class="op">(</span>List<span class="op">&lt;</span>ModelData<span class="op">&gt;</span> models<span class="op">)</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">models</span> <span class="op">=</span> models<span class="op">;</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="fu">Startup</span><span class="op">()</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> tfjsModelsDir <span class="op">=</span> <span class="st">"TFJSModels"</span><span class="op">;</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        List<span class="op">&lt;</span>ModelData<span class="op">&gt;</span> models <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span>ModelData<span class="op">&gt;();</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span><span class="st">"Available models"</span><span class="op">);</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the paths for each model folder</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">foreach</span> <span class="op">(</span><span class="dt">string</span> dir <span class="kw">in</span> Directory<span class="op">.</span><span class="fu">GetDirectories</span><span class="op">(</span>$<span class="st">"{Application.streamingAssetsPath}/{tfjsModelsDir}"</span><span class="op">))</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>            <span class="dt">string</span> dirStr <span class="op">=</span> dir<span class="op">.</span><span class="fu">Replace</span><span class="op">(</span><span class="st">"</span><span class="sc">\\</span><span class="st">"</span><span class="op">,</span> <span class="st">"/"</span><span class="op">);</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Extract the model folder name</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>            <span class="dt">string</span><span class="op">[]</span> splits <span class="op">=</span> dirStr<span class="op">.</span><span class="fu">Split</span><span class="op">(</span><span class="ch">'/'</span><span class="op">);</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>            <span class="dt">string</span> modelName <span class="op">=</span> splits<span class="op">[</span>splits<span class="op">.</span><span class="fu">Length</span> <span class="op">-</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Get the paths for the model.json file for each model</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">foreach</span> <span class="op">(</span><span class="dt">string</span> file <span class="kw">in</span> Directory<span class="op">.</span><span class="fu">GetFiles</span><span class="op">(</span>dirStr<span class="op">))</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> <span class="op">(</span>file<span class="op">.</span><span class="fu">EndsWith</span><span class="op">(</span><span class="st">"model.json"</span><span class="op">))</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">string</span> fileStr <span class="op">=</span> file<span class="op">.</span><span class="fu">Replace</span><span class="op">(</span><span class="st">"</span><span class="sc">\\</span><span class="st">"</span><span class="op">,</span> <span class="st">"/"</span><span class="op">).</span><span class="fu">Replace</span><span class="op">(</span>Application<span class="op">.</span><span class="fu">streamingAssetsPath</span><span class="op">,</span> <span class="st">""</span><span class="op">);</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>                    models<span class="op">.</span><span class="fu">Add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ModelData</span><span class="op">(</span>modelName<span class="op">,</span> fileStr<span class="op">));</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        ModelList modelList <span class="op">=</span> <span class="kw">new</span> <span class="fu">ModelList</span><span class="op">(</span>models<span class="op">);</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Format the list of available models as a string in JSON format</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> json <span class="op">=</span> JsonUtility<span class="op">.</span><span class="fu">ToJson</span><span class="op">(</span>modelList<span class="op">);</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Model List JSON: {json}"</span><span class="op">);</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Write the list of available TensorFlow.js models to a JSON file</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">using</span> StreamWriter writer <span class="op">=</span> <span class="kw">new</span> <span class="fu">StreamWriter</span><span class="op">(</span>$<span class="st">"{Application.streamingAssetsPath}/models.json"</span><span class="op">);</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">Write</span><span class="op">(</span>json<span class="op">);</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a><span class="kw">#endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="define-public-variables" class="level3">
<h3 class="anchored" data-anchor-id="define-public-variables">Define public variables</h3>
<p>The required public variables are mostly the same as the <a href="../tensorflow-js-unity-tutorial/part-2/#define-public-variables"><code>ImageClassifier</code> script</a>.</p>
<p><strong>Define scene object variables</strong></p>
<p>We’ll add a new variable to indicate whether to mirror the in-scene screen.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Scene Objects"</span><span class="op">)]</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The Screen object for the scene"</span><span class="op">)]</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Transform screen<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Mirror the in-game screen."</span><span class="op">)]</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> mirrorScreen <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define data processing variables</strong></p>
<p>We’ll increase the default target input resolution from <code>216</code> to <code>224</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Data Processing"</span><span class="op">)]</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The target minimum model input dimensions"</span><span class="op">)]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> targetDim <span class="op">=</span> <span class="dv">224</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define output processing variables</strong></p>
<p>We’ll replace the <code>classLabels</code> <a href="https://docs.unity3d.com/ScriptReference/TextAsset.html">TextAsset</a> with a variable for the colormap JSON file.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Output Processing"</span><span class="op">)]</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"A json file containing the colormaps for object classes"</span><span class="op">)]</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> TextAsset colormapFile<span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Minimum confidence score for keeping predictions"</span><span class="op">)]</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>f<span class="op">)]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">float</span> minConfidence <span class="op">=</span> <span class="fl">0.5f</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for debugging (unchanged)</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Debugging"</span><span class="op">)]</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Print debugging messages to the console"</span><span class="op">)]</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> printDebugMessages <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define webcam variables (unchanged)</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"Webcam"</span><span class="op">)]</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Use a webcam as input"</span><span class="op">)]</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> useWebcam <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The requested webcam dimensions"</span><span class="op">)]</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Vector2Int webcamDims <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector2Int</span><span class="op">(</span><span class="dv">1280</span><span class="op">,</span> <span class="dv">720</span><span class="op">);</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The requested webcam framerate"</span><span class="op">)]</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">60</span><span class="op">)]</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> webcamFPS <span class="op">=</span> <span class="dv">60</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for user interface</strong></p>
<p>We’ll replace the <code>displayPredictedClass</code> GUI variable with two new variables that control displaying bounding boxes and the number of detected objects.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"GUI"</span><span class="op">)]</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Display predicted class"</span><span class="op">)]</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> displayBoundingBoxes <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Display number of detected objects"</span><span class="op">)]</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> displayProposalCount <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"Display fps"</span><span class="op">)]</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">bool</span> displayFPS <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The on-screen text color"</span><span class="op">)]</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Color textColor <span class="op">=</span> Color<span class="op">.</span><span class="fu">yellow</span><span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The scale value for the on-screen font size"</span><span class="op">)]</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Range</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">99</span><span class="op">)]</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> fontScale <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The number of seconds to wait between refreshing the fps value"</span><span class="op">)]</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Range</span><span class="op">(</span><span class="fl">0.01f</span><span class="op">,</span> <span class="fl">1.0f</span><span class="op">)]</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">float</span> fpsRefreshRate <span class="op">=</span> <span class="fl">0.1f</span><span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The toggle for using a webcam as the input source"</span><span class="op">)]</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Toggle useWebcamToggle<span class="op">;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The dropdown menu that lists available webcam devices"</span><span class="op">)]</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Dropdown webcamDropdown<span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The dropdown menu that lists available TFJS models"</span><span class="op">)]</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Dropdown modelDropdown<span class="op">;</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The dropdown menu that lists available TFJS backends"</span><span class="op">)]</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> Dropdown backendDropdown<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define TensorFlow.js variables (unchanged)</strong></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Header</span><span class="op">(</span><span class="st">"TFJS"</span><span class="op">)]</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The name of the TFJS models folder"</span><span class="op">)]</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">string</span> tfjsModelsDir <span class="op">=</span> <span class="st">"TFJSModels"</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-private-variables" class="level3">
<h3 class="anchored" data-anchor-id="define-private-variables">Define private variables</h3>
<p>We’ll add the required private variables right below the public variables.</p>
<p><strong>Define private webcam variables (unchanged)</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// List of available webcam devices</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> WebCamDevice<span class="op">[]</span> webcamDevices<span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Live video input from a webcam</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> WebCamTexture webcamTexture<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">// The name of the current webcam  device</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">string</span> currentWebcam<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define input variables (unchanged)</strong></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The test image dimensions</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>Vector2Int imageDims<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">// The test image texture</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>Texture imageTexture<span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">// The current screen object dimensions</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>Vector2Int screenDims<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">// The model GPU input texture</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>RenderTexture inputTextureGPU<span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">// The model CPU input texture</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>Texture2D inputTextureCPU<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for colormap</strong></p>
<p>We’ll create a couple of classes to parse the JSON colormap content.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A class for parsing in colormaps from a JSON file</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>System<span class="op">.</span><span class="fu">Serializable</span><span class="op">]</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ColorMap <span class="op">{</span> <span class="kw">public</span> <span class="dt">string</span> label<span class="op">;</span> <span class="kw">public</span> <span class="dt">float</span><span class="op">[]</span> color<span class="op">;</span> <span class="op">}</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">// A class for reading in a list of colormaps from a JSON file</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>System<span class="op">.</span><span class="fu">Serializable</span><span class="op">]</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ColorMapList <span class="op">{</span> <span class="kw">public</span> List<span class="op">&lt;</span>ColorMap<span class="op">&gt;</span> items<span class="op">;</span> <span class="op">}</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores a list of colormaps from a JSON file</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> ColorMapList colormapList<span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">// A list of colors that map to class labels</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Color<span class="op">[]</span> colors<span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">// A list of single pixel textures that map to class labels</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Texture2D<span class="op">[]</span> colorTextures<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variable to track whether a model is initialized (unchanged)</strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores whether the TensorFlow.js model is ready for inference</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> modelInitialized<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for tracking the framerate (unchanged)</strong></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The current frame rate value</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">int</span> fps <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Controls when the frame rate value updates</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">float</span> fpsTimer <span class="op">=</span> <span class="dv">0</span>f<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables to store values for GUI dropdowns (unchanged)</strong></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// File paths for the available TFJS models</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> modelPaths <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;();</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Names of the available TFJS models</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> modelNames <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;();</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Names of the available TFJS backends</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> tfjsBackends <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> <span class="op">{</span> <span class="st">"webgl"</span> <span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for reading the <code>models.json</code> file (unchanged)</strong></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// A helper class to store the name and file path of a TensorFlow.js model</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>System<span class="op">.</span><span class="fu">Serializable</span><span class="op">]</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelData <span class="op">{</span> <span class="kw">public</span> <span class="dt">string</span> name<span class="op">;</span> <span class="kw">public</span> <span class="dt">string</span> path<span class="op">;</span> <span class="op">}</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">// A helper class to store a read a list of available TensorFlow.js models from a JSON file</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>System<span class="op">.</span><span class="fu">Serializable</span><span class="op">]</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ModelList <span class="op">{</span> <span class="kw">public</span> List<span class="op">&lt;</span>ModelData<span class="op">&gt;</span> models<span class="op">;</span> <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for normalization stats</strong></p>
<p>The YOLOX model uses the standard ImageNet normalization stats from PyTorch.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The normalization stats for the YOLOX model</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span><span class="op">[]</span> mean <span class="op">=</span> <span class="kw">new</span> <span class="dt">float</span><span class="op">[]</span> <span class="op">{</span> <span class="fl">0.485f</span><span class="op">,</span> <span class="fl">0.456f</span><span class="op">,</span> <span class="fl">0.406f</span> <span class="op">};</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span><span class="op">[]</span> std <span class="op">=</span> <span class="kw">new</span> <span class="dt">float</span><span class="op">[]</span> <span class="op">{</span> <span class="fl">0.229f</span><span class="op">,</span> <span class="fl">0.224f</span><span class="op">,</span> <span class="fl">0.225f</span> <span class="op">};</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define struct to store information for object predictions</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Stores the information for a single object</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span><span class="co"> </span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">struct</span> Object</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The X coordinate for the top left bounding box corner</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">float</span> x0<span class="op">;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The Y coordinate for the top left bounding box cornder</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">float</span> y0<span class="op">;</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The width of the bounding box</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">float</span> width<span class="op">;</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The height of the bounding box</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">float</span> height<span class="op">;</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The object class index for the detected object</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> label<span class="op">;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The model confidence score for the object</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">float</span> prob<span class="op">;</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Object</span><span class="op">(</span><span class="dt">float</span> x0<span class="op">,</span> <span class="dt">float</span> y0<span class="op">,</span> <span class="dt">float</span> width<span class="op">,</span> <span class="dt">float</span> height<span class="op">,</span> <span class="dt">int</span> label<span class="op">,</span> <span class="dt">float</span> prob<span class="op">)</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">x0</span> <span class="op">=</span> x0<span class="op">;</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">y0</span> <span class="op">=</span> y0<span class="op">;</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">width</span> <span class="op">=</span> width<span class="op">;</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">height</span> <span class="op">=</span> height<span class="op">;</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">label</span> <span class="op">=</span> label<span class="op">;</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">prob</span> <span class="op">=</span> prob<span class="op">;</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define struct to store grid offset and stride values</strong></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Store grid offset and stride values to decode a section of the model output</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">struct</span> GridAndStride</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> grid0<span class="op">;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> grid1<span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> stride<span class="op">;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">GridAndStride</span><span class="op">(</span><span class="dt">int</span> grid0<span class="op">,</span> <span class="dt">int</span> grid1<span class="op">,</span> <span class="dt">int</span> stride<span class="op">)</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">grid0</span> <span class="op">=</span> grid0<span class="op">;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">grid1</span> <span class="op">=</span> grid1<span class="op">;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">stride</span> <span class="op">=</span> stride<span class="op">;</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define variables for processing model output</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores information for the current list of detected objects</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Object<span class="op">[]</span> objectInfoArray<span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores the grid and stride values to navigate the raw model output</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>List<span class="op">&lt;</span>GridAndStride<span class="op">&gt;</span> grid_strides <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span>GridAndStride<span class="op">&gt;();</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">// The stride values used to generate the gride_strides vector</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span><span class="op">[]</span> strides <span class="op">=</span> <span class="kw">new</span> <span class="dt">int</span><span class="op">[]</span> <span class="op">{</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">16</span><span class="op">,</span> <span class="dv">32</span> <span class="op">};</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores the raw model output</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span><span class="op">[]</span> output_array<span class="op">;</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">// The scale values used to adjust the model output to the source image resolution</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> scale_x<span class="op">;</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> scale_y<span class="op">;</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Stores the number of detected objects</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">int</span> numObjects<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-initialization-methods" class="level3">
<h3 class="anchored" data-anchor-id="define-initialization-methods">Define Initialization Methods</h3>
<p>The initialization methods are identical to those from the <code>ImageClassifier</code> script except for <code>UpdateTFJSModel</code>.</p>
<p><strong>Define method to initialize a webcam device (unchanged)</strong></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Initialize the selected webcam device</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"deviceName"</span><span class="kw">&gt;</span><span class="co">The name of the selected webcam device</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">InitializeWebcam</span><span class="op">(</span><span class="dt">string</span> deviceName<span class="op">)</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Stop any webcams already playing</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>webcamTexture <span class="op">&amp;&amp;</span> webcamTexture<span class="op">.</span><span class="fu">isPlaying</span><span class="op">)</span> webcamTexture<span class="op">.</span><span class="fu">Stop</span><span class="op">();</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create a new WebCamTexture</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    webcamTexture <span class="op">=</span> <span class="kw">new</span> <span class="fu">WebCamTexture</span><span class="op">(</span>deviceName<span class="op">,</span> webcamDims<span class="op">.</span><span class="fu">x</span><span class="op">,</span> webcamDims<span class="op">.</span><span class="fu">y</span><span class="op">,</span> webcamFPS<span class="op">);</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Start the webcam</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    webcamTexture<span class="op">.</span><span class="fu">Play</span><span class="op">();</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if webcam is playing</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    useWebcam <span class="op">=</span> webcamTexture<span class="op">.</span><span class="fu">isPlaying</span><span class="op">;</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update toggle value</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    useWebcamToggle<span class="op">.</span><span class="fu">SetIsOnWithoutNotify</span><span class="op">(</span>useWebcam<span class="op">);</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>useWebcam <span class="op">?</span> <span class="st">"Webcam is playing"</span> <span class="op">:</span> <span class="st">"Webcam not playing, option disabled"</span><span class="op">);</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to initialize the in-scene screen object (unchanged)</strong></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Resize and position an in-scene screen object</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">InitializeScreen</span><span class="op">()</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the texture for the screen object</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    screen<span class="op">.</span><span class="fu">gameObject</span><span class="op">.</span><span class="fu">GetComponent</span><span class="op">&lt;</span>MeshRenderer<span class="op">&gt;().</span><span class="fu">material</span><span class="op">.</span><span class="fu">mainTexture</span> <span class="op">=</span> useWebcam <span class="op">?</span> webcamTexture <span class="op">:</span> imageTexture<span class="op">;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the screen dimensions</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    screenDims <span class="op">=</span> useWebcam <span class="op">?</span> <span class="kw">new</span> <span class="fu">Vector2Int</span><span class="op">(</span>webcamTexture<span class="op">.</span><span class="fu">width</span><span class="op">,</span> webcamTexture<span class="op">.</span><span class="fu">height</span><span class="op">)</span> <span class="op">:</span> imageDims<span class="op">;</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Flip the screen around the Y-Axis when using webcam</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> yRotation <span class="op">=</span> useWebcam <span class="op">?</span> <span class="dv">180</span>f <span class="op">:</span> <span class="dv">0</span>f<span class="op">;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Invert the scale value for the Z-Axis when using webcam</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> zScale <span class="op">=</span> useWebcam <span class="op">?</span> <span class="op">-</span><span class="dv">1</span>f <span class="op">:</span> <span class="dv">1</span>f<span class="op">;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set screen rotation</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    screen<span class="op">.</span><span class="fu">rotation</span> <span class="op">=</span> Quaternion<span class="op">.</span><span class="fu">Euler</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> yRotation<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust the screen dimensions</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    screen<span class="op">.</span><span class="fu">localScale</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector3</span><span class="op">(</span>screenDims<span class="op">.</span><span class="fu">x</span><span class="op">,</span> screenDims<span class="op">.</span><span class="fu">y</span><span class="op">,</span> zScale<span class="op">);</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust the screen position</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    screen<span class="op">.</span><span class="fu">position</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector3</span><span class="op">(</span>screenDims<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> screenDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to switch TensorFlow.js models</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Load a TensorFlow.js model</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">UpdateTFJSModel</span><span class="op">()</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load TensorFlow.js model in JavaScript plugin</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    WebGLPlugin<span class="op">.</span><span class="fu">InitTFJSModel</span><span class="op">(</span>modelPaths<span class="op">[</span>modelDropdown<span class="op">.</span><span class="fu">value</span><span class="op">],</span> mean<span class="op">,</span> std<span class="op">);</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to read the list of available TensorFlow.js models (unchanged)</strong></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Get the names and paths of the available TensorFlow.js models</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"json"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">GetTFJSModels</span><span class="op">(</span><span class="dt">string</span> json<span class="op">)</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    ModelList modelList <span class="op">=</span> JsonUtility<span class="op">.</span><span class="fu">FromJson</span><span class="op">&lt;</span>ModelList<span class="op">&gt;(</span>json<span class="op">);</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> <span class="op">(</span>ModelData model <span class="kw">in</span> modelList<span class="op">.</span><span class="fu">models</span><span class="op">)</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Debug.Log($"{model.name}: {model.path}");</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        modelNames<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>model<span class="op">.</span><span class="fu">name</span><span class="op">);</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> path <span class="op">=</span> $<span class="st">"{Application.streamingAssetsPath}{model.path}"</span><span class="op">;</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        modelPaths<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>path<span class="op">);</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove default dropdown options</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    modelDropdown<span class="op">.</span><span class="fu">ClearOptions</span><span class="op">();</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add TFJS model names to menu</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    modelDropdown<span class="op">.</span><span class="fu">AddOptions</span><span class="op">(</span>modelNames<span class="op">);</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Select the first option in the dropdown</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    modelDropdown<span class="op">.</span><span class="fu">SetValueWithoutNotify</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to download the list of available TensorFlow.js models (unchanged)</strong></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Download the JSON file with the available TFJS model information</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"uri"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>IEnumerator <span class="fu">GetRequest</span><span class="op">(</span><span class="dt">string</span> uri<span class="op">)</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="op">(</span>UnityWebRequest webRequest <span class="op">=</span> UnityWebRequest<span class="op">.</span><span class="fu">Get</span><span class="op">(</span>uri<span class="op">))</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Request and wait for the desired page.</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">yield</span> <span class="kw">return</span> webRequest<span class="op">.</span><span class="fu">SendWebRequest</span><span class="op">();</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span><span class="op">[]</span> pages <span class="op">=</span> uri<span class="op">.</span><span class="fu">Split</span><span class="op">(</span><span class="ch">'/'</span><span class="op">);</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> page <span class="op">=</span> pages<span class="op">.</span><span class="fu">Length</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">switch</span> <span class="op">(</span>webRequest<span class="op">.</span><span class="fu">result</span><span class="op">)</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">case</span> UnityWebRequest<span class="op">.</span><span class="fu">Result</span><span class="op">.</span><span class="fu">ConnectionError</span><span class="op">:</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">case</span> UnityWebRequest<span class="op">.</span><span class="fu">Result</span><span class="op">.</span><span class="fu">DataProcessingError</span><span class="op">:</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>                Debug<span class="op">.</span><span class="fu">LogError</span><span class="op">(</span>pages<span class="op">[</span>page<span class="op">]</span> <span class="op">+</span> <span class="st">": Error: "</span> <span class="op">+</span> webRequest<span class="op">.</span><span class="fu">error</span><span class="op">);</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>                <span class="kw">break</span><span class="op">;</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">case</span> UnityWebRequest<span class="op">.</span><span class="fu">Result</span><span class="op">.</span><span class="fu">ProtocolError</span><span class="op">:</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>                Debug<span class="op">.</span><span class="fu">LogError</span><span class="op">(</span>pages<span class="op">[</span>page<span class="op">]</span> <span class="op">+</span> <span class="st">": HTTP Error: "</span> <span class="op">+</span> webRequest<span class="op">.</span><span class="fu">error</span><span class="op">);</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>                <span class="kw">break</span><span class="op">;</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">case</span> UnityWebRequest<span class="op">.</span><span class="fu">Result</span><span class="op">.</span><span class="fu">Success</span><span class="op">:</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>                Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>pages<span class="op">[</span>page<span class="op">]</span> <span class="op">+</span> <span class="st">":</span><span class="sc">\n</span><span class="st">Received: "</span> <span class="op">+</span> webRequest<span class="op">.</span><span class="fu">downloadHandler</span><span class="op">.</span><span class="fu">text</span><span class="op">);</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Extract the available model names and file paths from the JSON string</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>                <span class="fu">GetTFJSModels</span><span class="op">(</span>webRequest<span class="op">.</span><span class="fu">downloadHandler</span><span class="op">.</span><span class="fu">text</span><span class="op">);</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Initialize one of the available TensorFlow.js models</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>                <span class="fu">UpdateTFJSModel</span><span class="op">();</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>                <span class="kw">break</span><span class="op">;</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to initialize GUI dropdown menu options (unchanged)</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Initialize the GUI dropdown list</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">InitializeDropdown</span><span class="op">()</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create list of webcam device names</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> webcamNames <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;();</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> <span class="op">(</span>WebCamDevice device <span class="kw">in</span> webcamDevices<span class="op">)</span> webcamNames<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>device<span class="op">.</span><span class="fu">name</span><span class="op">);</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove default dropdown options</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    webcamDropdown<span class="op">.</span><span class="fu">ClearOptions</span><span class="op">();</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add webcam device names to dropdown menu</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    webcamDropdown<span class="op">.</span><span class="fu">AddOptions</span><span class="op">(</span>webcamNames<span class="op">);</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the value for the dropdown to the current webcam device</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    webcamDropdown<span class="op">.</span><span class="fu">SetValueWithoutNotify</span><span class="op">(</span>webcamNames<span class="op">.</span><span class="fu">IndexOf</span><span class="op">(</span>currentWebcam<span class="op">));</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the available TensorFlow.js models</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">string</span> modelListPath <span class="op">=</span> $<span class="st">"{Application.streamingAssetsPath}/models.json"</span><span class="op">;</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">StartCoroutine</span><span class="op">(</span><span class="fu">GetRequest</span><span class="op">(</span>modelListPath<span class="op">));</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove default dropdown options</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    backendDropdown<span class="op">.</span><span class="fu">ClearOptions</span><span class="op">();</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add TFJS backend names to menu</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    backendDropdown<span class="op">.</span><span class="fu">AddOptions</span><span class="op">(</span>tfjsBackends<span class="op">);</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Select the first option in the dropdown</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    backendDropdown<span class="op">.</span><span class="fu">SetValueWithoutNotify</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to initialize the in-scene camera object (unchanged)</strong></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Resize and position the main camera based on an in-scene screen object</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"screenDims"</span><span class="kw">&gt;</span><span class="co">The dimensions of an in-scene screen object</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">InitializeCamera</span><span class="op">(</span>Vector2Int screenDims<span class="op">,</span> <span class="dt">string</span> cameraName <span class="op">=</span> <span class="st">"Main Camera"</span><span class="op">)</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get a reference to the Main Camera GameObject</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    GameObject camera <span class="op">=</span> GameObject<span class="op">.</span><span class="fu">Find</span><span class="op">(</span>cameraName<span class="op">);</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust the camera position to account for updates to the screenDims</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    camera<span class="op">.</span><span class="fu">transform</span><span class="op">.</span><span class="fu">position</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector3</span><span class="op">(</span>screenDims<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> screenDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="op">-</span><span class="dv">10</span>f<span class="op">);</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Render objects with no perspective (i.e. 2D)</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    camera<span class="op">.</span><span class="fu">GetComponent</span><span class="op">&lt;</span>Camera<span class="op">&gt;().</span><span class="fu">orthographic</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust the camera size to account for updates to the screenDims</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    camera<span class="op">.</span><span class="fu">GetComponent</span><span class="op">&lt;</span>Camera<span class="op">&gt;().</span><span class="fu">orthographicSize</span> <span class="op">=</span> screenDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-awake-method-unchanged" class="level3">
<h3 class="anchored" data-anchor-id="define-awake-method-unchanged">Define Awake method (unchanged)</h3>
<div class="sourceCode" id="cb33"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Awake is called when the script instance is being loaded</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">Awake</span><span class="op">()</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    WebGLPlugin<span class="op">.</span><span class="fu">GetExternalJS</span><span class="op">();</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-start-method" class="level3">
<h3 class="anchored" data-anchor-id="define-start-method">Define Start method</h3>
<p>In the Start method, we need to initialize the color map variables with the JSON file.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Start is called before the first frame update</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">Start</span><span class="op">()</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the source image texture</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    imageTexture <span class="op">=</span> screen<span class="op">.</span><span class="fu">gameObject</span><span class="op">.</span><span class="fu">GetComponent</span><span class="op">&lt;</span>MeshRenderer<span class="op">&gt;().</span><span class="fu">material</span><span class="op">.</span><span class="fu">mainTexture</span><span class="op">;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the source image dimensions as a Vector2Int</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    imageDims <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector2Int</span><span class="op">(</span>imageTexture<span class="op">.</span><span class="fu">width</span><span class="op">,</span> imageTexture<span class="op">.</span><span class="fu">height</span><span class="op">);</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize list of available webcam devices</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    webcamDevices <span class="op">=</span> WebCamTexture<span class="op">.</span><span class="fu">devices</span><span class="op">;</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> <span class="op">(</span>WebCamDevice device <span class="kw">in</span> webcamDevices<span class="op">)</span> Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>device<span class="op">.</span><span class="fu">name</span><span class="op">);</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    currentWebcam <span class="op">=</span> webcamDevices<span class="op">[</span><span class="dv">0</span><span class="op">].</span><span class="fu">name</span><span class="op">;</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    useWebcam <span class="op">=</span> webcamDevices<span class="op">.</span><span class="fu">Length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> useWebcam <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize webcam</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>useWebcam<span class="op">)</span> <span class="fu">InitializeWebcam</span><span class="op">(</span>currentWebcam<span class="op">);</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize and position the screen object using the source image dimensions</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeScreen</span><span class="op">();</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize and position the main camera using the source image dimensions</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeCamera</span><span class="op">(</span>screenDims<span class="op">);</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize list of color maps from JSON file</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    colormapList <span class="op">=</span> JsonUtility<span class="op">.</span><span class="fu">FromJson</span><span class="op">&lt;</span>ColorMapList<span class="op">&gt;(</span>colormapFile<span class="op">.</span><span class="fu">text</span><span class="op">);</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the list of colors</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> <span class="kw">new</span> Color<span class="op">[</span>colormapList<span class="op">.</span><span class="fu">items</span><span class="op">.</span><span class="fu">Count</span><span class="op">];</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the list of color textures</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    colorTextures <span class="op">=</span> <span class="kw">new</span> Texture2D<span class="op">[</span>colormapList<span class="op">.</span><span class="fu">items</span><span class="op">.</span><span class="fu">Count</span><span class="op">];</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Populate the color and color texture arrays</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> colors<span class="op">.</span><span class="fu">Length</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create a new color object</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>        colors<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Color</span><span class="op">(</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>            colormapList<span class="op">.</span><span class="fu">items</span><span class="op">[</span>i<span class="op">].</span><span class="fu">color</span><span class="op">[</span><span class="dv">0</span><span class="op">],</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>            colormapList<span class="op">.</span><span class="fu">items</span><span class="op">[</span>i<span class="op">].</span><span class="fu">color</span><span class="op">[</span><span class="dv">1</span><span class="op">],</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>            colormapList<span class="op">.</span><span class="fu">items</span><span class="op">[</span>i<span class="op">].</span><span class="fu">color</span><span class="op">[</span><span class="dv">2</span><span class="op">]);</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create a single-pixel texture</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>        colorTextures<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> <span class="fu">Texture2D</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>        colorTextures<span class="op">[</span>i<span class="op">].</span><span class="fu">SetPixel</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> colors<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>        colorTextures<span class="op">[</span>i<span class="op">].</span><span class="fu">Apply</span><span class="op">();</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the webcam dropdown list</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeDropdown</span><span class="op">();</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update the current TensorFlow.js compute backend</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    WebGLPlugin<span class="op">.</span><span class="fu">SetTFJSBackend</span><span class="op">(</span>tfjsBackends<span class="op">[</span>backendDropdown<span class="op">.</span><span class="fu">value</span><span class="op">]);</span></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-processing-methods" class="level3">
<h3 class="anchored" data-anchor-id="define-processing-methods">Define Processing Methods</h3>
<p>The preprocessing methods are identical to those from the <code>ImageClassifier</code> script. However, we need to add some post-processing methods to extract object predictions from the raw model output.</p>
<p><strong>Define method to calculate input resolution (unchanged)</strong></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Scale the source image resolution to the target input dimensions</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// while maintaing the source aspect ratio.</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"imageDims"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"targetDims"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>Vector2Int <span class="fu">CalculateInputDims</span><span class="op">(</span>Vector2Int imageDims<span class="op">,</span> <span class="dt">int</span> targetDim<span class="op">)</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clamp the minimum dimension value to 64px</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    targetDim <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>targetDim<span class="op">,</span> <span class="dv">64</span><span class="op">);</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    Vector2Int inputDims <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector2Int</span><span class="op">();</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate the input dimensions using the target minimum dimension</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>imageDims<span class="op">.</span><span class="fu">x</span> <span class="op">&gt;=</span> imageDims<span class="op">.</span><span class="fu">y</span><span class="op">)</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>        inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>imageDims<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> <span class="op">((</span><span class="dt">float</span><span class="op">)</span>imageDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>targetDim<span class="op">));</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        inputDims<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> targetDim<span class="op">;</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> targetDim<span class="op">;</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        inputDims<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>imageDims<span class="op">.</span><span class="fu">y</span> <span class="op">/</span> <span class="op">((</span><span class="dt">float</span><span class="op">)</span>imageDims<span class="op">.</span><span class="fu">x</span> <span class="op">/</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>targetDim<span class="op">));</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> inputDims<span class="op">;</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to scale bounding boxes to the display resolution</strong></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Scale the latest bounding boxes to the display resolution</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ScaleBoundingBoxes</span><span class="op">()</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Process new detected objects</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> objectInfoArray<span class="op">.</span><span class="fu">Length</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// The smallest dimension of the screen</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> minScreenDim <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Min</span><span class="op">(</span>screen<span class="op">.</span><span class="fu">transform</span><span class="op">.</span><span class="fu">localScale</span><span class="op">.</span><span class="fu">x</span><span class="op">,</span> screen<span class="op">.</span><span class="fu">transform</span><span class="op">.</span><span class="fu">localScale</span><span class="op">.</span><span class="fu">y</span><span class="op">);</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// The smallest input dimension</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> minInputDim <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Min</span><span class="op">(</span>inputTextureCPU<span class="op">.</span><span class="fu">width</span><span class="op">,</span> inputTextureCPU<span class="op">.</span><span class="fu">height</span><span class="op">);</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate the scale value between the in-game screen and input dimensions</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> minImgScale <span class="op">=</span> minScreenDim <span class="op">/</span> minInputDim<span class="op">;</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate the scale value between the in-game screen and display</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> displayScale <span class="op">=</span> Screen<span class="op">.</span><span class="fu">height</span> <span class="op">/</span> screen<span class="op">.</span><span class="fu">transform</span><span class="op">.</span><span class="fu">localScale</span><span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Scale bounding box to in-game screen resolution and flip the bbox coordinates vertically</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> x0 <span class="op">=</span> objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">x0</span> <span class="op">*</span> minImgScale<span class="op">;</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> y0 <span class="op">=</span> <span class="op">(</span>inputTextureCPU<span class="op">.</span><span class="fu">height</span> <span class="op">-</span> objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">y0</span><span class="op">)</span> <span class="op">*</span> minImgScale<span class="op">;</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> width <span class="op">=</span> objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">width</span> <span class="op">*</span> minImgScale<span class="op">;</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> height <span class="op">=</span> objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">height</span> <span class="op">*</span> minImgScale<span class="op">;</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Mirror bounding box across screen</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>mirrorScreen <span class="op">&amp;&amp;</span> useWebcam<span class="op">)</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>            x0 <span class="op">=</span> screen<span class="op">.</span><span class="fu">transform</span><span class="op">.</span><span class="fu">localScale</span><span class="op">.</span><span class="fu">x</span> <span class="op">-</span> x0 <span class="op">-</span> width<span class="op">;</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Scale bounding boxes to display resolution</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>        objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">x0</span> <span class="op">=</span> x0 <span class="op">*</span> displayScale<span class="op">;</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>        objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">y0</span> <span class="op">=</span> y0 <span class="op">*</span> displayScale<span class="op">;</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>        objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">width</span> <span class="op">=</span> width <span class="op">*</span> displayScale<span class="op">;</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>        objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">height</span> <span class="op">=</span> height <span class="op">*</span> displayScale<span class="op">;</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Offset the bounding box coordinates based on the difference between the in-game screen and display</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>        objectInfoArray<span class="op">[</span>i<span class="op">].</span><span class="fu">x0</span> <span class="op">+=</span> <span class="op">(</span>Screen<span class="op">.</span><span class="fu">width</span> <span class="op">-</span> screen<span class="op">.</span><span class="fu">transform</span><span class="op">.</span><span class="fu">localScale</span><span class="op">.</span><span class="fu">x</span> <span class="op">*</span> displayScale<span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to generate stride values to navigate the raw model output</strong></p>
<p>We’ll generate offset values based on the input dimensions and stride values, which we can use to traverse the output array.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Generate offset values to navigate the raw model output</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"height"</span><span class="kw">&gt;</span><span class="co">The model input height</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"width"</span><span class="kw">&gt;</span><span class="co">The model input width</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>List<span class="op">&lt;</span>GridAndStride<span class="op">&gt;</span> <span class="fu">GenerateGridStrides</span><span class="op">(</span><span class="dt">int</span> height<span class="op">,</span> <span class="dt">int</span> width<span class="op">)</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    List<span class="op">&lt;</span>GridAndStride<span class="op">&gt;</span> grid_strides <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span>GridAndStride<span class="op">&gt;();</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Iterate through each stride value</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> <span class="op">(</span><span class="dt">int</span> stride <span class="kw">in</span> strides<span class="op">)</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate the grid dimensions</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> grid_height <span class="op">=</span> height <span class="op">/</span> stride<span class="op">;</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> grid_width <span class="op">=</span> width <span class="op">/</span> stride<span class="op">;</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Gride: {grid_height} x {grid_width}"</span><span class="op">);</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store each combination of grid coordinates</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> g1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> g1 <span class="op">&lt;</span> grid_height<span class="op">;</span> g1<span class="op">++)</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> g0 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> g0 <span class="op">&lt;</span> grid_width<span class="op">;</span> g0<span class="op">++)</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>                grid_strides<span class="op">.</span><span class="fu">Add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">GridAndStride</span><span class="op">(</span>g0<span class="op">,</span> g1<span class="op">,</span> stride<span class="op">));</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> grid_strides<span class="op">;</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to generate object detection proposals from the raw model output</strong></p>
<p>Next, we define a method to iterate through the output array and decode the bounding box information for each object proposal. We only want to keep the ones with a high enough confidence score. The model predicts the center coordinates of a bounding box, but we store the coordinates for the top-left corner as we use this to draw the rectangles on the screen.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Generate object detection proposals from the raw model output</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"model_output"</span><span class="kw">&gt;</span><span class="co">The raw model output</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"proposal_length"</span><span class="kw">&gt;</span><span class="co">The length of a single proposal</span><span class="kw">&lt;/param&gt;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>List<span class="op">&lt;</span>Object<span class="op">&gt;</span> <span class="fu">GenerateYOLOXProposals</span><span class="op">(</span><span class="dt">float</span><span class="op">[]</span> model_output<span class="op">,</span> <span class="dt">int</span> proposal_length<span class="op">)</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    List<span class="op">&lt;</span>Object<span class="op">&gt;</span> proposals <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span>Object<span class="op">&gt;();</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Obtain the number of classes the model was trained to detect</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_classes <span class="op">=</span> proposal_length <span class="op">-</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> anchor_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> anchor_idx <span class="op">&lt;</span> grid_strides<span class="op">.</span><span class="fu">Count</span><span class="op">;</span> anchor_idx<span class="op">++)</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the current grid and stride values</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> grid0 <span class="op">=</span> grid_strides<span class="op">[</span>anchor_idx<span class="op">].</span><span class="fu">grid0</span><span class="op">;</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> grid1 <span class="op">=</span> grid_strides<span class="op">[</span>anchor_idx<span class="op">].</span><span class="fu">grid1</span><span class="op">;</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> stride <span class="op">=</span> grid_strides<span class="op">[</span>anchor_idx<span class="op">].</span><span class="fu">stride</span><span class="op">;</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the starting index for the current proposal</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> start_idx <span class="op">=</span> anchor_idx <span class="op">*</span> proposal_length<span class="op">;</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the coordinates for the center of the predicted bounding box</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> x_center <span class="op">=</span> <span class="op">(</span>model_output<span class="op">[</span>start_idx <span class="op">+</span> <span class="dv">0</span><span class="op">]</span> <span class="op">+</span> grid0<span class="op">)</span> <span class="op">*</span> stride<span class="op">;</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> y_center <span class="op">=</span> <span class="op">(</span>model_output<span class="op">[</span>start_idx <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">+</span> grid1<span class="op">)</span> <span class="op">*</span> stride<span class="op">;</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the dimensions for the predicted bounding box</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> w <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Exp</span><span class="op">(</span>model_output<span class="op">[</span>start_idx <span class="op">+</span> <span class="dv">2</span><span class="op">])</span> <span class="op">*</span> stride<span class="op">;</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> h <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Exp</span><span class="op">(</span>model_output<span class="op">[</span>start_idx <span class="op">+</span> <span class="dv">3</span><span class="op">])</span> <span class="op">*</span> stride<span class="op">;</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate the coordinates for the upper left corner of the bounding box</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> x0 <span class="op">=</span> x_center <span class="op">-</span> w <span class="op">*</span> <span class="fl">0.5f</span><span class="op">;</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> y0 <span class="op">=</span> y_center <span class="op">-</span> h <span class="op">*</span> <span class="fl">0.5f</span><span class="op">;</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        x0 <span class="op">/=</span> scale_x<span class="op">;</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        y0 <span class="op">/=</span> scale_y<span class="op">;</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>        w <span class="op">/=</span> scale_x<span class="op">;</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>        h <span class="op">/=</span> scale_y<span class="op">;</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the confidence score that an object is present</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> box_objectness <span class="op">=</span> model_output<span class="op">[</span>start_idx <span class="op">+</span> <span class="dv">4</span><span class="op">];</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize object struct with bounding box information</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>        Object obj <span class="op">=</span> <span class="kw">new</span> <span class="fu">Object</span><span class="op">(</span>x0<span class="op">,</span> y0<span class="op">,</span> w<span class="op">,</span> h<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Find the object class with the highest confidence score</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> class_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> class_idx <span class="op">&lt;</span> num_classes<span class="op">;</span> class_idx<span class="op">++)</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Get the confidence score for the current object class</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> box_cls_score <span class="op">=</span> model_output<span class="op">[</span>start_idx <span class="op">+</span> <span class="dv">5</span> <span class="op">+</span> class_idx<span class="op">];</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Calculate the final confidence score for the object proposal</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> box_prob <span class="op">=</span> box_objectness <span class="op">*</span> box_cls_score<span class="op">;</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check for the highest confidence score</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(</span>box_prob <span class="op">&gt;</span> obj<span class="op">.</span><span class="fu">prob</span><span class="op">)</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>                obj<span class="op">.</span><span class="fu">label</span> <span class="op">=</span> class_idx<span class="op">;</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>                obj<span class="op">.</span><span class="fu">prob</span> <span class="op">=</span> box_prob<span class="op">;</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Only add object proposals with high enough confidence scores</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>obj<span class="op">.</span><span class="fu">prob</span> <span class="op">&gt;</span> minConfidence<span class="op">)</span> proposals<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Sort the proposals based on the confidence score in descending order</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>    proposals <span class="op">=</span> proposals<span class="op">.</span><span class="fu">OrderByDescending</span><span class="op">(</span>x <span class="op">=&gt;</span> x<span class="op">.</span><span class="fu">prob</span><span class="op">).</span><span class="fu">ToList</span><span class="op">();</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> proposals<span class="op">;</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define function to calculate the union area of two bounding boxes</strong></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Calculate the union area of two bounding boxes</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"a"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"b"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">CalcUnionArea</span><span class="op">(</span>Object a<span class="op">,</span> Object b<span class="op">)</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> x <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Min</span><span class="op">(</span>a<span class="op">.</span><span class="fu">x0</span><span class="op">,</span> b<span class="op">.</span><span class="fu">x0</span><span class="op">);</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> y <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Min</span><span class="op">(</span>a<span class="op">.</span><span class="fu">y0</span><span class="op">,</span> b<span class="op">.</span><span class="fu">y0</span><span class="op">);</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> w <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>a<span class="op">.</span><span class="fu">x0</span> <span class="op">+</span> a<span class="op">.</span><span class="fu">width</span><span class="op">,</span> b<span class="op">.</span><span class="fu">x0</span> <span class="op">+</span> b<span class="op">.</span><span class="fu">width</span><span class="op">)</span> <span class="op">-</span> x<span class="op">;</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> h <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>a<span class="op">.</span><span class="fu">y0</span> <span class="op">+</span> a<span class="op">.</span><span class="fu">height</span><span class="op">,</span> b<span class="op">.</span><span class="fu">y0</span> <span class="op">+</span> b<span class="op">.</span><span class="fu">height</span><span class="op">)</span> <span class="op">-</span> y<span class="op">;</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> w <span class="op">*</span> h<span class="op">;</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define function to calculate the intersection area of two bounding boxes</strong></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Calculate the intersection area of two bounding boxes</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"a"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"b"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span> <span class="fu">CalcInterArea</span><span class="op">(</span>Object a<span class="op">,</span> Object b<span class="op">)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> x <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>a<span class="op">.</span><span class="fu">x0</span><span class="op">,</span> b<span class="op">.</span><span class="fu">x0</span><span class="op">);</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> y <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>a<span class="op">.</span><span class="fu">y0</span><span class="op">,</span> b<span class="op">.</span><span class="fu">y0</span><span class="op">);</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> w <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Min</span><span class="op">(</span>a<span class="op">.</span><span class="fu">x0</span> <span class="op">+</span> a<span class="op">.</span><span class="fu">width</span><span class="op">,</span> b<span class="op">.</span><span class="fu">x0</span> <span class="op">+</span> b<span class="op">.</span><span class="fu">width</span><span class="op">)</span> <span class="op">-</span> x<span class="op">;</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> h <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Min</span><span class="op">(</span>a<span class="op">.</span><span class="fu">y0</span> <span class="op">+</span> a<span class="op">.</span><span class="fu">height</span><span class="op">,</span> b<span class="op">.</span><span class="fu">y0</span> <span class="op">+</span> b<span class="op">.</span><span class="fu">height</span><span class="op">)</span> <span class="op">-</span> y<span class="op">;</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> w <span class="op">*</span> h<span class="op">;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define function to sort bounding box proposals using Non-Maximum Suppression</strong></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Sort bounding box proposals using Non-Maximum Suppression</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"proposals"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"nms_thresh"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;returns&gt;&lt;/returns&gt;</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>List<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> <span class="fu">NMSSortedBoxes</span><span class="op">(</span>List<span class="op">&lt;</span>Object<span class="op">&gt;</span> proposals<span class="op">,</span> <span class="dt">float</span> nms_thresh <span class="op">=</span> <span class="fl">0.45f</span><span class="op">)</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    List<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> proposal_indices <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;();</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> proposals<span class="op">.</span><span class="fu">Count</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> a <span class="op">=</span> proposals<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> keep <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if the current object proposal overlaps any selected objects too much</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">foreach</span> <span class="op">(</span><span class="dt">int</span> j <span class="kw">in</span> proposal_indices<span class="op">)</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> b <span class="op">=</span> proposals<span class="op">[</span>j<span class="op">];</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Calculate the area where the two object bounding boxes overlap</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> inter_area <span class="op">=</span> <span class="fu">CalcInterArea</span><span class="op">(</span>a<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Calculate the union area of both bounding boxes</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">var</span> union_area <span class="op">=</span> <span class="fu">CalcUnionArea</span><span class="op">(</span>a<span class="op">,</span> b<span class="op">);</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Ignore object proposals that overlap selected objects too much</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">(</span>inter_area <span class="op">/</span> union_area <span class="op">&gt;</span> nms_thresh<span class="op">)</span> keep <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Keep object proposals that do not overlap selected objects too much</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>keep<span class="op">)</span> proposal_indices<span class="op">.</span><span class="fu">Add</span><span class="op">(</span>i<span class="op">);</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> proposal_indices<span class="op">;</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-update-method" class="level3">
<h3 class="anchored" data-anchor-id="define-update-method">Define Update method</h3>
<p>Most of the Update method is identical to the one from the <code>ImageClassifier</code> script, besides the post-processing steps. Although, there is an odd quirk with part of the YOLOX model in TensorFlow.js.</p>
<p>The YOLOX model requires input dimensions that are multiples of 32. However, if we perform inference with such an input resolution, we get an error like the one below.</p>
<pre class="text"><code>Uncaught (in promise) Error: Error in concat4D: Shape of tensors[1] (1,3,111,112) does not match the shape of the rest (1,3,112,112) along the non-concatenated axis 1.</code></pre>
<p>I don’t know why this occurs in TensorFlow.js, but we can resolve it by adding 1 to each input dimension. So instead of an input resolution of <code>224x224</code>, we have <code>225x225</code>.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Update is called once per frame</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">Update</span><span class="op">()</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    useWebcam <span class="op">=</span> webcamDevices<span class="op">.</span><span class="fu">Length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> useWebcam <span class="op">:</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>useWebcam<span class="op">)</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize webcam if it is not already playing</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(!</span>webcamTexture <span class="op">||</span> <span class="op">!</span>webcamTexture<span class="op">.</span><span class="fu">isPlaying</span><span class="op">)</span> <span class="fu">InitializeWebcam</span><span class="op">(</span>currentWebcam<span class="op">);</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Skip the rest of the method if the webcam is not initialized</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>webcamTexture<span class="op">.</span><span class="fu">width</span> <span class="op">&lt;=</span> <span class="dv">16</span><span class="op">)</span> <span class="kw">return</span><span class="op">;</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Make sure screen dimensions match webcam resolution when using webcam</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>screenDims<span class="op">.</span><span class="fu">x</span> <span class="op">!=</span> webcamTexture<span class="op">.</span><span class="fu">width</span><span class="op">)</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Resize and position the screen object using the source image dimensions</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">InitializeScreen</span><span class="op">();</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Resize and position the main camera using the source image dimensions</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">InitializeCamera</span><span class="op">(</span>screenDims<span class="op">);</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span>webcamTexture <span class="op">&amp;&amp;</span> webcamTexture<span class="op">.</span><span class="fu">isPlaying</span><span class="op">)</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Stop the current webcam</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>        webcamTexture<span class="op">.</span><span class="fu">Stop</span><span class="op">();</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resize and position the screen object using the source image dimensions</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">InitializeScreen</span><span class="op">();</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resize and position the main camera using the source image dimensions</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">InitializeCamera</span><span class="op">(</span>screenDims<span class="op">);</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Scale the source image resolution</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    Vector2Int sourceDims <span class="op">=</span> <span class="fu">CalculateInputDims</span><span class="op">(</span>screenDims<span class="op">,</span> targetDim<span class="op">);</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    Vector2Int inputDims <span class="op">=</span> sourceDims<span class="op">;</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>    inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">%</span> <span class="dv">32</span><span class="op">)</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>    inputDims<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span>inputDims<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> inputDims<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">%</span> <span class="dv">32</span><span class="op">)</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    scale_x <span class="op">=</span> inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">/</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>sourceDims<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    scale_y <span class="op">=</span> inputDims<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">/</span> <span class="op">(</span><span class="dt">float</span><span class="op">)</span>sourceDims<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize the input texture with the calculated input dimensions</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>    inputTextureGPU <span class="op">=</span> RenderTexture<span class="op">.</span><span class="fu">GetTemporary</span><span class="op">(</span>inputDims<span class="op">.</span><span class="fu">x</span><span class="op">,</span> inputDims<span class="op">.</span><span class="fu">y</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> RenderTextureFormat<span class="op">.</span><span class="fu">ARGB32</span><span class="op">);</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(!</span>inputTextureCPU <span class="op">||</span> inputTextureCPU<span class="op">.</span><span class="fu">width</span> <span class="op">!=</span> inputTextureGPU<span class="op">.</span><span class="fu">width</span><span class="op">)</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>        inputTextureCPU <span class="op">=</span> <span class="kw">new</span> <span class="fu">Texture2D</span><span class="op">(</span>inputDims<span class="op">.</span><span class="fu">x</span><span class="op">,</span> inputDims<span class="op">.</span><span class="fu">y</span><span class="op">,</span> TextureFormat<span class="op">.</span><span class="fu">RGB24</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>        grid_strides <span class="op">=</span> <span class="kw">new</span> List<span class="op">&lt;</span>GridAndStride<span class="op">&gt;();</span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>        grid_strides <span class="op">=</span> <span class="fu">GenerateGridStrides</span><span class="op">(</span>inputDims<span class="op">[</span><span class="dv">1</span><span class="op">],</span> inputDims<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> output_size <span class="op">=</span> grid_strides<span class="op">.</span><span class="fu">Count</span> <span class="op">*</span> <span class="op">(</span>colors<span class="op">.</span><span class="fu">Length</span> <span class="op">+</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>        output_array <span class="op">=</span> <span class="kw">new</span> <span class="dt">float</span><span class="op">[</span>output_size<span class="op">];</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>        WebGLPlugin<span class="op">.</span><span class="fu">UpdateOutputArray</span><span class="op">(</span>output_array<span class="op">,</span> output_size<span class="op">);</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Updating output array to {output_size}"</span><span class="op">);</span></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>        Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Input Dims: {inputTextureCPU.width}x{inputTextureCPU.height}"</span><span class="op">);</span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>printDebugMessages<span class="op">)</span> Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Input Dims: {inputTextureGPU.width}x{inputTextureGPU.height}"</span><span class="op">);</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy the source texture into model input texture</span></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>    Graphics<span class="op">.</span><span class="fu">Blit</span><span class="op">((</span>useWebcam <span class="op">?</span> webcamTexture <span class="op">:</span> imageTexture<span class="op">),</span> inputTextureGPU<span class="op">);</span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Download pixel data from GPU to CPU</span></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>    RenderTexture<span class="op">.</span><span class="fu">active</span> <span class="op">=</span> inputTextureGPU<span class="op">;</span></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>    inputTextureCPU<span class="op">.</span><span class="fu">ReadPixels</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Rect</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> inputTextureGPU<span class="op">.</span><span class="fu">width</span><span class="op">,</span> inputTextureGPU<span class="op">.</span><span class="fu">height</span><span class="op">),</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>    inputTextureCPU<span class="op">.</span><span class="fu">Apply</span><span class="op">();</span></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the current input dimensions</span></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> width <span class="op">=</span> inputTextureCPU<span class="op">.</span><span class="fu">width</span><span class="op">;</span></span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> height <span class="op">=</span> inputTextureCPU<span class="op">.</span><span class="fu">height</span><span class="op">;</span></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> size <span class="op">=</span> width <span class="op">*</span> height <span class="op">*</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pass the input data to the plugin to perform inference</span></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>    modelInitialized <span class="op">=</span> WebGLPlugin<span class="op">.</span><span class="fu">PerformInference</span><span class="op">(</span>inputTextureCPU<span class="op">.</span><span class="fu">GetRawTextureData</span><span class="op">(),</span> size<span class="op">,</span> width<span class="op">,</span> height<span class="op">);</span></span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Release the input texture</span></span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>    RenderTexture<span class="op">.</span><span class="fu">ReleaseTemporary</span><span class="op">(</span>inputTextureGPU<span class="op">);</span></span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>modelInitialized <span class="op">==</span> <span class="kw">false</span><span class="op">)</span> <span class="kw">return</span><span class="op">;</span></span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>    List<span class="op">&lt;</span>Object<span class="op">&gt;</span> proposals <span class="op">=</span> <span class="fu">GenerateYOLOXProposals</span><span class="op">(</span>output_array<span class="op">,</span> colors<span class="op">.</span><span class="fu">Length</span> <span class="op">+</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>    List<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> proposal_indices <span class="op">=</span> <span class="fu">NMSSortedBoxes</span><span class="op">(</span>proposals<span class="op">);</span></span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>    numObjects <span class="op">=</span> proposal_indices<span class="op">.</span><span class="fu">Count</span><span class="op">;</span></span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>    objectInfoArray <span class="op">=</span> <span class="kw">new</span> Object<span class="op">[</span>numObjects<span class="op">];</span></span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> objectInfoArray<span class="op">.</span><span class="fu">Length</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>        objectInfoArray<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> proposals<span class="op">[</span>proposal_indices<span class="op">[</span>i<span class="op">]];</span></span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ScaleBoundingBoxes</span><span class="op">();</span></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="define-gui-methods" class="level3">
<h3 class="anchored" data-anchor-id="define-gui-methods">Define GUI Methods</h3>
<p><strong>Define method to update webcam usage from GUI (unchanged)</strong></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// This method is called when the value for the webcam toggle changes</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"useWebcam"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">UpdateWebcamToggle</span><span class="op">(</span><span class="dt">bool</span> useWebcam<span class="op">)</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">useWebcam</span> <span class="op">=</span> useWebcam<span class="op">;</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to update webcam device from GUI (unchanged)</strong></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// The method is called when the selected value for the webcam dropdown changes</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">UpdateWebcamDevice</span><span class="op">()</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    currentWebcam <span class="op">=</span> webcamDevices<span class="op">[</span>webcamDropdown<span class="op">.</span><span class="fu">value</span><span class="op">].</span><span class="fu">name</span><span class="op">;</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Selected Webcam: {currentWebcam}"</span><span class="op">);</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize webcam if it is not already playing</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>useWebcam<span class="op">)</span> <span class="fu">InitializeWebcam</span><span class="op">(</span>currentWebcam<span class="op">);</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize and position the screen object using the source image dimensions</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeScreen</span><span class="op">();</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Resize and position the main camera using the source image dimensions</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">InitializeCamera</span><span class="op">(</span>screenDims<span class="op">);</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to update the TensorFlow.js backend (unchanged)</strong></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Update the TensorFlow.js compute backend</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">UpdateTFJSBackend</span><span class="op">()</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    WebGLPlugin<span class="op">.</span><span class="fu">SetTFJSBackend</span><span class="op">(</span>tfjsBackends<span class="op">[</span>backendDropdown<span class="op">.</span><span class="fu">value</span><span class="op">]);</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define method to update the confidence threshold (unchanged)</strong></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;summary&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// Update the minimum confidence score for keeping predictions</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span><span class="kw">&lt;param</span><span class="ot"> name=</span><span class="dt">"slider"</span><span class="kw">&gt;&lt;/param&gt;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">UpdateConfidenceThreshold</span><span class="op">(</span>Slider slider<span class="op">)</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    minConfidence <span class="op">=</span> slider<span class="op">.</span><span class="fu">value</span><span class="op">;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Define OnGUI method</strong></p>
<p>We’ll display the predicted bounding boxes and current frame rate in the <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.OnGUI.html">OnGUI</a> method. We’ll show a different message while the model is still loading.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">// OnGUI is called for rendering and handling GUI events.</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnGUI</span><span class="op">()</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize a rectangle for label text</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    Rect labelRect <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rect</span><span class="op">();</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize a rectangle for bounding boxes</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    Rect boxRect <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rect</span><span class="op">();</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    GUIStyle labelStyle <span class="op">=</span> <span class="kw">new</span> GUIStyle</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        fontSize <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>Screen<span class="op">.</span><span class="fu">width</span> <span class="op">*</span> <span class="fl">11e-3</span><span class="op">)</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    labelStyle<span class="op">.</span><span class="fu">alignment</span> <span class="op">=</span> TextAnchor<span class="op">.</span><span class="fu">MiddleLeft</span><span class="op">;</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> <span class="op">(</span>Object objectInfo <span class="kw">in</span> objectInfoArray<span class="op">)</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(!</span>displayBoundingBoxes<span class="op">)</span> <span class="kw">break</span><span class="op">;</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Skip object if label index is out of bounds</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> <span class="op">(</span>objectInfo<span class="op">.</span><span class="fu">label</span> <span class="op">&gt;</span> colors<span class="op">.</span><span class="fu">Length</span> <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="kw">continue</span><span class="op">;</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get color for current class index</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>        Color color <span class="op">=</span> colors<span class="op">[</span>objectInfo<span class="op">.</span><span class="fu">label</span><span class="op">];</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get label for current class index</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> name <span class="op">=</span> colormapList<span class="op">.</span><span class="fu">items</span><span class="op">[</span>objectInfo<span class="op">.</span><span class="fu">label</span><span class="op">].</span><span class="fu">label</span><span class="op">;</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set bounding box coordinates</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>        boxRect<span class="op">.</span><span class="fu">x</span> <span class="op">=</span> objectInfo<span class="op">.</span><span class="fu">x0</span><span class="op">;</span></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>        boxRect<span class="op">.</span><span class="fu">y</span> <span class="op">=</span> Screen<span class="op">.</span><span class="fu">height</span> <span class="op">-</span> objectInfo<span class="op">.</span><span class="fu">y0</span><span class="op">;</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set bounding box dimensions</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>        boxRect<span class="op">.</span><span class="fu">width</span> <span class="op">=</span> objectInfo<span class="op">.</span><span class="fu">width</span><span class="op">;</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>        boxRect<span class="op">.</span><span class="fu">height</span> <span class="op">=</span> objectInfo<span class="op">.</span><span class="fu">height</span><span class="op">;</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Scale bounding box line width based on display resolution</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> lineWidth <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>Screen<span class="op">.</span><span class="fu">width</span> <span class="op">*</span> <span class="fl">1.75e-3</span><span class="op">);</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Render bounding box</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>        GUI<span class="op">.</span><span class="fu">DrawTexture</span><span class="op">(</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>            position<span class="op">:</span> boxRect<span class="op">,</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>            image<span class="op">:</span> Texture2D<span class="op">.</span><span class="fu">whiteTexture</span><span class="op">,</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>            scaleMode<span class="op">:</span> ScaleMode<span class="op">.</span><span class="fu">StretchToFill</span><span class="op">,</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>            alphaBlend<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>            imageAspect<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>            color<span class="op">:</span> color<span class="op">,</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>            borderWidth<span class="op">:</span> lineWidth<span class="op">,</span></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>            borderRadius<span class="op">:</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Include class label and confidence score in label text</span></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a>        <span class="dt">string</span> labelText <span class="op">=</span> $<span class="st">" {name}: {(objectInfo.prob * 100).ToString("</span><span class="fl">0.</span>##<span class="st">")}%"</span><span class="op">;</span></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize label GUI content</span></span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a>        GUIContent labelContent <span class="op">=</span> <span class="kw">new</span> <span class="fu">GUIContent</span><span class="op">(</span>labelText<span class="op">);</span></span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate the text size.</span></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a>        Vector2 textSize <span class="op">=</span> labelStyle<span class="op">.</span><span class="fu">CalcSize</span><span class="op">(</span>labelContent<span class="op">);</span></span>
<span id="cb48-55"><a href="#cb48-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-56"><a href="#cb48-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set label text coordinates</span></span>
<span id="cb48-57"><a href="#cb48-57" aria-hidden="true" tabindex="-1"></a>        labelRect<span class="op">.</span><span class="fu">x</span> <span class="op">=</span> objectInfo<span class="op">.</span><span class="fu">x0</span><span class="op">;</span></span>
<span id="cb48-58"><a href="#cb48-58" aria-hidden="true" tabindex="-1"></a>        labelRect<span class="op">.</span><span class="fu">y</span> <span class="op">=</span> Screen<span class="op">.</span><span class="fu">height</span> <span class="op">-</span> objectInfo<span class="op">.</span><span class="fu">y0</span> <span class="op">-</span> textSize<span class="op">.</span><span class="fu">y</span> <span class="op">+</span> lineWidth<span class="op">;</span></span>
<span id="cb48-59"><a href="#cb48-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-60"><a href="#cb48-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set label text dimensions</span></span>
<span id="cb48-61"><a href="#cb48-61" aria-hidden="true" tabindex="-1"></a>        labelRect<span class="op">.</span><span class="fu">width</span> <span class="op">=</span> Mathf<span class="op">.</span><span class="fu">Max</span><span class="op">(</span>textSize<span class="op">.</span><span class="fu">x</span><span class="op">,</span> objectInfo<span class="op">.</span><span class="fu">width</span><span class="op">);</span></span>
<span id="cb48-62"><a href="#cb48-62" aria-hidden="true" tabindex="-1"></a>        labelRect<span class="op">.</span><span class="fu">height</span> <span class="op">=</span> textSize<span class="op">.</span><span class="fu">y</span><span class="op">;</span></span>
<span id="cb48-63"><a href="#cb48-63" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set label text and backgound color</span></span>
<span id="cb48-64"><a href="#cb48-64" aria-hidden="true" tabindex="-1"></a>        labelStyle<span class="op">.</span><span class="fu">normal</span><span class="op">.</span><span class="fu">textColor</span> <span class="op">=</span> color<span class="op">.</span><span class="fu">grayscale</span> <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="op">?</span> Color<span class="op">.</span><span class="fu">black</span> <span class="op">:</span> Color<span class="op">.</span><span class="fu">white</span><span class="op">;</span></span>
<span id="cb48-65"><a href="#cb48-65" aria-hidden="true" tabindex="-1"></a>        labelStyle<span class="op">.</span><span class="fu">normal</span><span class="op">.</span><span class="fu">background</span> <span class="op">=</span> colorTextures<span class="op">[</span>objectInfo<span class="op">.</span><span class="fu">label</span><span class="op">];</span></span>
<span id="cb48-66"><a href="#cb48-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Render label</span></span>
<span id="cb48-67"><a href="#cb48-67" aria-hidden="true" tabindex="-1"></a>        GUI<span class="op">.</span><span class="fu">Label</span><span class="op">(</span>labelRect<span class="op">,</span> labelContent<span class="op">,</span> labelStyle<span class="op">);</span></span>
<span id="cb48-68"><a href="#cb48-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-69"><a href="#cb48-69" aria-hidden="true" tabindex="-1"></a>        Rect objectDot <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rect</span><span class="op">();</span></span>
<span id="cb48-70"><a href="#cb48-70" aria-hidden="true" tabindex="-1"></a>        objectDot<span class="op">.</span><span class="fu">height</span> <span class="op">=</span> lineWidth <span class="op">*</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb48-71"><a href="#cb48-71" aria-hidden="true" tabindex="-1"></a>        objectDot<span class="op">.</span><span class="fu">width</span> <span class="op">=</span> lineWidth <span class="op">*</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb48-72"><a href="#cb48-72" aria-hidden="true" tabindex="-1"></a>        <span class="dt">float</span> radius <span class="op">=</span> objectDot<span class="op">.</span><span class="fu">width</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb48-73"><a href="#cb48-73" aria-hidden="true" tabindex="-1"></a>        objectDot<span class="op">.</span><span class="fu">x</span> <span class="op">=</span> <span class="op">(</span>boxRect<span class="op">.</span><span class="fu">x</span> <span class="op">+</span> boxRect<span class="op">.</span><span class="fu">width</span> <span class="op">/</span> <span class="dv">2</span><span class="op">)</span> <span class="op">-</span> radius<span class="op">;</span></span>
<span id="cb48-74"><a href="#cb48-74" aria-hidden="true" tabindex="-1"></a>        objectDot<span class="op">.</span><span class="fu">y</span> <span class="op">=</span> <span class="op">(</span>boxRect<span class="op">.</span><span class="fu">y</span> <span class="op">+</span> boxRect<span class="op">.</span><span class="fu">height</span> <span class="op">/</span> <span class="dv">2</span><span class="op">)</span> <span class="op">-</span> radius<span class="op">;</span></span>
<span id="cb48-75"><a href="#cb48-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-76"><a href="#cb48-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-77"><a href="#cb48-77" aria-hidden="true" tabindex="-1"></a>        GUI<span class="op">.</span><span class="fu">DrawTexture</span><span class="op">(</span></span>
<span id="cb48-78"><a href="#cb48-78" aria-hidden="true" tabindex="-1"></a>            position<span class="op">:</span> objectDot<span class="op">,</span></span>
<span id="cb48-79"><a href="#cb48-79" aria-hidden="true" tabindex="-1"></a>            image<span class="op">:</span> Texture2D<span class="op">.</span><span class="fu">whiteTexture</span><span class="op">,</span></span>
<span id="cb48-80"><a href="#cb48-80" aria-hidden="true" tabindex="-1"></a>            scaleMode<span class="op">:</span> ScaleMode<span class="op">.</span><span class="fu">StretchToFill</span><span class="op">,</span></span>
<span id="cb48-81"><a href="#cb48-81" aria-hidden="true" tabindex="-1"></a>            alphaBlend<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb48-82"><a href="#cb48-82" aria-hidden="true" tabindex="-1"></a>            imageAspect<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb48-83"><a href="#cb48-83" aria-hidden="true" tabindex="-1"></a>            color<span class="op">:</span> color<span class="op">,</span></span>
<span id="cb48-84"><a href="#cb48-84" aria-hidden="true" tabindex="-1"></a>            borderWidth<span class="op">:</span> radius<span class="op">,</span></span>
<span id="cb48-85"><a href="#cb48-85" aria-hidden="true" tabindex="-1"></a>            borderRadius<span class="op">:</span> radius<span class="op">);</span></span>
<span id="cb48-86"><a href="#cb48-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-87"><a href="#cb48-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb48-88"><a href="#cb48-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-89"><a href="#cb48-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define styling information for GUI elements</span></span>
<span id="cb48-90"><a href="#cb48-90" aria-hidden="true" tabindex="-1"></a>    GUIStyle style <span class="op">=</span> <span class="kw">new</span> GUIStyle</span>
<span id="cb48-91"><a href="#cb48-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb48-92"><a href="#cb48-92" aria-hidden="true" tabindex="-1"></a>        fontSize <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span>Screen<span class="op">.</span><span class="fu">width</span> <span class="op">*</span> <span class="op">(</span><span class="dv">1</span>f <span class="op">/</span> <span class="op">(</span><span class="dv">100</span>f <span class="op">-</span> fontScale<span class="op">)))</span></span>
<span id="cb48-93"><a href="#cb48-93" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb48-94"><a href="#cb48-94" aria-hidden="true" tabindex="-1"></a>    style<span class="op">.</span><span class="fu">normal</span><span class="op">.</span><span class="fu">textColor</span> <span class="op">=</span> textColor<span class="op">;</span></span>
<span id="cb48-95"><a href="#cb48-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-96"><a href="#cb48-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Define screen spaces for GUI elements</span></span>
<span id="cb48-97"><a href="#cb48-97" aria-hidden="true" tabindex="-1"></a>    Rect slot1 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rect</span><span class="op">(</span><span class="dv">10</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">500</span><span class="op">);</span></span>
<span id="cb48-98"><a href="#cb48-98" aria-hidden="true" tabindex="-1"></a>    Rect slot2 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rect</span><span class="op">(</span><span class="dv">10</span><span class="op">,</span> style<span class="op">.</span><span class="fu">fontSize</span> <span class="op">*</span> <span class="fl">1.5f</span><span class="op">,</span> <span class="dv">500</span><span class="op">,</span> <span class="dv">500</span><span class="op">);</span></span>
<span id="cb48-99"><a href="#cb48-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-100"><a href="#cb48-100" aria-hidden="true" tabindex="-1"></a>    <span class="dt">string</span> content <span class="op">=</span> $<span class="st">"Objects Detected: {numObjects}"</span><span class="op">;</span></span>
<span id="cb48-101"><a href="#cb48-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>displayProposalCount<span class="op">)</span> GUI<span class="op">.</span><span class="fu">Label</span><span class="op">(</span>slot1<span class="op">,</span> <span class="kw">new</span> <span class="fu">GUIContent</span><span class="op">(</span>modelInitialized <span class="op">?</span> content <span class="op">:</span> <span class="st">"Loading Model..."</span><span class="op">),</span> style<span class="op">);</span></span>
<span id="cb48-102"><a href="#cb48-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-103"><a href="#cb48-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update framerate value</span></span>
<span id="cb48-104"><a href="#cb48-104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>Time<span class="op">.</span><span class="fu">unscaledTime</span> <span class="op">&gt;</span> fpsTimer<span class="op">)</span></span>
<span id="cb48-105"><a href="#cb48-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb48-106"><a href="#cb48-106" aria-hidden="true" tabindex="-1"></a>        fps <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span><span class="dv">1</span>f <span class="op">/</span> Time<span class="op">.</span><span class="fu">unscaledDeltaTime</span><span class="op">);</span></span>
<span id="cb48-107"><a href="#cb48-107" aria-hidden="true" tabindex="-1"></a>        fpsTimer <span class="op">=</span> Time<span class="op">.</span><span class="fu">unscaledTime</span> <span class="op">+</span> fpsRefreshRate<span class="op">;</span></span>
<span id="cb48-108"><a href="#cb48-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb48-109"><a href="#cb48-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-110"><a href="#cb48-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Adjust screen position when not showing predicted class</span></span>
<span id="cb48-111"><a href="#cb48-111" aria-hidden="true" tabindex="-1"></a>    Rect fpsRect <span class="op">=</span> displayProposalCount <span class="op">?</span> slot2 <span class="op">:</span> slot1<span class="op">;</span></span>
<span id="cb48-112"><a href="#cb48-112" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>displayFPS<span class="op">)</span> GUI<span class="op">.</span><span class="fu">Label</span><span class="op">(</span>fpsRect<span class="op">,</span> <span class="kw">new</span> <span class="fu">GUIContent</span><span class="op">(</span>$<span class="st">"FPS: {fps}"</span><span class="op">),</span> style<span class="op">);</span></span>
<span id="cb48-113"><a href="#cb48-113" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That’s it for the code updates.</p>
</section>
</section>
<section id="update-unity-scene" class="level2">
<h2 class="anchored" data-anchor-id="update-unity-scene">Update Unity Scene</h2>
<p>All that’s left is to swap out the <code>ImageClassifier</code> script in the Unity scene.</p>
<p><strong>Update Inference Manager object</strong></p>
<p>With the <code>InferenceManager</code> object selected, drag the <code>ObjectDetector</code> script into the Inspector tab.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-attach-object-detector-script.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Remove the empty script component left over from the <code>ImageClassifier</code> script.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-remove-empty-script-component.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Now we can assign the Screen object and colormap file in the Inspector tab by dragging them into their respective fields.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-assign-object-detector-script-assets.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Configure Webcam Toggle On Value Changed function</strong></p>
<p>Next, we need to pair the <code>WebcamToggle</code> with the <code>UpdateWebcamToggle</code> function in the <code>ObjectDetector</code> script. Expand the Canvas object and select the <code>WebcamToggle</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-select-webcamtoggle.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Click and drag the <code>InferenceManager</code> into the <code>On Value Changed</code> field.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-webcamtoggle-update-inference-manager.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Open the dropdown menu and select <code>ObjectDetector → UpdateWebcamToggle</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-webcamtoggle-update-inference-manager-function.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Configure Webcam Dropdown On Value Changed function</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-webcamdropdown-update-inference-manager-function.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Configure <code>TFJSModelDropdown</code> On Value Changed function</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-update-tfjs-model-dropdown-on-value-changed.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Configure <code>TFJSBackendDropdown</code> On Value Changed function</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-update-tfjs-backend-dropdown-on-value-changed.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Configure <code>ConfidenceThresholdSlider</code> On Value Changed Event</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-update-confidence-threshold-slider-on-value-changed.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Assign GUI objects to Inference Manager</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-inference-manager-assign-gui-objects.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="test-in-browser" class="level2">
<h2 class="anchored" data-anchor-id="test-in-browser">Test in Browser</h2>
<p>Now, we can build the project and test it in a web browser. In the Unity project, select <code>File → Build Settings...</code> in the top menu bar to open the Build Settings window.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-open-build-settings.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Select <code>WebGL</code> from the list of platforms and click <code>Switch Platform</code> if it is not already the target platform.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-build-settings-switch-to-webgl.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>We can test the WebGL build locally by clicking <code>Build and Run</code> in the Build Settings window.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-build-settings-build-and-run.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Unity will prompt us to select a folder to store the build files or default to the Build folder from the original tutorial. If it’s the former, create a new folder called <code>Build</code>. Open the folder and click <code>Select Folder</code> to start the build process.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/unity-select-build-folder.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Unity caps the framerate to the default <a href="https://docs.unity3d.com/ScriptReference/Application-targetFrameRate.html">target framerate</a> for the platform. My desktop display maxes out at 60fps.</p>
<p><strong>Test YOLOX Tiny performance</strong></p>
<p>As with the image classifier models in the original tutorial, performance is far lower in WebGL with the YOLOX model than when using native inference options.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/in-browser-test-yolox.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p><strong>Full-screen</strong></p>
<p>Performance seems slightly better when in full-screen mode.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/in-browser-test-yolox-fullscreen.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this follow-up tutorial, we showed you how to use TensorFlow.js for in-browser object detection in Unity. We began by converting our model to TFJS and importing the necessary assets. Next, we updated our JavaScript and jslib plugin files. We then created an object detector script and updated our Unity scene to use it. Finally, we tested everything in the browser to ensure that our project worked as expected. With this tutorial, you should now be able to use TensorFlow.js for in-browser object detection in your Unity projects.</p>


</section>

</main> <!-- /main -->
<!-- Cloudflare Web Analytics --><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;56b8d2f624604c4891327b3c0d9f6703&quot;}"></script><!-- End Cloudflare Web Analytics -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="cj-mills/christianjmills" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Copyright 2024, Christian J. Mills
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>