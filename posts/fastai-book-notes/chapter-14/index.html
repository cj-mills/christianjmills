<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.361">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christian Mills">
<meta name="dcterms.date" content="2022-03-29">
<meta name="description" content="Chapter 14 covers building a ResNet from scratch.">

<title>Christian Mills - Notes on fastai Book Ch. 14</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../images/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Christian Mills - Notes on fastai Book Ch. 14">
<meta property="og:description" content="Chapter 14 covers building a ResNet from scratch.">
<meta property="og:image" content="christianjmills.com/posts/fastai-book-notes/chapter-14/images/logo.png">
<meta property="og:site-name" content="Christian Mills">
<meta name="twitter:title" content="Christian Mills - Notes on fastai Book Ch. 14">
<meta name="twitter:description" content="Chapter 14 covers building a ResNet from scratch.">
<meta name="twitter:image" content="christianjmills.com/posts/fastai-book-notes/chapter-14/images/logo.png">
<meta name="twitter:creator" content="@cdotjdotmills">
<meta name="twitter:site" content="@cdotjdotmills">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Christian Mills</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series/tutorials/index.html" rel="" target="">
 <span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series/notes/index.html" rel="" target="">
 <span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../services.html" rel="" target="">
 <span class="menu-text">Services</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:christian@christianjmills.com" rel="" target=""><i class="bi bi-envelope-fill" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cj-mills" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/cdotjdotmills" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../blog.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#resnets" id="toc-resnets" class="nav-link active" data-scroll-target="#resnets">ResNets</a></li>
  <li><a href="#going-back-to-imagenette" id="toc-going-back-to-imagenette" class="nav-link" data-scroll-target="#going-back-to-imagenette">Going Back to Imagenette</a>
  <ul>
  <li><a href="#average-pooling" id="toc-average-pooling" class="nav-link" data-scroll-target="#average-pooling">Average Pooling</a>
  <ul class="collapse">
  <li><a href="#adaptive-average-pooling" id="toc-adaptive-average-pooling" class="nav-link" data-scroll-target="#adaptive-average-pooling">Adaptive Average Pooling</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#building-a-modern-cnn-resnet" id="toc-building-a-modern-cnn-resnet" class="nav-link" data-scroll-target="#building-a-modern-cnn-resnet">Building a Modern CNN: ResNet</a>
  <ul>
  <li><a href="#skip-connections" id="toc-skip-connections" class="nav-link" data-scroll-target="#skip-connections">Skip Connections</a></li>
  <li><a href="#a-state-of-the-art-resnet" id="toc-a-state-of-the-art-resnet" class="nav-link" data-scroll-target="#a-state-of-the-art-resnet">A State-of-the-Art ResNet</a>
  <ul class="collapse">
  <li><a href="#top-5-accuracy" id="toc-top-5-accuracy" class="nav-link" data-scroll-target="#top-5-accuracy">Top-5 Accuracy</a></li>
  <li><a href="#stem" id="toc-stem" class="nav-link" data-scroll-target="#stem">Stem</a></li>
  </ul></li>
  <li><a href="#bottleneck-layers" id="toc-bottleneck-layers" class="nav-link" data-scroll-target="#bottleneck-layers">Bottleneck Layers</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Notes on fastai Book Ch. 14</h1>
  <div class="quarto-categories">
    <div class="quarto-category">ai</div>
    <div class="quarto-category">fastai</div>
    <div class="quarto-category">notes</div>
    <div class="quarto-category">pytorch</div>
  </div>
  </div>

<div>
  <div class="description">
    Chapter 14 covers building a ResNet from scratch.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christian Mills </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 29, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<ul>
<li><a href="#resnets">ResNets</a></li>
<li><a href="#going-back-to-imagenette">Going Back to Imagenette</a></li>
<li><a href="#building-a-modern-cnn-resnet">Building a Modern CNN: ResNet</a></li>
<li><a href="#references">References</a></li>
</ul>
<hr>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#hide</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install -Uqq fastbook</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastbook</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>fastbook.setup_book()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#hide</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastbook <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_source(obj):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> inspect.getsource(obj).split(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>):</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(line)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="resnets" class="level2">
<h2 class="anchored" data-anchor-id="resnets">ResNets</h2>
<ul>
<li><a href="https://arxiv.org/abs/1512.03385">Deep Residual Learning for Image Recognition</a>
<ul>
<li>introduced the concept of residual (skip) connections</li>
</ul></li>
</ul>
</section>
<section id="going-back-to-imagenette" class="level2">
<h2 class="anchored" data-anchor-id="going-back-to-imagenette">Going Back to Imagenette</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_data(url, presize, resize):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> untar_data(url)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(path)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> DataBlock(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        blocks<span class="op">=</span>(ImageBlock, CategoryBlock), get_items<span class="op">=</span>get_image_files, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        splitter<span class="op">=</span>GrandparentSplitter(valid_name<span class="op">=</span><span class="st">'val'</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        get_y<span class="op">=</span>parent_label, item_tfms<span class="op">=</span>Resize(presize),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        batch_tfms<span class="op">=</span>[<span class="op">*</span>aug_transforms(min_scale<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span>resize),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                    Normalize.from_stats(<span class="op">*</span>imagenet_stats)],</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    ).dataloaders(path, bs<span class="op">=</span><span class="dv">128</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>URLs.IMAGENETTE_160</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>'https://s3.amazonaws.com/fast-ai-imageclas/imagenette2-160.tgz'</code></pre>
<hr>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> get_data(URLs.IMAGENETTE_160, <span class="dv">160</span>, <span class="dv">128</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/output_8_0.png" class="img-fluid figure-img"></p>
</figure>
</div>
<section id="average-pooling" class="level3">
<h3 class="anchored" data-anchor-id="average-pooling">Average Pooling</h3>
<ul>
<li>take the average of activations across a convolutional grid</li>
<li>an alternative to the approach of using stride-2 layers to downscale input dimensions to the a single output vector</li>
<li>used in fully convolutional networks to allow the model to be used on image sizes other than what the model was trained on</li>
</ul>
<p><strong>Note:</strong> A fully convolutional network is a good choice when the objects you want to classify don’t have a single correct orientation or size (e.g.&nbsp;most natural photos) * It would not be a good choice for applications like MNIST where their is a fixed correct orientation for each character</p>
<hr>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Take the mean over the x and y axes</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Will always convert a grid of activations into a single activation per image</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> avg_pool(x): <span class="cf">return</span> x.mean((<span class="dv">2</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> block(ni, nf): <span class="cf">return</span> ConvLayer(ni, nf, stride<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_model():</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nn.Sequential(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">3</span>, <span class="dv">16</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">16</span>, <span class="dv">32</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">32</span>, <span class="dv">64</span>),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">64</span>, <span class="dv">128</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">128</span>, <span class="dv">256</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        nn.AdaptiveAvgPool2d(<span class="dv">1</span>),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        Flatten(),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        nn.Linear(<span class="dv">256</span>, dls.c))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ConvLayer</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>fastai.layers.ConvLayer</code></pre>
<hr>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>print_source(ConvLayer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>class ConvLayer(nn.Sequential):
    "Create a sequence of convolutional (`ni` to `nf`), ReLU (if `use_activ`) and `norm_type` layers."
    @delegates(nn.Conv2d)
    def __init__(self, ni, nf, ks=3, stride=1, padding=None, bias=None, ndim=2, norm_type=NormType.Batch, bn_1st=True,
                 act_cls=defaults.activation, transpose=False, init='auto', xtra=None, bias_std=0.01, **kwargs):
        if padding is None: padding = ((ks-1)//2 if not transpose else 0)
        bn = norm_type in (NormType.Batch, NormType.BatchZero)
        inn = norm_type in (NormType.Instance, NormType.InstanceZero)
        if bias is None: bias = not (bn or inn)
        conv_func = _conv_func(ndim, transpose=transpose)
        conv = conv_func(ni, nf, kernel_size=ks, bias=bias, stride=stride, padding=padding, **kwargs)
        act = None if act_cls is None else act_cls()
        init_linear(conv, act, init=init, bias_std=bias_std)
        if   norm_type==NormType.Weight:   conv = weight_norm(conv)
        elif norm_type==NormType.Spectral: conv = spectral_norm(conv)
        layers = [conv]
        act_bn = []
        if act is not None: act_bn.append(act)
        if bn: act_bn.append(BatchNorm(nf, norm_type=norm_type, ndim=ndim))
        if inn: act_bn.append(InstanceNorm(nf, norm_type=norm_type, ndim=ndim))
        if bn_1st: act_bn.reverse()
        layers += act_bn
        if xtra: layers.append(xtra)
        super().__init__(*layers)</code></pre>
<section id="adaptive-average-pooling" class="level4">
<h4 class="anchored" data-anchor-id="adaptive-average-pooling">Adaptive Average Pooling</h4>
<ul>
<li>averages a grid of activations into whatever sized destination you require</li>
</ul>
<hr>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>nn.AdaptiveAvgPool2d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>torch.nn.modules.pooling.AdaptiveAvgPool2d</code></pre>
<ul>
<li>input: <span class="math inline">\((N, C, H_{in}, W_{in})\)</span> or <span class="math inline">\((C, H_{in}, W_{in})\)</span></li>
<li>output: <span class="math inline">\((N, C, S_{0}, S_{1})\)</span> or <span class="math inline">\((C, S_{0}, S_{1})\)</span>, where <span class="math inline">\(S=output_size\)</span></li>
</ul>
<hr>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>print_source(nn.AdaptiveAvgPool2d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>class AdaptiveAvgPool2d(_AdaptiveAvgPoolNd):
    r"""Applies a 2D adaptive average pooling over an input signal composed of several input planes.

    The output is of size H x W, for any input size.
    The number of output features is equal to the number of input planes.

    Args:
        output_size: the target output size of the image of the form H x W.
                     Can be a tuple (H, W) or a single H for a square image H x H.
                     H and W can be either a ``int``, or ``None`` which means the size will
                     be the same as that of the input.

    Shape:
        - Input: :math:`(N, C, H_{in}, W_{in})` or :math:`(C, H_{in}, W_{in})`.
        - Output: :math:`(N, C, S_{0}, S_{1})` or :math:`(C, S_{0}, S_{1})`, where
          :math:`S=\text{output\_size}`.

    Examples:
        &gt;&gt;&gt; # target output size of 5x7
        &gt;&gt;&gt; m = nn.AdaptiveAvgPool2d((5,7))
        &gt;&gt;&gt; input = torch.randn(1, 64, 8, 9)
        &gt;&gt;&gt; output = m(input)
        &gt;&gt;&gt; # target output size of 7x7 (square)
        &gt;&gt;&gt; m = nn.AdaptiveAvgPool2d(7)
        &gt;&gt;&gt; input = torch.randn(1, 64, 10, 9)
        &gt;&gt;&gt; output = m(input)
        &gt;&gt;&gt; # target output size of 10x7
        &gt;&gt;&gt; m = nn.AdaptiveAvgPool2d((None, 7))
        &gt;&gt;&gt; input = torch.randn(1, 64, 10, 9)
        &gt;&gt;&gt; output = m(input)

    """

    output_size: _size_2_opt_t

    def forward(self, input: Tensor) -&gt; Tensor:
        return F.adaptive_avg_pool2d(input, self.output_size)</code></pre>
<hr>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_learner(m):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Learner(dls, m, loss_func<span class="op">=</span>nn.CrossEntropyLoss(), metrics<span class="op">=</span>accuracy</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                  ).to_fp16()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> get_learner(get_model())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>learn.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>Sequential(
  (0): ConvLayer(
    (0): Conv2d(3, 16, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
    (1): BatchNorm2d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU()
  )
  (1): ConvLayer(
    (0): Conv2d(16, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
    (1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU()
  )
  (2): ConvLayer(
    (0): Conv2d(32, 64, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
    (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU()
  )
  (3): ConvLayer(
    (0): Conv2d(64, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
    (1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU()
  )
  (4): ConvLayer(
    (0): Conv2d(128, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
    (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (2): ReLU()
  )
  (5): AdaptiveAvgPool2d(output_size=1)
  (6): Flatten(full=False)
  (7): Linear(in_features=256, out_features=10, bias=True)
)</code></pre>
<hr>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>SuggestedLRs(valley=0.0008317637839354575)</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/output_21_3.png" class="img-fluid figure-img"></p>
</figure>
</div>
<hr>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">3e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="overflow-x:auto;">

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
1.885349
</td>
<td>
2.287517
</td>
<td>
0.341401
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
1
</td>
<td>
1.525377
</td>
<td>
2.245459
</td>
<td>
0.395159
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
2
</td>
<td>
1.290083
</td>
<td>
1.217583
</td>
<td>
0.609172
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
3
</td>
<td>
1.145256
</td>
<td>
1.164249
</td>
<td>
0.631338
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
4
</td>
<td>
1.045142
</td>
<td>
1.064749
</td>
<td>
0.668025
</td>
<td>
00:03
</td>
</tr>
</tbody>

</table>
</div>
<p><strong>Note:</strong> We won’t necessarily get better results simply by adding more layers.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> get_learner(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    nn.Sequential(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">3</span>, <span class="dv">16</span>),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">16</span>, <span class="dv">32</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">32</span>, <span class="dv">64</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">64</span>, <span class="dv">128</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">128</span>, <span class="dv">256</span>),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">256</span>, <span class="dv">512</span>),</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        block(<span class="dv">512</span>, <span class="dv">1024</span>),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        nn.AdaptiveAvgPool2d(<span class="dv">1</span>),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        Flatten(),</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        nn.Linear(<span class="dv">1024</span>, dls.c)))</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>SuggestedLRs(valley=0.0002754228771664202)</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/output_24_3.png" class="img-fluid figure-img"></p>
</figure>
</div>
<hr>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">10</span>, <span class="fl">0.03</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="overflow-x:auto;">

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
1.826138
</td>
<td>
3.406225
</td>
<td>
0.314395
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
1
</td>
<td>
1.752539
</td>
<td>
3.521486
</td>
<td>
0.296051
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
2
</td>
<td>
1.531295
</td>
<td>
2.125122
</td>
<td>
0.382420
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
3
</td>
<td>
1.322462
</td>
<td>
1.528130
</td>
<td>
0.530955
</td>
<td>
00:04
</td>
</tr>
<tr>
<td>
4
</td>
<td>
1.180348
</td>
<td>
1.409803
</td>
<td>
0.559236
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
5
</td>
<td>
1.112325
</td>
<td>
1.155497
</td>
<td>
0.638217
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
6
</td>
<td>
0.977593
</td>
<td>
0.918580
</td>
<td>
0.706242
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
7
</td>
<td>
0.870830
</td>
<td>
1.019607
</td>
<td>
0.680000
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
8
</td>
<td>
0.780924
</td>
<td>
0.779768
</td>
<td>
0.750573
</td>
<td>
00:03
</td>
</tr>
<tr>
<td>
9
</td>
<td>
0.706074
</td>
<td>
0.767961
</td>
<td>
0.759490
</td>
<td>
00:03
</td>
</tr>
</tbody>

</table>
</div>
<p><strong>Note:</strong> Needed to train for more epochs to achieve the same accuracy.</p>
</section>
</section>
</section>
<section id="building-a-modern-cnn-resnet" class="level2">
<h2 class="anchored" data-anchor-id="building-a-modern-cnn-resnet">Building a Modern CNN: ResNet</h2>
<section id="skip-connections" class="level3">
<h3 class="anchored" data-anchor-id="skip-connections">Skip Connections</h3>
<ul>
<li><p>skip connections make the network easier to train with SGD</p>
<ul>
<li><code>x + conv2(conv1(x))</code></li>
</ul></li>
<li><p>Identity Mapping: returning the input without changing it at all</p></li>
<li><p>residual: prediction minus target</p></li>
<li><p>The authors of the <a href="https://arxiv.org/abs/1512.03385">ResNet paper</a> noticed that a network with more layers performed worse than a network with fewer layers, all other factors being equal</p>
<ul>
<li>this was true on both the training and validation sets</li>
</ul></li>
<li><p>Key Insight:</p>
<ul>
<li>start with a model with fewer layers that is trained well, and add more layers to it that do nothing at all the result should be a larger network that does exactly the same thing as the smaller network, proving there are always deep networks that should be at least as good as a more shallow network</li>
<li>however, SGD was not finding these</li>
</ul></li>
<li><p>Using skip connections also helps smooth the loss function, which makes training easier</p></li>
</ul>
<p><strong>Note:</strong> Use zero for the initial value of gamma in batch normalization * allows training at higher learning rates * recall: <span class="math inline">\(y*gamma + beta\)</span></p>
<hr>
<div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResBlock(Module):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ni, nf):</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.convs <span class="op">=</span> nn.Sequential(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>            ConvLayer(ni,nf),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>            ConvLayer(nf,nf, norm_type<span class="op">=</span>NormType.BatchZero))</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x): <span class="cf">return</span> x <span class="op">+</span> <span class="va">self</span>.convs(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Note:</strong> The above implementation requires the stride to be 1 and <code>ni==nf</code> in order for <code>x + self.convs(x)</code> to work. * Need to change the shape of <code>x</code> to match the result of <code>self.convs(x)</code> * Can use an average pooling layer with a stride of 2 to change the shape * Can use a 1x1 convolution to change the number of channels</p>
<hr>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _conv_block(ni,nf,stride):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nn.Sequential(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>        ConvLayer(ni, nf, stride<span class="op">=</span>stride),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        ConvLayer(nf, nf, act_cls<span class="op">=</span><span class="va">None</span>, norm_type<span class="op">=</span>NormType.BatchZero))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResBlock(Module):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ni, nf, stride<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.convs <span class="op">=</span> _conv_block(ni,nf,stride)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.idconv <span class="op">=</span> noop <span class="cf">if</span> ni<span class="op">==</span>nf <span class="cf">else</span> ConvLayer(ni, nf, <span class="dv">1</span>, act_cls<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pool <span class="op">=</span> noop <span class="cf">if</span> stride<span class="op">==</span><span class="dv">1</span> <span class="cf">else</span> nn.AvgPool2d(<span class="dv">2</span>, ceil_mode<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> F.relu(<span class="va">self</span>.convs(x) <span class="op">+</span> <span class="va">self</span>.idconv(<span class="va">self</span>.pool(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>noop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>&lt;function fastai.imports.noop(x=None, *args, **kwargs)&gt;</code></pre>
<hr>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>print_source(noop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>def noop (x=None, *args, **kwargs):
    "Do nothing"
    return x</code></pre>
<hr>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> block(ni,nf): <span class="cf">return</span> ResBlock(ni, nf, stride<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> get_learner(get_model())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>learn.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>Sequential(
  (0): ResBlock(
    (convs): Sequential(
      (0): ConvLayer(
        (0): Conv2d(3, 16, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
      (1): ConvLayer(
        (0): Conv2d(16, 16, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
        (1): BatchNorm2d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (idconv): ConvLayer(
      (0): Conv2d(3, 16, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (1): BatchNorm2d(16, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
    (pool): AvgPool2d(kernel_size=2, stride=2, padding=0)
  )
  (1): ResBlock(
    (convs): Sequential(
      (0): ConvLayer(
        (0): Conv2d(16, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
      (1): ConvLayer(
        (0): Conv2d(32, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
        (1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (idconv): ConvLayer(
      (0): Conv2d(16, 32, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
    (pool): AvgPool2d(kernel_size=2, stride=2, padding=0)
  )
  (2): ResBlock(
    (convs): Sequential(
      (0): ConvLayer(
        (0): Conv2d(32, 64, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
      (1): ConvLayer(
        (0): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
        (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (idconv): ConvLayer(
      (0): Conv2d(32, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
    (pool): AvgPool2d(kernel_size=2, stride=2, padding=0)
  )
  (3): ResBlock(
    (convs): Sequential(
      (0): ConvLayer(
        (0): Conv2d(64, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
      (1): ConvLayer(
        (0): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
        (1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (idconv): ConvLayer(
      (0): Conv2d(64, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
    (pool): AvgPool2d(kernel_size=2, stride=2, padding=0)
  )
  (4): ResBlock(
    (convs): Sequential(
      (0): ConvLayer(
        (0): Conv2d(128, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
        (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
        (2): ReLU()
      )
      (1): ConvLayer(
        (0): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
        (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (idconv): ConvLayer(
      (0): Conv2d(128, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
    (pool): AvgPool2d(kernel_size=2, stride=2, padding=0)
  )
  (5): AdaptiveAvgPool2d(output_size=1)
  (6): Flatten(full=False)
  (7): Linear(in_features=256, out_features=10, bias=True)
)</code></pre>
<hr>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">3e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="overflow-x:auto;">

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
1.975520
</td>
<td>
1.854834
</td>
<td>
0.346242
</td>
<td>
00:04
</td>
</tr>
<tr>
<td>
1
</td>
<td>
1.658158
</td>
<td>
1.478215
</td>
<td>
0.517197
</td>
<td>
00:04
</td>
</tr>
<tr>
<td>
2
</td>
<td>
1.377669
</td>
<td>
1.307936
</td>
<td>
0.585478
</td>
<td>
00:04
</td>
</tr>
<tr>
<td>
3
</td>
<td>
1.162053
</td>
<td>
1.106804
</td>
<td>
0.642548
</td>
<td>
00:04
</td>
</tr>
<tr>
<td>
4
</td>
<td>
1.027879
</td>
<td>
1.009977
</td>
<td>
0.674140
</td>
<td>
00:04
</td>
</tr>
</tbody>

</table>
</div>
<hr>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Try training with a model that is twice as deep</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> block(ni, nf):</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nn.Sequential(ResBlock(ni, nf, stride<span class="op">=</span><span class="dv">2</span>), ResBlock(nf, nf))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> get_learner(get_model())</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">3e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="overflow-x:auto;">

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
1.940119
</td>
<td>
1.815366
</td>
<td>
0.372484
</td>
<td>
00:05
</td>
</tr>
<tr>
<td>
1
</td>
<td>
1.602748
</td>
<td>
1.461486
</td>
<td>
0.526879
</td>
<td>
00:05
</td>
</tr>
<tr>
<td>
2
</td>
<td>
1.296337
</td>
<td>
1.346131
</td>
<td>
0.571210
</td>
<td>
00:05
</td>
</tr>
<tr>
<td>
3
</td>
<td>
1.052998
</td>
<td>
0.996216
</td>
<td>
0.678471
</td>
<td>
00:05
</td>
</tr>
<tr>
<td>
4
</td>
<td>
0.926301
</td>
<td>
0.901209
</td>
<td>
0.713121
</td>
<td>
00:05
</td>
</tr>
</tbody>

</table>
</div>
</section>
<section id="a-state-of-the-art-resnet" class="level3">
<h3 class="anchored" data-anchor-id="a-state-of-the-art-resnet">A State-of-the-Art ResNet</h3>
<ul>
<li><a href="https://arxiv.org/abs/1812.01187">Bag of Tricks for Image Classification with Convolutional Neural Networks</a>
<ul>
<li>studies variations of the ResNet architecture that come at almost no additional cost in terms of number of parameters or computation</li>
<li>used a tweaked ResNet-50 architecture and Mixup to achieve a 94.6% top-5 accuracy on ImageNet compared to 92.2% with a regular ResNet-50 without Mixup</li>
</ul></li>
</ul>
<section id="top-5-accuracy" class="level4">
<h4 class="anchored" data-anchor-id="top-5-accuracy">Top-5 Accuracy</h4>
<ul>
<li>a metric testing how often the label we want is in the top-5 predictions of our model</li>
<li>used in ImageNet competition because many of the images contained multiple objects, or objects that could be easily confused or were mislabeled</li>
</ul>
</section>
<section id="stem" class="level4">
<h4 class="anchored" data-anchor-id="stem">Stem</h4>
<ul>
<li>the first few layers of a CNN</li>
<li>the stem has a different structure than the main body of the CNN</li>
<li>the vast majority of computation in a deep convolutional network occurs in the early layers
<ul>
<li>we should keep the early layers as fast and simple as possible</li>
</ul></li>
<li>the vast majority of parameters are in the last layers</li>
<li>a ResNet block takes more computation than a plain convolutional block</li>
</ul>
<hr>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _resnet_stem(<span class="op">*</span>sizes):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>        ConvLayer(sizes[i], sizes[i<span class="op">+</span><span class="dv">1</span>], <span class="dv">3</span>, stride <span class="op">=</span> <span class="dv">2</span> <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(sizes)<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    ] <span class="op">+</span> [nn.MaxPool2d(kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>_resnet_stem(<span class="dv">3</span>,<span class="dv">32</span>,<span class="dv">32</span>,<span class="dv">64</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>[ConvLayer(
   (0): Conv2d(3, 32, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
   (1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
   (2): ReLU()
 ),
 ConvLayer(
   (0): Conv2d(32, 32, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
   (1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
   (2): ReLU()
 ),
 ConvLayer(
   (0): Conv2d(32, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
   (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
   (2): ReLU()
 ),
 MaxPool2d(kernel_size=3, stride=2, padding=1, dilation=1, ceil_mode=False)]</code></pre>
<hr>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResNet(nn.Sequential):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_out, layers, expansion<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        stem <span class="op">=</span> _resnet_stem(<span class="dv">3</span>,<span class="dv">32</span>,<span class="dv">32</span>,<span class="dv">64</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.block_szs <span class="op">=</span> [<span class="dv">64</span>, <span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">256</span>, <span class="dv">512</span>]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">5</span>): <span class="va">self</span>.block_szs[i] <span class="op">*=</span> expansion</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        blocks <span class="op">=</span> [<span class="va">self</span>._make_layer(<span class="op">*</span>o) <span class="cf">for</span> o <span class="kw">in</span> <span class="bu">enumerate</span>(layers)]</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(<span class="op">*</span>stem, <span class="op">*</span>blocks,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>                         nn.AdaptiveAvgPool2d(<span class="dv">1</span>), Flatten(),</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                         nn.Linear(<span class="va">self</span>.block_szs[<span class="op">-</span><span class="dv">1</span>], n_out))</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _make_layer(<span class="va">self</span>, idx, n_layers):</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        stride <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> idx<span class="op">==</span><span class="dv">0</span> <span class="cf">else</span> <span class="dv">2</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        ch_in,ch_out <span class="op">=</span> <span class="va">self</span>.block_szs[idx:idx<span class="op">+</span><span class="dv">2</span>]</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> nn.Sequential(<span class="op">*</span>[</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>            ResBlock(ch_in <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span> <span class="cf">else</span> ch_out, ch_out, stride <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span>)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_layers)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>rn <span class="op">=</span> ResNet(dls.c, [<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> get_learner(rn)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">3e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="overflow-x:auto;">

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
1.676334
</td>
<td>
3.144195
</td>
<td>
0.332229
</td>
<td>
00:05
</td>
</tr>
<tr>
<td>
1
</td>
<td>
1.330461
</td>
<td>
1.301046
</td>
<td>
0.601274
</td>
<td>
00:05
</td>
</tr>
<tr>
<td>
2
</td>
<td>
1.081648
</td>
<td>
1.654932
</td>
<td>
0.530701
</td>
<td>
00:05
</td>
</tr>
<tr>
<td>
3
</td>
<td>
0.883710
</td>
<td>
0.889572
</td>
<td>
0.725096
</td>
<td>
00:06
</td>
</tr>
<tr>
<td>
4
</td>
<td>
0.752461
</td>
<td>
0.770025
</td>
<td>
0.751592
</td>
<td>
00:05
</td>
</tr>
</tbody>

</table>
</div>
<p><strong>Note:</strong> The optimized stem kept training time just as fast as before despite the model having more channels.</p>
</section>
</section>
<section id="bottleneck-layers" class="level3">
<h3 class="anchored" data-anchor-id="bottleneck-layers">Bottleneck Layers</h3>
<ul>
<li>instead of stacking two convolutions with a kernel size of 3, bottleneck layers use three convolutions
<ul>
<li>two <span class="math inline">\(1x1\)</span> (at the beginning and the end) and one <span class="math inline">\(3x3\)</span></li>
</ul></li>
<li><span class="math inline">\(1x1\)</span> convolutions are much faster so the block executes faster than the earlier type of ResNet block above
<ul>
<li>allows us to use more convolutional filters</li>
</ul></li>
</ul>
<hr>
<div class="sourceCode" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _conv_block(ni,nf,stride):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> nn.Sequential(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>        ConvLayer(ni, nf<span class="op">//</span><span class="dv">4</span>, <span class="dv">1</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>        ConvLayer(nf<span class="op">//</span><span class="dv">4</span>, nf<span class="op">//</span><span class="dv">4</span>, stride<span class="op">=</span>stride), </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        ConvLayer(nf<span class="op">//</span><span class="dv">4</span>, nf, <span class="dv">1</span>, act_cls<span class="op">=</span><span class="va">None</span>, norm_type<span class="op">=</span>NormType.BatchZero))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use bigger images</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> get_data(URLs.IMAGENETTE_320, presize<span class="op">=</span><span class="dv">320</span>, resize<span class="op">=</span><span class="dv">224</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>/home/innom-dt/.fastai/data/imagenette2-320</code></pre>
<hr>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>rn <span class="op">=</span> ResNet(dls.c, [<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">3</span>], <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Note:</strong> Deeper networks like this take more epochs to show improvements in accuracy.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> get_learner(rn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>SuggestedLRs(valley=2.2908675418875646e-06)</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/output_56_3.png" class="img-fluid figure-img"></p>
</figure>
</div>
<hr>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">20</span>, <span class="fl">3e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="overflow-x:auto;">

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
1.631725
</td>
<td>
1.667390
</td>
<td>
0.491720
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
1
</td>
<td>
1.396282
</td>
<td>
1.772770
</td>
<td>
0.492739
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
2
</td>
<td>
1.244810
</td>
<td>
1.644604
</td>
<td>
0.520764
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
3
</td>
<td>
1.147434
</td>
<td>
2.000461
</td>
<td>
0.433121
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
4
</td>
<td>
1.061841
</td>
<td>
1.668560
</td>
<td>
0.537580
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
5
</td>
<td>
0.971388
</td>
<td>
1.221623
</td>
<td>
0.634395
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
6
</td>
<td>
0.875570
</td>
<td>
1.315725
</td>
<td>
0.606369
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
7
</td>
<td>
0.773697
</td>
<td>
1.347997
</td>
<td>
0.625987
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
8
</td>
<td>
0.693710
</td>
<td>
1.044750
</td>
<td>
0.662166
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
9
</td>
<td>
0.642479
</td>
<td>
0.847296
</td>
<td>
0.715669
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
10
</td>
<td>
0.597677
</td>
<td>
0.815032
</td>
<td>
0.728662
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
11
</td>
<td>
0.554460
</td>
<td>
1.310289
</td>
<td>
0.632357
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
12
</td>
<td>
0.504132
</td>
<td>
0.645502
</td>
<td>
0.797707
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
13
</td>
<td>
0.444430
</td>
<td>
0.553372
</td>
<td>
0.839490
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
14
</td>
<td>
0.404554
</td>
<td>
0.524731
</td>
<td>
0.840510
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
15
</td>
<td>
0.363680
</td>
<td>
0.430417
</td>
<td>
0.869299
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
16
</td>
<td>
0.326445
</td>
<td>
0.468357
</td>
<td>
0.858854
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
17
</td>
<td>
0.291472
</td>
<td>
0.398314
</td>
<td>
0.882038
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
18
</td>
<td>
0.273819
</td>
<td>
0.441020
</td>
<td>
0.865987
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
19
</td>
<td>
0.266643
</td>
<td>
0.429735
</td>
<td>
0.868280
</td>
<td>
00:26
</td>
</tr>
</tbody>

</table>
</div>
<hr>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Try training for much longer with MixUp</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>rn <span class="op">=</span> ResNet(dls.c, [<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">3</span>], <span class="dv">4</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> Learner(dls, rn, loss_func<span class="op">=</span>CrossEntropyLossFlat(), metrics<span class="op">=</span>accuracy, cbs<span class="op">=</span>MixUp).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>learn.cbs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>(#5) [TrainEvalCallback,Recorder,ProgressCallback,MixUp,MixedPrecision]</code></pre>
<hr>
<div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre class="text"><code>SuggestedLRs(valley=0.002511886414140463)</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/output_60_3.png" class="img-fluid figure-img"></p>
</figure>
</div>
<hr>
<div class="sourceCode" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">100</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div style="overflow-x:auto; overflow-y:auto; height:800px">

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
epoch
</th>
<th>
train_loss
</th>
<th>
valid_loss
</th>
<th>
accuracy
</th>
<th>
time
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
2.357731
</td>
<td>
2.383324
</td>
<td>
0.130191
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
1
</td>
<td>
2.336724
</td>
<td>
2.336634
</td>
<td>
0.139108
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
2
</td>
<td>
2.307106
</td>
<td>
2.287395
</td>
<td>
0.160764
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
3
</td>
<td>
2.270103
</td>
<td>
2.233956
</td>
<td>
0.206369
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
4
</td>
<td>
2.230594
</td>
<td>
2.175580
</td>
<td>
0.248408
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
5
</td>
<td>
2.186367
</td>
<td>
2.114939
</td>
<td>
0.285605
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
6
</td>
<td>
2.138676
</td>
<td>
2.052963
</td>
<td>
0.314904
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
7
</td>
<td>
2.093770
</td>
<td>
1.997618
</td>
<td>
0.340892
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
8
</td>
<td>
2.050327
</td>
<td>
1.941644
</td>
<td>
0.362038
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
9
</td>
<td>
2.008452
</td>
<td>
1.897457
</td>
<td>
0.381146
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
10
</td>
<td>
1.976088
</td>
<td>
1.857476
</td>
<td>
0.393376
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
11
</td>
<td>
1.942721
</td>
<td>
1.811248
</td>
<td>
0.414013
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
12
</td>
<td>
1.913029
</td>
<td>
1.795007
</td>
<td>
0.415796
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
13
</td>
<td>
1.887761
</td>
<td>
1.753944
</td>
<td>
0.427771
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
14
</td>
<td>
1.867352
</td>
<td>
1.726478
</td>
<td>
0.446369
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
15
</td>
<td>
1.850482
</td>
<td>
1.703274
</td>
<td>
0.458089
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
16
</td>
<td>
1.820035
</td>
<td>
1.656702
</td>
<td>
0.478471
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
17
</td>
<td>
1.804909
</td>
<td>
1.627078
</td>
<td>
0.489172
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
18
</td>
<td>
1.777827
</td>
<td>
1.597916
</td>
<td>
0.509045
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
19
</td>
<td>
1.754695
</td>
<td>
1.580777
</td>
<td>
0.500637
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
20
</td>
<td>
1.730523
</td>
<td>
1.532980
</td>
<td>
0.521274
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
21
</td>
<td>
1.719565
</td>
<td>
1.506606
</td>
<td>
0.532229
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
22
</td>
<td>
1.699022
</td>
<td>
1.465760
</td>
<td>
0.549045
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
23
</td>
<td>
1.671000
</td>
<td>
1.451764
</td>
<td>
0.551083
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
24
</td>
<td>
1.642783
</td>
<td>
1.409297
</td>
<td>
0.568408
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
25
</td>
<td>
1.624837
</td>
<td>
1.379675
</td>
<td>
0.586752
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
26
</td>
<td>
1.601221
</td>
<td>
1.365560
</td>
<td>
0.586752
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
27
</td>
<td>
1.586046
</td>
<td>
1.327966
</td>
<td>
0.597452
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
28
</td>
<td>
1.569099
</td>
<td>
1.349460
</td>
<td>
0.584713
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
29
</td>
<td>
1.547596
</td>
<td>
1.318505
</td>
<td>
0.599236
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
30
</td>
<td>
1.545876
</td>
<td>
1.287586
</td>
<td>
0.611465
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
31
</td>
<td>
1.516503
</td>
<td>
1.269668
</td>
<td>
0.616815
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
32
</td>
<td>
1.510151
</td>
<td>
1.259776
</td>
<td>
0.620892
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
33
</td>
<td>
1.499429
</td>
<td>
1.274317
</td>
<td>
0.611720
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
34
</td>
<td>
1.492611
</td>
<td>
1.246700
</td>
<td>
0.622675
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
35
</td>
<td>
1.470544
</td>
<td>
1.241083
</td>
<td>
0.624204
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
36
</td>
<td>
1.453925
</td>
<td>
1.201963
</td>
<td>
0.639236
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
37
</td>
<td>
1.450406
</td>
<td>
1.166396
</td>
<td>
0.649172
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
38
</td>
<td>
1.444372
</td>
<td>
1.220421
</td>
<td>
0.629045
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
39
</td>
<td>
1.447028
</td>
<td>
1.173165
</td>
<td>
0.648153
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
40
</td>
<td>
1.425553
</td>
<td>
1.183527
</td>
<td>
0.636433
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
41
</td>
<td>
1.415466
</td>
<td>
1.161390
</td>
<td>
0.647643
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
42
</td>
<td>
1.405419
</td>
<td>
1.155593
</td>
<td>
0.648662
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
43
</td>
<td>
1.411261
</td>
<td>
1.179044
</td>
<td>
0.636688
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
44
</td>
<td>
1.404317
</td>
<td>
1.118105
</td>
<td>
0.665733
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
45
</td>
<td>
1.392309
</td>
<td>
1.119027
</td>
<td>
0.663949
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
46
</td>
<td>
1.382899
</td>
<td>
1.081154
</td>
<td>
0.674395
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
47
</td>
<td>
1.374947
</td>
<td>
1.107488
</td>
<td>
0.661911
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
48
</td>
<td>
1.364989
</td>
<td>
1.132930
</td>
<td>
0.655287
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
49
</td>
<td>
1.371344
</td>
<td>
1.078784
</td>
<td>
0.674904
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
50
</td>
<td>
1.365992
</td>
<td>
1.086367
</td>
<td>
0.673885
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
51
</td>
<td>
1.355748
</td>
<td>
1.102273
</td>
<td>
0.663185
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
52
</td>
<td>
1.346135
</td>
<td>
1.069236
</td>
<td>
0.672357
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
53
</td>
<td>
1.342680
</td>
<td>
1.059305
</td>
<td>
0.681019
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
54
</td>
<td>
1.342354
</td>
<td>
1.056270
</td>
<td>
0.683057
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
55
</td>
<td>
1.348057
</td>
<td>
1.054993
</td>
<td>
0.680000
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
56
</td>
<td>
1.327710
</td>
<td>
1.040115
</td>
<td>
0.682293
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
57
</td>
<td>
1.331265
</td>
<td>
1.082385
</td>
<td>
0.669299
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
58
</td>
<td>
1.328200
</td>
<td>
1.027992
</td>
<td>
0.686879
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
59
</td>
<td>
1.328389
</td>
<td>
1.039981
</td>
<td>
0.681529
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
60
</td>
<td>
1.319880
</td>
<td>
1.033769
</td>
<td>
0.682293
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
61
</td>
<td>
1.323757
</td>
<td>
1.039335
</td>
<td>
0.681783
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
62
</td>
<td>
1.308027
</td>
<td>
1.014351
</td>
<td>
0.690191
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
63
</td>
<td>
1.317649
</td>
<td>
1.047797
</td>
<td>
0.677197
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
64
</td>
<td>
1.291757
</td>
<td>
1.013592
</td>
<td>
0.690955
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
65
</td>
<td>
1.303231
</td>
<td>
1.045248
</td>
<td>
0.680255
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
66
</td>
<td>
1.296039
</td>
<td>
1.027358
</td>
<td>
0.684331
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
67
</td>
<td>
1.298419
</td>
<td>
1.015950
</td>
<td>
0.692994
</td>
<td>
00:27
</td>
</tr>
<tr>
<td>
68
</td>
<td>
1.295830
</td>
<td>
1.029434
</td>
<td>
0.684841
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
69
</td>
<td>
1.301385
</td>
<td>
1.021460
</td>
<td>
0.687898
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
70
</td>
<td>
1.297332
</td>
<td>
1.003877
</td>
<td>
0.695032
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
71
</td>
<td>
1.304215
</td>
<td>
1.015531
</td>
<td>
0.689936
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
72
</td>
<td>
1.301384
</td>
<td>
0.997708
</td>
<td>
0.696051
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
73
</td>
<td>
1.299483
</td>
<td>
0.999720
</td>
<td>
0.696561
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
74
</td>
<td>
1.279976
</td>
<td>
0.983441
</td>
<td>
0.702420
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
75
</td>
<td>
1.283374
</td>
<td>
0.998377
</td>
<td>
0.694522
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
76
</td>
<td>
1.297397
</td>
<td>
0.997266
</td>
<td>
0.693248
</td>
<td>
00:26
</td>
</tr>
<tr>
<td>
77
</td>
<td>
1.292927
</td>
<td>
0.989717
</td>
<td>
0.697580
</td>
<td>
00:27
</td>
</tr>
</tbody>

</table>
</div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://www.oreilly.com/library/view/deep-learning-for/9781492045519/">Deep Learning for Coders with fastai &amp; PyTorch</a></li>
<li><a href="https://github.com/fastai/fastbook">The fastai book GitHub Repository</a></li>
</ul>
<p><strong>Previous:</strong> <a href="../chapter-13/">Notes on fastai Book Ch. 13</a></p>
<p><strong>Next:</strong> <a href="../chapter-15/">Notes on fastai Book Ch. 15</a></p>


</section>

</main> <!-- /main -->
<!-- Cloudflare Web Analytics --><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;56b8d2f624604c4891327b3c0d9f6703&quot;}"></script><!-- End Cloudflare Web Analytics -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="cj-mills/christianjmills" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Copyright 2023, Christian J. Mills
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>