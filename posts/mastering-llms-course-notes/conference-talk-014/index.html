<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christian Mills">
<meta name="dcterms.date" content="2024-08-02">
<meta name="description" content="In this talk, Ben Clavié from Answer.ai deconstructs the concept of Retrieval-Augmented Generation (RAG) and walks through building a robust, basic RAG pipeline.">

<title>Christian Mills - Conference Talk 14: Explaining the Basics of Retrieval Augmented Generation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../images/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Christian Mills - Conference Talk 14: Explaining the Basics of Retrieval Augmented Generation">
<meta property="og:description" content="In this talk, Ben Clavié from Answer.ai deconstructs the concept of Retrieval-Augmented Generation (RAG) and walks through building a robust, basic RAG pipeline.">
<meta property="og:image" content="https://christianjmills.com/posts/mastering-llms-course-notes/social-media/cover.jpg">
<meta property="og:site_name" content="Christian Mills">
<meta name="twitter:title" content="Christian Mills - Conference Talk 14: Explaining the Basics of Retrieval Augmented Generation">
<meta name="twitter:description" content="In this talk, Ben Clavié from Answer.ai deconstructs the concept of Retrieval-Augmented Generation (RAG) and walks through building a robust, basic RAG pipeline.">
<meta name="twitter:image" content="https://christianjmills.com/posts/mastering-llms-course-notes/social-media/cover.jpg">
<meta name="twitter:creator" content="@cdotjdotmills">
<meta name="twitter:site" content="@cdotjdotmills">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Christian Mills</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series/tutorials/index.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series/notes/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:christian@christianjmills.com"> <i class="bi bi-envelope-fill" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cj-mills"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/christianjmills"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#summary" id="toc-summary" class="nav-link active" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#demystifying-rag" id="toc-demystifying-rag" class="nav-link" data-scroll-target="#demystifying-rag">Demystifying RAG</a></li>
  <li><a href="#the-compact-mvp-a-simple-rag-implementation" id="toc-the-compact-mvp-a-simple-rag-implementation" class="nav-link" data-scroll-target="#the-compact-mvp-a-simple-rag-implementation">The Compact MVP: A Simple RAG Implementation</a></li>
  <li><a href="#understanding-bi-encoders-in-vector-search" id="toc-understanding-bi-encoders-in-vector-search" class="nav-link" data-scroll-target="#understanding-bi-encoders-in-vector-search">Understanding Bi-Encoders in Vector Search</a></li>
  <li><a href="#improving-retrieval-with-re-ranking" id="toc-improving-retrieval-with-re-ranking" class="nav-link" data-scroll-target="#improving-retrieval-with-re-ranking">Improving Retrieval with Re-ranking</a></li>
  <li><a href="#keyword-search" id="toc-keyword-search" class="nav-link" data-scroll-target="#keyword-search">Keyword Search</a>
  <ul>
  <li><a href="#the-tf-idf-mvp" id="toc-the-tf-idf-mvp" class="nav-link" data-scroll-target="#the-tf-idf-mvp">The TF-IDF MVP++</a></li>
  </ul></li>
  <li><a href="#leveraging-metadata-for-targeted-retrieval" id="toc-leveraging-metadata-for-targeted-retrieval" class="nav-link" data-scroll-target="#leveraging-metadata-for-targeted-retrieval">Leveraging Metadata for Targeted Retrieval</a></li>
  <li><a href="#putting-it-all-together-the-complete-mvp-pipeline" id="toc-putting-it-all-together-the-complete-mvp-pipeline" class="nav-link" data-scroll-target="#putting-it-all-together-the-complete-mvp-pipeline">Putting it All Together: The Complete MVP++ Pipeline</a>
  <ul>
  <li><a href="#the-final-compact-mvp" id="toc-the-final-compact-mvp" class="nav-link" data-scroll-target="#the-final-compact-mvp">The Final Compact MVP++</a></li>
  <li><a href="#code-example-implementing-the-mvp-with-lancedb" id="toc-code-example-implementing-the-mvp-with-lancedb" class="nav-link" data-scroll-target="#code-example-implementing-the-mvp-with-lancedb">Code Example: Implementing the MVP++ with LanceDB</a></li>
  </ul></li>
  <li><a href="#beyond-the-basics-future-exploration-and-resources" id="toc-beyond-the-basics-future-exploration-and-resources" class="nav-link" data-scroll-target="#beyond-the-basics-future-exploration-and-resources">Beyond the Basics: Future Exploration and Resources</a></li>
  <li><a href="#qa-session" id="toc-qa-session" class="nav-link" data-scroll-target="#qa-session">Q&amp;A Session</a>
  <ul>
  <li><a href="#fine-tuning-bi-encoders-and-cross-encoders" id="toc-fine-tuning-bi-encoders-and-cross-encoders" class="nav-link" data-scroll-target="#fine-tuning-bi-encoders-and-cross-encoders">Fine-tuning Bi-Encoders and Cross-Encoders</a></li>
  <li><a href="#combining-bi-encoder-and-tf-idf-scores" id="toc-combining-bi-encoder-and-tf-idf-scores" class="nav-link" data-scroll-target="#combining-bi-encoder-and-tf-idf-scores">Combining Bi-Encoder and TF-IDF Scores</a></li>
  <li><a href="#rags-future-with-million-token-context-lengths" id="toc-rags-future-with-million-token-context-lengths" class="nav-link" data-scroll-target="#rags-future-with-million-token-context-lengths">RAG’s Future with Million-Token Context Lengths</a></li>
  <li><a href="#chunking-strategies" id="toc-chunking-strategies" class="nav-link" data-scroll-target="#chunking-strategies">Chunking Strategies</a></li>
  <li><a href="#fine-tuning-bi-encoders" id="toc-fine-tuning-bi-encoders" class="nav-link" data-scroll-target="#fine-tuning-bi-encoders">Fine-tuning Bi-Encoders</a></li>
  <li><a href="#colbert-clarification-and-discussion" id="toc-colbert-clarification-and-discussion" class="nav-link" data-scroll-target="#colbert-clarification-and-discussion">Colbert Clarification and Discussion</a></li>
  <li><a href="#tools-for-fine-tuning-embeddings" id="toc-tools-for-fine-tuning-embeddings" class="nav-link" data-scroll-target="#tools-for-fine-tuning-embeddings">Tools for Fine-tuning Embeddings</a></li>
  <li><a href="#fine-tuning-embeddings-workflow" id="toc-fine-tuning-embeddings-workflow" class="nav-link" data-scroll-target="#fine-tuning-embeddings-workflow">Fine-tuning Embeddings Workflow</a></li>
  <li><a href="#impact-of-long-context-windows-on-rag" id="toc-impact-of-long-context-windows-on-rag" class="nav-link" data-scroll-target="#impact-of-long-context-windows-on-rag">Impact of Long Context Windows on RAG</a></li>
  <li><a href="#fine-tuning-encoder-tutorials" id="toc-fine-tuning-encoder-tutorials" class="nav-link" data-scroll-target="#fine-tuning-encoder-tutorials">Fine-tuning Encoder Tutorials</a></li>
  <li><a href="#go-to-embedding-models" id="toc-go-to-embedding-models" class="nav-link" data-scroll-target="#go-to-embedding-models">Go-to Embedding Models</a></li>
  <li><a href="#using-elasticsearch-for-rag" id="toc-using-elasticsearch-for-rag" class="nav-link" data-scroll-target="#using-elasticsearch-for-rag">Using Elasticsearch for RAG</a></li>
  <li><a href="#bm25-score-in-re-ranking" id="toc-bm25-score-in-re-ranking" class="nav-link" data-scroll-target="#bm25-score-in-re-ranking">BM25 Score in Re-ranking</a></li>
  <li><a href="#strategies-for-chunks-exceeding-context-window" id="toc-strategies-for-chunks-exceeding-context-window" class="nav-link" data-scroll-target="#strategies-for-chunks-exceeding-context-window">Strategies for Chunks Exceeding Context Window</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Conference Talk 14: Explaining the Basics of Retrieval Augmented Generation</h1>
  <div class="quarto-categories">
    <div class="quarto-category">notes</div>
    <div class="quarto-category">llms</div>
  </div>
  </div>

<div>
  <div class="description">
    In this talk, <strong>Ben Clavié</strong> from Answer.ai deconstructs the concept of Retrieval-Augmented Generation (RAG) and walks through building a robust, basic RAG pipeline.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christian Mills </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 2, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#demystifying-rag">Demystifying RAG</a></li>
<li><a href="#the-compact-mvp-a-simple-rag-implementation">The Compact MVP: A Simple RAG Implementation</a></li>
<li><a href="#understanding-bi-encoders-in-vector-search">Understanding Bi-Encoders in Vector Search</a></li>
<li><a href="#improving-retrieval-with-re-ranking">Improving Retrieval with Re-ranking</a></li>
<li><a href="#keyword-search">Keyword Search</a></li>
<li><a href="#leveraging-metadata-for-targeted-retrieval">Leveraging Metadata for Targeted Retrieval</a></li>
<li><a href="#putting-it-all-together-the-complete-mvp-pipeline">Putting it All Together: The Complete MVP++ Pipeline</a></li>
<li><a href="#beyond-the-basics-future-exploration-and-resources">Beyond the Basics: Future Exploration and Resources</a></li>
<li><a href="#qa-session">Q&amp;A Session</a></li>
</ul>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p><a href="https://ben.clavie.eu/">Ben Clavié</a> deconstructs the concept of Retrieval-Augmented Generation (RAG) and guides the audience through building a robust, basic RAG pipeline. He emphasizes that RAG is not a standalone technology, but a pipeline combining retrieval and generation, and each component needs individual attention for optimization. Ben advocates for a “MVP++” approach, incorporating essential elements like bi-encoders, re-ranking, keyword search (TF-IDF/BM25), and metadata filtering for a well-rounded system.</p>
</section>
<section id="demystifying-rag" class="level2">
<h2 class="anchored" data-anchor-id="demystifying-rag">Demystifying RAG</h2>
<ul>
<li><strong>RAG: Overused and Misunderstood</strong>
<ul>
<li>The term “RAG” is often used incorrectly to represent an end-to-end system, creating confusion.</li>
</ul></li>
<li><strong>RAG as a Pipeline: Retrieval + Generation</strong>
<ul>
<li>RAG simply combines retrieval (finding relevant information) and generation (creating text) using Large Language Models (LLMs).</li>
<li>It’s not a single technology, but a pipeline requiring optimization at each stage: retrieval, generation, and their connection.</li>
</ul></li>
<li><strong>Importance of Identifying Specific RAG Issues</strong>
<ul>
<li>“My RAG doesn’t work” is too broad. Pinpointing the failing component (retrieval, LLM utilization) is crucial for debugging.</li>
</ul></li>
</ul>
</section>
<section id="the-compact-mvp-a-simple-rag-implementation" class="level2">
<h2 class="anchored" data-anchor-id="the-compact-mvp-a-simple-rag-implementation">The Compact MVP: A Simple RAG Implementation</h2>
<ul>
<li><strong>Basic Pipeline Components and Flow</strong>
<ul>
<li>Query embedding</li>
<li>Document embedding</li>
<li>Cosine similarity search for relevant documents</li>
</ul></li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 478.00 336.80" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 332.8)">
<title>bencoder_approach</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-332.8 474,-332.8 474,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M20,-136C20,-136 450,-136 450,-136 456,-136 462,-142 462,-148 462,-148 462,-272.8 462,-272.8 462,-278.8 456,-284.8 450,-284.8 450,-284.8 20,-284.8 20,-284.8 14,-284.8 8,-278.8 8,-272.8 8,-272.8 8,-148 8,-148 8,-142 14,-136 20,-136"></path>
<text text-anchor="middle" x="235" y="-268.2" font-family="Times,serif" font-size="14.00" fill="red">This is called a 'bi-encoder' approach</text>
</g>
<!-- Query -->
<g id="node1" class="node">
<title>Query</title>
<path fill="#a4d8ff" stroke="black" d="M136,-328.8C136,-328.8 106,-328.8 106,-328.8 100,-328.8 94,-322.8 94,-316.8 94,-316.8 94,-304.8 94,-304.8 94,-298.8 100,-292.8 106,-292.8 106,-292.8 136,-292.8 136,-292.8 142,-292.8 148,-298.8 148,-304.8 148,-304.8 148,-316.8 148,-316.8 148,-322.8 142,-328.8 136,-328.8"></path>
<text text-anchor="middle" x="121" y="-306.6" font-family="Times,serif" font-size="14.00">Query</text>
</g>
<!-- Query_Embedding_Model -->
<g id="node3" class="node">
<title>Query_Embedding_Model</title>
<path fill="#ffc9c9" stroke="black" d="M169.1,-252C169.1,-252 72.9,-252 72.9,-252 66.9,-252 60.9,-246 60.9,-240 60.9,-240 60.9,-228 60.9,-228 60.9,-222 66.9,-216 72.9,-216 72.9,-216 169.1,-216 169.1,-216 175.1,-216 181.1,-222 181.1,-228 181.1,-228 181.1,-240 181.1,-240 181.1,-246 175.1,-252 169.1,-252"></path>
<text text-anchor="middle" x="121" y="-229.8" font-family="Times,serif" font-size="14.00">Embedding Model</text>
</g>
<!-- Query&#45;&gt;Query_Embedding_Model -->
<g id="edge1" class="edge">
<title>Query-&gt;Query_Embedding_Model</title>
<path fill="none" stroke="black" d="M121,-292.45C121,-283.58 121,-272.56 121,-262.56"></path>
<polygon fill="black" stroke="black" points="124.5,-262.25 121,-252.25 117.5,-262.25 124.5,-262.25"></polygon>
</g>
<!-- Documents -->
<g id="node2" class="node">
<title>Documents</title>
<path fill="#feec98" stroke="black" d="M376.77,-328.8C376.77,-328.8 321.23,-328.8 321.23,-328.8 315.23,-328.8 309.23,-322.8 309.23,-316.8 309.23,-316.8 309.23,-304.8 309.23,-304.8 309.23,-298.8 315.23,-292.8 321.23,-292.8 321.23,-292.8 376.77,-292.8 376.77,-292.8 382.77,-292.8 388.77,-298.8 388.77,-304.8 388.77,-304.8 388.77,-316.8 388.77,-316.8 388.77,-322.8 382.77,-328.8 376.77,-328.8"></path>
<text text-anchor="middle" x="349" y="-306.6" font-family="Times,serif" font-size="14.00">Documents</text>
</g>
<!-- Document_Embedding_Model -->
<g id="node5" class="node">
<title>Document_Embedding_Model</title>
<path fill="#ffc9c9" stroke="black" d="M397.1,-252C397.1,-252 300.9,-252 300.9,-252 294.9,-252 288.9,-246 288.9,-240 288.9,-240 288.9,-228 288.9,-228 288.9,-222 294.9,-216 300.9,-216 300.9,-216 397.1,-216 397.1,-216 403.1,-216 409.1,-222 409.1,-228 409.1,-228 409.1,-240 409.1,-240 409.1,-246 403.1,-252 397.1,-252"></path>
<text text-anchor="middle" x="349" y="-229.8" font-family="Times,serif" font-size="14.00">Embedding Model</text>
</g>
<!-- Documents&#45;&gt;Document_Embedding_Model -->
<g id="edge3" class="edge">
<title>Documents-&gt;Document_Embedding_Model</title>
<path fill="none" stroke="black" d="M349,-292.45C349,-283.58 349,-272.56 349,-262.56"></path>
<polygon fill="black" stroke="black" points="352.5,-262.25 349,-252.25 345.5,-262.25 352.5,-262.25"></polygon>
</g>
<!-- Query_Embedding_Pooling -->
<g id="node4" class="node">
<title>Query_Embedding_Pooling</title>
<path fill="#ffc9c9" stroke="black" d="M214.41,-180C214.41,-180 27.59,-180 27.59,-180 21.59,-180 15.59,-174 15.59,-168 15.59,-168 15.59,-156 15.59,-156 15.59,-150 21.59,-144 27.59,-144 27.59,-144 214.41,-144 214.41,-144 220.41,-144 226.41,-150 226.41,-156 226.41,-156 226.41,-168 226.41,-168 226.41,-174 220.41,-180 214.41,-180"></path>
<text text-anchor="middle" x="121" y="-157.8" font-family="Times,serif" font-size="14.00">Embedding pooling (into 1 vector)</text>
</g>
<!-- Query_Embedding_Model&#45;&gt;Query_Embedding_Pooling -->
<g id="edge2" class="edge">
<title>Query_Embedding_Model-&gt;Query_Embedding_Pooling</title>
<path fill="none" stroke="black" d="M121,-215.7C121,-207.98 121,-198.71 121,-190.11"></path>
<polygon fill="black" stroke="black" points="124.5,-190.1 121,-180.1 117.5,-190.1 124.5,-190.1"></polygon>
</g>
<!-- Cosine_Similarity_Search -->
<g id="node7" class="node">
<title>Cosine_Similarity_Search</title>
<path fill="#b2f3bb" stroke="black" d="M298.8,-108C298.8,-108 171.2,-108 171.2,-108 165.2,-108 159.2,-102 159.2,-96 159.2,-96 159.2,-84 159.2,-84 159.2,-78 165.2,-72 171.2,-72 171.2,-72 298.8,-72 298.8,-72 304.8,-72 310.8,-78 310.8,-84 310.8,-84 310.8,-96 310.8,-96 310.8,-102 304.8,-108 298.8,-108"></path>
<text text-anchor="middle" x="235" y="-85.8" font-family="Times,serif" font-size="14.00">Cosine similarity search</text>
</g>
<!-- Query_Embedding_Pooling&#45;&gt;Cosine_Similarity_Search -->
<g id="edge5" class="edge">
<title>Query_Embedding_Pooling-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M148.89,-143.88C163.79,-134.72 182.33,-123.34 198.38,-113.48"></path>
<polygon fill="black" stroke="black" points="200.31,-116.41 207.01,-108.19 196.65,-110.44 200.31,-116.41"></polygon>
</g>
<!-- Document_Embedding_Pooling -->
<g id="node6" class="node">
<title>Document_Embedding_Pooling</title>
<path fill="#ffc9c9" stroke="black" d="M442.41,-180C442.41,-180 255.59,-180 255.59,-180 249.59,-180 243.59,-174 243.59,-168 243.59,-168 243.59,-156 243.59,-156 243.59,-150 249.59,-144 255.59,-144 255.59,-144 442.41,-144 442.41,-144 448.41,-144 454.41,-150 454.41,-156 454.41,-156 454.41,-168 454.41,-168 454.41,-174 448.41,-180 442.41,-180"></path>
<text text-anchor="middle" x="349" y="-157.8" font-family="Times,serif" font-size="14.00">Embedding pooling (into 1 vector)</text>
</g>
<!-- Document_Embedding_Model&#45;&gt;Document_Embedding_Pooling -->
<g id="edge4" class="edge">
<title>Document_Embedding_Model-&gt;Document_Embedding_Pooling</title>
<path fill="none" stroke="black" d="M349,-215.7C349,-207.98 349,-198.71 349,-190.11"></path>
<polygon fill="black" stroke="black" points="352.5,-190.1 349,-180.1 345.5,-190.1 352.5,-190.1"></polygon>
</g>
<!-- Document_Embedding_Pooling&#45;&gt;Cosine_Similarity_Search -->
<g id="edge6" class="edge">
<title>Document_Embedding_Pooling-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M321.11,-143.88C306.21,-134.72 287.67,-123.34 271.62,-113.48"></path>
<polygon fill="black" stroke="black" points="273.35,-110.44 262.99,-108.19 269.69,-116.41 273.35,-110.44"></polygon>
</g>
<!-- Results -->
<g id="node8" class="node">
<title>Results</title>
<path fill="#b2f3bb" stroke="black" d="M251.73,-36C251.73,-36 218.27,-36 218.27,-36 212.27,-36 206.27,-30 206.27,-24 206.27,-24 206.27,-12 206.27,-12 206.27,-6 212.27,0 218.27,0 218.27,0 251.73,0 251.73,0 257.73,0 263.73,-6 263.73,-12 263.73,-12 263.73,-24 263.73,-24 263.73,-30 257.73,-36 251.73,-36"></path>
<text text-anchor="middle" x="235" y="-13.8" font-family="Times,serif" font-size="14.00">Results</text>
</g>
<!-- Cosine_Similarity_Search&#45;&gt;Results -->
<g id="edge7" class="edge">
<title>Cosine_Similarity_Search-&gt;Results</title>
<path fill="none" stroke="black" d="M235,-71.7C235,-63.98 235,-54.71 235,-46.11"></path>
<polygon fill="black" stroke="black" points="238.5,-46.1 235,-36.1 231.5,-46.1 238.5,-46.1"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li><div class="callout callout-style-default callout-note callout-titled" title="Code Example: Vector Search with NumPy">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Code Example: Vector Search with NumPy
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Demonstrates a basic RAG pipeline without a vector database, emphasizing simplicity.</li>
<li>Uses NumPy for cosine similarity search for demonstration purposes.</li>
</ul>
<div class="sourceCode" id="annotated-cell-2"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-2-1"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the embedding model</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-2-2" class="code-annotation-target"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="annotated-cell-2-3"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SentenceTransformer(<span class="st">"Alibaba-NLP/gte-base-en-v1.5"</span>)</span>
<span id="annotated-cell-2-4"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-2-5" class="code-annotation-target"><a href="#annotated-cell-2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch some text content...</span></span>
<span id="annotated-cell-2-6"><a href="#annotated-cell-2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> wikipediaapi <span class="im">import</span> Wikipedia</span>
<span id="annotated-cell-2-7"><a href="#annotated-cell-2-7" aria-hidden="true" tabindex="-1"></a>wiki <span class="op">=</span> Wikipedia(<span class="st">'RAGBot/0.0'</span>, <span class="st">'en'</span>)</span>
<span id="annotated-cell-2-8"><a href="#annotated-cell-2-8" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> wiki.page(<span class="st">'Hayao_Miyazaki'</span>).text</span>
<span id="annotated-cell-2-9"><a href="#annotated-cell-2-9" aria-hidden="true" tabindex="-1"></a>paragraphs <span class="op">=</span> doc.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)</span>
<span id="annotated-cell-2-10"><a href="#annotated-cell-2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ...And embed it.</span></span>
<span id="annotated-cell-2-11"><a href="#annotated-cell-2-11" aria-hidden="true" tabindex="-1"></a>docs_embed <span class="op">=</span> model.encode(paragraphs, normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-2-12"><a href="#annotated-cell-2-12" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-2-13" class="code-annotation-target"><a href="#annotated-cell-2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Embed the query</span></span>
<span id="annotated-cell-2-14"><a href="#annotated-cell-2-14" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"What was Studio Ghibli's first film?"</span></span>
<span id="annotated-cell-2-15"><a href="#annotated-cell-2-15" aria-hidden="true" tabindex="-1"></a>query_embed <span class="op">=</span> model.encode(query, normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="annotated-cell-2-16"><a href="#annotated-cell-2-16" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-2-17" class="code-annotation-target"><a href="#annotated-cell-2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the 3 closest paragraphs to the query</span></span>
<span id="annotated-cell-2-18"><a href="#annotated-cell-2-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="annotated-cell-2-19"><a href="#annotated-cell-2-19" aria-hidden="true" tabindex="-1"></a>similarities <span class="op">=</span> np.dot(docs_embed, query_embed.T)</span>
<span id="annotated-cell-2-20"><a href="#annotated-cell-2-20" aria-hidden="true" tabindex="-1"></a>top_3_idx <span class="op">=</span> similarities.topk(<span class="dv">3</span>).indices.tolist()</span>
<span id="annotated-cell-2-21"><a href="#annotated-cell-2-21" aria-hidden="true" tabindex="-1"></a>most_similar_documents <span class="op">=</span> [paragraphs[idx] <span class="cf">for</span> idx <span class="kw">in</span> top_3_idx]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="2,3" data-code-annotation="1">Load Bi-Encoder</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="5,6,7,8,9,10,11" data-code-annotation="2">Embed Documents</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="13,14,15" data-code-annotation="3">Embed Query</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="17,18,19,20,21" data-code-annotation="4">Cosine Similarity Search</span>
</dd>
</dl>
</div>
</div></li>
</ul>
</section>
<section id="understanding-bi-encoders-in-vector-search" class="level2">
<h2 class="anchored" data-anchor-id="understanding-bi-encoders-in-vector-search">Understanding Bi-Encoders in Vector Search</h2>
<ul>
<li><p><strong>Vector Databases: When and Why?</strong></p>
<ul>
<li>Useful for efficiently searching large document sets using Approximate Search techniques
<ul>
<li><strong>HNSW</strong>
<ul>
<li><strong>Paper:</strong> <a href="https://arxiv.org/abs/1603.09320">Efficient and robust approximate nearest neighbor search using Hierarchical Navigable Small World graphs</a></li>
<li><strong>Article:</strong> <a href="https://www.pinecone.io/learn/series/faiss/hnsw/">Hierarchical Navigable Small Worlds (HNSW)</a></li>
</ul></li>
<li><strong>IVFPQ</strong>
<ul>
<li><strong>Article:</strong> <a href="https://www.pinecone.io/learn/series/faiss/product-quantization/">Product Quantization: Compressing high-dimensional vectors by 97%</a></li>
</ul></li>
</ul></li>
<li>Not necessary for small datasets (e.g., 500 documents)
<ul>
<li>Modern CPU can search through hundreds of vectors in milliseconds</li>
</ul></li>
</ul></li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 478.00 351.80" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 347.8)">
<title>bencoder_approach</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-347.8 474,-347.8 474,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M20,-153.8C20,-153.8 450,-153.8 450,-153.8 456,-153.8 462,-159.8 462,-165.8 462,-165.8 462,-266.8 462,-266.8 462,-272.8 456,-278.8 450,-278.8 450,-278.8 20,-278.8 20,-278.8 14,-278.8 8,-272.8 8,-266.8 8,-266.8 8,-165.8 8,-165.8 8,-159.8 14,-153.8 20,-153.8"></path>
</g>
<!-- Query -->
<g id="node1" class="node">
<title>Query</title>
<path fill="#a4d8ff" stroke="black" d="M136,-343.8C136,-343.8 106,-343.8 106,-343.8 100,-343.8 94,-337.8 94,-331.8 94,-331.8 94,-319.8 94,-319.8 94,-313.8 100,-307.8 106,-307.8 106,-307.8 136,-307.8 136,-307.8 142,-307.8 148,-313.8 148,-319.8 148,-319.8 148,-331.8 148,-331.8 148,-337.8 142,-343.8 136,-343.8"></path>
<text text-anchor="middle" x="121" y="-321.6" font-family="Times,serif" font-size="14.00">Query</text>
</g>
<!-- Query_Embedding_Model -->
<g id="node3" class="node">
<title>Query_Embedding_Model</title>
<path fill="#fddde6" stroke="black" d="M169.1,-270.8C169.1,-270.8 72.9,-270.8 72.9,-270.8 66.9,-270.8 60.9,-264.8 60.9,-258.8 60.9,-258.8 60.9,-246.8 60.9,-246.8 60.9,-240.8 66.9,-234.8 72.9,-234.8 72.9,-234.8 169.1,-234.8 169.1,-234.8 175.1,-234.8 181.1,-240.8 181.1,-246.8 181.1,-246.8 181.1,-258.8 181.1,-258.8 181.1,-264.8 175.1,-270.8 169.1,-270.8"></path>
<text text-anchor="middle" x="121" y="-248.6" font-family="Times,serif" font-size="14.00">Embedding Model</text>
</g>
<!-- Query&#45;&gt;Query_Embedding_Model -->
<g id="edge1" class="edge">
<title>Query-&gt;Query_Embedding_Model</title>
<path fill="none" stroke="black" d="M121,-307.61C121,-299.59 121,-289.85 121,-280.87"></path>
<polygon fill="black" stroke="black" points="124.5,-280.83 121,-270.83 117.5,-280.83 124.5,-280.83"></polygon>
</g>
<!-- Documents -->
<g id="node2" class="node">
<title>Documents</title>
<path fill="#feec98" stroke="black" d="M376.77,-343.8C376.77,-343.8 321.23,-343.8 321.23,-343.8 315.23,-343.8 309.23,-337.8 309.23,-331.8 309.23,-331.8 309.23,-319.8 309.23,-319.8 309.23,-313.8 315.23,-307.8 321.23,-307.8 321.23,-307.8 376.77,-307.8 376.77,-307.8 382.77,-307.8 388.77,-313.8 388.77,-319.8 388.77,-319.8 388.77,-331.8 388.77,-331.8 388.77,-337.8 382.77,-343.8 376.77,-343.8"></path>
<text text-anchor="middle" x="349" y="-321.6" font-family="Times,serif" font-size="14.00">Documents</text>
</g>
<!-- Document_Embedding_Model -->
<g id="node5" class="node">
<title>Document_Embedding_Model</title>
<path fill="#fddde6" stroke="black" d="M397.1,-270.8C397.1,-270.8 300.9,-270.8 300.9,-270.8 294.9,-270.8 288.9,-264.8 288.9,-258.8 288.9,-258.8 288.9,-246.8 288.9,-246.8 288.9,-240.8 294.9,-234.8 300.9,-234.8 300.9,-234.8 397.1,-234.8 397.1,-234.8 403.1,-234.8 409.1,-240.8 409.1,-246.8 409.1,-246.8 409.1,-258.8 409.1,-258.8 409.1,-264.8 403.1,-270.8 397.1,-270.8"></path>
<text text-anchor="middle" x="349" y="-248.6" font-family="Times,serif" font-size="14.00">Embedding Model</text>
</g>
<!-- Documents&#45;&gt;Document_Embedding_Model -->
<g id="edge3" class="edge">
<title>Documents-&gt;Document_Embedding_Model</title>
<path fill="none" stroke="black" d="M349,-307.61C349,-299.59 349,-289.85 349,-280.87"></path>
<polygon fill="black" stroke="black" points="352.5,-280.83 349,-270.83 345.5,-280.83 352.5,-280.83"></polygon>
</g>
<!-- Query_Embedding_Pooling -->
<g id="node4" class="node">
<title>Query_Embedding_Pooling</title>
<path fill="#fddde6" stroke="black" d="M214.41,-197.8C214.41,-197.8 27.59,-197.8 27.59,-197.8 21.59,-197.8 15.59,-191.8 15.59,-185.8 15.59,-185.8 15.59,-173.8 15.59,-173.8 15.59,-167.8 21.59,-161.8 27.59,-161.8 27.59,-161.8 214.41,-161.8 214.41,-161.8 220.41,-161.8 226.41,-167.8 226.41,-173.8 226.41,-173.8 226.41,-185.8 226.41,-185.8 226.41,-191.8 220.41,-197.8 214.41,-197.8"></path>
<text text-anchor="middle" x="121" y="-175.6" font-family="Times,serif" font-size="14.00">Embedding pooling (into 1 vector)</text>
</g>
<!-- Query_Embedding_Model&#45;&gt;Query_Embedding_Pooling -->
<g id="edge2" class="edge">
<title>Query_Embedding_Model-&gt;Query_Embedding_Pooling</title>
<path fill="none" stroke="black" d="M121,-234.61C121,-226.59 121,-216.85 121,-207.87"></path>
<polygon fill="black" stroke="black" points="124.5,-207.83 121,-197.83 117.5,-207.83 124.5,-207.83"></polygon>
</g>
<!-- Cosine_Similarity_Search -->
<g id="node7" class="node">
<title>Cosine_Similarity_Search</title>
<path fill="#b2f3bb" stroke="black" d="M297.8,-109C297.8,-109 170.2,-109 170.2,-109 164.2,-109 158.2,-103 158.2,-97 158.2,-97 158.2,-85 158.2,-85 158.2,-79 164.2,-73 170.2,-73 170.2,-73 297.8,-73 297.8,-73 303.8,-73 309.8,-79 309.8,-85 309.8,-85 309.8,-97 309.8,-97 309.8,-103 303.8,-109 297.8,-109"></path>
<text text-anchor="middle" x="234" y="-86.8" font-family="Times,serif" font-size="14.00">Cosine similarity search</text>
</g>
<!-- Query_Embedding_Pooling&#45;&gt;Cosine_Similarity_Search -->
<g id="edge5" class="edge">
<title>Query_Embedding_Pooling-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M143.33,-161.65C160.58,-148.4 184.65,-129.91 203.66,-115.31"></path>
<polygon fill="black" stroke="black" points="205.92,-117.98 211.72,-109.11 201.66,-112.43 205.92,-117.98"></polygon>
</g>
<!-- Document_Embedding_Pooling -->
<g id="node6" class="node">
<title>Document_Embedding_Pooling</title>
<path fill="#fddde6" stroke="black" d="M442.41,-197.8C442.41,-197.8 255.59,-197.8 255.59,-197.8 249.59,-197.8 243.59,-191.8 243.59,-185.8 243.59,-185.8 243.59,-173.8 243.59,-173.8 243.59,-167.8 249.59,-161.8 255.59,-161.8 255.59,-161.8 442.41,-161.8 442.41,-161.8 448.41,-161.8 454.41,-167.8 454.41,-173.8 454.41,-173.8 454.41,-185.8 454.41,-185.8 454.41,-191.8 448.41,-197.8 442.41,-197.8"></path>
<text text-anchor="middle" x="349" y="-175.6" font-family="Times,serif" font-size="14.00">Embedding pooling (into 1 vector)</text>
</g>
<!-- Document_Embedding_Model&#45;&gt;Document_Embedding_Pooling -->
<g id="edge4" class="edge">
<title>Document_Embedding_Model-&gt;Document_Embedding_Pooling</title>
<path fill="none" stroke="black" d="M349,-234.61C349,-226.59 349,-216.85 349,-207.87"></path>
<polygon fill="black" stroke="black" points="352.5,-207.83 349,-197.83 345.5,-207.83 352.5,-207.83"></polygon>
</g>
<!-- Document_Embedding_Pooling&#45;&gt;Cosine_Similarity_Search -->
<g id="edge6" class="edge">
<title>Document_Embedding_Pooling-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M326.28,-161.65C308.72,-148.4 284.22,-129.91 264.88,-115.31"></path>
<polygon fill="black" stroke="black" points="266.76,-112.34 256.67,-109.11 262.55,-117.93 266.76,-112.34"></polygon>
<text text-anchor="middle" x="359.9" y="-131.2" font-family="Times,serif" font-size="14.00">Vector DB goes here</text>
</g>
<!-- Results -->
<g id="node8" class="node">
<title>Results</title>
<path fill="#b2f3bb" stroke="black" d="M250.73,-36C250.73,-36 217.27,-36 217.27,-36 211.27,-36 205.27,-30 205.27,-24 205.27,-24 205.27,-12 205.27,-12 205.27,-6 211.27,0 217.27,0 217.27,0 250.73,0 250.73,0 256.73,0 262.73,-6 262.73,-12 262.73,-12 262.73,-24 262.73,-24 262.73,-30 256.73,-36 250.73,-36"></path>
<text text-anchor="middle" x="234" y="-13.8" font-family="Times,serif" font-size="14.00">Results</text>
</g>
<!-- Cosine_Similarity_Search&#45;&gt;Results -->
<g id="edge7" class="edge">
<title>Cosine_Similarity_Search-&gt;Results</title>
<path fill="none" stroke="black" d="M234,-72.81C234,-64.79 234,-55.05 234,-46.07"></path>
<polygon fill="black" stroke="black" points="237.5,-46.03 234,-36.03 230.5,-46.03 237.5,-46.03"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li><p><strong>Bi-Encoders: Separate Encoding for Queries and Documents</strong></p>
<ul>
<li>Encode documents and queries independently.</li>
<li>Pre-computed document representations allow for efficient inference, as only the query needs encoding at runtime.</li>
<li>Comes with retrieval performance tradeoffs</li>
</ul></li>
</ul>
</section>
<section id="improving-retrieval-with-re-ranking" class="level2">
<h2 class="anchored" data-anchor-id="improving-retrieval-with-re-ranking">Improving Retrieval with Re-ranking</h2>
<ul>
<li><strong>Bi-Encoder Limitations: Context Unawareness</strong>
<ul>
<li>Bi-encoders encode documents and queries separately, potentially missing nuanced relationships between them.</li>
</ul></li>
<li><strong>Cross-Encoders: Joint Encoding for Better Relevance Scoring</strong>
<ul>
<li>Encode query-document pairs together, allowing for a more context-aware relevance score.</li>
<li>Effectively a binary classifier
<ul>
<li>Uses the probability of being the positive class as the similarity score.</li>
</ul></li>
<li>Computationally expensive for large datasets.</li>
</ul></li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 406.00 244.80" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 240.8)">
<title>bi_encoder</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-240.8 402,-240.8 402,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M20,-8C20,-8 378,-8 378,-8 384,-8 390,-14 390,-20 390,-20 390,-216.8 390,-216.8 390,-222.8 384,-228.8 378,-228.8 378,-228.8 20,-228.8 20,-228.8 14,-228.8 8,-222.8 8,-216.8 8,-216.8 8,-20 8,-20 8,-14 14,-8 20,-8"></path>
<text text-anchor="middle" x="199" y="-212.2" font-family="Times,serif" font-size="14.00">Bi-Encoder</text>
</g>
<!-- Query -->
<g id="node1" class="node">
<title>Query</title>
<path fill="#a4d8ff" stroke="black" d="M310,-196C310,-196 280,-196 280,-196 274,-196 268,-190 268,-184 268,-184 268,-172 268,-172 268,-166 274,-160 280,-160 280,-160 310,-160 310,-160 316,-160 322,-166 322,-172 322,-172 322,-184 322,-184 322,-190 316,-196 310,-196"></path>
<text text-anchor="middle" x="295" y="-173.8" font-family="Times,serif" font-size="14.00">Query</text>
</g>
<!-- Query_Bi_Encoder -->
<g id="node3" class="node">
<title>Query_Bi_Encoder</title>
<path fill="#fddde6" stroke="black" d="M369.58,-124C369.58,-124 220.42,-124 220.42,-124 214.42,-124 208.42,-118 208.42,-112 208.42,-112 208.42,-100 208.42,-100 208.42,-94 214.42,-88 220.42,-88 220.42,-88 369.58,-88 369.58,-88 375.58,-88 381.58,-94 381.58,-100 381.58,-100 381.58,-112 381.58,-112 381.58,-118 375.58,-124 369.58,-124"></path>
<text text-anchor="middle" x="295" y="-101.8" font-family="Times,serif" font-size="14.00">Bi-Encoder (Embed + Pool)</text>
</g>
<!-- Query&#45;&gt;Query_Bi_Encoder -->
<g id="edge1" class="edge">
<title>Query-&gt;Query_Bi_Encoder</title>
<path fill="none" stroke="black" d="M295,-159.7C295,-151.98 295,-142.71 295,-134.11"></path>
<polygon fill="black" stroke="black" points="298.5,-134.1 295,-124.1 291.5,-134.1 298.5,-134.1"></polygon>
</g>
<!-- Documents -->
<g id="node2" class="node">
<title>Documents</title>
<path fill="#feec98" stroke="black" d="M130.77,-196C130.77,-196 75.23,-196 75.23,-196 69.23,-196 63.23,-190 63.23,-184 63.23,-184 63.23,-172 63.23,-172 63.23,-166 69.23,-160 75.23,-160 75.23,-160 130.77,-160 130.77,-160 136.77,-160 142.77,-166 142.77,-172 142.77,-172 142.77,-184 142.77,-184 142.77,-190 136.77,-196 130.77,-196"></path>
<text text-anchor="middle" x="103" y="-173.8" font-family="Times,serif" font-size="14.00">Documents</text>
</g>
<!-- Document_Bi_Encoder -->
<g id="node4" class="node">
<title>Document_Bi_Encoder</title>
<path fill="#fddde6" stroke="black" d="M177.58,-124C177.58,-124 28.42,-124 28.42,-124 22.42,-124 16.42,-118 16.42,-112 16.42,-112 16.42,-100 16.42,-100 16.42,-94 22.42,-88 28.42,-88 28.42,-88 177.58,-88 177.58,-88 183.58,-88 189.58,-94 189.58,-100 189.58,-100 189.58,-112 189.58,-112 189.58,-118 183.58,-124 177.58,-124"></path>
<text text-anchor="middle" x="103" y="-101.8" font-family="Times,serif" font-size="14.00">Bi-Encoder (Embed + Pool)</text>
</g>
<!-- Documents&#45;&gt;Document_Bi_Encoder -->
<g id="edge2" class="edge">
<title>Documents-&gt;Document_Bi_Encoder</title>
<path fill="none" stroke="black" d="M103,-159.7C103,-151.98 103,-142.71 103,-134.11"></path>
<polygon fill="black" stroke="black" points="106.5,-134.1 103,-124.1 99.5,-134.1 106.5,-134.1"></polygon>
</g>
<!-- Cosine_Similarity_Search -->
<g id="node5" class="node">
<title>Cosine_Similarity_Search</title>
<path fill="#b2f3bb" stroke="black" d="M262.8,-52C262.8,-52 135.2,-52 135.2,-52 129.2,-52 123.2,-46 123.2,-40 123.2,-40 123.2,-28 123.2,-28 123.2,-22 129.2,-16 135.2,-16 135.2,-16 262.8,-16 262.8,-16 268.8,-16 274.8,-22 274.8,-28 274.8,-28 274.8,-40 274.8,-40 274.8,-46 268.8,-52 262.8,-52"></path>
<text text-anchor="middle" x="199" y="-29.8" font-family="Times,serif" font-size="14.00">Cosine similarity search</text>
</g>
<!-- Query_Bi_Encoder&#45;&gt;Cosine_Similarity_Search -->
<g id="edge3" class="edge">
<title>Query_Bi_Encoder-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M271.27,-87.7C259.06,-78.8 244.01,-67.82 230.82,-58.2"></path>
<polygon fill="black" stroke="black" points="232.6,-55.17 222.46,-52.1 228.48,-60.82 232.6,-55.17"></polygon>
</g>
<!-- Document_Bi_Encoder&#45;&gt;Cosine_Similarity_Search -->
<g id="edge4" class="edge">
<title>Document_Bi_Encoder-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M126.73,-87.7C138.94,-78.8 153.99,-67.82 167.18,-58.2"></path>
<polygon fill="black" stroke="black" points="169.52,-60.82 175.54,-52.1 165.4,-55.17 169.52,-60.82"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 192.00 244.80" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 240.8)">
<title>cross_encoder</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-240.8 188,-240.8 188,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M20,-8C20,-8 164,-8 164,-8 170,-8 176,-14 176,-20 176,-20 176,-216.8 176,-216.8 176,-222.8 170,-228.8 164,-228.8 164,-228.8 20,-228.8 20,-228.8 14,-228.8 8,-222.8 8,-216.8 8,-216.8 8,-20 8,-20 8,-14 14,-8 20,-8"></path>
<text text-anchor="middle" x="92" y="-212.2" font-family="Times,serif" font-size="14.00">Cross-Encoder</text>
</g>
<!-- Query_2 -->
<g id="node1" class="node">
<title>Query_2</title>
<path fill="#a4d8ff" stroke="black" d="M156,-196C156,-196 126,-196 126,-196 120,-196 114,-190 114,-184 114,-184 114,-172 114,-172 114,-166 120,-160 126,-160 126,-160 156,-160 156,-160 162,-160 168,-166 168,-172 168,-172 168,-184 168,-184 168,-190 162,-196 156,-196"></path>
<text text-anchor="middle" x="141" y="-173.8" font-family="Times,serif" font-size="14.00">Query</text>
</g>
<!-- Cross_Encoder -->
<g id="node3" class="node">
<title>Cross_Encoder</title>
<path fill="#fed8a7" stroke="black" d="M129.7,-124C129.7,-124 54.3,-124 54.3,-124 48.3,-124 42.3,-118 42.3,-112 42.3,-112 42.3,-100 42.3,-100 42.3,-94 48.3,-88 54.3,-88 54.3,-88 129.7,-88 129.7,-88 135.7,-88 141.7,-94 141.7,-100 141.7,-100 141.7,-112 141.7,-112 141.7,-118 135.7,-124 129.7,-124"></path>
<text text-anchor="middle" x="92" y="-101.8" font-family="Times,serif" font-size="14.00">Cross-Encoder</text>
</g>
<!-- Query_2&#45;&gt;Cross_Encoder -->
<g id="edge1" class="edge">
<title>Query_2-&gt;Cross_Encoder</title>
<path fill="none" stroke="black" d="M128.89,-159.7C123.13,-151.47 116.14,-141.48 109.79,-132.42"></path>
<polygon fill="black" stroke="black" points="112.58,-130.29 103.97,-124.1 106.84,-134.3 112.58,-130.29"></polygon>
</g>
<!-- Documents_2 -->
<g id="node2" class="node">
<title>Documents_2</title>
<path fill="#feec98" stroke="black" d="M83.77,-196C83.77,-196 28.23,-196 28.23,-196 22.23,-196 16.23,-190 16.23,-184 16.23,-184 16.23,-172 16.23,-172 16.23,-166 22.23,-160 28.23,-160 28.23,-160 83.77,-160 83.77,-160 89.77,-160 95.77,-166 95.77,-172 95.77,-172 95.77,-184 95.77,-184 95.77,-190 89.77,-196 83.77,-196"></path>
<text text-anchor="middle" x="56" y="-173.8" font-family="Times,serif" font-size="14.00">Documents</text>
</g>
<!-- Documents_2&#45;&gt;Cross_Encoder -->
<g id="edge2" class="edge">
<title>Documents_2-&gt;Cross_Encoder</title>
<path fill="none" stroke="black" d="M64.9,-159.7C69,-151.73 73.95,-142.1 78.49,-133.26"></path>
<polygon fill="black" stroke="black" points="81.74,-134.6 83.2,-124.1 75.52,-131.4 81.74,-134.6"></polygon>
</g>
<!-- Similarity_Score -->
<g id="node4" class="node">
<title>Similarity_Score</title>
<path fill="#b2f3bb" stroke="black" d="M133.88,-52C133.88,-52 50.12,-52 50.12,-52 44.12,-52 38.12,-46 38.12,-40 38.12,-40 38.12,-28 38.12,-28 38.12,-22 44.12,-16 50.12,-16 50.12,-16 133.88,-16 133.88,-16 139.88,-16 145.88,-22 145.88,-28 145.88,-28 145.88,-40 145.88,-40 145.88,-46 139.88,-52 133.88,-52"></path>
<text text-anchor="middle" x="92" y="-29.8" font-family="Times,serif" font-size="14.00">Similarity Score</text>
</g>
<!-- Cross_Encoder&#45;&gt;Similarity_Score -->
<g id="edge3" class="edge">
<title>Cross_Encoder-&gt;Similarity_Score</title>
<path fill="none" stroke="black" d="M92,-87.7C92,-79.98 92,-70.71 92,-62.11"></path>
<polygon fill="black" stroke="black" points="95.5,-62.1 92,-52.1 88.5,-62.1 95.5,-62.1"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<ul>
<li><p><strong>Re-ranking in Practice: Addressing Computational Costs</strong></p>
<ul>
<li>Leverage a powerful but computationally expensive model (like cross-encoders) to score a subset of your documents, previously retrieved by more efficient model</li>
<li><strong>Examples of other re-ranking approaches:</strong>
<ul>
<li><strong><a href="https://github.com/sunnweiwei/RankGPT">RankGPT</a>:</strong> LLMs as Re-Ranking Agent</li>
<li><strong><a href="https://github.com/castorini/rank_llm">RankLLM</a>:</strong> Repository for prompt-decoding using LLMs</li>
</ul></li>
</ul></li>
<li><p><strong><a href="https://github.com/AnswerDotAI/rerankers">rerankers</a>:</strong> A lightweight unified API for various reranking models.</p></li>
</ul>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 406.00 372.80" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 368.8)">
<title>reranking</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-368.8 402,-368.8 402,4 -4,4"></polygon>
<text text-anchor="middle" x="199" y="-348.2" font-family="Times,serif" font-size="14.00">Compact Pipeline + Reranking</text>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M20,-208C20,-208 378,-208 378,-208 384,-208 390,-214 390,-220 390,-220 390,-248 390,-248 390,-254 384,-260 378,-260 378,-260 20,-260 20,-260 14,-260 8,-254 8,-248 8,-248 8,-220 8,-220 8,-214 14,-208 20,-208"></path>
</g>
<!-- Query -->
<g id="node1" class="node">
<title>Query</title>
<path fill="#a4d8ff" stroke="black" d="M118,-324C118,-324 88,-324 88,-324 82,-324 76,-318 76,-312 76,-312 76,-300 76,-300 76,-294 82,-288 88,-288 88,-288 118,-288 118,-288 124,-288 130,-294 130,-300 130,-300 130,-312 130,-312 130,-318 124,-324 118,-324"></path>
<text text-anchor="middle" x="103" y="-301.8" font-family="Times,serif" font-size="14.00">Query</text>
</g>
<!-- Query_Bi_Encoder -->
<g id="node3" class="node">
<title>Query_Bi_Encoder</title>
<path fill="#ffc9c9" stroke="black" d="M177.58,-252C177.58,-252 28.42,-252 28.42,-252 22.42,-252 16.42,-246 16.42,-240 16.42,-240 16.42,-228 16.42,-228 16.42,-222 22.42,-216 28.42,-216 28.42,-216 177.58,-216 177.58,-216 183.58,-216 189.58,-222 189.58,-228 189.58,-228 189.58,-240 189.58,-240 189.58,-246 183.58,-252 177.58,-252"></path>
<text text-anchor="middle" x="103" y="-229.8" font-family="Times,serif" font-size="14.00">Bi-Encoder (Embed + Pool)</text>
</g>
<!-- Query&#45;&gt;Query_Bi_Encoder -->
<g id="edge1" class="edge">
<title>Query-&gt;Query_Bi_Encoder</title>
<path fill="none" stroke="black" d="M103,-287.7C103,-279.98 103,-270.71 103,-262.11"></path>
<polygon fill="black" stroke="black" points="106.5,-262.1 103,-252.1 99.5,-262.1 106.5,-262.1"></polygon>
</g>
<!-- Documents -->
<g id="node2" class="node">
<title>Documents</title>
<path fill="#feec98" stroke="black" d="M322.77,-324C322.77,-324 267.23,-324 267.23,-324 261.23,-324 255.23,-318 255.23,-312 255.23,-312 255.23,-300 255.23,-300 255.23,-294 261.23,-288 267.23,-288 267.23,-288 322.77,-288 322.77,-288 328.77,-288 334.77,-294 334.77,-300 334.77,-300 334.77,-312 334.77,-312 334.77,-318 328.77,-324 322.77,-324"></path>
<text text-anchor="middle" x="295" y="-301.8" font-family="Times,serif" font-size="14.00">Documents</text>
</g>
<!-- Document_Bi_Encoder -->
<g id="node4" class="node">
<title>Document_Bi_Encoder</title>
<path fill="#ffc9c9" stroke="black" d="M369.58,-252C369.58,-252 220.42,-252 220.42,-252 214.42,-252 208.42,-246 208.42,-240 208.42,-240 208.42,-228 208.42,-228 208.42,-222 214.42,-216 220.42,-216 220.42,-216 369.58,-216 369.58,-216 375.58,-216 381.58,-222 381.58,-228 381.58,-228 381.58,-240 381.58,-240 381.58,-246 375.58,-252 369.58,-252"></path>
<text text-anchor="middle" x="295" y="-229.8" font-family="Times,serif" font-size="14.00">Bi-Encoder (Embed + Pool)</text>
</g>
<!-- Documents&#45;&gt;Document_Bi_Encoder -->
<g id="edge2" class="edge">
<title>Documents-&gt;Document_Bi_Encoder</title>
<path fill="none" stroke="black" d="M295,-287.7C295,-279.98 295,-270.71 295,-262.11"></path>
<polygon fill="black" stroke="black" points="298.5,-262.1 295,-252.1 291.5,-262.1 298.5,-262.1"></polygon>
</g>
<!-- Cosine_Similarity_Search -->
<g id="node5" class="node">
<title>Cosine_Similarity_Search</title>
<path fill="#b2f3bb" stroke="black" d="M262.8,-180C262.8,-180 135.2,-180 135.2,-180 129.2,-180 123.2,-174 123.2,-168 123.2,-168 123.2,-156 123.2,-156 123.2,-150 129.2,-144 135.2,-144 135.2,-144 262.8,-144 262.8,-144 268.8,-144 274.8,-150 274.8,-156 274.8,-156 274.8,-168 274.8,-168 274.8,-174 268.8,-180 262.8,-180"></path>
<text text-anchor="middle" x="199" y="-157.8" font-family="Times,serif" font-size="14.00">Cosine similarity search</text>
</g>
<!-- Query_Bi_Encoder&#45;&gt;Cosine_Similarity_Search -->
<g id="edge3" class="edge">
<title>Query_Bi_Encoder-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M126.73,-215.7C138.94,-206.8 153.99,-195.82 167.18,-186.2"></path>
<polygon fill="black" stroke="black" points="169.52,-188.82 175.54,-180.1 165.4,-183.17 169.52,-188.82"></polygon>
</g>
<!-- Document_Bi_Encoder&#45;&gt;Cosine_Similarity_Search -->
<g id="edge4" class="edge">
<title>Document_Bi_Encoder-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M271.27,-215.7C259.06,-206.8 244.01,-195.82 230.82,-186.2"></path>
<polygon fill="black" stroke="black" points="232.6,-183.17 222.46,-180.1 228.48,-188.82 232.6,-183.17"></polygon>
</g>
<!-- Reranking -->
<g id="node7" class="node">
<title>Reranking</title>
<path fill="#fed8a7" stroke="black" d="M224.32,-108C224.32,-108 173.68,-108 173.68,-108 167.68,-108 161.68,-102 161.68,-96 161.68,-96 161.68,-84 161.68,-84 161.68,-78 167.68,-72 173.68,-72 173.68,-72 224.32,-72 224.32,-72 230.32,-72 236.32,-78 236.32,-84 236.32,-84 236.32,-96 236.32,-96 236.32,-102 230.32,-108 224.32,-108"></path>
<text text-anchor="middle" x="199" y="-85.8" font-family="Times,serif" font-size="14.00">Reranking</text>
</g>
<!-- Cosine_Similarity_Search&#45;&gt;Reranking -->
<g id="edge5" class="edge">
<title>Cosine_Similarity_Search-&gt;Reranking</title>
<path fill="none" stroke="black" d="M199,-143.7C199,-135.98 199,-126.71 199,-118.11"></path>
<polygon fill="black" stroke="black" points="202.5,-118.1 199,-108.1 195.5,-118.1 202.5,-118.1"></polygon>
</g>
<!-- Results -->
<g id="node6" class="node">
<title>Results</title>
<path fill="#b2f3bb" stroke="black" d="M215.73,-36C215.73,-36 182.27,-36 182.27,-36 176.27,-36 170.27,-30 170.27,-24 170.27,-24 170.27,-12 170.27,-12 170.27,-6 176.27,0 182.27,0 182.27,0 215.73,0 215.73,0 221.73,0 227.73,-6 227.73,-12 227.73,-12 227.73,-24 227.73,-24 227.73,-30 221.73,-36 215.73,-36"></path>
<text text-anchor="middle" x="199" y="-13.8" font-family="Times,serif" font-size="14.00">Results</text>
</g>
<!-- Reranking&#45;&gt;Results -->
<g id="edge6" class="edge">
<title>Reranking-&gt;Results</title>
<path fill="none" stroke="black" d="M199,-71.7C199,-63.98 199,-54.71 199,-46.11"></path>
<polygon fill="black" stroke="black" points="202.5,-46.1 199,-36.1 195.5,-46.1 202.5,-46.1"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="keyword-search" class="level2">
<h2 class="anchored" data-anchor-id="keyword-search">Keyword Search</h2>
<ul>
<li><p>Also called “full-text search”</p></li>
<li><p><strong>Embeddings Are Not Enough: Lossy Compression and Jargon</strong></p>
<ul>
<li>Embeddings compress information, potentially losing details crucial for accurate retrieval, especially with domain-specific jargon and acronyms.</li>
</ul></li>
<li><p><strong>TF-IDF and BM25</strong></p>
<ul>
<li>Emphasizes the importance of incorporating traditional keyword search alongside embedding-based methods.</li>
<li><strong>TF-IDF (Term Frequency-Inverse Document Frequency)</strong>
<ul>
<li>Assigns a weight to words or groups of words based on their rarity</li>
<li><strong>Stanford IR Book:</strong> <a href="https://nlp.stanford.edu/IR-book/html/htmledition/inverse-document-frequency-1.html">Inverse document frequency</a></li>
</ul></li>
<li><strong>BM25 (Best-Matching 25)</strong>
<ul>
<li><strong>Wikipedia:</strong> <a href="https://en.wikipedia.org/wiki/Okapi_BM25">Okapi BM25</a></li>
<li><strong>Stanford IR Book:</strong> <a href="https://nlp.stanford.edu/IR-book/html/htmledition/okapi-bm25-a-non-binary-model-1.html">Okapi BM25: a non-binary model</a></li>
</ul></li>
</ul></li>
<li><p><strong>BM25 Performance and Relevance in Modern Pipelines</strong></p>
<ul>
<li>Highlights BM25’s continued relevance and effectiveness, often outperforming or complementing more complex methods.
<ul>
<li><div class="callout callout-style-default callout-note callout-titled" title="Results Table">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Results Table
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<div style="overflow-x:auto; max-height:500px">
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 4%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 9%">
</colgroup>
<thead>
<tr class="header">
<th>Model (→) Dataset (↓)</th>
<th>BM25</th>
<th>DeepCT</th>
<th>SPARTA</th>
<th>docT5query</th>
<th>DPR</th>
<th>ANCE</th>
<th>TAS-B</th>
<th>GenQ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MS MARCO</td>
<td>0.228</td>
<td>0.296‡</td>
<td>0.351‡</td>
<td>0.338‡</td>
<td>0.177</td>
<td>0.388‡</td>
<td>0.408‡</td>
<td>0.408‡</td>
</tr>
<tr class="even">
<td>TREC-COVID</td>
<td>0.656</td>
<td>0.406</td>
<td>0.538</td>
<td>0.713</td>
<td>0.332</td>
<td>0.654</td>
<td>0.481</td>
<td>0.619</td>
</tr>
<tr class="odd">
<td>BioASQ</td>
<td>0.465</td>
<td>0.407</td>
<td>0.351</td>
<td>0.431</td>
<td>0.127</td>
<td>0.306</td>
<td>0.383</td>
<td>0.398</td>
</tr>
<tr class="even">
<td>NFCorpus</td>
<td>0.325</td>
<td>0.283</td>
<td>0.301</td>
<td>0.328</td>
<td>0.189</td>
<td>0.237</td>
<td>0.319</td>
<td>0.319</td>
</tr>
<tr class="odd">
<td>NQ</td>
<td>0.329</td>
<td>0.188</td>
<td>0.398</td>
<td>0.399</td>
<td>0.474‡</td>
<td>0.446</td>
<td>0.463</td>
<td>0.358</td>
</tr>
<tr class="even">
<td>HotpotQA</td>
<td>0.603</td>
<td>0.503</td>
<td>0.492</td>
<td>0.580</td>
<td>0.391</td>
<td>0.456</td>
<td>0.584</td>
<td>0.534</td>
</tr>
<tr class="odd">
<td>FiQA-2018</td>
<td>0.236</td>
<td>0.191</td>
<td>0.198</td>
<td>0.291</td>
<td>0.112</td>
<td>0.295</td>
<td>0.300</td>
<td>0.308</td>
</tr>
<tr class="even">
<td>Signal-1M (RT)</td>
<td>0.330</td>
<td>0.269</td>
<td>0.252</td>
<td>0.307</td>
<td>0.155</td>
<td>0.249</td>
<td>0.289</td>
<td>0.281</td>
</tr>
<tr class="odd">
<td>TREC-NEWS</td>
<td>0.398</td>
<td>0.220</td>
<td>0.258</td>
<td>0.420</td>
<td>0.161</td>
<td>0.382</td>
<td>0.377</td>
<td>0.396</td>
</tr>
<tr class="even">
<td>Robust04</td>
<td>0.408</td>
<td>0.287</td>
<td>0.276</td>
<td>0.437</td>
<td>0.252</td>
<td>0.392</td>
<td>0.427</td>
<td>0.362</td>
</tr>
<tr class="odd">
<td>ArguAna</td>
<td>0.315</td>
<td>0.309</td>
<td>0.279</td>
<td>0.349</td>
<td>0.175</td>
<td>0.415</td>
<td>0.429</td>
<td>0.493</td>
</tr>
<tr class="even">
<td>Touché-2020</td>
<td>0.367</td>
<td>0.156</td>
<td>0.175</td>
<td>0.347</td>
<td>0.131</td>
<td>0.240</td>
<td>0.162</td>
<td>0.182</td>
</tr>
<tr class="odd">
<td>CQADupStack</td>
<td>0.299</td>
<td>0.268</td>
<td>0.257</td>
<td>0.325</td>
<td>0.153</td>
<td>0.296</td>
<td>0.314</td>
<td>0.347</td>
</tr>
<tr class="even">
<td>Quora</td>
<td>0.789</td>
<td>0.691</td>
<td>0.630</td>
<td>0.802</td>
<td>0.248</td>
<td>0.852</td>
<td>0.835</td>
<td>0.830</td>
</tr>
<tr class="odd">
<td>DBPedia</td>
<td>0.313</td>
<td>0.177</td>
<td>0.314</td>
<td>0.331</td>
<td>0.263</td>
<td>0.281</td>
<td>0.384</td>
<td>0.328</td>
</tr>
<tr class="even">
<td>SCIDOCS</td>
<td>0.158</td>
<td>0.124</td>
<td>0.126</td>
<td>0.162</td>
<td>0.077</td>
<td>0.122</td>
<td>0.149</td>
<td>0.143</td>
</tr>
<tr class="odd">
<td>FEVER</td>
<td>0.753</td>
<td>0.353</td>
<td>0.596</td>
<td>0.714</td>
<td>0.562</td>
<td>0.669</td>
<td>0.700</td>
<td>0.669</td>
</tr>
<tr class="even">
<td>Climate-FEVER</td>
<td>0.213</td>
<td>0.066</td>
<td>0.082</td>
<td>0.201</td>
<td>0.148</td>
<td>0.198</td>
<td>0.228</td>
<td>0.175</td>
</tr>
<tr class="odd">
<td>SciFact</td>
<td>0.665</td>
<td>0.630</td>
<td>0.582</td>
<td>0.675</td>
<td>0.318</td>
<td>0.507</td>
<td>0.643</td>
<td>0.644</td>
</tr>
<tr class="even">
<td><strong>Avg. Performance vs.&nbsp;BM25</strong></td>
<td></td>
<td><strong>- 27.9%</strong></td>
<td><strong>- 20.3%</strong></td>
<td><strong>+ 1.6%</strong></td>
<td><strong>- 47.7%</strong></td>
<td><strong>- 7.4%</strong></td>
<td><strong>- 2.8%</strong></td>
<td><strong>- 3.6%</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div></li>
<li><strong>Source:</strong> <a href="https://arxiv.org/abs/2104.08663">BEIR: A Heterogeneous Benchmark for Zero-shot Evaluation of Information Retrieval Models</a></li>
</ul></li>
<li>Especially powerful on longer documents and documents containing a lot of domain-specific jargon</li>
<li>Virtually unnoticeable inference-time compute overhead</li>
</ul></li>
</ul>
<section id="the-tf-idf-mvp" class="level3">
<h3 class="anchored" data-anchor-id="the-tf-idf-mvp">The TF-IDF MVP++</h3>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 760.00 404.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 400)">
<title>tfidf_mvp_plusplus</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-400 756,-400 756,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M20,-280C20,-280 378,-280 378,-280 384,-280 390,-286 390,-292 390,-292 390,-320 390,-320 390,-326 384,-332 378,-332 378,-332 20,-332 20,-332 14,-332 8,-326 8,-320 8,-320 8,-292 8,-292 8,-286 14,-280 20,-280"></path>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M410,-280C410,-280 732,-280 732,-280 738,-280 744,-286 744,-292 744,-292 744,-320 744,-320 744,-326 738,-332 732,-332 732,-332 410,-332 410,-332 404,-332 398,-326 398,-320 398,-320 398,-292 398,-292 398,-286 404,-280 410,-280"></path>
</g>
<!-- Query -->
<g id="node1" class="node">
<title>Query</title>
<path fill="#a4d8ff" stroke="black" d="M335,-396C335,-396 305,-396 305,-396 299,-396 293,-390 293,-384 293,-384 293,-372 293,-372 293,-366 299,-360 305,-360 305,-360 335,-360 335,-360 341,-360 347,-366 347,-372 347,-372 347,-384 347,-384 347,-390 341,-396 335,-396"></path>
<text text-anchor="middle" x="320" y="-373.8" font-family="Times,serif" font-size="14.00">Query</text>
</g>
<!-- Query_Bi_Encoder -->
<g id="node3" class="node">
<title>Query_Bi_Encoder</title>
<path fill="#ffc9c9" stroke="black" d="M177.58,-324C177.58,-324 28.42,-324 28.42,-324 22.42,-324 16.42,-318 16.42,-312 16.42,-312 16.42,-300 16.42,-300 16.42,-294 22.42,-288 28.42,-288 28.42,-288 177.58,-288 177.58,-288 183.58,-288 189.58,-294 189.58,-300 189.58,-300 189.58,-312 189.58,-312 189.58,-318 183.58,-324 177.58,-324"></path>
<text text-anchor="middle" x="103" y="-301.8" font-family="Times,serif" font-size="14.00">Bi-Encoder (Embed + Pool)</text>
</g>
<!-- Query&#45;&gt;Query_Bi_Encoder -->
<g id="edge1" class="edge">
<title>Query-&gt;Query_Bi_Encoder</title>
<path fill="none" stroke="black" d="M292.96,-368.28C261.23,-358.04 207.6,-340.74 165.41,-327.13"></path>
<polygon fill="black" stroke="black" points="166.36,-323.76 155.77,-324.02 164.21,-330.42 166.36,-323.76"></polygon>
</g>
<!-- Query_tfidf -->
<g id="node5" class="node">
<title>Query_tfidf</title>
<path fill="#cfbffe" stroke="black" d="M550.34,-324C550.34,-324 417.66,-324 417.66,-324 411.66,-324 405.66,-318 405.66,-312 405.66,-312 405.66,-300 405.66,-300 405.66,-294 411.66,-288 417.66,-288 417.66,-288 550.34,-288 550.34,-288 556.34,-288 562.34,-294 562.34,-300 562.34,-300 562.34,-312 562.34,-312 562.34,-318 556.34,-324 550.34,-324"></path>
<text text-anchor="middle" x="484" y="-301.8" font-family="Times,serif" font-size="14.00">tf-idf (weighted full text)</text>
</g>
<!-- Query&#45;&gt;Query_tfidf -->
<g id="edge3" class="edge">
<title>Query-&gt;Query_tfidf</title>
<path fill="none" stroke="black" d="M347.08,-365.44C370.79,-355.32 405.82,-340.37 434.52,-328.12"></path>
<polygon fill="black" stroke="black" points="436.16,-331.23 443.98,-324.08 433.41,-324.79 436.16,-331.23"></polygon>
</g>
<!-- Documents -->
<g id="node2" class="node">
<title>Documents</title>
<path fill="#feec98" stroke="black" d="M485.77,-396C485.77,-396 430.23,-396 430.23,-396 424.23,-396 418.23,-390 418.23,-384 418.23,-384 418.23,-372 418.23,-372 418.23,-366 424.23,-360 430.23,-360 430.23,-360 485.77,-360 485.77,-360 491.77,-360 497.77,-366 497.77,-372 497.77,-372 497.77,-384 497.77,-384 497.77,-390 491.77,-396 485.77,-396"></path>
<text text-anchor="middle" x="458" y="-373.8" font-family="Times,serif" font-size="14.00">Documents</text>
</g>
<!-- Document_Bi_Encoder -->
<g id="node4" class="node">
<title>Document_Bi_Encoder</title>
<path fill="#ffc9c9" stroke="black" d="M369.58,-324C369.58,-324 220.42,-324 220.42,-324 214.42,-324 208.42,-318 208.42,-312 208.42,-312 208.42,-300 208.42,-300 208.42,-294 214.42,-288 220.42,-288 220.42,-288 369.58,-288 369.58,-288 375.58,-288 381.58,-294 381.58,-300 381.58,-300 381.58,-312 381.58,-312 381.58,-318 375.58,-324 369.58,-324"></path>
<text text-anchor="middle" x="295" y="-301.8" font-family="Times,serif" font-size="14.00">Bi-Encoder (Embed + Pool)</text>
</g>
<!-- Documents&#45;&gt;Document_Bi_Encoder -->
<g id="edge2" class="edge">
<title>Documents-&gt;Document_Bi_Encoder</title>
<path fill="none" stroke="black" d="M418.13,-359.88C395.84,-350.31 367.88,-338.3 344.24,-328.15"></path>
<polygon fill="black" stroke="black" points="345.31,-324.8 334.74,-324.07 342.55,-331.23 345.31,-324.8"></polygon>
</g>
<!-- Document_tfidf -->
<g id="node6" class="node">
<title>Document_tfidf</title>
<path fill="#cfbffe" stroke="black" d="M724.34,-324C724.34,-324 591.66,-324 591.66,-324 585.66,-324 579.66,-318 579.66,-312 579.66,-312 579.66,-300 579.66,-300 579.66,-294 585.66,-288 591.66,-288 591.66,-288 724.34,-288 724.34,-288 730.34,-288 736.34,-294 736.34,-300 736.34,-300 736.34,-312 736.34,-312 736.34,-318 730.34,-324 724.34,-324"></path>
<text text-anchor="middle" x="658" y="-301.8" font-family="Times,serif" font-size="14.00">tf-idf (weighted full text)</text>
</g>
<!-- Documents&#45;&gt;Document_tfidf -->
<g id="edge4" class="edge">
<title>Documents-&gt;Document_tfidf</title>
<path fill="none" stroke="black" d="M497.99,-363C527.15,-352.8 567.1,-338.82 599.79,-327.37"></path>
<polygon fill="black" stroke="black" points="600.96,-330.67 609.24,-324.07 598.64,-324.07 600.96,-330.67"></polygon>
</g>
<!-- Cosine_Similarity_Search -->
<g id="node7" class="node">
<title>Cosine_Similarity_Search</title>
<path fill="#b2f3bb" stroke="black" d="M358.8,-252C358.8,-252 231.2,-252 231.2,-252 225.2,-252 219.2,-246 219.2,-240 219.2,-240 219.2,-228 219.2,-228 219.2,-222 225.2,-216 231.2,-216 231.2,-216 358.8,-216 358.8,-216 364.8,-216 370.8,-222 370.8,-228 370.8,-228 370.8,-240 370.8,-240 370.8,-246 364.8,-252 358.8,-252"></path>
<text text-anchor="middle" x="295" y="-229.8" font-family="Times,serif" font-size="14.00">Cosine similarity search</text>
</g>
<!-- Query_Bi_Encoder&#45;&gt;Cosine_Similarity_Search -->
<g id="edge5" class="edge">
<title>Query_Bi_Encoder-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M149.97,-287.88C176.68,-278.14 210.32,-265.87 238.47,-255.61"></path>
<polygon fill="black" stroke="black" points="239.99,-258.78 248.18,-252.07 237.59,-252.21 239.99,-258.78"></polygon>
</g>
<!-- Document_Bi_Encoder&#45;&gt;Cosine_Similarity_Search -->
<g id="edge6" class="edge">
<title>Document_Bi_Encoder-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M295,-287.7C295,-279.98 295,-270.71 295,-262.11"></path>
<polygon fill="black" stroke="black" points="298.5,-262.1 295,-252.1 291.5,-262.1 298.5,-262.1"></polygon>
</g>
<!-- BM25 -->
<g id="node10" class="node">
<title>BM25</title>
<path fill="#eebefa" stroke="black" d="M546.46,-252C546.46,-252 421.54,-252 421.54,-252 415.54,-252 409.54,-246 409.54,-240 409.54,-240 409.54,-228 409.54,-228 409.54,-222 415.54,-216 421.54,-216 421.54,-216 546.46,-216 546.46,-216 552.46,-216 558.46,-222 558.46,-228 558.46,-228 558.46,-240 558.46,-240 558.46,-246 552.46,-252 546.46,-252"></path>
<text text-anchor="middle" x="484" y="-229.8" font-family="Times,serif" font-size="14.00">BM25 (full-text) search</text>
</g>
<!-- Query_tfidf&#45;&gt;BM25 -->
<g id="edge8" class="edge">
<title>Query_tfidf-&gt;BM25</title>
<path fill="none" stroke="black" d="M484,-287.7C484,-279.98 484,-270.71 484,-262.11"></path>
<polygon fill="black" stroke="black" points="487.5,-262.1 484,-252.1 480.5,-262.1 487.5,-262.1"></polygon>
</g>
<!-- Document_tfidf&#45;&gt;BM25 -->
<g id="edge9" class="edge">
<title>Document_tfidf-&gt;BM25</title>
<path fill="none" stroke="black" d="M615.43,-287.88C591.44,-278.22 561.27,-266.09 535.9,-255.88"></path>
<polygon fill="black" stroke="black" points="537.01,-252.55 526.43,-252.07 534.4,-259.05 537.01,-252.55"></polygon>
</g>
<!-- Combine_Scores -->
<g id="node11" class="node">
<title>Combine_Scores</title>
<path fill="#95f2d7" stroke="black" d="M440.42,-180C440.42,-180 337.58,-180 337.58,-180 331.58,-180 325.58,-174 325.58,-168 325.58,-168 325.58,-156 325.58,-156 325.58,-150 331.58,-144 337.58,-144 337.58,-144 440.42,-144 440.42,-144 446.42,-144 452.42,-150 452.42,-156 452.42,-156 452.42,-168 452.42,-168 452.42,-174 446.42,-180 440.42,-180"></path>
<text text-anchor="middle" x="389" y="-157.8" font-family="Times,serif" font-size="14.00">Combine the scores</text>
</g>
<!-- Cosine_Similarity_Search&#45;&gt;Combine_Scores -->
<g id="edge11" class="edge">
<title>Cosine_Similarity_Search-&gt;Combine_Scores</title>
<path fill="none" stroke="black" d="M318.24,-215.7C330.19,-206.8 344.92,-195.82 357.85,-186.2"></path>
<polygon fill="black" stroke="black" points="360.1,-188.88 366.03,-180.1 355.92,-183.27 360.1,-188.88"></polygon>
</g>
<!-- Results -->
<g id="node8" class="node">
<title>Results</title>
<path fill="#b2f3bb" stroke="black" d="M405.73,-36C405.73,-36 372.27,-36 372.27,-36 366.27,-36 360.27,-30 360.27,-24 360.27,-24 360.27,-12 360.27,-12 360.27,-6 366.27,0 372.27,0 372.27,0 405.73,0 405.73,0 411.73,0 417.73,-6 417.73,-12 417.73,-12 417.73,-24 417.73,-24 417.73,-30 411.73,-36 405.73,-36"></path>
<text text-anchor="middle" x="389" y="-13.8" font-family="Times,serif" font-size="14.00">Results</text>
</g>
<!-- Reranking -->
<g id="node9" class="node">
<title>Reranking</title>
<path fill="#fed8a7" stroke="black" d="M414.32,-108C414.32,-108 363.68,-108 363.68,-108 357.68,-108 351.68,-102 351.68,-96 351.68,-96 351.68,-84 351.68,-84 351.68,-78 357.68,-72 363.68,-72 363.68,-72 414.32,-72 414.32,-72 420.32,-72 426.32,-78 426.32,-84 426.32,-84 426.32,-96 426.32,-96 426.32,-102 420.32,-108 414.32,-108"></path>
<text text-anchor="middle" x="389" y="-85.8" font-family="Times,serif" font-size="14.00">Reranking</text>
</g>
<!-- Reranking&#45;&gt;Results -->
<g id="edge7" class="edge">
<title>Reranking-&gt;Results</title>
<path fill="none" stroke="black" d="M389,-71.7C389,-63.98 389,-54.71 389,-46.11"></path>
<polygon fill="black" stroke="black" points="392.5,-46.1 389,-36.1 385.5,-46.1 392.5,-46.1"></polygon>
</g>
<!-- BM25&#45;&gt;Combine_Scores -->
<g id="edge10" class="edge">
<title>BM25-&gt;Combine_Scores</title>
<path fill="none" stroke="black" d="M460.52,-215.7C448.44,-206.8 433.55,-195.82 420.48,-186.2"></path>
<polygon fill="black" stroke="black" points="422.34,-183.22 412.21,-180.1 418.19,-188.85 422.34,-183.22"></polygon>
</g>
<!-- Combine_Scores&#45;&gt;Reranking -->
<g id="edge12" class="edge">
<title>Combine_Scores-&gt;Reranking</title>
<path fill="none" stroke="black" d="M389,-143.7C389,-135.98 389,-126.71 389,-118.11"></path>
<polygon fill="black" stroke="black" points="392.5,-118.1 389,-108.1 385.5,-118.1 392.5,-118.1"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
</section>
<section id="leveraging-metadata-for-targeted-retrieval" class="level2">
<h2 class="anchored" data-anchor-id="leveraging-metadata-for-targeted-retrieval">Leveraging Metadata for Targeted Retrieval</h2>
<ul>
<li><strong>Real-World Data Has Context: Metadata Matters</strong>
<ul>
<li>Real-world documents often possess valuable metadata (e.g., author, date, department) that can significantly improve retrieval accuracy.</li>
<li>Pure Semantic or Keyword Search can struggle with metadata
<ul>
<li><strong>Example Query:</strong> “Can you get me the cruise division financial report for Q4 2022?”
<ul>
<li>Model must accurately represent all of “ﬁnancial report”, “cruise division”, “Q4” and “2022”, into a single vector
<ul>
<li>Otherwise it will fetch documents that look relevant but aren’t meeting one or more of those criteria.</li>
</ul></li>
<li>If the number of documents you search for (“k”) is set too high, you will be passing irrelevant ﬁnancial reports to your LLM</li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Entity Detection and Metadata Filtering: A Practical Example</strong>
<ul>
<li>Use entity detection models like GLiNER to automatically extract relevant metadata (e.g., document type, time period, department).</li>
<li><strong>GLiNER</strong>
<ul>
<li><strong>Paper:</strong> <a href="https://arxiv.org/abs/2311.08526">GLiNER: Generalist Model for Named Entity Recognition using Bidirectional Transformer</a></li>
<li><strong>GitHub Repository:</strong> <a href="https://github.com/urchade/GLiNER">GLiNER</a></li>
<li><strong>:hugs: Spaces Demo:</strong> <a href="https://huggingface.co/spaces/tomaarsen/gliner_medium-v2.1">GLiNER-medium-v2.1, zero-shot NER</a></li>
</ul></li>
<li>Filter documents based on extracted metadata to ensure relevance and reduce noise.</li>
</ul></li>
<li><strong>Storing and Using Metadata for Pre-filtering</strong>
<ul>
<li>Store metadata alongside documents in the database.</li>
<li>During retrieval, pre-filter documents based on query-specific metadata to narrow down the search space.</li>
</ul></li>
</ul>
</section>
<section id="putting-it-all-together-the-complete-mvp-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-all-together-the-complete-mvp-pipeline">Putting it All Together: The Complete MVP++ Pipeline</h2>
<section id="the-final-compact-mvp" class="level3">
<h3 class="anchored" data-anchor-id="the-final-compact-mvp">The Final Compact MVP++</h3>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 760.00 476.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 472)">
<title>tfidf_mvp_plusplus</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-472 756,-472 756,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M20,-352C20,-352 378,-352 378,-352 384,-352 390,-358 390,-364 390,-364 390,-392 390,-392 390,-398 384,-404 378,-404 378,-404 20,-404 20,-404 14,-404 8,-398 8,-392 8,-392 8,-364 8,-364 8,-358 14,-352 20,-352"></path>
</g>
<g id="clust2" class="cluster">
<title>cluster_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M410,-352C410,-352 732,-352 732,-352 738,-352 744,-358 744,-364 744,-364 744,-392 744,-392 744,-398 738,-404 732,-404 732,-404 410,-404 410,-404 404,-404 398,-398 398,-392 398,-392 398,-364 398,-364 398,-358 404,-352 410,-352"></path>
</g>
<!-- Query -->
<g id="node1" class="node">
<title>Query</title>
<path fill="#a4d8ff" stroke="black" d="M335,-468C335,-468 305,-468 305,-468 299,-468 293,-462 293,-456 293,-456 293,-444 293,-444 293,-438 299,-432 305,-432 305,-432 335,-432 335,-432 341,-432 347,-438 347,-444 347,-444 347,-456 347,-456 347,-462 341,-468 335,-468"></path>
<text text-anchor="middle" x="320" y="-445.8" font-family="Times,serif" font-size="14.00">Query</text>
</g>
<!-- Query_Bi_Encoder -->
<g id="node3" class="node">
<title>Query_Bi_Encoder</title>
<path fill="#ffc9c9" stroke="black" d="M177.58,-396C177.58,-396 28.42,-396 28.42,-396 22.42,-396 16.42,-390 16.42,-384 16.42,-384 16.42,-372 16.42,-372 16.42,-366 22.42,-360 28.42,-360 28.42,-360 177.58,-360 177.58,-360 183.58,-360 189.58,-366 189.58,-372 189.58,-372 189.58,-384 189.58,-384 189.58,-390 183.58,-396 177.58,-396"></path>
<text text-anchor="middle" x="103" y="-373.8" font-family="Times,serif" font-size="14.00">Bi-Encoder (Embed + Pool)</text>
</g>
<!-- Query&#45;&gt;Query_Bi_Encoder -->
<g id="edge1" class="edge">
<title>Query-&gt;Query_Bi_Encoder</title>
<path fill="none" stroke="black" d="M292.96,-440.28C261.23,-430.04 207.6,-412.74 165.41,-399.13"></path>
<polygon fill="black" stroke="black" points="166.36,-395.76 155.77,-396.02 164.21,-402.42 166.36,-395.76"></polygon>
</g>
<!-- Query_tfidf -->
<g id="node5" class="node">
<title>Query_tfidf</title>
<path fill="#cfbffe" stroke="black" d="M550.34,-396C550.34,-396 417.66,-396 417.66,-396 411.66,-396 405.66,-390 405.66,-384 405.66,-384 405.66,-372 405.66,-372 405.66,-366 411.66,-360 417.66,-360 417.66,-360 550.34,-360 550.34,-360 556.34,-360 562.34,-366 562.34,-372 562.34,-372 562.34,-384 562.34,-384 562.34,-390 556.34,-396 550.34,-396"></path>
<text text-anchor="middle" x="484" y="-373.8" font-family="Times,serif" font-size="14.00">tf-idf (weighted full text)</text>
</g>
<!-- Query&#45;&gt;Query_tfidf -->
<g id="edge3" class="edge">
<title>Query-&gt;Query_tfidf</title>
<path fill="none" stroke="black" d="M347.08,-437.44C370.79,-427.32 405.82,-412.37 434.52,-400.12"></path>
<polygon fill="black" stroke="black" points="436.16,-403.23 443.98,-396.08 433.41,-396.79 436.16,-403.23"></polygon>
</g>
<!-- Documents -->
<g id="node2" class="node">
<title>Documents</title>
<path fill="#feec98" stroke="black" d="M485.77,-468C485.77,-468 430.23,-468 430.23,-468 424.23,-468 418.23,-462 418.23,-456 418.23,-456 418.23,-444 418.23,-444 418.23,-438 424.23,-432 430.23,-432 430.23,-432 485.77,-432 485.77,-432 491.77,-432 497.77,-438 497.77,-444 497.77,-444 497.77,-456 497.77,-456 497.77,-462 491.77,-468 485.77,-468"></path>
<text text-anchor="middle" x="458" y="-445.8" font-family="Times,serif" font-size="14.00">Documents</text>
</g>
<!-- Document_Bi_Encoder -->
<g id="node4" class="node">
<title>Document_Bi_Encoder</title>
<path fill="#ffc9c9" stroke="black" d="M369.58,-396C369.58,-396 220.42,-396 220.42,-396 214.42,-396 208.42,-390 208.42,-384 208.42,-384 208.42,-372 208.42,-372 208.42,-366 214.42,-360 220.42,-360 220.42,-360 369.58,-360 369.58,-360 375.58,-360 381.58,-366 381.58,-372 381.58,-372 381.58,-384 381.58,-384 381.58,-390 375.58,-396 369.58,-396"></path>
<text text-anchor="middle" x="295" y="-373.8" font-family="Times,serif" font-size="14.00">Bi-Encoder (Embed + Pool)</text>
</g>
<!-- Documents&#45;&gt;Document_Bi_Encoder -->
<g id="edge2" class="edge">
<title>Documents-&gt;Document_Bi_Encoder</title>
<path fill="none" stroke="black" d="M418.13,-431.88C395.84,-422.31 367.88,-410.3 344.24,-400.15"></path>
<polygon fill="black" stroke="black" points="345.31,-396.8 334.74,-396.07 342.55,-403.23 345.31,-396.8"></polygon>
</g>
<!-- Document_tfidf -->
<g id="node6" class="node">
<title>Document_tfidf</title>
<path fill="#cfbffe" stroke="black" d="M724.34,-396C724.34,-396 591.66,-396 591.66,-396 585.66,-396 579.66,-390 579.66,-384 579.66,-384 579.66,-372 579.66,-372 579.66,-366 585.66,-360 591.66,-360 591.66,-360 724.34,-360 724.34,-360 730.34,-360 736.34,-366 736.34,-372 736.34,-372 736.34,-384 736.34,-384 736.34,-390 730.34,-396 724.34,-396"></path>
<text text-anchor="middle" x="658" y="-373.8" font-family="Times,serif" font-size="14.00">tf-idf (weighted full text)</text>
</g>
<!-- Documents&#45;&gt;Document_tfidf -->
<g id="edge4" class="edge">
<title>Documents-&gt;Document_tfidf</title>
<path fill="none" stroke="black" d="M497.99,-435C527.15,-424.8 567.1,-410.82 599.79,-399.37"></path>
<polygon fill="black" stroke="black" points="600.96,-402.67 609.24,-396.07 598.64,-396.07 600.96,-402.67"></polygon>
</g>
<!-- Cosine_Similarity_Search -->
<g id="node9" class="node">
<title>Cosine_Similarity_Search</title>
<path fill="#b2f3bb" stroke="black" d="M358.8,-252C358.8,-252 231.2,-252 231.2,-252 225.2,-252 219.2,-246 219.2,-240 219.2,-240 219.2,-228 219.2,-228 219.2,-222 225.2,-216 231.2,-216 231.2,-216 358.8,-216 358.8,-216 364.8,-216 370.8,-222 370.8,-228 370.8,-228 370.8,-240 370.8,-240 370.8,-246 364.8,-252 358.8,-252"></path>
<text text-anchor="middle" x="295" y="-229.8" font-family="Times,serif" font-size="14.00">Cosine similarity search</text>
</g>
<!-- Query_Bi_Encoder&#45;&gt;Cosine_Similarity_Search -->
<g id="edge7" class="edge">
<title>Query_Bi_Encoder-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M118.05,-359.77C135.33,-340.66 165.15,-309.68 195,-288 211.23,-276.21 230.42,-265.4 247.63,-256.65"></path>
<polygon fill="black" stroke="black" points="249.56,-259.6 256.95,-252.02 246.44,-253.34 249.56,-259.6"></polygon>
</g>
<!-- Metadata_Filtering -->
<g id="node7" class="node">
<title>Metadata_Filtering</title>
<path fill="#d2bab0" stroke="black" d="M373.62,-324C373.62,-324 216.38,-324 216.38,-324 210.38,-324 204.38,-318 204.38,-312 204.38,-312 204.38,-300 204.38,-300 204.38,-294 210.38,-288 216.38,-288 216.38,-288 373.62,-288 373.62,-288 379.62,-288 385.62,-294 385.62,-300 385.62,-300 385.62,-312 385.62,-312 385.62,-318 379.62,-324 373.62,-324"></path>
<text text-anchor="middle" x="295" y="-301.8" font-family="Times,serif" font-size="14.00">Metadata Document Filtering</text>
</g>
<!-- Document_Bi_Encoder&#45;&gt;Metadata_Filtering -->
<g id="edge5" class="edge">
<title>Document_Bi_Encoder-&gt;Metadata_Filtering</title>
<path fill="none" stroke="black" d="M295,-359.7C295,-351.98 295,-342.71 295,-334.11"></path>
<polygon fill="black" stroke="black" points="298.5,-334.1 295,-324.1 291.5,-334.1 298.5,-334.1"></polygon>
</g>
<!-- BM25 -->
<g id="node12" class="node">
<title>BM25</title>
<path fill="#eebefa" stroke="black" d="M546.46,-252C546.46,-252 421.54,-252 421.54,-252 415.54,-252 409.54,-246 409.54,-240 409.54,-240 409.54,-228 409.54,-228 409.54,-222 415.54,-216 421.54,-216 421.54,-216 546.46,-216 546.46,-216 552.46,-216 558.46,-222 558.46,-228 558.46,-228 558.46,-240 558.46,-240 558.46,-246 552.46,-252 546.46,-252"></path>
<text text-anchor="middle" x="484" y="-229.8" font-family="Times,serif" font-size="14.00">BM25 (full-text) search</text>
</g>
<!-- Query_tfidf&#45;&gt;BM25 -->
<g id="edge10" class="edge">
<title>Query_tfidf-&gt;BM25</title>
<path fill="none" stroke="black" d="M484,-359.87C484,-335.67 484,-291.21 484,-262.39"></path>
<polygon fill="black" stroke="black" points="487.5,-262.19 484,-252.19 480.5,-262.19 487.5,-262.19"></polygon>
</g>
<!-- Metadata_Filtering_2 -->
<g id="node8" class="node">
<title>Metadata_Filtering_2</title>
<path fill="#d2bab0" stroke="black" d="M708.62,-324C708.62,-324 551.38,-324 551.38,-324 545.38,-324 539.38,-318 539.38,-312 539.38,-312 539.38,-300 539.38,-300 539.38,-294 545.38,-288 551.38,-288 551.38,-288 708.62,-288 708.62,-288 714.62,-288 720.62,-294 720.62,-300 720.62,-300 720.62,-312 720.62,-312 720.62,-318 714.62,-324 708.62,-324"></path>
<text text-anchor="middle" x="630" y="-301.8" font-family="Times,serif" font-size="14.00">Metadata Document Filtering</text>
</g>
<!-- Document_tfidf&#45;&gt;Metadata_Filtering_2 -->
<g id="edge6" class="edge">
<title>Document_tfidf-&gt;Metadata_Filtering_2</title>
<path fill="none" stroke="black" d="M651.08,-359.7C647.93,-351.81 644.12,-342.3 640.62,-333.55"></path>
<polygon fill="black" stroke="black" points="643.81,-332.09 636.84,-324.1 637.31,-334.69 643.81,-332.09"></polygon>
</g>
<!-- Metadata_Filtering&#45;&gt;Cosine_Similarity_Search -->
<g id="edge8" class="edge">
<title>Metadata_Filtering-&gt;Cosine_Similarity_Search</title>
<path fill="none" stroke="black" d="M295,-287.7C295,-279.98 295,-270.71 295,-262.11"></path>
<polygon fill="black" stroke="black" points="298.5,-262.1 295,-252.1 291.5,-262.1 298.5,-262.1"></polygon>
</g>
<!-- Metadata_Filtering_2&#45;&gt;BM25 -->
<g id="edge11" class="edge">
<title>Metadata_Filtering_2-&gt;BM25</title>
<path fill="none" stroke="black" d="M594.28,-287.88C574.5,-278.39 549.73,-266.51 528.67,-256.42"></path>
<polygon fill="black" stroke="black" points="530.13,-253.24 519.6,-252.07 527.1,-259.55 530.13,-253.24"></polygon>
</g>
<!-- Combine_Scores -->
<g id="node13" class="node">
<title>Combine_Scores</title>
<path fill="#95f2d7" stroke="black" d="M440.42,-180C440.42,-180 337.58,-180 337.58,-180 331.58,-180 325.58,-174 325.58,-168 325.58,-168 325.58,-156 325.58,-156 325.58,-150 331.58,-144 337.58,-144 337.58,-144 440.42,-144 440.42,-144 446.42,-144 452.42,-150 452.42,-156 452.42,-156 452.42,-168 452.42,-168 452.42,-174 446.42,-180 440.42,-180"></path>
<text text-anchor="middle" x="389" y="-157.8" font-family="Times,serif" font-size="14.00">Combine the scores</text>
</g>
<!-- Cosine_Similarity_Search&#45;&gt;Combine_Scores -->
<g id="edge13" class="edge">
<title>Cosine_Similarity_Search-&gt;Combine_Scores</title>
<path fill="none" stroke="black" d="M318.24,-215.7C330.19,-206.8 344.92,-195.82 357.85,-186.2"></path>
<polygon fill="black" stroke="black" points="360.1,-188.88 366.03,-180.1 355.92,-183.27 360.1,-188.88"></polygon>
</g>
<!-- Results -->
<g id="node10" class="node">
<title>Results</title>
<path fill="#b2f3bb" stroke="black" d="M405.73,-36C405.73,-36 372.27,-36 372.27,-36 366.27,-36 360.27,-30 360.27,-24 360.27,-24 360.27,-12 360.27,-12 360.27,-6 366.27,0 372.27,0 372.27,0 405.73,0 405.73,0 411.73,0 417.73,-6 417.73,-12 417.73,-12 417.73,-24 417.73,-24 417.73,-30 411.73,-36 405.73,-36"></path>
<text text-anchor="middle" x="389" y="-13.8" font-family="Times,serif" font-size="14.00">Results</text>
</g>
<!-- Reranking -->
<g id="node11" class="node">
<title>Reranking</title>
<path fill="#fed8a7" stroke="black" d="M414.32,-108C414.32,-108 363.68,-108 363.68,-108 357.68,-108 351.68,-102 351.68,-96 351.68,-96 351.68,-84 351.68,-84 351.68,-78 357.68,-72 363.68,-72 363.68,-72 414.32,-72 414.32,-72 420.32,-72 426.32,-78 426.32,-84 426.32,-84 426.32,-96 426.32,-96 426.32,-102 420.32,-108 414.32,-108"></path>
<text text-anchor="middle" x="389" y="-85.8" font-family="Times,serif" font-size="14.00">Reranking</text>
</g>
<!-- Reranking&#45;&gt;Results -->
<g id="edge9" class="edge">
<title>Reranking-&gt;Results</title>
<path fill="none" stroke="black" d="M389,-71.7C389,-63.98 389,-54.71 389,-46.11"></path>
<polygon fill="black" stroke="black" points="392.5,-46.1 389,-36.1 385.5,-46.1 392.5,-46.1"></polygon>
</g>
<!-- BM25&#45;&gt;Combine_Scores -->
<g id="edge12" class="edge">
<title>BM25-&gt;Combine_Scores</title>
<path fill="none" stroke="black" d="M460.52,-215.7C448.44,-206.8 433.55,-195.82 420.48,-186.2"></path>
<polygon fill="black" stroke="black" points="422.34,-183.22 412.21,-180.1 418.19,-188.85 422.34,-183.22"></polygon>
</g>
<!-- Combine_Scores&#45;&gt;Reranking -->
<g id="edge14" class="edge">
<title>Combine_Scores-&gt;Reranking</title>
<path fill="none" stroke="black" d="M389,-143.7C389,-135.98 389,-126.71 389,-118.11"></path>
<polygon fill="black" stroke="black" points="392.5,-118.1 389,-108.1 385.5,-118.1 392.5,-118.1"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="code-example-implementing-the-mvp-with-lancedb" class="level3">
<h3 class="anchored" data-anchor-id="code-example-implementing-the-mvp-with-lancedb">Code Example: Implementing the MVP++ with LanceDB</h3>
<ul>
<li>Uses LanceDB for its ease of use and built-in components.</li>
<li><strong>Vector Databases</strong>
<ul>
<li><a href="https://lancedb.com/">LanceDB</a></li>
<li><a href="https://weaviate.io/">Weaviate</a></li>
<li><a href="https://www.trychroma.com/">Chroma</a></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch some text content in two different categories</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> wikipediaapi <span class="im">import</span> Wikipedia</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>wiki <span class="op">=</span> Wikipedia(<span class="st">'RAGBot/0.0'</span>, <span class="st">'en'</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>docs <span class="op">=</span> [{<span class="st">"text"</span>: x,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">"category"</span>: <span class="st">"person"</span>}</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> x <span class="kw">in</span> wiki.page(<span class="st">'Hayao_Miyazaki'</span>).text.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>docs <span class="op">+=</span> [{<span class="st">"text"</span>: x,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">"category"</span>: <span class="st">"film"</span>}</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> x <span class="kw">in</span> wiki.page(<span class="st">'Spirited_Away'</span>).text.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Enter LanceDB</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lancedb</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb.pydantic <span class="im">import</span> LanceModel, Vector</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb.embedding <span class="im">import</span> get_registry</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialise the embedding model</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>model_registry <span class="op">=</span> get_registry().get(<span class="st">"sentence-transformers"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> model_registry.create(name<span class="op">=</span><span class="st">"BAAI/bge-small-en-v1.5"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Model to store attributes for filtering</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Document(LanceModel):                    </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    text: <span class="bu">str</span> <span class="op">=</span> model.SourceField()</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    vector: Vector(<span class="dv">384</span>) <span class="op">=</span> model.VectorField()</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    category: <span class="bu">str</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> lancedb.<span class="ex">connect</span>(<span class="st">".my_db"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>tbl <span class="op">=</span> db.create_table(<span class="st">"my_table"</span>, schema<span class="op">=</span>Document)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Embed the documents and store them in the database</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>tbl.add(docs)                                        </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the full-text (tf-idf) search index</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>tbl.create_fts_index(<span class="st">"text"</span>)                         </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialise a reranker -- here, Cohere's API one</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> lancedb.rerankers <span class="im">import</span> CohereReranker</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>reranker <span class="op">=</span> CohereReranker()                        </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"What is Chihiro's new name given to her by the witch?"</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> (tbl.search(query, query_type<span class="op">=</span><span class="st">"hybrid"</span>) <span class="co"># Hybrid means text + vector</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>           .where(<span class="st">"category = 'film'"</span>, prefilter<span class="op">=</span><span class="va">True</span>) <span class="co"># Restrict to only docs in the 'film' category</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>           .limit(<span class="dv">10</span>) <span class="co"># Get 10 results from first-pass retrieval</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>           .rerank(reranker<span class="op">=</span>reranker) <span class="co"># For the reranker to compute the final ranking</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>          )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="beyond-the-basics-future-exploration-and-resources" class="level2">
<h2 class="anchored" data-anchor-id="beyond-the-basics-future-exploration-and-resources">Beyond the Basics: Future Exploration and Resources</h2>
<ul>
<li><strong><a href="https://github.com/AnswerDotAI/RAGatouille">RAGatouille</a>:</strong> Easily use and train state of the art late-interaction retrieval methods (ColBERT) in any RAG pipeline.</li>
<li><strong><a href="https://github.com/AnswerDotAI/rerankers">rerankers</a>:</strong> A lightweight unified API for various reranking models.</li>
<li><strong>Video Tutorial:</strong> <a href="https://www.youtube.com/watch?v=jkrNMKz9pWU">A Hackers’ Guide to Language Models</a></li>
<li><strong>ColBERT</strong>
<ul>
<li><strong>Paper:</strong> <a href="https://arxiv.org/abs/2004.12832">ColBERT: Efficient and Effective Passage Search via Contextualized Late Interaction over BERT</a></li>
<li><strong>HuggingFace Hub:</strong> <a href="https://huggingface.co/colbert-ir/colbertv2.0">colbert-ir/colbertv2.0</a></li>
</ul></li>
<li><strong>Sparse Vectors:</strong> <a href="https://docs.pinecone.io/guides/data/understanding-hybrid-search">Understanding hybrid search</a></li>
<li><strong>Multi-vector Retrievers:</strong> <a href="https://blog.langchain.dev/semi-structured-multi-modal-rag/">Multi-Vector Retriever for RAG on tables, text, and images</a></li>
</ul>
</section>
<section id="qa-session" class="level2">
<h2 class="anchored" data-anchor-id="qa-session">Q&amp;A Session</h2>
<section id="fine-tuning-bi-encoders-and-cross-encoders" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning-bi-encoders-and-cross-encoders">Fine-tuning Bi-Encoders and Cross-Encoders</h3>
<ul>
<li><p><strong>Q:</strong> Does the fine-tuning approach for bi-encoder models impact the fine-tuning of cross-encoder models and vice versa?</p></li>
<li><p><strong>A:</strong> While domain-specific, generally aim for complementarity. Fine-tune bi-encoders for broader retrieval, capturing potential candidates. Rely on cross-encoders (re-rankers) for precise filtering and ranking.</p></li>
</ul>
</section>
<section id="combining-bi-encoder-and-tf-idf-scores" class="level3">
<h3 class="anchored" data-anchor-id="combining-bi-encoder-and-tf-idf-scores">Combining Bi-Encoder and TF-IDF Scores</h3>
<ul>
<li><p><strong>Q:</strong> What are the advantages and disadvantages of using a weighted average of bi-encoder and TF-IDF scores for selecting re-ranker questions compared to taking the top X from each ranker?</p></li>
<li><p><strong>A:</strong> Both methods are valid and depend on the data. Weighted averages can be effective, but in domains like biomedicine, where document specificity is crucial, taking the top X from both ensures representation for potentially poorly embedded queries.</p></li>
</ul>
</section>
<section id="rags-future-with-million-token-context-lengths" class="level3">
<h3 class="anchored" data-anchor-id="rags-future-with-million-token-context-lengths">RAG’s Future with Million-Token Context Lengths</h3>
<ul>
<li><p><strong>Q:</strong> How will the emergence of million-token context lengths impact the relevance of RAG in the future?</p></li>
<li><p><strong>A:</strong> RAG remains relevant even with extended context windows. Just as RAM doesn’t replace hard drives, large context windows won’t replace the need for efficient retrieval from vast external knowledge stores. Long context windows provide more flexibility in retrieval speed and allow for incorporating longer documents.</p></li>
</ul>
</section>
<section id="chunking-strategies" class="level3">
<h3 class="anchored" data-anchor-id="chunking-strategies">Chunking Strategies</h3>
<ul>
<li><p><strong>Q:</strong> What are your thoughts on different chunking strategies?</p></li>
<li><p><strong>A:</strong> While LLMs for pre-chunking are promising but currently immature, maintaining semantic continuity within chunks is vital. The recommended approach is 300 tokens per chunk, avoiding sentence interruptions and including overlapping context (50 tokens) between consecutive chunks.</p></li>
</ul>
</section>
<section id="fine-tuning-bi-encoders" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning-bi-encoders">Fine-tuning Bi-Encoders</h3>
<ul>
<li><p><strong>Q:</strong> Should bi-encoders always be fine-tuned with labeled data or is it acceptable to use them off-the-shelf and rely on a re-ranker?</p></li>
<li><p><strong>A:</strong> Fine-tuning encoders (both bi- and cross-) with labeled data consistently improves results. If data and resources are available, fine-tuning is highly recommended. However, for MVPs with limited resources, leveraging pre-trained models with re-ranking is a viable option.</p></li>
</ul>
</section>
<section id="colbert-clarification-and-discussion" class="level3">
<h3 class="anchored" data-anchor-id="colbert-clarification-and-discussion">Colbert Clarification and Discussion</h3>
<ul>
<li><p><strong>Discussion:</strong> Clarifying the role of ColBERT in RAG pipelines.</p>
<ul>
<li><p><strong>ColBERT as a First-Stage Retriever:</strong> Ideally replaces the bi-encoder in new pipelines, not used as a re-ranker.</p></li>
<li><p><strong>ColBERT as a Re-Ranker:</strong> Can be used when pipeline changes are not feasible, but less optimal.</p></li>
<li><p><strong>ColBERT Overview:</strong> A bi-encoder variant where documents and queries are represented as bags of embeddings (one per token). This approach enhances out-of-domain performance due to its multi-vector representation, capturing more granular information.</p></li>
</ul></li>
</ul>
</section>
<section id="tools-for-fine-tuning-embeddings" class="level3">
<h3 class="anchored" data-anchor-id="tools-for-fine-tuning-embeddings">Tools for Fine-tuning Embeddings</h3>
<ul>
<li><p><strong>Q:</strong> Recommendations for tools to fine-tune embeddings for retrieval.</p></li>
<li><p><strong>A:</strong> <a href="https://sbert.net/">Sentence Transformers</a>, particularly version 3.0, is highly recommended for its user-friendliness and comprehensive implementation of essential features.</p></li>
</ul>
</section>
<section id="fine-tuning-embeddings-workflow" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning-embeddings-workflow">Fine-tuning Embeddings Workflow</h3>
<ul>
<li><p><strong>Q:</strong> Can you describe the workflow for fine-tuning an embedding model?</p></li>
<li><p><strong>A:</strong></p>
<ol type="1">
<li><strong>Gather Data:</strong> Obtain queries and their corresponding relevant and non-relevant documents.</li>
<li><strong>Define Loss Function:</strong> Use a suitable loss function like <a href="https://doordash.engineering/2021/09/08/using-twin-neural-networks-to-train-catalog-item-embeddings/">triplet loss</a>, which leverages positive and negative examples to guide the model.</li>
<li><strong>Consider Hard Negatives:</strong> Enhance training by retrieving hard negatives—documents similar to positive examples but irrelevant to the query.</li>
<li><strong>Data Analysis and Generation:</strong> Thoroughly analyze existing queries or generate synthetic ones using LLMs to augment training data.</li>
</ol></li>
</ul>
</section>
<section id="impact-of-long-context-windows-on-rag" class="level3">
<h3 class="anchored" data-anchor-id="impact-of-long-context-windows-on-rag">Impact of Long Context Windows on RAG</h3>
<ul>
<li><p><strong>Q:</strong> How do long context windows change the strategies and possibilities within RAG?</p></li>
<li><p><strong>A:</strong> Long context windows enable:</p>
<ul>
<li><p><strong>Longer Documents:</strong> Incorporating longer documents or concatenated chunks into the context.</p></li>
<li><p><strong>Reduced Retrieval Overhead:</strong> Relaxing the reliance on highly precise retrieval (e.g., Recall@3) as more documents can fit within the context window. This allows for faster, less resource-intensive retrieval methods.</p></li>
</ul></li>
</ul>
</section>
<section id="fine-tuning-encoder-tutorials" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning-encoder-tutorials">Fine-tuning Encoder Tutorials</h3>
<ul>
<li><p><strong>Q:</strong> Recommendations for tutorials on fine-tuning encoders.</p></li>
<li><p><strong>A:</strong> The <a href="https://www.sbert.net/docs/sentence_transformer/training_overview.html">Sentence Transformers documentation</a> is a valuable resource but can be challenging for beginners.</p></li>
</ul>
</section>
<section id="go-to-embedding-models" class="level3">
<h3 class="anchored" data-anchor-id="go-to-embedding-models">Go-to Embedding Models</h3>
<ul>
<li><p><strong>Q:</strong> Go-to embedding models for different scenarios.</p></li>
<li><p><strong>A:</strong></p>
<ul>
<li><p><strong>Demos:</strong> <a href="https://cohere.com/">Cohere</a>’s embedding models due to their API accessibility, performance, and affordability.</p></li>
<li><p><strong>Production:</strong> Multi-vector models like ColBERT are preferred.</p></li>
</ul></li>
<li><p><strong>General Recommendations:</strong></p>
<ul>
<li><p><strong>Model Size:</strong> Stick to models with parameters between 100 million and 1 billion; larger LLMs as encoders often have unfavorable latency-performance trade-offs.</p></li>
<li><p><strong>Avoid Overly Large Models:</strong> Using excessively large LLMs for embedding can lead to diminishing returns in performance and increased latency.</p></li>
</ul></li>
</ul>
</section>
<section id="using-elasticsearch-for-rag" class="level3">
<h3 class="anchored" data-anchor-id="using-elasticsearch-for-rag">Using Elasticsearch for RAG</h3>
<ul>
<li><p><strong>Q:</strong> Can Elasticsearch, a widely used search engine, be integrated into RAG pipelines, especially for organizations already invested in it?</p></li>
<li><p><strong>A:</strong></p>
<ul>
<li><p><strong>Hybrid Approach:</strong> Use Elasticsearch’s BM25 capabilities for initial retrieval and integrate a separate re-ranking pipeline (potentially using a cross-encoder).</p></li>
<li><p><strong>Vector Database Integration:</strong> Leverage Elasticsearch’s vector database offerings to incorporate semantic search capabilities.</p></li>
</ul></li>
</ul>
</section>
<section id="bm25-score-in-re-ranking" class="level3">
<h3 class="anchored" data-anchor-id="bm25-score-in-re-ranking">BM25 Score in Re-ranking</h3>
<ul>
<li><p><strong>Q:</strong> Is it beneficial to incorporate BM25 similarity scores during the re-ranking stage?</p></li>
<li><p><strong>A:</strong> No, BM25 scores are primarily used for candidate retrieval and are not typically required by cross-encoders during re-ranking.</p></li>
</ul>
</section>
<section id="strategies-for-chunks-exceeding-context-window" class="level3">
<h3 class="anchored" data-anchor-id="strategies-for-chunks-exceeding-context-window">Strategies for Chunks Exceeding Context Window</h3>
<ul>
<li><p><strong>Q:</strong> Strategies for handling situations where document chunks exceed the context window size.</p></li>
<li><p><strong>A:</strong> Solutions depend on the specific constraints:</p>
<ul>
<li><p><strong>Latency Tolerance:</strong> User experience dictates acceptable processing time.</p></li>
<li><p><strong>Document Length and Diversity Requirements:</strong></p></li>
<li><p><strong>Precomputed Summaries:</strong> Maintain a separate database mapping documents to their summaries, generated offline. Retrieve relevant chunks and feed summaries into the context window to provide concise context.</p></li>
</ul></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<!-- Cloudflare Web Analytics --><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;56b8d2f624604c4891327b3c0d9f6703&quot;}"></script><!-- End Cloudflare Web Analytics -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/christianjmills\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="cj-mills/christianjmills" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
<p>Content licensed under CC BY-NC-SA 4.0</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../../about.html">
<p>© 2024 Christian J. Mills</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://opensource.org/licenses/MIT">
<p>Code samples licensed under the MIT License</p>
</a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>