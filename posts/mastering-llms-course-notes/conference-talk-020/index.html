<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christian Mills">
<meta name="dcterms.date" content="2024-08-30">
<meta name="description" content="In this talk, Jo Kristian Bergum from Vespa.ai explores practical strategies for building better Retrieval Augmented Generation (RAG) applications, emphasizing the importance of robust evaluation methods and understanding the nuances of information retrieval beyond simple vector embeddings.">

<title>Christian Mills - Conference Talk 20: Back to Basics for RAG</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../images/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Christian Mills - Conference Talk 20: Back to Basics for RAG">
<meta property="og:description" content="In this talk, Jo Kristian Bergum from Vespa.ai explores practical strategies for building better Retrieval Augmented Generation (RAG) applications, emphasizing the importance of robust evaluation methods and understanding the nuances of information retrieval beyond simple vector embeddings.">
<meta property="og:image" content="https://christianjmills.com/posts/mastering-llms-course-notes/social-media/cover.jpg">
<meta property="og:site_name" content="Christian Mills">
<meta name="twitter:title" content="Christian Mills - Conference Talk 20: Back to Basics for RAG">
<meta name="twitter:description" content="In this talk, Jo Kristian Bergum from Vespa.ai explores practical strategies for building better Retrieval Augmented Generation (RAG) applications, emphasizing the importance of robust evaluation methods and understanding the nuances of information retrieval beyond simple vector embeddings.">
<meta name="twitter:image" content="https://christianjmills.com/posts/mastering-llms-course-notes/social-media/cover.jpg">
<meta name="twitter:creator" content="@cdotjdotmills">
<meta name="twitter:site" content="@cdotjdotmills">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Christian Mills</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series/tutorials/index.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../series/notes/index.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:christian@christianjmills.com"> <i class="bi bi-envelope-fill" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cj-mills"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/christianjmills"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about-jo-kristian-bergum" id="toc-about-jo-kristian-bergum" class="nav-link active" data-scroll-target="#about-jo-kristian-bergum">About Jo Kristian Bergum</a></li>
  <li><a href="#talk-overview" id="toc-talk-overview" class="nav-link" data-scroll-target="#talk-overview">Talk Overview</a></li>
  <li><a href="#demystifying-rag" id="toc-demystifying-rag" class="nav-link" data-scroll-target="#demystifying-rag">Demystifying RAG</a></li>
  <li><a href="#cutting-through-the-hype" id="toc-cutting-through-the-hype" class="nav-link" data-scroll-target="#cutting-through-the-hype">Cutting Through the Hype</a></li>
  <li><a href="#evaluating-information-retrieval-systems" id="toc-evaluating-information-retrieval-systems" class="nav-link" data-scroll-target="#evaluating-information-retrieval-systems">Evaluating Information Retrieval Systems</a></li>
  <li><a href="#building-your-own-relevancy-dataset" id="toc-building-your-own-relevancy-dataset" class="nav-link" data-scroll-target="#building-your-own-relevancy-dataset">Building Your Own Relevancy Dataset</a></li>
  <li><a href="#representational-approaches-and-scoring-functions" id="toc-representational-approaches-and-scoring-functions" class="nav-link" data-scroll-target="#representational-approaches-and-scoring-functions">Representational Approaches and Scoring Functions</a></li>
  <li><a href="#hybrid-approaches" id="toc-hybrid-approaches" class="nav-link" data-scroll-target="#hybrid-approaches">Hybrid Approaches</a></li>
  <li><a href="#long-context-and-chunking" id="toc-long-context-and-chunking" class="nav-link" data-scroll-target="#long-context-and-chunking">Long Context and Chunking</a></li>
  <li><a href="#real-world-rag-considerations" id="toc-real-world-rag-considerations" class="nav-link" data-scroll-target="#real-world-rag-considerations">Real-World RAG Considerations</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#qa-session" id="toc-qa-session" class="nav-link" data-scroll-target="#qa-session">Q&amp;A Session</a>
  <ul>
  <li><a href="#q1-metadata-for-vector-db-in-rag" id="toc-q1-metadata-for-vector-db-in-rag" class="nav-link" data-scroll-target="#q1-metadata-for-vector-db-in-rag">Q1: Metadata for Vector DB in RAG</a></li>
  <li><a href="#q2-calibration-of-different-indices" id="toc-q2-calibration-of-different-indices" class="nav-link" data-scroll-target="#q2-calibration-of-different-indices">Q2: Calibration of Different Indices</a></li>
  <li><a href="#q3-efficacy-of-re-rankers" id="toc-q3-efficacy-of-re-rankers" class="nav-link" data-scroll-target="#q3-efficacy-of-re-rankers">Q3: Efficacy of Re-rankers</a></li>
  <li><a href="#q4-combining-usage-data-and-semantic-similarity" id="toc-q4-combining-usage-data-and-semantic-similarity" class="nav-link" data-scroll-target="#q4-combining-usage-data-and-semantic-similarity">Q4: Combining Usage Data and Semantic Similarity</a></li>
  <li><a href="#q5-jason-lius-post-on-structured-summaries" id="toc-q5-jason-lius-post-on-structured-summaries" class="nav-link" data-scroll-target="#q5-jason-lius-post-on-structured-summaries">Q5: Jason Liu’s Post on Structured Summaries</a></li>
  <li><a href="#q6-recent-advancements-in-text-embedding-models" id="toc-q6-recent-advancements-in-text-embedding-models" class="nav-link" data-scroll-target="#q6-recent-advancements-in-text-embedding-models">Q6: Recent Advancements in Text Embedding Models</a></li>
  <li><a href="#q7-query-expansion-with-bm25" id="toc-q7-query-expansion-with-bm25" class="nav-link" data-scroll-target="#q7-query-expansion-with-bm25">Q7: Query Expansion with BM25</a></li>
  <li><a href="#q8-handling-jargon-and-tokenization-issues" id="toc-q8-handling-jargon-and-tokenization-issues" class="nav-link" data-scroll-target="#q8-handling-jargon-and-tokenization-issues">Q8: Handling Jargon and Tokenization Issues</a></li>
  <li><a href="#q9-colbert-and-tokenizer-problems" id="toc-q9-colbert-and-tokenizer-problems" class="nav-link" data-scroll-target="#q9-colbert-and-tokenizer-problems">Q9: ColBERT and Tokenizer Problems</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Conference Talk 20: Back to Basics for RAG</h1>
  <div class="quarto-categories">
    <div class="quarto-category">notes</div>
    <div class="quarto-category">llms</div>
  </div>
  </div>

<div>
  <div class="description">
    In this talk, <strong>Jo Kristian Bergum</strong> from <strong>Vespa.ai</strong> explores practical strategies for building better Retrieval Augmented Generation (RAG) applications, emphasizing the importance of robust evaluation methods and understanding the nuances of information retrieval beyond simple vector embeddings.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christian Mills </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 30, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Presentation Resources:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Presentation Resources:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Slides:</strong> <a href="https://docs.google.com/presentation/d/19L2j2-fBC_iPGswwER3Cfsy7N3HSqUrVfxh2xvcBU2Y/edit#slide=id.p">Back to basics?</a></li>
</ul>
</div>
</div>
<section id="about-jo-kristian-bergum" class="level3">
<h3 class="anchored" data-anchor-id="about-jo-kristian-bergum">About Jo Kristian Bergum</h3>
<ul>
<li><strong>Distinguished Engineer</strong> at Vespa.ai</li>
<li>18 years at Vespa.ai, 20 years in search and recommendation.</li>
<li><strong><a href="https://vespa.ai/">Vespa.ai</a>:</strong>
<ul>
<li>Serving platform spun out of Yahoo.</li>
<li>Open source since 2017.</li>
<li><strong>Blog:</strong> <a href="https://blog.vespa.ai/">https://blog.vespa.ai/</a></li>
</ul></li>
<li>Active on Twitter (<a href="https://x.com/jobergum"><span class="citation" data-cites="jobergum">@jobergum</span></a>), enjoys posting memes.</li>
</ul>
</section>
<section id="talk-overview" class="level3">
<h3 class="anchored" data-anchor-id="talk-overview">Talk Overview</h3>
<ul>
<li><strong>Stuffing Text into Language Model Prompts:</strong> Using RAG beyond question answering, e.g., for classification by retrieving relevant training examples.</li>
<li><strong>Information Retrieval (The R in RAG):</strong> Exploring the core concepts of retrieval and its importance in RAG pipelines.</li>
<li><strong>Evaluation of IR Systems:</strong>
<ul>
<li>Building your own evaluation systems to measure and improve search performance.</li>
<li>Demonstrating the impact of changes to your CTO.</li>
</ul></li>
<li><strong>Representational Approaches for IR:</strong>
<ul>
<li>Discussing <strong>sparse</strong> and <strong>dense</strong> representations (BM25, vectors, embeddings).</li>
<li>Examining baselines for comparison.</li>
</ul></li>
</ul>
</section>
<section id="demystifying-rag" class="level3">
<h3 class="anchored" data-anchor-id="demystifying-rag">Demystifying RAG</h3>
<ul>
<li><strong>RAG (Retrieval Augmented Generation):</strong> A technique for enhancing language model outputs by retrieving relevant context from external knowledge sources.</li>
<li><strong>Common Use Cases:</strong> Question answering, chatbots, generating grounded responses.
<ul>
<li><div class="callout callout-style-default callout-note callout-titled" title="Example:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example:
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Current date is {date}, Don’t be rude. I’ll tip $5. Think step-by-step.</strong></p>
<p>I want you to classify the text input as positive, negative or neutral. Examples:</p>
<p><strong>Input:</strong> I’m very happy today<br>
<strong>Output:</strong> positive</p>
<p><strong>Input:</strong> I’m sad today<br>
<strong>Output:</strong> negative</p>
<p><strong>Input:</strong> I don’t know what to feel today<br>
<strong>Output:</strong> neutral</p>
<p>✨ <strong>{many_retrieved_context_sensitive_examples}</strong> ✨</p>
<p><strong>Input:</strong> {input}<br>
<strong>Output:</strong></p>
</div>
</div></li>
<li><div class="callout callout-style-default callout-note callout-titled" title="Example:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example:
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Current date is {date}, Don’t be rude. I’ll tip $5. Think step-by-step.</strong></p>
<p>I want you to summarize and answer the question using context retrieved by a search engine.<br>
<strong>Context:</strong> [1] BERT: Pre-training of deep bidirectional transformers for language understanding…<br>
<strong>Question:</strong> What is a bidirectional transformer model?<br>
<strong>Helpful answer:</strong> bidirectional means that tokens attend to all other tokens in the input sequence [1].</p>
<p>✨ <strong>{retrieved_context_sensitive_examples}</strong> ✨</p>
<p><strong>Context:</strong> {retrieved_context_question}<br>
<strong>Question:</strong> {question}<br>
<strong>Helpful answer:</strong></p>
</div>
</div></li>
</ul></li>
<li><strong>Basic Architecture:</strong>
<ul>
<li><strong>Orchestration Component:</strong> Manages the flow of data and interactions between components.</li>
<li><strong>Input:</strong> User queries or prompts.</li>
<li><strong>Output:</strong> Generated responses.</li>
<li><strong>Evaluation:</strong> Measures the quality of the output.</li>
<li><strong>Prompting:</strong> Techniques for interacting with language models.</li>
<li><strong>Language Models:</strong> The core component for generating text.</li>
<li><strong>State:</strong> Data storage, including files, search engines, vector databases, and databases.</li>
</ul></li>
</ul>
</section>
<section id="cutting-through-the-hype" class="level3">
<h3 class="anchored" data-anchor-id="cutting-through-the-hype">Cutting Through the Hype</h3>
<ul>
<li><strong>Challenges in the RAG Landscape:</strong>
<ul>
<li>Constant stream of new models, components, and tricks.</li>
<li>Oversimplification of RAG as just vector embeddings and language models.</li>
<li>Lack of focus on evaluating performance on specific data.</li>
</ul></li>
<li><strong>Importance of Information Retrieval:</strong>
<ul>
<li>Retrieval is a deep and well-studied field, crucial for many applications.</li>
<li>It’s more complex than simply encoding text into a single vector representation.</li>
<li>Building effective RAG solutions requires understanding and leveraging existing retrieval techniques.</li>
</ul></li>
</ul>
</section>
<section id="evaluating-information-retrieval-systems" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-information-retrieval-systems">Evaluating Information Retrieval Systems</h3>
<ul>
<li><strong>Information Retrieval System as a Black Box:</strong>
<ul>
<li>Input: Query</li>
<li>Output: Ranked list of documents</li>
</ul></li>
<li><strong>Evaluation Based on Relevance:</strong>
<ul>
<li>Human annotators judge the relevance of retrieved documents to the query.</li>
<li><strong>Binary Judgment:</strong> Relevant or not relevant.</li>
<li><strong>Graded Judgment:</strong> Levels of relevance (e.g., 0 - irrelevant, 1 - slightly relevant, 2 - highly relevant).</li>
</ul></li>
<li><strong>Established IR Research and Benchmarks:</strong>
<ul>
<li><strong><a href="https://trec.nist.gov/">TREC (Text Retrieval Conference)</a>:</strong> Evaluates various retrieval tasks, including news retrieval.</li>
<li><strong><a href="https://microsoft.github.io/msmarco/">MS MARCO</a>:</strong> Large-scale dataset from Bing with real-world annotated data used for training embedding models.
<ul>
<li><strong>HuggingFace Hub:</strong> <a href="https://huggingface.co/datasets/microsoft/ms_marco">microsoft/ms_marco</a></li>
</ul></li>
<li><strong><a href="https://github.com/beir-cellar/beir">BEIR</a>:</strong> Evaluates models in a zero-shot setting without training data.</li>
</ul></li>
<li><strong>Common IR Metrics:</strong>
<ul>
<li><strong>Recall@K:</strong> Measures the proportion of relevant documents retrieved within the top K positions.</li>
<li><strong>Precision@K:</strong> Measures the proportion of relevant documents among the top K retrieved documents.</li>
<li><strong>nDCG (Normalized Discounted Cumulative Gain):</strong> Rank-aware metric that considers graded relevance judgments.</li>
<li><strong>Reciprocal Rank:</strong> Measures the position of the first relevant hit.</li>
<li><strong>LGTM (Looks Good To Me):</strong> Informal but common metric in industry.</li>
</ul></li>
<li><strong>Production System Metrics:</strong> Engagement (clicks, dwell time), add-to-cart rate, revenue.</li>
<li><strong>Benchmark Limitations:</strong>
<ul>
<li>Often compare flat lists, not personalized results.</li>
<li>Don’t always transfer well to specific domains or use cases.</li>
</ul></li>
</ul>
</section>
<section id="building-your-own-relevancy-dataset" class="level3">
<h3 class="anchored" data-anchor-id="building-your-own-relevancy-dataset">Building Your Own Relevancy Dataset</h3>
<ul>
<li><p><strong>The Importance of Measuring:</strong> To improve RAG performance, measure relevance on your specific data.</p></li>
<li><p><strong>Creating a Relevancy Dataset:</strong></p>
<ul>
<li><strong>Leverage Existing Traffic:</strong> Log user searches and judge the relevance of results.</li>
<li><strong>Bootstrap with Language Models:</strong> Use LLMs to generate questions based on your content and judge the relevance of retrieved passages.</li>
</ul></li>
<li><p><strong>Dataset Format:</strong></p>
<ul>
<li><p>Simple TSV file is sufficient.</p></li>
<li><p><strong>Query ID, Document ID, Relevance Label</strong></p>
<ul>
<li><table class="caption-top table">
<thead>
<tr class="header">
<th>qid</th>
<th>docid</th>
<th>relevance label</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3 (how to ..)</td>
<td>4</td>
<td>2</td>
<td></td>
</tr>
<tr class="even">
<td>3 (where ..)</td>
<td>2</td>
<td>0</td>
<td></td>
</tr>
</tbody>
</table></li>
</ul></li>
</ul></li>
<li><p><strong>Static vs.&nbsp;Dynamic Collections:</strong></p>
<ul>
<li>Static collections are preferred for consistent evaluation.</li>
<li>Dynamic collections can introduce noise when evaluating metrics.</li>
</ul></li>
<li><p><strong>Using Language Models for Relevance Judgments:</strong></p>
<ul>
<li><p><strong>Paper:</strong> <a href="https://arxiv.org/abs/2309.10621">Large language models can accurately predict searcher preferences</a></p></li>
<li><p>LLMs can be prompted to assess the relevance of queries and passages.</p></li>
<li><p>Find a prompt that correlates well with your golden dataset.</p></li>
<li><p>Enables cheaper and larger-scale evaluation.</p></li>
<li><p><strong>Example:</strong> Microsoft research demonstrating LLM effectiveness in judging relevance.</p>
<ul>
<li><p><strong>Paper:</strong> <a href="https://arxiv.org/abs/2406.06519">UMBRELA: UMbrela is the (Open-Source Reproduction of the) Bing RELevance Assessor</a></p></li>
<li><div class="callout callout-style-default callout-note callout-titled" title="Figure 1: Prompt used for relevance assessment.">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Figure 1: Prompt used for relevance assessment.
</div>
</div>
<div class="callout-body-container callout-body">
<pre class="text"><code>Given a query and a passage, you must provide a score on an
integer scale of 0 to 3 with the following meanings:
0 = represent that the passage has nothing to do with the query,
1 = represents that the passage seems related to the query but
does not answer it,
2 = represents that the passage has some answer for the query,
but the answer may be a bit unclear, or hidden amongst extraneous
information and
3 = represents that the passage is dedicated to the query and
contains the exact answer.

Important Instruction: Assign category 1 if the passage is
somewhat related to the topic but not completely, category 2 if
passage presents something very important related to the entire
topic but also has some extra information and category 3 if the
passage only and entirely refers to the topic. If none of the
above satisfies give it category 0.

Query: {query}
Passage: {passage}

Split this problem into steps:
Consider the underlying intent of the search.
Measure how well the content matches a likely intent of the query
(M).
Measure how trustworthy the passage is (T).
Consider the aspects above and the relative importance of each,
and decide on a final score (O). Final score must be an integer
value only.
Do not provide any code in result. Provide each score in the
format of: ##final score: score without providing any reasoning.</code></pre>
</div>
</div></li>
</ul></li>
</ul></li>
<li><p><strong>Benefits of Custom Relevancy Datasets:</strong></p>
<ul>
<li>Iterate and measure the impact of changes to your retrieval system.</li>
<li>Track improvements in metrics like nDCG.</li>
<li><strong>Example:</strong> Vespa documentation search showing improvement in nDCG with hybrid retrieval methods.</li>
</ul></li>
</ul>
</section>
<section id="representational-approaches-and-scoring-functions" class="level3">
<h3 class="anchored" data-anchor-id="representational-approaches-and-scoring-functions">Representational Approaches and Scoring Functions</h3>
<ul>
<li><strong>Motivation for Efficient Retrieval:</strong> Avoid scoring all documents in the collection for each query.</li>
<li><strong>Sparse Representations:</strong>
<ul>
<li><strong>Term-based:</strong> Documents and queries are represented by the presence and weight of terms.</li>
<li><strong>Efficient Retrieval:</strong> Inverted indexes, algorithms like WAND and MaxScore.</li>
<li><strong>Example:</strong> Keyword search technologies like Elasticsearch and Vespa.</li>
</ul></li>
<li><strong>Dense Representations:</strong>
<ul>
<li><strong>Embedding-based:</strong> Documents and queries are represented by vectors in a latent space.</li>
<li><strong>Neural/Sparse Embedding Models:</strong> Learn term weights using transformer models.</li>
<li><strong>Efficient Retrieval:</strong> Approximate Nearest Neighbor search, vector databases.</li>
<li><strong>Example:</strong> Text embedding models, semantic search.</li>
</ul></li>
<li><strong>Advantages of Dense Representations:</strong>
<ul>
<li>Capture semantic relationships between words and concepts.</li>
<li>Enable search based on meaning rather than exact keyword matches.</li>
</ul></li>
<li><strong>Challenges of Dense Representations:</strong>
<ul>
<li><strong>Transfer Learning:</strong> Off-the-shelf models may not perform well on specific data.</li>
<li><strong>Diluted Representations:</strong> Averaging token embeddings into a single vector can lose information.</li>
<li><strong>Fixed Vocabulary:</strong> Out-of-vocabulary words can be mapped to incorrect concepts.</li>
<li><strong>Chunking:</strong> Long documents need to be chunked to maintain precision.</li>
</ul></li>
<li><strong>Baselines for Comparison:</strong>
<ul>
<li><strong>BM25:</strong>
<ul>
<li><strong>Term-based scoring function.</strong></li>
<li><strong>Unsupervised, based on corpus statistics.</strong></li>
<li><strong>Cheap, small index footprint.</strong></li>
<li><strong>Strong baseline for many tasks.</strong></li>
<li><strong>Limitations:</strong> Requires language-specific tokenization, struggles with long context.</li>
</ul></li>
<li><strong>Example:</strong> BM25 outperforming embedding models on long context documents in ColBERT evaluation.
<ul>
<li><strong>Blog Post:</strong> <a href="https://blog.vespa.ai/announcing-long-context-ColBERT-in-vespa/">Announcing Vespa Long-Context ColBERT</a></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="hybrid-approaches" class="level3">
<h3 class="anchored" data-anchor-id="hybrid-approaches">Hybrid Approaches</h3>
<ul>
<li><strong>Combining Sparse and Dense Representations:</strong>
<ul>
<li>Can overcome limitations of individual approaches.</li>
<li>Example: Combining keyword search with embedding retrieval.</li>
</ul></li>
<li><strong>Challenges of Hybrid Approaches:</strong>
<ul>
<li>Calibration of different scoring functions.</li>
<li>Determining when to ignore embedding results.</li>
<li>Requires careful tuning and evaluation.</li>
</ul></li>
</ul>
</section>
<section id="long-context-and-chunking" class="level3">
<h3 class="anchored" data-anchor-id="long-context-and-chunking">Long Context and Chunking</h3>
<ul>
<li><strong>Desire for Long Context Models:</strong> Eliminate the need for chunking.</li>
<li><strong>Reality of Chunking:</strong>
<ul>
<li>Necessary for meaningful representations in high-precision search.
<ul>
<li>Dense representation beyond 256 tokens are bad for high-precision search.</li>
</ul></li>
<li><strong>Pooling operations dilute representations in long contexts.</strong></li>
<li><strong>Limited training data for long context models.</strong></li>
</ul></li>
<li><strong>Chunking Strategies:</strong>
<ul>
<li>Split long documents into smaller segments.</li>
<li>Index multiple vectors per row in a database.</li>
</ul></li>
</ul>
</section>
<section id="real-world-rag-considerations" class="level3">
<h3 class="anchored" data-anchor-id="real-world-rag-considerations">Real-World RAG Considerations</h3>
<ul>
<li><strong>Google Search Signals:</strong>
<ul>
<li><strong>Text Similarity:</strong> BM25, vector cosine similarity.</li>
<li><strong>Freshness:</strong> Recency of content.</li>
<li><strong>Authority:</strong> Trustworthiness of the source.</li>
<li><strong>Quality:</strong> Overall content quality.</li>
<li><strong>PageRank:</strong> Link analysis algorithm.</li>
<li><strong>Revenue:</strong> In advertising-based search.</li>
</ul></li>
<li><strong>GBDT (Gradient Boosted Decision Trees):</strong>
<ul>
<li>Effective for combining tabular features.</li>
<li>Still relevant for real-world search.</li>
</ul></li>
</ul>
</section>
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">Summary</h3>
<ul>
<li><strong>Information retrieval is more than just vector representations.</strong></li>
<li><strong>Build your own evaluations to improve retrieval.</strong></li>
<li><strong>Don’t ignore the BM25 baseline.</strong></li>
<li><strong>Choose technologies with hybrid capabilities.</strong></li>
<li><strong>Real-world search involves more than just text similarity.</strong></li>
</ul>
</section>
<section id="qa-session" class="level3">
<h3 class="anchored" data-anchor-id="qa-session">Q&amp;A Session</h3>
<section id="q1-metadata-for-vector-db-in-rag" class="level4">
<h4 class="anchored" data-anchor-id="q1-metadata-for-vector-db-in-rag">Q1: Metadata for Vector DB in RAG</h4>
<ul>
<li><strong>Question:</strong> What kind of metadata is most valuable to put into a vector DB for doing RAG?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Context-Dependent:</strong> The most valuable metadata depends on the specific use case and domain.</li>
<li><strong>Text-Only Use Cases:</strong>
<ul>
<li><strong>Authority/Source Filtering:</strong> Important in domains like healthcare where trustworthiness of sources is crucial (e.g., filter out Reddit posts in favor of medical journals).</li>
<li><strong>Title and other basic metadata:</strong> Can provide additional context for retrieval.</li>
</ul></li>
<li><strong>Real-World Use Cases:</strong>
<ul>
<li>Consider factors beyond text, such as freshness, authority, quality, and even revenue.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="q2-calibration-of-different-indices" class="level4">
<h4 class="anchored" data-anchor-id="q2-calibration-of-different-indices">Q2: Calibration of Different Indices</h4>
<ul>
<li><strong>Question:</strong> Do you have any thoughts on calibration of different indices? How can we obtain confidence scores for recommendations?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Challenge:</strong> Different scoring functions (e.g., BM25, cosine similarity) have different distributions and ranges, making calibration difficult. Scores are not probabilities.</li>
<li><strong>Learning Task:</strong> Combining scores effectively is a learning problem.</li>
<li><strong>GBDT’s Strength:</strong> Gradient Boosted Decision Trees (GBDT) can learn non-linear combinations of features, including different scoring functions.</li>
<li><strong>Need for Training Data:</strong> Calibration and learning require training data.</li>
<li><strong>Options for Training Data:</strong>
<ul>
<li><strong>Evaluation Data:</strong> The evaluation datasets described earlier can be used to generate training data.</li>
<li><strong>Real User Interactions:</strong> Gather data from user searches and clicks (like Google).</li>
<li><strong>Synthetic Data:</strong> Use large language models to generate synthetic training data.</li>
</ul></li>
<li><strong>No Easy Tricks:</strong> There’s no universal solution for calibration without training data and evaluation.</li>
</ul></li>
</ul>
</section>
<section id="q3-efficacy-of-re-rankers" class="level4">
<h4 class="anchored" data-anchor-id="q3-efficacy-of-re-rankers">Q3: Efficacy of Re-rankers</h4>
<ul>
<li><strong>Question:</strong> What are your observations on the efficacy of re-rankers? Do you recommend using them?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Phased Retrieval and Ranking:</strong> Re-rankers are valuable in multi-stage pipelines. They allow you to invest more compute into fewer, more promising hits retrieved in earlier stages.</li>
<li><strong>Benefits of Re-rankers:</strong>
<ul>
<li><strong>Token-Level Interaction:</strong> Re-rankers like Cohere or cross-encoders enable deeper interaction between the query and document at the token level, improving accuracy.</li>
<li><strong>Latency Management:</strong> By focusing on a smaller set of candidates, re-rankers can help meet latency requirements.</li>
</ul></li>
<li><strong>Trade-offs:</strong> Re-rankers add computational cost and latency.</li>
<li><strong>Recommendation:</strong> If accuracy is a priority and the cost is acceptable, re-rankers are recommended.</li>
</ul></li>
</ul>
</section>
<section id="q4-combining-usage-data-and-semantic-similarity" class="level4">
<h4 class="anchored" data-anchor-id="q4-combining-usage-data-and-semantic-similarity">Q4: Combining Usage Data and Semantic Similarity</h4>
<ul>
<li><strong>Question:</strong> Do you have advice on combining usage data (e.g., number of views) with semantic similarity?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Learning to Rank Problem:</strong> Integrating usage data turns it into a learning to rank problem.</li>
<li><strong>Label Generation:</strong> Convert interaction data into labeled training data. Different interactions (e.g., views, clicks, add-to-cart) may have different weights in the label generation process.</li>
<li><strong>Model Training:</strong> Train a ranking model (e.g., GBDT) using the labeled data, including semantic similarity scores and usage data as features.</li>
</ul></li>
</ul>
</section>
<section id="q5-jason-lius-post-on-structured-summaries" class="level4">
<h4 class="anchored" data-anchor-id="q5-jason-lius-post-on-structured-summaries">Q5: Jason Liu’s Post on Structured Summaries</h4>
<ul>
<li><strong>Question:</strong> What are your thoughts on Jason Liu’s post about the value of generating structured summaries and reports for decision makers instead of doing RAG as commonly done today?</li>
<li><strong>Answer:</strong> Jo was not familiar with the specific post.</li>
</ul>
</section>
<section id="q6-recent-advancements-in-text-embedding-models" class="level4">
<h4 class="anchored" data-anchor-id="q6-recent-advancements-in-text-embedding-models">Q6: Recent Advancements in Text Embedding Models</h4>
<ul>
<li><strong>Question:</strong> What are some of your favorite advancements recently in text embedding models or other search technologies?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Larger Vocabularies:</strong> Jo hopes for embedding models with larger vocabularies to better handle out-of-vocabulary words, especially in specialized domains. BERT’s vocabulary is outdated.</li>
<li><strong>Improved Pre-trained Models:</strong> Better pre-training techniques and data can lead to more robust and generalizable embedding models.</li>
<li><strong>Caution on Long Context:</strong> Jo is not overly enthusiastic about increasing context length for embedding models. Research suggests diminishing returns for high-precision search with very long contexts.</li>
</ul></li>
</ul>
</section>
<section id="q7-query-expansion-with-bm25" class="level4">
<h4 class="anchored" data-anchor-id="q7-query-expansion-with-bm25">Q7: Query Expansion with BM25</h4>
<ul>
<li><strong>Question:</strong> Does query expansion of out-of-vocabulary words with BM25 work better at search? Are people utilizing classical search techniques like query expansion enough?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>BM25 and Re-ranking:</strong> Combining BM25 with a re-ranker can yield excellent results. While BM25 may struggle with single-word queries that are out-of-vocabulary, it avoids the severe failure modes of relying solely on embedding-based search.</li>
<li><strong>Query Expansion’s Potential:</strong> Query expansion and understanding are powerful techniques. Language models can be used for query expansion, and tools for prompting LLMs for this purpose are improving.</li>
<li><strong>Importance of Evaluation:</strong> Building your own evaluation setup allows you to systematically test different techniques like query expansion on your specific data and determine their effectiveness.</li>
</ul></li>
</ul>
</section>
<section id="q8-handling-jargon-and-tokenization-issues" class="level4">
<h4 class="anchored" data-anchor-id="q8-handling-jargon-and-tokenization-issues">Q8: Handling Jargon and Tokenization Issues</h4>
<ul>
<li><strong>Question:</strong> How do you overcome limitations in fixed vocabulary and poor tokenization in domains with a lot of jargon, when using an out-of-the-box model?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Hybrid Approach:</strong> Combine keyword search with embedding retrieval to mitigate vocabulary limitations.</li>
<li><strong>Challenge of Ignoring Embedding Results:</strong> Embedding retrieval always returns results, even if they are not semantically relevant. It’s crucial to identify and filter out these irrelevant results.</li>
<li><strong>Fine-tuning:</strong> Fine-tuning your own embedding model on domain-specific data can help, but vocabulary limitations may persist.</li>
<li><strong>Pre-training from Scratch:</strong> Training a BERT-like model from scratch with a custom vocabulary tailored to the domain is becoming more feasible.
<ul>
<li>This is a common practice in e-commerce.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="q9-colbert-and-tokenizer-problems" class="level4">
<h4 class="anchored" data-anchor-id="q9-colbert-and-tokenizer-problems">Q9: ColBERT and Tokenizer Problems</h4>
<ul>
<li><strong>Question:</strong> Would ColBERT-based methods improve retrieval when we are concerned with tokenizer problems?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>ColBERT’s Approach:</strong> ColBERT learns token-level vector representations instead of a single vector for the whole passage or query. It offers high accuracy while being computationally less expensive than cross-encoders.</li>
<li><strong>Vocabulary Limitations:</strong> ColBERT still relies on the same vocabulary as other BERT-based models, so it’s not a complete solution to tokenizer problems.</li>
<li><strong>Future Direction:</strong> Better pre-trained models with larger vocabularies would benefit ColBERT and other embedding models.</li>
</ul></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<!-- Cloudflare Web Analytics --><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;56b8d2f624604c4891327b3c0d9f6703&quot;}"></script><!-- End Cloudflare Web Analytics -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/christianjmills\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="cj-mills/christianjmills" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
<p>Content licensed under CC BY-NC-ND 4.0</p>
</a>
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../../about.html">
<p>© 2024 Christian J. Mills</p>
</a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://opensource.org/licenses/MIT">
<p>Code samples licensed under the MIT License</p>
</a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>