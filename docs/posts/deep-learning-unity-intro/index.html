<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-05-28">
<meta name="description" content="An overview of Unity’s Barracuda inference library for executing deep learning models on user devices.">

<title>Christian Mills - Getting Started With Deep Learning in Unity</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Christian Mills - Getting Started With Deep Learning in Unity">
<meta property="og:description" content="An overview of Unity's Barracuda inference library for executing deep learning models on user devices.">
<meta property="og:image" content="christianjmills.com/images/logo.png">
<meta property="og:site-name" content="Christian Mills">
<meta property="og:image:height" content="295">
<meta property="og:image:width" content="300">
<meta name="twitter:title" content="Christian Mills - Getting Started With Deep Learning in Unity">
<meta name="twitter:description" content="An overview of Unity's Barracuda inference library for executing deep learning models on user devices.">
<meta name="twitter:image" content="christianjmills.com/images/logo.png">
<meta name="twitter:creator" content="@cdotjdotmills">
<meta name="twitter:site" content="@cdotjdotmills">
<meta name="twitter:image-height" content="295">
<meta name="twitter:image-width" content="300">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Christian Mills</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:christian@christianjmills.com"><i class="bi bi-envelope-fill" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cj-mills"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/cdotjdotmills"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Getting Started With Deep Learning in Unity</h1>
  <div class="quarto-categories">
    <div class="quarto-category">unity</div>
    <div class="quarto-category">barracuda</div>
  </div>
  </div>

<div>
  <div class="description">
    An overview of Unity’s Barracuda inference library for executing deep learning models on user devices.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 28, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-barracuda-library">The Barracuda Library</a></li>
<li><a href="#exporting-models-to-onnx">Exporting Models to ONNX</a></li>
<li><a href="#loading-models">Loading Models</a></li>
<li><a href="#executing-models">Executing Models</a></li>
<li><a href="#working-with-data">Working with Data</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Most deep learning models get deployed to servers instead of user devices. Server-side inference comes with many advantages, like complete control over the runtime environment and the option to scale computing resources up and down as needed. It can also be the only feasible way to run extremely-large models like <a href="https://openai.com/api/">GPT-3</a>.</p>
<p>However, running models on user devices can provide compelling cost, latency, and privacy benefits. There are no servers to maintain, no lag from poor internet connections, and no user data to protect. The latency benefits can be particularly significant for interactive real-time applications.</p>
<p><a href="https://unity.com/">Unity</a> is one of the best platforms for developing real-time 2D, 3D, VR, and AR applications. Its core competency is game development, but it also works well for other immersive and interactive applications.</p>
<p>There are many potential ways to leverage deep learning in Unity applications, including mapping user movement to virtual avatars, generating character dialogue, and powering enemy AI to name a few. Below are some examples from personal projects.</p>
<section id="in-game-style-transfer" class="level4">
<h4 class="anchored" data-anchor-id="in-game-style-transfer">In-Game Style Transfer</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><video src="./videos/in-game-style-transfer.mp4" class="img-fluid" controls=""><a href="./videos/in-game-style-transfer.mp4">Video</a></video></p>
</figure>
</div>
</section>
<section id="pose-estimation" class="level4">
<h4 class="anchored" data-anchor-id="pose-estimation">Pose Estimation</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><video src="./videos/multipose-demo-1.mp4" class="img-fluid" controls=""><a href="./videos/multipose-demo-1.mp4">Video</a></video></p>
</figure>
</div>
</section>
<section id="object-detection" class="level4">
<h4 class="anchored" data-anchor-id="object-detection">Object Detection</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><video src="./videos/HaGRID-demo.mp4" class="img-fluid" controls=""><a href="./videos/HaGRID-demo.mp4">Video</a></video></p>
</figure>
</div>
<p>These examples only scratch the surface of what’s possible by combining deep learning models with powerful real-time creation tools like Unity and <a href="https://www.unrealengine.com/en-US">Unreal Engine</a>. The Barracuda library makes it easy to start exploring these possibilities.</p>
</section>
</section>
<section id="the-barracuda-library" class="level2">
<h2 class="anchored" data-anchor-id="the-barracuda-library">The Barracuda Library</h2>
<p><a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/manual/index.html">Barracuda</a> is a neural network inference library for the Unity game engine. It initially focused on models trained with Unity’s Deep Reinforcement Learning toolkit, <a href="https://github.com/Unity-Technologies/ml-agents">ML-Agents</a>, but has expanded support over time.</p>
<p>Barracuda provides <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.WorkerFactory.Type.html">multiple</a> backends for both CPU and GPU inference. The fastest CPU backend uses the <a href="https://docs.unity3d.com/Packages/com.unity.burst@1.7/manual/index.html">Burst compiler</a>, which translates IL/.NET bytecode into highly-optimized native code using <a href="https://llvm.org/">LLVM</a>. The most performant GPU backend uses <a href="https://docs.unity3d.com/Manual/class-ComputeShader.html">Compute shaders</a>. Compute shaders are programs written in <a href="https://docs.microsoft.com/en-us/windows/win32/direct3dhlsl/dx-graphics-hlsl?redirectedfrom=MSDN">High-level shader language (HLSL)</a> that run on the GPU, outside the standard <a href="https://docs.unity3d.com/Manual/Glossary.html#Renderpipeline">rendering pipeline</a>.</p>
<p>Some platforms don’t support Compute shaders, so Unity recently added a Pixel Shader backend to enable GPU inference on platforms where Compute shaders are not supported. While faster than CPU inference, it is significantly slower than the Compute shader backend in my testing.</p>
<p>One of Barracuda’s greatest strengths is its cross-platform support. As of writing, Barracuda does not support specialized inference hardware, quantization, or even FP16 precision. However, it runs wherever Unity does, which is <a href="https://support.unity.com/hc/en-us/articles/206336795-What-platforms-are-supported-by-Unity-">nearly everywhere</a>.</p>
</section>
<section id="exporting-models-to-onnx" class="level2">
<h2 class="anchored" data-anchor-id="exporting-models-to-onnx">Exporting Models to ONNX</h2>
<p>Barracuda works with models in the <a href="https://onnx.ai/">ONNX</a> file format. PyTorch provides <a href="https://pytorch.org/docs/stable/onnx.html">built-in support</a> to export models to ONNX.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>torch.onnx.export(learn.model.cpu(),</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                  batched_tensor,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                  onnx_file_name,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                  export_params<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                  opset_version<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                  do_constant_folding<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                  input_names <span class="op">=</span> [<span class="st">'input'</span>],</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                  output_names <span class="op">=</span> [<span class="st">'output'</span>],</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                 )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can use the <a href="https://github.com/onnx/tensorflow-onnx">tf2onnx</a> python package to convert TensorFlow models.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> tf2onnx.convert <span class="at">--saved-model</span> ./savedmodel <span class="at">--opset</span> 10 <span class="at">--output</span> model.onnx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Barracuda maps <a href="https://github.com/onnx/onnx/blob/main/docs/Operators.md">ONNX operators</a> to backend-specific implementations, so model support depends on what operators Unity <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/manual/SupportedOperators.html">implements</a> for a given inference backend. One could theoretically implement missing operations themselves, but it would probably make more sense to explore other inference options at that point. Another option is to tweak the model architecture to ensure it only uses supported operations.</p>
</section>
<section id="loading-models" class="level2">
<h2 class="anchored" data-anchor-id="loading-models">Loading Models</h2>
<p>Unity imports ONNX models as an <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.NNModel.html">NNModel</a> asset.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">Tooltip</span><span class="op">(</span><span class="st">"The Barracuda/ONNX asset file"</span><span class="op">)]</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> NNModel modelAsset<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These then compile into a <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.Model.html#methods">Model</a> object at runtime.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get an object oriented representation of the model</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>m_RunTimeModel <span class="op">=</span> ModelLoader<span class="op">.</span><span class="fu">Load</span><span class="op">(</span>modelAsset<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="executing-models" class="level2">
<h2 class="anchored" data-anchor-id="executing-models">Executing Models</h2>
<p>Barracuda has an <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.IWorker.html">IWorker</a> interface that abstracts implementation details for different inference backends. It is responsible for translating the <code>Model</code> object into a set of operations and executing them.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a worker to execute the model using the selected backend</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>IWorker engine <span class="op">=</span> WorkerFactory<span class="op">.</span><span class="fu">CreateWorker</span><span class="op">(</span>workerType<span class="op">,</span> m_RunTimeModel<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Barracuda can run models in a single frame or across multiple using <a href="https://docs.unity3d.com/Manual/Coroutines.html">Coroutines</a>. The latter option can help maintain smooth frame rates when using more demanding models.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Execute the model with the input Tensor</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>engine<span class="op">.</span><span class="fu">Execute</span><span class="op">(</span>input<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="working-with-data" class="level2">
<h2 class="anchored" data-anchor-id="working-with-data">Working with Data</h2>
<p>Barracuda stores data in multi-dimensional array-like objects called <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.Tensor.html">Tensors</a>.</p>
<section id="initializing-tensors" class="level3">
<h3 class="anchored" data-anchor-id="initializing-tensors">Initializing Tensors</h3>
<p>We can initialize an input Tensor from an array for CPU data, a <a href="https://docs.unity3d.com/ScriptReference/ComputeBuffer.html">ComputeBuffer</a> for general GPU data, or a <a href="https://docs.unity3d.com/ScriptReference/Texture2D.html">Texture2D</a> or <a href="https://docs.unity3d.com/ScriptReference/RenderTexture.html">RenderTexture</a> for image data.</p>
<p><strong>Initialize from an array</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Normal single-dimensional array</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span><span class="op">[]</span> tensorData <span class="op">=</span> <span class="kw">new</span> <span class="dt">float</span><span class="op">[]</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    0f<span class="op">,</span> 1f<span class="op">,</span> 2f<span class="op">,</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    3f<span class="op">,</span> 4f<span class="op">,</span> 5f<span class="op">,</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    6f<span class="op">,</span> 7f<span class="op">,</span> 8f </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>Tensor tensor <span class="op">=</span> <span class="kw">new</span> <span class="fu">Tensor</span><span class="op">(</span>n<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> h<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> w<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> c<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> tensorData<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Initialize from image data</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize a Tensor using the inputTexture</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>Tensor input <span class="op">=</span> <span class="kw">new</span> <span class="fu">Tensor</span><span class="op">(</span>inputTexture<span class="op">,</span> channels<span class="op">:</span> <span class="dv">3</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="accessing-tensor-elements" class="level3">
<h3 class="anchored" data-anchor-id="accessing-tensor-elements">Accessing Tensor Elements</h3>
<p>We can <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/manual/TensorHandling.html#data-access">access</a> Tensor elements using multi-dimensional array operators.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Normal single-dimensional array</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dt">float</span><span class="op">[]</span> tensorData <span class="op">=</span> <span class="kw">new</span> <span class="dt">float</span><span class="op">[]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    0f<span class="op">,</span> 1f<span class="op">,</span> 2f<span class="op">,</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    3f<span class="op">,</span> 4f<span class="op">,</span> 5f<span class="op">,</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    6f<span class="op">,</span> 7f<span class="op">,</span> 8f </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Batch size: 1, Height: 3, Width: 3, Channels: 1</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>Tensor tensor <span class="op">=</span> <span class="kw">new</span> <span class="fu">Tensor</span><span class="op">(</span>n<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> h<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> w<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> c<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> tensorData<span class="op">);</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Tensor shape: {tensor.shape}"</span><span class="op">);</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"First element in flat array: {tensor[0]}"</span><span class="op">);</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Second row, third column: {tensor[0, 1, 2, 0]}"</span><span class="op">);</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>tensor<span class="op">.</span><span class="fu">Dispose</span><span class="op">();</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Batch size: 1, Height: 1, Width: 3, Channels: 3</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>tensor <span class="op">=</span> <span class="kw">new</span> <span class="fu">Tensor</span><span class="op">(</span>n<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> h<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> w<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> c<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> tensorData<span class="op">);</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"Tensor shape: {tensor.shape}"</span><span class="op">);</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"First element in flat array: {tensor[0]}"</span><span class="op">);</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"First row, first column, second channel: {tensor[0, 0, 0, 1]}"</span><span class="op">);</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>Debug<span class="op">.</span><span class="fu">Log</span><span class="op">(</span>$<span class="st">"First row, second column, third channel: {tensor[0, 0, 1, 2]}"</span><span class="op">);</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>tensor<span class="op">.</span><span class="fu">Dispose</span><span class="op">();</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Output</strong></p>
<pre class="text"><code>Tensor shape: (n:1, h:3, w:3, c:1)
First element in flat array: 0
Second row, third column: 5

Tensor shape: (n:1, h:1, w:3, c:3)
First element in flat array: 0
First row, first column, second channel: 1
First row, second column, third channel: 5</code></pre>
</section>
<section id="retrieving-model-output" class="level3">
<h3 class="anchored" data-anchor-id="retrieving-model-output">Retrieving Model Output</h3>
<p>We can download model output to the CPU or copy it to a RenderTexture to keep the data on the GPU, as shown below.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get raw model output</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>Tensor output <span class="op">=</span> engine<span class="op">.</span><span class="fu">PeekOutput</span><span class="op">(</span>outputLayer<span class="op">);</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Copy model output to a RenderTexture</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>output<span class="op">.</span><span class="fu">ToRenderTexture</span><span class="op">(</span>outputTextureGPU<span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Reading model output from the GPU to the CPU causes a <a href="https://en.wikipedia.org/wiki/Pipeline_stall">pipeline stall</a> as Unity prevents any execution on the main thread to prevent the data from changing before it has finished downloading to the CPU. The pipeline stall can cause a noticeable performance bottleneck that increases with the amount of data we need to download.</p>
<p>This performance bottleneck is not an issue when the model output can stay on the GPU like when performing artistic style transfer. However, reading the prediction of a simple image classifier to the CPU can cap GPU utilization from approximately 100% to around 60%.</p>
<section id="standard-gpu-readback" class="level4">
<h4 class="anchored" data-anchor-id="standard-gpu-readback">Standard GPU Readback</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/image-classifier-without-async.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>Fortunately, Unity provides a method to read data from the GPU asynchronously called <a href="https://docs.unity3d.com/ScriptReference/Rendering.AsyncGPUReadback.Request.html">AsyncGPUReadback.Request()</a>. The one drawback to this method is that it adds a few frames of latency. That should not be noticeable as long as the frame rate is high enough.</p>
</section>
<section id="asynchronous-gpu-readback" class="level4">
<h4 class="anchored" data-anchor-id="asynchronous-gpu-readback">Asynchronous GPU Readback</h4>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/image-classifier-with-async.png" class="img-fluid figure-img"></p>
</figure>
</div>
</section>
</section>
<section id="processing-data" class="level3">
<h3 class="anchored" data-anchor-id="processing-data">Processing Data</h3>
<p>We typically need to manually implement preprocessing steps like applying ImageNet normalization to input images. We can implement these preprocessing steps on the CPU using C# scripts or on the GPU using Compute shaders (when supported) or <a href="https://docs.unity3d.com/Manual/SL-VertexFragmentShaderExamples.html">Fragment Shaders</a>. Naturally, we want to perform image preprocessing on the GPU when possible.</p>
<section id="imagenet-normalization-compute-shader" class="level4">
<h4 class="anchored" data-anchor-id="imagenet-normalization-compute-shader">ImageNet Normalization Compute shader</h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Each #kernel tells which function to compile; you can have many kernels</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>#pragma kernel NormalizeImageNet</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">// The pixel data for the input image</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>Texture2D<span class="op">&lt;</span>float4<span class="op">&gt;</span> InputImage<span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">// The pixel data for the processed image</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>RWTexture2D<span class="op">&lt;</span>float4<span class="op">&gt;</span> Result<span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply the ImageNet normalization stats from PyTorch to an image</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">numthreads</span><span class="op">(</span><span class="dv">8</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">1</span><span class="op">)]</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">NormalizeImageNet</span><span class="op">(</span>uint3 id <span class="op">:</span> SV_DispatchThreadID<span class="op">)</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set the pixel color values for the processed image</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    Result<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">]</span> <span class="op">=</span> <span class="fu">float4</span><span class="op">(</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Normalize the red color channel values</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>InputImage<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">].</span><span class="fu">r</span> <span class="op">-</span> <span class="fl">0.4850f</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2290f</span><span class="op">,</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Normalize the green color channel values</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>InputImage<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">].</span><span class="fu">g</span> <span class="op">-</span> <span class="fl">0.4560f</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2240f</span><span class="op">,</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Normalize the blue color channel values</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>InputImage<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">].</span><span class="fu">b</span> <span class="op">-</span> <span class="fl">0.4060f</span><span class="op">)</span> <span class="op">/</span> <span class="fl">0.2250f</span><span class="op">,</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Ignore the alpha/transparency channel</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        InputImage<span class="op">[</span>id<span class="op">.</span><span class="fu">xy</span><span class="op">].</span><span class="fu">a</span><span class="op">);</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can sometimes use Barracuda to handle postprocessing by adding additional layers to the end of models, like Sigmoid, Softmax, and Argmax, <a href="https://docs.unity3d.com/Packages/com.unity.barracuda@3.0/api/Unity.Barracuda.ModelBuilder.html#Unity_Barracuda_ModelBuilder_Upsample2D_System_String_System_Object_Int32___System_Boolean_">at runtime</a>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a model builder to modify the m_RunTimeModel</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ModelBuilder modelBuilder <span class="op">=</span> <span class="kw">new</span> <span class="fu">ModelBuilder</span><span class="op">(</span>m_RunTimeModel<span class="op">);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a new Softmax layer</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>modelBuilder<span class="op">.</span><span class="fu">Softmax</span><span class="op">(</span>softmaxLayer<span class="op">,</span> outputLayer<span class="op">);</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a new Argmax layer</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>modelBuilder<span class="op">.</span><span class="fu">Reduce</span><span class="op">(</span>Layer<span class="op">.</span><span class="fu">Type</span><span class="op">.</span><span class="fu">ArgMax</span><span class="op">,</span> argmaxLayer<span class="op">,</span> softmaxLayer<span class="op">);</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a worker to execute the model using the selected backend</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>IWorker engine <span class="op">=</span> WorkerFactory<span class="op">.</span><span class="fu">CreateWorker</span><span class="op">(</span>workerType<span class="op">,</span> modelBuilder<span class="op">.</span><span class="fu">model</span><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Otherwise, we need to implement those manually as well.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c# code-with-copy"><code class="sourceCode cs"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get raw model output</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>Tensor output <span class="op">=</span> engine<span class="op">.</span><span class="fu">PeekOutput</span><span class="op">(</span>outputLayer<span class="op">);</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize vector for coordinates</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>Vector2 coords <span class="op">=</span> <span class="kw">new</span> <span class="fu">Vector2</span><span class="op">();</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Process estimated point coordinates</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> output<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    coords<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">((</span>output<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="op">)</span> <span class="op">*</span> inputDims<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> <span class="op">(</span>imageDims<span class="op">[</span>i<span class="op">]</span> <span class="op">/</span> inputDims<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This post introduced the Barracuda inference library for the Unity game engine. Barracuda is not the only option to perform inference in Unity, but it provides a good starting point. A follow-up tutorial series will walk through training a model using the <a href="https://docs.fast.ai/">fastai library</a>, exporting it to ONNX format, and performing inference with it in a Unity project using the Barracuda library.</p>
<p><strong>Next:</strong> <a href="../fastai-to-unity-tutorial/part-1/">Fastai to Unity Tutorial Pt. 1</a></p>
<!-- Cloudflare Web Analytics -->
<script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;56b8d2f624604c4891327b3c0d9f6703&quot;}"></script>
<!-- End Cloudflare Web Analytics -->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="cj-mills/christianjmills" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item">
 Copyright 2022, Christian J. Mills
  </li>  
</ul>
      </div>
  </div>
</footer>



</body></html>