<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Christian Mills</title>
<link>https://christianjmills.com/blog.html</link>
<atom:link href="https://christianjmills.com/blog.xml" rel="self" type="application/rss+xml"/>
<description>This is Christian Mills&#39; personal website.</description>
<image>
<url>https://christianjmills.com/images/logo.png</url>
<title>Christian Mills</title>
<link>https://christianjmills.com/blog.html</link>
<height>144</height>
<width>144</width>
</image>
<generator>quarto-1.4.555</generator>
<lastBuildDate>Sun, 15 Sep 2024 07:00:00 GMT</lastBuildDate>
<item>
  <title>CUDA MODE Lecture 10: Build a Prod Ready CUDA library</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/lecture-010/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<ul>
<li>Introduction<br>
</li>
<li>Relevant CUDA Concepts</li>
<li>The CUDA Ninja’s Motivation: Why Create Libraries?</li>
<li>Automatic TV: Understanding the Application and its Challenges</li>
<li>Library Challenges: Abstraction vs.&nbsp;Performance</li>
<li>Use Case 1: GPU Communication Manager<br>
</li>
<li>Use Case 2: CUDA Layers for Image Preprocessing</li>
<li>Conclusion and Future Directions</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Resource Links:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Resource Links:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube Recording:</strong> <a href="https://www.youtube.com/watch?v=FHsEW0HpuoU">Lecture 10: Build a Prod Ready CUDA library</a></li>
<li><strong>Slides:</strong> <a href="https://drive.google.com/drive/folders/158V8BzGj-IkdXXDAdHPNwUzDLNmr971_">Lecture 10: Building production ready CUDA libraries</a></li>
</ul>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<section id="speaker-introduction" class="level3">
<h3 class="anchored" data-anchor-id="speaker-introduction">Speaker Introduction</h3>
<ul>
<li><strong>Oscar Amoros Huguet</strong>: Professional CUDA developer and active community member.</li>
<li><strong>Background</strong>:
<ul>
<li>Started with OpenCL for processing 3D volumes (wave propagation simulation and medical imaging).</li>
<li>Worked with Barcelona Supercomputing Center on <a href="https://pm.bsc.es/ompss">OmpSs</a> (cluster programming abstraction).</li>
<li>Taught OpenSphere Encoder and computer science topics at the University of Barcelona.</li>
<li>Co-authored papers on OpenCL and related topics.</li>
<li>Created “Simple OpenCL” library (linked by Khronos Group).</li>
<li>Ported <a href="https://github.com/boostorg/compute">Boost Compute</a>’s OpenCL code to HSAIL (GPU assembly).</li>
<li>Currently works at Mediapro on <a href="https://automatic.tv/">Automatic TV</a>, a soft real-time C++ and CUDA-based application.</li>
</ul></li>
</ul>
</section>
<section id="lecture-structure" class="level3">
<h3 class="anchored" data-anchor-id="lecture-structure">Lecture Structure</h3>
<ul>
<li><strong>Review of Relevant CUDA Concepts</strong>: GPU communication, streams, latency hiding, kernel fusion.</li>
<li><strong>The CUDA Ninja’s Motivation for Library Creation</strong>: Addressing practical challenges in a production environment.</li>
<li><strong>Use Cases</strong>:
<ul>
<li><strong>GPU Communication Manager</strong>: Optimizing data transfer between different memory spaces.</li>
<li><strong>CUDA Layers for Image Preprocessing</strong>: Accelerating common image processing operations for tasks like neural network inference.</li>
</ul></li>
<li><strong>Open Source Project</strong>: Discussion of an open-source CUDA library project.</li>
</ul>
</section>
</section>
<section id="relevant-cuda-concepts" class="level2">
<h2 class="anchored" data-anchor-id="relevant-cuda-concepts">Relevant CUDA Concepts</h2>
<ul>
<li><strong>Focus</strong>: Host-side optimization for real-world applications.</li>
<li><strong>Tools</strong>: <strong>NVIDIA Nsight Systems</strong> for profiling and identifying bottlenecks.</li>
<li><strong>Key Concepts</strong>:
<ul>
<li><strong>GPU Memory Copies (<code>cudaMemcpyAsync</code>)</strong>: Data transfer between CPU and GPU or between GPUs.</li>
<li><strong>CUDA Streams</strong>: Enabling asynchronous execution of kernels and memory copies.</li>
<li><strong>Latencies and Latency Hiding</strong>: Overlapping computation and data transfer to minimize idle time.</li>
<li><strong>Kernel Fusion (Vertical and Horizontal)</strong>: Combining multiple kernels to reduce overhead.</li>
<li><strong>Memory-Bound Kernels</strong>: Performance limited by memory bandwidth.</li>
<li><strong>Compute-Bound Kernels</strong>: Performance limited by computational capacity.</li>
</ul></li>
</ul>
</section>
<section id="the-cuda-ninjas-motivation-why-create-libraries" class="level2">
<h2 class="anchored" data-anchor-id="the-cuda-ninjas-motivation-why-create-libraries">The CUDA Ninja’s Motivation: Why Create Libraries?</h2>
<ul>
<li><strong>Initial Expectations (Ideal Scenario)</strong>:
<ul>
<li>Bug-free, well-tested CPU code.</li>
<li>Unit tests for performance benchmarking and validation.</li>
</ul></li>
<li><strong>Reality in a Startup Environment</strong>:
<ul>
<li><strong>Collaboration with Non-CUDA Experts</strong>: Computer vision specialists, C++ application developers, etc.</li>
<li><strong>Need for Real-Time Prototyping</strong>: Enabling quick iteration and testing of computer vision algorithms.</li>
<li><strong>Performance Bottlenecks in Production</strong>: Handling larger datasets and multiple cameras demanded further optimization beyond initial prototypes.</li>
<li><strong>QA and Performance Measurement</strong>: Establishing performance benchmarks and cost goals.</li>
</ul></li>
<li><strong>The Need for Automation</strong>: Repetitive optimization tasks and the desire to empower non-CUDA programmers led to the idea of creating libraries and abstractions.</li>
</ul>
</section>
<section id="automatic-tv-understanding-the-application-and-its-challenges" class="level2">
<h2 class="anchored" data-anchor-id="automatic-tv-understanding-the-application-and-its-challenges">Automatic TV: Understanding the Application and its Challenges</h2>
<ul>
<li><strong>Automatic TV</strong>: A software for automated sports recording that tracks the game and provides dynamic camera views.</li>
<li><strong>Functionality</strong>:
<ul>
<li>Uses multiple fixed 4K cameras as input.</li>
<li>Stitches camera feeds to create a seamless panoramic view.</li>
<li>Employs AI (computer vision and neural networks) for player tracking, object detection, and camera switching.</li>
<li>Generates a Full HD output video with enhanced image quality and features (scoreboard overlays, etc.).</li>
</ul></li>
<li><strong>Performance Challenges</strong>:
<ul>
<li><strong>Real-time/Soft Real-time Processing</strong>: Maintaining a smooth output video with minimal delay.</li>
<li><strong>Multi-GPU Support</strong>: Distributing the processing workload across up to three GPUs for increased throughput.</li>
<li><strong>Efficient GPU Communication</strong>: Minimizing the overhead of data transfer between GPUs and the CPU.</li>
</ul></li>
</ul>
</section>
<section id="library-challenges-abstraction-vs.-performance" class="level2">
<h2 class="anchored" data-anchor-id="library-challenges-abstraction-vs.-performance">Library Challenges: Abstraction vs.&nbsp;Performance</h2>
<ul>
<li><strong>Key Challenges</strong>:
<ul>
<li><strong>Performance</strong>: Achieving optimal performance comparable to hand-tuned CUDA code.</li>
<li><strong>Abstraction</strong>: Hiding CUDA complexities and providing an easy-to-use interface for non-CUDA programmers.</li>
<li><strong>Balancing Abstraction and Performance</strong>: Finding the right level of abstraction that simplifies usage without significantly sacrificing performance.</li>
<li><strong>User Requirements</strong>: Understanding the target users’ needs and preferences (level of CUDA knowledge, performance expectations, etc.).</li>
<li><strong>API Design</strong>: Creating an intuitive and familiar API that integrates seamlessly with existing workflows.</li>
</ul></li>
</ul>
</section>
<section id="use-case-1-gpu-communication-manager" class="level2">
<h2 class="anchored" data-anchor-id="use-case-1-gpu-communication-manager">Use Case 1: GPU Communication Manager</h2>
<section id="problem-definition-efficient-data-transfer" class="level3">
<h3 class="anchored" data-anchor-id="problem-definition-efficient-data-transfer">Problem Definition: Efficient Data Transfer</h3>
<ul>
<li><strong>Goal</strong>: Create a system for efficient data transfer (e.g., images) between different memory spaces (CPU, GPU, CPU pinned memory).</li>
<li><strong>Memory Spaces</strong>:
<ul>
<li><strong>CPU Memory</strong>: Standard system RAM.</li>
<li><strong>GPU Memory</strong>: Dedicated memory on the graphics card.</li>
<li><strong>CPU Pinned Memory</strong>: A special type of CPU memory that can be directly accessed by the GPU, eliminating the need for an intermediate copy.</li>
</ul></li>
<li><strong>CUDA memcpy</strong>: The standard CUDA function for transferring data between memory spaces.</li>
</ul>
</section>
<section id="requirements-and-considerations" class="level3">
<h3 class="anchored" data-anchor-id="requirements-and-considerations">Requirements and Considerations</h3>
<ul>
<li><strong>Zero Allocation During Runtime</strong>: Allocate all necessary memory upfront to avoid blocking CPU threads during real-time processing.</li>
<li><strong>Handling Same Memory Space Transfers</strong>: Optimize for cases where the source and destination memory spaces are the same, avoiding unnecessary copies.</li>
<li><strong>Minimizing CPU Thread Blocking</strong>: Ensure the CPU thread responsible for scheduling CUDA work remains responsive and is not blocked by memory operations.</li>
</ul>
</section>
<section id="memory-space-combinations-and-copy-strategies" class="level3">
<h3 class="anchored" data-anchor-id="memory-space-combinations-and-copy-strategies">Memory Space Combinations and Copy Strategies</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 14%">
<col style="width: 30%">
<col style="width: 10%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th>Source Memory Space</th>
<th>Destination Memory Space</th>
<th>Desired Copies</th>
<th>CUDA memcpy Strategy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CPU</td>
<td>CPU</td>
<td>0</td>
<td>No copy</td>
</tr>
<tr class="even">
<td>CPU Pinned</td>
<td>CPU Pinned</td>
<td>0</td>
<td>No copy</td>
</tr>
<tr class="odd">
<td>GPU</td>
<td>GPU</td>
<td>0</td>
<td>No copy</td>
</tr>
<tr class="even">
<td>CPU</td>
<td>CPU Pinned</td>
<td>1</td>
<td><code>cudaMemcpyHostToHost</code></td>
</tr>
<tr class="odd">
<td>CPU Pinned</td>
<td>CPU</td>
<td>1</td>
<td><code>cudaMemcpyHostToHost</code></td>
</tr>
<tr class="even">
<td>CPU</td>
<td>GPU</td>
<td>2</td>
<td><code>cudaMemcpyHostToHost</code> (CPU to CPU Pinned) followed by <code>cudaMemcpyHostToDevice</code></td>
</tr>
<tr class="odd">
<td>GPU</td>
<td>CPU</td>
<td>2</td>
<td><code>cudaMemcpyDeviceToHost</code> followed by <code>cudaMemcpyHostToHost</code> (CPU Pinned to CPU)</td>
</tr>
<tr class="even">
<td>CPU Pinned</td>
<td>GPU</td>
<td>1</td>
<td><code>cudaMemcpyHostToDevice</code></td>
</tr>
<tr class="odd">
<td>GPU</td>
<td>CPU Pinned</td>
<td>1</td>
<td><code>cudaMemcpyDeviceToHost</code></td>
</tr>
<tr class="even">
<td>GPU</td>
<td>GPU (Same Device)</td>
<td>0</td>
<td>No copy</td>
</tr>
<tr class="odd">
<td>GPU</td>
<td>GPU (Different Devices, Peer-to-Peer)</td>
<td>1</td>
<td><code>cudaMemcpyPeerAsync</code> (if supported)</td>
</tr>
<tr class="even">
<td>GPU</td>
<td>GPU (Different Devices, No Peer-to-Peer)</td>
<td>2</td>
<td><code>cudaMemcpyDeviceToHost</code> followed by <code>cudaMemcpyHostToDevice</code></td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Peer-to-Peer Communication</strong>: Direct data transfer between GPU memories without involving the CPU, achievable through NVLink or PCI Express (if supported by the hardware and drivers).</li>
<li><strong>Manual Pinned Memory Allocation</strong>: Bypassing CUDA runtime’s automatic pinned memory allocation to prevent CPU thread blocking.</li>
</ul>
</section>
<section id="overcoming-sequential-data-transfer-bottlenecks" class="level3">
<h3 class="anchored" data-anchor-id="overcoming-sequential-data-transfer-bottlenecks">Overcoming Sequential Data Transfer Bottlenecks</h3>
<ul>
<li><strong>Problem</strong>: Sequential memory copies and kernel launches introduce significant delays in a multi-GPU pipeline.</li>
<li><strong>Solution</strong>: Introduce <strong>delays (buffers)</strong> and utilize <strong>CUDA streams</strong> to enable <strong>parallel execution</strong> of kernels and memory transfers.</li>
</ul>
</section>
<section id="producer-consumer-model" class="level3">
<h3 class="anchored" data-anchor-id="producer-consumer-model">Producer-Consumer Model</h3>
<ul>
<li><strong>Traditional CPU-Based Model</strong>:
<ul>
<li><strong>Producer</strong>: A thread that generates data and writes it to a shared buffer.</li>
<li><strong>Consumer</strong>: A thread that reads and processes data from the shared buffer.</li>
<li><strong>Buffer</strong>: Manages access to the shared data, ensuring thread safety.</li>
</ul></li>
<li><strong>Key Features</strong>:
<ul>
<li><strong>Task Parallelism</strong>: Producer and consumer can operate concurrently.</li>
<li><strong>Variable Buffer Size</strong>: Adjusts to fluctuations in producer and consumer execution times.</li>
</ul></li>
</ul>
</section>
<section id="adapting-producer-consumer-for-gpu-communication" class="level3">
<h3 class="anchored" data-anchor-id="adapting-producer-consumer-for-gpu-communication">Adapting Producer-Consumer for GPU Communication</h3>
<ul>
<li><p><strong>Iterative Memory Manager</strong>: A specialized buffer designed for GPU communication in iterative applications.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-010/images/producer-consumer-gpu-diagram.png" class="img-fluid figure-img"></p>
<figcaption>Slide 24</figcaption>
</figure>
</div></li>
<li><p><strong>Key Features</strong>:</p>
<ul>
<li><strong>Iteration-Based Synchronization</strong>: All asynchronous operations (kernels and copies) are synchronized at the end of each iteration.</li>
<li><strong>Ping-Pong Buffers</strong>: Utilizes at least two pointers (memory regions) to enable concurrent reading and writing.</li>
</ul></li>
<li><p><strong>Example</strong>:</p>
<ul>
<li>A kernel writes its output to a pointer in the manager.</li>
<li>A copy operation transfers data from that pointer to another pointer in a different memory space.</li>
<li>Another kernel reads from the second pointer.</li>
<li>Pointers are swapped at the end of each iteration to ensure continuous data flow.</li>
</ul></li>
</ul>
</section>
<section id="delay-buffers-and-optimizing-memory-manager" class="level3">
<h3 class="anchored" data-anchor-id="delay-buffers-and-optimizing-memory-manager">Delay Buffers and Optimizing Memory Manager</h3>
<ul>
<li><strong>Delay Buffer</strong>: A buffer that introduces a fixed delay in the data flow.</li>
<li><strong>Optimization</strong>: When a delay buffer is used, the memory manager can directly access data from the delay buffer’s pointer, eliminating the need for an extra copy.</li>
<li><strong>Example</strong>:
<ul>
<li>A kernel writes to a delay buffer.</li>
<li>Instead of copying from the kernel’s output to the memory manager, the manager directly reads from the delay buffer after the specified delay.</li>
</ul></li>
</ul>
</section>
<section id="provider-taker-model-an-abstraction-for-memory-management" class="level3">
<h3 class="anchored" data-anchor-id="provider-taker-model-an-abstraction-for-memory-management">Provider-Taker Model: An Abstraction for Memory Management</h3>
<ul>
<li><strong>Motivation</strong>: Introduce a new abstraction to simplify the interaction with the memory manager.</li>
<li><strong>Key Concepts</strong>:
<ul>
<li><strong>Taking</strong>: Requesting a pointer from the memory manager (the manager allocates and owns the pointer).</li>
<li><strong>Providing</strong>: Supplying a pointer to the memory manager (the caller allocates and owns the pointer).</li>
</ul></li>
<li><strong>Ownership</strong>:
<ul>
<li>Taking: The memory manager owns the pointer.</li>
<li>Providing: The caller owns the pointer.</li>
</ul></li>
<li><strong>Difference from Producer-Consumer</strong>:
<ul>
<li>Producer-Consumer focuses on data movement.</li>
<li>Provider-Taker focuses on pointer ownership and allocation responsibility.</li>
</ul></li>
</ul>
</section>
<section id="iterative-memory-manager-interface" class="level3">
<h3 class="anchored" data-anchor-id="iterative-memory-manager-interface">Iterative Memory Manager Interface</h3>
<ul>
<li><p><strong>Data Structure</strong>: Define a class representing the data to be transferred.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">struct</span> DataInfo <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb1-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> numElements<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> elemSizeInBytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-4">  MemorySpace memSpace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div>
<ul>
<li>Includes information like width, height, and memory space.</li>
</ul></li>
<li><p><strong>Producer/Consumer Roles</strong>: Define an enum to specify whether the producer and consumer will take or provide pointers:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">enum</span> Actions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span> ProducerProvides<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ProducerTakes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ConsumerProvides<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ConsumerTakes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span></code></pre></div></li>
<li><p><strong>Memory Manager Initialization</strong>:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1">DataInfo producerDataInfo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> HostPageable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-2">DataInfo consumerDataInfo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> Device_1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">};</span></span>
<span id="cb3-3"></span>
<span id="cb3-4">Data ptrToProduce<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>producerDataInfo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-5">Data ptrToConsume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>consumerDataInfo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//Initialization</span></span>
<span id="cb3-8">MemoryManager<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>ProducerProvides<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ConsumerProvides<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> manager<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>producerDataInfo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> consumerDataInfo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span></code></pre></div></li>
<li><p><strong>Managing Data Transfer</strong>:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> delay <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> manager<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>getTotalDelay<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Query delay generated by the manager</span></span>
<span id="cb4-2"></span>
<span id="cb4-3">manager<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>manage<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>ptrToProduce<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> ptrToConsume<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Usage</span></span></code></pre></div></li>
<li><p><strong>Understanding Provide and Take</strong>:</p>
<ul>
<li><strong>Provide</strong>: Pass data structures as arguments to <code>manage()</code>. The caller is responsible for allocating these data structures.</li>
<li><strong>Take</strong>: The <code>manage()</code> function returns pointers to data structures allocated by the manager.</li>
</ul></li>
</ul>
</section>
<section id="memory-manager-configurations" class="level3">
<h3 class="anchored" data-anchor-id="memory-manager-configurations">Memory Manager Configurations</h3>
<ul>
<li><strong>Four Possible Configurations</strong>:
<ul>
<li><strong>Take-Take</strong>: Producer and consumer both take pointers from the manager.</li>
<li><strong>Provide-Provide</strong>: Producer and consumer both provide pointers to the manager.</li>
<li><strong>Take-Provide</strong>: Producer takes a pointer, consumer provides a pointer.</li>
<li><strong>Provide-Take</strong>: Producer provides a pointer, consumer takes a pointer.</li>
</ul></li>
<li><strong>Memory Space Awareness</strong>: The memory manager automatically handles copies based on the specified memory spaces of the producer and consumer data.</li>
<li><strong>Zero-Copy Optimization</strong>: If the source and destination memory spaces are the same, the manager performs no copy and simply forwards the pointer.</li>
</ul>
</section>
<section id="example-memory-manager-with-a-delay-buffer" class="level3">
<h3 class="anchored" data-anchor-id="example-memory-manager-with-a-delay-buffer">Example: Memory Manager with a Delay Buffer</h3>
<ul>
<li><strong>Scenario</strong>:
<ul>
<li>A kernel writes to a buffer.</li>
<li>A delay buffer stores the kernel’s output.</li>
<li>Another kernel reads from the delay buffer after a fixed delay.</li>
</ul></li>
<li><strong>Memory Manager Configuration</strong>: Take-Provide (producer takes, consumer provides).</li>
<li><strong>Zero-Copy Optimization</strong>: If the delay buffer and the consumer kernel are in the same memory space, no copy is performed.</li>
</ul>
</section>
<section id="timeline-analysis-achieving-parallelism" class="level3">
<h3 class="anchored" data-anchor-id="timeline-analysis-achieving-parallelism">Timeline Analysis: Achieving Parallelism</h3>
<ul>
<li><strong>Multi-GPU Pipeline with Delay Buffers</strong>:
<ul>
<li>Kernels on different GPUs execute in parallel.</li>
<li>Memory transfers are overlapped with computation using CUDA streams.</li>
</ul></li>
<li><strong>Benefits</strong>:
<ul>
<li>Maximizes GPU utilization.</li>
<li>Reduces overall processing time.</li>
</ul></li>
</ul>
</section>
<section id="real-world-application-automatic-tvs-gpu-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="real-world-application-automatic-tvs-gpu-pipeline">Real-World Application: Automatic TV’s GPU Pipeline</h3>
<ul>
<li><p><strong>Automatic TV’s Implementation</strong>:</p>
<ul>
<li><strong>GPU 0</strong>: Camera input processing, data transfer to CPU.</li>
<li><strong>GPU 1</strong>: AI processing (computer vision, neural networks).</li>
<li><strong>GPU 2</strong>: Output processing, data transfer to CPU for encoding.</li>
</ul></li>
<li><p><strong>NVIDIA Nsight Systems Analysis</strong>: Demonstrates efficient parallelism between compute and data transfer operations.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-010/images/nsight-system-analysis.png" class="img-fluid figure-img"></p>
<figcaption>Slide 45</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-010/images/gpu-usage-diagram.png" class="img-fluid figure-img"></p>
<figcaption>Slide 45</figcaption>
</figure>
</div></li>
</ul>
</section>
<section id="potential-application-multi-gpu-neural-network-training" class="level3">
<h3 class="anchored" data-anchor-id="potential-application-multi-gpu-neural-network-training">Potential Application: Multi-GPU Neural Network Training</h3>
<ul>
<li><strong>Proposed Idea</strong>: Apply the Iterative Memory Manager concept to multi-GPU neural network training.</li>
<li><strong>Potential Benefits</strong>:
<ul>
<li>Parallelize forward and backward passes across multiple GPUs.</li>
<li>Overlap computation with data transfer of intermediate results.</li>
</ul></li>
<li><strong>Challenges</strong>:
<ul>
<li>Requires sufficient GPU memory to store multiple copies of intermediate data.</li>
<li>Complexity of integrating with existing training frameworks.</li>
</ul></li>
</ul>
</section>
</section>
<section id="use-case-2-cuda-layers-for-image-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="use-case-2-cuda-layers-for-image-preprocessing">Use Case 2: CUDA Layers for Image Preprocessing</h2>
<ul>
<li><p><strong>Problem</strong>: Accelerate common image preprocessing operations for tasks like neural network inference.</p></li>
<li><p><strong>GitHub Project:</strong> <a href="https://github.com/morousg/cvGPUSpeedup">cvGPUSpeedup</a></p></li>
<li><p><strong>OpenCV CUDA vs.&nbsp;Custom CUDA Layer</strong>:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// OpenCV version</span></span>
<span id="cb5-2">cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>cuda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>crop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> d_up<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> targetRes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>INTER_LINEAR<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cv_stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-3">d_up<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>convertTo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CV_32FC3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cv_stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-4"></span>
<span id="cb5-5">cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>cuda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>subtract<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> val_sub<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_temp2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>noArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(),</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cv_stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-6">cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>cuda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>divide<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_temp2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> val_div<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cv_stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-7"></span>
<span id="cb5-8">cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>cuda<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_temp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cv_stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-9"></span>
<span id="cb5-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// cvGPUSpeedup version</span></span>
<span id="cb5-11">cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>Scalar val_alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb5-12">cvGS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>executeOperations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>cv_stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-13">    cvGS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>resize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CV_8UC3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>INTER_LINEAR<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>crop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> targetRes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb5-14">    cvGS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>convertTo<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CV_8UC3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> CV_32FC3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(),</span></span>
<span id="cb5-15">    cvGS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>multiply<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CV_32FC3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>val_alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb5-16">    cvGS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>subtract<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CV_32FC3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>val_sub<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb5-17">    cvGS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>divide<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CV_32FC3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>val_div<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span></span>
<span id="cb5-18">    cvGS<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>CV_32FC3<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span></code></pre></div>
<ul>
<li>OpenCV CUDA provides individual functions for operations like cropping, resizing, and color conversion.</li>
<li>The custom CUDA layer fuses these operations into a single kernel, reducing overhead and improving performance.</li>
</ul></li>
<li><p><strong>Performance Gains</strong>: Significant speedups (e.g., 167x) achieved by fusing operations and optimizing memory access.</p></li>
<li><p><strong>Section cut short due to time constraints for the live-stream.</strong></p></li>
</ul>
</section>
<section id="conclusion-and-future-directions" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-and-future-directions">Conclusion and Future Directions</h2>
<ul>
<li><strong>Key Takeaways</strong>:
<ul>
<li>Libraries can significantly improve CUDA development by optimizing performance and providing abstractions for non-CUDA programmers.</li>
<li>The Iterative Memory Manager is a powerful tool for managing data transfer in multi-GPU pipelines.</li>
<li>CUDA layers can accelerate common image processing tasks, particularly beneficial for neural network inference.</li>
</ul></li>
<li><strong>Future Work</strong>:
<ul>
<li>Explore the application of the Iterative Memory Manager to multi-GPU neural network training.</li>
<li>Further develop and refine the open-source CUDA layer library for image preprocessing.</li>
<li>Improve the abstraction and usability of the libraries to make them more accessible to a wider audience.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/lecture-010/</guid>
  <pubDate>Sun, 15 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>CUDA MODE Lecture 9: Reductions</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/lecture-009/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<ul>
<li>Introduction</li>
<li>Examples of Reductions</li>
<li>Reductions in Machine Learning</li>
<li>Implementing Reductions in PyTorch</li>
<li>Serial Reduction</li>
<li>Parallel Reduction Algorithm</li>
<li>Non-Determinism in Floating-Point Reductions</li>
<li>Implementing Parallel Reduction in CUDA<br>
</li>
<li>Reductions in Machine Learning Frameworks<br>
</li>
<li>Conclusion</li>
<li>Call to Action</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Resource Links:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Resource Links:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube Recording:</strong> <a href="https://www.youtube.com/watch?v=09wntC6BT5o">Lecture 9: Reductions</a></li>
<li><strong>Slides:</strong> <a href="https://docs.google.com/presentation/d/1s8lRU8xuDn-R05p1aSP6P7T5kk9VYnDOCyN5bWKeg3U/edit#slide=id.p">Lecture 9: Reductions</a></li>
<li><strong>Code:</strong> <a href="https://github.com/cuda-mode/lectures/tree/main/lecture_009">lecture_009</a></li>
<li><strong>Lightning AI Studio:</strong> <a href="https://lightning.ai/msaroufim/studios/cuda-mode-lectures?section=featured&amp;query=cuda+mode">CUDA Mode Lectures</a></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled" title="[Local NCU Permissions](https://developer.nvidia.com/nvidia-development-tools-solutions-err_nvgpuctrperm-permission-issue-performance-counters)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<a href="https://developer.nvidia.com/nvidia-development-tools-solutions-err_nvgpuctrperm-permission-issue-performance-counters">Local NCU Permissions</a>
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Allow access for any user (restart required)</span></span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'options nvidia NVreg_RestrictProfilingToAdminUsers=0'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tee /etc/modprobe.d/ncu-permissions.conf</span></code></pre></div>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li><p>This lecture covers <strong>reductions</strong>, a core concept in GPU programming and machine learning.</p></li>
<li><p>Previous lectures (1-8) provided the foundational knowledge to author, integrate, profile, and ship CUDA/Triton kernels in PyTorch.</p></li>
<li><p>This lecture aligns with Chapter 10 of the PMPP book and includes example kernels available on GitHub.</p></li>
<li><p><strong>Reductions</strong> are mathematical operations that reduce the size of input data, often producing a scalar from a vector in machine learning.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-009/images/basic-reduction-graphviz.png" class="img-fluid figure-img"></p>
<figcaption>Sum Reduction</figcaption>
</figure>
</div></li>
</ul>
</section>
<section id="examples-of-reductions" class="level2">
<h2 class="anchored" data-anchor-id="examples-of-reductions">Examples of Reductions</h2>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reduce</span>(data, identity, op):</span>
<span id="cb2-2">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> identity</span>
<span id="cb2-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> element <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> data:</span>
<span id="cb2-4">        result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> op(result, element)</span>
<span id="cb2-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> result</span>
<span id="cb2-6"></span>
<span id="cb2-7">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span></code></pre></div>
<ul>
<li><strong>Sum:</strong>
<ul>
<li><p>Iteratively adds elements of a list.</p></li>
<li><p>Identity element: 0 (for an empty list).</p></li>
<li><p><strong>Example:</strong></p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Summation</span></span>
<span id="cb3-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reduce</span>(data, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> a, b: a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output: 15</span></span></code></pre></div></li>
</ul></li>
<li><strong>Product:</strong>
<ul>
<li><p>Iteratively multiplies elements of a list.</p></li>
<li><p>Identity element: 1 (for an empty list).</p></li>
<li><p><strong>Example:</strong></p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Product</span></span>
<span id="cb4-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reduce</span>(data, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> a, b: a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output: 120</span></span></code></pre></div></li>
</ul></li>
<li><strong>Min/Max:</strong>
<ul>
<li><p>Finds the minimum/maximum element in a list.</p></li>
<li><p>Identity element: <code>float('-inf')</code>/<code>float('inf')</code> (for an empty list).</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Maximum</span></span>
<span id="cb5-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reduce</span>(data, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-inf'</span>), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output: 5</span></span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Minimum</span></span>
<span id="cb5-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reduce</span>(data, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'inf'</span>), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output: 1</span></span></code></pre></div></li>
</ul></li>
<li>Other common reductions: argmax, argmin, norm, mean, number of unique elements.</li>
</ul>
</section>
<section id="reductions-in-machine-learning" class="level2">
<h2 class="anchored" data-anchor-id="reductions-in-machine-learning">Reductions in Machine Learning</h2>
<ul>
<li><strong>Ubiquitous</strong> in machine learning code:
<ul>
<li>Convolutional Neural Networks (CNNs): Mean/max pooling.</li>
<li>Classification: Argmax over probabilities.</li>
<li>Loss calculations: Scalar loss computed from target and prediction.</li>
<li>Softmax normalization: Summation of exponentiated elements.</li>
</ul></li>
</ul>
</section>
<section id="implementing-reductions-in-pytorch" class="level2">
<h2 class="anchored" data-anchor-id="implementing-reductions-in-pytorch">Implementing Reductions in PyTorch</h2>
<ul>
<li><strong>Reduction Implementations:</strong> <a href="https://github.com/pytorch/pytorch/blob/main/aten/src/ATen/native/cuda/ReduceOps.cpp">aten/src/ATen/native/cuda/ReduceOps.cpp</a></li>
<li>PyTorch provides built-in functions for common reductions (e.g., <code>torch.max</code>, <code>torch.min</code>, <code>torch.mean</code>).</li>
<li>These functions call optimized CUDA kernels when tensors are on a CUDA device.</li>
</ul>
</section>
<section id="serial-reduction" class="level2">
<h2 class="anchored" data-anchor-id="serial-reduction">Serial Reduction</h2>
<ul>
<li><p><strong>Serial reduction</strong> is a basic approach where a single thread iterates through the input data and updates the result sequentially.</p></li>
<li><p><strong>Example:</strong> Finding the maximum element in a list by iterating and comparing each element to the current maximum.</p>
<pre class="text"><code>+----------------------+
|    Initial Vector    |
+----------------------+
|  5  |  2  |  8  |  1 |
+----------------------+
           |
           v
+----------------------+
|     Iteration 1      |
+----------------------+
|  5  |     |     |    |
+----------------------+
           |
           v
+----------------------+
|     Iteration 2      |
+----------------------+
|  5  |  5  |     |    |
+----------------------+
           |
           v
+----------------------+
|     Iteration 3      |
+----------------------+
|  5  |  5  |  8  |    |
+----------------------+
           |
           v
+----------------------+
|     Iteration 4      |
+----------------------+
|  5  |  5  |  8  |  8 |
+----------------------+</code></pre></li>
<li><p><strong>Inefficient</strong> for parallel architectures like GPUs.</p></li>
</ul>
</section>
<section id="parallel-reduction-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="parallel-reduction-algorithm">Parallel Reduction Algorithm</h2>
<ul>
<li><p><strong>Linked Video:</strong> <a href="https://www.youtube.com/watch?v=D4l1YMsGNlU&amp;t=1763s">05 Atomics Reductions Warp Shuffle</a></p></li>
<li><p><strong>Foundation</strong> for efficient GPU reduction implementations.</p></li>
<li><p><strong>Key Idea:</strong> Divide the input data into pairs, assign a thread to each pair, and have each thread perform the reduction operation on its pair.</p></li>
<li><p><strong>Iterative Process:</strong> Repeat the process on the reduced results until a single result remains.</p></li>
<li><p><strong>Max Reduction Visualization:</strong></p>
<pre class="text"><code>+-----------------------------------------------------------------------+
|                             Initial Vector                            |
+-----------------------------------------------------------------------+
|  5  |  2  |  8  |  1  |  1  |  9  |  3  |  7  |  7  |  4  |  6  |  0  |
+-----------------------------------------------------------------------+
                                    |
                                    v
+-----------------------------------------------------------------------+
|                            Reduction Step 1                           |
+-----------------------------------------------------------------------+
|  5  |  8  |  9  |  7  |  6                                            |
+-----------------------------------------------------------------------+
                                    |
                                    v
+-----------------------------------------------------------------------+
|                            Reduction Step 2                           |
+-----------------------------------------------------------------------+
|  8  |  9  |  7                                                        |
+-----------------------------------------------------------------------+
                                    |
                                    v
+-----------------------------------------------------------------------+
|                            Reduction Step 3                           |
+-----------------------------------------------------------------------+
|  9  |  9                                                              |
+-----------------------------------------------------------------------+
                                    |
                                    v
+-----------------------------------------------------------------------+
|                          Final Reduction Step                         |
+-----------------------------------------------------------------------+
|  9                                                                    |
+-----------------------------------------------------------------------+</code></pre></li>
<li><p><strong>Sum Reduction Tree:</strong> Visualizes the parallel reduction process as a tree, where each level represents a reduction step.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-009/images/parallel-sum-reduction-tree-graphviz.png" class="img-fluid figure-img"></p>
<figcaption>Parallel Sum Reduction Tree</figcaption>
</figure>
</div></li>
<li><p><strong>Logarithmic Complexity:</strong> Requires <code>log n</code> steps for an input of size <code>n</code>.</p></li>
</ul>
</section>
<section id="non-determinism-in-floating-point-reductions" class="level2">
<h2 class="anchored" data-anchor-id="non-determinism-in-floating-point-reductions">Non-Determinism in Floating-Point Reductions</h2>
<ul>
<li><p><strong>Floating-point operations are non-commutative</strong>, meaning <code>a + b</code> may not equal <code>b + a</code>.</p></li>
<li><p><strong>Parallel reductions can introduce non-determinism</strong> due to:</p>
<ul>
<li><strong>Weak memory consistency</strong> on GPUs: Different threads may execute operations in unpredictable order.</li>
<li><strong>Order of operations within threads:</strong> The order in which a thread performs operations can affect the result.</li>
</ul></li>
<li><p><strong>Deterministic algorithms</strong> can be enforced in PyTorch using <code>torch.use_deterministic_algorithms(True)</code>, but this can impact performance.</p></li>
<li><p><strong>Example:</strong> Summing a list with many small numbers and a few large numbers can produce different results depending on the order of operations.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># We'll use several small numbers that, when added together first, could show a difference</span></span>
<span id="cb8-2">numbers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-20</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e20</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e20</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10 small numbers followed by a large positive and negative number</span></span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sum the list from left to right</span></span>
<span id="cb8-5">sum_left_to_right_adjusted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(numbers)</span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sum the list from right to left</span></span>
<span id="cb8-8">sum_right_to_left_adjusted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">reversed</span>(numbers))</span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.0 9.999999999999997e-20</span></span>
<span id="cb8-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"sum_left_to_right_adjusted: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sum_left_to_right_adjusted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"sum_right_to_left_adjusted: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sum_right_to_left_adjusted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre class="text"><code>sum_left_to_right_adjusted: 0.0
sum_right_to_left_adjusted: 9.999999999999997e-20</code></pre></li>
<li><p><strong>Accuracy Implications:</strong> Accumulating many small values in low-precision floating-point formats (e.g., float16) can lead to loss of precision.</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb10-2">large_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000.0</span>], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using float32 for initial value</span></span>
<span id="cb10-3"></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a smaller value that is significant for float32 but not for float16</span></span>
<span id="cb10-5">small_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Small value in float32</span></span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add small value to large value in float32</span></span>
<span id="cb10-8">result_float32 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> large_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> small_value</span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert large value to float16 and add the small value (also converted to float16)</span></span>
<span id="cb10-11">result_float16 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> large_value.to(torch.float16) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> small_value.to(torch.float16)</span>
<span id="cb10-12"></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert results back to float32 for accurate comparison</span></span>
<span id="cb10-14">result_float32 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> result_float32.item()</span>
<span id="cb10-15">result_float16_converted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> result_float16.to(torch.float32).item()</span>
<span id="cb10-16"></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print results</span></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1000.0009765625 1000.0</span></span>
<span id="cb10-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"result_float32: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result_float32<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"result_float16_converted: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>result_float16_converted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre class="text"><code>result_float32: 1000.0009765625
result_float16_converted: 1000.0</code></pre></li>
<li><p><strong>Solutions:</strong></p>
<ul>
<li>Use higher-precision formats (e.g., bfloat16) for accumulation.</li>
<li>Upcast the accumulator to a higher precision (e.g., float32) during the reduction.</li>
</ul></li>
</ul>
</section>
<section id="implementing-parallel-reduction-in-cuda" class="level2">
<h2 class="anchored" data-anchor-id="implementing-parallel-reduction-in-cuda">Implementing Parallel Reduction in CUDA</h2>
<section id="naive-approach-simple-reduce" class="level3">
<h3 class="anchored" data-anchor-id="naive-approach-simple-reduce">Naive Approach: Simple Reduce</h3>
<ul>
<li><p><strong>Thread Strategy:</strong> One thread per pair of elements.</p></li>
<li><p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Include necessary header files</span></span>
<span id="cb12-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">  </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// For standard input/output functions</span></span>
<span id="cb12-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda.h&gt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">    </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// For CUDA functions and data types</span></span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*</span></span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * CUDA kernel function to perform sum reduction on an array of floats.</span></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * The kernel reduces the input array 'input' to a single sum and stores the result in 'output'.</span></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * The reduction is performed in parallel using a binary tree reduction pattern.</span></span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * Key concepts:</span></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * - Each thread in a block processes elements of the array.</span></span>
<span id="cb12-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * - The number of active threads decreases by half in each iteration.</span></span>
<span id="cb12-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * - Synchronization is required between iterations to ensure correct results.</span></span>
<span id="cb12-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb12-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * CUDA-specific keywords:</span></span>
<span id="cb12-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * - __global__: Indicates a function that runs on the device (GPU) and is called from the host (CPU).</span></span>
<span id="cb12-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * - threadIdx.x: The thread's index within its block in the x-dimension.</span></span>
<span id="cb12-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * - blockDim.x: The number of threads in a block in the x-dimension.</span></span>
<span id="cb12-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * - __syncthreads(): A barrier synchronization function that waits until all threads in the block reach this point.</span></span>
<span id="cb12-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb12-22">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> SimpleSumReductionKernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Calculate the index for each thread.</span></span>
<span id="cb12-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Each thread handles two elements starting at index 'i'.</span></span>
<span id="cb12-25">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-26"></span>
<span id="cb12-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Start the reduction loop.</span></span>
<span id="cb12-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 'stride' controls the distance between elements to be added.</span></span>
<span id="cb12-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-30">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Only threads where threadIdx.x is a multiple of 'stride' participate.</span></span>
<span id="cb12-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-32">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Add the element at 'i + stride' to the element at 'i'.</span></span>
<span id="cb12-33">            input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb12-34">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Synchronize threads to ensure all additions are completed before the next iteration.</span></span>
<span id="cb12-36">        __syncthreads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb12-37">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-38"></span>
<span id="cb12-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// After the reduction, the total sum is stored in input[0].</span></span>
<span id="cb12-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Thread 0 writes the result to the output variable.</span></span>
<span id="cb12-41">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-42">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb12-43">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-44"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-45"></span>
<span id="cb12-46"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Define the size of the input array.</span></span>
<span id="cb12-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-49"></span>
<span id="cb12-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Calculate the total bytes needed for the input array.</span></span>
<span id="cb12-51">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> bytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-52"></span>
<span id="cb12-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory on the host (CPU) for input array and output variable.</span></span>
<span id="cb12-54">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Host input array</span></span>
<span id="cb12-55">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Host output variable</span></span>
<span id="cb12-56"></span>
<span id="cb12-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize the input array on the host.</span></span>
<span id="cb12-58">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// For simplicity, set all elements to 1.0f.</span></span>
<span id="cb12-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb12-60">        h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize each element to 1</span></span>
<span id="cb12-61">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb12-62"></span>
<span id="cb12-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Declare pointers for device (GPU) memory.</span></span>
<span id="cb12-64">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Device input array</span></span>
<span id="cb12-65">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Device output variable</span></span>
<span id="cb12-66"></span>
<span id="cb12-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory on the device for input array and output variable.</span></span>
<span id="cb12-68">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory for input array</span></span>
<span id="cb12-69">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory for output variable</span></span>
<span id="cb12-70"></span>
<span id="cb12-71">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy the input data from host memory to device memory.</span></span>
<span id="cb12-72">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-73"></span>
<span id="cb12-74">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Determine the number of threads per block.</span></span>
<span id="cb12-75">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Since each thread handles two elements, we use half the size of the input array.</span></span>
<span id="cb12-76">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-77"></span>
<span id="cb12-78">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch the reduction kernel on the device.</span></span>
<span id="cb12-79">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The kernel configuration &lt;&lt;&lt;1, threadsPerBlock&gt;&gt;&gt; means:</span></span>
<span id="cb12-80">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// - 1 block</span></span>
<span id="cb12-81">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// - 'threadsPerBlock' threads per block</span></span>
<span id="cb12-82">    SimpleSumReductionKernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-83"></span>
<span id="cb12-84">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy the result from device memory back to host memory.</span></span>
<span id="cb12-85">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb12-86"></span>
<span id="cb12-87">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Print the result to the console.</span></span>
<span id="cb12-88">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sum is "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb12-89"></span>
<span id="cb12-90">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free the allocated memory on the host.</span></span>
<span id="cb12-91">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free host input array</span></span>
<span id="cb12-92">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free host output variable</span></span>
<span id="cb12-93"></span>
<span id="cb12-94">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free the allocated memory on the device.</span></span>
<span id="cb12-95">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free device input array</span></span>
<span id="cb12-96">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free device output variable</span></span>
<span id="cb12-97"></span>
<span id="cb12-98">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Return success</span></span>
<span id="cb12-99"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li>Threads with even indices are active.</li>
<li>Stride starts at 1 and doubles at each iteration.</li>
<li>Each thread adds its current element and the element at <code>stride</code> distance.</li>
</ul></li>
<li><p><strong>Issues:</strong></p>
<ul>
<li><strong>High thread divergence:</strong> Many threads become inactive as the reduction progresses.</li>
<li><strong>Poor memory access patterns:</strong> Threads access data with increasing strides, leading to poor cache utilization.</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called sum</span></span>
<span id="cb13-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> sum simple_reduce.cu</span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the binary</span></span>
<span id="cb13-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--set</span> full sum</span></code></pre></div></li>
<li><p><strong>Results (RTX 4090):</strong></p>
<pre class="text"><code>Sum is 2048</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Branch Instructions Ratio</td>
<td>%</td>
<td>0.12</td>
</tr>
<tr class="even">
<td>Branch Instructions</td>
<td>inst</td>
<td>1,312</td>
</tr>
<tr class="odd">
<td><strong>Branch Efficiency</strong></td>
<td>%</td>
<td><strong>74.05</strong></td>
</tr>
<tr class="even">
<td>Avg. Divergent Branches</td>
<td></td>
<td>0.37</td>
</tr>
</tbody>
</table></li>
</ul>
</section>
<section id="minimizing-control-divergence-control-divergence-reduction" class="level3">
<h3 class="anchored" data-anchor-id="minimizing-control-divergence-control-divergence-reduction">Minimizing Control Divergence: Control Divergence Reduction</h3>
<ul>
<li><p><strong>Thread Strategy:</strong> Threads are co-located, with stride starting at block dimension and halving at each iteration.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-009/images/control-divergence-reduce.png" class="img-fluid figure-img"></p>
<figcaption>Figure 10.8</figcaption>
</figure>
</div></li>
<li><p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb15-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Include input/output stream library</span></span>
<span id="cb15-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda.h&gt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">   </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Include CUDA runtime API</span></span>
<span id="cb15-3"></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// CUDA kernel function to perform parallel reduction (sum of array elements)</span></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This kernel adds elements in the input array in parallel to compute the total sum.</span></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// It uses a tree-based reduction pattern to sum the elements efficiently.</span></span>
<span id="cb15-7">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> FixDivergenceKernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Each thread handles one element of the input array.</span></span>
<span id="cb15-9"></span>
<span id="cb15-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Iteratively reduce the array elements.</span></span>
<span id="cb15-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// At each step, 'stride' determines the distance between elements to be added.</span></span>
<span id="cb15-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-13">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Ensure that threads with index less than 'stride' perform the computation.</span></span>
<span id="cb15-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-15">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Add the element from the distant index (i + stride) to the current index (i).</span></span>
<span id="cb15-16">            input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb15-17">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Synchronize threads to ensure all additions are completed before the next iteration.</span></span>
<span id="cb15-19">        __syncthreads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb15-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-21"></span>
<span id="cb15-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// After the reduction, the first thread (threadIdx.x == 0) has the total sum in input[0].</span></span>
<span id="cb15-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-24">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Write the result to the output variable.</span></span>
<span id="cb15-25">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-26"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-27"></span>
<span id="cb15-28"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Size of the input data (number of elements in the array).</span></span>
<span id="cb15-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Total size in bytes of the input data.</span></span>
<span id="cb15-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> bytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-33"></span>
<span id="cb15-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory for input and output on the host (CPU).</span></span>
<span id="cb15-35">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Host input array.</span></span>
<span id="cb15-36">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Host output variable to store the result.</span></span>
<span id="cb15-37"></span>
<span id="cb15-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize input data on the host.</span></span>
<span id="cb15-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb15-40">        h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Example initialization: set all elements to 1.</span></span>
<span id="cb15-41">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb15-42"></span>
<span id="cb15-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory for input and output on the device (GPU).</span></span>
<span id="cb15-44">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Device input array.</span></span>
<span id="cb15-45">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Device output variable.</span></span>
<span id="cb15-46">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory for input array on device.</span></span>
<span id="cb15-47">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory for output variable on device.</span></span>
<span id="cb15-48"></span>
<span id="cb15-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy input data from host to device.</span></span>
<span id="cb15-50">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-51"></span>
<span id="cb15-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Determine the number of threads per block.</span></span>
<span id="cb15-53">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch half as many threads as the input size.</span></span>
<span id="cb15-54"></span>
<span id="cb15-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch the kernel function on the GPU.</span></span>
<span id="cb15-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The syntax is &lt;&lt;&lt;number of blocks, threads per block&gt;&gt;&gt;</span></span>
<span id="cb15-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// We use 1 block and 'threadsPerBlock' threads.</span></span>
<span id="cb15-58">    FixDivergenceKernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-59"></span>
<span id="cb15-60">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy the result back from device to host.</span></span>
<span id="cb15-61">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb15-62"></span>
<span id="cb15-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Print the result.</span></span>
<span id="cb15-64">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sum is "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Expected output: Sum is 2048</span></span>
<span id="cb15-65"></span>
<span id="cb15-66">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Clean up and free allocated memory.</span></span>
<span id="cb15-67">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free host input array.</span></span>
<span id="cb15-68">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free host output variable.</span></span>
<span id="cb15-69">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free device input array.</span></span>
<span id="cb15-70">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free device output variable.</span></span>
<span id="cb15-71"></span>
<span id="cb15-72">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb15-73"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li>All threads are initially active.</li>
<li>Stride starts at block dimension and is halved at each iteration.</li>
<li>Each thread adds its current element and the element at <code>stride</code> distance.</li>
</ul></li>
<li><p><strong>Benefits:</strong></p>
<ul>
<li><strong>Reduced thread divergence:</strong> Threads remain active for longer.</li>
<li><strong>Improved memory access patterns:</strong> Threads access contiguous chunks of memory, improving cache utilization.</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called sum</span></span>
<span id="cb16-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> sum control_divergence_reduce.cu</span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the binary</span></span>
<span id="cb16-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--set</span> full sum</span></code></pre></div></li>
<li><p><strong>Results (RTX 4090):</strong></p>
<pre class="text"><code>Sum is 2048</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.28</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.19</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>6,299</td>
</tr>
<tr class="even">
<td>Memory Throughput</td>
<td>%</td>
<td>0.68</td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>0.39</td>
</tr>
<tr class="even">
<td><strong>Duration</strong></td>
<td>us</td>
<td><strong>2.88</strong></td>
</tr>
<tr class="odd">
<td><strong>L1/TEX Cache Throughput</strong></td>
<td>%</td>
<td><strong>30.49</strong></td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>0.68</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>29.80</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td><strong>0.12</strong></td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Branch Instructions Ratio</td>
<td>%</td>
<td>0.31</td>
</tr>
<tr class="even">
<td>Branch Instructions</td>
<td>inst</td>
<td>1,126</td>
</tr>
<tr class="odd">
<td><strong>Branch Efficiency</strong></td>
<td>%</td>
<td><strong>99.32</strong></td>
</tr>
<tr class="even">
<td>Avg. Divergent Branches</td>
<td></td>
<td>0.01</td>
</tr>
</tbody>
</table></li>
</ul>
</section>
<section id="utilizing-shared-memory-shared-reduce" class="level3">
<h3 class="anchored" data-anchor-id="utilizing-shared-memory-shared-reduce">Utilizing Shared Memory: Shared Reduce</h3>
<ul>
<li><p><strong>Thread Strategy:</strong> Similar to control divergence reduction, but the first reduction step is performed in shared memory.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-009/images/shared-reduce.png" class="img-fluid figure-img"></p>
<figcaption>Figure 10.10</figcaption>
</figure>
</div></li>
<li><p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb18-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb18-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda.h&gt;</span></span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*</span></span>
<span id="cb18-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * This program demonstrates how to perform parallel reduction using CUDA.</span></span>
<span id="cb18-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * It computes the sum of an array of floating-point numbers.</span></span>
<span id="cb18-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * The reduction is performed within a single block using shared memory for optimization.</span></span>
<span id="cb18-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb18-9"></span>
<span id="cb18-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Define the number of threads per block (must be a power of 2 for reduction)</span></span>
<span id="cb18-11"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define BLOCK_DIM </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb18-12"></span>
<span id="cb18-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// CUDA kernel function to perform parallel reduction using shared memory</span></span>
<span id="cb18-14">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> SharedMemoryReduction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Declare shared memory array to hold partial sums</span></span>
<span id="cb18-16">    __shared__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>BLOCK_DIM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb18-17"></span>
<span id="cb18-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Calculate the thread's index within the block</span></span>
<span id="cb18-19">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-20"></span>
<span id="cb18-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Each thread processes two elements from the input array</span></span>
<span id="cb18-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute the global indices of the elements to be processed</span></span>
<span id="cb18-23">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> start_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-24">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> end_index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> BLOCK_DIM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-25"></span>
<span id="cb18-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Load elements from global memory, add them, and store the result in shared memory</span></span>
<span id="cb18-27">    input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>start_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>end_index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb18-28"></span>
<span id="cb18-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Synchronize threads to ensure all partial sums are loaded into shared memory</span></span>
<span id="cb18-30">    __syncthreads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb18-31"></span>
<span id="cb18-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform the reduction in shared memory</span></span>
<span id="cb18-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// At each step, the stride is halved and threads with indices less than the stride</span></span>
<span id="cb18-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// add their corresponding element with the element stride positions ahead</span></span>
<span id="cb18-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This effectively sums pairs of elements, then pairs of pairs, and so on</span></span>
<span id="cb18-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Synchronize threads before each reduction step to ensure all additions are complete</span></span>
<span id="cb18-38">        __syncthreads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb18-39"></span>
<span id="cb18-40">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Only threads with indices less than stride participate in this step</span></span>
<span id="cb18-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-42">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Each thread adds its element with the element stride positions ahead</span></span>
<span id="cb18-43">            input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb18-44">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-45">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-46"></span>
<span id="cb18-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// After the reduction, the first element of shared memory contains the total sum</span></span>
<span id="cb18-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Thread 0 writes the result from shared memory to the output variable in global memory</span></span>
<span id="cb18-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-50">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb18-51">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-52"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-53"></span>
<span id="cb18-54"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Total number of input elements (must be a multiple of 2 * BLOCK_DIM)</span></span>
<span id="cb18-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2048</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Note: This implementation assumes size is exactly 2 * BLOCK_DIM</span></span>
<span id="cb18-57"></span>
<span id="cb18-58">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Total size in bytes of the input array</span></span>
<span id="cb18-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> bytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-60"></span>
<span id="cb18-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate host memory for input and output</span></span>
<span id="cb18-62">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Host input array</span></span>
<span id="cb18-63">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Host output value</span></span>
<span id="cb18-64"></span>
<span id="cb18-65">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize input data on the host</span></span>
<span id="cb18-66">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// For simplicity, we initialize all elements to 1.0f</span></span>
<span id="cb18-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The expected sum is size * 1.0f = 2048.0f</span></span>
<span id="cb18-68">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb18-69">        h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-70">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-71"></span>
<span id="cb18-72">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate device memory for input and output</span></span>
<span id="cb18-73">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-74">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-75">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Device input array</span></span>
<span id="cb18-76">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Device output value</span></span>
<span id="cb18-77"></span>
<span id="cb18-78">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy input data from host to device</span></span>
<span id="cb18-79">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-80"></span>
<span id="cb18-81">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch the kernel with one block and size / 2 threads</span></span>
<span id="cb18-82">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Each thread processes two elements</span></span>
<span id="cb18-83">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 2048 / 2 = 1024 threads</span></span>
<span id="cb18-84">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> blocksPerGrid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-85">    SharedMemoryReduction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>blocksPerGrid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-86"></span>
<span id="cb18-87">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy the result from device to host</span></span>
<span id="cb18-88">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-89"></span>
<span id="cb18-90">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Print the final result</span></span>
<span id="cb18-91">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sum is "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-92"></span>
<span id="cb18-93">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free host and device memory</span></span>
<span id="cb18-94">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-95">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-96">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-97">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb18-98"></span>
<span id="cb18-99">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb18-100"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li>Input data is copied to shared memory in a block-wise manner.</li>
<li>Reduction is performed entirely in shared memory.</li>
<li>Final result is written to global memory using atomic operations.</li>
</ul></li>
<li><p><strong>Benefits:</strong></p>
<ul>
<li><strong>Reduced global memory accesses:</strong> Data is read from global memory only once.</li>
<li><strong>Improved memory access patterns:</strong> Shared memory access is faster and more predictable than global memory access.</li>
</ul></li>
<li><p><strong>Limitation:</strong> Assumes the entire input can fit into shared memory.</p></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called sum</span></span>
<span id="cb19-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> sum shared_reduce.cu</span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the binary</span></span>
<span id="cb19-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--set</span> full sum</span></code></pre></div></li>
<li><p><strong>Results (RTX 4090):</strong></p>
<pre class="text"><code>Sum is 2048</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.32</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.19</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>7,006</td>
</tr>
<tr class="even">
<td>Memory Throughput</td>
<td>%</td>
<td>0.44</td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>0.44</td>
</tr>
<tr class="even">
<td><strong>Duration</strong></td>
<td>us</td>
<td><strong>3.20</strong></td>
</tr>
<tr class="odd">
<td><strong>L1/TEX Cache Throughput</strong></td>
<td>%</td>
<td><strong>48.27</strong></td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>0.36</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>35.28</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>0.24</td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Branch Instructions Ratio</td>
<td>%</td>
<td>0.10</td>
</tr>
<tr class="even">
<td>Branch Instructions</td>
<td>inst</td>
<td>385</td>
</tr>
<tr class="odd">
<td><strong>Branch Efficiency</strong></td>
<td>%</td>
<td><strong>100</strong></td>
</tr>
<tr class="even">
<td>Avg. Divergent Branches</td>
<td></td>
<td>0</td>
</tr>
</tbody>
</table></li>
</ul>
</section>
<section id="segmented-multi-block-reduction-segmented-reduce" class="level3">
<h3 class="anchored" data-anchor-id="segmented-multi-block-reduction-segmented-reduce">Segmented Multi-Block Reduction: Segmented Reduce</h3>
<ul>
<li><p><strong>Thread Strategy:</strong> Uses multiple blocks to handle larger inputs. Each block performs a reduction on a segment of the input</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-009/images/segmented-multiblock.png" class="img-fluid figure-img"></p>
<figcaption>Figure 10.12</figcaption>
</figure>
</div></li>
<li><p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/*</span></span>
<span id="cb21-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * This program demonstrates how to perform a parallel reduction (sum) of an array using CUDA.</span></span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * It sums up all elements of an input array using multiple threads and blocks on the GPU.</span></span>
<span id="cb21-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * Each block computes a partial sum using shared memory and then adds it to a global output variable.</span></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb21-6"></span>
<span id="cb21-7"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">  </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Include standard input/output stream library</span></span>
<span id="cb21-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda.h&gt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">    </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Include CUDA library for GPU programming</span></span>
<span id="cb21-9"></span>
<span id="cb21-10"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define BLOCK_DIM </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">  </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Define the number of threads per block</span></span>
<span id="cb21-11"></span>
<span id="cb21-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb21-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * CUDA kernel function to perform parallel reduction (sum) of an input array.</span></span>
<span id="cb21-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * Each block reduces its portion of the array using shared memory, and the result is accumulated</span></span>
<span id="cb21-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * into a single output variable using atomic addition.</span></span>
<span id="cb21-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb21-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * </span><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@param</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="cv" style="color: #5E5E5E;
background-color: null;
font-style: italic;">input</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Pointer to input array in device memory</span></span>
<span id="cb21-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * </span><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@param</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="cv" style="color: #5E5E5E;
background-color: null;
font-style: italic;">output</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> Pointer to output variable in device memory (the result of reduction)</span></span>
<span id="cb21-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * </span><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@param</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="cv" style="color: #5E5E5E;
background-color: null;
font-style: italic;">n</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">      Size of the input array</span></span>
<span id="cb21-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb21-21">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> SharedMemoryReduction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Declare shared memory array for this block</span></span>
<span id="cb21-23">    __shared__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>BLOCK_DIM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb21-24"></span>
<span id="cb21-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute global index for this thread</span></span>
<span id="cb21-26">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Global index</span></span>
<span id="cb21-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Thread index within the block</span></span>
<span id="cb21-28">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-29"></span>
<span id="cb21-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Each thread loads one element from global memory to shared memory</span></span>
<span id="cb21-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-32">        input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Load element from global memory</span></span>
<span id="cb21-33">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-34">        input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// If index exceeds array size, initialize to zero</span></span>
<span id="cb21-35">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-36">    __syncthreads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Ensure all threads have loaded their data</span></span>
<span id="cb21-37"></span>
<span id="cb21-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform tree-based reduction in shared memory</span></span>
<span id="cb21-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-40">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// At each step, the stride halves, combining pairs of elements</span></span>
<span id="cb21-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-42">            input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Add the element with its pair</span></span>
<span id="cb21-43">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-44">        __syncthreads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Synchronize threads before next iteration</span></span>
<span id="cb21-45">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-46"></span>
<span id="cb21-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// After reduction, the first thread of each block contains the block's partial sum</span></span>
<span id="cb21-48">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-49">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Atomically add block's partial sum to global output variable</span></span>
<span id="cb21-50">        atomicAdd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb21-51">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-52"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-53"></span>
<span id="cb21-54"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Define the size of the input data</span></span>
<span id="cb21-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Total number of elements in the array</span></span>
<span id="cb21-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> bytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Total size in bytes of the array</span></span>
<span id="cb21-58"></span>
<span id="cb21-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory on host (CPU)</span></span>
<span id="cb21-60">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Host input array</span></span>
<span id="cb21-61">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Host output variable</span></span>
<span id="cb21-62"></span>
<span id="cb21-63">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize input data on host</span></span>
<span id="cb21-64">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb21-65">        h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Example: Initialize all elements to 1</span></span>
<span id="cb21-66">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb21-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Since we initialized all elements to 1.0f, the expected sum is equal to 'size'</span></span>
<span id="cb21-68"></span>
<span id="cb21-69">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory on device (GPU)</span></span>
<span id="cb21-70">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Device input array</span></span>
<span id="cb21-71">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Device output variable</span></span>
<span id="cb21-72"></span>
<span id="cb21-73">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate device memory for input array</span></span>
<span id="cb21-74">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate device memory for output variable</span></span>
<span id="cb21-75"></span>
<span id="cb21-76">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize output variable on device to zero</span></span>
<span id="cb21-77">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> zero <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-78">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>zero<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb21-79"></span>
<span id="cb21-80">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy input data from host to device</span></span>
<span id="cb21-81">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb21-82"></span>
<span id="cb21-83">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Determine the number of blocks needed</span></span>
<span id="cb21-84">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> numBlocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> BLOCK_DIM <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> BLOCK_DIM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Calculate number of blocks</span></span>
<span id="cb21-85"></span>
<span id="cb21-86">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch the kernel on the device</span></span>
<span id="cb21-87">    SharedMemoryReduction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>numBlocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> BLOCK_DIM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb21-88"></span>
<span id="cb21-89">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy the result from device back to host</span></span>
<span id="cb21-90">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb21-91"></span>
<span id="cb21-92">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Print the result</span></span>
<span id="cb21-93">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sum is "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-94"></span>
<span id="cb21-95">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free host and device memory</span></span>
<span id="cb21-96">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free host input array</span></span>
<span id="cb21-97">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free host output variable</span></span>
<span id="cb21-98">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free device input array</span></span>
<span id="cb21-99">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free device output variable</span></span>
<span id="cb21-100"></span>
<span id="cb21-101">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-102"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li>Each block copies its segment of the input to shared memory.</li>
<li>Reduction is performed in shared memory within each block.</li>
<li>Each block writes its partial result to global memory using atomic operations.</li>
<li>A final reduction is performed on the partial results in global memory.</li>
</ul></li>
<li><p><strong>Benefits:</strong></p>
<ul>
<li><strong>Handles larger inputs:</strong> Shared memory limitations are overcome by using multiple blocks.</li>
<li><strong>Improved parallelism:</strong> Multiple blocks can execute concurrently.</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called sum</span></span>
<span id="cb22-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> sum segment_reduce.cu</span>
<span id="cb22-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the binary</span></span>
<span id="cb22-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--set</span> full sum</span></code></pre></div></li>
<li><p><strong>Results (RTX 4090):</strong></p>
<pre class="text"><code>Sum is 100000</code></pre></li>
</ul>
</section>
<section id="thread-coarsening-reduced-coarsening" class="level3">
<h3 class="anchored" data-anchor-id="thread-coarsening-reduced-coarsening">Thread Coarsening: Reduced Coarsening</h3>
<ul>
<li><p><strong>Thread Strategy:</strong> Each thread reduces multiple elements before synchronizing with other threads.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-009/images/thread-coarsening-reduction.png" class="img-fluid figure-img"></p>
<figcaption>Figure 10.14</figcaption>
</figure>
</div></li>
<li><p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb24-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb24-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda.h&gt;</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">  </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Include CUDA header for CUDA runtime functions</span></span>
<span id="cb24-3"></span>
<span id="cb24-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Define the number of threads per block (maximum is 1024 for most GPUs)</span></span>
<span id="cb24-5"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define BLOCK_DIM </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb24-6"></span>
<span id="cb24-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Define the coarsening factor (number of elements each thread will process)</span></span>
<span id="cb24-8"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define COARSE_FACTOR </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb24-9"></span>
<span id="cb24-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb24-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * CUDA kernel function that performs parallel reduction (summing up an array of floats)</span></span>
<span id="cb24-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * using thread coarsening to have each thread process multiple elements,</span></span>
<span id="cb24-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * and using shared memory for efficient intra-block reduction.</span></span>
<span id="cb24-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb24-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * </span><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@param</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="cv" style="color: #5E5E5E;
background-color: null;
font-style: italic;">input</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  Pointer to the input array in device memory</span></span>
<span id="cb24-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * </span><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@param</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="cv" style="color: #5E5E5E;
background-color: null;
font-style: italic;">output</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> Pointer to the output value in device memory</span></span>
<span id="cb24-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> * </span><span class="an" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@param</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> </span><span class="cv" style="color: #5E5E5E;
background-color: null;
font-style: italic;">size</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">   The size of the input array</span></span>
<span id="cb24-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb24-19">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> CoarsenedReduction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate shared memory for partial sums within a block</span></span>
<span id="cb24-21">    __shared__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>BLOCK_DIM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb24-22"></span>
<span id="cb24-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute the global index for each thread, adjusted for coarsening</span></span>
<span id="cb24-24">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> COARSE_FACTOR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-25"></span>
<span id="cb24-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Thread index within the block</span></span>
<span id="cb24-27">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-28"></span>
<span id="cb24-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize a local sum for this thread</span></span>
<span id="cb24-30">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-31"></span>
<span id="cb24-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Each thread processes COARSE_FACTOR elements</span></span>
<span id="cb24-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> COARSE_FACTOR<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>tile<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-34">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute the index for the current element</span></span>
<span id="cb24-35"></span>
<span id="cb24-36">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Check if index is within bounds</span></span>
<span id="cb24-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-38">            sum <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Accumulate the sum</span></span>
<span id="cb24-39">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-40">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-41"></span>
<span id="cb24-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Store the partial sum in shared memory</span></span>
<span id="cb24-43">    input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-44"></span>
<span id="cb24-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Synchronize threads within the block to ensure all partial sums are stored</span></span>
<span id="cb24-46">    __syncthreads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb24-47"></span>
<span id="cb24-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Perform reduction within the block using shared memory</span></span>
<span id="cb24-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">unsigned</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-50">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-51">            input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Accumulate sums from higher threads</span></span>
<span id="cb24-52">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-53">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Synchronize after each reduction step</span></span>
<span id="cb24-54">        __syncthreads<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb24-55">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-56"></span>
<span id="cb24-57">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Thread 0 in each block adds the block's result to the global output atomically</span></span>
<span id="cb24-58">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-59">        atomicAdd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> input_s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]);</span></span>
<span id="cb24-60">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-61"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-62"></span>
<span id="cb24-63"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-64">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Total number of elements to sum</span></span>
<span id="cb24-65">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-66">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Total size in bytes for the input array</span></span>
<span id="cb24-67">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> bytes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-68"></span>
<span id="cb24-69">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory on the host (CPU) for input data and output result</span></span>
<span id="cb24-70">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Input array</span></span>
<span id="cb24-71">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Output value</span></span>
<span id="cb24-72"></span>
<span id="cb24-73">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize input data on the host (e.g., set all elements to 1.0f)</span></span>
<span id="cb24-74">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb24-75">        h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Example initialization</span></span>
<span id="cb24-76">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb24-77"></span>
<span id="cb24-78">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory on the device (GPU) for input data and output result</span></span>
<span id="cb24-79">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-80">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-81">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span>          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate device memory for input</span></span>
<span id="cb24-82">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate device memory for output</span></span>
<span id="cb24-83"></span>
<span id="cb24-84">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy input data from host to device</span></span>
<span id="cb24-85">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> bytes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-86"></span>
<span id="cb24-87">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize output on the device to 0</span></span>
<span id="cb24-88">    cudaMemset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb24-89"></span>
<span id="cb24-90">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Calculate the number of blocks needed, considering coarsening</span></span>
<span id="cb24-91">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> numBlocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> BLOCK_DIM <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> COARSE_FACTOR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>BLOCK_DIM <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> COARSE_FACTOR<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-92"></span>
<span id="cb24-93">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch the kernel with the calculated number of blocks and threads per block</span></span>
<span id="cb24-94">    CoarsenedReduction<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>numBlocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> BLOCK_DIM<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-95"></span>
<span id="cb24-96">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy the result from device back to host</span></span>
<span id="cb24-97">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-98"></span>
<span id="cb24-99">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Print the final result</span></span>
<span id="cb24-100">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sum is "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>h_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-101"></span>
<span id="cb24-102">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free allocated memory on the host</span></span>
<span id="cb24-103">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[]</span> h_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-104">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">delete</span> h_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-105"></span>
<span id="cb24-106">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Free allocated memory on the device</span></span>
<span id="cb24-107">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-108">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb24-109"></span>
<span id="cb24-110">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-111"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li>Threads reduce multiple elements within their assigned segment.</li>
<li>Reduction is then performed within blocks and finally across blocks, similar to the segmented reduction.</li>
</ul></li>
<li><p><strong>Benefits:</strong></p>
<ul>
<li><strong>Reduced synchronization overhead:</strong> Threads synchronize less frequently.</li>
<li><strong>Improved memory access patterns:</strong> Threads access contiguous chunks of memory during the initial reduction.</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called sum</span></span>
<span id="cb25-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> sum reduce_coarsening.cu</span>
<span id="cb25-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the binary</span></span>
<span id="cb25-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--set</span> full sum</span></code></pre></div></li>
<li><p><strong>Results (RTX 4090):</strong></p>
<pre class="text"><code>Sum is 10000</code></pre></li>
</ul>
</section>
</section>
<section id="reductions-in-machine-learning-frameworks" class="level2">
<h2 class="anchored" data-anchor-id="reductions-in-machine-learning-frameworks">Reductions in Machine Learning Frameworks</h2>
<section id="pytorch" class="level3">
<h3 class="anchored" data-anchor-id="pytorch">PyTorch</h3>
<ul>
<li><strong>Generic Reduction Kernel:</strong> PyTorch uses a single <a href="https://github.com/pytorch/pytorch/blob/main/aten/src/ATen/native/cuda/Reduce.cuh"><code>Reduce.cuh</code></a> kernel for various reduction operations (e.g., min, max, sum).</li>
<li><strong>Code Generation:</strong> The kernel is specialized at runtime based on the desired reduction operation, data type, and input size.</li>
<li><strong>Heuristics:</strong> PyTorch uses heuristics to determine optimal kernel launch parameters (e.g., block size, grid size).</li>
<li><strong><a href="https://github.com/pytorch/pytorch/blob/c64ae601ba9eb3ad2cd3402a14f6ac83c0ab7eba/aten/src/ATen/native/cuda/Reduce.cuh#L1205">ReduceConfig</a>:</strong> Defines various heuristics and parameters for different reduction scenarios.</li>
<li><strong>Examples:</strong>
<ul>
<li><a href="https://github.com/pytorch/pytorch/blob/main/aten/src/ATen/native/cuda/Reduce.cuh"><code>Reduce.cuh</code></a> handles different data types and accumulation strategies.</li>
<li><a href="https://github.com/pytorch/pytorch/blob/c64ae601ba9eb3ad2cd3402a14f6ac83c0ab7eba/aten/src/ATen/native/cuda/Reduce.cuh#L1205"><code>ReduceConfig</code></a> sets heuristics for block size, thread coarsening, and accumulation data type.</li>
</ul></li>
</ul>
</section>
<section id="torch-compile-triton" class="level3">
<h3 class="anchored" data-anchor-id="torch-compile-triton">Torch Compile (Triton)</h3>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch </span>
<span id="cb27-2"></span>
<span id="cb27-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.compile</span></span>
<span id="cb27-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f(a):</span>
<span id="cb27-5">    c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(a)</span>
<span id="cb27-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> c</span>
<span id="cb27-7"></span>
<span id="cb27-8">f(torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>).cuda())</span></code></pre></div>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">TORCH_LOGS</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output_code"</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> reduce_compile.py</span></code></pre></div>
<ul>
<li><p><strong>Trident Kernels:</strong> Torch Compile generates Trident kernels for reductions.</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># AOT ID: ['0_inference']</span></span>
<span id="cb29-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ctypes <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> c_void_p, c_long</span>
<span id="cb29-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb29-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb29-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb29-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb29-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tempfile</span>
<span id="cb29-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> math <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> inf, nan</span>
<span id="cb29-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.hooks <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> run_intermediate_hooks</span>
<span id="cb29-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> maybe_profile</span>
<span id="cb29-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.codegen.memory_planning <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> _align <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> align</span>
<span id="cb29-12"></span>
<span id="cb29-13"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> device, empty_strided</span>
<span id="cb29-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.async_compile <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AsyncCompile</span>
<span id="cb29-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.select_algorithm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> extern_kernels</span>
<span id="cb29-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.codegen.multi_kernel <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> MultiKernelCall</span>
<span id="cb29-17"></span>
<span id="cb29-18">aten <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ops.aten</span>
<span id="cb29-19">inductor_ops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ops.inductor</span>
<span id="cb29-20">_quantized <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ops._quantized</span>
<span id="cb29-21">assert_size_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch._C._dynamo.guards.assert_size_stride</span>
<span id="cb29-22">empty_strided_cpu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch._C._dynamo.guards._empty_strided_cpu</span>
<span id="cb29-23">empty_strided_cuda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch._C._dynamo.guards._empty_strided_cuda</span>
<span id="cb29-24">reinterpret_tensor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch._C._dynamo.guards._reinterpret_tensor</span>
<span id="cb29-25">alloc_from_pool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.ops.inductor._alloc_from_pool</span>
<span id="cb29-26">async_compile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AsyncCompile()</span>
<span id="cb29-27"></span>
<span id="cb29-28"></span>
<span id="cb29-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kernel path: /tmp/torchinductor_innom-dt/xc/cxcl4refhjzcdxt6unhmqpirfzuwlll35zqbrgprj6lcwak26bfa.py</span></span>
<span id="cb29-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Source Nodes: [c], Original ATen: [aten.sum]</span></span>
<span id="cb29-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># c =&gt; sum_1</span></span>
<span id="cb29-32">triton_per_fused_sum_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> async_compile.triton(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'triton_'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span>
<span id="cb29-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import triton</span></span>
<span id="cb29-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">import triton.language as tl</span></span>
<span id="cb29-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">from triton.compiler.compiler import AttrsDescriptor</span></span>
<span id="cb29-36"></span>
<span id="cb29-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">from torch._inductor.runtime import triton_helpers, triton_heuristics</span></span>
<span id="cb29-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">from torch._inductor.runtime.triton_helpers import libdevice, math as tl_math</span></span>
<span id="cb29-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">from torch._inductor.runtime.hints import AutotuneHint, ReductionHint, TileHint, instance_descriptor, DeviceProperties</span></span>
<span id="cb29-40"></span>
<span id="cb29-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">@triton_heuristics.persistent_reduction(</span></span>
<span id="cb29-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    size_hints=[1, 16],</span></span>
<span id="cb29-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    reduction_hint=ReductionHint.INNER,</span></span>
<span id="cb29-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    filename=__file__,</span></span>
<span id="cb29-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    triton_meta={'signature': {0: '*fp32', 1: '*fp32', 2: 'i32', 3: 'i32'}, 'device': DeviceProperties(type='cuda', index=0, cc=89, major=8, regs_per_multiprocessor=65536, max_threads_per_multi_processor=1536, multi_processor_count=128), 'constants': </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{2: 1}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">, 'configs': [AttrsDescriptor(divisible_by_16=(0, 1), equal_to_1=(2,))]},</span></span>
<span id="cb29-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    inductor_meta={'autotune_hints': set(), 'kernel_name': 'triton_per_fused_sum_0', 'mutated_arg_names': [], 'no_x_dim': False, 'num_load': 1, 'num_reduction': 1, 'backend_hash': '2A9CF09493B10CFF69FD04C0FEC21CD676E4FE3810C6D0938868EF378B24086E', 'are_deterministic_algorithms_enabled': False, 'assert_indirect_indexing': True, 'autotune_local_cache': True, 'autotune_pointwise': True, 'autotune_remote_cache': False, 'force_disable_caches': False, 'dynamic_scale_rblock': True, 'max_autotune': False, 'max_autotune_pointwise': False, 'min_split_scan_rblock': 256, 'spill_threshold': 16, 'store_cubin': False}</span></span>
<span id="cb29-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb29-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">@triton.jit</span></span>
<span id="cb29-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">def triton_(in_ptr0, out_ptr0, xnumel, rnumel, XBLOCK : tl.constexpr):</span></span>
<span id="cb29-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    xnumel = 1</span></span>
<span id="cb29-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    rnumel = 10</span></span>
<span id="cb29-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    RBLOCK: tl.constexpr = 16</span></span>
<span id="cb29-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    xoffset = tl.program_id(0) * XBLOCK</span></span>
<span id="cb29-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    xindex = xoffset + tl.arange(0, XBLOCK)[:, None]</span></span>
<span id="cb29-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    xmask = xindex &lt; xnumel</span></span>
<span id="cb29-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    rindex = tl.arange(0, RBLOCK)[None, :]</span></span>
<span id="cb29-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    roffset = 0</span></span>
<span id="cb29-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    rmask = rindex &lt; rnumel</span></span>
<span id="cb29-59"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    r0 = rindex</span></span>
<span id="cb29-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    tmp0 = tl.load(in_ptr0 + (r0), rmask, other=0.0)</span></span>
<span id="cb29-61"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    tmp1 = tl.broadcast_to(tmp0, [XBLOCK, RBLOCK])</span></span>
<span id="cb29-62"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    tmp3 = tl.where(rmask, tmp1, 0)</span></span>
<span id="cb29-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    tmp4 = tl.sum(tmp3, 1)[:, None]</span></span>
<span id="cb29-64"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    tl.store(out_ptr0 + (tl.full([XBLOCK, 1], 0, tl.int32)), tmp4, None)</span></span>
<span id="cb29-65"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span>, device_str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda'</span>)</span>
<span id="cb29-66"></span>
<span id="cb29-67"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> triton</span>
<span id="cb29-68"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> triton.language <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tl</span>
<span id="cb29-69"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.runtime.triton_heuristics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> grid, split_scan_grid, start_graph, end_graph</span>
<span id="cb29-70"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._C <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> _cuda_getCurrentRawStream <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> get_raw_stream</span>
<span id="cb29-71"></span>
<span id="cb29-72"></span>
<span id="cb29-73">async_compile.wait(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">globals</span>())</span>
<span id="cb29-74"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">del</span> async_compile</span>
<span id="cb29-75"></span>
<span id="cb29-76"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> call(args):</span>
<span id="cb29-77">    arg0_1, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> args</span>
<span id="cb29-78">    args.clear()</span>
<span id="cb29-79">    assert_size_stride(arg0_1, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, ), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ))</span>
<span id="cb29-80">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.cuda._DeviceGuard(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb29-81">        torch.cuda.set_device(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb29-82">        buf0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> empty_strided_cuda((), (), torch.float32)</span>
<span id="cb29-83">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Source Nodes: [c], Original ATen: [aten.sum]</span></span>
<span id="cb29-84">        stream0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_raw_stream(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb29-85">        triton_per_fused_sum_0.run(arg0_1, buf0, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, grid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>grid(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), stream<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>stream0)</span>
<span id="cb29-86">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">del</span> arg0_1</span>
<span id="cb29-87">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (buf0, )</span>
<span id="cb29-88"></span>
<span id="cb29-89"></span>
<span id="cb29-90"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> benchmark_compiled_module(times<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb29-91">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._dynamo.testing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> rand_strided</span>
<span id="cb29-92">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> print_performance</span>
<span id="cb29-93">    arg0_1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rand_strided((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, ), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ), device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda:0'</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32)</span>
<span id="cb29-94">    fn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span>: call([arg0_1])</span>
<span id="cb29-95">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> print_performance(fn, times<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>times, repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>repeat)</span>
<span id="cb29-96"></span>
<span id="cb29-97"></span>
<span id="cb29-98"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb29-99">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.wrapper_benchmark <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> compiled_module_main</span>
<span id="cb29-100">    compiled_module_main(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'None'</span>, benchmark_compiled_module)</span></code></pre></div>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> triton</span>
<span id="cb30-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> triton.language <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tl</span>
<span id="cb30-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> triton.compiler.compiler <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AttrsDescriptor</span>
<span id="cb30-4"></span>
<span id="cb30-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.runtime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> triton_helpers, triton_heuristics</span>
<span id="cb30-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.runtime.triton_helpers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> libdevice, math <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tl_math</span>
<span id="cb30-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch._inductor.runtime.hints <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutotuneHint, ReductionHint, TileHint, instance_descriptor, DeviceProperties</span>
<span id="cb30-8"></span>
<span id="cb30-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@triton_heuristics.persistent_reduction</span>(</span>
<span id="cb30-10">    size_hints<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>],</span>
<span id="cb30-11">    reduction_hint<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ReductionHint.INNER,</span>
<span id="cb30-12">    filename<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__file__</span>,</span>
<span id="cb30-13">    triton_meta<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'signature'</span>: {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*fp32'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*fp32'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'i32'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'i32'</span>}, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'device'</span>: DeviceProperties(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cuda'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, cc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">89</span>, major<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, regs_per_multiprocessor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65536</span>, max_threads_per_multi_processor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1536</span>, multi_processor_count<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'constants'</span>: {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>}, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'configs'</span>: [AttrsDescriptor(divisible_by_16<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), equal_to_1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,))]},</span>
<span id="cb30-14">    inductor_meta<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'autotune_hints'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'kernel_name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'triton_per_fused_sum_0'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mutated_arg_names'</span>: [], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'no_x_dim'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_load'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'num_reduction'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'backend_hash'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'2A9CF09493B10CFF69FD04C0FEC21CD676E4FE3810C6D0938868EF378B24086E'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'are_deterministic_algorithms_enabled'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'assert_indirect_indexing'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'autotune_local_cache'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'autotune_pointwise'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'autotune_remote_cache'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'force_disable_caches'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dynamic_scale_rblock'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_autotune'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_autotune_pointwise'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min_split_scan_rblock'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'spill_threshold'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'store_cubin'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>}</span>
<span id="cb30-15">)</span>
<span id="cb30-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@triton.jit</span></span>
<span id="cb30-17"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> triton_(in_ptr0, out_ptr0, xnumel, rnumel, XBLOCK : tl.constexpr):</span>
<span id="cb30-18">    xnumel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb30-19">    rnumel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb30-20">    RBLOCK: tl.constexpr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb30-21">    xoffset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.program_id(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> XBLOCK</span>
<span id="cb30-22">    xindex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xoffset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tl.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, XBLOCK)[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb30-23">    xmask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xindex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> xnumel</span>
<span id="cb30-24">    rindex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, RBLOCK)[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]</span>
<span id="cb30-25">    roffset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb30-26">    rmask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rindex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> rnumel</span>
<span id="cb30-27">    r0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rindex</span>
<span id="cb30-28">    tmp0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.load(in_ptr0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (r0), rmask, other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb30-29">    tmp1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.broadcast_to(tmp0, [XBLOCK, RBLOCK])</span>
<span id="cb30-30">    tmp3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.where(rmask, tmp1, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb30-31">    tmp4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tl.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(tmp3, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb30-32">    tl.store(out_ptr0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (tl.full([XBLOCK, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, tl.int32)), tmp4, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span></code></pre></div></li>
<li><p><strong>Heuristics:</strong> Trident uses heuristics to determine optimal kernel launch parameters and optimizations.</p>
<ul>
<li><a href="https://github.com/pytorch/pytorch/blob/main/torch/_inductor/runtime/triton_heuristics.py">torch/_inductor/runtime/triton_heuristics.py</a></li>
</ul></li>
<li><p><strong>Examples:</strong></p>
<ul>
<li>Trident automatically detects reductions in PyTorch code.</li>
<li>Trident generates efficient kernels with appropriate block size and thread coarsening.</li>
<li>Trident provides hints for specific optimizations (e.g., reduction type, dimensions).</li>
</ul></li>
</ul>
</section>
<section id="triton" class="level3">
<h3 class="anchored" data-anchor-id="triton">Triton</h3>
<ul>
<li><strong>Hierarchical Reduction:</strong> Triton implements reductions using a hierarchical approach, similar to the CUDA implementations discussed.
<ul>
<li><a href="https://github.com/triton-lang/triton/blob/c99c2148f363e4806e02300d302ae0b52bb19388/lib/Conversion/TritonGPUToLLVM/ReduceOpToLLVM.cpp#L39">lib/Conversion/TritonGPUToLLVM/ReduceOpToLLVM.cpp</a></li>
</ul></li>
<li><strong>Examples:</strong>
<ul>
<li>Triton performs reduction within threads, within warps, within blocks, and finally across blocks.</li>
</ul></li>
<li><strong>Flexibility:</strong> Triton provides primitives for building custom reduction kernels with fine-grained control over the reduction process.</li>
</ul>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<ul>
<li><strong>Reductions are essential operations in GPU programming and machine learning.</strong></li>
<li><strong>Parallel reduction algorithms</strong> enable efficient implementation of reductions on GPUs.</li>
<li><strong>Thread strategies play a crucial role in optimizing parallel reductions.</strong></li>
<li><strong>Machine learning frameworks</strong> like PyTorch and Triton employ sophisticated techniques to generate optimized reduction kernels.</li>
<li><strong>Understanding reduction algorithms and implementation strategies is crucial for developing high-performance GPU code.</strong></li>
</ul>
</section>
<section id="call-to-action" class="level2">
<h2 class="anchored" data-anchor-id="call-to-action">Call to Action</h2>
<ul>
<li><strong>Start writing your own kernels!</strong> This is the best way to solidify your understanding and gain practical experience.</li>
<li><strong>Consider collaborating with others</strong> for motivation and support.</li>
<li><strong>Volunteer to give a lecture!</strong> Share your knowledge and experience with the community. Topics like Trident kernels, prefix sum, and NCCL are highly relevant.</li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/lecture-009/</guid>
  <pubDate>Sat, 14 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Notes on Trends in Deep Learning Hardware: Bill Dally (NVIDIA)</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/trends-in-deep-learning-hardware-bill-dally-nvidia/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<ul>
<li>Motivation and History</li>
<li>GPU Performance Improvements: Huang’s Law</li>
<li>Complex Instructions and Their Importance</li>
<li>NVIDIA Hopper GPU: Current State (2023)</li>
<li>Scaling with Multiple GPUs</li>
<li>The Importance of Software</li>
<li>Future Directions</li>
<li>Number Representation: Choosing the Right System</li>
<li>Logarithmic Number Systems</li>
<li>Optimal Clipping</li>
<li>Scaling Granularity</li>
<li>Sparsity</li>
<li>Accelerators vs.&nbsp;GPUs</li>
<li>Magnetic BERT Accelerator</li>
<li>Conclusion</li>
<li>Q&amp;A Session</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Source Material">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Source Material
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube:</strong> <a href="https://www.youtube.com/watch?v=kLiwvnr4L80">Trends in Deep Learning Hardware: Bill Dally (NVIDIA)</a></li>
</ul>
</div>
</div>
<section id="motivation-and-history" class="level2">
<h2 class="anchored" data-anchor-id="motivation-and-history">Motivation and History</h2>
<ul>
<li><strong>Deep learning</strong> can be viewed as a process of distilling data into value.
<ul>
<li>Starting with massive datasets (e.g., 10<sup>12</sup> tokens, 10<sup>9</sup> images).</li>
<li>Aiming to extract valuable insights, applications, and functionalities.</li>
</ul></li>
<li><strong>Deep learning models</strong> require a training process analogous to education:
<ul>
<li><strong>Undergraduate School (General Training):</strong>
<ul>
<li>Input: Trillion-token dataset (now exceeding 10 trillion).</li>
<li>Process: Extensive training on GPUs (e.g., via AWS).</li>
<li>Output: A broadly trained model with a general understanding of the data.</li>
</ul></li>
<li><strong>Graduate School (Specialization):</strong>
<ul>
<li><strong>Pre-tuning:</strong> Continued training on domain-specific data (e.g., Chip Nemo trained on 24 billion tokens of NVIDIA hardware design documents).</li>
<li><strong>Fine-tuning with Human Feedback:</strong> Model generates responses, humans grade them, and feedback refines the model for better user experience.</li>
</ul></li>
<li><strong>Inference (Real-World Application):</strong>
<ul>
<li>The bulk of deep learning computation occurs in the inference stage.</li>
<li>Trained models are used for extended periods, performing inference on new data (e.g., answering queries, generating content).</li>
<li><strong>Retrieval Augmented Generation:</strong>
<ul>
<li>Recent approach to enhance inference accuracy and prevent “hallucinations.”</li>
<li>Queries a database (e.g., Chip Nemo’s document database) before running the LLM.</li>
<li>Relevant documents are fed into the transformer’s input window along with the original query.</li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Deep learning’s revolution</strong> was enabled by hardware:
<ul>
<li><strong>Algorithms (Fuel):</strong> Mostly established by the 1980s (e.g., deep neural networks, convolutional networks, stochastic gradient descent, backpropagation).</li>
<li><strong>Data (Air):</strong> Large labeled datasets emerged in the early 2000s (e.g., Pascal, ImageNet).</li>
<li><strong>Computing Power (Spark):</strong> Sufficient compute to train large models on large datasets in reasonable time was the catalyst (e.g., AlexNet trained on ImageNet in two weeks on a pair of Fermi GPUs).</li>
</ul></li>
<li><strong>Progress in deep learning</strong> is gated by available compute power:
<ul>
<li>Training time demands have increased dramatically:
<ul>
<li>AlexNet (2012): 10<sup>-2</sup> petaflop days.</li>
<li>ResNet (2016): ~1 petaflop day.</li>
<li>BERT (2018): ~10 petaflop days.</li>
<li>GPT-4 (2023, estimated): ~10<sup>6</sup> petaflop days.</li>
</ul></li>
<li>This represents a 10<sup>8</sup> increase in compute demand over a decade.</li>
<li>Improvements have come from:
<ul>
<li><strong>Increased individual GPU performance (~1000x).</strong></li>
<li><strong>Scaling up GPU numbers and training time (~10<sup>6</sup>x).</strong></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="gpu-performance-improvements-huangs-law" class="level2">
<h2 class="anchored" data-anchor-id="gpu-performance-improvements-huangs-law">GPU Performance Improvements: Huang’s Law</h2>
<ul>
<li><strong>Huang’s Law:</strong> Deep learning inference performance on NVIDIA GPUs has doubled annually for the last decade.
<ul>
<li>Kepler generation: ~4 int8 TOPS (Tera Operations Per Second) on single-chip inference.</li>
<li>Hopper generation: ~4000 int8 TOPS.</li>
<li>This represents a ~1000x increase over 10 years.</li>
</ul></li>
<li><strong>Key contributors to performance gains:</strong>
<ul>
<li><strong>Smaller numbers (biggest gain):</strong>
<ul>
<li>Shifting from FP32 (used in Kepler for scientific computing and graphics) to int8 for inference.</li>
<li>Reduced data size (4x) and quadratic reduction in multiply operations (16x).</li>
<li>Note: Google TPU V1’s efficiency advantage over Kepler stemmed primarily from using int8 vs.&nbsp;Kepler’s FP32.</li>
</ul></li>
<li><strong>Complex instructions:</strong>
<ul>
<li>GPUs have a simplified pipeline (no branch prediction, out-of-order execution), but instruction execution still has significant overhead (~20x the cost of arithmetic within the instruction).</li>
<li><strong>Complex instructions amortize this overhead by performing more work per instruction.</strong></li>
<li>Examples:
<ul>
<li><strong>FMA (Fuse Multiply Add) in Kepler.</strong></li>
<li><strong>DP4 (4-element Dot Product) in Pascal.</strong></li>
<li><strong>HMMA (Half-precision Matrix Multiply Accumulate) in Volta.</strong></li>
<li><strong>IMMA (Integer Matrix Multiply Accumulate) in Turing.</strong></li>
<li>These instructions offer efficiency comparable to hardwired accelerators (e.g., TPUs).</li>
</ul></li>
</ul></li>
<li><strong>Process technology:</strong>
<ul>
<li>Four generations of process technology advancements (28nm to 5nm) contributed ~2.5x improvement.</li>
<li><strong>Most gains have come from architectural improvements, not process technology.</strong></li>
</ul></li>
<li><strong>Sparsity:</strong>
<ul>
<li>Exploiting sparsity (currently 2:1 on weights only) yields performance improvements.</li>
<li>Future potential lies in exploiting higher levels of sparsity and sparsity in activations.</li>
</ul></li>
<li><strong>Algorithm improvements:</strong>
<ul>
<li>More efficient deep learning models have also contributed significantly to performance gains (estimated ~1000x).</li>
<li>Example: GoogleNet’s efficiency improvements over VGGNet in the ImageNet competition.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="complex-instructions-and-their-importance" class="level2">
<h2 class="anchored" data-anchor-id="complex-instructions-and-their-importance">Complex Instructions and Their Importance</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Energy**</th>
<th>Overhead*</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HFMA</td>
<td>1.5pJ</td>
<td>2000%</td>
</tr>
<tr class="even">
<td>HDP4A</td>
<td>6.0pJ</td>
<td>500%</td>
</tr>
<tr class="odd">
<td>HMMA</td>
<td>110pJ</td>
<td>22%</td>
</tr>
<tr class="even">
<td>IMMA</td>
<td>160pJ</td>
<td>16%</td>
</tr>
</tbody>
</table>
<ul>
<li>Even simplified GPU pipelines have an overhead factor of ~20 for instruction execution compared to the cost of arithmetic operations within the instruction.</li>
<li>Complex CPUs have even higher overhead (~1000x for FP16 operations).</li>
<li><strong>Complex instructions are crucial for amortizing instruction overhead:</strong>
<ul>
<li><strong>FMA:</strong> Two arithmetic operations, overhead dominates energy consumption.</li>
<li><strong>DP4:</strong> Eight operations (4 multiplies, 4 adds), overhead reduced to ~5x.</li>
<li><strong>Tensor Cores (HMMA, IMMA, QMMA):</strong> Matrix multiply instructions perform hundreds of operations per instruction, significantly reducing overhead to ~15-20%.
<ul>
<li><strong>HMMA (Volta):</strong> Two FP16 4x4 matrices, matrix multiply (64 multiplies), accumulate into an FP32 4x4 matrix (128 total operations).</li>
<li><strong>IMMA (Turing):</strong> Two int8 8x8 matrices, matrix multiply and accumulate.</li>
<li><strong>QMMA (Hopper):</strong> Quarter-precision (FP8) matrix multiply accumulate.</li>
</ul></li>
</ul></li>
<li><strong>Complex instructions make programmable GPUs as efficient as hardwired accelerators for deep learning while retaining programmability advantages.</strong></li>
</ul>
</section>
<section id="nvidia-hopper-gpu-current-state-2023" class="level2">
<h2 class="anchored" data-anchor-id="nvidia-hopper-gpu-current-state-2023">NVIDIA Hopper GPU: Current State (2023)</h2>
<ul>
<li><strong>Hopper H100:</strong>
<ul>
<li>1 petaflop TensorFloat32.</li>
<li>1-2 petaflops FP16/BFloat16 (dense/sparse).</li>
<li>2-4 petaflops FP8/int8 (dense/sparse).</li>
<li>3 TB/s memory bandwidth.</li>
<li>96 GB HBM3 memory.</li>
<li>18 NVLink ports (900 GB/s off-chip bandwidth).</li>
<li>700 watts power consumption.</li>
<li>9 teraOPS/watt (int8/FP8).</li>
<li>Includes dynamic programming instructions for bioinformatics.</li>
</ul></li>
<li><strong>Note:</strong> Export restrictions to China may be counterproductive, potentially driving Chinese developers to Huawei’s hardware.</li>
</ul>
</section>
<section id="scaling-with-multiple-gpus" class="level2">
<h2 class="anchored" data-anchor-id="scaling-with-multiple-gpus">Scaling with Multiple GPUs</h2>
<ul>
<li><strong>Model Parallelism:</strong>
<ul>
<li>Necessary because large models (e.g., GPT-4 with 1.2 trillion parameters) don’t fit on a single GPU.</li>
<li><strong>Tensor Parallelism:</strong> Dividing individual matrices (e.g., into column strips) and distributing operations across multiple GPUs.</li>
<li><strong>Pipeline Parallelism:</strong> Assigning different network layers to different GPUs, forwarding results sequentially. Earlier layers start processing the next batch of training data while later layers finish the current batch.</li>
</ul></li>
<li><strong>Data Parallelism:</strong>
<ul>
<li>Running multiple copies of the model.</li>
<li>Splitting a batch of training data across model copies.</li>
<li>Each copy trains on its portion, then weight updates are exchanged to ensure all copies have the same weights for the next iteration.</li>
</ul></li>
<li><strong>Hardware for Multi-GPU Scaling:</strong>
<ul>
<li><strong>HGX Server:</strong> 8 H100 GPUs, 4 NV switches, 32 petaflops compute, 11 kilowatts power, 900 GB/s bandwidth.</li>
<li><strong>NV Switch Pizza Box:</strong> Connects multiple HGX servers with active optical cables.</li>
<li><strong>DGX SuperPOD:</strong> Large-scale system comprised of multiple interconnected HGX servers.
<ul>
<li><strong>Pre-configured software for rapid deployment.</strong></li>
<li><strong>Network collectives (all-reduce) on NVLink and InfiniBand for efficient data parallel training.</strong></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-importance-of-software" class="level2">
<h2 class="anchored" data-anchor-id="the-importance-of-software">The Importance of Software</h2>
<ul>
<li>“Anybody can build a matrix multiplier, but software makes it useful.”</li>
<li><strong>NVIDIA’s Deep Learning Software History:</strong>
<ul>
<li>Started in 2010 with cuDNN, developed in collaboration with Andrew Ng (Stanford).</li>
<li>Has evolved into a comprehensive software stack:
<ul>
<li><strong>AI Stack:</strong> CUDA, cuDNN, TensorRT, etc.</li>
<li><strong>HPC Stack:</strong> Libraries and tools for high-performance computing.</li>
<li><strong>Graphics Stack (Omniverse):</strong> Platform for 3D design collaboration and simulation.</li>
<li><strong>Vertical Applications:</strong> Clara (medical), Modulus (physics), Drive (autonomous vehicles), etc.</li>
</ul></li>
<li>Represents tens of thousands of person-years of development effort.</li>
</ul></li>
<li><strong>MLPerf Benchmarks:</strong> Demonstrate the impact of software on performance.
<ul>
<li>NVIDIA GPUs consistently lead in these benchmarks, showcasing the strength of the software ecosystem.</li>
<li><strong>Significant performance gains are achieved through software optimizations even on existing hardware (e.g., Ampere’s performance increased 2.5x since its initial release).</strong></li>
</ul></li>
</ul>
</section>
<section id="future-directions" class="level2">
<h2 class="anchored" data-anchor-id="future-directions">Future Directions</h2>
<ul>
<li><strong>The challenge:</strong> Meeting the ever-increasing compute demand for deep learning (10<sup>8</sup> increase in 10 years).</li>
<li><strong>Energy breakdown in deep learning inference:</strong>
<ul>
<li>Math (Datapath and MAC): 47%.</li>
<li>Memories (accumulation buffer, input buffer, weight buffer, accumulation collector): 47%.</li>
<li>Data movement: 6%.</li>
</ul></li>
<li><strong>Strategies for future improvements:</strong>
<ul>
<li><strong>Number Representation:</strong>
<ul>
<li><strong>Use the cheapest representation that maintains sufficient accuracy.</strong></li>
<li><strong>Optimal scaling:</strong> Adjust the dynamic range of the number system to minimize error (e.g., minimize mean squared error).</li>
<li><strong>Logarithmic numbers:</strong> Offer better accuracy than integers or floats, especially for small values. Efficient addition methods exist.</li>
<li><strong>Sparsity:</strong> Exploit sparsity in both weights and activations, explore lower density sparsity patterns.</li>
</ul></li>
<li><strong>Data Movement:</strong>
<ul>
<li><strong>Better tiling:</strong> Optimize loop scheduling to minimize data movement and maximize reuse.</li>
</ul></li>
<li><strong>Circuits:</strong>
<ul>
<li><strong>More efficient memories:</strong>
<ul>
<li><strong>Write-once, read-many optimizations (e.g., bit line per cell).</strong> This reduces read energy significantly.</li>
</ul></li>
<li><strong>Better communication circuits:</strong> Reduce energy consumption in on-chip data transfer (e.g., using lower voltage signaling).</li>
<li><strong>3D memory:</strong> Stack DRAM directly on top of the GPU for higher bandwidth and lower energy (long-term goal with significant technical challenges).</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="number-representation-choosing-the-right-system" class="level2">
<h2 class="anchored" data-anchor-id="number-representation-choosing-the-right-system">Number Representation: Choosing the Right System</h2>
<ul>
<li><strong>Evaluating a number system:</strong>
<ul>
<li><strong>Accuracy:</strong> Maximum error introduced when converting a real number to the number system’s representation (due to rounding).</li>
<li><strong>Dynamic Range:</strong> The range of numbers that can be represented.</li>
<li><strong>Cost:</strong>
<ul>
<li>Number of bits (affects storage and data movement).</li>
<li>Cost of arithmetic operations (e.g., multiply-accumulate).</li>
</ul></li>
</ul></li>
<li><strong>Comparison of number systems:</strong>
<ul>
<li><strong>Integer:</strong> Poor accuracy (error is independent of value), worst-case error of 33%.</li>
<li><strong>Floating Point:</strong> Better accuracy than integer, error scales with value but in blocks.</li>
<li><strong>Logarithmic:</strong> Even better accuracy, error scales continuously with value.
<ul>
<li>Example: Log 4.3 (8-bit representation) offers 50% higher worst-case accuracy than FP8 (E4M3) with the same dynamic range.</li>
</ul></li>
<li><strong>Symbolic:</strong> Optimal for a fixed number of representable values (e.g., codebook), but lookup and arithmetic costs can be high.</li>
<li><strong>Spiking:</strong> Extremely inefficient in terms of energy consumption due to high toggling activity.</li>
<li><strong>Analog:</strong> Advantages in individual operations are negated by the need for digital conversion for storage and movement.</li>
</ul></li>
</ul>
</section>
<section id="logarithmic-number-systems" class="level2">
<h2 class="anchored" data-anchor-id="logarithmic-number-systems">Logarithmic Number Systems</h2>
<ul>
<li><strong>Principle:</strong> Similar to slide rules, using logarithmic scales to turn multiplication into addition.</li>
<li><strong>Advantages:</strong>
<ul>
<li><strong>Cheap multiplications:</strong> Simple addition operation.</li>
<li><strong>High accuracy, especially for small values:</strong> Error scales continuously with value.</li>
</ul></li>
<li><strong>Challenges:</strong>
<ul>
<li><strong>Additions are traditionally expensive:</strong> Requires table lookups to convert between logarithmic and linear representations.</li>
</ul></li>
<li><strong>Efficient Addition in Logarithmic Systems:</strong>
<ul>
<li><strong>Factor out table lookups:</strong> Perform lookups once per tensor (e.g., 10,000 elements) instead of per element.</li>
<li><strong>Sort elements based on fractional exponent part (EF).</strong></li>
<li><strong>Add integer parts (EI) together efficiently.</strong></li>
<li><strong>Perform a single lookup (or use hardwired constants) for each EF value.</strong></li>
<li><strong>Multiply partial sums by the looked-up values.</strong></li>
<li><strong>Convert the final sum back to logarithmic form.</strong></li>
</ul></li>
</ul>
</section>
<section id="optimal-clipping" class="level2">
<h2 class="anchored" data-anchor-id="optimal-clipping">Optimal Clipping</h2>
<ul>
<li><p><strong>Goal:</strong> Minimize error by optimally centering the representable range of a number system on the distribution of values to be represented (e.g., weights or activations).</p></li>
<li><p><strong>Traditional Scaling:</strong></p>
<ul>
<li>Scale the number system to represent the minimum and maximum values without clipping.</li>
<li>No clipping noise, but high quantization noise due to large spacing between representable values.</li>
</ul></li>
<li><p><strong>Optimal Clipping:</strong></p>
<ul>
<li>Introduce clipping noise by saturating values outside a chosen range.</li>
<li><strong>Reduces quantization noise significantly.</strong></li>
<li><strong>Minimizes the overall error (e.g., mean squared error) by balancing clipping noise and quantization noise.</strong></li>
</ul></li>
<li><p><strong>Finding the optimal clipping point:</strong> <img src="https://latex.codecogs.com/png.latex?%0As_%7Bn+1%7D%20=%20%5Cfrac%7B%5Cmathbb%7BE%7D%5Cleft%5B%7CX%7C%20%5Ccdot%20%5Cmathbb%7B1%7D_%7B%5C%7B%7CX%7C%20%3E%20s_n%5C%7D%7D%5Cright%5D%7D%7B%5Cfrac%7B4%5E%7B-B%7D%7D%7B3%7D%20%5Cmathbb%7BE%7D%5Cleft%5B%5Cmathbb%7B1%7D_%7B%5C%7B%7CX%7C%20%5Cleq%20s_n%5C%7D%7D%5Cright%5D%20+%20%5Cmathbb%7BE%7D%5Cleft%5B%5Cmathbb%7B1%7D_%7B%5C%7B%7CX%7C%20%3E%20s_n%5C%7D%7D%5Cright%5D%7D%0A"></p>
<ul>
<li>An iterative equation approximates the integral that minimizes mean squared error.</li>
<li>A few iterations provide a good approximation of the optimal clipping range.</li>
</ul></li>
<li><p><strong>Benefits:</strong></p>
<ul>
<li><strong>Can be worth more than a bit of precision in terms of mean squared error.</strong></li>
<li><strong>Significantly improves accuracy, especially for lower-precision representations.</strong></li>
</ul></li>
<li><p><strong>Note:</strong> Clipping is typically done post-training, but training the clipping factor along with the model’s weights could potentially yield further improvements.</p></li>
</ul>
</section>
<section id="scaling-granularity" class="level2">
<h2 class="anchored" data-anchor-id="scaling-granularity">Scaling Granularity</h2>
<ul>
<li><strong>Layer-wise scaling:</strong> Initially used for both forward and backward propagation (separate scale factors).</li>
<li><strong>Finer granularity scaling (e.g., vector-wise):</strong> Improves accuracy by scaling smaller groups of elements independently.
<ul>
<li><strong>Example:</strong> In ConvNets, scaling each 32-element vector in the channel dimension independently.</li>
</ul></li>
<li><strong>Hardware support:</strong> Requires additional multipliers to apply activation and weight scale factors (SW and SA) after the MAC operation.</li>
<li><strong>Benefits:</strong> Tighter scaling for smaller groups of numbers leads to significantly reduced error, equivalent to gaining a couple of bits of precision.</li>
</ul>
</section>
<section id="sparsity" class="level2">
<h2 class="anchored" data-anchor-id="sparsity">Sparsity</h2>
<ul>
<li><strong>Pruning neural networks:</strong> Removing less important weights (e.g., based on magnitude or sensitivity) can significantly reduce the number of computations without significant accuracy loss.
<ul>
<li>Multi-layer perceptrons (MLPs): Can prune up to 90% of weights.</li>
<li>Convolutional neural networks (ConvNets): Can prune up to 60-70% of weights.</li>
</ul></li>
<li><strong>Challenges in implementing sparsity efficiently:</strong>
<ul>
<li><strong>Irregularity of sparsity patterns:</strong> Leads to high overhead for bookkeeping and data shuffling.</li>
<li><strong>Difficulty in parallelizing sparse computations efficiently.</strong></li>
</ul></li>
<li><strong>Structured Sparsity (Ampere and Hopper):</strong>
<ul>
<li><strong>Enforces a regular sparsity pattern (e.g., no more than 2 out of every 4 weights can be non-zero).</strong></li>
<li><strong>Dense training followed by structured pruning and retraining with a mask.</strong></li>
<li><strong>Compression by storing only non-zero weights and metadata indicating their positions.</strong></li>
<li><strong>Benefits:</strong> Predictable sparsity pattern enables efficient parallel computations, achieving ~2x speedup.</li>
</ul></li>
<li><strong>Future directions:</strong> Extending structured sparsity to activations and exploring other regular sparsity patterns.</li>
</ul>
</section>
<section id="accelerators-vs.-gpus" class="level2">
<h2 class="anchored" data-anchor-id="accelerators-vs.-gpus">Accelerators vs.&nbsp;GPUs</h2>
<ul>
<li><strong>NVIDIA’s accelerator projects:</strong> EIE, IRIS, SCNN, multi-chip module.</li>
<li><strong>How accelerators achieve performance:</strong>
<ul>
<li><strong>Special data types and operators:</strong> Similar to GPUs, using specialized data types (e.g., FP8) and complex instructions (e.g., matrix multiply).</li>
<li><strong>Massive parallelism:</strong> Exploiting parallelism to perform many operations concurrently.</li>
<li><strong>Optimized memory:</strong> Minimizing main memory accesses through hierarchical scratchpads and data reuse.</li>
<li><strong>Algorithm-architecture co-design:</strong> Adapting algorithms to the accelerator’s architecture for optimal performance (e.g., bioinformatics accelerator with efficient alignment engine).</li>
<li><strong>Reduced dramatized overhead:</strong> Simplifying control and data movement compared to CPUs.</li>
</ul></li>
<li><strong>Amortizing overhead:</strong> Crucial for efficiency.
<ul>
<li>Example: Simple ARM out-of-order core:
<ul>
<li>CPU instruction overhead: 250 picojoules.</li>
<li>16-bit integer add: 32 femtojoules.</li>
<li>Overhead dominates energy consumption (~99.99%).</li>
</ul></li>
</ul></li>
<li><strong>Memory access costs:</strong>
<ul>
<li>Local 8kB memory: 5 picojoules/word.</li>
<li>On-chip (hundreds of MB): 50 picojoules/word (45 picojoules for communication).</li>
<li>Off-chip LPDDR/HBM: 640 picojoules/word (32-bit).</li>
</ul></li>
</ul>
</section>
<section id="magnetic-bert-accelerator" class="level2">
<h2 class="anchored" data-anchor-id="magnetic-bert-accelerator">Magnetic BERT Accelerator</h2>
<ul>
<li><strong>Design:</strong>
<ul>
<li>Optimized for LLMs (BERT and BERT-large).</li>
<li>Incorporates optimal clipping and vector-level scaling (32-element vectors).</li>
<li>Achieves int4 (4-bit) inference with negligible accuracy loss.</li>
</ul></li>
<li><strong>Performance:</strong>
<ul>
<li><strong>95.6 teraOPS/watt for int8 operations (~10x more efficient than Hopper).</strong></li>
<li>Demonstrates the potential for further efficiency improvements in future GPU designs.</li>
</ul></li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<ul>
<li>Deep learning’s progress is heavily reliant on hardware advancements.</li>
<li>GPUs have provided significant performance gains (~1000x in 10 years) through architectural innovations (smaller numbers, complex instructions, sparsity).</li>
<li>Scaling with multiple GPUs and longer training times has enabled the training of increasingly large models.</li>
<li><strong>Future directions focus on:</strong>
<ul>
<li>Number representation (logarithmic numbers, optimal clipping, scaling granularity).</li>
<li>Sparsity (exploiting higher levels and activation sparsity).</li>
<li>Memory and circuit optimizations (efficient memories, communication circuits, 3D memory).</li>
<li>Algorithm-architecture co-design.</li>
</ul></li>
<li><strong>Accelerators like Magnetic BERT demonstrate the potential for further efficiency gains, paving the way for future GPU architectures.</strong></li>
</ul>
</section>
<section id="qa-session" class="level2">
<h2 class="anchored" data-anchor-id="qa-session">Q&amp;A Session</h2>
<section id="question-1-network-size-optimization-and-pruning-techniques" class="level4">
<h4 class="anchored" data-anchor-id="question-1-network-size-optimization-and-pruning-techniques">Question 1: Network Size Optimization and Pruning Techniques</h4>
<ul>
<li><strong>Question:</strong> What techniques are used for optimizing network size (pruning)?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Neural Architecture Search:</strong> A team at NVIDIA uses neural architecture search to find optimal models based on various parameters (number of layers, channels per layer, layer sizes, etc.) given constraints on accuracy, execution time, or power.</li>
<li><strong>Pruning Techniques:</strong>
<ul>
<li><strong>Magnitude-based pruning (most common):</strong>
<ul>
<li>Scan weights in a layer and prune those with the smallest magnitudes based on a target density.</li>
<li>Essentially histograms the layer and sets weights below a threshold to zero.</li>
</ul></li>
<li><strong>Sensitivity-based pruning (more complex but potentially more effective):</strong>
<ul>
<li>Considers both the weight value and the sensitivity of the weight’s connections to the output.</li>
<li>Prunes weights with the least sensitivity, taking into account both the weight value and its impact on the output.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="question-2-energy-savings-breakdown-for-complex-instructions" class="level4">
<h4 class="anchored" data-anchor-id="question-2-energy-savings-breakdown-for-complex-instructions">Question 2: Energy Savings Breakdown for Complex Instructions</h4>
<ul>
<li><strong>Question:</strong> Regarding the energy savings from complex instructions, could you elaborate on the breakdown between fetch/decode savings and operand loading savings?</li>
<li><strong>Answer:</strong> While the exact breakdown isn’t readily available, Dally believes that the majority of energy savings come from reduced fetch and decode operations. However, more detailed analysis would be required to provide specific numbers.</li>
</ul>
</section>
<section id="question-3-systolic-array-architectures-vs.-nvidias-approach" class="level4">
<h4 class="anchored" data-anchor-id="question-3-systolic-array-architectures-vs.-nvidias-approach">Question 3: Systolic Array Architectures vs.&nbsp;NVIDIA’s Approach</h4>
<ul>
<li><strong>Question:</strong> Does NVIDIA use systolic arrays for matrix multiplications, like Google’s TPU?</li>
<li><strong>Answer:</strong>
<ul>
<li>NVIDIA uses smaller matrix multiplies (4x4 for FP16/BFloat16) compared to Google’s TPUs, which often use larger sizes (e.g., 128x128).</li>
<li>Smaller matrix sizes help avoid fragmentation issues that can arise when the natural matrix size isn’t a power of two. Large matrix multipliers can lead to significant rounding-up inefficiencies.</li>
<li>While NVIDIA’s approach isn’t systolic, the efficiency of the core matrix multiply operation is comparable. The energy cost is dominated by the math units themselves.</li>
<li>NVIDIA feeds matrix multipliers from register files, potentially incurring slightly higher shuffling overhead for smaller matrices compared to systolic arrays.</li>
<li>However, even this overhead is likely minimal (estimated around 10%) and comparable to the data movement costs in systolic arrays. Google’s TPUs still require data movement to feed the systolic array, and they also have control overhead.</li>
</ul></li>
</ul>
</section>
<section id="question-4-hardwaresoftware-implementation-of-clipping" class="level4">
<h4 class="anchored" data-anchor-id="question-4-hardwaresoftware-implementation-of-clipping">Question 4: Hardware/Software Implementation of Clipping</h4>
<ul>
<li><strong>Question:</strong> Is the clipping technique implemented in hardware, software, or programmable hardware like FPGAs?</li>
<li><strong>Answer:</strong>
<ul>
<li>Clipping is primarily implemented in software.</li>
<li>NVIDIA GPUs already have the capability to use scale factors for adjusting the dynamic range of number representations.</li>
<li>Clipping simply involves choosing a larger scale factor, causing some numbers to saturate to the maximum representable value.</li>
<li>The only hardware requirement is the presence of multipliers for applying activation and weight scale factors (SW and SA), which are already present in GPUs that support scaling.</li>
<li>The clipping itself and the granularity of scaling are software-controlled, allowing flexibility in implementation.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/trends-in-deep-learning-hardware-bill-dally-nvidia/</guid>
  <pubDate>Wed, 11 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>CUDA MODE Lecture 8: CUDA Performance Checklist</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/lecture-008/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<ul>
<li>Introduction</li>
<li>The Importance of SRAM</li>
<li>CUDA Performance Tricks</li>
<li>Memory Latency and the Roofline Model</li>
<li>Case Study 1: Coalescing Global Memory Accesses</li>
<li>Case Study 2: Maximizing Occupancy</li>
<li>Understanding Memory vs.&nbsp;Compute Bound Workloads</li>
<li>Case Study 3: Minimizing Control Divergence</li>
<li>Case Study 4: Thread Coarsening</li>
<li>Case Study 5: Privatization</li>
<li>Case Study 6: Rewriting Algorithms with Better Math (Flash Attention)</li>
<li>Conclusion</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Resource Links:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Resource Links:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube Recording:</strong> <a href="https://www.youtube.com/watch?v=SGhfUhlowB4">Lecture 8: CUDA Performance Checklist</a></li>
<li><strong>Slides:</strong> <a href="https://docs.google.com/presentation/d/1cvVpf3ChFFiY4Kf25S4e4sPY6Y5uRUO-X-A4nJ7IhFE/edit#slide=id.p">CUDA Performance Checklist</a></li>
<li><strong>Code:</strong> <a href="https://github.com/cuda-mode/lectures/tree/main/lecture_008">lecture_008</a></li>
<li><strong>Lightning AI Studio:</strong> <a href="https://lightning.ai/msaroufim/studios/cuda-mode-lectures?section=featured&amp;query=cuda+mode">CUDA Mode Lectures</a></li>
</ul>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li><strong>Mark Saroufim</strong>, an engineer on the PyTorch team at Meta, presents a re-recorded talk on CUDA performance checklist.</li>
<li>This talk is a direct sequel to <a href="../lecture-001/">Lecture 1</a>, which focused on the importance of GPU performance.</li>
<li>This lecture covers common tricks to improve CUDA and PyTorch performance.</li>
<li>The content follows a profiling-first approach, using <strong><a href="https://docs.nvidia.com/nsight-compute/NsightComputeCli/index.html">NCU</a></strong> (an NVIDIA CUDA Profiler) to validate hypotheses.</li>
<li>Running the examples requires a GPU; cloud vendor setup for NCU can be tricky.</li>
<li><a href="https://lightning.ai/studios">Lightning AI Studio</a> is recommended for cloud-based execution as NCU is already set up.</li>
<li><strong>Technical Report:</strong> <a href="https://arxiv.org/pdf/1804.06826">Dissecting the NVIDIA Volta GPU Architecture via Microbenchmarking</a></li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled" title="[Local NCU Permissions](https://developer.nvidia.com/nvidia-development-tools-solutions-err_nvgpuctrperm-permission-issue-performance-counters)">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<a href="https://developer.nvidia.com/nvidia-development-tools-solutions-err_nvgpuctrperm-permission-issue-performance-counters">Local NCU Permissions</a>
</div>
</div>
<div class="callout-body-container callout-body">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Allow access for any user (restart required)</span></span>
<span id="cb1-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">echo</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'options nvidia NVreg_RestrictProfilingToAdminUsers=0'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> tee /etc/modprobe.d/ncu-permissions.conf</span></code></pre></div>
</div>
</div>
</section>
<section id="the-importance-of-sram" class="level2">
<h2 class="anchored" data-anchor-id="the-importance-of-sram">The Importance of SRAM</h2>
<ul>
<li><strong>Blog Post:</strong> <a href="https://siliconvlsi.com/why-sram-is-faster-than-dram/">Why SRAM is faster than DRAM</a></li>
<li>The primary goal for CUDA performance is to minimize the use of DRAM (slow) and maximize the use of SRAM (fast).</li>
<li><strong>SRAM (Static RAM):</strong> Shared memory, on the order of kilobytes.</li>
<li><strong>DRAM (Dynamic RAM):</strong> Global memory, on the order of tens of gigabytes (e.g., 23GB, 40GB, 80GB).</li>
<li>SRAM is physically larger, more expensive (3-6x), and generates more heat than DRAM, limiting its size on GPUs.</li>
<li>Bill Dally (Chief Scientist at NVIDIA) provides insightful explanations of GPU architecture in his talks (recommended).
<ul>
<li><strong>YouTube:</strong> <a href="https://www.youtube.com/watch?v=kLiwvnr4L80">Trends in Deep Learning Hardware: Bill Dally (NVIDIA)</a></li>
<li><strong>Notes:</strong> <a href="../trends-in-deep-learning-hardware-bill-dally-nvidia/">Notes on <em>Trends in Deep Learning Hardware: Bill Dally (NVIDIA)</em></a></li>
</ul></li>
<li>Key takeaway: While hardware limitations exist, we can leverage software tricks to improve performance.</li>
</ul>
</section>
<section id="cuda-performance-tricks" class="level2">
<h2 class="anchored" data-anchor-id="cuda-performance-tricks">CUDA Performance Tricks</h2>
<ul>
<li><strong>Coalescing global memory accesses:</strong> Ensuring contiguous memory access for efficient data transfer.</li>
<li><strong>Maximizing occupancy:</strong> Optimizing thread block and grid sizes to fully utilize GPU resources.</li>
<li><strong><em>Understanding memory or compute bound workloads:</em></strong> Identifying the bottleneck (memory bandwidth or compute capability) to guide optimization strategies.</li>
<li><strong>Minimizing control divergence:</strong> Ensuring threads within a warp execute similar instructions to avoid idle time.</li>
<li><strong>Tiling of reused data:</strong> Storing frequently accessed data in shared memory (SRAM) for faster access (covered in <a href="../lecture-005/">Lecture 5</a>).</li>
<li><strong>Privatization:</strong> Utilizing local copies of data to minimize global memory accesses.</li>
<li><strong>Thread coarsening:</strong> Increasing the workload per thread, particularly beneficial for memory-bound kernels.</li>
<li><strong><em>Rewriting algorithms using better math:</em></strong> Employing algorithmic and mathematical optimizations to improve performance (e.g., Flash Attention).</li>
<li>Most of these tricks are discussed in the “Programming Massively Parallel Processors” (PMPP) book.</li>
</ul>
</section>
<section id="memory-latency-and-the-roofline-model" class="level2">
<h2 class="anchored" data-anchor-id="memory-latency-and-the-roofline-model">Memory Latency and the Roofline Model</h2>
<ul>
<li><strong>Latency:</strong> The time it takes to access a memory location.</li>
<li><strong>Paper:</strong> <a href="https://arxiv.org/abs/2208.11174">Demystifying the Nvidia Ampere Architecture through Microbenchmarking and Instruction-level Analysis</a></li>
<li><strong>Global memory latency:</strong> ~290 cycles (from “Demystifying the NVIDIA Ampere Architecture…” paper).</li>
<li><strong>L2 cache latency:</strong> ~200 cycles.</li>
<li><strong>L1 cache latency:</strong> ~33 cycles (10x reduction compared to global memory).</li>
<li><strong>Shared memory latency:</strong> Similar to L1 cache (23/19).</li>
<li>GPU memory access is non-deterministic due to the implicit management of L1 and L2 caches.</li>
<li><strong>“<a href="http://www.stuartcheshire.org/rants/latency.html">It’s the Latency, Stupid</a>” article:</strong> Explains the challenges of reducing latency; throughput can be increased by parallelism, but latency reduction requires fundamental changes.</li>
<li><strong>Quantization:</strong> Reduces latency by using smaller data types (e.g., int8 instead of float32), but may impact accuracy.</li>
<li><strong>Roofline Model:</strong>
<ul>
<li><strong>Operational Intensity:</strong> (Total operations) / (Total memory accesses)</li>
<li><strong>X-axis:</strong> Operational Intensity.</li>
<li><strong>Y-axis:</strong> Performance.</li>
<li><strong>Memory-bound workloads:</strong> Performance limited by memory bandwidth (low operational intensity).</li>
<li><strong>Compute-bound workloads:</strong> Performance limited by GPU compute capability (high operational intensity).</li>
</ul></li>
</ul>
</section>
<section id="case-study-1-coalescing-global-memory-accesses" class="level2">
<h2 class="anchored" data-anchor-id="case-study-1-coalescing-global-memory-accesses">Case Study 1: Coalescing Global Memory Accesses</h2>
<ul>
<li><p><strong>Goal:</strong> Demonstrate the impact of coalesced vs.&nbsp;non-coalesced memory accesses.</p></li>
<li><p><strong>Kernel:</strong> Copies data from one memory location to another.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb2-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb2-3"></span>
<span id="cb2-4">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> copyDataNonCoalesced<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-7">        out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb2-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-10"></span>
<span id="cb2-11">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> copyDataCoalesced<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-14">        out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb2-15">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-17"></span>
<span id="cb2-18"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> initializeArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-20">        arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-21">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-22"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-23"></span>
<span id="cb2-24"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb2-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Increase n to have a larger workload</span></span>
<span id="cb2-26">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-27"></span>
<span id="cb2-28">    cudaMallocManaged<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb2-29">    cudaMallocManaged<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb2-30"></span>
<span id="cb2-31">    initializeArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-32"></span>
<span id="cb2-33">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> blockSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Define block size</span></span>
<span id="cb2-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// int blockSize = 1024; // change this when talking about occupancy</span></span>
<span id="cb2-35">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> numBlocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> blockSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> blockSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Ensure there are enough blocks to cover all elements</span></span>
<span id="cb2-36"></span>
<span id="cb2-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch non-coalesced kernel</span></span>
<span id="cb2-38">    copyDataNonCoalesced<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>numBlocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> blockSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-39">    cudaDeviceSynchronize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-40"></span>
<span id="cb2-41">    initializeArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Reset output array</span></span>
<span id="cb2-42"></span>
<span id="cb2-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch coalesced kernel</span></span>
<span id="cb2-44">    copyDataCoalesced<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>numBlocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> blockSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-45">    cudaDeviceSynchronize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb2-46"></span>
<span id="cb2-47">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-48">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb2-49"></span>
<span id="cb2-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-51"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li><strong>Coalesced version:</strong> Threads access contiguous memory locations.</li>
<li><strong>Non-coalesced version:</strong> Threads access memory locations with strides (skipping elements).</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called benchmark</span></span>
<span id="cb3-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> benchmark coalesce.cu</span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the benchmark</span></span>
<span id="cb3-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> benchmark</span></code></pre></div></li>
<li><p><strong>Metrics:</strong> DRAM throughput, L1 cache throughput, kernel duration.</p></li>
<li><p><strong>Lecture Results (T4):</strong></p>
<ul>
<li><p><strong>Non-coalesced:</strong> Lower L1 cache throughput, higher DRAM throughput, slower kernel duration.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>cycle/nsecond</td>
<td>4.97</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>cycle/usecond</td>
<td>581.85</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>444595</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>89.74</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>89.74</td>
</tr>
<tr class="even">
<td><strong>Duration</strong></td>
<td>usecond</td>
<td><strong>764.10</strong></td>
</tr>
<tr class="odd">
<td><strong>L1/TEX Cache Throughput</strong></td>
<td>%</td>
<td><strong>29.51</strong></td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>30.26</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>443190.15</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>25.06</td>
</tr>
</tbody>
</table></li>
<li><p><strong>Coalesced:</strong> Higher L1 cache throughput, lower DRAM throughput, significantly faster kernel duration.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>cycle/nsecond</td>
<td>4.97</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>cycle/usecond</td>
<td>582.33</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>325426</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>82.13</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>82.13</td>
</tr>
<tr class="even">
<td><strong>Duration</strong></td>
<td>usecond</td>
<td><strong>558.82</strong></td>
</tr>
<tr class="odd">
<td><strong>L1/TEX Cache Throughput</strong></td>
<td>%</td>
<td><strong>36.70</strong></td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>27.57</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>323347.40</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>24.17</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p><strong>Personal Results (RTX 4090):</strong></p>
<ul>
<li><p><strong>Non-coalesced:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.49</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.23</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>458,344</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>94.34</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>94.34</td>
</tr>
<tr class="even">
<td><strong>Duration</strong></td>
<td>us</td>
<td><strong>205.12</strong></td>
</tr>
<tr class="odd">
<td><strong>L1/TEX Cache Throughput</strong></td>
<td>%</td>
<td><strong>9.52</strong></td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>34.92</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>414,499.87</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>8.31</td>
</tr>
</tbody>
</table></li>
<li><p><strong>Coalesced:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.49</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.23</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>265,803</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>93.54</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>93.54</td>
</tr>
<tr class="even">
<td><strong>Duration</strong></td>
<td>us</td>
<td><strong>118.98</strong></td>
</tr>
<tr class="odd">
<td><strong>L1/TEX Cache Throughput</strong></td>
<td>%</td>
<td><strong>17.47</strong></td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>31.50</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>206,343.47</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>11.56</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p><strong>Key takeaway:</strong> Coalesced memory accesses significantly improve performance, especially for larger inputs.</p>
<p>​</p></li>
</ul>
</section>
<section id="case-study-2-maximizing-occupancy" class="level2">
<h2 class="anchored" data-anchor-id="case-study-2-maximizing-occupancy">Case Study 2: Maximizing Occupancy</h2>
<ul>
<li><p><strong>Occupancy:</strong> The ratio of active warps to the maximum number of warps a streaming multiprocessor (SM) can handle.</p></li>
<li><p><strong>Tile Quantization:</strong> Occurs when matrix dimensions are not divisible by the thread block tile size.</p></li>
<li><p><strong>Wave Quantization:</strong> Occurs when the total number of tiles is not divisible by the number of SMs.</p></li>
<li><p><strong>NCU Warning:</strong> Indicates tile or wave quantization issues.</p></li>
<li><p><strong>Example:</strong> Matrix multiplication with varying inner dimension (k).</p>
<ul>
<li><strong>NVIDIA Documentation:</strong> <a href="https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html">Matrix Multiplication Background User’s Guide</a></li>
</ul></li>
<li><p><strong>Results:</strong> Performance can vary significantly (up to 4x) depending on the divisibility of k by the optimal tile size.</p></li>
<li><p><strong>Padding:</strong> A common technique in PyTorch to ensure matrix dimensions are multiples of optimal values.</p></li>
<li><p><strong>Optimal Tile Sizes (from <a href="https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html#requirements-tc">Matrix Multiplication Background User’s Guide</a>):</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 32%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th>Tensor Cores can be used for…</th>
<th>cuBLAS version &lt; 11.0 cuDNN version &lt; 7.6.3</th>
<th>cuBLAS version ≥ 11.0 cuDNN version ≥ 7.6.3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>INT8</td>
<td>Multiples of 16</td>
<td>Always but most efficient with multiples of 16; on A100, multiples of 128.</td>
</tr>
<tr class="even">
<td>FP16</td>
<td>Multiples of 8</td>
<td>Always but most efficient with multiples of 8; on A100, multiples of 64.</td>
</tr>
<tr class="odd">
<td>TF32</td>
<td>N/A</td>
<td>Always but most efficient with multiples of 4; on A100, multiples of 32.</td>
</tr>
<tr class="even">
<td>FP64</td>
<td>N/A</td>
<td>Always but most efficient with multiples of 2; on A100, multiples of 16.</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>A100 (Tensor Cores):</strong> int8 (multiples of 16, 128), FP16 (multiples of 8, 64), TF32 (multiples of 4, 32), FP64 (multiples of 2, 16).</li>
</ul></li>
<li><p><strong>CUDA Occupancy Calculator:</strong> A tool that recommends optimal block and grid sizes for a given kernel and hardware.</p></li>
<li><p><strong>Example:</strong> Using <code>cudaOccupancyMaxPotentialBlockSize</code> function to determine optimal block and grid sizes.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;iostream&gt;</span></span>
<span id="cb4-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb4-3"></span>
<span id="cb4-4">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> copyDataCoalesced<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-7">        out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb4-8">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-9"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> initializeArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-13">        arr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">static_cast</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;(</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-14">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-15"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Adjust the data size for workload</span></span>
<span id="cb4-19">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-20"></span>
<span id="cb4-21">    cudaMallocManaged<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb4-22">    cudaMallocManaged<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb4-23"></span>
<span id="cb4-24">    initializeArray<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-25"></span>
<span id="cb4-26">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> blockSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Optimal block size for many devices</span></span>
<span id="cb4-27">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> numBlocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> blockSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> blockSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Calculate the number of blocks</span></span>
<span id="cb4-28"></span>
<span id="cb4-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Optimize grid dimensions based on device properties</span></span>
<span id="cb4-30">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> minGridSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-31">    cudaOccupancyMaxPotentialBlockSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>minGridSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>blockSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> copyDataCoalesced<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-32"></span>
<span id="cb4-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Print suggested block size and minimum grid size</span></span>
<span id="cb4-34">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>cout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Recommended block size: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> blockSize</span>
<span id="cb4-35">              <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", Minimum grid size: "</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> minGridSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">std::</span>endl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-36"></span>
<span id="cb4-37">    numBlocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> blockSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> blockSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-38"></span>
<span id="cb4-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch coalesced kernel</span></span>
<span id="cb4-40">    copyDataCoalesced<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>numBlocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> blockSize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-41">    cudaDeviceSynchronize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">();</span></span>
<span id="cb4-42"></span>
<span id="cb4-43">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-44">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb4-45"></span>
<span id="cb4-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb4-47"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called benchmark</span></span>
<span id="cb5-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> benchmark occupancy.cu</span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the benchmark</span></span>
<span id="cb5-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> benchmark</span></code></pre></div></li>
<li><p><strong>Lecture Results (T4):</strong> Significant performance improvement by using recommended block and grid sizes.</p>
<pre class="text"><code>Recommended block size: 1024, Minimum grid size: 40</code></pre></li>
<li><p><strong>Personal Results (RTX 4090):</strong></p>
<pre class="text"><code>Recommended block size: 768, Minimum grid size: 256</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.49</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.23</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>265,182</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>93.62</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>93.62</td>
</tr>
<tr class="even">
<td><strong>Duration</strong></td>
<td>us</td>
<td><strong>118.69</strong></td>
</tr>
<tr class="odd">
<td><strong>L1/TEX Cache Throughput</strong></td>
<td>%</td>
<td><strong>17.08</strong></td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>28.70</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>246,167.14</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>11.32</td>
</tr>
</tbody>
</table></li>
<li><p><strong>Key takeaway:</strong> Maximizing occupancy is crucial for achieving optimal performance, especially for compute-bound kernels.</p></li>
</ul>
</section>
<section id="understanding-memory-vs.-compute-bound-workloads" class="level2">
<h2 class="anchored" data-anchor-id="understanding-memory-vs.-compute-bound-workloads">Understanding Memory vs.&nbsp;Compute Bound Workloads</h2>
<ul>
<li><p><strong>Slides:</strong> <a href="https://developer.download.nvidia.com/video/gputechconf/gtc/2019/presentation/s9926-tensor-core-performance-the-ultimate-guide.pdf">NVIDIA Tensor Core DL Performance Guide</a></p></li>
<li><p><strong>Memory-bound kernels:</strong> Bottlenecked by memory bandwidth.</p></li>
<li><p><strong>Compute-bound kernels:</strong> Bottlenecked by GPU compute capability.</p></li>
<li><p><strong>Operational Intensity:</strong> A key metric to determine if a kernel is memory or compute bound.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Operation</th>
<th>Arithmetic Intensity</th>
<th>Limiter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Residual addition</td>
<td>0.166</td>
<td>Memory</td>
</tr>
<tr class="even">
<td>ReLU activation</td>
<td>0.25</td>
<td>Memory</td>
</tr>
<tr class="odd">
<td>Batch normalization</td>
<td>O(10)</td>
<td>Memory</td>
</tr>
<tr class="even">
<td>Convolution</td>
<td>1-10000+</td>
<td>Memory/Math</td>
</tr>
</tbody>
</table></li>
<li><p><strong>Examples of Arithmetic Intensity Calculation:</strong></p>
<ul>
<li><strong>Pointwise Functions (e.g., ReLU):</strong>
<ul>
<li><strong>Float32:</strong> Arithmetic intensity of 1/8 (general case) or 1/4 (best case).</li>
<li><strong>Float16:</strong> Arithmetic intensity of 1/4.</li>
</ul></li>
<li><strong>Matrix Multiplication:</strong>
<ul>
<li><strong><code>A = [m,n]</code> <code>B = [n,k]</code>:</strong> 2mnk / (mn + nk + mk)</li>
<li>Generally compute-bound for larger matrices.</li>
<li>Can become memory bandwidth bound for very small matrices.</li>
</ul></li>
</ul></li>
<li><p><strong>Optimizations for Memory-Bound Kernels:</strong></p>
<ul>
<li><strong>Fusions:</strong> Combining multiple operations into a single kernel to reduce memory accesses.</li>
<li><strong>Quantization:</strong> Reducing data type size to improve arithmetic intensity.</li>
<li><strong>Compilation:</strong> Using compilers like Torch Compiler to optimize memory access patterns and reduce overhead.</li>
</ul></li>
<li><p><strong>Optimizations for Compute-Bound Kernels:</strong></p>
<ul>
<li><strong>Algorithm optimization:</strong> Rewriting the algorithm with fewer operations or improved mathematical formulations.</li>
</ul></li>
<li><p><strong>Key takeaway:</strong> Understanding the bottleneck (memory or compute) is crucial for selecting the right optimization strategies.</p></li>
</ul>
</section>
<section id="case-study-3-minimizing-control-divergence" class="level2">
<h2 class="anchored" data-anchor-id="case-study-3-minimizing-control-divergence">Case Study 3: Minimizing Control Divergence</h2>
<ul>
<li><p><strong>Control Divergence:</strong> Occurs when threads within a warp execute different instructions due to conditional statements (if-else).</p></li>
<li><p><strong>Warp:</strong> A group of 32 threads scheduled together on a SM.</p></li>
<li><p><strong>Problem:</strong> Divergent threads can lead to idle time and reduced performance.</p></li>
<li><p><strong>Example:</strong> Kernel with an if-else statement based on even/odd element values.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdio.h&gt;</span></span>
<span id="cb8-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb8-3"></span>
<span id="cb8-4">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> processArrayWithDivergence<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-8">            data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-9">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-10">            data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-11">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-12">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-14"></span>
<span id="cb8-15">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> processArrayWithoutDivergence<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-16">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-18">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> isEven <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!(</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-19">        data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> isEven <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(!</span>isEven<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-20">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-21"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-22"></span>
<span id="cb8-23"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> benchmarkKernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(*</span>kernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">char</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>kernelName<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-24">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>devData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-25">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>devData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb8-26">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>devData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-27"></span>
<span id="cb8-28">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">cudaEvent_t</span> start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-29">    cudaEventCreate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-30">    cudaEventCreate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-31"></span>
<span id="cb8-32">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-33">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> blocksPerGrid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-34"></span>
<span id="cb8-35">    cudaEventRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-36">    kernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>blocksPerGrid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>devData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-37">    cudaEventRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-38"></span>
<span id="cb8-39">    cudaEventSynchronize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-40"></span>
<span id="cb8-41">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> milliseconds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-42">    cudaEventElapsedTime<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>milliseconds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-43"></span>
<span id="cb8-44">    printf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%s</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> took </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> milliseconds</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> kernelName<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> milliseconds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-45"></span>
<span id="cb8-46">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> devData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-47">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>devData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-48">    cudaEventDestroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-49">    cudaEventDestroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-50"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-51"></span>
<span id="cb8-52"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Example size</span></span>
<span id="cb8-54">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb8-55"></span>
<span id="cb8-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize data</span></span>
<span id="cb8-57">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb8-58">        data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-59">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb8-60"></span>
<span id="cb8-61">    benchmarkKernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>processArrayWithDivergence<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processArrayWithDivergence"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-62">    benchmarkKernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>processArrayWithoutDivergence<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"processArrayWithoutDivergence"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-63"></span>
<span id="cb8-64">    free<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb8-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb8-66"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li><strong>Solution:</strong> Rewrite the if-else statement using clever algebra to eliminate branching.</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called benchmark</span></span>
<span id="cb9-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> benchmark divergence.cu</span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the benchmark</span></span>
<span id="cb9-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--set</span> full benchmark</span></code></pre></div></li>
<li><p><strong>Lecture Results (T4):</strong> Significant performance improvement (up to 3x speedup) by reducing branch instructions and improving warp efficiency.</p>
<ul>
<li><p>With Divergence:</p>
<pre class="text"><code>processArrayWithDivergence took 0.074272 milliseconds</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Branch Instructions Ratio</td>
<td>%</td>
<td>0.18</td>
</tr>
<tr class="even">
<td>Branch Instructions</td>
<td>inst</td>
<td>98304</td>
</tr>
<tr class="odd">
<td>Branch Efficiency</td>
<td>%</td>
<td>0</td>
</tr>
<tr class="even">
<td>Avg. Divergent Branches</td>
<td></td>
<td>0</td>
</tr>
</tbody>
</table></li>
<li><p>Without Divergence:</p>
<pre class="text"><code>processArrayWithoutDivergence took 0.024704 milliseconds</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Branch Instructions Ratio</td>
<td>%</td>
<td>0.13</td>
</tr>
<tr class="even">
<td>Branch Instructions</td>
<td>inst</td>
<td>65536</td>
</tr>
<tr class="odd">
<td>Branch Efficiency</td>
<td>%</td>
<td>0</td>
</tr>
<tr class="even">
<td>Avg. Divergent Branches</td>
<td>-</td>
<td>0</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p><strong>Personal Results (RTX 4090):</strong></p>
<ul>
<li><p>With Divergence:</p>
<pre class="text"><code>processArrayWithDivergence took 0.032224 milliseconds</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Branch Instructions Ratio</td>
<td>%</td>
<td>0.17</td>
</tr>
<tr class="even">
<td>Branch Instructions</td>
<td>inst</td>
<td>98,304</td>
</tr>
<tr class="odd">
<td>Branch Efficiency</td>
<td>%</td>
<td>0</td>
</tr>
<tr class="even">
<td>Avg. Divergent Branches</td>
<td></td>
<td>0</td>
</tr>
</tbody>
</table></li>
<li><p>Without Divergence:</p>
<pre class="text"><code>processArrayWithoutDivergence took 0.107680 milliseconds</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Branch Instructions Ratio</td>
<td>%</td>
<td>0.12</td>
</tr>
<tr class="even">
<td>Branch Instructions</td>
<td>inst</td>
<td>65,536</td>
</tr>
<tr class="odd">
<td>Branch Efficiency</td>
<td>%</td>
<td>0</td>
</tr>
<tr class="even">
<td>Avg. Divergent Branches</td>
<td></td>
<td>0</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p><strong>Key takeaway:</strong> Minimizing control divergence is important for maintaining high warp utilization and overall performance.</p></li>
</ul>
</section>
<section id="case-study-4-thread-coarsening" class="level2">
<h2 class="anchored" data-anchor-id="case-study-4-thread-coarsening">Case Study 4: Thread Coarsening</h2>
<ul>
<li><p><strong>Thread Coarsening:</strong> Increasing the workload per thread, especially beneficial for memory-bound kernels.</p></li>
<li><p><strong>Example:</strong> Vector addition kernel.</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb14-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdio.h&gt;</span></span>
<span id="cb14-2"></span>
<span id="cb14-3"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define N </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb14-4"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#define THREADS_PER_BLOCK </span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;"> </span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// This is just an example block size</span></span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Original vector addition kernel without coarsening</span></span>
<span id="cb14-7">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> VecAdd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb14-8"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb14-11">        C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb14-12"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-13"></span>
<span id="cb14-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Vector addition kernel with thread coarsening</span></span>
<span id="cb14-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Assuming a coarsening factor of 2</span></span>
<span id="cb14-16">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> VecAddCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb14-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-18">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Coarsening factor applied here</span></span>
<span id="cb14-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb14-20">        C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb14-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Handle the additional element due to coarsening</span></span>
<span id="cb14-22">        C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb14-23"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-24"></span>
<span id="cb14-25"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> random_init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb14-27">        data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rand<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span>RAND_MAX<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-28"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb14-29"></span>
<span id="cb14-30"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span></span>
<span id="cb14-31"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb14-32">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-33">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// device copies of a, b, c</span></span>
<span id="cb14-34">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-35"></span>
<span id="cb14-36">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate space for device copies of a, b, c</span></span>
<span id="cb14-37">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**)&amp;</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-38">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**)&amp;</span>d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-39">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">((</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**)&amp;</span>d_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-40"></span>
<span id="cb14-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate space for host copies of a, b, c and setup input values</span></span>
<span id="cb14-42">    a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> random_init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-43">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> random_init<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> N<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-44">    c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-45"></span>
<span id="cb14-46">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">cudaEvent_t</span> start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> startCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stopCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-47">    cudaEventCreate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-48">    cudaEventCreate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-49">    cudaEventCreate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>startCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-50">    cudaEventCreate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>stopCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-51"></span>
<span id="cb14-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy inputs to device</span></span>
<span id="cb14-53">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-54">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-55"></span>
<span id="cb14-56">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Start timer for VecAdd kernel</span></span>
<span id="cb14-57">    cudaEventRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-58">    VecAdd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;(</span>N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> THREADS_PER_BLOCK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> THREADS_PER_BLOCK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-59">    cudaEventRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-60"></span>
<span id="cb14-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Wait for VecAdd kernel to finish</span></span>
<span id="cb14-62">    cudaEventSynchronize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-63"></span>
<span id="cb14-64">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> milliseconds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-65">    cudaEventElapsedTime<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>milliseconds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-66">    printf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"VecAdd execution time: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> ms</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> milliseconds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-67"></span>
<span id="cb14-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Start timer for VecAddCoarsened kernel</span></span>
<span id="cb14-69">    cudaEventRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>startCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-70">    VecAddCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;(</span>N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>THREADS_PER_BLOCK <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>THREADS_PER_BLOCK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> THREADS_PER_BLOCK<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-71">    cudaEventRecord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stopCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-72"></span>
<span id="cb14-73">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Wait for VecAddCoarsened kernel to finish</span></span>
<span id="cb14-74">    cudaEventSynchronize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stopCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-75"></span>
<span id="cb14-76">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> millisecondsCoarsened <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-77">    cudaEventElapsedTime<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>millisecondsCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> startCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> stopCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-78">    printf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"VecAddCoarsened execution time: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%f</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> ms</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> millisecondsCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-79"></span>
<span id="cb14-80">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy result back to host</span></span>
<span id="cb14-81">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-82"></span>
<span id="cb14-83">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Clean up</span></span>
<span id="cb14-84">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-85">    free<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> free<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> free<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-86"></span>
<span id="cb14-87">    cudaEventDestroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>start<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-88">    cudaEventDestroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-89">    cudaEventDestroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>startCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-90">    cudaEventDestroy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>stopCoarsened<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb14-91"></span>
<span id="cb14-92">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb14-93"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li><strong>Standard version:</strong> Each thread handles one element.</li>
<li><strong>Coarsened version:</strong> Each thread handles two elements (coarsening factor of 2).</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called benchmark</span></span>
<span id="cb15-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> benchmark coarsening.cu</span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the benchmark</span></span>
<span id="cb15-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> benchmark</span></code></pre></div></li>
<li><p><strong>Lecture Results (T4):</strong> Dramatic performance improvement by reducing the number of memory accesses.</p>
<ul>
<li><p>Without Coarsening:</p>
<pre class="text"><code>VecAdd execution time: 0.235264 ms</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>cycle/nsecond</td>
<td>4.70</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>cycle/usecond</td>
<td>553.39</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>2321</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>0.81</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>0.81</td>
</tr>
<tr class="even">
<td>Duration</td>
<td>usecond</td>
<td>4.19</td>
</tr>
<tr class="odd">
<td>L1/TEX Cache Throughput</td>
<td>%</td>
<td>27.52</td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>0.72</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>29.07</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>0.28</td>
</tr>
</tbody>
</table></li>
<li><p>With Coarsening:</p>
<pre class="text"><code>VecAddCoarsened execution time: 0.020480 ms</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>cycle/nsecond</td>
<td>4.68</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>cycle/usecond</td>
<td>547.36</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>2488</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>1.10</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>1.10</td>
</tr>
<tr class="even">
<td>Duration</td>
<td>usecond</td>
<td>4.54</td>
</tr>
<tr class="odd">
<td>L1/TEX Cache Throughput</td>
<td>%</td>
<td>38.64</td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>0.74</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>33.12</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>0.26</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p><strong>Personal Results (RTX 4090):</strong></p>
<ul>
<li><p>Without Coarsening:</p>
<pre class="text"><code>VecAdd execution time: 0.082944 ms</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.19</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.17</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>4,244</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>0.67</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>0.57</td>
</tr>
<tr class="even">
<td>Duration</td>
<td>us</td>
<td>1.95</td>
</tr>
<tr class="odd">
<td>L1/TEX Cache Throughput</td>
<td>%</td>
<td>17.10</td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>0.67</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>52.64</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>0.05</td>
</tr>
</tbody>
</table></li>
<li><p>With Coarsening:</p>
<pre class="text"><code>VecAddCoarsened execution time: 0.008192 ms</code></pre>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.29</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.18</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>4,402</td>
</tr>
<tr class="even">
<td><strong>Memory Throughput</strong></td>
<td>%</td>
<td><strong>0.74</strong></td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>0.57</td>
</tr>
<tr class="even">
<td>Duration</td>
<td>us</td>
<td>2.02</td>
</tr>
<tr class="odd">
<td>L1/TEX Cache Throughput</td>
<td>%</td>
<td>29.11</td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>0.74</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>30.92</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>0.04</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p><strong>Note:</strong> Larger coarsening factors may not always yield further improvements (Zippy’s experiments in CUDA Mode Discord).</p></li>
<li><p><strong>Key takeaway:</strong> Thread coarsening can significantly improve performance for memory-bound kernels by reducing memory traffic.</p></li>
</ul>
</section>
<section id="case-study-5-privatization" class="level2">
<h2 class="anchored" data-anchor-id="case-study-5-privatization">Case Study 5: Privatization</h2>
<ul>
<li><p><strong>Privatization:</strong> Using local copies of data to minimize global memory accesses.</p></li>
<li><p><strong>Example 1:</strong> Vector addition with private variables.</p>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb20-1"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;stdio.h&gt;</span></span>
<span id="cb20-2"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#include </span><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// CUDA kernel for vector addition without privatization</span></span>
<span id="cb20-5">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> vectorAdd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-8">        result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span></span>
<span id="cb20-9">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-11"></span>
<span id="cb20-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// CUDA kernel for vector addition with privatization</span></span>
<span id="cb20-13">__global__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> vectorAddPrivatized<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">const</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threadIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> blockIdx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-16">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> a_private <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Load into private memory</span></span>
<span id="cb20-17">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> b_private <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">];</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Load into private memory</span></span>
<span id="cb20-18">        result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a_private <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b_private<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-19">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-21"></span>
<span id="cb20-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Function to initialize the vectors with dummy data</span></span>
<span id="cb20-23"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> initData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-25">        data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">[</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">]</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-27"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb20-28"></span>
<span id="cb20-29"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> main<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">()</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb20-30">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Size of the vectors</span></span>
<span id="cb20-31">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d_result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-32"></span>
<span id="cb20-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory on the host</span></span>
<span id="cb20-34">    a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb20-35">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb20-36">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*)</span>malloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb20-37"></span>
<span id="cb20-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Initialize vectors</span></span>
<span id="cb20-39">    initData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-40">    initData<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-41"></span>
<span id="cb20-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Allocate memory on the device</span></span>
<span id="cb20-43">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb20-44">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb20-45">    cudaMalloc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(&amp;</span>d_result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">));</span></span>
<span id="cb20-46"></span>
<span id="cb20-47">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy vectors from host to device</span></span>
<span id="cb20-48">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-49">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyHostToDevice<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-50"></span>
<span id="cb20-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Define number of blocks and threads</span></span>
<span id="cb20-52">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-53">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> blocksPerGrid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">)</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-54"></span>
<span id="cb20-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch the vector addition kernel without privatization</span></span>
<span id="cb20-56">    vectorAdd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>blocksPerGrid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-57"></span>
<span id="cb20-58">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy result back to host</span></span>
<span id="cb20-59">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-60"></span>
<span id="cb20-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Launch the vector addition kernel with privatization</span></span>
<span id="cb20-62">    vectorAddPrivatized<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>blocksPerGrid<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;(</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-63"></span>
<span id="cb20-64">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Copy result back to host</span></span>
<span id="cb20-65">    cudaMemcpy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> d_result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">sizeof</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">),</span> cudaMemcpyDeviceToHost<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-66"></span>
<span id="cb20-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Cleanup</span></span>
<span id="cb20-68">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-69">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-70">    cudaFree<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>d_result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-71">    free<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-72">    free<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-73">    free<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span>result<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span></span>
<span id="cb20-74"></span>
<span id="cb20-75">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb20-76"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<ul>
<li><strong>Vector Addition without Privatization:</strong> Directly accesses global memory for each operation.</li>
<li><strong>Vector Addition with Privatization:</strong> Loads data into private variables before performing operations.</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called benchmark</span></span>
<span id="cb21-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> benchmark privatization.cu</span>
<span id="cb21-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the benchmark</span></span>
<span id="cb21-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> benchmark</span></code></pre></div></li>
<li><p><strong>Lecture Results (T4):</strong> No significant performance improvement in this specific example.</p></li>
<li><p><strong>Personal Results (RTX 4090):</strong></p>
<ul>
<li><p><strong>Not Privatized:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.44</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.22</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>24,774</td>
</tr>
<tr class="even">
<td>Memory Throughput</td>
<td>%</td>
<td>77.39</td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>77.39</td>
</tr>
<tr class="even">
<td>Duration</td>
<td>us</td>
<td>11.14</td>
</tr>
<tr class="odd">
<td>L1/TEX Cache Throughput</td>
<td>%</td>
<td>11.14</td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>33.19</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>20,122.48</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>8.64</td>
</tr>
</tbody>
</table></li>
<li><p><strong>Privatized:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.44</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.23</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>28,775</td>
</tr>
<tr class="even">
<td>Memory Throughput</td>
<td>%</td>
<td>80.72</td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>80.72</td>
</tr>
<tr class="even">
<td>Duration</td>
<td>us</td>
<td>12.93</td>
</tr>
<tr class="odd">
<td>L1/TEX Cache Throughput</td>
<td>%</td>
<td>11.33</td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>28.59</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>20,259.88</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>8.77</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p><strong>Example 2:</strong> Sliding window algorithm using shared memory.</p>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#include &lt;stdio.h&gt;</span></span>
<span id="cb22-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#include &lt;cuda_runtime.h&gt;</span></span>
<span id="cb22-3"></span>
<span id="cb22-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Kernel without privatization: Direct <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">global</span> memory access</span>
<span id="cb22-5">__global__ void windowSumDirect(const <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>output, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> n, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> windowSize) {</span>
<span id="cb22-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx.x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> halfWindow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> windowSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n) {</span>
<span id="cb22-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>halfWindow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> halfWindow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i) {</span>
<span id="cb22-11">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> accessIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-12">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (accessIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> accessIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n) {</span>
<span id="cb22-13">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>[accessIdx]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-14">            }</span>
<span id="cb22-15">        }</span>
<span id="cb22-16">        output[idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-17">    }</span>
<span id="cb22-18">}</span>
<span id="cb22-19"></span>
<span id="cb22-20"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Kernel <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> privatization: Preload window elements into registers</span>
<span id="cb22-21">__global__ void windowSumPrivatized(const <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>output, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> n, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> windowSize) {</span>
<span id="cb22-22">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx.x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> halfWindow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> windowSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-24">    __shared__ <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> sharedData[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Assuming blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span></span>
<span id="cb22-25"></span>
<span id="cb22-26">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Load <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span> into shared memory (<span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> demonstration, assuming window fits into shared memory)</span>
<span id="cb22-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n) {</span>
<span id="cb22-28">        sharedData[threadIdx.x] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>[idx]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-29">        __syncthreads()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Ensure <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> loads are complete</span>
<span id="cb22-30"></span>
<span id="cb22-31">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>halfWindow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> halfWindow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>i) {</span>
<span id="cb22-33">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> accessIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threadIdx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-34">            <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Check bounds within shared memory</span>
<span id="cb22-35">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (accessIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> accessIdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> (idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> (idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb22-36">                <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> sharedData[accessIdx]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-37">            }</span>
<span id="cb22-38">        }</span>
<span id="cb22-39">        output[idx] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-40">    }</span>
<span id="cb22-41">}</span>
<span id="cb22-42"></span>
<span id="cb22-43">void initializeArray(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>arr, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> n) {</span>
<span id="cb22-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">++</span>) {</span>
<span id="cb22-45">        arr[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">f</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Simple initialization <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> demonstration</span>
<span id="cb22-46">    }</span>
<span id="cb22-47">}</span>
<span id="cb22-48"></span>
<span id="cb22-49"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> main() {</span>
<span id="cb22-50">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Example array size</span>
<span id="cb22-51">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> windowSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Example window size</span>
<span id="cb22-52">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-53">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d_input, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d_output<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-54"></span>
<span id="cb22-55">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>)malloc(n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sizeof(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-56">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>)malloc(n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sizeof(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-57"></span>
<span id="cb22-58">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Initialize <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span> array</span>
<span id="cb22-59">    initializeArray(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>, n)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-60"></span>
<span id="cb22-61">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Allocate device memory</span>
<span id="cb22-62">    cudaMalloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>d_input, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sizeof(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-63">    cudaMalloc(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span>d_output, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sizeof(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-64"></span>
<span id="cb22-65">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Copy data to device</span>
<span id="cb22-66">    cudaMemcpy(d_input, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sizeof(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>), cudaMemcpyHostToDevice)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-67"></span>
<span id="cb22-68">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Setup execution parameters</span>
<span id="cb22-69">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-70">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> blocksPerGrid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadsPerBlock <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-71"></span>
<span id="cb22-72">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Execute kernels</span>
<span id="cb22-73">    windowSumDirect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>blocksPerGrid, threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span>(d_input, d_output, n, windowSize)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-74">    cudaMemcpy(output, d_output, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sizeof(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>), cudaMemcpyDeviceToHost)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Copy result back <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> verification</span>
<span id="cb22-75"></span>
<span id="cb22-76">    windowSumPrivatized<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;&lt;&lt;</span>blocksPerGrid, threadsPerBlock<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;&gt;&gt;</span>(d_input, d_output, n, windowSize)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-77">    cudaMemcpy(output, d_output, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sizeof(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>), cudaMemcpyDeviceToHost)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Copy result back <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> verification</span>
<span id="cb22-78"></span>
<span id="cb22-79">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> Cleanup</span>
<span id="cb22-80">    cudaFree(d_input)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-81">    cudaFree(d_output)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-82">    free(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-83">    free(output)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-84"></span>
<span id="cb22-85">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb22-86">}</span></code></pre></div>
<ul>
<li><strong>Sliding Window Algorithm with Privatization:</strong> Utilizes shared memory to store data within the sliding window, reducing global memory traffic.</li>
</ul></li>
<li><p><strong>Benchmark:</strong></p>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a binary called benchmark</span></span>
<span id="cb23-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">nvcc</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-o</span> benchmark privatization2.cu</span>
<span id="cb23-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the benchmark</span></span>
<span id="cb23-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ncu</span> benchmark</span></code></pre></div></li>
<li><p><strong>Personal Results (RTX 4090):</strong></p>
<ul>
<li><p><strong>Not Privatized:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.46</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.22</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>16,441</td>
</tr>
<tr class="even">
<td>Memory Throughput</td>
<td>%</td>
<td>64.73</td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>64.73</td>
</tr>
<tr class="even">
<td>Duration</td>
<td>us</td>
<td>7.39</td>
</tr>
<tr class="odd">
<td>L1/TEX Cache Throughput</td>
<td>%</td>
<td>31.43</td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>32.96</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>11,401.60</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>29.51</td>
</tr>
</tbody>
</table></li>
<li><p><strong>Privatized:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric Name</th>
<th>Metric Unit</th>
<th>Metric Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DRAM Frequency</td>
<td>Ghz</td>
<td>10.39</td>
</tr>
<tr class="even">
<td>SM Frequency</td>
<td>Ghz</td>
<td>2.22</td>
</tr>
<tr class="odd">
<td>Elapsed Cycles</td>
<td>cycle</td>
<td>17,959</td>
</tr>
<tr class="even">
<td>Memory Throughput</td>
<td>%</td>
<td>67.53</td>
</tr>
<tr class="odd">
<td>DRAM Throughput</td>
<td>%</td>
<td>67.53</td>
</tr>
<tr class="even">
<td>Duration</td>
<td>us</td>
<td>8.10</td>
</tr>
<tr class="odd">
<td>L1/TEX Cache Throughput</td>
<td>%</td>
<td>37.99</td>
</tr>
<tr class="even">
<td>L2 Cache Throughput</td>
<td>%</td>
<td>28.07</td>
</tr>
<tr class="odd">
<td>SM Active Cycles</td>
<td>cycle</td>
<td>12,130.35</td>
</tr>
<tr class="even">
<td>Compute (SM) Throughput</td>
<td>%</td>
<td>41.96</td>
</tr>
</tbody>
</table></li>
</ul></li>
<li><p><strong>Key takeaway:</strong> Privatization can be effective, but its impact depends on the specific algorithm and memory access patterns.</p></li>
</ul>
</section>
<section id="case-study-6-rewriting-algorithms-with-better-math-flash-attention" class="level2">
<h2 class="anchored" data-anchor-id="case-study-6-rewriting-algorithms-with-better-math-flash-attention">Case Study 6: Rewriting Algorithms with Better Math (Flash Attention)</h2>
<ul>
<li><p><strong>Flash Attention:</strong> An example of algorithm optimization for attention mechanisms.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-008/images/flash-attention-figure.png" class="img-fluid figure-img"></p>
<figcaption><a href="https://arxiv.org/abs/2205.14135">FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness</a></figcaption>
</figure>
</div>
<p><strong>Problem:</strong> Traditional softmax calculation in attention requires multiple passes over the data, making it memory-bound.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-008/images/flash-attention-2-figure.png" class="img-fluid figure-img"></p>
<figcaption><a href="https://arxiv.org/abs/2307.08691">FlashAttention-2: Faster Attention with Better Parallelism and Work Partitioning</a></figcaption>
</figure>
</div>
<ul>
<li><div class="callout callout-style-default callout-note callout-titled" title="FlashAttention-2: Figure 1">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
FlashAttention-2: Figure 1
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Figure 1:</strong> Diagram of how FlashAttention forward pass is performed, when the key K is partitioned into two blocks and the value V is also partitioned into two blocks. By computing attention with respect to each block and rescaling the output, we get the right answer at the end, while avoiding expensive memory reads/writes of the intermediate matrices S and P. We simplify the diagram, omitting the step in softmax that subtracts each element by the row-wise max.</p>
</div>
</div></li>
</ul></li>
<li><p><strong>Original softmax</strong></p>
<ul>
<li><p>3 memory accesses per element</p>
<ul>
<li>2 reads</li>
<li>1 store</li>
</ul></li>
<li><p><strong>Function:</strong> <img src="https://latex.codecogs.com/png.latex?%0A%20%20y_i%20=%20%5Cfrac%7Be%5E%7Bx_i%7D%7D%7B%5Csum%5Climits_%7Bj=1%7D%5E%7BV%7D%20e%5E%7Bx_j%7D%7D%0A%20%20"></p></li>
<li><p><strong>Algorithm:</strong></p>
<pre class="text"><code>1: d₀ ← 0
2: for j ← 1, V do
3:     d₁ ← dⱼ₋₁ + eˣⱼ
4: end for
5: for i ← 1, V do
6:     yᵢ ← eˣⁱ / d_V
7: end for</code></pre></li>
</ul></li>
<li><p><strong>Safe softmax:</strong></p>
<ul>
<li><p>4 memory accesses per element</p>
<ul>
<li>3 reads</li>
<li>1 store</li>
</ul></li>
<li><p><strong>Function:</strong> <img src="https://latex.codecogs.com/png.latex?%0A%20%20y_i%20=%20%5Cfrac%7Be%5E%7Bx_i%20-%20%5Cmax%5Climits_%7Bk=1%7D%5E%7BV%7D%20x_k%7D%7D%7B%5Csum%5Climits_%7Bj=1%7D%5E%7BV%7D%20e%5E%7Bx_j%20-%20%5Cmax%5Climits_%7Bk=1%7D%5E%7BV%7D%20x_k%7D%7D%0A%20%20"></p></li>
<li><p><strong>Algorithm:</strong></p>
<pre class="text"><code> 1: m₀ ← -∞
 2: for k ← 1, V do
 3:     mₖ ← max(mₖ₋₁, xₖ)
 4: end for
 5: d₀ ← 0
 6: for j ← 1, V do
 7:     dⱼ ← dⱼ₋₁ + eˣʲ⁻ᵐ_V
 8: end for
 9: for i ← 1, V do
10:     yᵢ ← eˣⁱ⁻ᵐ_V / d_V
11: end for</code></pre></li>
</ul></li>
<li><p><strong>Solution:</strong> <strong>Online softmax</strong> algorithm:</p>
<ul>
<li><p><strong>Paper:</strong> <a href="https://arxiv.org/abs/1805.02867">Online normalizer calculation for softmax</a></p></li>
<li><p>3 memory accesses per element</p>
<ul>
<li>3 reads</li>
<li>1 store</li>
</ul></li>
<li><p><strong>Algorithm:</strong></p>
<pre class="text"><code>1: m₀ ← -∞  
2: d₀ ← 0  
3: for j ← 1, V do  
4:     mⱼ ← max(mⱼ₋₁, xⱼ)  
5:     dⱼ ← dⱼ₋₁ × eᵐʲ⁻₁⁻ᵐʲ + eˣʲ⁻ᵐⱼ  
6: end for  
7: for i ← 1, V do  
8:     yᵢ ← eˣⁱ⁻ᵐ_V / d_V  
9: end for  </code></pre></li>
<li><p>Maintains a running estimate of the normalization factor.</p></li>
<li><p>Corrects the normalization factor locally as new elements are processed. (line 5)</p></li>
<li><p>Reduces the number of memory accesses, improving performance.</p></li>
</ul></li>
<li><p><strong>Key takeaway:</strong> Algorithmic and mathematical optimizations can significantly improve performance, especially for compute-bound kernels.</p></li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<ul>
<li><p>This lecture presented several key optimizations for improving CUDA kernel performance.</p></li>
<li><p><strong>Table 6.1 in the PMPP book</strong> provides a summary of these optimizations and their impact on compute and memory performance.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 27%">
<col style="width: 27%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th>Optimization</th>
<th>Benefit to compute cores</th>
<th>Benefit to memory</th>
<th>Strategies</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Maximizing occupancy</td>
<td>More work to hide pipeline latency</td>
<td>More parallel memory accesses to hide DRAM latency</td>
<td>Tuning usage of SM resources such as threads per block, shared memory per block, and registers per thread</td>
</tr>
<tr class="even">
<td>Enabling coalesced global memory accesses</td>
<td>Fewer pipeline stalls waiting for global memory accesses</td>
<td>Less global memory traffic and better utilization of bursts/cache lines</td>
<td>Transfer between global memory and shared memory in a coalesced manner and performing uncoalesced accesses in shared memory (e.g., corner turning) Rearranging the mapping of threads to data Rearranging the layout of the data</td>
</tr>
<tr class="odd">
<td>Minimizing control divergence</td>
<td>High SIMD efficiency (fewer idle cores during SIMD execution)</td>
<td>–</td>
<td>Rearranging the mapping of threads to work and/or data Rearranging the layout of the data</td>
</tr>
<tr class="even">
<td>Tiling of reused data</td>
<td>Fewer pipeline stalls waiting for global memory accesses</td>
<td>Less global memory traffic</td>
<td>Placing data that is reused within a block in shared memory or registers so that it is transferred between global memory and the SM only once</td>
</tr>
<tr class="odd">
<td>Privatization (covered later)</td>
<td>Fewer pipeline stalls waiting for atomic updates</td>
<td>Less contention and serialization of atomic updates</td>
<td>Applying partial updates to a private copy of the data and then updating the universal copy when done</td>
</tr>
<tr class="even">
<td>Thread coarsening</td>
<td>Less redundant work, divergence, or synchronization</td>
<td>Less redundant global memory traffic</td>
<td>Assigning multiple units of parallelism to each thread to reduce the price of parallelism when it is incurred unnecessarily</td>
</tr>
</tbody>
</table></li>
<li><p><strong>NCU (NVIDIA CUDA Profiler)</strong> is a valuable tool for profiling and understanding kernel performance.</p></li>
<li><p>Understanding whether a workload is memory or compute bound is crucial for choosing the right optimization strategies.</p></li>
<li><p><strong>CUDA Mode:</strong> Represents the mastery of both math and computer science to co-design software with hardware in mind.</p></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/lecture-008/</guid>
  <pubDate>Wed, 11 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>CUDA MODE Lecture 7: Advanced Quantization</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/lecture-007/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<ul>
<li>Introduction</li>
<li>Overview of Quantization</li>
<li>Dynamic Quantization Kernels</li>
<li>Weight-only Quantization Kernels</li>
<li>INT4 Weight-only Quantization Kernels</li>
<li>Strengths and Limitations of Triton</li>
<li>Q&amp;A Session</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Resource Links:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Resource Links:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube Recording:</strong> <a href="https://www.youtube.com/watch?v=1u9xUK3G4VM">Lecture 7 Advanced Quantization</a></li>
<li><strong>Slides:</strong> <a href="https://www.dropbox.com/scl/fi/hzfx1l267m8gwyhcjvfk4/Quantization-Cuda-vs-Triton.pdf?rlkey=s4j64ivi2kpp2l0uq8xjdwbab&amp;e=1&amp;dl=0">Quantization Cuda vs Triton</a></li>
</ul>
</div>
</div>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<ul>
<li><strong>Speaker:</strong> Charles Hernandez, PyTorch Core Team (AO Team - Quantization &amp; Pruning)</li>
<li><strong>Focus:</strong> GPU Quantization - Intersection of CUDA and Triton based on Charles’ experience over the past year.</li>
<li><strong>Background:</strong>
<ul>
<li><a href="https://github.com/pytorch/ao">PyTorch AO</a> team focuses on making models work “worse but faster” by trading off accuracy for performance.</li>
<li>Historically, quantization was primarily for CPUs.</li>
<li>Recent push for GPU model productionization led to a shift towards GPU quantization.</li>
<li>Charles spearheaded quantization for projects like Segment Anything Fast, GPT Fast, SDXL Fast.</li>
<li>Tools used are available in Torch AO.</li>
<li><strong>GPU Quantization:</strong> Focus of Charles’ work over the past year.
<ul>
<li>Tools available in Torch AO repository.</li>
<li>Types of quantization: Dynamic, Weight-only INT8, INT4 Weight-only.</li>
<li>Key challenge: Lack of GPU quantized kernels prior to this work.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="overview-of-quantization" class="level3">
<h3 class="anchored" data-anchor-id="overview-of-quantization">Overview of Quantization</h3>
<ul>
<li><strong>Goal:</strong> Achieve faster inference by reducing the precision of weights and/or activations.</li>
<li><strong>Types:</strong>
<ul>
<li><p><strong>Dynamic Quantization:</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-007/images/dynamic-quantization-flow.png" class="img-fluid figure-img"></p>
<figcaption>Slide 3: Dynamic Quantization Flow</figcaption>
</figure>
</div>
<ul>
<li><strong>Weights:</strong> Quantized to integers.</li>
<li><strong>Activations:</strong> Quantized to integers.</li>
<li><strong>Multiplication:</strong> Integer multiplication (faster than float multiplication).</li>
<li><strong>Accumulation:</strong> Results accumulated, rescaled, and output as float.</li>
<li><strong>Benefits:</strong> Effective for compute-bound models (e.g., Segment Anything).</li>
<li><strong>Example:</strong> Multiplying two INT8 tensors is ~4x faster than multiplying two BF16 tensors.</li>
</ul></li>
<li><p><strong>Weight-only Quantization:</strong></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-007/images/weight-only-quantization-flow.png" class="img-fluid figure-img"></p>
<figcaption>Slide 3: Weight Only Quantization</figcaption>
</figure>
</div>
<ul>
<li><strong>Weights:</strong> Quantized to integers.</li>
<li><strong>Activations:</strong> Remain in original precision (float).</li>
<li><strong>Multiplication:</strong> Either directly multiply integer weights with float activations (mixed-dtype) or dequantize weights before multiplication.</li>
<li><strong>Benefits:</strong>
<ul>
<li>Very fast weight loading.</li>
<li>Effective for memory-bound models (e.g., LLaMA).</li>
<li>More accurate than dynamic quantization (activations not quantized).</li>
</ul></li>
<li><strong>Why not quantize activations in weight-only quantization?</strong>
<ul>
<li>Memory-bound scenarios prioritize fast weight loading.</li>
<li>Quantizing activations adds overhead (compute and memory) that outweighs benefits in memory-bound cases.</li>
<li>Dynamic quantization tends to slow down memory-bound models like LLaMA compared to weight-only quantization.</li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Terminology</strong>: Int4 quantization is ambiguous and should specify weight and activation dtypes (e.g., W4A16, W4BF16 with accumulation in FP32).</li>
<li><strong>Quantization Considerations:</strong>
<ul>
<li><strong>Model Quantizability:</strong> Not all models are equally quantizable.
<ul>
<li><strong>Categorization models:</strong> Generally easier to quantize.</li>
<li><strong>Regression models:</strong> More challenging to quantize.</li>
<li><strong>GPTQ (Generative Pretrained Transformer Quantization)</strong>: Implemented for Int4 in GPT Fast, allows for model-agnostic quantization.</li>
</ul></li>
<li><strong>Quantization-Aware Training (QAT):</strong> Technique to improve quantizability by training the model with simulated quantization.
<ul>
<li>Gradients are backpropagated through the simulated quantization operator.</li>
</ul></li>
<li><strong>Granularity of Quantization:</strong>
<ul>
<li><strong>Per-tensor:</strong> Single scale for the entire tensor.</li>
<li><strong>Per-channel:</strong> Different scales for each output channel.</li>
<li><strong>Per-token, per-vector, per-block:</strong> Other possible granularities.</li>
<li>Finer granularities provide better accuracy but require more memory (more scales).</li>
</ul></li>
<li><strong>Choice of Precision:</strong> 8-bit, 4-bit, even 1-bit quantization are possible.
<ul>
<li><strong>Bit Width</strong>: Lower bit widths (e.g., 1-bit) are possible but often lead to significant accuracy degradation, suitable for simpler tasks.</li>
</ul></li>
<li><strong>Outliers and Distribution:</strong> Quantization performance is affected by the distribution of weights and activations. Outliers can negatively impact accuracy.</li>
</ul></li>
</ul>
</section>
<section id="dynamic-quantization-kernels" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-quantization-kernels">Dynamic Quantization Kernels</h3>
<ul>
<li><strong>Initial Approach:</strong> Leverage <code>torch.compile()</code> to generate Triton kernels from Python code.</li>
<li><strong>Mathematical Formulation</strong>:
<ul>
<li>Basic linear operation: <code>Y = X.W</code></li>
<li>Quantized operation (factor out scales): <code>Y = Sx * Sw * (Xint.Wint)</code> where <code>Xint</code> and <code>Wint</code> are quantized versions of <code>x</code> and <code>w</code>.</li>
<li><strong>Triton Tutorial:</strong> <a href="https://triton-lang.org/main/getting-started/tutorials/03-matrix-multiplication.html">Matrix Multiplication</a></li>
</ul></li>
<li><strong>Per Token &amp; Per Channel Quantization</strong>: GPU allows efficient per token and per channel quantization due to parallel processing.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-007/images/dynamic-quantization-slide-7.png" class="img-fluid figure-img"></p>
<figcaption>Slide 7</figcaption>
</figure>
</div>
<ul>
<li><strong>Challenges:</strong>
<ul>
<li><strong>Memory Increase:</strong> Materializing intermediate results in INT32 during INT8 multiplication leads to higher memory usage than BF16.</li>
</ul></li>
<li><strong>Solution:</strong>
<ul>
<li>Fuse the rescaling operation (<code>sw</code>) into the Triton kernel to avoid materializing the INT32 intermediate result.</li>
<li><strong>Implementation:</strong>
<ul>
<li>Modify the Triton kernel to include the rescaling multiplication.</li>
<li>Use <code>config.force_fuse_int_mm_with_mul = True</code> in Torch Compile to force fusion.</li>
<li><strong><code>torch/_inductor/kernel/mm.py</code></strong> <a href="https://github.com/pytorch/pytorch/blob/26e5572dd24acd69b08eb94577f8796a480c9fe0/torch/_inductor/kernel/mm.py#L757"><code>tuned_fused_int_mm_mul</code></a></li>
</ul></li>
</ul></li>
<li><strong>Results:</strong>
<ul>
<li><strong>Performance:</strong> ~14% improvement over baseline.</li>
<li><strong>Memory:</strong> Slightly improved peak memory.</li>
</ul></li>
<li><strong>Key Takeaway:</strong> Triton’s flexibility in fusing operations enables significant performance gains without extensive kernel development.</li>
</ul>
</section>
<section id="weight-only-quantization-kernels" class="level3">
<h3 class="anchored" data-anchor-id="weight-only-quantization-kernels">Weight-only Quantization Kernels</h3>
<ul>
<li><strong>Initial Approach (Naive):</strong>
<ul>
<li>Use the same matrix multiplication kernel as in dynamic quantization but change the activation’s dtype to BF16.</li>
<li>Load INT8 weights, convert to BF16, multiply with BF16 activations, accumulate in FP32, and rescale.</li>
</ul></li>
<li><strong>Results:</strong> Extremely slow, even slower than non-quantized matmul.</li>
<li><strong>Analysis:</strong>
<ul>
<li>Increased workload (loading integers, conversions, rescaling).</li>
<li>Potential limitations with block size in Triton’s tensor core kernels.</li>
</ul></li>
<li><strong>Solution (Torch Compile Magic):</strong>
<ul>
<li>Reformulate the matmul operation using element-wise multiplication and summation.</li>
<li><code>torch.sum(x.unsqueeze(-1) * w, dim=-2)</code></li>
</ul></li>
<li><strong>Results:</strong>
<ul>
<li><strong>Performance:</strong> Blazing fast, significantly faster than both weight-only and non-quantized matmul.</li>
</ul></li>
<li><strong>Analysis:</strong>
<ul>
<li>Torch Compile generates a highly efficient Triton kernel that avoids tensor cores.</li>
<li>Each column of the weight matrix <code>w</code> is processed by a separate thread, enabling high parallelism.</li>
<li>Accumulates in FP32 (potential for further optimization).</li>
</ul></li>
<li><strong>Limitations:</strong>
<ul>
<li>Only works for batch size 1 (memory-bound scenarios).</li>
<li>Batch size &gt; 1 requires indexing over both activation and weight matrices, making it compute-bound and challenging.</li>
</ul></li>
<li><strong>Key Takeaway:</strong> Torch Compile can sometimes produce unexpectedly efficient kernels for specific formulations, highlighting its potential for optimization.</li>
</ul>
</section>
<section id="int4-weight-only-quantization-kernels" class="level3">
<h3 class="anchored" data-anchor-id="int4-weight-only-quantization-kernels">INT4 Weight-only Quantization Kernels</h3>
<ul>
<li><strong>Challenges:</strong>
<ul>
<li>No native INT4 dtype in PyTorch or Triton Lang.</li>
<li>Manual packing and unpacking of INT4 values into INT8 is required, introducing overhead.</li>
<li>Ideal scenario: Directly multiply INT4 values with BF16 activations without explicit conversions.</li>
</ul></li>
<li><strong>Triton-based Approach:</strong>
<ul>
<li><strong>Packing:</strong> Pack two INT4 values into one INT8 using various packing schemes.</li>
<li><strong>Kernel Implementation:</strong> Implement a custom Triton kernel to handle packed INT4 multiplication.</li>
</ul></li>
<li><strong>Results:</strong> Very slow, comparable to the naive weight-only approach.</li>
<li><strong>CUDA Kernel (FastINT8):</strong>
<ul>
<li>Jeff Johnson (PyTorch GPU backend developer) developed a highly optimized CUDA kernel for INT4 weight-only quantization.</li>
</ul></li>
<li><strong>Results:</strong>
<ul>
<li><strong>Performance:</strong> Extremely fast, surpassing all previous approaches.</li>
<li>Achieves state-of-the-art performance for INT4 quantization.</li>
</ul></li>
<li><strong>Key Takeaway:</strong> For complex operations and custom dtypes, highly optimized CUDA kernels can significantly outperform Triton-based solutions. Triton’s limitations become apparent in these scenarios.</li>
</ul>
</section>
<section id="strengths-and-limitations-of-triton" class="level3">
<h3 class="anchored" data-anchor-id="strengths-and-limitations-of-triton">Strengths and Limitations of Triton</h3>
<ul>
<li><strong>Strengths:</strong>
<ul>
<li><strong>Accessibility:</strong> Enables rapid development of efficient GPU kernels without deep CUDA expertise.</li>
<li><strong>Fusion:</strong> Excellent at fusing multiple operations into single kernels, reducing overhead.</li>
<li><strong>INT8 Support:</strong> Handles INT8 quantization very well.</li>
<li><strong>Torch Compile Integration:</strong> Works seamlessly with Torch Compile for automatic kernel generation.</li>
<li><strong>Flexibility:</strong> Easy to add custom operations or modify existing kernels.</li>
</ul></li>
<li><strong>Limitations:</strong>
<ul>
<li><strong>Custom Dtypes:</strong> Limited support for custom dtypes like INT4.</li>
<li><strong>Complex Operations:</strong> Can struggle with complex operations that require fine-grained control over data layout and computation.</li>
<li><strong>Batch Size &gt; 1 for Weight-only INT4:</strong> No efficient solution yet.</li>
<li><strong>L2 Cache Issues:</strong> Potential problems with L2 cache utilization for batch size &gt; 1 in weight-only quantization.</li>
<li><strong>Config Consistency:</strong> Heuristics for selecting optimal kernel configurations can be inconsistent.</li>
</ul></li>
</ul>
</section>
<section id="qa-session" class="level3">
<h3 class="anchored" data-anchor-id="qa-session">Q&amp;A Session</h3>
<section id="motivation-and-comparison-with-other-libraries" class="level4">
<h4 class="anchored" data-anchor-id="motivation-and-comparison-with-other-libraries">Motivation and Comparison with Other Libraries</h4>
<section id="reasons-for-developing-native-pytorch-quantization" class="level5">
<h5 class="anchored" data-anchor-id="reasons-for-developing-native-pytorch-quantization">Reasons for Developing Native PyTorch Quantization</h5>
<ul>
<li><strong>Goal:</strong> Address the <strong>fracturization of technologies</strong> in the open-source community and make advanced techniques like quantization more accessible, especially for those without the time to keep up with rapidly evolving optimizations.</li>
<li><strong>Advantages:</strong>
<ul>
<li><strong>Native PyTorch integration:</strong> Similar to how operations like LayerNorm and BatchNorm became accessible within PyTorch, quantization aims to provide a user-friendly experience.</li>
<li><strong>Access to the Torch Compile team:</strong> Allows for faster development and the addition of hard-coded optimizations that might not be easily implemented elsewhere.</li>
<li><strong>Collaboration with experts like Jeff Johnson:</strong> Leverages expertise in int4 kernels, resulting in potentially the <strong>fastest int4 performance</strong> currently available.</li>
</ul></li>
</ul>
</section>
<section id="comparison-with-bitsandbytes" class="level5">
<h5 class="anchored" data-anchor-id="comparison-with-bitsandbytes">Comparison with BitsandBytes</h5>
<ul>
<li><strong>Question:</strong> Have you tested <strong>Tim Dettmers’ BitsandBytes library</strong> for quantization?</li>
<li><strong>Answer:</strong>
<ul>
<li>BitsandBytes focuses more on <strong>quantization-aware training (QAT)</strong>.</li>
<li>BitsandBytes kernels are <strong>not the fastest</strong>, employing a hybrid approach with FP16 for challenging layers.</li>
<li>The project aims for maximum speed, suggesting QAT or GPTQ as solutions for quantization challenges.</li>
<li>BitsandBytes appears to use <strong>table-based lookups for 4-bit quantization</strong>, which is likely not currently possible with Triton without an FP4 data type or tweaks to the Triton language.</li>
</ul></li>
</ul>
</section>
<section id="comparison-with-other-quantization-libraries" class="level5">
<h5 class="anchored" data-anchor-id="comparison-with-other-quantization-libraries">Comparison with Other Quantization Libraries</h5>
<ul>
<li><strong><a href="https://huggingface.co/blog/quanto-introduction">Quanto</a>:</strong> Hugging Face seems to be moving towards Quanto, developed by one of their employees.</li>
<li><strong>Overall:</strong> There are many strong quantization technologies (BitsandBytes, Quanto, the project discussed) and limited engineering resources.</li>
<li><strong>Prediction:</strong> One technology will likely dominate the field within a couple of years.</li>
</ul>
</section>
</section>
<section id="hardware-support-and-integration" class="level4">
<h4 class="anchored" data-anchor-id="hardware-support-and-integration">Hardware Support and Integration</h4>
<section id="nvidia-kernels-and-data-types" class="level5">
<h5 class="anchored" data-anchor-id="nvidia-kernels-and-data-types">Nvidia Kernels and Data Types</h5>
<ul>
<li><strong>Question:</strong> Have you looked at <strong>Nvidia’s custom FP8 kernels</strong>, particularly their performance in high-throughput scenarios with larger batch sizes?</li>
<li><strong>Answer:</strong>
<ul>
<li>Nvidia appears to have <strong>removed int4 kernels from the H100</strong> and moved to <strong>FP4</strong>.</li>
<li>Nvidia has a <strong>mixed-precision data type (MX)</strong>, but direct comparisons haven’t been conducted yet.</li>
<li>The current focus is on <strong>automating layer-specific quantization choices</strong>, rather than peak performance.</li>
<li>They are tracking various quantization technologies like QUIP and AMP, which focus on rounding rather than kernels, and prioritizing support based on need.</li>
</ul></li>
</ul>
</section>
<section id="amd-support" class="level5">
<h5 class="anchored" data-anchor-id="amd-support">AMD Support</h5>
<ul>
<li><strong>Question:</strong> What is the <strong>appetite for AMD hardware support</strong> through Triton?</li>
<li><strong>Answer:</strong>
<ul>
<li>While the speaker is not on the Triton team, they acknowledge the potential of AMD support.</li>
<li><strong>Strong community appetite:</strong> The GPT-fast blog post included AMD numbers, highlighting the potential for cross-platform support with minimal code changes.</li>
<li><strong>Active development:</strong> The PyTorch repo shows many eager kernels being HIP-ified (adapted for AMD).</li>
<li><strong>Bug reports are crucial</strong> for improving AMD support and encouraging development.</li>
</ul></li>
</ul>
</section>
<section id="mac-support" class="level5">
<h5 class="anchored" data-anchor-id="mac-support">Mac Support</h5>
<ul>
<li><strong>Question:</strong> Triton team mentioned plans for <strong>integration with newer Mac versions</strong> a year ago. Any updates?</li>
<li><strong>Answer:</strong> It’s difficult to comment on hardware vendor plans, as they are typically kept secret until release.</li>
</ul>
</section>
</section>
<section id="triton-usage-and-development" class="level4">
<h4 class="anchored" data-anchor-id="triton-usage-and-development">Triton Usage and Development</h4>
<section id="triton-installation" class="level5">
<h5 class="anchored" data-anchor-id="triton-installation">Triton Installation</h5>
<ul>
<li><strong>Question:</strong> Do you install Triton directly from GitHub or use the version included with the latest PyTorch build?</li>
<li><strong>Answer:</strong>
<ul>
<li>Triton’s rapid development can lead to inconsistencies between versions, affecting reproducibility.</li>
<li>Experiences of significant performance differences between Triton versions, with results sometimes degrading after upgrades or downgrades.</li>
<li>Currently, using the <strong>PyTorch-bundled version</strong> is recommended for <strong>reproducibility</strong>, although testing with the latest Triton can reveal potential speedups.</li>
</ul></li>
</ul>
</section>
<section id="tritons-openness-and-future" class="level5">
<h5 class="anchored" data-anchor-id="tritons-openness-and-future">Triton’s Openness and Future</h5>
<ul>
<li><strong>Question:</strong> Is Triton an OpenAI product or a collaborative effort? Are there agreements to ensure its availability for the broader community, even if OpenAI changes its licensing or access in the future?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Strong industry support:</strong> The recent Triton conference showcased talks primarily from hardware vendors, indicating its wide adoption.</li>
<li><strong>Close ties with PyTorch:</strong> Strong relationship between the Torch Compile and Triton teams, with Triton developers contributing to the PyTorch 2 paper.</li>
<li><strong>Triton’s future within PyTorch seems secure</strong>, becoming a core dependency for kernel generation.</li>
</ul></li>
</ul>
</section>
</section>
<section id="technical-deep-dive-into-quantization" class="level4">
<h4 class="anchored" data-anchor-id="technical-deep-dive-into-quantization">Technical Deep Dive into Quantization</h4>
<section id="accumulation-data-type-selection" class="level5">
<h5 class="anchored" data-anchor-id="accumulation-data-type-selection">Accumulation Data Type Selection</h5>
<ul>
<li><strong>Question:</strong> When performing matrix multiplication with int8 inputs, how is the <strong>accumulation data type</strong> (e.g., BF16, FP32, FP64) chosen?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Hardware limitations:</strong> In many cases, hardware dictates the accumulation type (e.g., int8 multiplication often accumulates to int32).</li>
<li><strong>Overflow concerns:</strong> Smaller accumulation types can lead to overflow issues, as seen with int8 accumulation in sparse kernels.</li>
<li><strong>Practical considerations:</strong> The goal is to use the smallest data type that avoids overflow, often BF16 or FP32.</li>
<li><strong>FP32’s versatility:</strong> It can handle accumulation from various data types, including int8, making it a robust choice.</li>
<li><strong>FP64 is rarely needed</strong> unless dealing with massive tensors prone to overflow during accumulation.</li>
</ul></li>
</ul>
</section>
<section id="one-bit-quantization" class="level5">
<h5 class="anchored" data-anchor-id="one-bit-quantization">One-Bit Quantization</h5>
<ul>
<li><strong>Question:</strong> Have you explored <strong>extreme cases like one-bit quantization</strong>? Is it still useful, or does it lead to significant performance degradation?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>QUIP paper demonstrates promising results:</strong> It employs pre-processing to orthogonalize weights and activations, mitigating quantization error propagation.</li>
<li><strong>Specialized kernels:</strong> QUIP uses kernels for orthogonalization, multiplication, and de-orthogonalization, achieving reasonable results with int2 and potentially int1.</li>
<li><strong>Usefulness depends on the task:</strong> LLMs might be challenging, but simpler tasks like MNIST could be feasible.</li>
<li><strong>Power-of-two quantizations</strong> are also efficient due to bit-shifting operations.</li>
<li><strong>Hardware support and accuracy</strong> are key factors in determining the viability of extreme quantization techniques.</li>
</ul></li>
</ul>
</section>
<section id="weight-distribution-analysis" class="level5">
<h5 class="anchored" data-anchor-id="weight-distribution-analysis">Weight Distribution Analysis</h5>
<ul>
<li><strong>Question:</strong> Do you use tools to <strong>analyze weight distributions</strong> before quantization (e.g., visualizing distributions, checking for outliers)?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Depends on the technique:</strong> Basic int8 quantization typically doesn’t require in-depth analysis.</li>
<li><strong>GPTQ for int4 requires data and pre-processing:</strong> It involves calculating the Hessian of activations and iteratively quantizing weight matrix columns while maintaining the Hessian multiplication.</li>
<li><strong>Int8 weight-only quantization is fast and doesn’t need data analysis</strong>.</li>
<li><strong>QLoRA and LLM.int8 papers provide valuable insights:</strong> QLoRA’s appendix shows that LLM weights are often zero-mean and normally distributed.</li>
<li><strong>QLoRA’s NF4 data type</strong> aims to maintain a normal distribution of weights.</li>
<li><strong>Plotting weight histograms</strong> is helpful to ensure a full range utilization of the lower d-type and avoid sparse buckets.</li>
<li><strong>Scaling and shifting the mean</strong> are common techniques to optimize the use of the lower d-type’s range.</li>
</ul></li>
</ul>
</section>
<section id="quantization-for-speculative-decoding" class="level5">
<h5 class="anchored" data-anchor-id="quantization-for-speculative-decoding">Quantization for Speculative Decoding</h5>
<ul>
<li><strong>Question:</strong> Is quantization the best option for <strong>speculative decoding</strong>, compared to using a separate network? Would the weight distribution be similar?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Experiments in the GPT-fast repo</strong> demonstrate quantization for speculative decoding with a 70B Llama 2 model, quantized using GPTQ on WikiText.</li>
<li><strong>Trade-off between speed and accuracy:</strong> Results show a clear trade-off, with different quantization levels offering varying performance.</li>
<li><strong>Quantization is currently the easiest and most mature option</strong>, but sparsity and other techniques like knowledge distillation are also being explored.</li>
</ul></li>
</ul>
</section>
</section>
<section id="future-directions-and-insights" class="level4">
<h4 class="anchored" data-anchor-id="future-directions-and-insights">Future Directions and Insights</h4>
<section id="scaling-vs.-optimization" class="level5">
<h5 class="anchored" data-anchor-id="scaling-vs.-optimization">Scaling vs.&nbsp;Optimization</h5>
<ul>
<li><strong>Observation:</strong> Current trends focus on scaling up models, but quantization suggests we may not need all weights in their non-zero form.</li>
<li><strong>Hardware limitations:</strong> Current hardware favors dense matrix multiplications, potentially hindering the adoption of sparse techniques.</li>
<li><strong>Sparse techniques are available in Torch.io for GPU</strong>, but further development is needed.</li>
</ul>
</section>
<section id="layer-specific-optimization" class="level5">
<h5 class="anchored" data-anchor-id="layer-specific-optimization">Layer-Specific Optimization</h5>
<ul>
<li><strong>Complexity of optimization:</strong> Finding the optimal combination of techniques for each layer is a laborious process, involving trade-offs between speed and accuracy.</li>
<li><strong>No single solution:</strong> There’s no “one-size-fits-all” approach; optimizing requires careful analysis and experimentation.</li>
</ul>
</section>
<section id="accuracy-metrics" class="level5">
<h5 class="anchored" data-anchor-id="accuracy-metrics">Accuracy Metrics</h5>
<ul>
<li><strong>Question:</strong> Is <strong>accuracy</strong> the best metric for evaluating quantization? Would <strong>perplexity</strong> be more realistic?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Perplexity’s limitations:</strong> While useful, it can be difficult to interpret in terms of real-world impact, lacking a clear connection to human perception of quality.</li>
<li><strong>Accuracy provides more granularity and robustness</strong>, allowing for fine-grained analysis of performance changes.</li>
<li><strong>Human evaluation (vibe checks)</strong> remains the most indicative measure of quality in the short term, especially for detecting significant degradations like a model switching languages.</li>
<li><strong>Evaluation datasets are useful for CI checks</strong> but might not fully capture real-world performance or user preferences.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>
</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/lecture-007/</guid>
  <pubDate>Tue, 10 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Deploying YOLOX for Real-Time Object Tracking on Jetson Orin Nano</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/pytorch-train-object-detector-yolox-tutorial/jetson-object-tracking/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/tutorials/pytorch-train-object-detector-yolox-series.html"><strong>Training YOLOX Models for Real-Time Object Detection in PyTorch</strong></a></li>
</ul>
</div>
</div>
<ul>
<li>Introduction</li>
<li>Prerequisites</li>
<li>Setting Up a Python Environment</li>
<li>Getting Started with the Code</li>
<li>Importing the Required Dependencies</li>
<li>Defining Utility Functions<br>
</li>
<li>Setting Up the Project<br>
</li>
<li>Loading the Checkpoint Data<br>
</li>
<li>Create an Inference Session</li>
<li>Tracking Objects in a Camera Feed<br>
</li>
<li>Conclusion</li>
</ul>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Welcome back to this series on real-time object detection with YOLOX. So far, this series has covered how to:</p>
<ul>
<li>Finetune a YOLOX model in PyTorch to detect hand signs.</li>
<li>Export the finetuned model to ONNX.</li>
<li>Use the ByteTrack object tracker to track objects across video frames.</li>
<li>Quantize the model with ONNX Runtime and TensorRT for int8 inference on NVIDIA hardware.</li>
</ul>
<p>This post builds on those past tutorials by walking through deploying our model on an NVIDIA <a href="https://developer.nvidia.com/embedded/learn/get-started-jetson-orin-nano-devkit">Jetson Orin Nano</a> developer kit to perform real-time object tracking from a camera feed. Additionally, we will use ONNX Runtime’s TensoRT execution provider to leverage the Jetson’s Tensor Cores.</p>
<p>Released in 2023, the Jetson Orin Nano is NVIDIA’s entry-level single-board computer and offers a balance of performance and power efficiency for edge AI applications. Its compact form factor and robust inference capabilities make it a suitable platform for deploying real-time object-tracking systems in various scenarios, from human-computer interaction to industrial automation.</p>
<p>Whether you’re working with the pre-trained hand-sign detection model used in this series or a custom model, real-time object tracking on the Jetson Orin Nano opens up many possibilities for edge applications.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>This tutorial is for Jetson devices loaded with <a href="https://developer.nvidia.com/embedded/jetpack-sdk-60">Jetpack 6</a>. You can follow the official guide from NVIDIA to ensure your Jetson is ready.</p>
<ul>
<li><a href="https://developer.nvidia.com/embedded/learn/get-started-jetson-orin-nano-devkit">Jetson Orin Nano Developer Kit Getting Started Guide</a></li>
</ul>
<p>The code for this tutorial assumes the Jetson device has either a USB or <a href="https://en.wikipedia.org/wiki/Camera_Serial_Interface">CSI</a> Camera attached. While a USB camera will work, a CSI Camera is preferable due to the improved frame rate and latency.</p>
<p>The Jetson Orin Nano devkit has 22-pin MIPI CSI camera connectors. If your CSI camera module uses a 15-pin connector, you will need a 15-pin to 22-pin adapter cable. You can order a pack of 3 on Amazon at the link below:</p>
<ul>
<li><a href="https://www.amazon.com/Arducam-Raspberry-Camera-Ribbon-Extension/dp/B085RW9K13">Arducam for Raspberry Pi Zero Camera Cable Set, 1.5” 2.87” 5.9” Ribbon Flex Extension Cables for Pi Zero&amp;W, Pack of 3</a></li>
</ul>
</section>
<section id="setting-up-a-python-environment" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-a-python-environment">Setting Up a Python Environment</h2>
<p>With our Jetson device prepared, we can set up a Python environment to run the demo code.</p>
<section id="install-mamba-package-manager" class="level3">
<h3 class="anchored" data-anchor-id="install-mamba-package-manager">Install Mamba Package Manager</h3>
<p>As with previous tutorials in this series, we will use the Mamba package manager to create and manage our Python environment.</p>
<p>Run the following bash commands on the Jetson to download the latest release, install it, and relaunch the current bash shell to apply the relevant changes:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download the latest Mambaforge installer for the current OS and architecture</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uname</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uname</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">.sh"</span></span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the Mambaforge installer silently (-b flag for batch mode)</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bash</span> Mambaforge-<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uname</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span>-<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uname</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span>.sh <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-b</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize mamba for shell usage</span></span>
<span id="cb1-8"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">~/mambaforge/bin/mamba</span> init</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Restart the shell to apply changes</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bash</span></span></code></pre></div>
</section>
<section id="create-a-python-environment" class="level3">
<h3 class="anchored" data-anchor-id="create-a-python-environment">Create a Python Environment</h3>
<p>Next, we will create and activate a Python 3.10 environment.</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mamba</span> create <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--name</span> object-tracking-env python=3.10 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span></span>
<span id="cb2-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">mamba</span> activate object-tracking-env</span></code></pre></div>
</section>
<section id="install-opencv-dependencies" class="level3">
<h3 class="anchored" data-anchor-id="install-opencv-dependencies">Install OpenCV Dependencies</h3>
<p>As with the <a href="../byte-track/">earlier object-tracking tutorial</a>, we will use the <a href="https://pypi.org/project/opencv-python/"><code>opencv-python</code></a> package to obtain input for our model. Since we are on a Jetson, we must build the package with support for USB and CSI Camera input enabled.</p>
<p>To do that, we must install some dependencies:</p>
<div class="callout callout-style-default callout-note callout-titled" title="Package Descriptions:">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Package Descriptions:
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 64%">
</colgroup>
<thead>
<tr class="header">
<th>Package</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>libgstreamer1.0-dev</td>
<td>Development files for the GStreamer multimedia framework</td>
</tr>
<tr class="even">
<td>libgstreamer-plugins-base1.0-dev</td>
<td>Development files for GStreamer plugins (base)</td>
</tr>
<tr class="odd">
<td>libgstreamer-plugins-bad1.0-dev</td>
<td>Development files for GStreamer plugins (bad)</td>
</tr>
<tr class="even">
<td>gstreamer1.0-plugins-base</td>
<td>GStreamer plugins from the “base” set</td>
</tr>
<tr class="odd">
<td>gstreamer1.0-plugins-good</td>
<td>GStreamer plugins from the “good” set</td>
</tr>
<tr class="even">
<td>gstreamer1.0-plugins-bad</td>
<td>GStreamer plugins from the “bad” set</td>
</tr>
<tr class="odd">
<td>gstreamer1.0-plugins-ugly</td>
<td>GStreamer plugins from the “ugly” set</td>
</tr>
<tr class="even">
<td>gstreamer1.0-libav</td>
<td>LibAV plugin for GStreamer</td>
</tr>
<tr class="odd">
<td>gstreamer1.0-tools</td>
<td>Tools for GStreamer</td>
</tr>
<tr class="even">
<td>gstreamer1.0-x</td>
<td>GStreamer plugins for X11</td>
</tr>
<tr class="odd">
<td>gstreamer1.0-alsa</td>
<td>GStreamer plugin for ALSA</td>
</tr>
<tr class="even">
<td>gstreamer1.0-gl</td>
<td>GStreamer plugins for GL</td>
</tr>
<tr class="odd">
<td>gstreamer1.0-gtk3</td>
<td>GStreamer plugin for GTK+3</td>
</tr>
<tr class="even">
<td>gstreamer1.0-qt5</td>
<td>GStreamer plugins for Qt5</td>
</tr>
<tr class="odd">
<td>gstreamer1.0-pulseaudio</td>
<td>GStreamer plugin for PulseAudio</td>
</tr>
<tr class="even">
<td>libgtk2.0-dev</td>
<td>Development files for the GTK+ library</td>
</tr>
<tr class="odd">
<td>pkg-config</td>
<td>Manage compile and link flags for libraries</td>
</tr>
<tr class="even">
<td>libavcodec-dev</td>
<td>Development files for libavcodec (FFmpeg)</td>
</tr>
<tr class="odd">
<td>libavformat-dev</td>
<td>Development files for libavformat (FFmpeg)</td>
</tr>
<tr class="even">
<td>libswscale-dev</td>
<td>Development files for libswscale (FFmpeg)</td>
</tr>
<tr class="odd">
<td>python3-dev</td>
<td>Header files and a static library for Python3</td>
</tr>
<tr class="even">
<td>python3-numpy</td>
<td>NumPy library for Python3</td>
</tr>
<tr class="odd">
<td>libtbb2</td>
<td>Threading Building Blocks (TBB) library</td>
</tr>
<tr class="even">
<td>libtbb-dev</td>
<td>Threading Building Blocks (TBB) development files</td>
</tr>
<tr class="odd">
<td>libjpeg-dev</td>
<td>Development files for the JPEG library</td>
</tr>
<tr class="even">
<td>libpng-dev</td>
<td>Development files for the PNG library</td>
</tr>
<tr class="odd">
<td>libtiff-dev</td>
<td>Development files for the TIFF library</td>
</tr>
<tr class="even">
<td>libdc1394-22-dev</td>
<td>Development files for libdc1394 (IEEE 1394 camera control)</td>
</tr>
<tr class="odd">
<td>libv4l-dev</td>
<td>Development files for libv4l (video4linux)</td>
</tr>
<tr class="even">
<td>v4l-utils</td>
<td>Collection of command line video4linux utilities</td>
</tr>
<tr class="odd">
<td>libcanberra-gtk-module</td>
<td>GTK+ module for the libcanberra sound library</td>
</tr>
<tr class="even">
<td>libcanberra-gtk3-module</td>
<td>GTK+3 module for the libcanberra sound library</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt-get update</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sudo</span> apt-get install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-y</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-3">    build-essential cmake git <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-4">    libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-5">    gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-6">    gstreamer1.0-libav gstreamer1.0-tools gstreamer1.0-x gstreamer1.0-alsa gstreamer1.0-gl <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-7">    gstreamer1.0-gtk3 gstreamer1.0-qt5 gstreamer1.0-pulseaudio <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-8">    libgtk2.0-dev pkg-config libavcodec-dev libavformat-dev libswscale-dev <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-9">    python3-dev python3-numpy <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-10">    libtbb2 libtbb-dev libjpeg-dev libpng-dev libtiff-dev <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-11">    libdc1394-22-dev <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-12">    libv4l-dev v4l-utils <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-13">    libcanberra-gtk-module libcanberra-gtk3-module</span></code></pre></div>
</section>
<section id="build-opencv-python-pip-wheel" class="level3">
<h3 class="anchored" data-anchor-id="build-opencv-python-pip-wheel">Build <code>opencv-python</code> Pip Wheel</h3>
<p>With the dependencies installed, we can clone the <code>opencv-python</code> GitHub repository and build and install the Python wheel.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This process will also install NumPy.</p>
</div>
</div>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clone the opencv-python repository with all its submodules</span></span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> clone <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--recursive</span> https://github.com/opencv/opencv-python.git</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Change directory to the cloned repository</span></span>
<span id="cb4-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> opencv-python</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the current directory to Git's safe.directory list to avoid ownership issues</span></span>
<span id="cb4-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">git</span> config <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--global</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--add</span> safe.directory <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">pwd</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span></span>
<span id="cb4-9"></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set CMAKE_ARGS environment variable with OpenCV build options</span></span>
<span id="cb4-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">export</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">CMAKE_ARGS</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-D WITH_GSTREAMER=ON -D WITH_GTK=ON -D WITH_V4L=ON -D WITH_LIBV4L=ON -D WITH_OPENGL=ON"</span></span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set MAKEFLAGS to use all available CPU cores for compilation</span></span>
<span id="cb4-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">export</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">MAKEFLAGS</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-j</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">$(</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nproc</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">)</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb4-15"></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Upgrade pip and install/upgrade the wheel package</span></span>
<span id="cb4-17"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--upgrade</span> pip wheel</span>
<span id="cb4-18"></span>
<span id="cb4-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build the OpenCV Python wheel</span></span>
<span id="cb4-20"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> wheel . <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--verbose</span></span>
<span id="cb4-21"></span>
<span id="cb4-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Install the built OpenCV Python wheel</span></span>
<span id="cb4-23"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install opencv_python<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">*</span>.whl</span>
<span id="cb4-24"></span>
<span id="cb4-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Move back to the parent directory</span></span>
<span id="cb4-26"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> ..</span>
<span id="cb4-27"></span>
<span id="cb4-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if OpenCV was built with GStreamer support by printing build information and filtering for GStreamer</span></span>
<span id="cb4-29"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"import cv2; print(cv2.getBuildInformation())"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GStreamer"</span></span></code></pre></div>
<pre class="text"><code>    GStreamer:                   YES (1.20.3)</code></pre>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The final print statement verifies that we successfully built OpenCV with GStreamer support, which we need for using CSI Cameras.</p>
</div>
</div>
</section>
<section id="install-onnx-runtime" class="level3">
<h3 class="anchored" data-anchor-id="install-onnx-runtime">Install ONNX Runtime</h3>
<p>Next, we will install ONNX Runtime to use its TensorRT Execution Provider. The <a href="../ort-tensorrt-ubuntu/">previous tutorial</a> that utilized this execution provider used the dedicated <a href="https://pypi.org/project/tensorrt/">tensorrt pip package</a>. This time, we will use the version of TensorRT that comes with Jetpack 6.</p>
<p>According to NVIDIA’s <a href="https://developer.nvidia.com/embedded/jetpack-sdk-60">release page</a> for Jetpack 6, it comes with CUDA 12.2 and TensorRT 8.6.</p>
<p>Looking at ONNX Runtime’s <a href="https://onnxruntime.ai/docs/execution-providers/TensorRT-ExecutionProvider.html#requirements">documentation</a>, we can see that we need ONNX Runtime 1.17 for those versions of CUDA and TensorRT.</p>
<p>We can download a pre-built Python 3.10 wheel for ONNX Runtime 1.17 from the webpage linked below:</p>
<ul>
<li><a href="https://elinux.org/Jetson_Zoo#ONNX_Runtime">Jetson Zoo: ONNX Runtime</a></li>
</ul>
<p>Run the following commands to download and install the required Python wheel:</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">wget</span> https://nvidia.box.com/shared/static/i7n40ki3pl2x57vyn4u7e9asyiqlnl7n.whl <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O</span> onnxruntime_gpu-1.17.0-cp310-cp310-linux_aarch64.whl</span>
<span id="cb6-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install onnxruntime_gpu-1.17.0-cp310-cp310-linux_aarch64.whl</span></code></pre></div>
</section>
<section id="install-additional-dependencies" class="level3">
<h3 class="anchored" data-anchor-id="install-additional-dependencies">Install Additional Dependencies</h3>
<p>To wrap up our environment setup, we will install a few additional dependencies for our demo project and downgrade NumPy to a version supported by ONNX Runtime.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-U</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"numpy&lt;2"</span></span>
<span id="cb7-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install jupyter cjm_psl_utils cjm_pil_utils cjm_byte_track</span></code></pre></div>
<p>With our environment set up, we can dive into the code.</p>
</section>
</section>
<section id="getting-started-with-the-code" class="level2">
<h2 class="anchored" data-anchor-id="getting-started-with-the-code">Getting Started with the Code</h2>
<p>This tutorial walks through the demo as a Jupyter Notebook, but the code is also available as a Python script.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Jupyter Notebook</th>
<th>Python Script</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><a href="https://github.com/cj-mills/pytorch-yolox-object-detection-tutorial-code/blob/main/notebooks/yolox-ort-trt-bytetrack-jetson.ipynb">yolox-ort-trt-bytetrack-jetson.ipynb</a></td>
<td><a href="https://github.com/cj-mills/pytorch-yolox-object-detection-tutorial-code/blob/main/scripts/yolox-ort-tensorrt-byte-track.py">scripts/yolox-ort-tensorrt-byte-track.py</a></td>
</tr>
</tbody>
</table>
</section>
<section id="importing-the-required-dependencies" class="level2">
<h2 class="anchored" data-anchor-id="importing-the-required-dependencies">Importing the Required Dependencies</h2>
<p>First, we will import the necessary Python packages.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standard library imports</span></span>
<span id="cb8-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> json  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For JSON data handling</span></span>
<span id="cb8-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For file path operations</span></span>
<span id="cb8-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For time-related functions</span></span>
<span id="cb8-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> threading  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For multi-threading support</span></span>
<span id="cb8-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For type hinting</span></span>
<span id="cb8-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> queue  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For queue data structure</span></span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ByteTrack package for object tracking</span></span>
<span id="cb8-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> cjm_byte_track.core <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BYTETracker</span>
<span id="cb8-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> cjm_byte_track.matching <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> match_detections_with_tracks</span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Utility functions</span></span>
<span id="cb8-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> cjm_psl_utils.core <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> download_file  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For downloading files</span></span>
<span id="cb8-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> cjm_pil_utils.core <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> resize_img  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For resizing images</span></span>
<span id="cb8-16"></span>
<span id="cb8-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OpenCV for computer vision tasks</span></span>
<span id="cb8-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> cv2</span>
<span id="cb8-19"></span>
<span id="cb8-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NumPy for numerical operations</span></span>
<span id="cb8-21"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb8-22"></span>
<span id="cb8-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PIL (Python Imaging Library) for image processing</span></span>
<span id="cb8-24"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image, ImageDraw, ImageFont</span>
<span id="cb8-25"></span>
<span id="cb8-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ONNX (Open Neural Network Exchange) for machine learning interoperability</span></span>
<span id="cb8-27"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> onnxruntime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ort  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ONNX Runtime for model inference</span></span></code></pre></div>
</section>
<section id="defining-utility-functions" class="level2">
<h2 class="anchored" data-anchor-id="defining-utility-functions">Defining Utility Functions</h2>
<p>Next, we will define some utility functions for our demo, starting with those needed for performing inference with our YOLOX ONNX model.</p>
<section id="define-functions-for-yolox-inference" class="level3">
<h3 class="anchored" data-anchor-id="define-functions-for-yolox-inference">Define Functions for YOLOX Inference</h3>
<p>These steps remain unchanged from <a href="../byte-track/#defining-utility-functions">previous tutorials</a>.</p>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> prepare_image_for_inference(frame:np.ndarray, target_sz:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, max_stride:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb9-2"></span>
<span id="cb9-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Prepares an image for inference by performing a series of preprocessing steps.</span></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Steps:</span></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    1. Converts a BGR image to RGB.</span></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    2. Resizes the image to a target size without cropping, considering a given divisor.</span></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    3. Calculates input dimensions as multiples of the max stride.</span></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    4. Calculates offsets based on the resized image dimensions and input dimensions.</span></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    5. Computes the scale between the original and resized image.</span></span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    6. Crops the resized image based on calculated input dimensions.</span></span>
<span id="cb9-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb9-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - frame (numpy.ndarray): The input image in BGR format.</span></span>
<span id="cb9-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - target_sz (int): The target minimum size for resizing the image.</span></span>
<span id="cb9-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - max_stride (int): The maximum stride to be considered for calculating input dimensions.</span></span>
<span id="cb9-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb9-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb9-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tuple: </span></span>
<span id="cb9-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - rgb_img (PIL.Image): The converted RGB image.</span></span>
<span id="cb9-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - input_dims (list of int): Dimensions of the image that are multiples of max_stride.</span></span>
<span id="cb9-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - offsets (numpy.ndarray): Offsets from the resized image dimensions to the input dimensions.</span></span>
<span id="cb9-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - min_img_scale (float): Scale factor between the original and resized image.</span></span>
<span id="cb9-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - input_img (PIL.Image): Cropped image based on the calculated input dimensions.</span></span>
<span id="cb9-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb9-27"></span>
<span id="cb9-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the BGR image to RGB</span></span>
<span id="cb9-29">    rgb_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.fromarray(cv2.cvtColor(frame, cv2.COLOR_BGR2RGB))</span>
<span id="cb9-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Resize image without cropping to multiple of the max stride</span></span>
<span id="cb9-31">    resized_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> resize_img(rgb_img, target_sz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>target_sz, divisor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-32">    </span>
<span id="cb9-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculating the input dimensions that multiples of the max stride</span></span>
<span id="cb9-34">    input_dims <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> max_stride <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> dim <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> resized_img.size]</span>
<span id="cb9-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the offsets from the resized image dimensions to the input dimensions</span></span>
<span id="cb9-36">    offsets <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (np.array(resized_img.size) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> input_dims) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb9-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the scale between the source image and the resized image</span></span>
<span id="cb9-38">    min_img_scale <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(rgb_img.size) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(resized_img.size)</span>
<span id="cb9-39">    </span>
<span id="cb9-40">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Crop the resized image to the input dimensions</span></span>
<span id="cb9-41">    input_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> resized_img.crop(box<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>offsets, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>resized_img.size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> offsets])</span>
<span id="cb9-42">    </span>
<span id="cb9-43">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rgb_img, input_dims, offsets, min_img_scale, input_img</span></code></pre></div>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> generate_output_grids_np(height, width, strides<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>]):</span>
<span id="cb10-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Generate a numpy array containing grid coordinates and strides for a given height and width.</span></span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        height (int): The height of the image.</span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        width (int): The width of the image.</span></span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        np.ndarray: A numpy array containing grid coordinates and strides.</span></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-12"></span>
<span id="cb10-13">    all_coordinates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb10-14"></span>
<span id="cb10-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> stride <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> strides:</span>
<span id="cb10-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the grid height and width</span></span>
<span id="cb10-17">        grid_height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> stride</span>
<span id="cb10-18">        grid_width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> width <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> stride</span>
<span id="cb10-19"></span>
<span id="cb10-20">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate grid coordinates</span></span>
<span id="cb10-21">        g1, g0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.meshgrid(np.arange(grid_height), np.arange(grid_width), indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ij'</span>)</span>
<span id="cb10-22"></span>
<span id="cb10-23">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an array of strides</span></span>
<span id="cb10-24">        s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.full((grid_height, grid_width), stride)</span>
<span id="cb10-25"></span>
<span id="cb10-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stack the coordinates along with the stride</span></span>
<span id="cb10-27">        coordinates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.stack((g0.flatten(), g1.flatten(), s.flatten()), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-28"></span>
<span id="cb10-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Append to the list</span></span>
<span id="cb10-30">        all_coordinates.append(coordinates)</span>
<span id="cb10-31"></span>
<span id="cb10-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Concatenate all arrays in the list along the first dimension</span></span>
<span id="cb10-33">    output_grids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.concatenate(all_coordinates, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb10-34"></span>
<span id="cb10-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> output_grids</span></code></pre></div>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calculate_boxes_and_probs(model_output:np.ndarray, output_grids:np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb11-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Calculate the bounding boxes and their probabilities.</span></span>
<span id="cb11-4"></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb11-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    model_output (numpy.ndarray): The output of the model.</span></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    output_grids (numpy.ndarray): The output grids.</span></span>
<span id="cb11-8"></span>
<span id="cb11-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb11-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    numpy.ndarray: The array containing the bounding box coordinates, class labels, and maximum probabilities.</span></span>
<span id="cb11-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb11-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the bounding box coordinates</span></span>
<span id="cb11-13">    box_centroids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (model_output[..., :<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> output_grids[..., :<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> output_grids[..., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]</span>
<span id="cb11-14">    box_sizes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(model_output[..., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> output_grids[..., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]</span>
<span id="cb11-15"></span>
<span id="cb11-16">    x0, y0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [t.squeeze(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> np.split(box_centroids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> box_sizes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)]</span>
<span id="cb11-17">    w, h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [t.squeeze(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> np.split(box_sizes, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)]</span>
<span id="cb11-18"></span>
<span id="cb11-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the probabilities for each class</span></span>
<span id="cb11-20">    box_objectness <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_output[..., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb11-21">    box_cls_scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model_output[..., <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:]</span>
<span id="cb11-22">    box_probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.expand_dims(box_objectness, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> box_cls_scores</span>
<span id="cb11-23"></span>
<span id="cb11-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the maximum probability and corresponding class for each proposal</span></span>
<span id="cb11-25">    max_probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(box_probs, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-26">    labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(box_probs, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-27"></span>
<span id="cb11-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> np.array([x0, y0, w, h, labels, max_probs]).transpose((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span></code></pre></div>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> process_outputs(outputs:np.ndarray, input_dims:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>, bbox_conf_thresh:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>):</span>
<span id="cb12-2"></span>
<span id="cb12-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Process the model outputs to generate bounding box proposals filtered by confidence threshold.</span></span>
<span id="cb12-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb12-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - outputs (numpy.ndarray): The raw output from the model, which will be processed to calculate boxes and probabilities.</span></span>
<span id="cb12-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - input_dims (tuple of int): Dimensions (height, width) of the input image to the model.</span></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - bbox_conf_thresh (float): Threshold for the bounding box confidence/probability. Bounding boxes with a confidence</span></span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                score below this threshold will be discarded.</span></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb12-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb12-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - numpy.array: An array of proposals where each proposal is an array containing bounding box coordinates</span></span>
<span id="cb12-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                   and its associated probability, sorted in descending order by probability.</span></span>
<span id="cb12-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb12-16"></span>
<span id="cb12-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process the model output</span></span>
<span id="cb12-18">    outputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calculate_boxes_and_probs(outputs, generate_output_grids_np(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>input_dims))</span>
<span id="cb12-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter the proposals based on the confidence threshold</span></span>
<span id="cb12-20">    max_probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outputs[:, :, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb12-21">    mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> max_probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> bbox_conf_thresh</span>
<span id="cb12-22">    proposals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> outputs[mask]</span>
<span id="cb12-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sort the proposals by probability in descending order</span></span>
<span id="cb12-24">    proposals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> proposals[proposals[..., <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].argsort()][::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb12-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> proposals</span></code></pre></div>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_iou(proposals:np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb13-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Calculates the Intersection over Union (IoU) for all pairs of bounding boxes (x,y,w,h) in 'proposals'.</span></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    The IoU is a measure of overlap between two bounding boxes. It is calculated as the area of</span></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    intersection divided by the area of union of the two boxes.</span></span>
<span id="cb13-7"></span>
<span id="cb13-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    proposals (2D np.array): A NumPy array of bounding boxes, where each box is an array [x, y, width, height].</span></span>
<span id="cb13-10"></span>
<span id="cb13-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    iou (2D np.array): The IoU matrix where each element i,j represents the IoU of boxes i and j.</span></span>
<span id="cb13-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb13-14"></span>
<span id="cb13-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate coordinates for the intersection rectangles</span></span>
<span id="cb13-16">    x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.maximum(proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>])</span>
<span id="cb13-17">    y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.maximum(proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>])</span>
<span id="cb13-18">    x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.minimum(proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], (proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>])</span>
<span id="cb13-19">    y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.minimum(proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], (proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>])</span>
<span id="cb13-20">    </span>
<span id="cb13-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate intersection areas</span></span>
<span id="cb13-22">    intersections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.maximum(x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x1, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.maximum(y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y1, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb13-23"></span>
<span id="cb13-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate union areas</span></span>
<span id="cb13-25">    areas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> proposals[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb13-26">    unions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> areas[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> areas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> intersections</span>
<span id="cb13-27"></span>
<span id="cb13-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate IoUs</span></span>
<span id="cb13-29">    iou <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> intersections <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> unions</span>
<span id="cb13-30"></span>
<span id="cb13-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the iou matrix</span></span>
<span id="cb13-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> iou</span></code></pre></div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> nms_sorted_boxes(iou:np.ndarray, iou_thresh:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray:</span>
<span id="cb14-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Applies non-maximum suppression (NMS) to sorted bounding boxes.</span></span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    It suppresses boxes that have high overlap (as defined by the IoU threshold) with a box that </span></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    has a higher score.</span></span>
<span id="cb14-7"></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    iou (np.ndarray): An IoU matrix where each element i,j represents the IoU of boxes i and j.</span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    iou_thresh (float): The IoU threshold for suppression. Boxes with IoU &gt; iou_thresh are suppressed.</span></span>
<span id="cb14-11"></span>
<span id="cb14-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb14-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    keep (np.ndarray): The indices of the boxes to keep after applying NMS.</span></span>
<span id="cb14-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb14-15"></span>
<span id="cb14-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a boolean mask to keep track of boxes</span></span>
<span id="cb14-17">    mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.ones(iou.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>)</span>
<span id="cb14-18"></span>
<span id="cb14-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply non-max suppression</span></span>
<span id="cb14-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(iou.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb14-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> mask[i]:</span>
<span id="cb14-22">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Suppress boxes with higher index and IoU &gt; threshold</span></span>
<span id="cb14-23">            mask[(iou[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> iou_thresh) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.arange(iou.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> i)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb14-24"></span>
<span id="cb14-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the indices of the boxes to keep</span></span>
<span id="cb14-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> np.arange(iou.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])[mask]</span></code></pre></div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> draw_bboxes_pil(image, boxes, labels, colors, font, width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, font_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>, probs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb15-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Annotates an image with bounding boxes, labels, and optional probability scores.</span></span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - image (PIL.Image): The input image on which annotations will be drawn.</span></span>
<span id="cb15-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - boxes (list of tuples): A list of bounding box coordinates where each tuple is (x, y, w, h).</span></span>
<span id="cb15-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - labels (list of str): A list of labels corresponding to each bounding box.</span></span>
<span id="cb15-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - colors (list of str): A list of colors for each bounding box and its corresponding label.</span></span>
<span id="cb15-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - font (str): Path to the font file to be used for displaying the labels.</span></span>
<span id="cb15-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - width (int, optional): Width of the bounding box lines. Defaults to 2.</span></span>
<span id="cb15-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - font_size (int, optional): Size of the font for the labels. Defaults to 18.</span></span>
<span id="cb15-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - probs (list of float, optional): A list of probability scores corresponding to each label. Defaults to None.</span></span>
<span id="cb15-14"></span>
<span id="cb15-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb15-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - annotated_image (PIL.Image): The image annotated with bounding boxes, labels, and optional probability scores.</span></span>
<span id="cb15-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb15-18">    </span>
<span id="cb15-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a reference diagonal</span></span>
<span id="cb15-20">    REFERENCE_DIAGONAL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb15-21">    </span>
<span id="cb15-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scale the font size using the hypotenuse of the image</span></span>
<span id="cb15-23">    font_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(font_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (np.hypot(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>image.size) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> REFERENCE_DIAGONAL))</span>
<span id="cb15-24">    </span>
<span id="cb15-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add probability scores to labels if provided</span></span>
<span id="cb15-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> probs <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb15-27">        labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>prob<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> label, prob <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(labels, probs)]</span>
<span id="cb15-28"></span>
<span id="cb15-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an ImageDraw object for drawing on the image</span></span>
<span id="cb15-30">    draw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDraw.Draw(image)</span>
<span id="cb15-31"></span>
<span id="cb15-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the font file (outside the loop)</span></span>
<span id="cb15-33">    fnt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageFont.truetype(font, font_size)</span>
<span id="cb15-34">    </span>
<span id="cb15-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the mean color value for each color</span></span>
<span id="cb15-36">    mean_colors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [np.mean(np.array(color)) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> color <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> colors]</span>
<span id="cb15-37"></span>
<span id="cb15-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loop through the bounding boxes, labels, and colors</span></span>
<span id="cb15-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> box, label, color, mean_color <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(boxes, labels, colors, mean_colors):</span>
<span id="cb15-40">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the bounding box coordinates</span></span>
<span id="cb15-41">        x, y, w, h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> box</span>
<span id="cb15-42"></span>
<span id="cb15-43">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw the bounding box on the image</span></span>
<span id="cb15-44">        draw.rectangle([x, y, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>w, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>h], outline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color, width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>width)</span>
<span id="cb15-45">        </span>
<span id="cb15-46">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the size of the label text box</span></span>
<span id="cb15-47">        label_w, label_h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> draw.textbbox(xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), text<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>label, font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fnt)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]</span>
<span id="cb15-48">        </span>
<span id="cb15-49">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw the label rectangle on the image</span></span>
<span id="cb15-50">        draw.rectangle([x, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>label_h, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>label_w, y], outline<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color)</span>
<span id="cb15-51"></span>
<span id="cb15-52">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw the label text on the image</span></span>
<span id="cb15-53">        font_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> mean_color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">127.5</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span></span>
<span id="cb15-54">        draw.multiline_text((x, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>label_h), label, font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>fnt, fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>font_color)</span>
<span id="cb15-55">        </span>
<span id="cb15-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> image</span></code></pre></div>
</section>
<section id="define-a-function-to-generate-a-gstreamer-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="define-a-function-to-generate-a-gstreamer-pipeline">Define a Function to Generate a GStreamer Pipeline</h3>
<p>Next, we will define a function to generate a GStreamer pipeline string for OpenCV. We need this to get input from a CSI camera.</p>
<p>The code is a lightly modified version of the <a href="https://github.com/JetsonHacksNano/CSI-Camera/blob/e11a0fa1f68519166e1627c5277c6dfda29f9d2f/simple_camera.py#L17">implementation</a> in the following JetsonHacks repository.</p>
<ul>
<li><a href="https://github.com/JetsonHacksNano/CSI-Camera/tree/master">CSI-Camera</a></li>
</ul>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> gstreamer_pipeline(</span>
<span id="cb16-2">    sensor_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb16-3">    capture_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1920</span>,</span>
<span id="cb16-4">    capture_height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1080</span>,</span>
<span id="cb16-5">    display_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">960</span>,</span>
<span id="cb16-6">    display_height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">540</span>,</span>
<span id="cb16-7">    framerate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,</span>
<span id="cb16-8">    flip_method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb16-9">):</span>
<span id="cb16-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Generate a GStreamer pipeline string for capturing and processing video from a camera.</span></span>
<span id="cb16-12"></span>
<span id="cb16-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function creates a pipeline that captures video from an NVIDIA Argus camera,</span></span>
<span id="cb16-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    performs necessary conversions, and prepares the video for display or further processing.</span></span>
<span id="cb16-15"></span>
<span id="cb16-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb16-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        sensor_id (int): The ID of the camera sensor to use (default: 0).</span></span>
<span id="cb16-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        capture_width (int): The width of the captured video in pixels (default: 1920).</span></span>
<span id="cb16-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        capture_height (int): The height of the captured video in pixels (default: 1080).</span></span>
<span id="cb16-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        display_width (int): The width of the displayed/processed video in pixels (default: 960).</span></span>
<span id="cb16-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        display_height (int): The height of the displayed/processed video in pixels (default: 540).</span></span>
<span id="cb16-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        framerate (int): The desired framerate of the video capture (default: 30).</span></span>
<span id="cb16-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        flip_method (int): The method used to flip the image, if needed (default: 0, no flip).</span></span>
<span id="cb16-24"></span>
<span id="cb16-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb16-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        str: A GStreamer pipeline string that can be used with GStreamer-based applications.</span></span>
<span id="cb16-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb16-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (</span>
<span id="cb16-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Start with nvarguscamerasrc to capture from NVIDIA Argus camera</span></span>
<span id="cb16-30">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"nvarguscamerasrc sensor-id=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sensor_id<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ! "</span></span>
<span id="cb16-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the captured video format and properties</span></span>
<span id="cb16-32">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"video/x-raw(memory:NVMM), width=(int)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>capture_width<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, height=(int)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>capture_height<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, framerate=(fraction)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>framerate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/1 ! "</span></span>
<span id="cb16-33">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use nvvidconv to convert the video and potentially flip the image</span></span>
<span id="cb16-34">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"nvvidconv flip-method=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>flip_method<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ! "</span></span>
<span id="cb16-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the display/processing video format and properties</span></span>
<span id="cb16-36">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"video/x-raw, width=(int)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>display_width<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, height=(int)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>display_height<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, format=(string)BGRx ! "</span></span>
<span id="cb16-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the video color format</span></span>
<span id="cb16-38">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"videoconvert ! "</span></span>
<span id="cb16-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the final video format to BGR for compatibility with OpenCV</span></span>
<span id="cb16-40">        <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"video/x-raw, format=(string)BGR ! appsink"</span></span>
<span id="cb16-41">    )</span></code></pre></div>
</section>
<section id="define-a-wrapper-class-for-reading-camera-frames" class="level3">
<h3 class="anchored" data-anchor-id="define-a-wrapper-class-for-reading-camera-frames">Define a Wrapper Class for Reading Camera Frames</h3>
<p>When testing the demo using OpenCV’s <code>VideoCapture</code> class directly, I noticed a delay between the input to the camera (e.g., me waving my hand) and what showed on the preview window.</p>
<p>This lag only occurred when performing inference, and the delay increased at higher framerates. It was as if there were a frame queue that built up faster than the Jetson could process.</p>
<p>This effect is not necessarily a problem, depending on the application. However, I found it annoying, so I used the following solution to get around it. It is essentially a wrapper for the <code>VideoCapture</code> class that helps ensure we only work with the most recent frame from the camera.</p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> FrameDropper:</span>
<span id="cb17-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A class for efficiently reading frames from a video capture device,</span></span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    dropping frames if necessary to maintain real-time processing.</span></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb17-6"></span>
<span id="cb17-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, cv2_capture: cv2.VideoCapture, queue_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb17-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb17-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Initialize the FrameDropper.</span></span>
<span id="cb17-10"></span>
<span id="cb17-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb17-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            cv2_capture (cv2.VideoCapture): The video capture object.</span></span>
<span id="cb17-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            queue_size (int): Maximum number of frames to keep in the queue.</span></span>
<span id="cb17-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb17-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store the video capture object</span></span>
<span id="cb17-16">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cv2_capture</span>
<span id="cb17-17">        </span>
<span id="cb17-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a queue to store frames with a maximum size</span></span>
<span id="cb17-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> queue.Queue(maxsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>queue_size)</span>
<span id="cb17-20">        </span>
<span id="cb17-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an event to signal when to stop the thread</span></span>
<span id="cb17-22">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.stop_flag <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threading.Event()</span>
<span id="cb17-23">        </span>
<span id="cb17-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a separate thread for reading frames</span></span>
<span id="cb17-25">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.thread <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threading.Thread(target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>._reader)</span>
<span id="cb17-26">        </span>
<span id="cb17-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the thread as a daemon, so it will automatically close when the main program exits</span></span>
<span id="cb17-28">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.thread.daemon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb17-29">        </span>
<span id="cb17-30">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Start the thread</span></span>
<span id="cb17-31">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.thread.start()</span>
<span id="cb17-32"></span>
<span id="cb17-33">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _reader(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb17-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb17-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Continuously read frames from the video capture device and manage the frame queue.</span></span>
<span id="cb17-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Runs in a separate thread.</span></span>
<span id="cb17-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb17-38">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.stop_flag.is_set():  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Continue until the stop flag is set</span></span>
<span id="cb17-39">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read a frame from the video capture device</span></span>
<span id="cb17-40">            ret, frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cap.read()</span>
<span id="cb17-41">            </span>
<span id="cb17-42">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> ret:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If reading the frame failed, exit the loop</span></span>
<span id="cb17-43">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb17-44">            </span>
<span id="cb17-45">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.q.full():  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the queue is not full</span></span>
<span id="cb17-46">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.q.put(frame)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the frame to the queue</span></span>
<span id="cb17-47">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb17-48">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb17-49">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the queue is full, try to remove the oldest frame</span></span>
<span id="cb17-50">                    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.q.get_nowait()</span>
<span id="cb17-51">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">except</span> queue.Empty:</span>
<span id="cb17-52">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the queue is empty (unlikely, but possible due to race conditions)</span></span>
<span id="cb17-53">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span>
<span id="cb17-54">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the new frame to the queue</span></span>
<span id="cb17-55">                <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.q.put(frame)</span>
<span id="cb17-56"></span>
<span id="cb17-57">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> read(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb17-58">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb17-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Read a frame from the queue.</span></span>
<span id="cb17-60"></span>
<span id="cb17-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb17-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            tuple: (True, frame) where frame is the next available frame.</span></span>
<span id="cb17-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb17-64">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the next frame from the queue and return it</span></span>
<span id="cb17-65">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The 'True' indicates that a frame was successfully read</span></span>
<span id="cb17-66">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.q.get()</span>
<span id="cb17-67"></span>
<span id="cb17-68">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> release(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb17-69">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb17-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Stop the reading thread and release the video capture resources.</span></span>
<span id="cb17-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb17-72">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the stop flag to signal the thread to stop</span></span>
<span id="cb17-73">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.stop_flag.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>()</span>
<span id="cb17-74">        </span>
<span id="cb17-75">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Release the video capture object</span></span>
<span id="cb17-76">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.cap.release()</span>
<span id="cb17-77">        </span>
<span id="cb17-78">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wait for the thread to finish</span></span>
<span id="cb17-79">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.thread.join()</span></code></pre></div>
<ol type="1">
<li>The class employs threading to read frames in the background, enhancing processing efficiency.</li>
<li>The class utilizes the <a href="https://docs.python.org/3/library/queue.html">queue</a> module to manage frames safely across threads.</li>
<li>A separate thread executes the <code>_reader</code> method, which continuously reads frames and manages the queue.</li>
<li>When the queue reaches capacity, the class discards the oldest frame to accommodate the newest one. This approach ensures the availability of the most recent frame for processing.</li>
<li>The main video processing loop accesses frames from the queue through the <code>read</code> method.</li>
<li>The release method stops the thread and frees up resources once the program finishes with video capture.</li>
</ol>
<p>That takes care of the utility code.</p>
</section>
</section>
<section id="setting-up-the-project" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-project">Setting Up the Project</h2>
<p>Next, we will set the folder locations for our project and the directory with the ONNX model, JSON colormap file, and the <a href="../ort-tensorrt-ubuntu/#inspect-tensorrt-cache-folder">calibration data</a> used by TensorRT to <a href="../ort-tensorrt-ubuntu/#quantization-process">quantize the model</a>.</p>
<section id="set-the-directory-paths" class="level3">
<h3 class="anchored" data-anchor-id="set-the-directory-paths">Set the Directory Paths</h3>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The name for the project</span></span>
<span id="cb18-2">project_name <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"pytorch-yolox-object-detector"</span></span>
<span id="cb18-3"></span>
<span id="cb18-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The path for the project folder</span></span>
<span id="cb18-5">project_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"./</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>project_name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/"</span>)</span>
<span id="cb18-6"></span>
<span id="cb18-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the project directory if it does not already exist</span></span>
<span id="cb18-8">project_dir.mkdir(parents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb18-9"></span>
<span id="cb18-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The path to the checkpoint folder</span></span>
<span id="cb18-11">checkpoint_folder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2024-02-17_11-08-46"</span></span>
<span id="cb18-12">checkpoint_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(project_dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>checkpoint_folder)</span></code></pre></div>
<div class="callout callout-style-default callout-tip callout-titled" title="Sample Files:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Sample Files:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I made an ONNX model available on Hugging Face Hub with a colormap file and a <code>trt_engine_cache</code> folder in the repository linked below:
<ul>
<li><a href="https://huggingface.co/cj-mills/yolox-hagrid-onnx/tree/main">cj-mills/yolox-hagrid-onnx</a></li>
</ul></li>
</ul>
</div>
</div>
</section>
<section id="download-a-font-file" class="level3">
<h3 class="anchored" data-anchor-id="download-a-font-file">Download a Font File</h3>
<p>We should also ensure we have a font file for annotating images.</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the name of the font file</span></span>
<span id="cb19-2">font_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'KFOlCnqEu92Fr1MmEU9vAw.ttf'</span></span>
<span id="cb19-3"></span>
<span id="cb19-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download the font file</span></span>
<span id="cb19-5">download_file(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"https://fonts.gstatic.com/s/roboto/v30/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>font_file<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./"</span>)</span></code></pre></div>
</section>
</section>
<section id="loading-the-checkpoint-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-the-checkpoint-data">Loading the Checkpoint Data</h2>
<p>Next, we will load the colormap and set the max stride value for processing model output.</p>
<section id="load-the-colormap" class="level3">
<h3 class="anchored" data-anchor-id="load-the-colormap">Load the Colormap</h3>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The colormap path</span></span>
<span id="cb20-2">colormap_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(checkpoint_dir.glob(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*colormap.json'</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the JSON colormap data</span></span>
<span id="cb20-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(colormap_path, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>:</span>
<span id="cb20-6">        colormap_json <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> json.load(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>)</span>
<span id="cb20-7"></span>
<span id="cb20-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the JSON data to a dictionary        </span></span>
<span id="cb20-9">colormap_dict <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>]: item[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'color'</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> item <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> colormap_json[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'items'</span>]}</span>
<span id="cb20-10"></span>
<span id="cb20-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the class names from the colormap</span></span>
<span id="cb20-12">class_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(colormap_dict.keys())</span>
<span id="cb20-13"></span>
<span id="cb20-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a copy of the colormap in integer format</span></span>
<span id="cb20-15">int_colors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> c <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> color) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> color <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> colormap_dict.values()]</span></code></pre></div>
</section>
<section id="set-the-preprocessing-and-post-processing-parameters" class="level3">
<h3 class="anchored" data-anchor-id="set-the-preprocessing-and-post-processing-parameters">Set the Preprocessing and Post-Processing Parameters</h3>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">max_stride <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb21-2">input_dim_slice <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">slice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span></code></pre></div>
</section>
</section>
<section id="create-an-inference-session" class="level2">
<h2 class="anchored" data-anchor-id="create-an-inference-session">Create an Inference Session</h2>
<p>Now, we can create an inference session using the TensorRT execution provider.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The following code assumes the <a href="../ort-tensorrt-ubuntu/#inspect-tensorrt-cache-folder"><code>trt_engine_cache</code></a> folder is in the same directory as the ONNX model.</p>
</div>
</div>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the filename for the ONNX model</span></span>
<span id="cb22-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assumes there's only one .onnx file in the checkpoint directory</span></span>
<span id="cb22-3">onnx_file_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(checkpoint_dir.glob(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'*.onnx'</span>))[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb22-4"></span>
<span id="cb22-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up a directory for TensorRT engine cache</span></span>
<span id="cb22-6">trt_cache_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> checkpoint_dir <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_engine_cache'</span></span>
<span id="cb22-7"></span>
<span id="cb22-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize ONNX Runtime session options</span></span>
<span id="cb22-9">sess_opt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ort.SessionOptions()</span>
<span id="cb22-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Disable memory optimizations to potentially improve performance</span></span>
<span id="cb22-11">sess_opt.enable_cpu_mem_arena <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb22-12">sess_opt.enable_mem_pattern <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb22-13">sess_opt.enable_mem_reuse <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb22-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set execution mode to sequential for predictable behavior</span></span>
<span id="cb22-15">sess_opt.execution_mode <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ort.ExecutionMode.ORT_SEQUENTIAL</span>
<span id="cb22-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enable all graph optimizations</span></span>
<span id="cb22-17">sess_opt.graph_optimization_level <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ort.GraphOptimizationLevel.ORT_ENABLE_ALL</span>
<span id="cb22-18"></span>
<span id="cb22-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure TensorRT Execution Provider settings</span></span>
<span id="cb22-20">providers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb22-21">    (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TensorrtExecutionProvider'</span>, {</span>
<span id="cb22-22">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'device_id'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GPU device ID (0 for the first GPU)</span></span>
<span id="cb22-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_int8_enable'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enable INT8 precision mode</span></span>
<span id="cb22-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_engine_cache_enable'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enable caching of TensorRT engines</span></span>
<span id="cb22-25">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_engine_cache_path'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(trt_cache_dir),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Path to store TensorRT cache</span></span>
<span id="cb22-26">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_int8_calibration_table_name'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'calibration.flatbuffers'</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># INT8 calibration file</span></span>
<span id="cb22-27">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_max_workspace_size'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4e9</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Maximum TensorRT workspace size (4GB)</span></span>
<span id="cb22-28">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_timing_cache_enable'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enable timing cache for faster engine building</span></span>
<span id="cb22-29">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_force_sequential_engine_build'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build engines sequentially</span></span>
<span id="cb22-30">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_dla_enable'</span>: <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Disable DLA (Deep Learning Accelerator)</span></span>
<span id="cb22-31">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_max_partition_iterations'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Max iterations for partitioning</span></span>
<span id="cb22-32">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'trt_min_subgraph_size'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Minimum subgraph size for TensorRT</span></span>
<span id="cb22-33">    })</span>
<span id="cb22-34">]</span>
<span id="cb22-35"></span>
<span id="cb22-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an ONNX Runtime InferenceSession with the specified options and providers</span></span>
<span id="cb22-37">session <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ort.InferenceSession(onnx_file_path, sess_options<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sess_opt, providers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>providers)</span></code></pre></div>
<pre class="text"><code>[0;93m2024-09-05 16:34:58.430807424 [W:onnxruntime:Default, tensorrt_execution_provider.h:83 log] [2024-09-05 23:34:58 WARNING] onnx2trt_utils.cpp:372: Your ONNX model has been generated with INT64 weights, while TensorRT does not natively support INT64. Attempting to cast down to INT32.[m
[0;93m2024-09-05 16:34:58.430935716 [W:onnxruntime:Default, tensorrt_execution_provider.h:83 log] [2024-09-05 23:34:58 WARNING] onnx2trt_utils.cpp:400: One or more weights outside the range of INT32 was clamped[m
[0;93m2024-09-05 16:34:58.472815780 [W:onnxruntime:Default, tensorrt_execution_provider.h:83 log] [2024-09-05 23:34:58 WARNING] onnx2trt_utils.cpp:372: Your ONNX model has been generated with INT64 weights, while TensorRT does not natively support INT64. Attempting to cast down to INT32.[m
[0;93m2024-09-05 16:34:58.472888966 [W:onnxruntime:Default, tensorrt_execution_provider.h:83 log] [2024-09-05 23:34:58 WARNING] onnx2trt_utils.cpp:400: One or more weights outside the range of INT32 was clamped[m</code></pre>
</section>
<section id="tracking-objects-in-a-camera-feed" class="level2">
<h2 class="anchored" data-anchor-id="tracking-objects-in-a-camera-feed">Tracking Objects in a Camera Feed</h2>
<p>Next, we will define the camera feed settings and the inference parameters.</p>
<section id="define-camera-feed-settings" class="level3">
<h3 class="anchored" data-anchor-id="define-camera-feed-settings">Define Camera Feed Settings</h3>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" aria-controls="tabset-1-1" aria-selected="true">CSI</a></li><li class="nav-item"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" aria-controls="tabset-1-2" aria-selected="false">USB</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" aria-labelledby="tabset-1-1-tab">
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1">use_csi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb24-2">sensor_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb24-3">flip_method <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb24-4">framerate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span></span>
<span id="cb24-5">capture_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1280</span></span>
<span id="cb24-6">capture_height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">720</span></span></code></pre></div>
</div>
<div id="tabset-1-2" class="tab-pane" aria-labelledby="tabset-1-2-tab">
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1">use_csi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb25-2">sensor_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb25-3">flip_method <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb25-4">framerate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span></span>
<span id="cb25-5">capture_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1280</span></span>
<span id="cb25-6">capture_height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">720</span></span></code></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you have multiple camera devices attached to the Jetson (e.g., a USB camera and a CSI camera), set the correct <code>sensor_id</code> for the target device.</p>
</div>
</div>
</section>
<section id="define-inference-parameters" class="level3">
<h3 class="anchored" data-anchor-id="define-inference-parameters">Define Inference Parameters</h3>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">test_sz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">384</span></span>
<span id="cb26-2">bbox_conf_thresh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span></span>
<span id="cb26-3">iou_thresh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.45</span></span></code></pre></div>
</section>
<section id="build-tensorrt-engine" class="level3">
<h3 class="anchored" data-anchor-id="build-tensorrt-engine">Build TensorRT Engine</h3>
<p>The TensorRT build process can take several minutes on the Jetson, so we will use a random sample input to build the engine before starting the camera feed loop.</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb27-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a sample input with the target dimensions </span></span>
<span id="cb27-3">test_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.fromarray(np.random.randn(capture_height, capture_width, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>).astype(np.uint8))</span>
<span id="cb27-4">resized_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> resize_img(test_img, test_sz)</span>
<span id="cb27-5">input_tensor_np <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(resized_img, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float32).transpose((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb27-6"></span>
<span id="cb27-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform a single inference run to build the TensorRT engine for the current input dimensions</span></span>
<span id="cb27-8">session.run(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: input_tensor_np})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<pre class="text"><code>2024-09-06 13:40:43.685287224 [W:onnxruntime:Default, tensorrt_execution_provider.cc:189 loadTimingCacheFile] [TensorRT EP] Could not read timing cache from: pytorch-yolox-object-detector/2024-02-17_11-08-46/trt_engine_cache/TensorrtExecutionProvider_cache_sm87.timing. A new timing cache will be generated and written.
2024-09-06 13:40:43.695805375 [W:onnxruntime:Default, tensorrt_execution_provider.h:83 log] [2024-09-06 20:40:43 WARNING] Calibrator is not being used. Users must provide dynamic range for all tensors that are not Int32 or Bool.
CPU times: user 7min 25s, sys: 20.8 s, total: 7min 46s
Wall time: 8min 10s</code></pre>
</section>
<section id="detect-track-and-annotate-objects" class="level3">
<h3 class="anchored" data-anchor-id="detect-track-and-annotate-objects">Detect, Track, and Annotate Objects</h3>
<p>At last, we can initialize our video capture and tracker objects and implement our video processing loop.</p>
<section id="overview" class="level4">
<h4 class="anchored" data-anchor-id="overview">Overview</h4>
<ol type="1">
<li>The following code sets up a video capture system, supporting either a CSI camera or a V4L2 camera based on the <code>use_csi</code> flag.</li>
<li>It creates a <code>FrameDropper</code> object to manage video capture.</li>
<li>The code initializes a <code>BYTETracker</code> for object tracking.</li>
<li>Inside a main processing loop, the system continuously:
<ul>
<li>Captures frames from the video feed</li>
<li>Prepares each frame for inference</li>
<li>Runs the ONNX model to detect objects</li>
<li>Processes the model outputs to generate object proposals</li>
<li>Applies non-max suppression to filter overlapping detections</li>
<li>Updates the tracker with new detections</li>
<li>Matches detections with existing tracks</li>
<li>Annotates the frame with bounding boxes and tracking IDs</li>
<li>Calculates and displays the current FPS</li>
</ul></li>
<li>The code uses OpenCV to create a window and display the annotated frames in real-time.</li>
<li>It implements an exit mechanism, listening for a ‘q’ key press to stop the processing loop.</li>
<li>Finally, the code ensures proper resource cleanup by releasing the video capture and closing all windows when the program terminates.</li>
</ol>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up window title for display</span></span>
<span id="cb29-2">window_title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Camera Feed - Press 'q' to Quit"</span></span>
<span id="cb29-3"></span>
<span id="cb29-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure camera source based on the 'use_csi' flag</span></span>
<span id="cb29-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> use_csi:</span>
<span id="cb29-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use CSI camera with GStreamer pipeline</span></span>
<span id="cb29-7">    src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gstreamer_pipeline(sensor_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sensor_id,</span>
<span id="cb29-8">                       display_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>capture_width,</span>
<span id="cb29-9">                       display_height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>capture_height,</span>
<span id="cb29-10">                       flip_method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>flip_method, </span>
<span id="cb29-11">                       capture_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>capture_width, </span>
<span id="cb29-12">                       capture_height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>capture_height, </span>
<span id="cb29-13">                       framerate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>framerate)</span>
<span id="cb29-14">    cv2_capture <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cv2.VideoCapture(src)</span>
<span id="cb29-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb29-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use V4L2 camera</span></span>
<span id="cb29-17">    cv2_capture <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cv2.VideoCapture(sensor_id, cv2.CAP_V4L2)</span>
<span id="cb29-18">    cv2_capture.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(cv2.CAP_PROP_FRAME_WIDTH, capture_width)</span>
<span id="cb29-19">    cv2_capture.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(cv2.CAP_PROP_FRAME_HEIGHT, capture_height)</span>
<span id="cb29-20">    cv2_capture.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(cv2.CAP_PROP_FPS, framerate)</span>
<span id="cb29-21"></span>
<span id="cb29-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a FrameDropper object to handle video capture</span></span>
<span id="cb29-23">video_capture <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FrameDropper(cv2_capture)</span>
<span id="cb29-24"></span>
<span id="cb29-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the ByteTracker for object tracking</span></span>
<span id="cb29-26">tracker <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BYTETracker(track_thresh<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, track_buffer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, match_thresh<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, frame_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb29-27"></span>
<span id="cb29-28"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb29-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a named window for displaying the video feed</span></span>
<span id="cb29-30">    window_handle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cv2.namedWindow(window_title, cv2.WINDOW_AUTOSIZE)</span>
<span id="cb29-31">    </span>
<span id="cb29-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Main processing loop</span></span>
<span id="cb29-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>:</span>
<span id="cb29-34">        start_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.perf_counter()</span>
<span id="cb29-35">        </span>
<span id="cb29-36">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Capture a frame from the video feed</span></span>
<span id="cb29-37">        ret_val, frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> video_capture.read()</span>
<span id="cb29-38">        </span>
<span id="cb29-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> ret_val:</span>
<span id="cb29-40">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Failed to retrieve frame"</span>)</span>
<span id="cb29-41">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">continue</span></span>
<span id="cb29-42">    </span>
<span id="cb29-43">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare the input image for inference</span></span>
<span id="cb29-44">        rgb_img, input_dims, offsets, min_img_scale, input_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prepare_image_for_inference(frame, test_sz, max_stride)</span>
<span id="cb29-45">        </span>
<span id="cb29-46">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the input image to NumPy format for the model</span></span>
<span id="cb29-47">        input_tensor_np <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(input_img, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float32).transpose((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb29-48">                        </span>
<span id="cb29-49">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run inference using the ONNX session</span></span>
<span id="cb29-50">        outputs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> session.run(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>: input_tensor_np})[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb29-51">    </span>
<span id="cb29-52">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Process the model output to get object proposals</span></span>
<span id="cb29-53">        proposals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> process_outputs(outputs, input_tensor_np.shape[input_dim_slice], bbox_conf_thresh)</span>
<span id="cb29-54">        </span>
<span id="cb29-55">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply non-max suppression to filter overlapping proposals</span></span>
<span id="cb29-56">        proposal_indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nms_sorted_boxes(calc_iou(proposals[:, :<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]), iou_thresh)</span>
<span id="cb29-57">        proposals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> proposals[proposal_indices]</span>
<span id="cb29-58">        </span>
<span id="cb29-59">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract bounding boxes, labels, and probabilities from proposals</span></span>
<span id="cb29-60">        bbox_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (proposals[:,:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>offsets, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>min_img_scale</span>
<span id="cb29-61">        label_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [class_names[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(idx)] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> idx <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> proposals[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]]</span>
<span id="cb29-62">        probs_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> proposals[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span>
<span id="cb29-63"></span>
<span id="cb29-64">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize track IDs for detected objects</span></span>
<span id="cb29-65">        track_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(bbox_list)</span>
<span id="cb29-66"></span>
<span id="cb29-67">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert bounding boxes to top-left bottom-right (tlbr) format</span></span>
<span id="cb29-68">        tlbr_boxes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bbox_list.copy()</span>
<span id="cb29-69">        tlbr_boxes[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> tlbr_boxes[:, :<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb29-70"></span>
<span id="cb29-71">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update tracker with detections</span></span>
<span id="cb29-72">        tracks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tracker.update(</span>
<span id="cb29-73">            output_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.concatenate([tlbr_boxes, probs_list[:, np.newaxis]], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb29-74">            img_info<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rgb_img.size,</span>
<span id="cb29-75">            img_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rgb_img.size)</span>
<span id="cb29-76"></span>
<span id="cb29-77">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tlbr_boxes) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tracks) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb29-78">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Match detections with tracks</span></span>
<span id="cb29-79">            track_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> match_detections_with_tracks(tlbr_boxes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tlbr_boxes, track_ids<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>track_ids, tracks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tracks)</span>
<span id="cb29-80">    </span>
<span id="cb29-81">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter object detections based on tracking results</span></span>
<span id="cb29-82">            bbox_list, label_list, probs_list, track_ids <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>[(bbox, label, prob, track_id) </span>
<span id="cb29-83">                                                                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> bbox, label, prob, track_id </span>
<span id="cb29-84">                                                                <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(bbox_list, label_list, probs_list, track_ids) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> track_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb29-85">            </span>
<span id="cb29-86">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(bbox_list) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb29-87">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Annotate the current frame with bounding boxes and tracking IDs</span></span>
<span id="cb29-88">                annotated_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> draw_bboxes_pil(</span>
<span id="cb29-89">                    image<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>rgb_img, </span>
<span id="cb29-90">                    boxes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bbox_list, </span>
<span id="cb29-91">                    labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>track_id<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>label<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> track_id, label <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(track_ids, label_list)],</span>
<span id="cb29-92">                    probs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>probs_list,</span>
<span id="cb29-93">                    colors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[int_colors[class_names.index(i)] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> label_list],  </span>
<span id="cb29-94">                    font<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>font_file,</span>
<span id="cb29-95">                )</span>
<span id="cb29-96">                annotated_frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cv2.cvtColor(np.array(annotated_img), cv2.COLOR_RGB2BGR)</span>
<span id="cb29-97">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb29-98">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If no detections, use the original frame</span></span>
<span id="cb29-99">            annotated_frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> frame</span>
<span id="cb29-100">    </span>
<span id="cb29-101">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate and display FPS</span></span>
<span id="cb29-102">        end_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.perf_counter()</span>
<span id="cb29-103">        processing_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> end_time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_time</span>
<span id="cb29-104">        fps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> processing_time</span>
<span id="cb29-105">    </span>
<span id="cb29-106">        fps_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"FPS: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb29-107">        cv2.putText(annotated_frame, fps_text, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb29-108">        </span>
<span id="cb29-109">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the annotated frame</span></span>
<span id="cb29-110">        cv2.imshow(window_title, annotated_frame)</span>
<span id="cb29-111">        </span>
<span id="cb29-112">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for 'q' key press to exit the loop</span></span>
<span id="cb29-113">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> cv2.waitKey(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> <span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0xFF</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ord</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'q'</span>):</span>
<span id="cb29-114">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb29-115"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">finally</span>:</span>
<span id="cb29-116">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clean up resources</span></span>
<span id="cb29-117">    video_capture.release()</span>
<span id="cb29-118">    cv2.destroyAllWindows()</span></code></pre></div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" aria-controls="tabset-2-1" aria-selected="true">CSI</a></li><li class="nav-item"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" aria-controls="tabset-2-2" aria-selected="false">USB</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" aria-labelledby="tabset-2-1-tab">
<pre class="text"><code>[ WARN:0@9.753] global cap_gstreamer.cpp:1777 open OpenCV | GStreamer warning: Cannot query video position: status=0, value=-1, duration=-1
Gtk-Message: 16:34:59.286: Failed to load module "canberra-gtk-module"
[0;93m2024-09-05 16:34:59.358765333 [W:onnxruntime:Default, tensorrt_execution_provider.h:83 log] [2024-09-05 23:34:59 WARNING] Using an engine plan file across different models of devices is not recommended and is likely to affect performance or even cause errors.[m


GST_ARGUS: Creating output stream
CONSUMER: Waiting until producer is connected...
GST_ARGUS: Available Sensor modes :
GST_ARGUS: 3280 x 2464 FR = 21.000000 fps Duration = 47619048 ; Analog Gain range min 1.000000, max 10.625000; Exposure Range min 13000, max 683709000;

GST_ARGUS: 3280 x 1848 FR = 28.000001 fps Duration = 35714284 ; Analog Gain range min 1.000000, max 10.625000; Exposure Range min 13000, max 683709000;

GST_ARGUS: 1920 x 1080 FR = 29.999999 fps Duration = 33333334 ; Analog Gain range min 1.000000, max 10.625000; Exposure Range min 13000, max 683709000;

GST_ARGUS: 1640 x 1232 FR = 29.999999 fps Duration = 33333334 ; Analog Gain range min 1.000000, max 10.625000; Exposure Range min 13000, max 683709000;

GST_ARGUS: 1280 x 720 FR = 59.999999 fps Duration = 16666667 ; Analog Gain range min 1.000000, max 10.625000; Exposure Range min 13000, max 683709000;

GST_ARGUS: Running with following settings:
   Camera index = 0 
   Camera mode  = 4 
   Output Stream W = 1280 H = 720 
   seconds to Run    = 0 
   Frame Rate = 59.999999 
GST_ARGUS: Setup Complete, Starting captures for 0 seconds
GST_ARGUS: Starting repeat capture requests.
CONSUMER: Producer has connected; continuing.</code></pre>
</div>
<div id="tabset-2-2" class="tab-pane" aria-labelledby="tabset-2-2-tab">
<pre class="text"><code>Gtk-Message: 14:40:32.594: Failed to load module "canberra-gtk-module"
2024-09-05 14:40:33.129041923 [W:onnxruntime:Default, tensorrt_execution_provider.h:83 log] [2024-09-05 21:40:33 WARNING] Using an engine plan file across different models of devices is not recommended and is likely to affect performance or even cause errors.</code></pre>
</div>
</div>
</div>
<p>A new window should pop up displaying the camera feed.</p>
</section>
</section>
<section id="comparing-performance" class="level3">
<h3 class="anchored" data-anchor-id="comparing-performance">Comparing Performance</h3>
<p>As mentioned earlier, a CSI Camera is preferable due to the improved framerate and latency. We can see in the following screenshots just how significant the performance gap can be.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs"><li class="nav-item"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" aria-controls="tabset-3-1" aria-selected="true">CSI (≈24fps)</a></li><li class="nav-item"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" aria-controls="tabset-3-2" aria-selected="false">USB (≈11fps)</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" aria-labelledby="tabset-3-1-tab">
<p><img src="https://christianjmills.com/posts/pytorch-train-object-detector-yolox-tutorial/jetson-object-tracking/images/csi-imx-219-sample.png" class="img-fluid"></p>
</div>
<div id="tabset-3-2" class="tab-pane" aria-labelledby="tabset-3-2-tab">
<p><img src="https://christianjmills.com/posts/pytorch-train-object-detector-yolox-tutorial/jetson-object-tracking/images/logitech-webcam-sample.png" class="img-fluid"></p>
</div>
</div>
</div>
<p>The USB camera also introduces a slight but noticeable delay in the camera input.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Congratulations on reaching the end of this tutorial. You’ve successfully learned to deploy a YOLOX object detection model on an NVIDIA Jetson Orin Nano for real-time object tracking from a camera feed. This tutorial covered several aspects:</p>
<ol type="1">
<li>Setting up a Python environment on the Jetson Orin Nano with the necessary dependencies</li>
<li>Loading and preparing a pre-trained YOLOX model for inference</li>
<li>Configuring ONNX Runtime with the TensorRT execution provider for optimized inference</li>
<li>Implementing frame capture and processing</li>
<li>Integrating the ByteTrack algorithm for object tracking</li>
<li>Creating a real-time video processing pipeline that detects, tracks, and annotates objects</li>
</ol>
<p>This project provides a foundation for numerous real-world applications.</p>
<p>Some potential next steps to consider:</p>
<ol type="1">
<li>Experiment with different model architectures or custom-trained models for other use cases</li>
<li>Implement additional features like object counting or trajectory analysis</li>
<li>Explore ways to stream the processed video over a network for remote monitoring</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled" title="Questions:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Questions:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Feel free to post questions or problems related to this tutorial in the comments below. I try to make time to address them on Thursdays and Fridays.</li>
</ul>
</div>
</div>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>onnx</category>
  <category>cuda</category>
  <category>tensorrt</category>
  <category>object-detection</category>
  <category>object-tracking</category>
  <category>yolox</category>
  <category>tutorial</category>
  <category>jetson</category>
  <guid>https://christianjmills.com/posts/pytorch-train-object-detector-yolox-tutorial/jetson-object-tracking/</guid>
  <pubDate>Fri, 06 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Notes on Atomic Awakening: A New Look at the History and Future of Nuclear Power</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/atomic-awakening-book-notes/</link>
  <description><![CDATA[ 




<ul>
<li>Author’s Note</li>
<li>Introduction</li>
<li>Part 1: The Fantasy</li>
<li>Part 2: The Puzzle<br>
</li>
<li>Part 3: The Paradox<br>
</li>
<li>Epilogue: The Radioactive Park</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Book Links">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Book Links
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://www.simonandschuster.com/books/Atomic-Awakening/James-Mahaffey/9781605982038">Publisher Page</a></li>
</ul>
</div>
</div>
<section id="authors-note" class="level2">
<h2 class="anchored" data-anchor-id="authors-note">Author’s Note</h2>
<section id="an-inside-joke" class="level3">
<h3 class="anchored" data-anchor-id="an-inside-joke">An Inside Joke</h3>
<ul>
<li><strong>The term “atomic,”</strong> while outdated in the context of nuclear technology, persists due to its historical charm and literary origins.</li>
<li><strong>Frederick Soddy’s 1909 book, “Interpretation of Radium,”</strong> detailed the discovery of energetic rays emitted during the disintegration of radium.
<ul>
<li>Soddy and Rutherford confirmed the existence of these rays.</li>
<li>Marie Curie, the discoverer of radium, named this energy “radiation.”</li>
<li>Rutherford jokingly suggested the possibility of triggering a chain reaction of disintegration in a radioactive metal, causing a massive explosion.</li>
<li>Soddy dismissed the idea as fantasy.</li>
</ul></li>
<li><strong>H.G. Wells’ 1914 novel, “The World Set Free,”</strong> was inspired by Soddy’s book.
<ul>
<li>Wells, a renowned science fiction author known for works like “The Time Machine” and “The War of the Worlds,” envisioned a future world war involving powerful bombs.</li>
<li>These bombs, dubbed <strong>“atomic bombs,”</strong> utilized radioactive decay as their explosive mechanism and could destroy entire cities.</li>
</ul></li>
<li><strong>Wells’ description of the atomic bomb’s technology was fictional and nonsensical:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“Those used by the Allies were lumps of pure carolinum, painted on the outside with unoxidized sidenator-inducive enclosed hermetically in a case of membranium, A little celluloid stud between the handles by which the bomb was lifted was arranged so as to be easily torn off and admit air to the inducive, which at once became active and set up radioactivity in the outer layer of the Carolinum sphere. This liberated fresh inducive, and in a few minutes the whole bomb was a blazing continual explosive.”</p>
</blockquote></li>
</ul></li>
<li><strong>Despite the inaccurate science, the book gained popularity among some technologists and nuclear scientists.</strong>
<ul>
<li>Wells accurately predicted that artificially induced radioactivity would be achieved by 1933.</li>
</ul></li>
<li><strong>Leo Szilard, a Hungarian physicist, read Wells’ book in 1932 and was inspired to explore nuclear chain reactions.</strong>
<ul>
<li>He solved the problem of self-sustained nuclear fission in 1933 and filed a patent for the nuclear reactor in 1934.</li>
</ul></li>
<li><strong>By World War II, the term “atomic” had become scientifically outdated.</strong>
<ul>
<li>Rutherford’s discovery of the nucleus in 1911 revealed that radiation originated from nuclear decay, not atomic processes.</li>
<li><strong>Atomic processes,</strong> such as chemical reactions, involve the electron clouds surrounding the nucleus, while <strong>nuclear binding forces</strong> are the source of radiation and a far greater energy source.</li>
</ul></li>
<li><strong>During the secretive wartime nuclear research, descriptive terms were avoided in favor of code names.</strong>
<ul>
<li>The test bomb in New Mexico was called “the Gadget.”</li>
<li>The Hiroshima bomb was “Little Boy,” and the Nagasaki bomb was “Fat Man.”</li>
</ul></li>
<li><strong>The term “Atomic Bomb” was adopted for the wartime nuclear weapons as a nod to H.G. Wells’ fictional creation, becoming an inside joke.</strong></li>
<li><strong>After the war, the term “atomic bomb” entered the public domain, popularized by the revelation of the Manhattan Project.</strong></li>
<li><strong>The United States Congress established the Atomic Energy Commission (AEC) in 1946, officially adopting the outdated term.</strong>
<ul>
<li>The AEC was replaced by the United States Nuclear Regulatory Commission in 1974.</li>
</ul></li>
<li><strong>The term “atomic” persists in the names of several international organizations:</strong>
<ul>
<li>Japanese Atomic Energy Commission</li>
<li>Pakistan Atomic Energy Commission</li>
<li>Atomic Energy Commission of India</li>
<li>Commissariat à l’énergie atomique of France</li>
</ul></li>
</ul>
</section>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<section id="the-paradox-inside-a-puzzle-inside-a-fantasy" class="level3">
<h3 class="anchored" data-anchor-id="the-paradox-inside-a-puzzle-inside-a-fantasy">The Paradox Inside a Puzzle, Inside a Fantasy</h3>
<ul>
<li><strong>Purpose of the book:</strong> Not to promote nuclear power, but to provide a clear history and understanding of its development and inevitability.</li>
<li><strong>Early perceptions of nuclear energy:</strong>
<ul>
<li>Sparked by a perceived energy crisis in 1939.</li>
<li>Douglas W. F. Meyer’s article “Energy from Matter” in <em>Discovery</em> magazine highlighted the potential of atomic power while acknowledging its limitations and dangers.</li>
</ul></li>
<li><strong>World War II and the Atomic Bomb:</strong>
<ul>
<li>Research on atomic energy shifted to military applications during World War II.</li>
<li>Public discussion of atomic energy ceased, replaced by a veil of secrecy.</li>
<li>The atomic bombings of Hiroshima and Nagasaki in August 1945 introduced the public to the destructive power of nuclear energy.</li>
<li>The subsequent publication of “Atomic Energy for Military Purposes” by Henry DeWolf Smith reignited public interest in the potential of nuclear energy for peaceful purposes.</li>
</ul></li>
<li><strong>Post-War Optimism and the Nuclear Paradox:</strong>
<ul>
<li>The post-war era saw widespread optimism about the potential of nuclear power to provide clean, abundant, and inexpensive energy.</li>
<li>Louis L. Strauss, chairman of the Atomic Energy Commission (AEC), famously predicted “electrical energy too cheap to meter.”</li>
<li>However, this optimism was tempered by the inherent dangers associated with nuclear technology, exemplified by the destructive power of the atomic bomb.</li>
<li><strong>The nuclear paradox:</strong> The promise of a clean and abundant energy source juxtaposed with the potential for catastrophic destruction and long-term health risks.</li>
</ul></li>
</ul>
</section>
<section id="the-challenges-of-nuclear-power-development" class="level3">
<h3 class="anchored" data-anchor-id="the-challenges-of-nuclear-power-development">The Challenges of Nuclear Power Development</h3>
<ul>
<li><strong>Public Perception and Fear:</strong>
<ul>
<li>The association of nuclear power with nuclear weapons created a significant public relations challenge.</li>
<li>The development of increasingly powerful nuclear weapons, along with Cold War anxieties, fueled public fear and skepticism.</li>
<li>Government efforts to educate the public about the safety of nuclear power were often met with distrust.</li>
</ul></li>
<li><strong>The AEC’s Conflicting Roles:</strong>
<ul>
<li>The AEC was tasked with promoting civilian nuclear power while simultaneously managing the nuclear arsenal and downplaying potential risks.</li>
<li>This led to a lack of transparency and eroded public trust.</li>
</ul></li>
<li><strong>Economic Realities:</strong>
<ul>
<li>The high upfront capital costs of building nuclear power plants proved to be a major obstacle to expansion.</li>
<li>Nuclear power was ultimately more expensive than traditional fossil fuels, despite lower fuel costs.</li>
<li><strong>Economic factors, not public fear, were the primary reason for the halt in nuclear power expansion in the 1970s.</strong></li>
</ul></li>
</ul>
</section>
<section id="the-decline-of-nuclear-power-in-the-united-states" class="level3">
<h3 class="anchored" data-anchor-id="the-decline-of-nuclear-power-in-the-united-states">The Decline of Nuclear Power in the United States</h3>
<ul>
<li><strong>The Three Mile Island Accident (1979):</strong>
<ul>
<li>A partial meltdown at the Three Mile Island Unit 2 reactor in Pennsylvania further damaged public confidence in nuclear power.</li>
<li>While not a catastrophic event, it highlighted the potential for accidents and the challenges of managing nuclear technology.</li>
<li><strong>The accident was a symptom of the decline, not the cause.</strong></li>
</ul></li>
<li><strong>Chernobyl Disaster (1986):</strong>
<ul>
<li>The Chernobyl disaster in the Soviet Union, a catastrophic nuclear accident, solidified public anxieties about nuclear power safety.</li>
<li>The accident had a limited impact on the US nuclear industry, which was already in decline.</li>
</ul></li>
<li><strong>Nuclear Power in a Coma:</strong>
<ul>
<li>Following the economic challenges and public backlash, nuclear power expansion in the United States stalled.</li>
<li>New plant construction ceased, research and development slowed, and the nuclear industry entered a period of stagnation.</li>
</ul></li>
</ul>
</section>
<section id="the-inevitable-revival-of-nuclear-power" class="level3">
<h3 class="anchored" data-anchor-id="the-inevitable-revival-of-nuclear-power">The Inevitable Revival of Nuclear Power</h3>
<ul>
<li><strong>Changing Energy Landscape:</strong>
<ul>
<li>The continued reliance on fossil fuels has led to increasing concerns about climate change, air pollution, and energy security.</li>
<li>The need for clean and sustainable energy sources has become increasingly urgent.</li>
</ul></li>
<li><strong>Nuclear Power as a Necessity:</strong>
<ul>
<li>Nuclear power is now recognized as a crucial component of a diversified energy portfolio.</li>
<li>Its ability to provide reliable, baseload power without greenhouse gas emissions makes it an essential part of the transition to a sustainable energy future.</li>
</ul></li>
<li><strong>The Nuclear Awakening:</strong>
<ul>
<li>Driven by environmental concerns, energy security needs, and technological advancements, the nuclear power industry is experiencing a resurgence.</li>
<li>New reactor designs, improved safety features, and a renewed focus on public education are paving the way for a nuclear renaissance.</li>
</ul></li>
</ul>
</section>
<section id="the-need-for-informed-public-discourse" class="level3">
<h3 class="anchored" data-anchor-id="the-need-for-informed-public-discourse">The Need for Informed Public Discourse</h3>
<ul>
<li><strong>Lack of Public Education:</strong>
<ul>
<li>Decades of stagnation in the nuclear industry have resulted in a decline in public understanding of nuclear technology.</li>
<li>This lack of knowledge contributes to misconceptions and fear surrounding nuclear power.</li>
</ul></li>
<li><strong>The Role of This Book:</strong>
<ul>
<li>This book aims to provide a comprehensive and objective history of nuclear power, addressing both its benefits and challenges.</li>
<li>It seeks to foster informed public discourse and promote a more nuanced understanding of this complex and vital technology.</li>
</ul></li>
</ul>
</section>
<section id="the-importance-of-scientific-curiosity-and-openness" class="level3">
<h3 class="anchored" data-anchor-id="the-importance-of-scientific-curiosity-and-openness">The Importance of Scientific Curiosity and Openness</h3>
<ul>
<li><strong>The Role of Skepticism and Openness in Scientific Discovery:</strong>
<ul>
<li>Scientific progress requires both rigorous skepticism and a willingness to consider new ideas, even those that challenge established paradigms.</li>
<li>The discovery of radioactivity, a phenomenon initially considered “supernatural,” revolutionized physics and paved the way for the development of nuclear technology.</li>
</ul></li>
<li><strong>Examples of Scientific Visionaries:</strong>
<ul>
<li>Isaac Newton, despite his groundbreaking contributions to physics, also explored spiritualism and the occult.</li>
<li>Albert Einstein, renowned for his theories of relativity, dedicated his later years to the pursuit of a unified field theory, a highly abstract and speculative endeavor.</li>
</ul></li>
<li><strong>The Power of Imagination in Science:</strong>
<ul>
<li>A willingness to entertain “impossible” ideas and challenge conventional wisdom is essential for scientific breakthroughs.</li>
<li>The development of nuclear power, from a theoretical fantasy to a practical reality, exemplifies the power of human imagination and scientific inquiry.</li>
</ul></li>
</ul>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<ul>
<li>The paradox of nuclear power – its immense potential for both good and harm – remains a central challenge.</li>
<li>Understanding the history, the science, and the complexities of nuclear technology is crucial for making informed decisions about its role in our future.</li>
<li>This book aims to provide the reader with the knowledge and context necessary to navigate this complex and vital issue, as nuclear power awakens from its decades-long coma and becomes an increasingly important part of the global energy landscape.</li>
</ul>
</section>
</section>
<section id="part-1-the-fantasy" class="level2">
<h2 class="anchored" data-anchor-id="part-1-the-fantasy">Part 1: The Fantasy</h2>
<section id="the-oklo-natural-nuclear-reactors" class="level3">
<h3 class="anchored" data-anchor-id="the-oklo-natural-nuclear-reactors">The Oklo Natural Nuclear Reactors</h3>
<section id="discovery-of-the-uranium-discrepancy" class="level4">
<h4 class="anchored" data-anchor-id="discovery-of-the-uranium-discrepancy">Discovery of the Uranium Discrepancy</h4>
<ul>
<li>In France, <strong>uranium tetrafluoride (yellow cake)</strong> is processed and enriched for use in nuclear power plants.</li>
<li><strong>Eurodif</strong>, a subsidiary of Kojima, operates a large <strong>gaseous diffusion plant</strong> to enrich uranium.</li>
<li>The plant enriches uranium from 0.7202% <strong>U-235</strong> (the fissile isotope) to 20.0% U-235.</li>
<li>In May 1972, an alarm was triggered at the Pierre-Lotte facility due to a <strong>U-235 deficit</strong> in a batch of uranium hexafluoride.</li>
<li>The U-235 concentration was only 0.7171%, significantly lower than the expected 0.7202%.</li>
<li>An investigation by the <strong>Commissariat à l’énergie atomique (CEA)</strong> traced the deficit back to the <strong>Oklo mine in Gabon, Africa</strong>.</li>
<li>Some Oklo samples showed U-235 deficits as high as 0.44%.</li>
</ul>
</section>
<section id="explanation-natural-nuclear-fission" class="level4">
<h4 class="anchored" data-anchor-id="explanation-natural-nuclear-fission">Explanation: Natural Nuclear Fission</h4>
<ul>
<li><strong>Francis Perrin</strong>, a French physicist, was tasked with investigating the missing U-235.</li>
<li><strong>All uranium on Earth is the same age</strong> and originates from the supernova explosion of a star billions of years ago.</li>
<li>Uranium is <strong>unstable</strong> and decays into thorium and eventually lead over millions of years.</li>
<li><strong>U-235 decays faster than U-238</strong>, leading to a gradual decrease in the concentration of U-235 over time.</li>
<li>The expected U-235 concentration in 1972 should have been precisely 0.7202% in all uranium mines.</li>
<li>The investigation ruled out theft or processing errors as the cause of the deficit.</li>
<li>The only explanation for the missing U-235 was that it had undergone <strong>nuclear fission</strong> in a natural reactor.</li>
<li>Analysis of the Oklo samples confirmed the presence of <strong>stable fission products</strong> trapped in the rock formations.</li>
</ul>
</section>
<section id="the-oklo-reactors-natures-nuclear-power-plants" class="level4">
<h4 class="anchored" data-anchor-id="the-oklo-reactors-natures-nuclear-power-plants">The Oklo Reactors: Nature’s Nuclear Power Plants</h4>
<ul>
<li><strong>16 natural nuclear reactors</strong> were discovered at three locations within the Oklo mines.</li>
<li>The CEA announced the discovery of self-sustaining nuclear chain reactions at Oklo on <strong>September 25, 1972</strong>.</li>
<li>The reactors operated about <strong>1.5 billion years ago</strong>.</li>
<li>At that time, the natural uranium at Oklo had a U-235 concentration of <strong>3%</strong>, similar to the enriched uranium used in some modern reactors.</li>
<li><strong>Groundwater</strong> leaking into the uranium deposit acted as a <strong>moderator</strong>, slowing down neutrons and initiating the chain reaction.</li>
<li>The reactors operated in <strong>pulse mode</strong>:
<ul>
<li>Water heated up and boiled away, shutting down the reaction.</li>
<li>The reactors cooled down, allowing water to seep back in and restart the cycle.</li>
</ul></li>
<li>The operating interval was approximately <strong>two hours and thirty minutes</strong>.</li>
<li>The reactors operated for a few hundred thousand years.</li>
<li>They produced heat at a rate of <strong>100 kilowatts</strong>, generated <strong>11,907 pounds of radioactive waste</strong>, and <strong>3,307 pounds of plutonium</strong>.</li>
</ul>
</section>
<section id="oklo-and-nuclear-waste-management" class="level4">
<h4 class="anchored" data-anchor-id="oklo-and-nuclear-waste-management">Oklo and Nuclear Waste Management</h4>
<ul>
<li>The <strong>sandstone shale</strong> structure of the Oklo mines is not considered ideal for long-term nuclear waste storage.</li>
<li>However, the radioactive waste from the Oklo reactors <strong>migrated only a few centimeters in 1.5 billion years</strong>.</li>
<li><strong>No evidence of groundwater contamination or biological harm</strong> was found.</li>
<li>The Oklo reactors demonstrated that nature can effectively contain radioactive waste for extended periods.</li>
</ul>
</section>
<section id="lessons-from-oklo" class="level4">
<h4 class="anchored" data-anchor-id="lessons-from-oklo">Lessons from Oklo</h4>
<ul>
<li>The Oklo reactors provided several insights:
<ul>
<li><strong>Clay can be used to stabilize radioactive waste</strong>.</li>
<li><strong>Designing a nuclear reactor is not as complex as some might suggest</strong>.</li>
<li><strong>The first self-sustaining nuclear chain reaction occurred naturally at Oklo, long before the Chicago Pile-1 experiment in 1942</strong>.</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-origins-of-energy-from-fusion-to-fission" class="level3">
<h3 class="anchored" data-anchor-id="the-origins-of-energy-from-fusion-to-fission">The Origins of Energy: From Fusion to Fission</h3>
<section id="solar-energy-the-foundation-of-most-energy-sources" class="level4">
<h4 class="anchored" data-anchor-id="solar-energy-the-foundation-of-most-energy-sources">Solar Energy: The Foundation of Most Energy Sources</h4>
<ul>
<li>The Oklo reactors were not the first instance of nuclear power; <strong>all energy on Earth ultimately originates from nuclear reactions</strong>, primarily in the Sun.</li>
<li>The Sun is a <strong>fusion reactor</strong> that converts hydrogen into heavier elements, releasing energy in the process.</li>
<li><strong>Solar energy</strong> drives various processes on Earth:
<ul>
<li><strong>Direct sunlight</strong></li>
<li><strong>Wind power</strong> (caused by solar heating of the atmosphere)</li>
<li><strong>Hydropower</strong> (driven by the water cycle, powered by solar evaporation)</li>
<li><strong>Fossil fuels</strong> (coal and petroleum, formed from ancient biological material that utilized solar energy through photosynthesis)</li>
<li><strong>Biomass energy</strong> (wood, biofuels)</li>
</ul></li>
</ul>
</section>
<section id="fission-energy-stored-supernova-energy" class="level4">
<h4 class="anchored" data-anchor-id="fission-energy-stored-supernova-energy">Fission Energy: Stored Supernova Energy</h4>
<ul>
<li><strong>Fission power from U-235 is also indirectly solar</strong>, but it originates from a different star’s supernova explosion, not our Sun.</li>
<li><strong>Uranium stores significantly more energy than fossil fuels</strong>.</li>
<li><strong>Supernovae create heavy elements like uranium through intense fusion reactions</strong>.</li>
<li><strong>Fission releases energy</strong> when heavy elements split into lighter ones, converting mass into energy.</li>
</ul>
</section>
<section id="earths-natural-nuclear-history" class="level4">
<h4 class="anchored" data-anchor-id="earths-natural-nuclear-history">Earth’s Natural Nuclear History</h4>
<ul>
<li>The Oklo discovery revealed that Earth has experienced both <strong>fusion (in the Sun) and fission (at Oklo)</strong> as natural sources of energy production and conversion.</li>
<li>This understanding of energy’s origins was not developed until the late 19th century.</li>
</ul>
</section>
</section>
<section id="chapter-1-invisible-demons" class="level3">
<h3 class="anchored" data-anchor-id="chapter-1-invisible-demons">Chapter 1: Invisible Demons</h3>
<section id="the-need-for-a-new-power-source" class="level4">
<h4 class="anchored" data-anchor-id="the-need-for-a-new-power-source">The Need for a New Power Source</h4>
<ul>
<li><strong>The Machine Age (1890s):</strong> Diesel and gasoline engines, electrical lighting, and mature steam technology were prevalent.
<ul>
<li>Most components needed for nuclear power plants already existed, except the power source itself.</li>
</ul></li>
<li><strong>Relocatable Power:</strong> Industry had shifted from location-dependent power (water wheels, windmills) to burnable fuels.
<ul>
<li>This allowed industries to be built anywhere, with fuel transported to them.</li>
<li><strong>Drawbacks:</strong> Carbon dioxide and soot emissions caused pollution, particularly in major cities.</li>
</ul></li>
<li><strong>Search for a New Power Source:</strong> The need for a compact, non-combusting energy source became apparent.
<ul>
<li>This required significant scientific advancements, research, and serendipity.</li>
<li>Understanding the structure of matter at a fundamental level was crucial.</li>
</ul></li>
</ul>
</section>
<section id="early-theories-of-matter" class="level4">
<h4 class="anchored" data-anchor-id="early-theories-of-matter">Early Theories of Matter</h4>
<ul>
<li><strong>Ancient Theories:</strong>
<ul>
<li><strong>Four Elements Theory:</strong> The belief that everything is composed of earth, air, fire, and water.
<ul>
<li>Examples: Mud (earth and water), bricks (heated mud, water driven off), steam (water and air heated by fire).</li>
</ul></li>
<li><strong>Atomic Theory in India (550 BCE):</strong> Nyaya and Vaisheshika schools described elementary particles combining in pairs and trios to form complex materials.</li>
<li><strong>Greek Atomic Theory (430 BCE):</strong> Leucippus and Democritus proposed that matter is made of indivisible particles called <strong>atoms</strong> (“uncuttable”).
<ul>
<li>These theories lacked experimental evidence and were considered philosophical.</li>
</ul></li>
</ul></li>
<li><strong>Practical Chemistry:</strong>
<ul>
<li>Ancient industries (soap making, tool production) required empirical knowledge of chemical combinations and metal alloys.</li>
<li>Limitations of the four-element theory became evident due to the lack of a systematic method of analysis.</li>
</ul></li>
<li><strong>Alchemy (Spagyric Art):</strong>
<ul>
<li>A 2,500-year-old practice focused on transmuting base metals into gold.</li>
<li><strong>Three Elements:</strong> Alchemists believed in three elements: salt, sulfur, and mercury.</li>
<li><strong>Contributions:</strong> Advanced distillation techniques, discovery of acids and bases.</li>
<li><strong>Influence:</strong> Despite its mystical nature, alchemy contributed to the development of chemistry and metallurgy.</li>
</ul></li>
</ul>
</section>
<section id="the-rise-of-modern-chemistry" class="level4">
<h4 class="anchored" data-anchor-id="the-rise-of-modern-chemistry">The Rise of Modern Chemistry</h4>
<section id="robert-boyle-1627-1691" class="level5">
<h5 class="anchored" data-anchor-id="robert-boyle-1627-1691">Robert Boyle (1627-1691)</h5>
<ul>
<li><strong>Background:</strong> Born into wealth in Ireland, received a comprehensive education.</li>
<li><strong>Scientific Contributions:</strong>
<ul>
<li><strong>Boyle’s Law of Gases:</strong> Explored the relationship between gas pressure and volume using a self-devised air compressor.</li>
<li><strong>“The Skeptical Chemist” (1661):</strong> Critiqued alchemy and advocated for a scientific approach to chemistry.
<ul>
<li>Distinguished between chemical compounds and mixtures.</li>
<li>Reintroduced the concept of matter being composed of fundamental substances (collections of atoms).</li>
</ul></li>
</ul></li>
<li><strong>Impact:</strong> Shifted science towards a new direction, emphasizing knowledge advancement over the pursuit of wealth.</li>
</ul>
</section>
<section id="antoine-lavoisier-1743-1794" class="level5">
<h5 class="anchored" data-anchor-id="antoine-lavoisier-1743-1794">Antoine Lavoisier (1743-1794)</h5>
<ul>
<li><strong>Background:</strong> Wealthy Parisian, pursued chemistry research independently.</li>
<li><strong>Scientific Contributions:</strong>
<ul>
<li>Introduced the metric system.</li>
<li><strong>Law of Conservation of Mass:</strong> Matter cannot be created or destroyed, only transformed.</li>
<li>Defined <strong>elements</strong> (e.g., oxygen, hydrogen) as substances that cannot be chemically broken down further.</li>
<li>Compiled the first table of elements.</li>
</ul></li>
<li><strong>Impact:</strong> Established fundamental principles of chemistry.</li>
</ul>
</section>
<section id="john-dalton-1766-1844" class="level5">
<h5 class="anchored" data-anchor-id="john-dalton-1766-1844">John Dalton (1766-1844)</h5>
<ul>
<li><strong>Background:</strong> Quaker, self-educated scientist, worked as a tutor.</li>
<li><strong>Scientific Contributions:</strong>
<ul>
<li>Researched colorblindness, weather phenomena, and light.</li>
<li><strong>“New System of Chemical Philosophy” (1808):</strong> Proposed <strong>Dalton’s Atomic Theory:</strong>
<ul>
<li>Elements are made of atoms.</li>
<li>Atoms of the same element are identical.</li>
<li>Atoms of different elements are different.</li>
<li>Atoms combine to form compounds.</li>
<li>Atoms cannot be created, destroyed, or broken down by chemical reactions.</li>
</ul></li>
</ul></li>
<li><strong>Impact:</strong> Solidified the atomic theory and influenced chemistry for centuries.</li>
</ul>
</section>
</section>
<section id="brownian-motion-and-the-electromagnetic-revolution" class="level4">
<h4 class="anchored" data-anchor-id="brownian-motion-and-the-electromagnetic-revolution">Brownian Motion and the Electromagnetic Revolution</h4>
<section id="robert-brown-1773-1858" class="level5">
<h5 class="anchored" data-anchor-id="robert-brown-1773-1858">Robert Brown (1773-1858)</h5>
<ul>
<li><strong>Background:</strong> Scottish botanist, explored Australian flora.</li>
<li><strong>Discovery of Brownian Motion (1827):</strong> Observed the random, jittery movement of tiny particles (pollen, dust) in water under a microscope.</li>
<li><strong>Impact:</strong> While Brown couldn’t explain the cause, <strong>Brownian motion</strong> would later be used to understand the movement of subatomic particles.</li>
</ul>
</section>
<section id="michael-faraday-1791-1867" class="level5">
<h5 class="anchored" data-anchor-id="michael-faraday-1791-1867">Michael Faraday (1791-1867)</h5>
<ul>
<li><strong>Background:</strong> Self-educated chemist and physicist from humble beginnings.</li>
<li><strong>Scientific Contributions:</strong>
<ul>
<li>Pioneered nanoscience, discovered benzene, liquefied chlorine.</li>
<li><strong>Electromagnetism:</strong>
<ul>
<li>Discovered <strong>electromagnetic induction:</strong> A changing magnetic field induces an electric current in a nearby wire.</li>
<li>Showed that an electric current produces a magnetic field.</li>
<li>Demonstrated <strong>magnetic induction:</strong> A current in one coil can induce a current in a nearby coil.</li>
<li>Invented the electric generator and transformer.</li>
<li>Proposed the existence of <strong>electromagnetic fields</strong> extending into space.</li>
</ul></li>
</ul></li>
<li><strong>Impact:</strong> Revolutionized the understanding of electricity and magnetism, laying the groundwork for future technologies.</li>
</ul>
</section>
<section id="james-clerk-maxwell-1831-1879" class="level5">
<h5 class="anchored" data-anchor-id="james-clerk-maxwell-1831-1879">James Clerk Maxwell (1831-1879)</h5>
<ul>
<li><strong>Background:</strong> Scottish physicist and mathematician.</li>
<li><strong>Scientific Contributions:</strong>
<ul>
<li>Researched thermodynamics, color, and photography.</li>
<li><strong>Maxwell’s Equations:</strong>
<ul>
<li>Mathematically formalized Faraday’s observations on electromagnetism.</li>
<li>Predicted the existence of <strong>electromagnetic waves</strong> that travel at the speed of light.</li>
<li>Provided a theoretical explanation for light as an electromagnetic phenomenon.</li>
</ul></li>
<li><strong>“On the Stability of Saturn’s Rings” (1859):</strong> Proposed that Saturn’s rings are composed of loose particles.</li>
</ul></li>
<li><strong>Impact:</strong> His work on electromagnetism profoundly impacted physics and laid the foundation for future advancements in fields like radio and quantum mechanics.</li>
</ul>
</section>
</section>
<section id="hertz-and-the-discovery-of-radio-waves" class="level4">
<h4 class="anchored" data-anchor-id="hertz-and-the-discovery-of-radio-waves">Hertz and the Discovery of Radio Waves</h4>
<section id="heinrich-hertz-1857-1894" class="level5">
<h5 class="anchored" data-anchor-id="heinrich-hertz-1857-1894">Heinrich Hertz (1857-1894)</h5>
<ul>
<li><strong>Background:</strong> German physicist, initially studied languages and engineering before shifting to physics.</li>
<li><strong>Scientific Contributions:</strong>
<ul>
<li><strong>Discovery of the Photoelectric Effect (1887):</strong> Observed that UV light can reduce the intensity of an electric spark.
<ul>
<li>This effect would later be explained by Einstein and lead to technologies like television and digital photography.</li>
</ul></li>
<li><strong>Discovery of Radio Waves (1887):</strong> Using a <strong>Ruhmkorff coil</strong>, Hertz observed that a spark in one circuit could induce a spark in a nearby, unconnected circuit.
<ul>
<li>This demonstrated the existence of <strong>radio waves</strong>, confirming Maxwell’s predictions.</li>
<li>Hertz showed that radio waves could be transmitted, reflected, and polarized, similar to light.</li>
</ul></li>
</ul></li>
<li><strong>Impact:</strong> His discoveries revolutionized communication technology and paved the way for the development of radio, television, and other wireless technologies.</li>
</ul>
</section>
</section>
<section id="röntgen-and-the-discovery-of-x-rays" class="level4">
<h4 class="anchored" data-anchor-id="röntgen-and-the-discovery-of-x-rays">Röntgen and the Discovery of X-Rays</h4>
<section id="wilhelm-conrad-röntgen-1845-1923" class="level5">
<h5 class="anchored" data-anchor-id="wilhelm-conrad-röntgen-1845-1923">Wilhelm Conrad Röntgen (1845-1923)</h5>
<ul>
<li><strong>Background:</strong> German physicist, initially studied mechanical engineering before transitioning to physics.</li>
<li><strong>Discovery of X-Rays (1895):</strong> While experimenting with <strong>cathode ray tubes</strong>, Röntgen noticed that a fluorescent screen glowed even when shielded from the tube.
<ul>
<li>He realized that a new type of ray was being emitted, capable of penetrating through materials.</li>
<li>He called these rays <strong>X-rays</strong> and demonstrated their ability to image bones inside the human body.</li>
</ul></li>
<li><strong>Impact:</strong> Röntgen’s discovery revolutionized medical imaging and opened up new avenues for studying the structure of matter.</li>
</ul>
</section>
</section>
<section id="becquerel-and-the-dawn-of-radioactivity" class="level4">
<h4 class="anchored" data-anchor-id="becquerel-and-the-dawn-of-radioactivity">Becquerel and the Dawn of Radioactivity</h4>
<section id="antoine-henri-becquerel-1852-1908" class="level5">
<h5 class="anchored" data-anchor-id="antoine-henri-becquerel-1852-1908">Antoine-Henri Becquerel (1852-1908)</h5>
<ul>
<li><strong>Background:</strong> French physicist, initially focused on fluorescence.</li>
<li><strong>Discovery of Radioactivity (1896):</strong>
<ul>
<li>Inspired by Röntgen’s work, Becquerel investigated whether fluorescent materials could emit X-rays.</li>
<li>He accidentally discovered that <strong>uranium salts</strong> emitted a penetrating radiation even without exposure to sunlight.</li>
<li>This radiation was not X-rays but a new phenomenon, later named <strong>radioactivity</strong> by Marie Curie.</li>
</ul></li>
<li><strong>Impact:</strong> Becquerel’s discovery marked the beginning of nuclear physics and the exploration of the atom’s nucleus.</li>
</ul>
</section>
</section>
<section id="conclusion-1" class="level4">
<h4 class="anchored" data-anchor-id="conclusion-1">Conclusion</h4>
<ul>
<li>The late 19th century witnessed a rapid advancement in the understanding of matter and energy.</li>
<li>Scientists like Boyle, Lavoisier, and Dalton established the foundations of modern chemistry and the atomic theory.</li>
<li>Discoveries by Brown, Faraday, and Maxwell revolutionized the understanding of electromagnetism and light.</li>
<li>Hertz confirmed the existence of electromagnetic waves, including radio waves.</li>
<li>Röntgen’s discovery of X-rays and Becquerel’s discovery of radioactivity opened up new frontiers in physics and paved the way for the exploration of the atom’s nucleus.</li>
<li>These “invisible demons” - X-rays and radioactivity - would reshape science and technology in the 20th century.</li>
</ul>
</section>
</section>
<section id="chapter-2-a-couple-of-remaining-questions" class="level3">
<h3 class="anchored" data-anchor-id="chapter-2-a-couple-of-remaining-questions">Chapter 2: A Couple of Remaining Questions</h3>
<section id="the-end-of-the-century-and-fantastical-discoveries-1897" class="level4">
<h4 class="anchored" data-anchor-id="the-end-of-the-century-and-fantastical-discoveries-1897">The End of the Century and Fantastical Discoveries (1897)</h4>
<ul>
<li><strong>The late 19th century saw a surge of groundbreaking scientific discoveries</strong>, including the establishment of atomic elements and Henri Becquerel’s discovery of an unusual property in uranium.
<ul>
<li>Becquerel found that <strong>uranium left a ghost image on photographic plates</strong>, similar to the effects sought by spiritualists.</li>
<li>This “ghost” suggested an <strong>unexplained energy or ray emanating from within the uranium atom</strong>.</li>
<li>There was <strong>no clear explanation for Becquerel’s rays</strong> other than it being a unique property of uranium.</li>
</ul></li>
</ul>
</section>
<section id="j.j.-thompson-and-the-nature-of-cathode-rays" class="level4">
<h4 class="anchored" data-anchor-id="j.j.-thompson-and-the-nature-of-cathode-rays">J.J. Thompson and the Nature of Cathode Rays</h4>
<section id="j.j.-thompsons-background-and-career" class="level5">
<h5 class="anchored" data-anchor-id="j.j.-thompsons-background-and-career">J.J. Thompson’s Background and Career</h5>
<ul>
<li><strong>Sir Joseph John J.J. Thompson (born 1856)</strong> was a British physicist at the Cavendish Laboratory in England.</li>
<li>Thompson’s parents encouraged him to pursue engineering.
<ul>
<li>He enrolled in an apprenticeship but, due to a waiting list, <strong>joined Owens College in Manchester at age 14</strong>.</li>
<li>He later <strong>transferred to Trinity College in Cambridge</strong>, graduating with a B.A. in mathematics in 1880 and an M.A.&nbsp;in mathematical physics in 1883.</li>
<li>He became <strong>Cavendish Professor of Physics in 1884</strong> and married Rose Paget in 1890.</li>
</ul></li>
<li><strong>Thompson focused on investigating cathode rays</strong>, a popular area of research involving vacuum tubes and high-voltage coils.
<ul>
<li><strong>Cathode rays were streams of energy observed in vacuum tubes when high voltage was applied across electrodes.</strong></li>
<li>Wilhelm Röntgen had used cathode rays to produce X-rays, but their nature remained a mystery.</li>
</ul></li>
</ul>
</section>
<section id="thompsons-cathode-ray-experiments" class="level5">
<h5 class="anchored" data-anchor-id="thompsons-cathode-ray-experiments">Thompson’s Cathode Ray Experiments</h5>
<ul>
<li>Thompson conducted <strong>three sequential experiments to determine the nature of cathode rays.</strong>
<ul>
<li><strong>Experiment 1:</strong>
<ul>
<li><strong>Purpose:</strong> To determine if the negative charge associated with cathode rays could be separated from the rays themselves.</li>
<li><strong>Setup:</strong> A specialized vacuum tube with a cathode, anode with a slit, and a third electrode at the end.</li>
<li><strong>Procedure:</strong> High voltage was applied, and an electrometer measured current between the first and third electrodes. A magnet was then used to deflect the beam.</li>
<li><strong>Results:</strong>
<ul>
<li>An electrical current flowed, indicating a component of electricity in the rays.</li>
<li>The magnet deflected the beam, causing the current to stop.</li>
</ul></li>
<li><strong>Conclusion:</strong> The <strong>negative charge and the rays were inseparable</strong>, indicating they were a single entity.</li>
</ul></li>
<li><strong>Experiment 2:</strong>
<ul>
<li><strong>Purpose:</strong> To further confirm that cathode rays were streams of electrical charge.</li>
<li><strong>Setup:</strong> A vacuum tube with a hole in the anode to create a thin beam, phosphorescent paint at the end, and two parallel metal plates in the flight path.</li>
<li><strong>Procedure:</strong> High voltage was applied across the deflection plates.</li>
<li><strong>Results:</strong> The beam bent towards the positive plate.</li>
<li><strong>Conclusion:</strong> The deflection confirmed that the <strong>rays were indeed streams of electrical charge.</strong></li>
</ul></li>
<li><strong>Experiment 3:</strong>
<ul>
<li><strong>Purpose:</strong> To confirm the nature of cathode rays using magnetic deflection.</li>
<li><strong>Setup:</strong> Similar to Experiment 2, but with external magnetic coils instead of deflection plates.</li>
<li><strong>Procedure:</strong> A controlled magnetic field was applied across the tube.</li>
<li><strong>Results:</strong> The beam deflected predictably in the magnetic field.</li>
<li><strong>Conclusion:</strong> The results from both electrostatic and magnetic deflection solidified Thompson’s understanding.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="thompsons-conclusions-and-the-plum-pudding-model" class="level5">
<h5 class="anchored" data-anchor-id="thompsons-conclusions-and-the-plum-pudding-model">Thompson’s Conclusions and the Plum-Pudding Model</h5>
<ul>
<li><strong>Thompson concluded that cathode rays are composed of tiny, negatively charged particles he called “corpuscles”.</strong>
<ul>
<li>These particles were later named <strong>electrons</strong>.</li>
</ul></li>
<li>Based on the deflection angles, he calculated the <strong>charge-to-mass ratio</strong> of the corpuscles.
<ul>
<li>He determined that the <strong>mass was negligible</strong>, and the <strong>charge was negative</strong>.</li>
</ul></li>
<li><strong>Thompson proposed the “plum-pudding model” of the atom.</strong>
<ul>
<li>This model depicted the atom as a <strong>large, positively charged sphere with embedded negative corpuscles (electrons).</strong></li>
</ul></li>
<li><strong>Thompson’s discoveries revolutionized physics.</strong>
<ul>
<li>He demonstrated that atoms, previously thought indestructible, could be disassembled.</li>
<li>He won the <strong>Nobel Prize in Physics in 1906</strong>.</li>
</ul></li>
<li>Physics was now able to detect subatomic particles through indirect means.</li>
<li>The study of physics became more organized, standardized, and systematic.</li>
</ul>
</section>
</section>
<section id="marie-curie-and-the-discovery-of-radioactivity" class="level4">
<h4 class="anchored" data-anchor-id="marie-curie-and-the-discovery-of-radioactivity">Marie Curie and the Discovery of Radioactivity</h4>
<section id="marie-curies-background-and-education" class="level5">
<h5 class="anchored" data-anchor-id="marie-curies-background-and-education">Marie Curie’s Background and Education</h5>
<ul>
<li><strong>Maria Skłodowska-Curie (born 1867)</strong> was a Polish physicist and chemist.</li>
<li><strong>Her parents were educators</strong>, fostering her interest in science.</li>
<li><strong>She faced challenges in accessing higher education due to being Polish and female</strong> in Russian-controlled Poland.
<ul>
<li>She enrolled in the <strong>“Floating University,”</strong> an underground educational institution.</li>
</ul></li>
<li><strong>She moved to Paris in 1891, changed her name to Marie, and enrolled at the Sorbonne.</strong>
<ul>
<li>She earned a master’s in physics (1893) and mathematics (1894).</li>
<li>She joined the doctoral program under Henri Becquerel.</li>
</ul></li>
</ul>
</section>
<section id="marie-curies-research-and-collaboration-with-pierre-curie" class="level5">
<h5 class="anchored" data-anchor-id="marie-curies-research-and-collaboration-with-pierre-curie">Marie Curie’s Research and Collaboration with Pierre Curie</h5>
<ul>
<li>Marie secured funding to research the magnetic properties of steel.</li>
<li><strong>She became laboratory chief at the Municipal School of Industrial Physics and Chemistry</strong>, where she met <strong>Pierre Curie</strong>.</li>
<li><strong>Marie and Pierre married in 1895</strong>.</li>
<li>They conducted research in a poorly equipped laboratory, referred to as the “Miserable Shed”.</li>
</ul>
</section>
<section id="marie-curies-investigation-of-becquerel-rays-and-radioactivity" class="level5">
<h5 class="anchored" data-anchor-id="marie-curies-investigation-of-becquerel-rays-and-radioactivity">Marie Curie’s Investigation of Becquerel Rays and Radioactivity</h5>
<ul>
<li>Marie became interested in <strong>Becquerel’s rays</strong> and chose them as her Ph.D.&nbsp;thesis topic.</li>
<li>She used <strong>Pierre’s electrometer</strong> to detect and quantify the rays through air ionization.</li>
<li><strong>She obtained pitchblende, a uranium ore, and conducted experiments.</strong>
<ul>
<li>She confirmed that the rays were constant, regardless of the uranium’s physical or chemical state.</li>
<li><strong>Minerals with higher uranium density emitted more rays.</strong></li>
</ul></li>
<li>Marie hypothesized that the rays originated from the core of the uranium atom, a revolutionary idea at the time.</li>
<li>She began using the term “radiation” and “radioactivity” to describe the phenomenon.</li>
<li><strong>In 1898, she discovered that thorium also emitted radiation</strong>, confirming that radioactivity was an atomic property.</li>
</ul>
</section>
<section id="the-curies-discovery-of-polonium-and-radium" class="level5">
<h5 class="anchored" data-anchor-id="the-curies-discovery-of-polonium-and-radium">The Curies’ Discovery of Polonium and Radium</h5>
<ul>
<li><strong>Pierre joined Marie’s research</strong>, recognizing its importance.</li>
<li><strong>They observed that pitchblende was more radioactive than pure uranium</strong>, suggesting the presence of other radioactive elements.</li>
<li><strong>Through extensive chemical processing of pitchblende, they isolated two new radioactive elements:</strong>
<ul>
<li><strong>Polonium</strong>, named after Marie’s native Poland.</li>
<li><strong>Radium</strong>, named after the term “radiation.”</li>
</ul></li>
<li><strong>They discovered these elements were products of the uranium decay chain.</strong>
<ul>
<li>Uranium and thorium, being the heaviest naturally occurring elements, are unstable and decay into lighter, radioactive elements, eventually ending with non-radioactive lead.</li>
</ul></li>
<li><strong>The Curies refined a small quantity of pure radium metal.</strong>
<ul>
<li><strong>Radium is intensely radioactive and emits a blue glow</strong> due to its interaction with air.</li>
</ul></li>
<li>Marie Curie’s 1903 Ph.D.&nbsp;thesis, “Research on Radioactive Substances,” was a landmark contribution to science.</li>
<li>Marie, Pierre, and Henri Becquerel shared the Nobel Prize in Physics in 1903 for their work on radioactivity.</li>
</ul>
</section>
<section id="the-health-effects-of-radiation-and-the-rise-of-a-radiation-industry" class="level5">
<h5 class="anchored" data-anchor-id="the-health-effects-of-radiation-and-the-rise-of-a-radiation-industry">The Health Effects of Radiation and the Rise of a Radiation Industry</h5>
<ul>
<li><strong>The Curies suffered health effects from constant exposure to radioactive materials.</strong>
<ul>
<li>They experienced burns, swelling, and peeling skin on their hands and fingers.</li>
<li>Pierre was particularly affected and suffered constant pain.</li>
</ul></li>
<li><strong>Despite the obvious health risks, the Curies continued their research.</strong></li>
<li><strong>A radiation industry emerged in the early 1900s, capitalizing on public excitement.</strong>
<ul>
<li>Products like Thoradia (beauty cream) and Doramad (toothpaste) were marketed with claims of health benefits, despite their radioactive content.</li>
</ul></li>
<li>Medical demand for radium for cancer treatment and skin disorders soared.</li>
<li>The Curies gained fame and funding, leading to the establishment of the Radium Institute at the Sorbonne in 1919.</li>
</ul>
</section>
</section>
<section id="ernest-rutherford-and-the-structure-of-the-atom" class="level4">
<h4 class="anchored" data-anchor-id="ernest-rutherford-and-the-structure-of-the-atom">Ernest Rutherford and the Structure of the Atom</h4>
<section id="ernest-rutherfords-background-and-early-research" class="level5">
<h5 class="anchored" data-anchor-id="ernest-rutherfords-background-and-early-research">Ernest Rutherford’s Background and Early Research</h5>
<ul>
<li><strong>Ernest Rutherford (born 1871)</strong> was a New Zealand-born physicist.</li>
<li>He excelled academically and earned scholarships to Nelson College and the University of New Zealand.</li>
<li>He earned an M.A.&nbsp;in mathematics and physical science at age 22.</li>
<li>He became interested in Hertz’s electromagnetic waves and radio transmission.</li>
<li>He received a scholarship to Cambridge and joined the Cavendish Laboratory in 1895, working under J.J. Thompson.</li>
</ul>
</section>
<section id="rutherfords-research-on-radioactivity-and-alpha-and-beta-rays" class="level5">
<h5 class="anchored" data-anchor-id="rutherfords-research-on-radioactivity-and-alpha-and-beta-rays">Rutherford’s Research on Radioactivity and Alpha and Beta Rays</h5>
<ul>
<li>Rutherford shifted his focus to radioactivity after Thompson’s discovery of the electron.</li>
<li><strong>He studied the nature of radiation and identified two distinct types:</strong>
<ul>
<li><strong>Alpha rays:</strong> Short-range radiation, easily stopped by solid objects or air.</li>
<li><strong>Beta rays:</strong> Longer-range radiation with greater penetrating power.</li>
</ul></li>
<li>He became professor of physics at McGill University in Montreal in 1899.</li>
</ul>
</section>
<section id="rutherford-and-soddys-research-on-radioactive-decay-and-transmutation" class="level5">
<h5 class="anchored" data-anchor-id="rutherford-and-soddys-research-on-radioactive-decay-and-transmutation">Rutherford and Soddy’s Research on Radioactive Decay and Transmutation</h5>
<ul>
<li><strong>Rutherford and his colleague Frederick Soddy investigated a gas emanating from thorium.</strong>
<ul>
<li>They found the <strong>gas was chemically inert</strong>, leading them to believe <strong>thorium was transmuting into argon</strong>.</li>
</ul></li>
<li>They studied the radioactivity of various elements using a method of counting flashes on a phosphorescent screen caused by radiation.</li>
<li><strong>They discovered that:</strong>
<ul>
<li>Different elements had different radiation rates.</li>
<li>An element’s radiation rate decreased exponentially over time, a concept Soddy termed <strong>“half-life.”</strong></li>
</ul></li>
<li><strong>They concluded that the gas was a result of thorium atom decay.</strong>
<ul>
<li>Radioactive decay involves an atom emitting radiation and transforming into a lighter element.</li>
<li>The decay product can also be radioactive.</li>
</ul></li>
<li><strong>They found that elements could have chemically identical subtypes with different half-lives, which Soddy termed “isotopes.”</strong>
<ul>
<li>Isotopes can be distinguished by their chemical properties and half-lives.</li>
</ul></li>
</ul>
</section>
<section id="rutherfords-identification-of-beta-rays-and-measurement-of-radioactive-energy" class="level5">
<h5 class="anchored" data-anchor-id="rutherfords-identification-of-beta-rays-and-measurement-of-radioactive-energy">Rutherford’s Identification of Beta Rays and Measurement of Radioactive Energy</h5>
<ul>
<li><strong>Rutherford suspected that beta rays were a natural form of cathode rays (electrons).</strong></li>
<li>He confirmed this by deflecting a beam of beta rays using magnets and electrostatic fields, similar to Thompson’s cathode ray experiments.</li>
<li><strong>In 1903, Rutherford and Soddy published “Radioactive Change,” presenting the first experimental measurements of energy produced by atomic decay.</strong>
<ul>
<li>They found that one gram of radium released an enormous amount of energy (estimated between 100 million and 10 billion calories).</li>
<li>This highlighted the <strong>vast difference in energy levels between chemical r</strong>eactions (electron binding) and the forces holding the atomic nucleus together.****</li>
</ul></li>
<li><strong>Rutherford pondered the potential implications of artificially induced decay, suggesting it could have devastating consequences.</strong></li>
</ul>
</section>
<section id="philipp-lenards-cathode-ray-scattering-and-the-concept-of-atomic-vacuum" class="level5">
<h5 class="anchored" data-anchor-id="philipp-lenards-cathode-ray-scattering-and-the-concept-of-atomic-vacuum">Philipp Lenard’s Cathode Ray Scattering and the Concept of Atomic Vacuum</h5>
<ul>
<li><strong>Philipp von Lenard</strong>, a German physicist, <strong>worked on bringing cathode rays out of the vacuum tube.</strong></li>
<li>He built a tube with a thin metal window that allowed cathode rays to escape.</li>
<li>He observed that some rays were scattered when passing through the window.</li>
<li>Lenard proposed that atoms were mostly empty space (vacuum) to explain the scattering.
<ul>
<li>He suggested that <strong>a cubic meter of platinum was as empty as outer space</strong>.</li>
</ul></li>
<li>This was a radical idea that challenged the prevailing view of atoms as solid, continuous entities.</li>
</ul>
</section>
<section id="hantaro-nagaokas-saturnian-model-of-the-atom" class="level5">
<h5 class="anchored" data-anchor-id="hantaro-nagaokas-saturnian-model-of-the-atom">Hantaro Nagaoka’s Saturnian Model of the Atom</h5>
<ul>
<li><strong>Hantaro Nagaoka</strong>, a Japanese physicist, <strong>developed a “Saturnian” model of the atom based on James Clerk Maxwell’s work on Saturn’s rings.</strong></li>
<li>He proposed that electrons orbited a central positive charge like rocks orbiting Saturn.</li>
<li><strong>This model had a flaw:</strong>
<ul>
<li>The repulsive force between electrons would cause them to fly apart, unlike the gravitational attraction that holds Saturn’s rings together.</li>
</ul></li>
</ul>
</section>
<section id="rutherfords-alpha-particle-scattering-and-the-discovery-of-the-nucleus" class="level5">
<h5 class="anchored" data-anchor-id="rutherfords-alpha-particle-scattering-and-the-discovery-of-the-nucleus">Rutherford’s Alpha Particle Scattering and the Discovery of the Nucleus</h5>
<ul>
<li>Rutherford, intrigued by Lenard’s claim of atomic vacuum, conducted experiments with alpha particles.</li>
<li><strong>He used a magnetic field to deflect alpha particles and observed their scattering through a thin piece of mica.</strong>
<ul>
<li>The mica deflected alpha particles more than the strongest magnet.</li>
</ul></li>
<li>Rutherford moved to the University of Manchester in 1907.</li>
<li>In 1908, he proved that alpha particles were helium atoms stripped of their electrons.</li>
<li><strong>In 1910, Rutherford, Hans Geiger, and Ernest Marsden conducted the Gold Foil Experiment.</strong>
<ul>
<li>They aimed a beam of alpha particles at a thin gold foil and observed their scattering using a zinc sulfide screen and microscope.</li>
<li>They unexpectedly found that some alpha particles were deflected at very large angles, even bouncing backwards.</li>
</ul></li>
<li><strong>Rutherford interpreted this as evidence for a dense, positively charged nucleus at the center of the atom.</strong>
<ul>
<li>He realized that most of the atom’s mass and positive charge were concentrated in a tiny nucleus.</li>
</ul></li>
<li><strong>Rutherford’s model replaced the plum-pudding model.</strong>
<ul>
<li>He envisioned the atom as mostly empty space with a dense nucleus and orbiting electrons, similar to a miniature solar system.</li>
</ul></li>
</ul>
</section>
<section id="rutherfords-announcement-and-the-impact-of-the-nuclear-model" class="level5">
<h5 class="anchored" data-anchor-id="rutherfords-announcement-and-the-impact-of-the-nuclear-model">Rutherford’s Announcement and the Impact of the Nuclear Model</h5>
<ul>
<li>Rutherford announced his discovery at the Manchester Literary and Philosophical Society in 1911.</li>
<li>His nuclear model of the atom became an iconic representation of atomic structure.</li>
<li>Rutherford’s work established the field of nuclear physics.</li>
</ul>
</section>
</section>
<section id="remaining-questions-and-the-shift-towards-theoretical-physics" class="level4">
<h4 class="anchored" data-anchor-id="remaining-questions-and-the-shift-towards-theoretical-physics">Remaining Questions and the Shift Towards Theoretical Physics</h4>
<ul>
<li>Despite the progress, two questions remained:
<ul>
<li>Johann Jakob Balmer’s formula (1885) accurately predicted the spectral lines of hydrogen but lacked a theoretical explanation.</li>
<li>The orbit of Mercury deviated slightly from predictions based on Newtonian physics.</li>
</ul></li>
<li>These anomalies indicated a need for deeper theoretical understanding.</li>
<li>Physics was transitioning towards a more abstract and mathematical approach.</li>
<li>Rutherford’s model, although iconic, would eventually be found to be inaccurate.
<ul>
<li>The orbiting electrons would not be stable due to electromagnetic radiation.</li>
</ul></li>
<li>The nature of the atom would require a radical shift in understanding, moving beyond classical physics.</li>
</ul>
</section>
</section>
<section id="chapter-3-einstein-drops-a-bomb" class="level3">
<h3 class="anchored" data-anchor-id="chapter-3-einstein-drops-a-bomb">Chapter 3: Einstein Drops a Bomb</h3>
<section id="the-united-states-in-physical-science-pre-1930s" class="level4">
<h4 class="anchored" data-anchor-id="the-united-states-in-physical-science-pre-1930s">The United States in Physical Science (Pre-1930s)</h4>
<ul>
<li><strong>Backwater in physical science</strong>, with one major exception: the <strong>Michelson-Morley experiment</strong>.</li>
</ul>
</section>
<section id="the-michelson-morley-experiment-1887" class="level4">
<h4 class="anchored" data-anchor-id="the-michelson-morley-experiment-1887">The Michelson-Morley Experiment (1887)</h4>
<section id="goal" class="level5">
<h5 class="anchored" data-anchor-id="goal">Goal</h5>
<ul>
<li>Determine the <strong>speed</strong> and <strong>direction</strong> of the Earth’s movement through space.</li>
<li>Scientists believed the Earth moved through a stationary medium called the <strong>luminiferous ether</strong>.</li>
</ul>
</section>
<section id="background" class="level5">
<h5 class="anchored" data-anchor-id="background">Background</h5>
<ul>
<li>Earth’s known movements:
<ul>
<li>Rotation on its north-south axis.</li>
<li>Orbit around the Sun at 19 miles per second.</li>
<li>Suspected movement of the solar system around the Milky Way’s center.</li>
</ul></li>
<li>Light was believed to travel in waves through the ether, similar to sound waves through air.</li>
</ul>
</section>
<section id="experimental-setup" class="level5">
<h5 class="anchored" data-anchor-id="experimental-setup">Experimental Setup</h5>
<ul>
<li><strong>Interferometer:</strong>
<ul>
<li>Stone slab (1 foot thick, 4.5 feet per side) on a wooden float in a mercury-filled trough.</li>
<li>Concrete pier and brick foundation for stability.</li>
<li>Housed in a basement with a wooden cover for minimal temperature and vibration fluctuations.</li>
</ul></li>
<li><strong>Half-silvered mirror:</strong> Split a light beam (from a gas burner) into two perpendicular paths.</li>
<li><strong>Mirrors at corners:</strong> Reflected the split beams back to the dividing mirror.</li>
<li><strong>Telescope:</strong> Viewed the resulting interference pattern (bullseye with concentric rings).</li>
<li><strong>Expected Outcome:</strong> Speed variations in the light beams would create interference fringes, indicating the Earth’s speed through the ether.</li>
</ul>
</section>
<section id="results" class="level5">
<h5 class="anchored" data-anchor-id="results">Results</h5>
<ul>
<li><strong>No variation in the speed of light</strong> was detected in any direction.</li>
</ul>
</section>
<section id="implications" class="level5">
<h5 class="anchored" data-anchor-id="implications">Implications</h5>
<ul>
<li>Two possibilities:
<ul>
<li>The laboratory was stationary relative to the ether, and the universe rotated around Cleveland.</li>
<li><strong>The ether does not exist.</strong></li>
</ul></li>
<li>The <strong>rippling pond analogy for light propagation was flawed</strong>.</li>
<li><strong>No medium for light conduction</strong> - a paradoxical finding.</li>
</ul>
</section>
<section id="subsequent-experiments" class="level5">
<h5 class="anchored" data-anchor-id="subsequent-experiments">Subsequent Experiments</h5>
<ul>
<li>Countless repetitions with increasing sophistication (up to laser optics era).</li>
<li><strong>1992:</strong> Most recent experiment confirmed the null result.</li>
<li><strong>Implications remain disturbing</strong>: No ether, no universal frame of reference.</li>
</ul>
</section>
<section id="recognition" class="level5">
<h5 class="anchored" data-anchor-id="recognition">Recognition</h5>
<ul>
<li><strong>Albert Michelson:</strong> Awarded the <strong>Nobel Prize in Physics (1907)</strong> for the experiment.</li>
<li><strong>Unique case:</strong> Nobel Prize for disproving the initial hypothesis.</li>
</ul>
</section>
</section>
<section id="albert-einsteins-entry" class="level4">
<h4 class="anchored" data-anchor-id="albert-einsteins-entry">Albert Einstein’s Entry</h4>
<section id="background-1" class="level5">
<h5 class="anchored" data-anchor-id="background-1">Background</h5>
<ul>
<li>Born in Ulm, Germany (1879).</li>
<li>Destined to revolutionize physics.</li>
</ul>
</section>
<section id="views-on-the-michelson-morley-experiment" class="level5">
<h5 class="anchored" data-anchor-id="views-on-the-michelson-morley-experiment">Views on the Michelson-Morley Experiment</h5>
<ul>
<li>Deemed it unnecessary, as he already knew <strong>no medium was needed for light propagation</strong>.</li>
<li><strong>Addendum to his theory:</strong> Proved the <strong>equivalence of energy and matter (E=mc²)</strong>.</li>
</ul>
</section>
</section>
<section id="early-20th-century-physics" class="level4">
<h4 class="anchored" data-anchor-id="early-20th-century-physics">Early 20th Century Physics</h4>
<section id="atomic-energy" class="level5">
<h5 class="anchored" data-anchor-id="atomic-energy">Atomic Energy</h5>
<ul>
<li>Scientists suspected a high-energy conversion in atomic nuclei beyond chemical energy release.</li>
<li>Einstein’s mass-energy equation:
<ul>
<li>Provided <strong>theoretical legitimacy</strong> for the pursuit of nuclear power.</li>
<li>Integrated it into a developing universal model.</li>
</ul></li>
</ul>
</section>
<section id="quantum-mechanics" class="level5">
<h5 class="anchored" data-anchor-id="quantum-mechanics">Quantum Mechanics</h5>
<ul>
<li>Einstein inadvertently initiated the development of quantum mechanics.</li>
<li>Quantum mechanics would eventually explain energy release from the atomic nucleus.</li>
</ul>
</section>
<section id="solving-19th-century-physics-problems" class="level5">
<h5 class="anchored" data-anchor-id="solving-19th-century-physics-problems">Solving 19th Century Physics Problems</h5>
<ul>
<li>Einstein’s theories of relativity and quantum mechanics addressed two unsolved problems:
<ul>
<li>The orbit of Mercury.</li>
<li>The Balmer series of hydrogen.</li>
</ul></li>
</ul>
</section>
<section id="new-questions-and-widening-gap" class="level5">
<h5 class="anchored" data-anchor-id="new-questions-and-widening-gap">New Questions and Widening Gap</h5>
<ul>
<li>Solving these problems opened up new questions.</li>
<li>Increased the perceived distance between the real world and the atomic world.</li>
</ul>
</section>
<section id="einsteins-popularity" class="level5">
<h5 class="anchored" data-anchor-id="einsteins-popularity">Einstein’s Popularity</h5>
<ul>
<li>Achieved unprecedented popularity for a scientist.</li>
<li><strong>Post-World War I:</strong> Published an English version of his Theories of Relativity for the general public.</li>
<li><strong>Book tours and lectures:</strong> Drew huge crowds, becoming a media sensation.</li>
<li><strong>Iconic image:</strong> Rumpled, lost in thought, reinforced the archetype of the physicist.</li>
<li><strong>Ambivalent about fame:</strong> Hated the attention but thrived on it.</li>
<li><strong>Opportune timing:</strong> His abstractions were needed by the developing field of nuclear physics.</li>
<li><strong>Popularizing science:</strong> Made nuclear energy more acceptable to the public.</li>
</ul>
</section>
</section>
<section id="einsteins-early-life-and-education" class="level4">
<h4 class="anchored" data-anchor-id="einsteins-early-life-and-education">Einstein’s Early Life and Education</h4>
<section id="early-fascination-with-science" class="level5">
<h5 class="anchored" data-anchor-id="early-fascination-with-science">Early Fascination with Science</h5>
<ul>
<li><strong>Age 5:</strong> Fascinated by a magnetic compass and its invisible force.</li>
<li><strong>Age 10:</strong> Reading science books.</li>
<li><strong>Age 12:</strong> Mastered Euclidean geometry.</li>
<li><strong>High school:</strong> Wrote his first scientific paper on ether in magnetic fields.</li>
</ul>
</section>
<section id="educational-path" class="level5">
<h5 class="anchored" data-anchor-id="educational-path">Educational Path</h5>
<ul>
<li><strong>1895:</strong> Dropped out of high school in Germany.</li>
<li><strong>Failed entrance exam</strong> to the Swiss Federal Institute of Technology (ETH Zurich).</li>
<li><strong>Completed secondary education in Aarau, Switzerland (1896).</strong></li>
<li><strong>Renounced German citizenship</strong> to avoid military service.</li>
<li><strong>Accepted at ETH Zurich</strong> and graduated with a physics degree (1900).</li>
</ul>
</section>
<section id="early-career-challenges" class="level5">
<h5 class="anchored" data-anchor-id="early-career-challenges">Early Career Challenges</h5>
<ul>
<li>Struggled to find work as a high school teacher for two years.</li>
<li><strong>1902:</strong> Secured a job as a patent examiner at the Swiss patent office.</li>
</ul>
</section>
</section>
<section id="the-patent-office-years-1902-1909" class="level4">
<h4 class="anchored" data-anchor-id="the-patent-office-years-1902-1909">The Patent Office Years (1902-1909)</h4>
<section id="ideal-environment-for-thought" class="level5">
<h5 class="anchored" data-anchor-id="ideal-environment-for-thought">Ideal Environment for Thought</h5>
<ul>
<li><strong>Freedom from academic pressures:</strong> Allowed for independent thinking.</li>
<li><strong>Exposure to clock-synchronizing patents:</strong> Sparked his thoughts on time.</li>
</ul>
</section>
<section id="annus-mirabilis-1905" class="level5">
<h5 class="anchored" data-anchor-id="annus-mirabilis-1905">Annus Mirabilis (1905)</h5>
<ul>
<li>Published five groundbreaking papers:</li>
</ul>
<p><strong>1. On a Heuristic Point of View Concerning the Production and Transformation of Light</strong></p>
<ul>
<li><strong>Nobel Prize in Physics (1921).</strong></li>
<li><strong>Explained the photoelectric effect:</strong>
<ul>
<li>Observed by Max Planck.</li>
<li>Electron energy depends on light frequency, not intensity.</li>
</ul></li>
<li><strong>Proposed the concept of light quanta:</strong>
<ul>
<li>Discrete packets of energy.</li>
<li>Challenged the wave theory of light.</li>
</ul></li>
<li><strong>Implications:</strong>
<ul>
<li><strong>Laid the foundation for quantum mechanics.</strong></li>
<li><strong>Supported the non-existence of ether.</strong></li>
</ul></li>
</ul>
<p><strong>2. A New Determination of Molecular Dimensions</strong></p>
<ul>
<li><strong>Ph.D.&nbsp;thesis</strong> at the University of Zurich.</li>
<li><strong>Studied the diffusion of sugar molecules in water.</strong></li>
<li><strong>Significance:</strong>
<ul>
<li>Confirmed the molecular structure of solutions.</li>
<li>Predicted the number and size of molecules theoretically.</li>
</ul></li>
</ul>
<p><strong>3. On the Motion of Small Particles Suspended in Stationary Liquids Required by the Molecular-Kinetic Theory of Heat</strong></p>
<ul>
<li>Published 11 days after his Ph.D.&nbsp;thesis.</li>
<li><strong>Explained Brownian motion:</strong> Random movement of particles in a fluid.</li>
<li><strong>Significance:</strong>
<ul>
<li>Further validated the atomic theory of matter.</li>
<li>Supported the use of statistical methods in physics.</li>
</ul></li>
</ul>
<p><strong>4. On the Electrodynamics of Moving Bodies</strong></p>
<ul>
<li><strong>Introduced the theory of special relativity.</strong></li>
<li><strong>Focused on the relative motion of observers.</strong></li>
<li><strong>Key Concepts:</strong>
<ul>
<li><strong>Relativity of motion:</strong> No absolute frame of reference.</li>
<li><strong>Constancy of the speed of light:</strong> The only constant in all frames of reference.</li>
<li><strong>Non-simultaneity of events:</strong> Events simultaneous for one observer may not be for another.</li>
</ul></li>
<li><strong>Thought Experiments:</strong>
<ul>
<li>Moving electron and magnetic field.</li>
<li>Lightning strikes and synchronized clocks.</li>
</ul></li>
</ul>
<p><strong>5. Does the Inertia of a Body Depend Upon Its Energy Content?</strong></p>
<ul>
<li><strong>Addendum to the special relativity paper.</strong></li>
<li><strong>Introduced the famous equation: E=mc².</strong></li>
<li><strong>Mass-energy equivalence:</strong> Mass and energy are interchangeable.</li>
<li><strong>Implications:</strong>
<ul>
<li>Revised the laws of conservation of mass and energy.</li>
<li>Small amounts of mass can be converted into enormous amounts of energy.</li>
</ul></li>
</ul>
</section>
<section id="impact-of-the-1905-papers" class="level5">
<h5 class="anchored" data-anchor-id="impact-of-the-1905-papers">Impact of the 1905 Papers</h5>
<ul>
<li><strong>Revolutionized physics.</strong></li>
<li><strong>Einstein’s career took off:</strong> Received numerous job offers from prestigious institutions.</li>
</ul>
</section>
</section>
<section id="general-relativity-1908-1919" class="level4">
<h4 class="anchored" data-anchor-id="general-relativity-1908-1919">General Relativity (1908-1919)</h4>
<section id="expanding-on-special-relativity" class="level5">
<h5 class="anchored" data-anchor-id="expanding-on-special-relativity">Expanding on Special Relativity</h5>
<ul>
<li><strong>Goal:</strong> Extend the theory to accelerating reference frames.</li>
<li><strong>Challenging task:</strong> Took ten years of intense work.</li>
</ul>
</section>
<section id="key-concepts" class="level5">
<h5 class="anchored" data-anchor-id="key-concepts">Key Concepts</h5>
<ul>
<li><strong>Equivalence principle:</strong> Gravity and acceleration are indistinguishable.</li>
<li><strong>Curvature of spacetime:</strong> Gravity is a manifestation of the curvature of spacetime caused by mass and energy.</li>
</ul>
</section>
<section id="thought-experiment-elevator-car" class="level5">
<h5 class="anchored" data-anchor-id="thought-experiment-elevator-car">Thought Experiment: Elevator Car</h5>
<ul>
<li><strong>Stationary elevator:</strong> Gravity holds you to the floor.</li>
<li><strong>Accelerating elevator in space:</strong> Acceleration mimics gravity.</li>
<li><strong>Light beam in an accelerating elevator:</strong> The beam appears bent due to the curvature of spacetime.</li>
</ul>
</section>
<section id="non-euclidean-geometry" class="level5">
<h5 class="anchored" data-anchor-id="non-euclidean-geometry">Non-Euclidean Geometry</h5>
<ul>
<li><strong>Euclidean geometry:</strong> Straight lines, pi, 180-degree triangles.</li>
<li><strong>Non-Euclidean geometry:</strong> Curved space, different rules.</li>
<li><strong>Einstein used non-Euclidean geometry to describe gravity.</strong></li>
</ul>
</section>
<section id="gravity-as-a-property-of-spacetime" class="level5">
<h5 class="anchored" data-anchor-id="gravity-as-a-property-of-spacetime">Gravity as a Property of Spacetime</h5>
<ul>
<li><strong>Trampoline analogy:</strong>
<ul>
<li>Bowling ball creates a well in the trampoline, representing the curvature of spacetime caused by the sun.</li>
<li>Billiard ball is attracted to the well, representing the gravitational attraction of planets to the sun.</li>
</ul></li>
</ul>
</section>
<section id="explaining-the-orbit-of-mercury" class="level5">
<h5 class="anchored" data-anchor-id="explaining-the-orbit-of-mercury">Explaining the Orbit of Mercury</h5>
<ul>
<li><strong>Mercury’s perihelion precession:</strong> Its orbit shifts slightly over time.</li>
<li><strong>Einstein’s explanation:</strong> Time is warped near the sun, affecting Mercury’s orbit.</li>
<li><strong>1915:</strong> Predicted the correct value of Mercury’s perihelion shift (43 arcseconds per century).</li>
</ul>
</section>
<section id="experimental-confirmation" class="level5">
<h5 class="anchored" data-anchor-id="experimental-confirmation">Experimental Confirmation</h5>
<ul>
<li><strong>Prediction:</strong> Starlight should bend as it passes near the sun (1.7 arcseconds).</li>
<li><strong>1914:</strong> Erwin Freundlich’s expedition to observe the eclipse in Russia was thwarted by World War I.</li>
<li><strong>1919:</strong> Arthur Eddington’s expeditions during a solar eclipse confirmed the bending of starlight.</li>
</ul>
</section>
<section id="impact-of-general-relativity" class="level5">
<h5 class="anchored" data-anchor-id="impact-of-general-relativity">Impact of General Relativity</h5>
<ul>
<li><strong>Further revolutionized physics.</strong></li>
<li><strong>Solved the Mercury problem.</strong></li>
<li><strong>Confirmed Einstein’s genius.</strong></li>
</ul>
</section>
<section id="public-reaction" class="level5">
<h5 class="anchored" data-anchor-id="public-reaction">Public Reaction</h5>
<ul>
<li><strong>Eddington’s announcement:</strong> Created a media frenzy.</li>
<li><strong>Einstein became a global celebrity.</strong></li>
<li><strong>Relativity became a popular topic of discussion.</strong></li>
</ul>
</section>
</section>
<section id="conclusion-2" class="level4">
<h4 class="anchored" data-anchor-id="conclusion-2">Conclusion</h4>
<ul>
<li><strong>Einstein’s theories:</strong> Dropped a bomb on classical physics.</li>
<li><strong>Paved the way for new and strange theories</strong>, preparing the world for the quantum revolution.</li>
<li><strong>Bridged the gap between science and the public</strong>, making complex scientific concepts accessible to a wider audience.</li>
</ul>
</section>
</section>
<section id="chapter-4-the-other-end-of-the-universe" class="level3">
<h3 class="anchored" data-anchor-id="chapter-4-the-other-end-of-the-universe">Chapter 4: The Other End of the Universe</h3>
<section id="the-bohr-medal-story" class="level4">
<h4 class="anchored" data-anchor-id="the-bohr-medal-story">The Bohr Medal Story</h4>
<section id="the-storys-premise" class="level5">
<h5 class="anchored" data-anchor-id="the-storys-premise">The Story’s Premise</h5>
<ul>
<li><strong>Niels Bohr</strong>, the originator of quantum mechanics and Nobel Prize winner in 1922, faced a dilemma during World War II.</li>
<li>German occupation of Denmark meant he couldn’t take his <strong>Nobel Prize medal</strong> (made of 200 grams of 23-carat gold) with him when escaping.</li>
<li>The story claims Bohr <strong>dissolved the medal in aqua regia</strong> (a mixture of hydrochloric and nitric acids), carried it out in a bottle, and later recast it in the United States.</li>
</ul>
</section>
<section id="reasons-for-doubt" class="level5">
<h5 class="anchored" data-anchor-id="reasons-for-doubt">Reasons for Doubt</h5>
<ul>
<li>Bohr’s escape was clandestine, involving a fishing boat and a nighttime journey to Sweden, making it unlikely he went through customs.</li>
<li>The author finds it improbable that Bohr would have declared the aqua regia to border guards.</li>
<li>The author concludes that the story is likely a <strong>myth</strong>, highlighting the fuzzy nature of history.</li>
</ul>
</section>
</section>
<section id="the-fuzzy-nature-of-atoms-and-quantum-mechanics" class="level4">
<h4 class="anchored" data-anchor-id="the-fuzzy-nature-of-atoms-and-quantum-mechanics">The Fuzzy Nature of Atoms and Quantum Mechanics</h4>
<section id="einsteins-relativity-and-its-limitations" class="level5">
<h5 class="anchored" data-anchor-id="einsteins-relativity-and-its-limitations">Einstein’s Relativity and its Limitations</h5>
<ul>
<li>Einstein’s <strong>theory of special relativity</strong> explained the immense energy released during nuclear decay (e.g., radium’s decay produces 10 billion calories per gram).
<ul>
<li>It showed that this energy comes from a tiny loss of mass (0.00047 grams per gram of radium).</li>
</ul></li>
<li>Special relativity, however, doesn’t explain the mechanisms of nuclear decay or how it can be controlled.</li>
<li><strong>General relativity</strong>, dealing with large-scale structures, predicts phenomena like black holes but breaks down at the atomic level where <strong>electromagnetic and nuclear forces dominate</strong>.</li>
<li>Relativity assumes a <strong>macroscopic world</strong> with smooth, infinitely divisible quantities and predictable actions.</li>
<li>The <strong>atomic world</strong> is fundamentally different, characterized by <strong>jerky movements, sudden jumps, and random, unpredictable behavior</strong>.</li>
</ul>
</section>
<section id="quantum-mechanics-a-parallel-development" class="level5">
<h5 class="anchored" data-anchor-id="quantum-mechanics-a-parallel-development">Quantum Mechanics: A Parallel Development</h5>
<ul>
<li><strong>Quantum mechanics</strong>, developed alongside relativity, offered an alternative explanation for nuclear physics.</li>
<li>It became the last major physical theory synthesized in Europe before World War II.</li>
<li>It resolved many questions unanswered by relativity but created a <strong>conflict with relativity</strong> that persisted even after Einstein’s death.</li>
</ul>
</section>
</section>
<section id="einsteins-quantum-contribution-and-bohrs-atomic-model" class="level4">
<h4 class="anchored" data-anchor-id="einsteins-quantum-contribution-and-bohrs-atomic-model">Einstein’s Quantum Contribution and Bohr’s Atomic Model</h4>
<section id="einsteins-photoelectric-effect-and-quantization" class="level5">
<h5 class="anchored" data-anchor-id="einsteins-photoelectric-effect-and-quantization">Einstein’s Photoelectric Effect and Quantization</h5>
<ul>
<li>In 1905, Einstein published a paper on the <strong>photoelectric effect</strong>, showing that <strong>light consists of discrete packets of energy called quanta</strong>.</li>
<li>He concluded that light cannot be divided below a limit defined by <strong>Planck’s constant</strong>.</li>
<li>This concept challenged classical physics and Maxwell’s equations, which assumed light as a continuous wave.</li>
<li>Subsequent research revealed that <strong>quantization</strong> applies to various phenomena, not just light.</li>
</ul>
</section>
<section id="quantization-example-cobalt-60" class="level5">
<h5 class="anchored" data-anchor-id="quantization-example-cobalt-60">Quantization Example: Cobalt-60</h5>
<ul>
<li><strong>Cobalt-60</strong>, a radioactive metal, has a <strong>half-life</strong> of 5.3 years (its radiation output halves in that time).</li>
<li>Repeatedly halving a block of cobalt-60 eventually leads to a single atom, which is the <strong>quantum cutoff</strong>.</li>
<li>At the macroscopic level, decay is predictable (half-life); at the quantum level, it’s probabilistic (50% chance of decay in 5.3 years).</li>
<li>This demonstrates the shift from <strong>certainty in the macro world to uncertainty in the quantum world</strong>.</li>
</ul>
</section>
<section id="niels-bohr-and-the-quantum-leap" class="level5">
<h5 class="anchored" data-anchor-id="niels-bohr-and-the-quantum-leap">Niels Bohr and the Quantum Leap</h5>
<ul>
<li><strong>Niels Bohr</strong>, a brilliant physicist, recognized the connection between Einstein’s light quanta and atomic structure.</li>
<li>Bohr worked with <strong>Rutherford</strong>, whose <strong>solar system model of the atom</strong> had limitations:
<ul>
<li>Electrons orbiting the nucleus should repel each other.</li>
<li>An orbiting electron, constantly accelerating, should emit radiation and eventually collapse into the nucleus, contradicting the stability of atoms.</li>
</ul></li>
<li>Bohr was inspired by <strong>spectral lines</strong>, the unique patterns of light emitted by excited gases.
<ul>
<li><strong>Balmer’s formula</strong> (1885) could predict the wavelengths of hydrogen’s spectral lines using integer values.</li>
<li><strong>Rydberg’s formula</strong> (1890) generalized Balmer’s formula for other elements.</li>
</ul></li>
<li>Bohr realized that the <strong>integers in these formulas implied quantization of the emitted light</strong>.</li>
<li>He proposed that electrons exist in <strong>discrete energy states</strong>, not continuous orbits.</li>
<li><strong>Electrons jump (quantum leap) between these energy states</strong>, emitting or absorbing specific amounts of energy corresponding to the spectral lines.</li>
<li>Bohr’s model successfully <strong>derived the Rydberg constant</strong> using fundamental constants (electron mass, electron charge, Planck’s constant).</li>
<li>It validated Einstein’s light quanta theory, Planck’s equation, and provided a physical basis for Balmer and Rydberg’s formulas.</li>
<li>Bohr effectively <strong>invented quantum mechanics</strong>.</li>
</ul>
</section>
</section>
<section id="the-bohr-model-and-the-periodic-table" class="level4">
<h4 class="anchored" data-anchor-id="the-bohr-model-and-the-periodic-table">The Bohr Model and the Periodic Table</h4>
<section id="bohrs-atomic-model-shells-and-ground-states" class="level5">
<h5 class="anchored" data-anchor-id="bohrs-atomic-model-shells-and-ground-states">Bohr’s Atomic Model: Shells and Ground States</h5>
<ul>
<li>Bohr’s model defined the <strong>ground state</strong> of an atom as a sphere at a specific distance from the nucleus.</li>
<li><strong>Ground state energies are quantized</strong> (occur in integer steps).</li>
<li>Higher ground states correspond to larger spheres that can hold more electrons.</li>
<li><strong>Hydrogen</strong>, with one electron, has a half-filled ground state.</li>
<li><strong>Helium</strong>, with two electrons, has a filled ground state, making it inert (unable to form compounds).</li>
<li>Heavier elements have multiple <strong>electron shells</strong>, each accommodating a specific number of electrons (8, 18, 32, etc.).</li>
<li><strong>Chemical reactivity</strong> depends on the ability to fill the outermost shell with electrons.</li>
</ul>
</section>
<section id="impact-on-chemistry-and-the-periodic-table" class="level5">
<h5 class="anchored" data-anchor-id="impact-on-chemistry-and-the-periodic-table">Impact on Chemistry and the Periodic Table</h5>
<ul>
<li>Bohr’s model clarified the <strong>periodic table of the elements</strong>, invented by <strong>Mendeleev</strong> in 1869.</li>
<li>Elements in the same column (e.g., alkali metals) have similar chemical properties because they have the same number of electrons in their outermost shell.</li>
<li>Electron shells fill from the inner to outer shells, with no gaps below the top level.</li>
</ul>
</section>
<section id="bohrs-continued-work-and-the-copenhagen-interpretation" class="level5">
<h5 class="anchored" data-anchor-id="bohrs-continued-work-and-the-copenhagen-interpretation">Bohr’s Continued Work and the Copenhagen Interpretation</h5>
<ul>
<li>Bohr became a professor in Copenhagen and director of the <strong>Institute of Theoretical Physics</strong>.</li>
<li>His refined theories became known as the <strong>Copenhagen Interpretation</strong>.</li>
<li>Bohr predicted that element 72 (later named <strong>Hafnium</strong>) would have four electrons in its outer shell and behave chemically like zirconium, a prediction confirmed shortly after he received his Nobel Prize in 1922.</li>
</ul>
</section>
</section>
<section id="heisenbergs-uncertainty-principle" class="level4">
<h4 class="anchored" data-anchor-id="heisenbergs-uncertainty-principle">Heisenberg’s Uncertainty Principle</h4>
<section id="heisenberg-and-quantum-mechanics" class="level5">
<h5 class="anchored" data-anchor-id="heisenberg-and-quantum-mechanics">Heisenberg and Quantum Mechanics</h5>
<ul>
<li><strong>Werner Heisenberg</strong>, a German physicist, collaborated with Bohr on quantum mechanics.</li>
<li>In 1927, they struggled with the <strong>wave-particle duality of light</strong>, its behavior as both particles and waves.</li>
<li>Inspired by <strong>Einstein’s statement, “It is the theory which decides what we can observe,”</strong> Heisenberg developed his <strong>Uncertainty Principle</strong>.</li>
</ul>
</section>
<section id="the-uncertainty-principle-limits-of-measurement" class="level5">
<h5 class="anchored" data-anchor-id="the-uncertainty-principle-limits-of-measurement">The Uncertainty Principle: Limits of Measurement</h5>
<ul>
<li>Heisenberg proposed that at the atomic level, there are <strong>fundamental limits to the precision of measurement</strong>.</li>
<li><strong>The act of measuring a quantity inevitably disturbs the system</strong>, leading to a loss of information about other quantities.</li>
<li><strong>Example:</strong>
<ul>
<li>Measuring the <strong>position</strong> of an electron precisely (e.g., with a flash photograph) makes its <strong>speed</strong> unknowable.</li>
<li>Measuring the <strong>speed</strong> of an electron precisely (e.g., by scattering gamma rays) makes its <strong>position</strong> unknowable.</li>
</ul></li>
<li>Since an electron’s energy (and thus speed) can be precisely measured using spectroscopy, its position becomes uncertain.</li>
<li><strong>Conclusion:</strong> The concept of a definite electron position around the nucleus is meaningless.</li>
<li>Bohr summarized this as <strong>“nothing exists until it is measured”</strong>.</li>
</ul>
</section>
<section id="implications-for-atomic-models" class="level5">
<h5 class="anchored" data-anchor-id="implications-for-atomic-models">Implications for Atomic Models</h5>
<ul>
<li>Heisenberg’s work showed that visual models of the atom, with electrons in specific orbits, are inaccurate.</li>
<li>Electrons are better represented as a <strong>cloud of uncertainty</strong> around the nucleus.</li>
<li>Heisenberg’s <strong>Uncertainty Principle</strong> revolutionized atomic physics, earning him the Nobel Prize in 1929.</li>
</ul>
</section>
</section>
<section id="the-double-slit-experiment-and-wave-particle-duality" class="level4">
<h4 class="anchored" data-anchor-id="the-double-slit-experiment-and-wave-particle-duality">The Double-Slit Experiment and Wave-Particle Duality</h4>
<section id="youngs-double-slit-experiment" class="level5">
<h5 class="anchored" data-anchor-id="youngs-double-slit-experiment">Young’s Double-Slit Experiment</h5>
<ul>
<li><strong>Thomas Young</strong>, in 1801, conducted the <strong>double-slit experiment</strong> to demonstrate the <strong>wave nature of light</strong>.</li>
<li>A light beam passing through two narrow slits creates an <strong>interference pattern</strong> on a screen behind the slits, with alternating light and dark bands.</li>
<li>This pattern arises from the <strong>wavefronts interfering with each other</strong>.</li>
</ul>
</section>
<section id="the-double-slit-experiment-with-electrons" class="level5">
<h5 class="anchored" data-anchor-id="the-double-slit-experiment-with-electrons">The Double-Slit Experiment with Electrons</h5>
<ul>
<li>The experiment has been repeated with various types of waves and even particles.</li>
<li>In 1961, it was done with a beam of electrons, and in 1989, with a <strong>single electron</strong>.</li>
<li>The <strong>interference pattern still appeared</strong>, even with a single electron, suggesting it somehow passed through both slits simultaneously.</li>
</ul>
</section>
<section id="wave-particle-duality-paradox" class="level5">
<h5 class="anchored" data-anchor-id="wave-particle-duality-paradox">Wave-Particle Duality Paradox</h5>
<ul>
<li>These results contradicted the particle nature of electrons established by Bohr and Compton.</li>
<li><strong>How could a single electron interfere with itself as if it were a wave?</strong></li>
<li>Experiments attempting to measure both wave and particle properties simultaneously have shown that <strong>light can behave as either a wave or a particle, but not both at the same time</strong>.</li>
</ul>
</section>
<section id="the-role-of-theory" class="level5">
<h5 class="anchored" data-anchor-id="the-role-of-theory">The Role of Theory</h5>
<ul>
<li><strong>Einstein’s statement about theory influencing observation becomes relevant</strong>.</li>
<li>The choice of experiment and the theory it’s based on determine whether light appears as a wave or a particle.</li>
</ul>
</section>
</section>
<section id="de-broglies-matter-waves" class="level4">
<h4 class="anchored" data-anchor-id="de-broglies-matter-waves">De Broglie’s Matter Waves</h4>
<section id="de-broglies-hypothesis" class="level5">
<h5 class="anchored" data-anchor-id="de-broglies-hypothesis">De Broglie’s Hypothesis</h5>
<ul>
<li><strong>Louis de Broglie</strong>, in 1924, proposed that <strong>matter, like light, can exhibit both wave and particle properties</strong>.</li>
<li>He based this on the <strong>symmetry of nature</strong> and the established wave-particle duality of light.</li>
<li>He expressed this with the equation: <strong>λ = h/p</strong>
<ul>
<li><strong>λ</strong> (lambda) is the wavelength.</li>
<li><strong>h</strong> is Planck’s constant.</li>
<li><strong>p</strong> is the momentum of the particle (mass x velocity).</li>
</ul></li>
</ul>
</section>
<section id="implications-and-significance" class="level5">
<h5 class="anchored" data-anchor-id="implications-and-significance">Implications and Significance</h5>
<ul>
<li>De Broglie’s equation showed that <strong>any particle with momentum has a corresponding wavelength</strong>.</li>
<li>This provided a theoretical basis for the wave-like behavior of electrons in the double-slit experiment.</li>
<li>De Broglie’s work earned him the Nobel Prize in Physics in 1929.</li>
</ul>
</section>
</section>
<section id="schrödingers-wave-mechanics" class="level4">
<h4 class="anchored" data-anchor-id="schrödingers-wave-mechanics">Schrödinger’s Wave Mechanics</h4>
<section id="schrödingers-approach" class="level5">
<h5 class="anchored" data-anchor-id="schrödingers-approach">Schrödinger’s Approach</h5>
<ul>
<li><strong>Erwin Schrödinger</strong>, inspired by de Broglie, developed <strong>wave mechanics</strong> as an alternative model of the atom.</li>
<li>He treated electrons as <strong>standing waves</strong> rather than particles.</li>
<li>These waves, confined around the nucleus, can only vibrate at specific <strong>integer frequencies (harmonics)</strong>.</li>
</ul>
</section>
<section id="confirmation-of-quantization" class="level5">
<h5 class="anchored" data-anchor-id="confirmation-of-quantization">Confirmation of Quantization</h5>
<ul>
<li>Schrödinger’s model, like Bohr’s, explained the <strong>quantized energy levels of electrons</strong>.</li>
<li><strong>Electrons can only jump between specific energy levels</strong> corresponding to integer multiples of the fundamental frequency.</li>
<li>This independently confirmed the quantization inherent in Bohr’s model.</li>
<li>Schrödinger shared the Nobel Prize in Physics with Paul Dirac in 1933.</li>
</ul>
</section>
</section>
<section id="understanding-atomic-models" class="level4">
<h4 class="anchored" data-anchor-id="understanding-atomic-models">Understanding Atomic Models</h4>
<section id="the-concept-of-physical-models" class="level5">
<h5 class="anchored" data-anchor-id="the-concept-of-physical-models">The Concept of Physical Models</h5>
<ul>
<li>The <strong>Bohr model</strong> (electrons in energy shells) and the <strong>Schrödinger model</strong> (standing waves) are both <strong>physical models</strong> of the atom.</li>
<li>The value of a model lies in its ability to <strong>accurately describe known phenomena and predict new ones</strong>.</li>
<li>Both models are successful in this regard.</li>
</ul>
</section>
<section id="the-real-picture-of-the-atom" class="level5">
<h5 class="anchored" data-anchor-id="the-real-picture-of-the-atom">The “Real” Picture of the Atom</h5>
<ul>
<li><strong>There is no single “real” picture of the atom</strong>.</li>
<li>Both models are useful representations that highlight different aspects of atomic behavior.</li>
</ul>
</section>
</section>
<section id="the-fates-of-bohr-and-schrödinger" class="level4">
<h4 class="anchored" data-anchor-id="the-fates-of-bohr-and-schrödinger">The Fates of Bohr and Schrödinger</h4>
<section id="bohrs-escape-from-denmark" class="level5">
<h5 class="anchored" data-anchor-id="bohrs-escape-from-denmark">Bohr’s Escape from Denmark</h5>
<ul>
<li>Bohr delayed leaving Nazi-occupied Denmark until it became critical.</li>
<li>He escaped to Sweden in a fishing boat, avoiding German minefields.</li>
<li>Fearing assassination, the British flew him to England in a <strong>Mosquito bomber</strong>, stripped of armaments and adapted for a passenger in the bomb bay.</li>
<li>Bohr’s large head prevented the flight helmet from fitting properly, and he missed the instruction to turn on his oxygen at high altitude.</li>
<li>The pilots descended to avoid endangering him, and Bohr survived the flight, reportedly getting his best sleep in months.</li>
</ul>
</section>
<section id="schrödinger-in-ireland" class="level5">
<h5 class="anchored" data-anchor-id="schrödinger-in-ireland">Schrödinger in Ireland</h5>
<ul>
<li>Schrödinger spent World War II in Dublin, Ireland, at the <strong>Institute for Advanced Studies</strong>, directing the School for Theoretical Physics.</li>
<li>His unconventional lifestyle (living with both his wife and mistress) was tolerated by the Irish.</li>
</ul>
</section>
</section>
<section id="conclusion-3" class="level4">
<h4 class="anchored" data-anchor-id="conclusion-3">Conclusion</h4>
<ul>
<li>The chapter highlights the development of quantum mechanics, its key figures, and its profound implications for understanding the atom.</li>
<li>It emphasizes the shift from classical physics to a quantum world where uncertainty and wave-particle duality are fundamental.</li>
<li>The story of Bohr’s escape and Schrödinger’s wartime refuge adds a human element to the scientific narrative.</li>
</ul>
</section>
</section>
<section id="chapter-5-breaking-open-the-atom" class="level3">
<h3 class="anchored" data-anchor-id="chapter-5-breaking-open-the-atom">Chapter 5: Breaking Open the Atom</h3>
<section id="the-dichotomy-of-physics" class="level4">
<h4 class="anchored" data-anchor-id="the-dichotomy-of-physics">The Dichotomy of Physics</h4>
<ul>
<li><strong>Physics</strong>, like many disciplines, frequently divides into opposing schools of thought.
<ul>
<li>Examples:
<ul>
<li>Arabic Spagyrus vs.&nbsp;Indian Chrysopaeus.</li>
<li>Newtonian astrophysicists vs.&nbsp;Einsteinian cosmologists.</li>
<li>Bosonic supersymmetric string theorists vs.&nbsp;Kaluza-Klein compactified M-theorists.</li>
</ul></li>
</ul></li>
<li>The most prominent division is between <strong>theorists</strong> and <strong>experimentalists</strong>.
<ul>
<li><strong>Theorists’ view of experimentalists:</strong> Mechanics, linear thinkers, unable to visualize four dimensions.</li>
<li><strong>Experimentalists’ view of theorists:</strong> Lazy, impractical, unable to perform basic lab tasks.</li>
</ul></li>
<li>Quantum mechanically, both perspectives hold some truth.</li>
</ul>
</section>
<section id="the-rise-of-theoretical-physics" class="level4">
<h4 class="anchored" data-anchor-id="the-rise-of-theoretical-physics">The Rise of Theoretical Physics</h4>
<ul>
<li><strong>1920s:</strong> Theorists seemingly held the dominant position in physics.</li>
<li><strong>Albert Einstein’s impact:</strong>
<ul>
<li><strong>Theories of relativity:</strong> Revolutionized physics, challenged Newtonian concepts, and popularized complex scientific ideas among the general public.</li>
<li><strong>Consequences:</strong> The public’s exposure to the intricacies of theoretical physics had unforeseen implications.</li>
</ul></li>
<li><strong>Niels Bohr’s contribution:</strong>
<ul>
<li><strong>Quantum mechanics:</strong> Explained phenomena at the subatomic level, but demanded a significant leap of faith due to its counterintuitive nature.</li>
</ul></li>
<li><strong>Need for experimental validation:</strong> As quantum mechanics delved into uncharted territory, experimental physics was crucial for grounding these theories in a semblance of reality.</li>
</ul>
</section>
<section id="the-search-for-the-neutron" class="level4">
<h4 class="anchored" data-anchor-id="the-search-for-the-neutron">The Search for the Neutron</h4>
<ul>
<li><strong>1920s:</strong> The structure of the <strong>atomic nucleus</strong> remained an enigma, as experimental physics entered a period of contemplation.</li>
<li><strong>Lord Ernest Rutherford’s Bakarian lecture (June 3rd, 1920):</strong>
<ul>
<li>Topic: <strong>Transmutation of nitrogen atoms</strong> using <strong>alpha particles</strong>.</li>
<li>Rutherford deviated from the main topic, raising a critical question about atomic weight discrepancies.</li>
</ul></li>
<li><strong>The Atomic Weight Problem:</strong>
<ul>
<li><strong>Established understanding:</strong> Atoms consist of <strong>electrons</strong> (negative charge) orbiting a <strong>nucleus</strong> composed of <strong>protons</strong> (positive charge). The number of protons and electrons is equal, resulting in a neutral atom.</li>
<li><strong>Discrepancy:</strong> Atomic weights of elements heavier than hydrogen did not align with the number of protons.
<ul>
<li>Example: Helium has two protons but weighs four times as much as hydrogen (which has one proton).</li>
<li>Further examples:
<ul>
<li>Nitrogen: 7 protons, atomic weight of 17.</li>
<li>Barium: 58 protons, atomic weight of 137.</li>
<li>Uranium: 92 protons, atomic weight of 238.</li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Rutherford’s hypothesis:</strong>
<ul>
<li>Proposed the existence of a neutral particle within the nucleus, which he called the <strong>neutron</strong>.</li>
<li><strong>Neutron properties:</strong>
<ul>
<li>No electrical charge.</li>
<li>Weight equivalent to a proton.</li>
<li>Ability to penetrate matter easily.</li>
<li>Undetectable by existing radiation detectors.</li>
</ul></li>
</ul></li>
<li><strong>The Elusive Neutron:</strong>
<ul>
<li>For 12 years after Rutherford’s lecture, experimentalists struggled to find the neutron.</li>
<li><strong>Erroneous assumption:</strong> The neutron was thought to be a proton with an embedded electron.</li>
<li><strong>Failed attempts:</strong> Efforts to create neutrons by bombarding hydrogen with electrons proved unsuccessful.</li>
</ul></li>
</ul>
</section>
<section id="james-chadwick-and-the-discovery-of-the-neutron" class="level4">
<h4 class="anchored" data-anchor-id="james-chadwick-and-the-discovery-of-the-neutron">James Chadwick and the Discovery of the Neutron</h4>
<ul>
<li><strong>James Chadwick (1891-):</strong>
<ul>
<li>Born in Bullington, Cheshire, England.</li>
<li>Studied physics at the University of Manchester, inspired by Rutherford’s lecture.</li>
<li>Obtained a Master of Science in Physics from the University of Cambridge.</li>
<li>Worked with Hans Geiger in Germany on the <strong>Geiger counter</strong>.</li>
<li><strong>World War I:</strong> Interned at Ruhleben POW camp in Germany.
<ul>
<li>Continued scientific pursuits even in captivity, investigating the ionization of phosphorus and the photochemical reaction of carbon monoxide and chlorine.</li>
</ul></li>
<li>Returned to England after the war and rejoined Rutherford’s team.</li>
</ul></li>
<li><strong>Chadwick’s Experiments:</strong>
<ul>
<li>Tasked with finding the neutron.</li>
<li>Began by bombarding various materials with <strong>alpha particles</strong>.</li>
<li><strong>Alpha particles:</strong> Helium nuclei, heavy and capable of causing nuclear disintegration.</li>
<li><strong>Beryllium anomaly:</strong>
<ul>
<li>When bombarded with alpha particles, beryllium emitted an unusually high intensity of <strong>gamma rays</strong> but no proton debris.</li>
</ul></li>
</ul></li>
<li><strong>The Role of Polonium-210:</strong>
<ul>
<li>Chadwick needed a strong <strong>polonium-210 alpha source</strong> (which emits alphas without gamma contamination) for his experiments.</li>
<li><strong>Irene Joliot-Curie</strong> and <strong>Frederic Joliot-Curie</strong> possessed the largest polonium-210 source at the time.</li>
</ul></li>
<li><strong>The Joliot-Curies’ Experiments (1931):</strong>
<ul>
<li>Used their alpha source and an <strong>ionization chamber</strong> to study beryllium’s response to alpha bombardment.</li>
<li><strong>Ionization chamber:</strong> A metal can filled with air and a central wire; ionizing events create a conductive trail, allowing for the detection and measurement of radiation.</li>
<li><strong>Cellophane experiment:</strong> Observed that gamma rays from beryllium, after passing through cellophane, caused a surge of protons in the detector.</li>
<li><strong>Conclusion:</strong> Attributed the proton emission to the gamma rays knocking protons out of the hydrogen in the cellophane.</li>
</ul></li>
<li><strong>Chadwick’s Reinterpretation:</strong>
<ul>
<li>Found the Joliot-Curies’ explanation implausible due to the significant mass difference between gamma rays and protons.</li>
<li>Obtained a large polonium-210 source from used radon ampoules.</li>
<li>Replicated the experiment using a beryllium target, paraffin sheet, and an ionization chamber.</li>
<li><strong>Chadwick’s deduction:</strong> The protons detected were not caused by gamma rays but by collisions with neutral particles of similar mass emitted from the beryllium – neutrons.</li>
</ul></li>
<li><strong>Chadwick’s Announcement:</strong>
<ul>
<li>Published “Possible Existence of a Neutron” in <em>Nature</em> (February 1932).</li>
<li>Presented his findings at the Kapitsa Club meeting.</li>
<li><strong>Impact:</strong> Chadwick’s discovery transformed physics and the world.</li>
</ul></li>
</ul>
</section>
<section id="leo-szilard-and-the-concept-of-nuclear-chain-reaction" class="level4">
<h4 class="anchored" data-anchor-id="leo-szilard-and-the-concept-of-nuclear-chain-reaction">Leo Szilard and the Concept of Nuclear Chain Reaction</h4>
<ul>
<li><strong>Leo Szilard (1898-1964):</strong>
<ul>
<li>A genius with a passion for physics and politics.</li>
<li>Born in Budapest, Hungary.</li>
<li>Studied engineering and later physics in Budapest and Berlin.</li>
<li>Received his doctorate from the Humboldt University in Berlin in 1923.</li>
<li>Fled to England in 1933 due to rising anti-Semitism in Germany.</li>
</ul></li>
<li><strong>Szilard’s Epiphany (September 12, 1933):</strong>
<ul>
<li>Read about Rutherford’s skepticism regarding nuclear power in <em>The Times</em>.</li>
<li>While crossing the street, Szilard conceived the idea of a <strong>nuclear chain reaction</strong>.</li>
</ul></li>
<li><strong>The Chain Reaction Concept:</strong>
<ul>
<li><strong>Neutron’s role:</strong> Neutrons, being uncharged, can penetrate nuclei easily.</li>
<li><strong>Nuclear instability:</strong> A neutron absorbed by a heavy, neutron-rich nucleus can induce instability.</li>
<li><strong>Nuclear fission:</strong> The unstable nucleus can split, releasing energy and more neutrons.</li>
<li><strong>Self-sustaining reaction:</strong> The released neutrons can trigger further fissions, creating a chain reaction.</li>
</ul></li>
<li><strong>Szilard’s Patent and Research:</strong>
<ul>
<li>Applied for a patent for a nuclear reactor in 1934 (assigned to the British Admiralty).</li>
<li>Immigrated to the United States in 1938.</li>
<li>Continued research, initially focusing on beryllium and indium, but without success.</li>
<li>Became disillusioned and wrote to the Admiralty to withdraw his patent application.</li>
</ul></li>
</ul>
</section>
<section id="otto-hahn-lise-meitner-and-the-discovery-of-nuclear-fission" class="level4">
<h4 class="anchored" data-anchor-id="otto-hahn-lise-meitner-and-the-discovery-of-nuclear-fission">Otto Hahn, Lise Meitner, and the Discovery of Nuclear Fission</h4>
<ul>
<li><strong>Otto Hahn (1879-1968):</strong>
<ul>
<li>Born in Frankfurt, Germany.</li>
<li>Studied chemistry and became a pioneer in <strong>radiochemistry</strong>.</li>
<li>Headed the radioactivity department of the Kaiser Wilhelm Institute of Chemistry in Berlin.</li>
</ul></li>
<li><strong>Lise Meitner (1878-1968):</strong>
<ul>
<li>A physicist from Vienna, Austria.</li>
<li>Collaborated with Hahn for 30 years.</li>
</ul></li>
<li><strong>Neutron Bombardment Experiments:</strong>
<ul>
<li>Hahn and Meitner systematically bombarded elements with neutrons, culminating with uranium.</li>
</ul></li>
<li><strong>Meitner’s Escape:</strong>
<ul>
<li>Meitner, being Jewish, had to flee Germany in 1938 due to the escalating Nazi threat.</li>
<li>Continued communication with Hahn through letters.</li>
</ul></li>
<li><strong>The Uranium Puzzle:</strong>
<ul>
<li>Hahn’s analysis of neutron-bombarded uranium yielded a puzzling radioactive isotope.</li>
<li>Initially suspected it to be radium, using barium as a carrier in fractional crystallization.</li>
</ul></li>
<li><strong>The Breakthrough:</strong>
<ul>
<li>Meitner realized that the product was not radium but barium itself.</li>
</ul></li>
<li><strong>Nuclear Fission:</strong>
<ul>
<li>Hahn had split the uranium atom, producing barium (slightly more than half the mass of uranium) and krypton (undetectable chemically).</li>
</ul></li>
<li><strong>Hahn’s Publications:</strong>
<ul>
<li>First paper (December 22, 1938): Cautiously reported the production of alkaline earth metals from uranium bombarded with neutrons.</li>
<li>Second paper: Reported the liberation of two free neutrons during fission.</li>
</ul></li>
<li><strong>Impact of the Discovery:</strong>
<ul>
<li>Generated immense excitement in the physics community, particularly for Szilard.</li>
<li>Szilard urged the British Admiralty to reinstate his patent application.</li>
</ul></li>
<li><strong>From Fantasy to Puzzle:</strong>
<ul>
<li>Nuclear power transitioned from a theoretical concept to a tangible possibility.</li>
<li>Experimentalists had validated Einstein’s prediction of mass-energy conversion.</li>
</ul></li>
<li><strong>The Remaining Question:</strong> The specific mechanism of how uranium converts mass into energy remained to be elucidated.</li>
</ul>
</section>
</section>
</section>
<section id="part-2-the-puzzle" class="level2">
<h2 class="anchored" data-anchor-id="part-2-the-puzzle">Part 2: The Puzzle</h2>
<section id="the-state-of-nuclear-engineering-in-the-1970s" class="level3">
<h3 class="anchored" data-anchor-id="the-state-of-nuclear-engineering-in-the-1970s">The State of Nuclear Engineering in the 1970s</h3>
<section id="a-technical-job-depression" class="level4">
<h4 class="anchored" data-anchor-id="a-technical-job-depression">A Technical Job Depression</h4>
<ul>
<li><strong>Technical Job Depression:</strong> The early 1970s faced a global technical job depression.
<ul>
<li><strong>NASA’s cancellation of the Apollo program:</strong> This resulted in a significant number of scientists and engineers losing their jobs.</li>
<li><strong>Rumors of highly qualified individuals in low-paying jobs:</strong> Physicists were said to be driving taxis and delivering pizzas due to job scarcity.</li>
<li><strong>Limited teaching opportunities:</strong> Even teaching positions in high schools were unavailable for physics graduates.</li>
</ul></li>
</ul>
</section>
<section id="graduate-school-as-a-last-resort" class="level4">
<h4 class="anchored" data-anchor-id="graduate-school-as-a-last-resort">Graduate School as a Last Resort</h4>
<ul>
<li><strong>Limited options:</strong> The job market forced many to consider graduate school.</li>
<li><strong>Nuclear engineering as a potential path:</strong> The author, a physics graduate, opted for a master’s in nuclear engineering, hoping for better job prospects.
<ul>
<li><strong>Hubris of a physics graduate:</strong> The author entered the program mid-curriculum without prerequisites, confident in their abilities.</li>
</ul></li>
</ul>
</section>
<section id="the-nuclear-landscape" class="level4">
<h4 class="anchored" data-anchor-id="the-nuclear-landscape">The Nuclear Landscape</h4>
<ul>
<li><strong>Light-water reactors:</strong> These were the dominant type of civilian nuclear reactors in the United States.
<ul>
<li><strong>Limited innovation:</strong> The design had reached a mature state, leaving little room for further development.</li>
</ul></li>
<li><strong>Fast breeder reactors:</strong> These represented the future of nuclear research and engineering.
<ul>
<li><strong>Plutonium-based:</strong> Breeder reactors utilized plutonium as fuel.</li>
<li><strong>Fuel breeding capability:</strong> They produced more fissionable fuel than they consumed, making them a potentially sustainable power source.</li>
</ul></li>
<li><strong>Fermi 1 meltdown:</strong> The first civilian breeder reactor, Fermi 1 in Michigan, experienced a meltdown in 1966 and was shut down in 1972.
<ul>
<li><strong>End of breeder reactor development:</strong> This incident marked the end of breeder reactor design and construction during the author’s career.</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-decline-of-heroic-nuclear-engineering" class="level3">
<h3 class="anchored" data-anchor-id="the-decline-of-heroic-nuclear-engineering">The Decline of Heroic Nuclear Engineering</h3>
<section id="a-coasting-field" class="level4">
<h4 class="anchored" data-anchor-id="a-coasting-field">A Coasting Field</h4>
<ul>
<li><strong>Loss of momentum:</strong> Despite advancements, nuclear engineering was losing its dynamism.</li>
<li><strong>End of an era:</strong> The time of groundbreaking discoveries and legendary figures like Enrico Fermi and Leo Szilard had passed.</li>
<li><strong>Decline in experimental research:</strong> The era of building innovative and potentially risky nuclear experiments was over.</li>
</ul>
</section>
<section id="the-afterglow-of-a-golden-age" class="level4">
<h4 class="anchored" data-anchor-id="the-afterglow-of-a-golden-age">The Afterglow of a Golden Age</h4>
<ul>
<li><strong>Witnessing the sunset:</strong> The author entered the field as the “golden age” of nuclear engineering was ending.</li>
<li><strong>Cancellation of ambitious projects:</strong> The Nerva nuclear rocket engine project, intended for a Mars mission, was canceled.</li>
<li><strong>Impact on faculty:</strong> Professors were often veterans of canceled projects like NERVA and SNAP, or even the Manhattan Project.</li>
</ul>
</section>
</section>
<section id="the-manhattan-project-and-its-legacy" class="level3">
<h3 class="anchored" data-anchor-id="the-manhattan-project-and-its-legacy">The Manhattan Project and Its Legacy</h3>
<section id="the-birth-of-nuclear-engineering" class="level4">
<h4 class="anchored" data-anchor-id="the-birth-of-nuclear-engineering">The Birth of Nuclear Engineering</h4>
<ul>
<li><strong>Manhattan Project:</strong> The atomic bomb project of World War II, the origin of nuclear engineering.</li>
<li><strong>Transition from theory to reality:</strong> Nuclear physics transformed from a theoretical concept to a practical, albeit destructive, technology.</li>
<li><strong>Solving the puzzle of power:</strong> The challenge of creating a powerful weapon from a laboratory effect was successfully addressed.</li>
</ul>
</section>
<section id="secrecy-and-silence" class="level4">
<h4 class="anchored" data-anchor-id="secrecy-and-silence">Secrecy and Silence</h4>
<ul>
<li><strong>Gaps in the record:</strong> Some aspects of the solutions and data remained classified.</li>
<li><strong>Reluctance to discuss details:</strong> Professors were hesitant to talk about the Manhattan Project or ongoing weapons research due to its sensitive nature.</li>
<li><strong>Cold War context:</strong> The ongoing ideological conflict with the Soviet Union maintained secrecy around nuclear weapon design.</li>
<li><strong>Varied responses to secrecy:</strong> Some professors were nervous, others frightened, and some simply tired of the secrecy surrounding the topic.</li>
</ul>
</section>
</section>
<section id="neb-kendrick-a-window-into-the-past" class="level3">
<h3 class="anchored" data-anchor-id="neb-kendrick-a-window-into-the-past">Neb Kendrick: A Window into the Past</h3>
<section id="a-source-of-war-stories" class="level4">
<h4 class="anchored" data-anchor-id="a-source-of-war-stories">A Source of War Stories</h4>
<ul>
<li><strong>Professor Neb Kendrick:</strong> A physics professor and former bomb assembler at Los Alamos, who shared his experiences with the author.</li>
<li><strong>Extensive experience:</strong> Kendrick had assembled various atomic bomb designs, including Little Boy, Fat Man, MK-6, and others.</li>
<li><strong>Firsthand witness to tests:</strong> He observed surface tests in Nevada, experiencing the shockwaves firsthand.</li>
<li><strong>Handling plutonium cores:</strong> Kendrick held plutonium cores, feeling the warmth from radiation.</li>
<li><strong>Knowledge of the X-unit:</strong> He had memorized the schematic design of the A-bomb firing circuit, known as the X-unit.</li>
</ul>
</section>
<section id="the-tx-9-nuclear-artillery-shell" class="level4">
<h4 class="anchored" data-anchor-id="the-tx-9-nuclear-artillery-shell">The TX-9 Nuclear Artillery Shell</h4>
<ul>
<li><strong>TX-9 Assembly:</strong> Kendrick assembled the TX-9 nuclear artillery shell for the Grable test in Nevada on May 25, 1953.</li>
<li><strong>Miniaturized Hiroshima bomb:</strong> The TX-9 was a uranium-fueled atomic bomb similar to the one used in Hiroshima, but designed to fit an 11-inch cannon shell.</li>
<li><strong>Gun-type design:</strong> It used a uranium projectile fired into a uranium target to achieve a hypercritical mass.</li>
<li><strong>Safety pins:</strong> Three steel pins prevented accidental detonation during handling by blocking the projectile’s movement.</li>
<li><strong>Arming mechanism:</strong> Centrifugal force during firing ejected the pins, arming the shell shortly after leaving the cannon.</li>
</ul>
</section>
<section id="the-grable-test" class="level4">
<h4 class="anchored" data-anchor-id="the-grable-test">The Grable Test</h4>
<ul>
<li><strong>High-velocity projectile:</strong> The TX-9 shell was fired at 2,000 feet per second with a high spin rate.</li>
<li><strong>Proximity of the firing crew:</strong> The crew was positioned only six miles from the detonation point.</li>
<li><strong>Ace of Spades experiment:</strong> Some crew members placed playing cards facing the blast to observe the effects of the flash.</li>
<li><strong>The Flash:</strong> The intense light from the explosion, even in daylight, burned out the black spades on the cards.</li>
<li><strong>The Shockwave:</strong> The ground-traveling shockwave distorted the earth significantly, making it impossible to see the end of the trench.</li>
<li><strong>“The very planet, indeed, quivered with implications”:</strong> A powerful statement reflecting the immense power and impact of the nuclear test.</li>
</ul>
</section>
</section>
<section id="chapter-1-a-fortuitous-condensation-of-genius" class="level3">
<h3 class="anchored" data-anchor-id="chapter-1-a-fortuitous-condensation-of-genius">Chapter 1: A Fortuitous Condensation of Genius</h3>
<section id="the-race-for-the-atomic-bomb-begins-1939" class="level4">
<h4 class="anchored" data-anchor-id="the-race-for-the-atomic-bomb-begins-1939">The Race for the Atomic Bomb Begins (1939)</h4>
<ul>
<li><strong>1939:</strong> The discovery of fission nine days prior to New Year’s Day sparked a race for the atomic bomb.</li>
<li>Physicists engaged in discussions, arguments, and research, creating a buzz of excitement, anticipation, and dread.</li>
</ul>
</section>
<section id="the-new-york-worlds-fair-1939" class="level4">
<h4 class="anchored" data-anchor-id="the-new-york-worlds-fair-1939">The New York World’s Fair (1939)</h4>
<ul>
<li><strong>April 30, 1939:</strong> The New York World’s Fair opened, showcasing the “materials, ideas, and forces” shaping the future.</li>
<li><strong>Focus:</strong> Technology and hope for the future.</li>
<li><strong>Notable Exhibitors:</strong>
<ul>
<li>RCA (television)</li>
<li>Bell Labs (Vocoder)</li>
</ul></li>
<li><strong>Participating Nations:</strong> Great Britain, Poland, Czechoslovakia, USSR, Palestine, and others.</li>
<li><strong>Germany’s Absence:</strong> Germany was absent, focusing on military applications of nuclear energy.</li>
</ul>
</section>
<section id="germanys-pursuit-of-nuclear-weapons" class="level4">
<h4 class="anchored" data-anchor-id="germanys-pursuit-of-nuclear-weapons">Germany’s Pursuit of Nuclear Weapons</h4>
<ul>
<li><strong>April 29, 1939:</strong> One day before the World’s Fair, Germany began investigating military uses of nuclear energy.</li>
<li><strong>Rationale:</strong>
<ul>
<li>Germany was where fission was discovered.</li>
<li>Germany had a strong scientific infrastructure.</li>
<li>Nuclear weapons aligned with Germany’s goal of world domination.</li>
</ul></li>
<li><strong>Key Players:</strong>
<ul>
<li>Paul Hartek (University of Hamburg): Contacted the army ordnance office.</li>
<li>Uranverein (Uranium Club): Formed by Georg Joos, Wilhelm Handler, and Reinhold Mankopf at the University of Göttingen.</li>
</ul></li>
</ul>
</section>
<section id="the-uranium-clubs-challenges-and-mistakes" class="level4">
<h4 class="anchored" data-anchor-id="the-uranium-clubs-challenges-and-mistakes">The Uranium Club’s Challenges and Mistakes</h4>
<section id="challenge-1-uranium-enrichment" class="level5">
<h5 class="anchored" data-anchor-id="challenge-1-uranium-enrichment"><strong>Challenge 1: Uranium Enrichment</strong></h5>
<ul>
<li><strong>Problem:</strong> Natural uranium contains very little fissile U-235 (less than 1%).</li>
<li><strong>Solution:</strong> Maximize the probability of fission using slow neutrons and a <strong>moderator</strong> to slow them down.</li>
</ul>
</section>
<section id="challenge-2-moderator-selection" class="level5">
<h5 class="anchored" data-anchor-id="challenge-2-moderator-selection"><strong>Challenge 2: Moderator Selection</strong></h5>
<ul>
<li><strong>Graphite:</strong>
<ul>
<li><strong>Theoretically Ideal:</strong> Light, solid, low neutron absorption probability.</li>
<li><strong>Practically Unsuitable:</strong> German industrial graphite was contaminated with boron, a strong neutron absorber.</li>
</ul></li>
<li><strong>Heavy Water (Deuterium Oxide):</strong>
<ul>
<li><strong>Chosen Moderator:</strong> Deuterium has a low probability of neutron capture.</li>
<li><strong>Production Issues:</strong> Difficult to produce in large quantities.</li>
<li><strong>Mistake 1:</strong> Dependence on a scarce material (heavy water).</li>
</ul></li>
</ul>
</section>
<section id="mistake-2-military-duty-interruption" class="level5">
<h5 class="anchored" data-anchor-id="mistake-2-military-duty-interruption"><strong>Mistake 2: Military Duty Interruption</strong></h5>
<ul>
<li><strong>August 1939:</strong> All able-bodied men, including the Uranium Club, were called to military duty.</li>
<li><strong>Consequence:</strong> Weeks of lost work time.</li>
</ul>
</section>
<section id="mistake-3-failed-research-council-meeting" class="level5">
<h5 class="anchored" data-anchor-id="mistake-3-failed-research-council-meeting"><strong>Mistake 3: Failed Research Council Meeting</strong></h5>
<ul>
<li><strong>February 26, 1942:</strong> A meeting to secure funding for the nuclear program failed.</li>
<li><strong>Reason:</strong> Physicists planned a luncheon with experimental food, deterring key decision-makers.</li>
<li><strong>Consequence:</strong> Further delays and fragmentation of the project.</li>
</ul>
</section>
<section id="mistake-4-the-brain-drain" class="level5">
<h5 class="anchored" data-anchor-id="mistake-4-the-brain-drain"><strong>Mistake 4: The Brain Drain</strong></h5>
<ul>
<li><strong>1930s:</strong> The Nazi regime purged Jewish scientists from universities and government programs.</li>
<li><strong>Consequence:</strong> Loss of top nuclear research talent, including:
<ul>
<li>Jewish Hungarians fleeing Soviet policies.</li>
<li>Native German Jewish scientists.</li>
</ul></li>
<li><strong>“Jewish Physics” vs.&nbsp;“Aryan Physics”:</strong>
<ul>
<li><strong>Aryan Physics:</strong> Classical physics taught in universities.</li>
<li><strong>Jewish Physics:</strong> Relativity and quantum mechanics, discouraged due to their association with Jewish scientists.</li>
<li><strong>Impact:</strong> Hindered progress in nuclear physics, which relies on relativity and quantum mechanics.</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-united-states-a-safe-haven-for-genius" class="level4">
<h4 class="anchored" data-anchor-id="the-united-states-a-safe-haven-for-genius">The United States: A Safe Haven for Genius</h4>
<ul>
<li><strong>Slow Start:</strong> The US initially lagged behind Europe in nuclear physics research, focusing on practical industrial research.</li>
<li><strong>The Edison Method:</strong> Favored trial and error over theoretical analysis.</li>
<li><strong>Transformation:</strong> Immigration of displaced European physicists transformed the US into a nuclear research hub.</li>
<li><strong>Key Immigrants:</strong>
<ul>
<li>Albert Einstein (1932)</li>
<li>Johnny von Neumann (1930)</li>
<li>E.P. Wigner (1930)</li>
<li>Hans Bethe (1935)</li>
<li>Edward Teller (1935)</li>
<li>Enrico Fermi (1938)</li>
<li>Leo Szilard (1938)</li>
<li>Niels Bohr (1943)</li>
</ul></li>
<li><strong>Factors Favoring the US:</strong>
<ul>
<li>Safe haven for immigrants.</li>
<li>Geographical isolation from Europe.</li>
<li>Strong industrial and university infrastructure.</li>
<li>“Foolish optimism” and a willingness to tackle ambitious projects.</li>
</ul></li>
</ul>
</section>
<section id="contrasting-approaches-germany-vs.-the-us" class="level4">
<h4 class="anchored" data-anchor-id="contrasting-approaches-germany-vs.-the-us">Contrasting Approaches: Germany vs.&nbsp;the US</h4>
<ul>
<li><strong>German “Realism”:</strong>
<ul>
<li>Believed developing a bomb would take at least four years.</li>
<li>Lacked the resources for a long war.</li>
<li>Focused on a quick victory.</li>
</ul></li>
<li><strong>American Enthusiasm:</strong>
<ul>
<li>Contagious optimism drove the effort.</li>
<li>Attracted British scientists to collaborate.</li>
</ul></li>
</ul>
</section>
<section id="enrico-fermis-contributions" class="level4">
<h4 class="anchored" data-anchor-id="enrico-fermis-contributions">Enrico Fermi’s Contributions</h4>
<section id="early-life-and-education" class="level5">
<h5 class="anchored" data-anchor-id="early-life-and-education"><strong>Early Life and Education</strong></h5>
<ul>
<li><strong>Born:</strong> September 29, 1901, in Rome, Italy.</li>
<li><strong>Family:</strong> Roman Catholic upbringing.</li>
<li><strong>Turning Point:</strong> His brother’s death sparked his interest in physics.</li>
<li><strong>Self-Education:</strong> Devoured physics books, including two volumes of “Elementary Mathematical Physics” written in Latin.</li>
<li><strong>Education:</strong> Earned undergraduate and doctoral degrees in physics from the Scuola Normale Superiore in Pisa.</li>
<li><strong>Göttingen Influence:</strong> Studied under Werner Heisenberg, developing a preference for rigorous simplicity in quantum mechanics.</li>
</ul>
</section>
<section id="research-in-italy" class="level5">
<h5 class="anchored" data-anchor-id="research-in-italy"><strong>Research in Italy</strong></h5>
<ul>
<li><strong>1926:</strong> Started nuclear physics research at the University of Rome La Sapienza.</li>
<li><strong>“The Pope”:</strong> Nickname given by his research team, the “Via Panasperna boys,” reflecting his authority in physics.</li>
<li><strong>Beta Decay Research (1933):</strong>
<ul>
<li>Completed a detailed study of beta decay.</li>
<li>Published “Tentavio di una teoria dei raggi beta,” introducing the first complete theory of beta decay.</li>
<li><strong>Initial Rejection:</strong> “Nature” rejected the paper, but later published it in 1939.</li>
</ul></li>
</ul>
</section>
<section id="beta-decay-explained" class="level5">
<h5 class="anchored" data-anchor-id="beta-decay-explained"><strong>Beta Decay Explained</strong></h5>
<ul>
<li><strong>Definition:</strong> A type of nuclear decay that changes the element of a nucleus while maintaining its mass.</li>
<li><strong>Types:</strong>
<ul>
<li><strong>Beta Minus Decay:</strong> A neutron converts to a proton, emitting an electron (beta particle) and an antineutrino.
<ul>
<li>Example: Lithium-8 decays into beryllium-8.</li>
</ul></li>
<li><strong>Beta Plus Decay:</strong> A proton converts to a neutron, emitting a positron (beta particle) and a neutrino.
<ul>
<li>Example: Carbon-11 decays into boron-11.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="neutron-activation-research" class="level5">
<h5 class="anchored" data-anchor-id="neutron-activation-research"><strong>Neutron Activation Research</strong></h5>
<ul>
<li><strong>Goal:</strong> Measured the interactions of neutrons with every element in the periodic table.</li>
<li><strong>Activation:</strong>
<ul>
<li><strong>Definition:</strong> The absorption of neutrons by atomic nuclei, leading to instability and radioactive decay.</li>
<li><strong>Examples:</strong>
<ul>
<li>Aluminum: Low sensitivity to activation.</li>
<li>Silver: High sensitivity to activation.</li>
</ul></li>
</ul></li>
<li><strong>The Wooden Bench Anomaly:</strong>
<ul>
<li><strong>Observation:</strong> Neutron activation of silver was higher on a wooden bench than on marble benches.</li>
<li><strong>Explanation:</strong> Hydrogen in the wood slowed down neutrons, increasing the probability of interaction with silver.</li>
</ul></li>
</ul>
</section>
<section id="slow-neutrons-and-fission" class="level5">
<h5 class="anchored" data-anchor-id="slow-neutrons-and-fission"><strong>Slow Neutrons and Fission</strong></h5>
<ul>
<li><strong>Key Finding:</strong> Slow neutrons have a higher probability of interacting with nuclei, including causing fission.</li>
<li><strong>Subatomic Interactions:</strong> All interactions at the quantum level are probabilistic.</li>
<li><strong>Slowing Down Neutrons:</strong> Increases the probability of interaction and fission.</li>
<li><strong>Fission:</strong>
<ul>
<li>When a slow neutron is absorbed by a U-235 nucleus, there’s a high probability of the nucleus becoming unstable and splitting (fission).</li>
</ul></li>
<li><strong>Fermi’s Near Miss:</strong> Fermi came close to discovering fission but didn’t win the Nobel for it.</li>
</ul>
</section>
<section id="nobel-prize-and-escape-to-the-us" class="level5">
<h5 class="anchored" data-anchor-id="nobel-prize-and-escape-to-the-us"><strong>Nobel Prize and Escape to the US</strong></h5>
<ul>
<li><strong>1938:</strong> Awarded the Nobel Prize in Physics for his work on slow neutrons.</li>
<li><strong>Escape from Fascism:</strong> Used the trip to Stockholm to flee Italy with his family due to rising anti-Semitism.</li>
</ul>
</section>
</section>
<section id="understanding-neutron-speeds-and-thermal-energy" class="level4">
<h4 class="anchored" data-anchor-id="understanding-neutron-speeds-and-thermal-energy">Understanding Neutron Speeds and Thermal Energy</h4>
<ul>
<li><strong>Fission Neutrons:</strong> Travel at high speeds (around 2 million electron volts).</li>
<li><strong>Thermal Neutrons:</strong> Neutrons slowed down to room temperature (0.025 electron volts) have a 1,000-fold increase in fission probability.</li>
</ul>
</section>
<section id="fermis-nuclear-reactor" class="level4">
<h4 class="anchored" data-anchor-id="fermis-nuclear-reactor">Fermi’s Nuclear Reactor</h4>
<ul>
<li><strong>Collaboration:</strong> Worked with Leo Szilard to build a <strong>nuclear reactor</strong>.</li>
<li><strong>Principle:</strong> Used a moderator to slow down neutrons and sustain a chain reaction of fission with low-grade uranium.</li>
<li><strong>Patent:</strong> Fermi and Szilard shared the patent for the nuclear reactor.</li>
</ul>
</section>
</section>
<section id="chapter-2-an-implied-threat-from-the-fatherland" class="level3">
<h3 class="anchored" data-anchor-id="chapter-2-an-implied-threat-from-the-fatherland">Chapter 2: An Implied Threat from the Fatherland</h3>
<section id="the-iraqi-situation-2003" class="level4">
<h4 class="anchored" data-anchor-id="the-iraqi-situation-2003">The Iraqi Situation (2003)</h4>
<ul>
<li><strong>Rumors and Warnings:</strong> Before the Iraq War, rumors, reports, books, and interviews with scientists and engineers escaping from Iraq warned the Western world of an impending crisis.
<ul>
<li>These individuals, seeking asylum, detailed <strong>nuclear activity</strong> in Iraq under a dictator seeking regional domination.</li>
<li>Concerns arose about <strong>Weapons of Mass Destruction (WMDs)</strong>, particularly nuclear weapons.</li>
</ul></li>
<li><strong>Evidence Gathering:</strong>
<ul>
<li>Material and equipment traffic into Iraq was monitored.</li>
<li>Satellite photos were studied.</li>
<li>Human intelligence sources were pressed for details.</li>
<li>The ejection of international inspectors intensified suspicion.</li>
</ul></li>
<li><strong>Limited Information and Suspicion:</strong>
<ul>
<li>Difficulty in assessing the situation in Iraq led to speculation and heightened suspense.</li>
<li>The <strong>World Trade Center attack in 2001</strong> fueled the belief that Iraq was developing an atomic bomb.</li>
</ul></li>
<li><strong>Invasion of Iraq:</strong>
<ul>
<li>The US Army, with support from Saudi Arabia, invaded Iraq.</li>
<li><strong>No evidence of atomic bomb-making capability was found.</strong></li>
</ul></li>
</ul>
</section>
<section id="the-german-situation-1939" class="level4">
<h4 class="anchored" data-anchor-id="the-german-situation-1939">The German Situation (1939)</h4>
<ul>
<li><strong>A Similar Situation:</strong> A comparable scenario unfolded in the United States in 1939.
<ul>
<li>President Roosevelt observed Europe and Asia preparing for another world war.</li>
<li>Refugee nuclear scientists from Europe arrived with warnings about Germany’s plans.</li>
</ul></li>
<li><strong>Hitler’s Ambitions and the “Ultimate Weapon”:</strong>
<ul>
<li>Adolf Hitler aimed to dominate Europe.</li>
<li>German scientists were reportedly developing a weapon capable of destroying an entire city – a <strong>uranium-based weapon</strong> utilizing the newly discovered <strong>fission process</strong>.</li>
</ul></li>
<li><strong>Refugee Advice and the Threat to the US:</strong>
<ul>
<li>Refugees from various countries had historically advised the US on invasions.</li>
<li>These European refugees presented a technical reason for intervention – the potential for Germany to use an ultimate weapon in the Western hemisphere.</li>
</ul></li>
<li><strong>Scientists’ Warnings:</strong>
<ul>
<li>Scientists like <strong>Leo Szilard</strong> issued dire warnings about the potential consequences of a German atomic bomb.</li>
</ul></li>
<li><strong>Germany’s Nuclear Program:</strong>
<ul>
<li>Information about Germany’s nuclear work ceased, creating suspicion.</li>
<li>Germany stopped the sale of uranium from Czechoslovakia.</li>
<li>This led to the assumption that Germany was building a bomb.</li>
</ul></li>
<li><strong>The US Response:</strong>
<ul>
<li>The resulting <strong>nuclear panic</strong> drove a crash program in the US to develop nuclear technology, prioritizing it over military action in the Pacific or Europe.</li>
</ul></li>
<li><strong>World War II and the Priority Shift:</strong>
<ul>
<li>The <strong>attack on Pearl Harbor on December 7, 1941</strong>, by Japan, formally brought the US into World War II.</li>
<li>Despite Japan’s attack, the US government prioritized defeating Germany.</li>
</ul></li>
<li><strong>Invasion of Germany:</strong>
<ul>
<li>The US invaded Germany from the west, using Great Britain as a staging area.</li>
<li><strong>No evidence of atomic bomb-making capability was found in Germany.</strong></li>
</ul></li>
<li><strong>The Atomic Bomb and the End of the War:</strong>
<ul>
<li>The US, having become a nuclear power, used its newly developed atomic bombs on Japan, ending the war.</li>
<li>The devastating impact of the atomic bombs introduced the world to the power and horror of nuclear weapons.</li>
</ul></li>
</ul>
</section>
<section id="leo-szilard-and-the-push-for-us-nuclear-research" class="level4">
<h4 class="anchored" data-anchor-id="leo-szilard-and-the-push-for-us-nuclear-research">Leo Szilard and the Push for US Nuclear Research</h4>
<ul>
<li><strong>Szilard’s Persuasive Abilities:</strong>
<ul>
<li><strong>Leo Szilard</strong> possessed exceptional persuasive skills, able to quickly assess individuals and convince them to act as he desired.</li>
</ul></li>
<li><strong>Szilard’s Early Research:</strong>
<ul>
<li>In 1939, Szilard established a lab at Columbia University and began experimenting with <strong>nuclear fission</strong> for power production.</li>
<li>He obtained uranium oxide from the <strong>Eldorado Radium Corporation</strong> and persuaded the <strong>National Carbon Company</strong> to produce high-purity graphite bricks.</li>
</ul></li>
<li><strong>The Need for Government Support:</strong>
<ul>
<li>Szilard realized that a large-scale effort, requiring government resources, was necessary to achieve <strong>self-sustained fission</strong>.</li>
</ul></li>
<li><strong>Fermi’s Meeting with the Navy:</strong>
<ul>
<li>Szilard arranged for <strong>Enrico Fermi</strong> to meet with the Navy Department on March 17, 1939, to discuss nuclear power.</li>
<li>The meeting, attended by naval officers and scientists, was unproductive.</li>
<li>Fermi’s lecture was not well-received, and he was unable to provide specifics about potential applications.</li>
<li>The meeting ended with no commitments from the Navy.</li>
</ul></li>
<li><strong>The Einstein-Szilard Letter:</strong>
<ul>
<li>Szilard, along with <strong>Eugene Wigner</strong> and <strong>Edward Teller</strong>, decided to write a letter to <strong>Queen Elizabeth of Belgium</strong> to prevent Germany from acquiring uranium from the Belgian Congo.</li>
<li>They sought <strong>Albert Einstein’s</strong> help due to his connection with the Queen.</li>
<li>On July 16, 1939, Szilard and Wigner met with Einstein, who agreed to write a letter to the Belgian ambassador, with a copy to the State Department.</li>
</ul></li>
<li><strong>Alexander Sachs and a Letter to Roosevelt:</strong>
<ul>
<li><strong>Alexander Sachs</strong>, an economist and friend of President Roosevelt, learned of Szilard’s plans and suggested writing directly to the President.</li>
<li>Szilard drafted a new letter, and on July 30, 1939, he, Einstein, and Teller finalized it.</li>
</ul></li>
<li><strong>The Letter’s Content:</strong>
<ul>
<li>The letter highlighted the potential of uranium as a new energy source and the possibility of creating a powerful bomb.</li>
<li>It warned of Germany’s potential development of such a weapon and urged the US to appoint an administrator and initiate its own research.</li>
</ul></li>
<li><strong>Sachs’ Meeting with Roosevelt:</strong>
<ul>
<li>Sachs delivered the letter to Roosevelt on October 11, 1939.</li>
<li>Instead of reading the letter, Sachs summarized its key points.</li>
<li>Roosevelt recognized the threat and initiated action.</li>
</ul></li>
<li><strong>The Uranium Committee:</strong>
<ul>
<li>The <strong>Uranium Committee</strong> was formed and held its first meeting on October 21, 1939.</li>
<li><strong>Dr.&nbsp;Lyman L. Briggs</strong> headed the committee, with representatives from the Army and Navy present.</li>
<li>Szilard and Wigner presented their case, but the Army representatives were skeptical.</li>
<li>Teller requested $6,000 for initial research, which was granted.</li>
</ul></li>
<li><strong>British Developments:</strong>
<ul>
<li>In February 1940, the British government received a report about potential German nuclear weapons research.</li>
<li>The <strong>Maud Committee</strong> was formed to evaluate the feasibility of nuclear power and weapons.</li>
<li>By December 1940, the Maud Committee concluded that a uranium bomb was feasible and could change the course of the war.</li>
<li>Recognizing their limited resources, they recommended collaboration with the US.</li>
<li>A report was sent to Briggs, but he locked it in his safe and forgot about it.</li>
</ul></li>
<li><strong>NDRC and Project S-1:</strong>
<ul>
<li><strong>Vannevar Bush</strong> formed the <strong>National Defense Research Committee (NDRC)</strong> in June 1940.</li>
<li>By July 1941, the NDRC absorbed the Uranium Committee, and the sustained fission initiative became <strong>Project S-1</strong>.</li>
<li>Bush appointed <strong>Arthur Compton</strong> as the director of S-1.</li>
</ul></li>
<li><strong>Pearl Harbor and the Escalation of the Project:</strong>
<ul>
<li>The Japanese attack on Pearl Harbor on December 7, 1941, officially brought the US into World War II.</li>
<li>Four days later, Germany declared war on the US.</li>
<li>These events led to the acceleration of the atomic bomb project.</li>
</ul></li>
</ul>
</section>
<section id="the-berkeley-effort-plutonium" class="level4">
<h4 class="anchored" data-anchor-id="the-berkeley-effort-plutonium">The Berkeley Effort: Plutonium</h4>
<ul>
<li><strong>A Parallel Threat:</strong> Another line of nuclear physics research was developing at the University of California, Berkeley.</li>
<li><strong>Quantum Mechanics and Nuclear Structure:</strong>
<ul>
<li><strong>Quantum mechanics</strong> provided a solid model of atomic structure.</li>
<li>Scientists applied quantum principles to understand the nucleus, composed of <strong>protons</strong> and <strong>neutrons</strong>.</li>
</ul></li>
<li><strong>Element 94:</strong>
<ul>
<li>Quantum mechanics predicted the existence of <strong>Element 94</strong>, a hypothetical element beyond uranium, which could be fissile.</li>
<li>The fissile isotope would be <strong>isotope 239</strong>.</li>
</ul></li>
<li><strong>Transmutation and Neutron Capture:</strong>
<ul>
<li><strong>Transmutation</strong> of elements was possible through nuclear decay and neutron capture.</li>
<li>Uranium could potentially be transmuted into Element 94 through neutron absorption.</li>
</ul></li>
<li><strong>Ernest O. Lawrence and the Cyclotron:</strong>
<ul>
<li><strong>Ernest O. Lawrence</strong> invented the <strong>cyclotron</strong>, a device that could accelerate particles to high speeds.</li>
<li>Lawrence built increasingly larger cyclotrons at Berkeley.</li>
<li>The cyclotron could produce neutrons by bombarding beryllium with deuterons.</li>
</ul></li>
<li><strong>Glenn Seaborg and the Synthesis of Element 94:</strong>
<ul>
<li><strong>Glenn Seaborg</strong> used Lawrence’s cyclotron to synthesize <strong>iodine-121</strong> and <strong>iron-59</strong>.</li>
<li>In August 1940, Seaborg attempted to synthesize Element 94.</li>
<li>On February 23, 1941, they isolated a unique alpha emitter, believed to be Element 94.</li>
<li>On February 26, 1941, they confirmed the synthesis of Element 94, which they named <strong>Plutonium (Pu)</strong>.</li>
</ul></li>
<li><strong>The Challenge of Plutonium Production:</strong>
<ul>
<li>Producing gram quantities of plutonium using the cyclotron would take an impractically long time.</li>
</ul></li>
<li><strong>The Need for a Nuclear Reactor:</strong>
<ul>
<li>A <strong>nuclear reactor</strong> was needed to produce a massive source of neutrons for converting U-238 into Pu-239.</li>
</ul></li>
<li><strong>Enrico Fermi and the First Nuclear Reactor:</strong>
<ul>
<li><strong>Enrico Fermi</strong> and his team at the University of Chicago built the first nuclear reactor in late 1942.</li>
<li>This reactor provided a neutron source for plutonium production and proved that nuclear reactions could be harnessed for power.</li>
</ul></li>
</ul>
</section>
<section id="chicago-pile-1-cp-1-the-first-self-sustaining-nuclear-reaction" class="level4">
<h4 class="anchored" data-anchor-id="chicago-pile-1-cp-1-the-first-self-sustaining-nuclear-reaction">Chicago Pile 1 (CP-1): The First Self-Sustaining Nuclear Reaction</h4>
<ul>
<li><strong>A Flawless Experiment:</strong> Fermi’s demonstration of controlled, sustained chain-reacting fission was a remarkably flawless experiment.</li>
<li><strong>The OSRD and Project S-1:</strong>
<ul>
<li>The NDRC evolved into the <strong>Office of Scientific Research and Development (OSRD)</strong>.</li>
<li>Arthur Compton continued to lead Project S-1.</li>
</ul></li>
<li><strong>Fermi’s Team and the Move to Chicago:</strong>
<ul>
<li>Fermi’s team conducted experiments at Columbia University before moving to Chicago for greater secrecy and space.</li>
<li>They chose an abandoned squash court under the West Stands of Stagg Field at the University of Chicago.</li>
</ul></li>
<li><strong>Construction of CP-1:</strong>
<ul>
<li>On November 16, 1942, Fermi’s team began constructing the <strong>“pile”</strong>, later known as <strong>Chicago Pile 1 (CP-1)</strong>.</li>
<li>CP-1 was a roughly spherical structure made of graphite bricks and uranium cylinders, with <strong>cadmium control rods</strong> to regulate the reaction.</li>
<li><strong>Neutron detectors</strong> and recording equipment were installed on a balcony overlooking the court.</li>
</ul></li>
<li><strong>The Experiment:</strong>
<ul>
<li>The experiment to achieve a self-sustaining reaction was scheduled for December 2, 1942.</li>
<li><strong>George Weil</strong> controlled a major control rod, while others stood by with cadmium salt solution and a fire axe as emergency measures.</li>
<li><strong>Norm Hilberry</strong> was prepared to cut a rope holding a <strong>“zip rod”</strong> for emergency shutdown.</li>
<li>Fermi, Compton, <strong>Herb Anderson</strong>, and <strong>Walter Zinn</strong> operated the control panel.</li>
<li><strong>Leona Woods</strong> was the only woman present and recorded the experiment in her notebook.</li>
</ul></li>
<li><strong>The Sequence of Events:</strong>
<ol type="1">
<li>At 9:45 a.m., the experiment began with the withdrawal of electrically driven control rods.</li>
<li>At 10:00 a.m., Zinn pulled out the gravity rod.</li>
<li>Fermi directed the withdrawal of the <strong>vernier control rod</strong> in stages, observing the neutron count rate.</li>
<li>At 11:35 a.m., the automatically actuated safety rod was accidentally triggered, shutting down the reaction prematurely.</li>
<li>Fermi called for a lunch break.</li>
<li>At 2:00 p.m., the experiment resumed.</li>
<li>At 3:20 p.m., Fermi called for further withdrawal of the vernier control rod.</li>
<li>At 3:52 p.m., Fermi announced that the <strong>reaction was self-sustaining</strong>, proving the feasibility of nuclear power.</li>
</ol></li>
<li><strong>Compton’s Phone Call:</strong>
<ul>
<li>Compton informed <strong>James B. Conant</strong>, head of the S-1 funding committee, about the success using a coded message: “The Italian navigator has landed in the New World.”</li>
</ul></li>
<li><strong>The Aftermath:</strong>
<ul>
<li>The pile was shut down, having produced power at a rate of half a watt.</li>
<li>The experiment marked a major milestone in nuclear physics and paved the way for the development of nuclear weapons and power plants.</li>
</ul></li>
</ul>
</section>
<section id="the-alsace-mission-and-the-german-nuclear-program" class="level4">
<h4 class="anchored" data-anchor-id="the-alsace-mission-and-the-german-nuclear-program">The Alsace Mission and the German Nuclear Program</h4>
<ul>
<li><strong>The Alsace Mission:</strong>
<ul>
<li>In 1945, as the war in Europe neared its end, the US sent the <strong>Alsace mission</strong> to investigate the status of the German atomic bomb project.</li>
</ul></li>
<li><strong>Disappointing Findings:</strong>
<ul>
<li>The mission discovered that Germany had abandoned its atomic bomb ambitions.</li>
<li>German scientists were conducting limited research in applied nuclear physics and attempting to build a <strong>heavy water moderated reactor</strong>.</li>
<li>The reactor experiment was moved to the beer cooling cellar of a castle in Heigerloch due to bombing raids.</li>
<li>The German reactor was far from operational size.</li>
<li>Upon learning of the approaching American forces, the German scientists hid the uranium and fled.</li>
</ul></li>
<li><strong>The Legacy of Heigerloch:</strong>
<ul>
<li>The Heigerloch reactor site is now a tourist attraction.</li>
</ul></li>
</ul>
</section>
</section>
<section id="chapter-3-a-jolt-in-the-dark" class="level3">
<h3 class="anchored" data-anchor-id="chapter-3-a-jolt-in-the-dark">Chapter 3: A Jolt in the Dark</h3>
<section id="the-transition-of-nuclear-physics" class="level4">
<h4 class="anchored" data-anchor-id="the-transition-of-nuclear-physics">The Transition of Nuclear Physics</h4>
<section id="world-war-ii-and-the-rise-of-secrecy" class="level5">
<h5 class="anchored" data-anchor-id="world-war-ii-and-the-rise-of-secrecy">World War II and the Rise of Secrecy</h5>
<ul>
<li><strong>World War II</strong> transformed nuclear physics from an open field to a military secret.</li>
<li>Journal publications ceased, and research moved from universities to <strong>secret laboratories</strong>.</li>
<li><strong>Strict security measures</strong> were implemented:
<ul>
<li>Personnel were relocated and sworn to secrecy.</li>
<li>Construction workers and laborers were unaware of the projects’ true nature.</li>
<li><strong>Code words</strong> replaced key terms (e.g., Uranium-235 became “ore alloy”).</li>
<li>Facilities were heavily guarded with barbed wire, watchtowers, and minefields.</li>
<li>Mail censorship, photography bans, and controlled documents were enforced.</li>
</ul></li>
<li>Examples of secrecy:
<ul>
<li>Robert Spruill, president of the University of California and administrator of a nuclear lab, was uninformed about the lab’s purpose.</li>
<li>Laura Fermi, Enrico Fermi’s wife, remained unaware of her husband’s work until after the war.</li>
<li>Counter-stories explained unusual events to the public.</li>
<li>Foreign scientists were monitored by the FBI.</li>
</ul></li>
<li>Despite the scale of the project, <strong>security was remarkably effective</strong>:
<ul>
<li>Germany and Japan remained unaware of the project.</li>
<li>Even Vice President Harry S. Truman was kept in the dark until FDR’s death.</li>
</ul></li>
<li><strong>Nuclear technology advanced rapidly</strong> in this secretive environment, transitioning from a theoretical topic to an industrial process in just three years.</li>
<li>The <strong>sudden unveiling of the atomic bomb</strong> at the end of the war shocked the world – a “jolt in the dark.”</li>
</ul>
</section>
<section id="soviet-espionage-and-response" class="level5">
<h5 class="anchored" data-anchor-id="soviet-espionage-and-response">Soviet Espionage and Response</h5>
<ul>
<li>The <strong>Soviets</strong>, masters of espionage, quickly deduced the American atomic bomb project.</li>
<li>The evidence was not direct communication, but the <strong>sudden absence of information</strong> in American physics journals.</li>
<li>Georgi Flerov alerted Joseph Stalin to this significant detail.</li>
<li>Two Soviet actions followed:
<ol type="1">
<li>Initiation of their own atomic bomb project, led by <strong>Igor Kurchatov</strong>, with research relocated to <strong>Serov</strong>.</li>
<li>Infiltration of the American project through <strong>espionage</strong>, which proved highly successful and aided the Soviets in their post-war bomb development.</li>
</ol></li>
</ul>
</section>
</section>
<section id="the-s-1-executive-committee-and-project-y" class="level4">
<h4 class="anchored" data-anchor-id="the-s-1-executive-committee-and-project-y">The S-1 Executive Committee and Project Y</h4>
<section id="the-bohemian-grove-meeting" class="level5">
<h5 class="anchored" data-anchor-id="the-bohemian-grove-meeting">The Bohemian Grove Meeting</h5>
<ul>
<li>On September 13, 1942, the <strong>S-1 Executive Committee</strong> held a crucial meeting to accelerate the atomic bomb project.</li>
<li>Attendees included:
<ul>
<li>Lyman Briggs (chairman)</li>
<li>James Conant (president of Harvard University)</li>
<li>Arthur Compton (physicist and Nobel laureate)</li>
<li>Ernest Lawrence (cyclotron expert from Berkeley)</li>
<li>Igor Murphree (petroleum chemist)</li>
<li>Harold Urey (chemist and Nobel laureate)</li>
</ul></li>
<li>The meeting took place at the <strong>Bohemian Club</strong> in Monte Rio, California, a secluded location chosen for its secrecy.</li>
<li>The club’s motto, “Weaving Spiders Come Not Here,” was ironically disregarded as the committee strategized.</li>
</ul>
</section>
<section id="the-british-mod-committee-report-and-its-implications" class="level5">
<h5 class="anchored" data-anchor-id="the-british-mod-committee-report-and-its-implications">The British Mod Committee Report and its Implications</h5>
<ul>
<li>The committee reviewed a report from the <strong>British Mod Committee</strong>, which had been kept secret since 1941.</li>
<li>The report revealed a crucial finding: <strong>fast fission</strong>.
<ul>
<li><strong>Fast neutrons</strong> (1 million electron volts) could also induce fission in U-235, occurring promptly without delay.</li>
</ul></li>
<li>This meant that bombs could be smaller and lighter, without requiring a bulky moderator.</li>
<li>Instead of a large graphite pile, a bomb could be made of pure U-235, the “size of a pineapple.”</li>
<li>The possibility of a practical atomic bomb became more realistic.</li>
</ul>
</section>
<section id="project-y-and-the-appointment-of-general-groves" class="level5">
<h5 class="anchored" data-anchor-id="project-y-and-the-appointment-of-general-groves">Project Y and the Appointment of General Groves</h5>
<ul>
<li>The committee established <strong>Project Y</strong>, a centralized laboratory dedicated to studying fast neutrons.</li>
<li>They selected <strong>Colonel Leslie Richard Groves</strong> to lead the project, seeking a disciplined military officer to manage the scientists.</li>
<li>Groves, a West Point graduate and experienced engineer (fresh off building the Pentagon), was promoted to <strong>Brigadier General</strong> and given unlimited resources.</li>
<li>The project was initially named “Laboratory for the Development of Substitute Materials,” but Groves changed it to <strong>Manhattan Engineering District</strong> (commonly known as the <strong>Manhattan Project</strong>).</li>
<li>Groves’ singular objective was to build and test the atomic bomb.</li>
</ul>
</section>
</section>
<section id="oak-ridge-the-manhattan-project-headquarters" class="level4">
<h4 class="anchored" data-anchor-id="oak-ridge-the-manhattan-project-headquarters">Oak Ridge: The Manhattan Project Headquarters</h4>
<section id="site-selection-and-development" class="level5">
<h5 class="anchored" data-anchor-id="site-selection-and-development">Site Selection and Development</h5>
<ul>
<li>Within a week of his appointment, Groves’ team acquired 52,000 acres in <strong>Oak Ridge, Tennessee</strong>.</li>
<li>The location was ideal:
<ul>
<li>Isolated and secure, between two mountain ranges.</li>
<li>Abundant electrical power from the Tennessee Valley Authority.</li>
</ul></li>
<li>The existing population was relocated, and prefabricated housing was installed, creating a secret city.</li>
<li>Oak Ridge became the <strong>Headquarters</strong> of the Manhattan Project, referred to as <strong>Site X</strong> or the <strong>Clinton Works</strong>.</li>
</ul>
</section>
<section id="groves-leadership-and-the-need-for-a-top-scientist" class="level5">
<h5 class="anchored" data-anchor-id="groves-leadership-and-the-need-for-a-top-scientist">Groves’ Leadership and the Need for a Top Scientist</h5>
<ul>
<li>General Groves’ decisive leadership expedited the project:
<ul>
<li>Decisions were made quickly, and budgets expanded dramatically.</li>
</ul></li>
<li>Groves recognized the need for a top scientist to manage the diverse team of experts.</li>
<li>He chose <strong>Dr.&nbsp;Julius Robert Oppenheimer</strong>, a theoretical physicist from Berkeley.</li>
</ul>
</section>
<section id="oppenheimers-security-clearance-and-contrasting-personalities" class="level5">
<h5 class="anchored" data-anchor-id="oppenheimers-security-clearance-and-contrasting-personalities">Oppenheimer’s Security Clearance and Contrasting Personalities</h5>
<ul>
<li>Oppenheimer’s security clearance was a concern due to his socialist leanings and connections to the Communist Party:
<ul>
<li>He subscribed to <em>People’s World</em> magazine.</li>
<li>His wife, mistress, brother, and others in his circle were Communist Party members.</li>
</ul></li>
<li>Despite this, Groves ensured Oppenheimer’s clearance was approved.</li>
<li><strong>Groves and Oppenheimer had contrasting personalities</strong>:
<ul>
<li><strong>Groves:</strong> Heavyset, military officer, engineer, direct, conservative, read the <em>World Almanac</em>.</li>
<li><strong>Oppenheimer:</strong> Thin, academic, theoretical physicist, chain-smoker, arrogant, left-leaning, read the <em>Bhagavad Gita</em> in Sanskrit.</li>
</ul></li>
<li>Despite their differences, they formed a highly effective team, driven by the shared goal of success.</li>
</ul>
</section>
</section>
<section id="los-alamos-site-y" class="level4">
<h4 class="anchored" data-anchor-id="los-alamos-site-y">Los Alamos: Site Y</h4>
<section id="site-selection-and-development-1" class="level5">
<h5 class="anchored" data-anchor-id="site-selection-and-development-1">Site Selection and Development</h5>
<ul>
<li>Oppenheimer chose the <strong>Los Alamos Ranch School</strong> in New Mexico for <strong>Site Y</strong>.</li>
<li>The location was isolated, secure, and familiar to Oppenheimer from his childhood summers.</li>
<li>The project acquired the school and its property, and Oppenheimer’s family moved into the administrator’s residence.</li>
<li>Existing buildings were repurposed, and new facilities were rapidly constructed.</li>
<li>Los Alamos became the ideal location for experimenting with explosives and dangerous materials.</li>
</ul>
</section>
<section id="bomb-design-concepts-hypercriticality-prompt-fission-and-fast-fission" class="level5">
<h5 class="anchored" data-anchor-id="bomb-design-concepts-hypercriticality-prompt-fission-and-fast-fission">Bomb Design Concepts: Hypercriticality, Prompt Fission, and Fast Fission</h5>
<ul>
<li>By the end of 1942, with Fermi’s reactor operational in Chicago and Los Alamos under development, a basic atomic bomb design emerged.</li>
<li>The bomb’s explosive power relied on three principles:
<ol type="1">
<li><strong>Hypercriticality:</strong> A state where the nuclear chain reaction rapidly escalates due to a large excess of fissile material.</li>
<li><strong>Prompt Fission:</strong> Utilizing only the neutrons released instantly during fission to ensure a rapid chain reaction.</li>
<li><strong>Fast Fission:</strong> Initiating fission with high-speed neutrons, eliminating the need for a moderator.</li>
</ol></li>
</ul>
</section>
</section>
<section id="the-dual-paths-to-the-bomb" class="level4">
<h4 class="anchored" data-anchor-id="the-dual-paths-to-the-bomb">The Dual Paths to the Bomb</h4>
<section id="path-1-the-uranium-bomb" class="level5">
<h5 class="anchored" data-anchor-id="path-1-the-uranium-bomb">Path 1: The Uranium Bomb</h5>
<ul>
<li>Path 1 focused on building a bomb using <strong>uranium</strong>.</li>
<li>The challenge was <strong>uranium enrichment</strong>, separating the fissile U-235 (0.7%) from the dominant U-238 (99.3%).</li>
<li>Chemical separation was impossible, as isotopes of the same element have identical chemical properties.</li>
<li>Isotope separation methods, like ultra-centrifuges and mass spectrometers, had only been used on a small scale.</li>
<li><strong>Oak Ridge</strong> became the center for large-scale isotope separation.</li>
<li>Path 1 was further divided into two parallel approaches:
<ul>
<li><strong>Path 1A: Calutrons (Y-12)</strong></li>
<li><strong>Path 1B: Gaseous Diffusion (K-25)</strong></li>
</ul></li>
</ul>
</section>
<section id="path-1a-calutrons-y-12" class="level5">
<h5 class="anchored" data-anchor-id="path-1a-calutrons-y-12">Path 1A: Calutrons (Y-12)</h5>
<ul>
<li><strong>Ernest Lawrence</strong> proposed using <strong>calutrons</strong>, large-scale mass spectrometers.</li>
<li>The process involved:
<ol type="1">
<li>Ionizing uranium metal.</li>
<li>Accelerating ions using an electrical charge.</li>
<li>Bending the ion path with a magnetic field.</li>
<li>Lighter U-235 ions would curve more sharply and hit a different target than U-238.</li>
</ol></li>
<li><strong>Groves approved Lawrence’s plan</strong>, despite its ambitious nature.</li>
<li><strong>Five alpha calutrons (racetracks)</strong> were built, achieving 12% enrichment.
<ul>
<li>Each racetrack was 122 feet long and 77 feet wide, containing 96 calutrons.</li>
<li>They relied heavily on the Tennessee Valley Authority’s power for the electromagnets.</li>
</ul></li>
<li><strong>“Z regulators”</strong> (voltage control systems) were operated by young women to maintain the magnetic field.</li>
<li><strong>Copper shortage</strong> for magnet windings was addressed by borrowing <strong>silver</strong> from the U.S. Treasury ($300 million worth).</li>
<li><strong>Calutrons proved inefficient</strong>: less than 5% of U-235 reached the target, the rest was contaminated.</li>
<li><strong>Beta calutrons</strong> were built for a second stage, reaching 80% enrichment.</li>
<li>By early 1945, they were producing enough enriched U-235 for a bomb, albeit with significant waste.</li>
</ul>
</section>
<section id="path-1b-gaseous-diffusion-k-25" class="level5">
<h5 class="anchored" data-anchor-id="path-1b-gaseous-diffusion-k-25">Path 1B: Gaseous Diffusion (K-25)</h5>
<ul>
<li><strong>Harold Urey</strong> championed the <strong>gaseous diffusion</strong> method.</li>
<li>The process exploited the slightly faster diffusion rate of lighter gas molecules through a permeable membrane.</li>
<li>The effect was small, requiring thousands of repetitions.</li>
<li><strong>Practical challenges</strong>:
<ul>
<li>Uranium had to be converted into gaseous <strong>uranium hexafluoride</strong>.</li>
<li>Uranium hexafluoride is highly reactive, requiring <strong>nickel</strong> for all components (pipes, valves, etc.).</li>
</ul></li>
<li><strong>K-25</strong> was a massive building, half a mile long and 1,000 feet wide, the largest in the world at the time.</li>
<li>15,000 people were involved in its construction and operation.</li>
<li><strong>K-25 did not reach full capacity during the war</strong> due to the time-consuming nature of diffusion.</li>
<li>However, it proved to be a more efficient and less wasteful process than calutrons.</li>
<li>The U.S. emerged from the war with the <strong>only uranium enrichment plant in the world</strong>, influencing future nuclear power development.</li>
</ul>
</section>
<section id="other-enrichment-efforts-s-50" class="level5">
<h5 class="anchored" data-anchor-id="other-enrichment-efforts-s-50">Other Enrichment Efforts: S-50</h5>
<ul>
<li>A third separation plant, the <strong>steam-powered thermal column cascade (S-50)</strong>, was also built at Oak Ridge.</li>
<li>This method, originally used by the Navy for a submarine engine project, was less efficient (0.15% enrichment).</li>
<li>Groves appropriated the equipment and had H.K. Ferguson construct the plant in 90 days.</li>
<li>In the final weeks before bomb assembly, Oppenheimer, desperate for enriched uranium, arranged the three processes in series:
<ul>
<li>S-50 (raw uranium to 0.85%) -&gt; K-25 (to 20%) -&gt; alpha calutrons -&gt; beta calutrons (to 82%).</li>
</ul></li>
</ul>
</section>
<section id="path-2-the-plutonium-bomb" class="level5">
<h5 class="anchored" data-anchor-id="path-2-the-plutonium-bomb">Path 2: The Plutonium Bomb</h5>
<ul>
<li>Path 2 aimed to create a bomb using <strong>plutonium-239 (Pu-239)</strong>, a man-made fissile isotope.</li>
<li>Pu-239 could be produced in large quantities using a scaled-up version of Fermi’s <strong>CP-1 graphite pile</strong>.</li>
<li>The process involved:
<ul>
<li>Running a nuclear reactor at high power.</li>
<li>U-238 in the fuel captures neutrons and transforms into neptunium-239, which decays into plutonium.</li>
</ul></li>
<li><strong>CP-1</strong> was disassembled and rebuilt as <strong>CP-2</strong> at Red Gate Woods near Chicago for further research.</li>
<li>A much larger reactor was designed for <strong>Site W (Hanford Works)</strong> in Washington State, near Richland.</li>
</ul>
</section>
<section id="hanford-works-plutonium-production-and-challenges" class="level5">
<h5 class="anchored" data-anchor-id="hanford-works-plutonium-production-and-challenges">Hanford Works: Plutonium Production and Challenges</h5>
<ul>
<li>The <strong>Hanford Works</strong> was a vast complex, primarily focused on plutonium production and chemical separation.</li>
<li><strong>B Reactor</strong>, the first production reactor, was housed in a gymnasium-sized building.
<ul>
<li>It used graphite bricks as a moderator and natural uranium slugs as fuel.</li>
<li>Water from the Columbia River was used for cooling.</li>
</ul></li>
<li><strong>E.I. DuPont de Nemours and Company</strong> engineered and operated the complex.</li>
<li><strong>B Reactor achieved criticality on September 26, 1944</strong>, with Enrico Fermi present.</li>
<li>However, <strong>the reactor shut down unexpectedly after an hour of high-power operation</strong>.</li>
<li><strong>John A. Wheeler</strong> identified the cause as <strong>xenon poisoning</strong>:
<ul>
<li><strong>Xenon-135</strong>, a fission product, is a powerful neutron absorber.</li>
<li>At high power, xenon-135 buildup absorbs enough neutrons to stop the chain reaction.</li>
</ul></li>
<li>Wheeler had anticipated a potential problem and insisted on extra fuel channels in the design, which proved crucial in overcoming xenon poisoning.</li>
<li>Subsequent reactors (D and F) were built with the enhanced design, and B Reactor was modified.</li>
<li>By April 1945, <strong>plutonium production was underway</strong>, and the material was shipped to Los Alamos.</li>
</ul>
</section>
</section>
<section id="los-alamos-bomb-design-and-development" class="level4">
<h4 class="anchored" data-anchor-id="los-alamos-bomb-design-and-development">Los Alamos: Bomb Design and Development</h4>
<section id="oppenheimers-team-and-the-los-alamos-ant-farm" class="level5">
<h5 class="anchored" data-anchor-id="oppenheimers-team-and-the-los-alamos-ant-farm">Oppenheimer’s Team and the Los Alamos “Ant Farm”</h5>
<ul>
<li>Oppenheimer assembled a brilliant team of scientists at Los Alamos, including:
<ul>
<li>Enrico Fermi</li>
<li>Hans Bethe</li>
<li>Edward Teller</li>
<li>Stanislaw Ulam</li>
<li>Seth Neddermeyer</li>
<li>George Kistiakowsky</li>
</ul></li>
<li>He also recruited technicians and specialists in various fields (chemistry, explosives, etc.).</li>
<li>Notably absent were Leo Szilard (who refused to relocate) and Isidor Isaac Rabi (prioritizing radar development).</li>
<li>Oppenheimer secured equipment from universities, including Harvard’s cyclotron and Wisconsin’s Van de Graaff accelerators.</li>
<li>The Los Alamos facility’s construction was seemingly chaotic, hampered by security restrictions and Oppenheimer’s clashes with the Army Corps of Engineers (e.g., over tree removal).</li>
<li>Despite the apparent disorder, the facility took shape rapidly, resembling an “ant farm” in its organization.</li>
</ul>
</section>
<section id="the-los-alamos-primer-and-the-theoretical-division" class="level5">
<h5 class="anchored" data-anchor-id="the-los-alamos-primer-and-the-theoretical-division">The Los Alamos Primer and the Theoretical Division</h5>
<ul>
<li>In April 1945, a <strong>short course</strong> was held to brief incoming scientists on the project’s goals and progress.</li>
<li>The course, taught by <strong>Robert Serber</strong>, took place in the Technical Area Library amidst ongoing construction.</li>
<li><strong>Hans Bethe</strong>, a German physicist, headed the <strong>theoretical division</strong>.
<ul>
<li>Initially skeptical about the possibility of a fission bomb, Bethe later calculated the critical mass of U-235.</li>
</ul></li>
<li><strong>Edward Teller</strong> served as the “idea man,” proposing numerous bomb concepts, often far ahead of their time.</li>
</ul>
</section>
<section id="the-gun-type-bomb-design-thin-man-and-little-boy" class="level5">
<h5 class="anchored" data-anchor-id="the-gun-type-bomb-design-thin-man-and-little-boy">The Gun-Type Bomb Design: Thin Man and Little Boy</h5>
<ul>
<li>The initial bomb design, called <strong>Thin Man</strong>, used a <strong>cannon barrel</strong> to assemble a hypercritical mass:
<ul>
<li>A cylinder of fissile material was propelled by an explosive charge to collide with another cylinder at the end of the barrel.</li>
</ul></li>
<li>The Navy conducted drop tests of Thin Man models, but they exhibited poor aerodynamic characteristics.</li>
<li><strong>The discovery of plutonium-240 (Pu-240) in the Hanford plutonium posed a major problem</strong>:
<ul>
<li>Pu-240’s tendency to pre-detonate rendered the gun-type design unsuitable for plutonium.</li>
</ul></li>
<li>The uranium-based Thin Man design was shortened to 10 feet and renamed <strong>Little Boy</strong>.</li>
<li>Little Boy showed improved flight characteristics in drop tests.</li>
</ul>
</section>
<section id="the-implosion-bomb-design-fat-man" class="level5">
<h5 class="anchored" data-anchor-id="the-implosion-bomb-design-fat-man">The Implosion Bomb Design: Fat Man</h5>
<ul>
<li><strong>Seth Neddermeyer</strong> proposed the <strong>implosion</strong> concept:
<ul>
<li>Compressing a subcritical sphere of fissile material to hypercriticality using explosives.</li>
</ul></li>
<li>Oppenheimer put Neddermeyer in charge of implosion research.</li>
<li>Initial attempts to shape explosive charges for implosion were unsuccessful.</li>
<li><strong>George Kistiakowsky</strong>, an explosives expert from Harvard, was brought in and appointed head of the implosion group.</li>
<li><strong>John von Neumann</strong> contributed to the complex mathematical modeling of the implosion process.</li>
<li>The implosion bomb design, called <strong>Fat Man</strong>, took shape as a sphere of explosives surrounding a plutonium core.</li>
</ul>
</section>
<section id="conclusion-4" class="level5">
<h5 class="anchored" data-anchor-id="conclusion-4">Conclusion</h5>
<ul>
<li>Both paths to the atomic bomb, uranium (Little Boy) and plutonium (Fat Man), achieved success.</li>
<li>The Manhattan Project, driven by the urgency of war and the brilliance of its scientists and engineers, had overcome numerous technical challenges to create the world’s first atomic bombs.</li>
</ul>
</section>
</section>
</section>
<section id="chapter-4-a-light-at-the-mouth-of-the-tunnel" class="level3">
<h3 class="anchored" data-anchor-id="chapter-4-a-light-at-the-mouth-of-the-tunnel">Chapter 4: A Light at the Mouth of the Tunnel</h3>
<section id="the-manhattan-projects-security-blanket-and-its-holes" class="level4">
<h4 class="anchored" data-anchor-id="the-manhattan-projects-security-blanket-and-its-holes">The Manhattan Project’s Security Blanket and Its Holes</h4>
<section id="the-illusion-of-impenetrable-security" class="level5">
<h5 class="anchored" data-anchor-id="the-illusion-of-impenetrable-security">The Illusion of Impenetrable Security</h5>
<ul>
<li>By 1944, the Manhattan Project was progressing smoothly and rapidly, seemingly without major obstacles.</li>
<li>Key figures like <strong>Oppenheimer</strong> (losing weight), <strong>Groves</strong> (gaining weight), and <strong>Szilard</strong> (under surveillance) appeared to be operating within the expected parameters.</li>
<li>A strict security blanket aimed to conceal all nuclear activities from:
<ul>
<li>Axis enemies</li>
<li>Non-British allies</li>
<li>Taxpayers not involved in the project</li>
<li>Most personnel working on the project</li>
</ul></li>
</ul>
</section>
<section id="the-cleve-cartmill-affair-a-potential-security-breach" class="level5">
<h5 class="anchored" data-anchor-id="the-cleve-cartmill-affair-a-potential-security-breach">The Cleve Cartmill Affair: A Potential Security Breach?</h5>
<ul>
<li><strong>The Cleve Cartmill Affair</strong>, an incident in FBI history, raised concerns about a potential security leak.</li>
<li><strong>John W. Campbell, Jr.</strong>, editor of <em>Astounding Science Fiction</em>, tasked <strong>Cleve Cartmill</strong> with writing a story about atomic weapons.
<ul>
<li>Campbell, a physics graduate from Duke University, considered himself a nuclear scientist.</li>
<li>He insisted on plausible science in the stories published in his magazine.</li>
</ul></li>
<li>Cartmill’s story, titled “<strong>Deadline</strong>”, was published in the March 1944 issue.</li>
<li>The story featured:
<ul>
<li>A terrifying super bomb built using uranium, beryllium, and radium.</li>
<li>Details about U-235 separation methods and quantities.</li>
<li>A fuse mechanism resembling the “Little Boy” bomb’s design.</li>
<li>Suspiciously coded names and places (e.g., Sixa powers, Yanomre, Yatal, Nilrek, Yabor Sibrof, Scylla, Syksa).</li>
</ul></li>
</ul>
</section>
<section id="the-fbi-investigation-and-its-findings" class="level5">
<h5 class="anchored" data-anchor-id="the-fbi-investigation-and-its-findings">The FBI Investigation and Its Findings</h5>
<ul>
<li>Similarities between “Deadline” and the Manhattan Project triggered an investigation by the War Department’s counterintelligence corps and the FBI.</li>
<li>The FBI discreetly interrogated Cartmill through his mail carrier, who was a science fiction enthusiast.
<ul>
<li>Cartmill revealed he wasn’t proud of the story and considered himself a nuclear physics authority despite the story’s flaws.</li>
</ul></li>
<li>The FBI visited Campbell and insisted on pulling the magazine from newsstands.
<ul>
<li>Campbell defended the story as fiction, claimed credit for its scientific accuracy, and argued that removing it would signal the existence of an atomic bomb project.</li>
</ul></li>
<li>The FBI ultimately deemed Campbell and Cartmill semi-innocent but reminded Campbell about the <strong>Code of Wartime Practices</strong>, prohibiting mention of atomic research.
<ul>
<li>They threatened to revoke his periodicals-rate postage permit if similar incidents occurred again.</li>
</ul></li>
</ul>
</section>
<section id="the-case-of-don-gordon-harmer-unintentional-revelation-through-freight-bills" class="level5">
<h5 class="anchored" data-anchor-id="the-case-of-don-gordon-harmer-unintentional-revelation-through-freight-bills">The Case of Don Gordon Harmer: Unintentional Revelation through Freight Bills</h5>
<ul>
<li><strong>Don Gordon Harmer</strong>, a freight rate examiner for the U.S. General Accounting Office, stumbled upon clues about the Manhattan Project while reviewing railroad shipping bills.</li>
<li>He noticed a bill for 14,700 pounds of silver wire wound into magnets, shipped to an obscure location in Tennessee with no rail access.
<ul>
<li>The shipment was billed at the precious metals rate, despite being transported on flat cars without security measures typical for silver bullion.</li>
</ul></li>
<li>Harmer argued that the silver should be billed as electrical machinery, saving the Manhattan Project $29.4 million.</li>
<li>Based on his knowledge of electrical engineering and physics, Harmer deduced that the magnets were likely for a mass spectrometer or cyclotron used in isotope separation at a secret location.</li>
</ul>
</section>
</section>
<section id="the-vexing-case-of-dr.-leo-szilard" class="level4">
<h4 class="anchored" data-anchor-id="the-vexing-case-of-dr.-leo-szilard">The Vexing Case of Dr.&nbsp;Leo Szilard</h4>
<section id="szilards-change-of-heart-and-growing-opposition" class="level5">
<h5 class="anchored" data-anchor-id="szilards-change-of-heart-and-growing-opposition">Szilard’s Change of Heart and Growing Opposition</h5>
<ul>
<li><strong>Dr.&nbsp;Leo Szilard</strong>, initially a strong advocate for atomic bombing, had a change of heart after Germany’s surrender in April 1945.</li>
<li>He began circulating a petition at Los Alamos arguing against using the bomb on Japan.</li>
<li>Szilard proposed:
<ul>
<li>A demonstration of the bomb’s power on an uninhabited island or to a Japanese delegation.</li>
<li>Sharing atomic bomb research results with the Soviet Union, then an ally of the United States.</li>
</ul></li>
</ul>
</section>
<section id="groves-response-and-surveillance" class="level5">
<h5 class="anchored" data-anchor-id="groves-response-and-surveillance">Groves’ Response and Surveillance</h5>
<ul>
<li><strong>General Groves</strong> found Szilard irritating, counterproductive, and potentially influential on other scientists.</li>
<li>Groves considered Szilard’s actions as detrimental to the project’s progress.</li>
<li>While he might have preferred to eliminate Szilard, Groves recognized the potential negative impact on other scientists.</li>
<li>Instead, Groves ordered close surveillance of Szilard to ensure he wasn’t contacting the Soviets and received daily reports on his activities.</li>
</ul>
</section>
</section>
<section id="the-little-boy-bomb-design-challenges-and-solutions" class="level4">
<h4 class="anchored" data-anchor-id="the-little-boy-bomb-design-challenges-and-solutions">The Little Boy Bomb: Design Challenges and Solutions</h4>
<section id="the-critical-mass-question" class="level5">
<h5 class="anchored" data-anchor-id="the-critical-mass-question">The Critical Mass Question</h5>
<ul>
<li>The <strong>Little Boy</strong> bomb, using uranium, was a simpler design with fewer unknowns compared to the plutonium bomb.</li>
<li>A crucial question remained: <strong>What was the exact amount of U-235 needed for an explosive reaction?</strong>
<ul>
<li>Underestimation would prevent the chain reaction.</li>
<li>Overestimation could lead to premature detonation.</li>
</ul></li>
<li>Limited experience with pure U-235 made this a challenging question to answer.</li>
</ul>
</section>
<section id="moving-from-a-spherical-to-a-cylindrical-core" class="level5">
<h5 class="anchored" data-anchor-id="moving-from-a-spherical-to-a-cylindrical-core">Moving from a Spherical to a Cylindrical Core</h5>
<ul>
<li>The ideal shape for a bomb core (plutonium or uranium) was a <strong>sphere</strong> due to its optimal surface area-to-volume ratio, minimizing neutron leakage.</li>
<li>However, the uncertainty about the critical mass made designing a bomb mechanism with a spherical core impractical.</li>
<li>The solution was to use a <strong>cylindrical</strong> core.
<ul>
<li>The cylinder’s length could be adjusted as the critical mass calculations became more precise, while maintaining a constant diameter of 6 inches.</li>
</ul></li>
</ul>
</section>
<section id="core-construction-and-detonation-mechanism" class="level5">
<h5 class="anchored" data-anchor-id="core-construction-and-detonation-mechanism">Core Construction and Detonation Mechanism</h5>
<ul>
<li>The core was assembled from stackable <strong>disks</strong> (thick washers) made of U-235.
<ul>
<li>Fine adjustments were possible by adding or removing thin U-235 shims.</li>
</ul></li>
<li>The core was hollow, with a 4-inch hole down the center line.</li>
<li>Detonation involved bringing together the 6-inch hollow cylinder and a 4-inch cylindrical plug, both assembled from disks and individually subcritical.</li>
<li>The final specifications for the Little Boy core were:
<ul>
<li>Mass of U-235: 64.15 kg</li>
<li>Enrichment: 82.68%</li>
</ul></li>
</ul>
</section>
<section id="correcting-misconceptions-about-the-gun-mechanism" class="level5">
<h5 class="anchored" data-anchor-id="correcting-misconceptions-about-the-gun-mechanism">Correcting Misconceptions about the Gun Mechanism</h5>
<ul>
<li>Contrary to common depictions, the <strong>annulus</strong> (outer cylinder), not the center cylinder, was the projectile in the gun barrel.</li>
<li>Eight pounds of slotted-tube <strong>cordite</strong> propelled the annulus down the 6.5-inch smoothbore gun barrel towards a <strong>tungsten carbide</strong> anvil.</li>
<li>The inner cylinder was bolted to the anvil.</li>
<li>Upon impact, the outer cylinder engulfed the target disks, creating a hypercritical cylinder for a brief moment, triggering the explosion.</li>
<li>This design allowed for adjustments to the axial dimension and was relatively straightforward to model mathematically.</li>
</ul>
</section>
<section id="safety-concerns-and-mitigation" class="level5">
<h5 class="anchored" data-anchor-id="safety-concerns-and-mitigation">Safety Concerns and Mitigation</h5>
<ul>
<li>The Little Boy bomb was inherently dangerous and prone to accidental detonation, especially if dropped on its nose during transport.</li>
<li>To prevent accidental detonation, <strong>three copper studs</strong> were screwed into the gun barrel in front of the core to prevent it from sliding forward.
<ul>
<li>These studs would shear off during the intended detonation.</li>
</ul></li>
</ul>
</section>
</section>
<section id="otto-frisch-and-the-dragon-experiments" class="level4">
<h4 class="anchored" data-anchor-id="otto-frisch-and-the-dragon-experiments">Otto Frisch and the Dragon Experiments</h4>
<section id="frischs-initial-approach-moderated-uranium-bars" class="level5">
<h5 class="anchored" data-anchor-id="frischs-initial-approach-moderated-uranium-bars">Frisch’s Initial Approach: Moderated Uranium Bars</h5>
<ul>
<li><strong>Otto Frisch</strong>, a neutron physics specialist from Britain, took on the task of determining the critical mass of uranium for the Little Boy.</li>
<li>He mixed enriched uranium powder with powdered plastic (rich in hydrogen) to act as a <strong>moderator</strong>, allowing him to achieve criticality with a smaller mass of uranium.</li>
<li>Frisch stacked the uranium-plastic bars in a beryllium box and used a neutron source to excite the assembly, monitoring radiation levels with a Geiger counter.</li>
<li>He discovered that his body’s hydrogen acted as a reflector, bringing the assembly close to criticality when he leaned over it.</li>
</ul>
</section>
<section id="the-guillotine-dragon-experiment" class="level5">
<h5 class="anchored" data-anchor-id="the-guillotine-dragon-experiment">The Guillotine (Dragon) Experiment</h5>
<ul>
<li>Recognizing the dangers of his initial approach, Frisch developed a new experimental setup called the <strong>guillotine</strong>, later renamed the <strong>dragon</strong>.</li>
<li>The experiment involved:
<ul>
<li>A 10-foot-high steel gantry with aluminum guide rails.</li>
<li>Uranium bars stacked on a table with a hole for the guide rails.</li>
<li>Dropping a block of uranium through the hole to briefly achieve supercriticality with the stacked bars.</li>
</ul></li>
<li><strong>Richard Feynman</strong> humorously compared the experiment to “tickling the tail of a sleeping dragon.”</li>
</ul>
</section>
<section id="frischs-legacy" class="level5">
<h5 class="anchored" data-anchor-id="frischs-legacy">Frisch’s Legacy</h5>
<ul>
<li>Frisch successfully completed his criticality measurements for the Little Boy core on April 12, 1945.</li>
<li>He survived his dangerous work and went on to lead the Atomic Energy Research Establishment in Harwell, England, and teach at Cambridge.</li>
</ul>
</section>
</section>
<section id="harry-daghlian-and-the-plutonium-core" class="level4">
<h4 class="anchored" data-anchor-id="harry-daghlian-and-the-plutonium-core">Harry Daghlian and the Plutonium Core</h4>
<section id="the-fat-mans-implosion-design" class="level5">
<h5 class="anchored" data-anchor-id="the-fat-mans-implosion-design">The Fat Man’s Implosion Design</h5>
<ul>
<li>The <strong>Fat Man</strong> bomb (model Y-1561), fueled by plutonium, relied on an <strong>implosion</strong> mechanism to achieve criticality.</li>
<li>The design involved:
<ul>
<li>5,300 pounds of high explosive surrounding the plutonium core in two layers.</li>
<li>An outer layer of fast-burning <strong>Composition B2</strong> (60% RDX, 39% TNT, 1% wax) cast into 32 segments with concave lenses to direct the blast inward.</li>
<li>Lens cavities filled with slow-burning <strong>baritol-70</strong> (70% barium nitrate, 30% TNT).</li>
<li>An inner layer of Composition B2, also cast into 32 segments, to amplify the shockwave.</li>
</ul></li>
</ul>
</section>
<section id="daghlians-criticality-experiment-and-tragic-accident" class="level5">
<h5 class="anchored" data-anchor-id="daghlians-criticality-experiment-and-tragic-accident">Daghlian’s Criticality Experiment and Tragic Accident</h5>
<ul>
<li><strong>Harry K. Daghlian, Jr.</strong>, a 24-year-old physicist, worked on determining the critical mass for the Fat Man’s plutonium core.</li>
<li>On August 21, 1945, after the Fat Man had been used and the war was over, Daghlian conducted a dangerous experiment in the Omega site’s 49 room.</li>
<li>He manually moved blocks of tungsten carbide (WC) close to a 6.2 kg plutonium core to find the point of criticality.</li>
<li>While stacking WC bricks around the plutonium sphere, Daghlian noticed a surge in radiation levels when he held the last brick over the core.</li>
<li>The brick slipped from his grip and fell into the center of the setup, causing a criticality incident.</li>
<li>Daghlian instinctively knocked the brick away with his right hand but received a massive dose of radiation.</li>
<li>He died 21 days later from radiation burns and poisoning, becoming the first person to die from the effects of nuclear fission.</li>
</ul>
</section>
</section>
<section id="the-trinity-test-the-dawn-of-the-atomic-age" class="level4">
<h4 class="anchored" data-anchor-id="the-trinity-test-the-dawn-of-the-atomic-age">The Trinity Test: The Dawn of the Atomic Age</h4>
<section id="the-decision-to-test-and-site-selection" class="level5">
<h5 class="anchored" data-anchor-id="the-decision-to-test-and-site-selection">The Decision to Test and Site Selection</h5>
<ul>
<li>By July 1945, the Fat Man’s design was finalized, and a test was deemed necessary due to its complexity and reliance on untested technologies.</li>
<li>The <strong>Trinity</strong> (TR) test was scheduled for July 16, 1945, at the <strong>Alamogordo bombing range</strong> in the New Mexico desert.</li>
<li><strong>Norris E. Bradbury</strong> oversaw the test preparations.</li>
<li>An abandoned ranch house served as the final assembly shop for the bomb.</li>
<li>Instruments and cameras were set up to record the event.</li>
<li>A 60-foot tower held the bomb, and bunkers were constructed for observers at various distances.</li>
</ul>
</section>
<section id="test-preparations-and-weather-delays" class="level5">
<h5 class="anchored" data-anchor-id="test-preparations-and-weather-delays">Test Preparations and Weather Delays</h5>
<ul>
<li><strong>Jumbo</strong>, a 240-ton steel canister, was initially intended to contain the plutonium in case of a fizzle but was ultimately placed 800 yards away as an observation target.</li>
<li>A cover story about an ammunition dump explosion was prepared for public release.</li>
<li>The bomb was assembled, winched to the top of the tower, and wired for detonation.</li>
<li>Scientists gathered and placed bets on the test’s outcome, with predictions ranging from a dud to atmospheric ignition.</li>
<li><strong>Jack M. Hubbard</strong>, the meteorologist, warned of an approaching rainstorm, leading to a delay and threats from Groves.</li>
</ul>
</section>
<section id="the-detonation-and-its-impact" class="level5">
<h5 class="anchored" data-anchor-id="the-detonation-and-its-impact">The Detonation and Its Impact</h5>
<ul>
<li>At 5:29:45 a.m. local time, the Trinity test was initiated.</li>
<li>The detonation produced an intensely bright light, visible for 150 miles, followed by a powerful shockwave felt up to 200 miles away.</li>
<li>The blast created a 1,100-foot-wide crater, melted sand into glass, and generated a mushroom cloud that rose 7.5 miles high.</li>
<li>Jumbo was heavily damaged but survived.</li>
</ul>
</section>
<section id="oppenheimers-reaction-and-the-aftermath" class="level5">
<h5 class="anchored" data-anchor-id="oppenheimers-reaction-and-the-aftermath">Oppenheimer’s Reaction and the Aftermath</h5>
<ul>
<li>The Trinity test was a resounding success, with a yield of 21 kilotons of TNT (84 trillion joules).</li>
<li>Oppenheimer expressed mixed emotions of pride, accomplishment, and concern for humanity’s future, famously saying, “We have known sin.”</li>
<li><strong>General Thomas Farrell</strong> declared, “The war is over,” recognizing the significance of the event.</li>
</ul>
</section>
</section>
<section id="the-birth-of-the-atomic-age-and-its-implications" class="level4">
<h4 class="anchored" data-anchor-id="the-birth-of-the-atomic-age-and-its-implications">The Birth of the Atomic Age and Its Implications</h4>
<ul>
<li>The Trinity test marked the beginning of the <strong>Atomic Age</strong>.</li>
<li>The subsequent decades witnessed rapid advancements in nuclear science, technology, and applications, along with significant funding and research efforts.</li>
<li>Nuclear power’s development was unconventional, starting with a powerful demonstration before peaceful applications were fully explored.</li>
<li>The analogy of gasoline’s first use being napalm highlights the potential for destructive applications to overshadow the beneficial ones.</li>
</ul>
</section>
</section>
<section id="chapter-5-post-war-planning" class="level3">
<h3 class="anchored" data-anchor-id="chapter-5-post-war-planning">Chapter 5: Post-War Planning</h3>
<section id="the-aftermath-of-the-trinity-test-japans-surrender" class="level4">
<h4 class="anchored" data-anchor-id="the-aftermath-of-the-trinity-test-japans-surrender">The Aftermath of the Trinity Test &amp; Japan’s Surrender</h4>
<section id="assessing-the-situation-and-preparing-for-the-atomic-bombing-of-japan" class="level5">
<h5 class="anchored" data-anchor-id="assessing-the-situation-and-preparing-for-the-atomic-bombing-of-japan">Assessing the Situation and Preparing for the Atomic Bombing of Japan</h5>
<ul>
<li><strong>Thomas Farrell</strong> was correct in stating that on July 16, 1945, the war was over in theory, as Japan had not yet surrendered.</li>
<li>Farrell and <strong>Deke Parsons</strong> flew to <strong>Tinian Island</strong> to begin preparations for the atomic bombing of Japan.
<ul>
<li>This effort was codenamed <strong>Project Alberta</strong>.</li>
</ul></li>
<li>Technical glitches still needed to be resolved.
<ul>
<li>For maximum effectiveness, an atomic bomb needed to be detonated 2,000 feet above the ground.</li>
<li>The trigger signal for both bombs would be provided by <strong>ARCHIs</strong> (redundant RT-34-APS-13 tail-warning radars).
<ul>
<li>ARCHIs were used in fighter planes to warn pilots of approaching aircraft from behind.</li>
<li>Built by RCA, one ARCHI cost as much as a new Cadillac limousine.</li>
<li>Four ARCHIs would be used in each bomb, each providing an opinion of the bomb’s height above ground.</li>
<li>If any two Archies agreed that the bomb had passed 2,000 feet, the firing circuit would be closed.</li>
</ul></li>
<li>To prevent confusion from Japanese air search radar, the Archies would be turned off until the bomb had fallen to 17,000 feet.
<ul>
<li>The turn-on altitude would be determined by six voting aneroid barometric switches.</li>
</ul></li>
<li>The bomb run altitude of the plane would be 31,000 feet.</li>
</ul></li>
<li><strong>Pumpkin runs</strong> (tests over the ocean using dummy bombs) revealed problems with the barometers due to shock waves around the bomb case.
<ul>
<li>These problems would be addressed.</li>
</ul></li>
</ul>
</section>
<section id="tinian-island-the-busiest-airbase-in-the-world" class="level5">
<h5 class="anchored" data-anchor-id="tinian-island-the-busiest-airbase-in-the-world">Tinian Island: The Busiest Airbase in the World</h5>
<ul>
<li><strong>Tinian</strong> was a former sugar plantation located five miles southwest of Saipan and within easy reach of Japan for B-29 bombers.</li>
<li>In July 1945, Tinian was the busiest airbase in the world.
<ul>
<li>It had six 8,500-foot runways and 40,000 personnel.</li>
<li>B-29s were constantly taking off and landing, conducting incendiary bombing raids on Japan.</li>
</ul></li>
<li>Over half a million people had been killed in the firebombing campaign, and Tokyo was essentially destroyed.
<ul>
<li>Dropping an atomic bomb on Tokyo would not provide any meaningful data.</li>
</ul></li>
<li>Planners had intentionally left some large cities untouched to assess the effects of an atomic bomb on an undamaged city.
<ul>
<li><strong>Kyoto</strong> was initially the top target but was removed from the list at the insistence of Secretary of War <strong>Henry Stimson</strong>.</li>
<li><strong>Hiroshima</strong>, a port city near the southern end of Honshu, became the primary target.
<ul>
<li>Hiroshima was home to Mitsubishi Heavy Industries, Hiroshima shipyards, Second Army Headquarters, and the Hiroshima Ordnance Supply Depot, making it an ideal target.</li>
</ul></li>
<li><strong>Kokura</strong> was designated as the secondary target in case Hiroshima was obscured by clouds.</li>
</ul></li>
</ul>
</section>
<section id="the-potsdam-declaration-and-trumans-order" class="level5">
<h5 class="anchored" data-anchor-id="the-potsdam-declaration-and-trumans-order">The Potsdam Declaration and Truman’s Order</h5>
<ul>
<li>On July 28, 1945, the United States, Great Britain, and China issued the <strong>Potsdam Declaration</strong>, outlining the terms for Japan’s surrender.</li>
<li>Japanese Prime Minister Admiral Baron <strong>Kentaro Suzuki</strong> responded with <strong>Mokusatsu</strong> (contemptuous silence).</li>
<li>President <strong>Harry S. Truman</strong> interpreted this as a rejection and ordered the use of nuclear weapons against Japan until they surrendered unconditionally.
<ul>
<li>This decision aimed to prevent a costly American ground invasion.</li>
</ul></li>
</ul>
</section>
<section id="preparing-the-509th-composite-group-and-the-atomic-bombs" class="level5">
<h5 class="anchored" data-anchor-id="preparing-the-509th-composite-group-and-the-atomic-bombs">Preparing the 509th Composite Group and the Atomic Bombs</h5>
<ul>
<li>Tinian Island was equipped with a special bomb-loading pit and an air-conditioned cleanroom for assembling the <strong>Little Boy</strong> and <strong>Fat Man</strong> bombs.</li>
<li>The <strong>509th Composite Group</strong> and the <strong>313th Bombardment Wing, 21 Bomber Command</strong> had trained extensively on handling the atomic weapons without knowing their exact nature.</li>
<li>A set of new B-29s were modified to carry the atomic bombs.</li>
<li>Colonel <strong>Paul W. Tibbets, Jr.</strong>, commander of the 509th, named the first plane <strong>Enola Gay</strong> after his mother.
<ul>
<li>The plane’s markings (a big R in a circle on the tail and 82 on the side) were meaningless and intended to confuse the enemy.</li>
</ul></li>
</ul>
</section>
<section id="assembling-little-boy" class="level5">
<h5 class="anchored" data-anchor-id="assembling-little-boy">Assembling Little Boy</h5>
<ul>
<li>Parts for Little Boy arrived in Tinian in small batches and required assembly.</li>
<li>The nosepiece, <strong>Old Faithful</strong>, was a 5,000-pound, high-alloy steel forging chosen for its durability after surviving four drop tests.</li>
<li>The armor plates for the sides had to be adjusted due to warping during heat treatment.</li>
<li>The uranium target disks arrived on July 28th.</li>
<li>On July 31st, the assembly was completed, and final electrical tests were conducted.</li>
<li>Bad weather over Japan delayed the bombing mission.</li>
</ul>
</section>
<section id="japans-internal-struggle-and-the-soviet-declaration-of-war" class="level5">
<h5 class="anchored" data-anchor-id="japans-internal-struggle-and-the-soviet-declaration-of-war">Japan’s Internal Struggle and the Soviet Declaration of War</h5>
<ul>
<li>The Imperial Court in Japan considered surrender but was concerned about the “unconditional” term.</li>
<li>Japanese ambassador <strong>Naotaki Sato</strong> in Moscow was tasked with seeking Soviet mediation for an acceptable end to the war.
<ul>
<li>Japan aimed to retain captured territories.</li>
</ul></li>
<li>On August 5th, the weather cleared, and Tibbets and his crew prepared the Enola Gay, loaded with Little Boy.</li>
<li>Deke Parsons insisted on accompanying the mission to perform the final bomb assembly in the air.</li>
<li>The Enola Gay took off at 2:45 a.m. on August 6th, followed by an instrument plane and a camera plane.
<ul>
<li>They rendezvoused over Iwo Jima before proceeding to Hiroshima.</li>
</ul></li>
</ul>
</section>
<section id="the-bombing-of-hiroshima" class="level5">
<h5 class="anchored" data-anchor-id="the-bombing-of-hiroshima">The Bombing of Hiroshima</h5>
<ul>
<li>The mission proceeded smoothly and on schedule.</li>
<li>At 7:09 a.m. Hiroshima time, an air raid warning was issued, but it was disregarded by many as it was for only one B-29 (the weather plane).</li>
<li>At 7:25 a.m., the weather plane reported less than three-tenths cloud cover at all altitudes.</li>
<li>At 7:31 a.m., the all-clear siren sounded in Hiroshima.</li>
<li>At 8:12 a.m., the three planes were spotted, triggering another air raid siren, which was largely ignored.</li>
<li>At 8:15:17 a.m., the Enola Gay, aligned with the <strong>Aioi Bridge</strong> in the city center, released Little Boy.</li>
<li>Exactly 44.4 seconds later, Little Boy detonated, obliterating Hiroshima.</li>
<li>The B-29 was hit by the shockwave, followed by a second shockwave reflected from the ground.
<ul>
<li>The crew could taste the radiation burst, described as a fizzing sensation and the taste of lead.</li>
</ul></li>
<li>The burst temperature exceeded one million degrees Celsius, igniting the air and vaporizing matter on the ground.</li>
<li>The bomb exploded approximately 900 feet southwest of the aiming point, directly above the <strong>Shima Surgical Hospital</strong>, which was completely destroyed.</li>
<li>After the 840-foot fireball dissipated, a firestorm engulfed the city.</li>
<li>A four-year survey concluded in 1995 confirmed 87,833 deaths.</li>
<li>The uranium bomb’s energy yield was estimated at 16 kilotons of TNT.</li>
</ul>
</section>
<section id="aftermath-of-the-hiroshima-bombing" class="level5">
<h5 class="anchored" data-anchor-id="aftermath-of-the-hiroshima-bombing">Aftermath of the Hiroshima Bombing</h5>
<ul>
<li>The Japanese government was initially confused by the destruction of Hiroshima, as communication with the Second Army Headquarters was lost.</li>
<li>Hiroshima’s electrical power consumption dropped to zero at 8:16 a.m.</li>
<li>Survivors with severe burns were found miles south of the city, recounting bizarre experiences.</li>
<li>On August 8th, the United States dropped leaflets warning of further attacks unless Japan surrendered unconditionally.</li>
</ul>
</section>
<section id="the-soviet-invasion-of-manchuria-and-the-bombing-of-nagasaki" class="level5">
<h5 class="anchored" data-anchor-id="the-soviet-invasion-of-manchuria-and-the-bombing-of-nagasaki">The Soviet Invasion of Manchuria and the Bombing of Nagasaki</h5>
<ul>
<li>On August 9th at 4:00 a.m., Tokyo learned that the Soviet Union had broken the Neutrality Pact, declared war on Japan, and invaded Manchuria.</li>
<li>At 7:50 a.m., an air raid siren sounded in <strong>Nagasaki</strong> but was a false alarm.</li>
<li>At 8:30 a.m., the all-clear was given.</li>
<li>At 10:53 a.m., two B-29s, <strong>Boxcar</strong> and <strong>The Great Artiste</strong>, were sighted but were mistaken for weather planes.</li>
<li>Captain <strong>Kermit Beahan</strong>, the bombardier on Boxcar, faced multiple problems.
<ul>
<li>They initially attempted to bomb the primary target, Kokura, but it was obscured by clouds.</li>
<li>A fuel transfer pump malfunction limited their fuel reserves.</li>
<li>They diverted to the secondary target, Nagasaki, but had difficulty seeing the ground.</li>
</ul></li>
<li>Despite a prohibition against using radar for bomb aiming, Beahan resorted to it to avoid ditching the bomb in the ocean.</li>
<li>At 11:00 a.m. Nagasaki time, radar operator <strong>James F. Van Pelt Jr.</strong> identified the high school soccer field in the <strong>Urakami Valley</strong> on the radar scope.</li>
<li>At 11:02 a.m., Fat Man was released.</li>
<li>The bomb detonated approximately 300 feet northwest of the soccer field, destroying the industrial north end of Nagasaki, including the Shiroyama Elementary School and the Shinzei Gakkan High School.</li>
<li>The energy yield was 21 kilotons of TNT.</li>
<li>Boxcar barely made it back, landing on Okinawa with minimal fuel.</li>
<li>Another 80,000 Japanese people died in Nagasaki.</li>
</ul>
</section>
<section id="japans-surrender" class="level5">
<h5 class="anchored" data-anchor-id="japans-surrender">Japan’s Surrender</h5>
<ul>
<li><strong>General Groves</strong> had another Fat Man bomb ready if needed.</li>
<li>Following the destruction of Nagasaki, the Japanese government accepted the reality of defeat.</li>
<li>After a period of internal conflict, Emperor <strong>Hirohito</strong> announced Japan’s surrender in a radio broadcast on August 15, 1945.
<ul>
<li>This was the first time the emperor’s voice had been broadcast to the public.</li>
</ul></li>
<li>The war officially ended.</li>
</ul>
</section>
</section>
<section id="the-dawn-of-the-atomic-age-and-the-quest-for-bigger-bombs" class="level4">
<h4 class="anchored" data-anchor-id="the-dawn-of-the-atomic-age-and-the-quest-for-bigger-bombs">The Dawn of the Atomic Age and the Quest for Bigger Bombs</h4>
<section id="public-release-of-the-smyth-report" class="level5">
<h5 class="anchored" data-anchor-id="public-release-of-the-smyth-report">Public Release of the Smyth Report</h5>
<ul>
<li>The United States government had spent two billion dollars on the Manhattan Project, a secret endeavor.</li>
<li>Days after the war ended, the government released the <strong>Smyth Report</strong> (“Atomic Energy for Military Purposes”), revealing most of the project’s details to the public.</li>
<li>This marked the beginning of the <strong>atomic age</strong>.</li>
</ul>
</section>
<section id="edward-teller-and-the-super-bomb" class="level5">
<h5 class="anchored" data-anchor-id="edward-teller-and-the-super-bomb">Edward Teller and the Super Bomb</h5>
<ul>
<li><strong>Edward Teller</strong> advocated for the development of a more powerful bomb (the “<strong>super bomb</strong>”).</li>
<li>Teller was born in Budapest, Austria-Hungary in 1908 and experienced the communist dictatorship of <strong>Béla Kun</strong>.
<ul>
<li>This fostered a deep animosity towards communism in Teller.</li>
</ul></li>
<li>Teller’s family was terrorized by soldiers searching for hidden currency.</li>
<li>The communist regime was replaced by the fascist <strong>Miklós Horthy</strong>, leading to further oppression.</li>
<li>Teller escaped to Germany, then to Copenhagen to work with <strong>Niels Bohr</strong>, and finally to the United States in 1935 with the help of <strong>George Gamow</strong>.</li>
<li>Teller held professorships at George Washington University and Columbia University before joining the Manhattan Project at Los Alamos.</li>
<li>At Los Alamos, Teller was disruptive, pushing for his super bomb and refusing to work on implosion calculations.
<ul>
<li><strong>Klaus Fuchs</strong>, a British physicist brought in to perform the calculations, turned out to be a Soviet spy, providing valuable information to the USSR.</li>
<li>Other Soviet spies were also present at Los Alamos.</li>
</ul></li>
</ul>
</section>
<section id="post-war-los-alamos-and-the-daniels-pile-project" class="level5">
<h5 class="anchored" data-anchor-id="post-war-los-alamos-and-the-daniels-pile-project">Post-War Los Alamos and the Daniels Pile Project</h5>
<ul>
<li>After the war, Los Alamos experienced a sense of letdown and inactivity.
<ul>
<li>Scientists left to resume their previous positions.</li>
<li>Technicians were laid off.</li>
<li>There was a delayed sense of shock at the war’s devastation.</li>
</ul></li>
<li>Interest in Teller’s super bomb was minimal.</li>
<li>At Oak Ridge, the <strong>Monsanto Chemical Company</strong> took over the uranium enrichment facilities, with <strong>Dr.&nbsp;Farrington Daniels</strong> as the new director.</li>
<li>The <strong>K-25 plant</strong> continued producing bomb-grade uranium despite no immediate plans for another Little Boy bomb.</li>
<li>Daniels proposed building the first civilian nuclear reactor power plant at Oak Ridge in 1946, known as the <strong>Daniels Pile</strong>.
<ul>
<li>The Army approved the project, and work began immediately.</li>
</ul></li>
</ul>
</section>
<section id="the-knowles-atomic-power-lab-and-the-problem-of-uranium" class="level5">
<h5 class="anchored" data-anchor-id="the-knowles-atomic-power-lab-and-the-problem-of-uranium">The Knowles Atomic Power Lab and the Problem of Uranium</h5>
<ul>
<li>The <strong>General Electric Company</strong> established the <strong>Knowles Atomic Power Lab</strong> in Schenectady, New York, in 1946.</li>
<li>Their initial project was to design a nuclear-powered naval destroyer, funded by the Bureau of Ships.</li>
<li>Existing reactor technology was too large for shipboard use and needed miniaturization.</li>
<li>Two major problems hindered development:
<ul>
<li><strong>Uranium shortage:</strong> The United States lacked uranium mines, and stockpiles were limited.</li>
<li><strong>Lack of nuclear engineers:</strong> The field was non-existent, with mostly nuclear physicists involved.</li>
</ul></li>
<li>Physicists envisioned power reactors as <strong>breeders</strong>, using depleted uranium (U-238) to produce plutonium fuel, addressing the uranium shortage.</li>
<li>They focused on complex designs with liquid metal coolants, magnetohydrodynamic pumps, and plutonium-fueled cores using fast neutron fission.</li>
</ul>
</section>
<section id="hyman-rickover-and-the-nuclear-submarine-project" class="level5">
<h5 class="anchored" data-anchor-id="hyman-rickover-and-the-nuclear-submarine-project">Hyman Rickover and the Nuclear Submarine Project</h5>
<ul>
<li><strong>Hyman George Rickover</strong>, a Navy captain, observed the struggles of the Daniels Pile and Knowles projects.</li>
<li>Rickover was born in Mokover, Russian-controlled Poland, in 1900 to a Jewish family.</li>
<li>His family fled to the United States in 1905 to escape persecution.</li>
<li>Rickover grew up in Chicago, working hard and lacking leisure time.</li>
<li>He met Congressman <strong>Adolph Sabbath</strong> at the 1916 Republican National Convention, leading to his appointment to the United States Naval Academy in 1918.</li>
<li>Rickover graduated from the Naval Academy in 1922 and served on various ships, including destroyers and submarines.</li>
<li>His experience on <strong>S-boats</strong> (primitive submarines) exposed him to the dangers and limitations of the technology.</li>
<li>Rickover envisioned a new type of submarine powered by a nuclear reactor, eliminating the need for air and exhaust.
<ul>
<li>He named his dream submarine <strong>Nautilus</strong>, after Captain Nemo’s vessel in “20,000 Leagues Under the Sea.”</li>
</ul></li>
</ul>
</section>
<section id="rickovers-design-philosophy-and-the-navys-secret-project" class="level5">
<h5 class="anchored" data-anchor-id="rickovers-design-philosophy-and-the-navys-secret-project">Rickover’s Design Philosophy and the Navy’s Secret Project</h5>
<ul>
<li>Rickover worked on the nuclear submarine project with limited resources, borrowing office space from the Army at Oak Ridge.</li>
<li>He advocated for nuclear submarine propulsion, despite the Navy’s apparent lack of interest.</li>
<li>The Navy had actually started a secret uranium enrichment project in the Philadelphia Navy Yard, which was later absorbed into the Manhattan Project.</li>
<li>The Navy formally proposed nuclear propulsion in December 1944 (<strong>Project D</strong>), with a detailed appendix by <strong>Dr.&nbsp;Phil Abelson</strong>.</li>
<li>Rickover developed key design principles:
<ol type="1">
<li>Reactor design was primarily an engineering problem (95%), not a physics problem (5%).</li>
<li>Design should start with the propeller shaft and work backward to the reactor.</li>
<li>Assume future uranium abundance and do not constrain the design by fuel availability.</li>
<li>The reactor must fit within the diameter of an ideal submarine hull.</li>
</ol></li>
<li>Captured German <strong>Type 26</strong> submarines, with their streamlined 28-foot-wide hulls, served as a model for Rickover’s nuclear submarine.</li>
<li>The nuclear submarine project faced resistance from the Navy, which was focused on managing existing ships rather than building new ones.</li>
</ul>
</section>
<section id="the-legacy-of-rickovers-design-and-operation-crossroads" class="level5">
<h5 class="anchored" data-anchor-id="the-legacy-of-rickovers-design-and-operation-crossroads">The Legacy of Rickover’s Design and Operation Crossroads</h5>
<ul>
<li>Contemporary nuclear power plant designs are heavily influenced by Rickover’s work and his critique of the Daniels Pile project.</li>
<li>Rickover’s focus on a <strong>passively safe</strong> reactor, cooled and moderated by ordinary water, proved crucial.
<ul>
<li>Inherent safety features ensured automatic shutdown in case of malfunctions.</li>
<li>Ordinary water as a coolant eliminated flammability and toxicity concerns.</li>
</ul></li>
<li>Other reactor designs, such as the Fast Breeder and gas-cooled graphite reactors, lacked this inherent safety.</li>
<li>The end of the Manhattan Project left <strong>General Leslie Groves</strong> with diminished power.
<ul>
<li>He remained at Los Alamos, heading the <strong>Armed Forces Special Weapons Project</strong>, but funding dwindled.</li>
</ul></li>
<li>The remaining staff at Los Alamos refined the Fat Man design (renamed <strong>MK-3</strong>).</li>
<li>The Navy requested tests to assess the effects of atomic bombs on naval vessels.</li>
<li><strong>Operation Crossroads</strong>, a series of live drop tests, was scheduled for June 1946 near <strong>Bikini Atoll</strong>.
<ul>
<li>Ninety obsolete ships, including captured enemy vessels, would be targeted.</li>
<li>Animals were used as test subjects instead of humans.</li>
<li>Civilian scientists and Navy personnel eagerly participated.</li>
<li>42,000 men and 150 support vessels were involved.</li>
</ul></li>
</ul>
</section>
<section id="louis-slotin-and-the-demon-core" class="level5">
<h5 class="anchored" data-anchor-id="louis-slotin-and-the-demon-core">Louis Slotin and the Demon Core</h5>
<ul>
<li><strong>Dr.&nbsp;Louis A. Slotin</strong>, known as the “Chief Armorer” for his expertise in assembling the MK-3, was among the remaining scientists at Los Alamos.</li>
<li>Slotin, originally from Canada, had a PhD in Physical Chemistry.</li>
<li>On May 21, 1946, Slotin was demonstrating a near-criticality test with the <strong>Demon Core</strong> (the same plutonium core that killed Harry Daghlian in 1945) to <strong>Alvin C. Graves</strong>.</li>
<li>The test involved manipulating the <strong>tungsten carbide</strong> reflector hemispheres around the plutonium core with a screwdriver.</li>
<li>The screwdriver slipped, causing the reflector halves to close completely, resulting in a <strong>supercriticality</strong> event.</li>
<li>The room flashed blue, and Slotin received a lethal dose of radiation.</li>
<li>He died nine days later.</li>
</ul>
</section>
<section id="a-turning-point-in-nuclear-science-and-the-paradox" class="level5">
<h5 class="anchored" data-anchor-id="a-turning-point-in-nuclear-science-and-the-paradox">A Turning Point in Nuclear Science and the Paradox</h5>
<ul>
<li>Slotin’s accident marked a turning point in nuclear science.
<ul>
<li>The frantic wartime atmosphere of reckless experimentation was over.</li>
<li>Safety became a paramount concern.</li>
</ul></li>
<li>Nuclear technology entered a paradoxical phase.
<ul>
<li>The Demon Core, destroyed in Operation Crossroads, would no longer pose a direct threat.</li>
<li>However, the legacy of the atomic bomb and the potential for future accidents remained.</li>
</ul></li>
</ul>
</section>
</section>
</section>
</section>
<section id="part-3-the-paradox" class="level2">
<h2 class="anchored" data-anchor-id="part-3-the-paradox">Part 3: The Paradox</h2>
<section id="the-hatch-nuclear-plant-field-trip-1973" class="level3">
<h3 class="anchored" data-anchor-id="the-hatch-nuclear-plant-field-trip-1973">The Hatch Nuclear Plant Field Trip (1973)</h3>
<section id="introduction-to-boiling-water-reactor-technology" class="level4">
<h4 class="anchored" data-anchor-id="introduction-to-boiling-water-reactor-technology">Introduction to Boiling Water Reactor Technology</h4>
<ul>
<li>Spring quarter, 1973: Enrolled in Dr.&nbsp;Joe Johnson’s <strong>Boiling Water Reactor Technology</strong> course out of interest.</li>
<li>Textbook: General Electric BWR Technical Manual (dense and lengthy).</li>
<li>Course climax: Field trip to <strong>Georgia Power’s Edwin I. Hatch Nuclear Generating Station</strong> near Baxley, GA.</li>
</ul>
</section>
<section id="journey-to-plant-hatch" class="level4">
<h4 class="anchored" data-anchor-id="journey-to-plant-hatch">Journey to Plant Hatch</h4>
<ul>
<li>Location: Near Baxley, GA, in the Vidalia onion-growing region of South Georgia.</li>
<li>Travel: Five-hour drive from Atlanta, departing at 2:00 AM.</li>
<li>Initial observation: Unit 1 reactor visible from a mile away in the rural darkness, brightly lit.</li>
<li>Plant status: Unit 1 nearing completion (95%), Unit 2 significantly behind (steel containment still being welded).</li>
</ul>
</section>
<section id="exploring-the-reactor" class="level4">
<h4 class="anchored" data-anchor-id="exploring-the-reactor">Exploring the Reactor</h4>
<ul>
<li>Unique experiences:
<ul>
<li>Descending a wooden ladder into the stainless steel <strong>core vessel</strong>.</li>
<li>Standing on the <strong>lower fuel support plate</strong>.</li>
<li>Walking the circumference of the <strong>steam expansion space</strong> around the <strong>primary containment</strong>.</li>
</ul></li>
<li>Tour guide: Mr.&nbsp;Tom Beckham of Georgia Power (provided a VIP tour usually reserved for GE executives or major stockholders).</li>
</ul>
</section>
<section id="observations-on-reactor-size-and-technology" class="level4">
<h4 class="anchored" data-anchor-id="observations-on-reactor-size-and-technology">Observations on Reactor Size and Technology</h4>
<ul>
<li><strong>Reactor size:</strong> Immense scale, surpassing the impression gained from diagrams, specifications, and photographs.</li>
<li><strong>Plant components:</strong> Unusually large, from reactor vessel head nuts to the turbine shaft.</li>
<li><strong>Control room:</strong>
<ul>
<li>Four walls covered in switch and indicator panels.</li>
<li>Every inch filled with handles, meters, or warning lights.</li>
<li>Behind the panels: Multiple layers of walls packed with <strong>dual-movement General Electric relays</strong> in airtight boxes with glass windows.</li>
</ul></li>
<li><strong>Technological surprise:</strong>
<ul>
<li>Not impressed by advanced engineering, but rather by its absence.</li>
<li>Control room technology seemed outdated (similar to a 1946 GE Industrial Electrics catalog).</li>
</ul></li>
</ul>
</section>
<section id="the-scram-system" class="level4">
<h4 class="anchored" data-anchor-id="the-scram-system">The Scram System</h4>
<ul>
<li><strong>Scram system:</strong> Banks of relays designed to automatically shut down the reactor in case of irregularities.
<ul>
<li>Purpose: Protect the core and steam system, prevent radiation release.</li>
</ul></li>
<li><strong>Relay logic:</strong> Each relay functioned as a node in a <strong>logic tree</strong>.
<ul>
<li>Example: “If condition A and condition B and condition C exist, then SCRAM.”</li>
</ul></li>
<li>Complexity: Complicated but fundamentally straightforward.</li>
</ul>
</section>
<section id="recognizing-the-potential-for-improvement" class="level4">
<h4 class="anchored" data-anchor-id="recognizing-the-potential-for-improvement">Recognizing the Potential for Improvement</h4>
<ul>
<li>Author’s expertise: Real-time digital computing for industrial monitoring and control.</li>
<li>Observation: Relay rack space seemed wasteful.</li>
<li>Potential solution: Entire scram logic circuit could be miniaturized onto a single silicon chip (even in 1973).</li>
</ul>
</section>
<section id="rationale-for-outdated-technology" class="level4">
<h4 class="anchored" data-anchor-id="rationale-for-outdated-technology">Rationale for Outdated Technology</h4>
<ul>
<li><strong>Reason for relay logic:</strong> Proven reliability and extensive use since before 1946.</li>
<li><strong>Silicon chip limitations:</strong> Relatively new technology with less established reliability.</li>
<li><strong>Paradox:</strong> The age of the relay technology made it the preferred choice for the new power reactor.</li>
<li><strong>Conservative approach:</strong> Innovative power production concepts relied on well-established component technologies.</li>
<li><strong>Limited computer use:</strong> Only slide rules were used for calculations at Plant Hatch.</li>
</ul>
</section>
</section>
<section id="mil-spec-computers-and-the-loft-reactor-1979-1981" class="level3">
<h3 class="anchored" data-anchor-id="mil-spec-computers-and-the-loft-reactor-1979-1981">Mil-Spec Computers and the LOFT Reactor (1979-1981)</h3>
<section id="post-graduate-work-and-research" class="level4">
<h4 class="anchored" data-anchor-id="post-graduate-work-and-research">Post-Graduate Work and Research</h4>
<ul>
<li>Graduation: Ph.D.&nbsp;in Nuclear Engineering in 1979.</li>
<li>Work experience: Georgia Tech Engineering Experiment Station on Department of Defense projects.</li>
<li>Specialization: <strong>Military specification (mil-spec) computers</strong>.
<ul>
<li>Characteristics: Rugged, airtight, designed for extreme conditions (rain, sandstorms, vibrations, etc.).</li>
<li>Components: Selected for high-temperature tolerance and long <strong>mean time between failures</strong>.</li>
<li>Cost: Expensive.</li>
</ul></li>
<li>Published papers: Proposed using mil-spec computers for data handling in nuclear power plants due to their robustness.</li>
</ul>
</section>
<section id="the-loft-reactor-experiment-and-its-challenges" class="level4">
<h4 class="anchored" data-anchor-id="the-loft-reactor-experiment-and-its-challenges">The LOFT Reactor Experiment and its Challenges</h4>
<ul>
<li><strong>Idaho Nuclear Energy Lab (INEL) contact:</strong> Project engineers at INEL read the author’s paper and saw a potential solution to their problem with the <strong>Loss of Fluid Test (LOFT)</strong> reactor experiment.</li>
<li><strong>LOFT reactor:</strong> Half-scale, fully operational power reactor.</li>
<li><strong>Experiment:</strong> Simulate a pipe break by remotely opening a valve on the primary coolant loop.</li>
<li><strong>Data collection:</strong> Extensive instrumentation and computers used to record and analyze the effects of coolant loss.</li>
<li><strong>Problem:</strong>
<ul>
<li>The simulated pipe break caused significant vibrations in the control complex.</li>
<li>Vibrations led to computer crashes during experiments, resulting in data loss.</li>
</ul></li>
</ul>
</section>
<section id="visiting-the-loft-facility" class="level4">
<h4 class="anchored" data-anchor-id="visiting-the-loft-facility">Visiting the LOFT Facility</h4>
<ul>
<li>Travel to Idaho Falls: January 1980, experiencing extreme cold (-26°F).</li>
<li>Travel to Test Area North (TAN): 52 miles northwest of Idaho Falls.</li>
<li><strong>LOFT reactor housing:</strong> Simple cylindrical containment structure beside a massive Quonset hut.</li>
<li><strong>Quonset hut:</strong>
<ul>
<li>Several stories tall, capable of housing an ocean liner.</li>
<li>Contained an internal environment with roads, streetlights, and huts.</li>
<li>Climate-controlled interior (fall-like weather on the day of the visit).</li>
</ul></li>
<li><strong>Quonset hut history:</strong> Former hangar for the NB-36H nuclear-powered strategic bomber (explained the small door at the top).</li>
<li><strong>Reactor control room:</strong> Located deep underground at the end of a 660-foot sloping tunnel, maintained at a warm 69°F.</li>
</ul>
</section>
<section id="project-details-and-research-findings" class="level4">
<h4 class="anchored" data-anchor-id="project-details-and-research-findings">Project Details and Research Findings</h4>
<ul>
<li><strong>Project funding:</strong> U.S. Department of Energy, overseen by the <strong>Nuclear Regulatory Commission (NRC)</strong> as regulatory research.</li>
<li><strong>Research focus:</strong> Hardening data collection computers against seismic shocks.</li>
<li><strong>Final report:</strong> “Reactor Safety System Design Using Hardened Computers” (NUREG CR-2118, April 1981).</li>
</ul>
</section>
<section id="impact-of-the-three-mile-island-incident" class="level4">
<h4 class="anchored" data-anchor-id="impact-of-the-three-mile-island-incident">Impact of the Three Mile Island Incident</h4>
<ul>
<li><strong>Three Mile Island (TMI) incident:</strong> Disastrous reactor meltdown in Pennsylvania (March 1979).</li>
<li><strong>NRC’s response:</strong> Published NUREG-0696, “Functional Criteria for Emergency Response Facilities” (February 1981).
<ul>
<li>Mandated the use of digital computers for data collection, display, and recording.</li>
<li>Did not address earthquake survivability requirements (specified in a separate regulation).</li>
</ul></li>
<li><strong>Author’s research relevance:</strong> Provided a solution to the earthquake hardness requirement using mil-spec computers.</li>
</ul>
</section>
</section>
<section id="upgrading-plant-hatch-and-navigating-the-nuclear-power-world" class="level3">
<h3 class="anchored" data-anchor-id="upgrading-plant-hatch-and-navigating-the-nuclear-power-world">Upgrading Plant Hatch and Navigating the Nuclear Power World</h3>
<section id="securing-the-contract-and-returning-to-plant-hatch" class="level4">
<h4 class="anchored" data-anchor-id="securing-the-contract-and-returning-to-plant-hatch">Securing the Contract and Returning to Plant Hatch</h4>
<ul>
<li><strong>Contract with Georgia Power:</strong> Secured a multi-million dollar contract to upgrade Plant Hatch with earthquake-hardened computer systems, fulfilling the new NRC regulation.</li>
<li><strong>Return to Plant Hatch:</strong> Eight years after initially observing the outdated control room technology.</li>
<li><strong>Initial procedures:</strong> Briefings, radiation safety lectures, radiation level checks, access badge and yellow hard hat issued.</li>
</ul>
</section>
<section id="the-importance-of-hard-hat-color" class="level4">
<h4 class="anchored" data-anchor-id="the-importance-of-hard-hat-color">The Importance of Hard Hat Color</h4>
<ul>
<li><strong>Encounter with Sam Hart (Georgia Power Technical Monitor):</strong> Hart expressed concern about the author’s yellow hard hat.</li>
<li><strong>Hard hat color significance:</strong>
<ul>
<li>Yellow: Maintenance personnel.</li>
<li>White: Management.</li>
</ul></li>
<li><strong>Importance of white hat:</strong> Commanded more respect and better treatment.</li>
<li><strong>Resolution:</strong> Hart arranged for the author to receive a white hard hat.</li>
</ul>
</section>
<section id="plant-hatch-revisited-and-the-hazards-of-a-white-hat" class="level4">
<h4 class="anchored" data-anchor-id="plant-hatch-revisited-and-the-hazards-of-a-white-hat">Plant Hatch Revisited and the Hazards of a White Hat</h4>
<ul>
<li><strong>Plant Hatch changes:</strong> Undergoing significant renovations, with scaffolding and workers throughout.</li>
<li><strong>Portal encounter:</strong> Stopped at a control deck entrance by a worker who noticed the white hard hat.</li>
<li><strong>Warning:</strong> Maintenance workers might intentionally drop objects on those wearing white hats (management).</li>
<li><strong>Demonstration:</strong> A pipe fitter in a yellow hard hat on the scaffolding smiled and waved menacingly.</li>
<li><strong>Realization:</strong> The nuclear power environment had its own unique social dynamics and potential hazards.</li>
</ul>
</section>
</section>
<section id="implementing-the-safety-parameter-display-system" class="level3">
<h3 class="anchored" data-anchor-id="implementing-the-safety-parameter-display-system">Implementing the Safety Parameter Display System</h3>
<section id="the-safety-parameter-display-system-spds" class="level4">
<h4 class="anchored" data-anchor-id="the-safety-parameter-display-system-spds">The Safety Parameter Display System (SPDS)</h4>
<ul>
<li><strong>Project scope:</strong> Design, build, and test a new computer network called the <strong>Safety Parameter Display System (SPDS)</strong> for Plant Hatch.</li>
<li><strong>Project duration:</strong> Four years.</li>
<li><strong>Project cost:</strong> Several million dollars.</li>
<li><strong>Team management:</strong> Oversaw a group of approximately 30 engineers at Georgia Tech.</li>
<li><strong>Author’s role:</strong> Limited hands-on work during development, but determined to handle the final installation personally.</li>
</ul>
</section>
<section id="final-installation-and-the-control-room-environment" class="level4">
<h4 class="anchored" data-anchor-id="final-installation-and-the-control-room-environment">Final Installation and the Control Room Environment</h4>
<ul>
<li><strong>Task:</strong> Connect the control room display computers to the data storage system in an auxiliary room using a <strong>mil-spec, redundant fiber-optic system</strong>.</li>
<li><strong>Fiber optic technology:</strong> Relatively new at the time, requiring on-site optical grinding and fitting of connector ends.</li>
<li><strong>Control room atmosphere:</strong>
<ul>
<li>Spotlessly clean, brightly lit, and quiet.</li>
<li>Strict rules: No eating, drinking, smoking, or loose particles.</li>
<li>Staff attire: Clean jumpsuits and brown hard hats.</li>
</ul></li>
<li><strong>Control room access:</strong> Required permission from the <strong>shift supervisor</strong>.
<ul>
<li>Approach: Polite, humble, and with a valid reason for entry.</li>
<li>Shift supervisor’s demeanor: Blank, unemotional expression.</li>
</ul></li>
</ul>
</section>
<section id="the-e-clip-incident" class="level4">
<h4 class="anchored" data-anchor-id="the-e-clip-incident">The E-clip Incident</h4>
<ul>
<li><strong>Fiber-optic connection process:</strong>
<ul>
<li>Installing a connector using a Daniels crimper.</li>
<li>Securing the connector with a tiny E-clip.</li>
</ul></li>
<li><strong>E-clip mishap:</strong> The E-clip slipped from the pliers and landed in a wastebasket under the control console.</li>
<li><strong>Retrieving the E-clip:</strong>
<ul>
<li>Reached into the wastebasket to retrieve the clip.</li>
<li>Noted a strange sensation on the hand.</li>
<li>Upon withdrawing the hand, found it covered in a brown liquid.</li>
</ul></li>
<li><strong>Initial assumption:</strong> Coca-Cola (though drinks were prohibited in the control room).</li>
<li><strong>Operator observation:</strong> Noticed an operator watching him.</li>
<li><strong>Wastebasket prevalence:</strong> Observed numerous wastebaskets around the control room.</li>
<li><strong>Revelation:</strong> The operator spit a stream of tobacco juice into a nearby wastebasket.</li>
<li><strong>Unpleasant realization:</strong> The brown liquid was not Coca-Cola, but a collection of spit.</li>
</ul>
</section>
<section id="paradox-within-paradox" class="level4">
<h4 class="anchored" data-anchor-id="paradox-within-paradox">Paradox within Paradox</h4>
<ul>
<li><strong>Control room contrast:</strong> The pristine, quiet, and orderly control room environment juxtaposed with the unsanitary practice of spitting tobacco juice into wastebaskets.</li>
<li><strong>Conclusion:</strong> This incident exemplified the paradoxical nature of the nuclear power industry, where advanced technology and strict regulations coexisted with unexpected and sometimes unsanitary practices.</li>
</ul>
</section>
</section>
<section id="chapter-1-a-quest-for-power" class="level3">
<h3 class="anchored" data-anchor-id="chapter-1-a-quest-for-power">Chapter 1: A Quest for Power</h3>
<section id="post-world-war-ii-nuclear-landscape" class="level4">
<h4 class="anchored" data-anchor-id="post-world-war-ii-nuclear-landscape">Post-World War II Nuclear Landscape</h4>
<section id="the-united-states-position" class="level5">
<h5 class="anchored" data-anchor-id="the-united-states-position">The United States’ Position</h5>
<ul>
<li>At the end of World War II, the <strong>United States</strong> was the only country with <strong>atomic bombs</strong>, a position that had both advantages and disadvantages.
<ul>
<li><strong>Advantage:</strong> The Soviet Union, under Stalin, was unlikely to initiate conflict in Europe due to the threat of atomic bombing.</li>
<li><strong>Disadvantage:</strong> The secrets of atomic bomb construction would inevitably be discovered by other nations with sufficient scientific and industrial capacity.</li>
</ul></li>
<li><strong>Nuclear physics</strong> is a universal science and could be mastered by any capable team, making it a matter of time before other countries developed atomic weapons.</li>
</ul>
</section>
<section id="british-concerns-and-agreements" class="level5">
<h5 class="anchored" data-anchor-id="british-concerns-and-agreements">British Concerns and Agreements</h5>
<ul>
<li>During the <strong>Manhattan Project</strong>, the <strong>British</strong> expressed concern about a lack of cooperation with the United States despite being allies.
<ul>
<li>British scientists contributed expertise at Los Alamos but were excluded from production facilities like the Hanford plutonium reactors.</li>
</ul></li>
<li><strong>Winston Churchill</strong> convinced <strong>Franklin Roosevelt</strong> of the need for a formal agreement to share atomic bomb expertise and data.</li>
<li>The <strong>Quebec Agreement</strong>, signed on <strong>August 19, 1943</strong>, formalized this collaboration, including <strong>Canada</strong> in the information-sharing policy due to their contribution of nuclear physicists.</li>
<li>An extended agreement signed at <strong>Hyde Park</strong> on <strong>September 18, 1944</strong>, pledged full cooperation in post-war nuclear pursuits, both military and civilian.</li>
<li>Following Roosevelt’s death and <strong>Harry S. Truman</strong>’s presidency, the modified agreement was seemingly lost, and Truman showed no interest in sharing atomic bomb information.</li>
<li>By <strong>1946</strong>, the British and Canadians were left to pursue their own nuclear programs independently.</li>
</ul>
</section>
<section id="the-mcmahon-act-and-soviet-espionage" class="level5">
<h5 class="anchored" data-anchor-id="the-mcmahon-act-and-soviet-espionage">The McMahon Act and Soviet Espionage</h5>
<ul>
<li>The <strong>Atomic Energy Act (McMahon Act)</strong>, passed by the US Congress in <strong>August 1946</strong>, prohibited sharing atomic energy secrets with any foreign country, including Britain and Canada, under penalty of death.</li>
<li>The <strong>Soviet Union</strong>, despite being a wartime ally, was intentionally excluded from atomic bomb development information.</li>
<li>Soviet leaders recognized the importance of nuclear technology and initiated their own program, facing challenges such as the German invasion and a lack of resources.</li>
<li>They compensated for these limitations through a highly effective <strong>espionage operation</strong>, stealing crucial information that accelerated their nuclear development.</li>
<li><strong>Soviet spies</strong> within the Manhattan Project included:
<ul>
<li><strong>Klaus Fuchs</strong> (physicist, codenamed Charles)</li>
<li><strong>Ted Hall</strong> (physicist, codenamed Imlad)</li>
<li><strong>David Greenglass</strong> (machinist, codenamed Caliber)</li>
</ul></li>
<li>Using this intelligence, Soviet scientists, led by <strong>Igor Kurchatov</strong>, built a replica of Enrico Fermi’s Chicago Pile Reactor in <strong>1946</strong> at <strong>Arzamas 16</strong> (formerly <strong>Serov</strong>).</li>
<li>By <strong>1949</strong>, the <strong>RDS-1 bomb</strong> (“<strong>Joe-1</strong>” to US intelligence) was ready for testing, a near copy of the US “Fat Man” bomb.</li>
<li>The successful detonation on <strong>August 29, 1949</strong>, in <strong>Kazakhstan</strong> yielded <strong>21 kilotons of TNT</strong>, ending the US nuclear monopoly and marking the beginning of the <strong>Cold War</strong>.</li>
</ul>
</section>
</section>
<section id="the-british-nuclear-program" class="level4">
<h4 class="anchored" data-anchor-id="the-british-nuclear-program">The British Nuclear Program</h4>
<section id="challenges-and-solutions" class="level5">
<h5 class="anchored" data-anchor-id="challenges-and-solutions">Challenges and Solutions</h5>
<ul>
<li><strong>Great Britain</strong> sought to develop its own atomic bomb, possessing the expertise but lacking the natural resources of the US and Soviet Union.</li>
<li>A key challenge was finding a suitable <strong>testing location</strong> due to safety concerns and the lack of large, uninhabited areas within Britain.</li>
<li>They established a <strong>plutonium production facility</strong> at <strong>Windscale</strong> on the Cumbrian coast, utilizing air-cooled reactors to vent exhaust over the Irish Sea.</li>
<li><strong>Plutonium production</strong> was accelerated by using short irradiation times, resulting in plutonium with high <strong>PU-240</strong> contamination, making bomb cores more hazardous.</li>
<li>Despite limitations, Windscale produced enough plutonium for a test, though not for a substantial arsenal.</li>
</ul>
</section>
<section id="research-and-development" class="level5">
<h5 class="anchored" data-anchor-id="research-and-development">Research and Development</h5>
<ul>
<li><strong>Sir John Cockcroft</strong> returned from Canada to lead the newly established <strong>United Kingdom Atomic Energy Authority</strong>.</li>
<li>The British equivalent of Los Alamos, the <strong>Atomic Energy Research Establishment</strong>, was built at <strong>Harwell</strong>, a former RAF airfield.</li>
<li><strong>GLEEP</strong> (Graphite Low Energy Experimental Pile), a copy of the Oak Ridge X-10 Pile, was built at Harwell, followed by <strong>BEPO</strong> (British Experimental Pile Zero).</li>
<li>The British aimed to test a “Fat Man” type device by <strong>August 1952</strong>.</li>
</ul>
</section>
<section id="operation-hurricane" class="level5">
<h5 class="anchored" data-anchor-id="operation-hurricane">Operation Hurricane</h5>
<ul>
<li><strong>Operation Hurricane</strong>, the British atomic bomb test, occurred on <strong>October 3, 1952</strong>, in shallow water off the <strong>Montebello Islands</strong> of <strong>Western Australia</strong>.</li>
<li>The test involved detonating the bomb within the hold of the <strong>HMS Plym</strong>, a frigate, to simulate a harbor attack scenario.</li>
<li>The <strong>25 kiloton</strong> explosion vaporized the HMS Plym and left a <strong>300-meter wide crater</strong> on the seabed.</li>
</ul>
</section>
</section>
<section id="the-canadian-nuclear-program" class="level4">
<h4 class="anchored" data-anchor-id="the-canadian-nuclear-program">The Canadian Nuclear Program</h4>
<section id="focus-on-nuclear-power" class="level5">
<h5 class="anchored" data-anchor-id="focus-on-nuclear-power">Focus on Nuclear Power</h5>
<ul>
<li><strong>Canada</strong>, unlike the US and Britain, focused on the potential of <strong>nuclear power</strong> rather than weapons development.</li>
<li>In <strong>1942</strong>, they established a <strong>nuclear research laboratory</strong> in <strong>Montreal</strong> under the <strong>National Research Council</strong>.</li>
<li>The facility was relocated to <strong>Chalk River, Ontario</strong>, in <strong>1944</strong> due to safety concerns associated with conducting experiments in an urban environment.</li>
</ul>
</section>
<section id="zeep-reactor" class="level5">
<h5 class="anchored" data-anchor-id="zeep-reactor">ZEEP Reactor</h5>
<ul>
<li><strong>ZEEP</strong> (Zero Energy Experimental Pile), the <strong>first nuclear reactor outside the United States</strong>, was built at Chalk River.</li>
<li>It achieved <strong>criticality</strong> on <strong>September 5, 1945</strong>, at <strong>3:45 p.m.</strong>, marking a significant milestone in the global pursuit of nuclear power.</li>
</ul>
</section>
</section>
<section id="the-race-for-nuclear-power" class="level4">
<h4 class="anchored" data-anchor-id="the-race-for-nuclear-power">The Race for Nuclear Power</h4>
<section id="early-achievements" class="level5">
<h5 class="anchored" data-anchor-id="early-achievements">Early Achievements</h5>
<ul>
<li>The <strong>United States</strong>, <strong>Canada</strong>, <strong>Great Britain</strong>, and the <strong>Soviet Union</strong> emerged as the leading competitors in the race for nuclear power.</li>
<li>Canada, though not pursuing weapons, supplied plutonium to Britain for the Hurricane test.</li>
<li>The US focused on developing a <strong>fast plutonium breeder reactor</strong> (<strong>EBR-1</strong>) in <strong>1949</strong>.
<ul>
<li>EBR-1 became the world’s <strong>first electricity-generating nuclear power plant</strong> on <strong>December 20, 1951</strong>, producing enough power to light four 200-watt bulbs.</li>
</ul></li>
</ul>
</section>
<section id="the-obninsk-power-plant" class="level5">
<h5 class="anchored" data-anchor-id="the-obninsk-power-plant">The Obninsk Power Plant</h5>
<ul>
<li>The world’s <strong>first civilian nuclear power station</strong> was built in <strong>Obninsk, Russia</strong>, construction starting on <strong>January 1, 1951</strong>, and the first startup on <strong>June 1, 1954</strong>.</li>
<li><strong>APS-1 Obninsk</strong> (Atomic Power Station 1) utilized a <strong>graphite-moderated, water-cooled</strong> reactor design (<strong>AM-1</strong>, or “peaceful Adam”).</li>
<li>On <strong>June 26, 1954</strong>, the plant’s <strong>6 megawatts</strong> of power were connected to the grid, making it officially the first civilian nuclear power plant.</li>
<li>The <strong>RBMK</strong> reactor design, later infamous for the <strong>Chernobyl disaster</strong>, was a scaled-up version of the AM-1.</li>
</ul>
</section>
<section id="calder-hall-nuclear-power-plant" class="level5">
<h5 class="anchored" data-anchor-id="calder-hall-nuclear-power-plant">Calder Hall Nuclear Power Plant</h5>
<ul>
<li><strong>Great Britain</strong> claimed the title of the first nuclear power station to deliver electricity at commercial levels with <strong>Calder Hall</strong>.</li>
<li>They argued that Obninsk was semi-experimental and its output too small to be considered truly commercial.</li>
<li>Calder Hall was connected to the grid on <strong>August 27, 1956</strong>, and officially opened on <strong>August 17, 1956</strong>.</li>
<li>The plant comprised four <strong>graphite-moderated, carbon dioxide-cooled</strong> reactors, each generating <strong>50 megawatts</strong>.</li>
<li>Calder Hall’s primary purpose was <strong>plutonium production</strong> for the British nuclear weapons program, replacing the Windscale reactors.</li>
<li>It also served a <strong>commercial purpose</strong>, providing an alternative to coal-fired power and potentially deterring coal miners’ strikes.</li>
</ul>
</section>
<section id="the-sodium-reactor-experiment" class="level5">
<h5 class="anchored" data-anchor-id="the-sodium-reactor-experiment">The Sodium Reactor Experiment</h5>
<ul>
<li>The <strong>United States</strong> followed closely behind Britain with the <strong>Santa Susana Field Laboratory</strong> in California.</li>
<li>Santa Susana focused on rocket engines and experimental nuclear reactors.</li>
<li>The <strong>Sodium Reactor Experiment</strong>, a reactor using <strong>metallic sodium</strong> as coolant, went critical in <strong>April 1957</strong> and began delivering power to the grid on <strong>July 12, 1957</strong>, serving <strong>1,100 homes</strong> in the Moorpark area.</li>
<li>On <strong>July 13, 1959</strong>, it experienced the <strong>first core meltdown</strong> in a US commercial power reactor due to a <strong>tetralyn leak</strong> that blocked cooling channels.
<ul>
<li>One-third of the fuel melted, but there were no injuries.</li>
<li>Radioactive gas was released into the atmosphere over several weeks.</li>
</ul></li>
</ul>
</section>
<section id="the-candu-reactor" class="level5">
<h5 class="anchored" data-anchor-id="the-candu-reactor">The CANDU Reactor</h5>
<ul>
<li><strong>Canada</strong> continued developing nuclear power, focusing on unique designs due to resource limitations.</li>
<li>Unable to easily obtain graphite or enrich uranium, they opted for <strong>heavy water</strong> as a highly efficient moderator, allowing the use of unenriched uranium.</li>
<li>A <strong>heavy water extraction plant</strong> was built at Chalk River.</li>
<li><strong>Atomic Energy of Canada</strong> and <strong>Canadian General Electric</strong> developed the <strong>CANDU</strong> (Canadian Deuterium Uranium) reactor.</li>
<li>The first CANDU power plant, a <strong>22 megawatt</strong> unit, was built in <strong>Rolfton, Ontario</strong>, marking the beginning of a series of distinctly Canadian reactor designs.</li>
</ul>
</section>
</section>
<section id="the-united-states-atomic-energy-commission" class="level4">
<h4 class="anchored" data-anchor-id="the-united-states-atomic-energy-commission">The United States Atomic Energy Commission</h4>
<section id="establishment-and-mission" class="level5">
<h5 class="anchored" data-anchor-id="establishment-and-mission">Establishment and Mission</h5>
<ul>
<li>The <strong>United States Atomic Energy Commission (AEC)</strong> was created by the <strong>McMahon Act</strong>.</li>
<li>Its first chairman was <strong>David Lilienthal</strong>, former head of the Tennessee Valley Authority.</li>
<li>The AEC’s mission was multifaceted and seemingly contradictory:
<ul>
<li><strong>Promote</strong> and <strong>explore</strong> nuclear power.</li>
<li><strong>Control</strong> nuclear technology and protect the public from its potential dangers.</li>
<li>Take control of all <strong>nuclear weapons</strong>, laboratories, production facilities, and uranium resources in the United States.</li>
</ul></li>
</ul>
</section>
<section id="expansion-and-resource-acquisition" class="level5">
<h5 class="anchored" data-anchor-id="expansion-and-resource-acquisition">Expansion and Resource Acquisition</h5>
<ul>
<li>The AEC organized and expanded the wartime nuclear weapons labs into a network of <strong>national laboratories</strong>:
<ul>
<li><strong>Argonne National Laboratory</strong> (from Enrico Fermi’s Metallurgical Lab)</li>
<li><strong>Los Alamos National Laboratory</strong></li>
<li><strong>Oak Ridge National Laboratory</strong></li>
<li><strong>Hanford Site</strong></li>
</ul></li>
<li>New facilities were built, often mirroring existing ones for redundancy in case of a nuclear attack:
<ul>
<li><strong>Savannah River Plant</strong> (mirroring Hanford)</li>
<li><strong>Lawrence Livermore National Laboratory</strong> (mirroring Los Alamos)</li>
<li><strong>Paducah Gaseous Diffusion Plant</strong> (mirroring Oak Ridge’s K-25)</li>
</ul></li>
<li><strong>Uranium ore</strong> was a critical resource.
<ul>
<li>In <strong>December 1949</strong>, the AEC set an <strong>artificially high price</strong> for uranium to encourage exploration and mining.</li>
<li>This triggered a <strong>uranium rush</strong>, particularly in the Four Corners region of the Colorado Plateau.</li>
<li><strong>Charles A. Steen</strong> discovered the massive <strong>Mi Vida uranium deposit</strong> in <strong>Utah</strong> in <strong>1952</strong>, significantly boosting US uranium reserves.</li>
</ul></li>
<li>By <strong>1960</strong>, uranium stockpiles exceeded projected needs, causing a drop in its value.</li>
</ul>
</section>
<section id="the-hydrogen-bomb" class="level5">
<h5 class="anchored" data-anchor-id="the-hydrogen-bomb">The Hydrogen Bomb</h5>
<ul>
<li>The AEC also faced the challenge of the Soviet Union’s atomic bomb development.</li>
<li>The US response was to pursue a more powerful weapon: the <strong>hydrogen bomb</strong>.</li>
<li><strong>Edward Teller</strong>’s enthusiasm for <strong>hydrogen fusion weapons</strong> (“the super”) gained traction in the late 1940s.</li>
<li>Early <strong>computer simulations</strong> using <strong>ENIAC</strong> and the <strong>IBM Harvard Mark I</strong> proved Teller’s initial designs unworkable.</li>
<li><strong>Stanislaw Ulam</strong> proposed a modified design, separating the fission and fusion components and using the <strong>shockwave</strong> from the fission explosion to compress and heat the fusion fuel.</li>
<li>This led to the <strong>Teller-Ulam</strong> hydrogen bomb design.</li>
<li>Teller further refined the design, suggesting using <strong>X-rays</strong> from the fission explosion for compression.</li>
<li>The first hydrogen bomb test, <strong>Ivy Mike</strong> (“the Sausage”), took place on <strong>November 1, 1952</strong>, on <strong>Elugelab Island</strong> in the Pacific.
<ul>
<li>The explosion yielded power <strong>1,000 times greater</strong> than the Hiroshima bomb, obliterating the island.</li>
<li>Teller, watching from UC Berkeley, telegrammed “It’s a boy” to Los Alamos.</li>
</ul></li>
<li>The US hydrogen bomb monopoly ended on <strong>November 22, 1955</strong>, when the Soviet Union tested <strong>RDS-37</strong>, a staged fission-fusion bomb.</li>
</ul>
</section>
</section>
<section id="the-nuclear-submarine" class="level4">
<h4 class="anchored" data-anchor-id="the-nuclear-submarine">The Nuclear Submarine</h4>
<section id="hyman-rickovers-vision" class="level5">
<h5 class="anchored" data-anchor-id="hyman-rickovers-vision">Hyman Rickover’s Vision</h5>
<ul>
<li><strong>Captain Hyman Rickover</strong> of the US Navy championed the development of a <strong>nuclear-powered submarine</strong>.</li>
<li>He challenged the conventional wisdom of using graphite reactors, recognizing their inherent safety limitations.</li>
<li>Rickover’s design utilized <strong>highly enriched uranium</strong> (50% U-235), eliminating the need for frequent refueling and allowing for a smaller reactor core.</li>
<li><strong>Ordinary water</strong> served as both moderator and coolant, providing a safety feature: loss of coolant also meant loss of moderation, leading to automatic shutdown.</li>
<li>The <strong>pressurized water reactor (PWR)</strong> design kept coolant under high pressure to prevent boiling, minimizing reactor size.</li>
<li>A <strong>closed primary cooling loop</strong> confined radioactivity, and a <strong>secondary loop</strong> transferred heat to a steam turbine, ensuring safety for maintenance.</li>
</ul>
</section>
<section id="overcoming-obstacles" class="level5">
<h5 class="anchored" data-anchor-id="overcoming-obstacles">Overcoming Obstacles</h5>
<ul>
<li>Rickover faced significant challenges in securing funding and support for his project.</li>
<li>Despite Edward Teller’s endorsement, the project initially stalled.</li>
<li>Rickover revitalized the program by repurposing funding from the <strong>Daniel’s Pile</strong> power plant project at Oak Ridge.</li>
<li>He secured the approval of <strong>Fleet Admiral Chester Nimitz</strong>, Chief of Naval Operations, by crafting a letter for Nimitz to sign.</li>
<li>The <strong>AEC</strong> also approved the project on <strong>May 1, 1948</strong>.</li>
</ul>
</section>
<section id="development-and-testing" class="level5">
<h5 class="anchored" data-anchor-id="development-and-testing">Development and Testing</h5>
<ul>
<li>Rickover established the <strong>Nuclear Power Division</strong> of the <strong>Bureau of Ships</strong> on <strong>August 2, 1948</strong>.</li>
<li><strong>Westinghouse</strong> was contracted to design the steam generator and later the entire reactor system.</li>
<li>Rickover assumed leadership of the <strong>Naval Reactors Branch</strong> of the AEC in <strong>February 1949</strong>, giving him unique authority over both Navy and AEC aspects of the project.</li>
<li>Technical challenges were addressed, including the production of <strong>zirconium</strong>, a crucial material for reactor internals.
<ul>
<li>Rickover spearheaded the industrialization of the <strong>Kroll process</strong> for zirconium production, dramatically lowering its cost.</li>
</ul></li>
<li>The first prototype reactor, <strong>Mark A</strong>, was built and tested underwater in the <strong>Horton Sphere</strong> in Idaho.</li>
<li>Shock resistance was rigorously tested by subjecting a non-nuclear power system in the submarine <strong>Ulua</strong> to depth charge attacks.</li>
</ul>
</section>
<section id="the-nautilus" class="level5">
<h5 class="anchored" data-anchor-id="the-nautilus">The Nautilus</h5>
<ul>
<li>The keel of the <strong>USS Nautilus (SSN-571)</strong> was laid on <strong>June 14, 1952</strong>, with President Truman in attendance.</li>
<li>The Nautilus was launched on <strong>January 21, 1954</strong>, and first went to sea under nuclear power on <strong>January 17, 1955</strong>.</li>
<li>President Eisenhower received the first message from the Nautilus: “Underway on nuclear power.”</li>
<li>The Nautilus set numerous records during its two-year shakedown trials, demonstrating the superiority of nuclear propulsion.</li>
<li>It became the first vessel to <strong>cross under the polar ice cap</strong>, passing under the <strong>North Pole</strong> on <strong>August 3, 1957</strong>.</li>
</ul>
</section>
<section id="legacy-of-the-nautilus" class="level5">
<h5 class="anchored" data-anchor-id="legacy-of-the-nautilus">Legacy of the Nautilus</h5>
<ul>
<li>The success of the Nautilus led the US Navy to adopt nuclear power for a wide range of vessels, including aircraft carriers, cruisers, and submarines.</li>
<li>Rickover’s <strong>PWR design</strong>, though not the cheapest or simplest, became the <strong>most widely used reactor design</strong> globally due to its compactness and safety features.</li>
</ul>
</section>
</section>
</section>
<section id="chapter-2-digging-canals-curing-cancer-and-flying-to-jupiter" class="level3">
<h3 class="anchored" data-anchor-id="chapter-2-digging-canals-curing-cancer-and-flying-to-jupiter">Chapter 2: Digging Canals, Curing Cancer, and Flying to Jupiter</h3>
<section id="radiation-and-nuclear-power" class="level4">
<h4 class="anchored" data-anchor-id="radiation-and-nuclear-power">Radiation and Nuclear Power</h4>
<section id="the-paradox-of-nuclear-power" class="level5">
<h5 class="anchored" data-anchor-id="the-paradox-of-nuclear-power">The Paradox of Nuclear Power</h5>
<ul>
<li><strong>Radiation</strong> is a sinister and dangerous concept, even to those familiar with it.</li>
<li><strong>Nuclear power</strong>, particularly fission, releases a tremendous amount of radiation.</li>
<li><strong>Paradox:</strong> More people die annually from radiation-induced diseases from sun exposure than from nuclear power applications.</li>
<li><strong>Radiation is ubiquitous:</strong> It constantly penetrates our bodies.</li>
</ul>
</section>
<section id="the-erb-and-the-georgia-tech-research-reactor" class="level5">
<h5 class="anchored" data-anchor-id="the-erb-and-the-georgia-tech-research-reactor">The ERB and the Georgia Tech Research Reactor</h5>
<ul>
<li><strong>ERB (Electronics Research Building):</strong> Built in 1966 at Georgia Tech.
<ul>
<li>Constructed with concrete blocks sourced from a Florida phosphate mine.</li>
<li>Phosphate mine tailings are rich in <strong>uranium</strong>, making the ERB radioactive.</li>
<li>Occupants were exposed to higher radiation levels than in the adjacent reactor building.</li>
</ul></li>
<li><strong>Frank H. Neely Nuclear Research Center:</strong> Built in 1963, contained a 5-megawatt CP-5 heavy water reactor.
<ul>
<li>Meticulous radiation monitoring and safety protocols.</li>
<li><strong>1965 Incident:</strong> Radiation alarms triggered by the ERB’s construction materials, not a reactor incident.</li>
</ul></li>
<li><strong>Decommissioning:</strong>
<ul>
<li>Reactor meticulously decontaminated and disassembled at high cost.</li>
<li>ERB demolished with minimal precautions, spreading radioactive dust.</li>
</ul></li>
<li><strong>Paradox Illustrated:</strong> Extensive effort to protect from reactor radiation, while a greater, unmonitored radiation source existed in the ERB.</li>
<li><strong>Public Perception:</strong> Protecting the public from the perception of radiation contamination was paramount, even if the actual risk was low.</li>
</ul>
</section>
</section>
<section id="the-age-of-wild-experimentation-1954-1963" class="level4">
<h4 class="anchored" data-anchor-id="the-age-of-wild-experimentation-1954-1963">The Age of Wild Experimentation (1954-1963)</h4>
<section id="nuclear-weapons-testing" class="level5">
<h5 class="anchored" data-anchor-id="nuclear-weapons-testing">Nuclear Weapons Testing</h5>
<ul>
<li><strong>Early 1950s:</strong> US could detect Soviet nuclear tests through atmospheric radiation.</li>
<li><strong>Escalation of Testing:</strong>
<ul>
<li>1955: 20 above-ground tests</li>
<li>1956: 30 tests</li>
<li>1957: 50 tests</li>
<li>1958: 105 tests</li>
<li>1961: 140 tests</li>
</ul></li>
<li><strong>Consequences:</strong>
<ul>
<li>Atmospheric radiation levels rose to dangerous levels.</li>
<li>Rainwater became contaminated with radioactive fallout.</li>
</ul></li>
<li><strong>Weapons Development:</strong>
<ul>
<li>Los Alamos and Lawrence Livermore labs designed diverse nuclear weapons: gravity bombs, artillery shells, anti-aircraft weapons, etc.</li>
<li><strong>XM388 (Davy Crockett):</strong> Jeep-mounted recoilless rifle-fired nuclear device.</li>
<li><strong>W45 MADM:</strong> Designed to destroy hydroelectric dams.</li>
</ul></li>
<li><strong>Testing Effects:</strong> Structures, vehicles, and objects subjected to nuclear blasts to study their effects.</li>
<li><strong>Soviet Tsar Bomba (RDS-220):</strong>
<ul>
<li>October 30, 1961: Largest man-made explosion (50 megatons).</li>
<li>Never deployed, but demonstrated Soviet nuclear capability.</li>
</ul></li>
</ul>
</section>
<section id="industrial-uses-of-atomic-bombs" class="level5">
<h5 class="anchored" data-anchor-id="industrial-uses-of-atomic-bombs">Industrial Uses of Atomic Bombs</h5>
<ul>
<li><strong>Operation Plowshare (US) and Program 7 (USSR):</strong> Explored non-military uses for nuclear explosions.</li>
</ul>
<p><strong>Panama Canal</strong></p>
<ul>
<li><strong>Problem:</strong> Existing Panama Canal was too narrow for modern ships.</li>
<li><strong>Proposed Solution:</strong> Use nuclear explosions to excavate a new sea-level canal.</li>
<li><strong>Sedan Test (July 6, 1962):</strong>
<ul>
<li>104-kiloton bomb detonated at Yucca Flat, Nevada.</li>
<li>Created a crater 320 feet deep and 1,280 feet across.</li>
<li>Released significant radioactive fallout, exposing millions.</li>
</ul></li>
<li><strong>Consequences:</strong>
<ul>
<li>Project abandoned due to fallout concerns.</li>
<li>Public confidence in nuclear technology further eroded.</li>
</ul></li>
</ul>
<p><strong>Pechora-Kama Canal (USSR)</strong></p>
<ul>
<li><strong>Goal:</strong> Connect the Pechora and Kama river basins.</li>
<li><strong>March 23, 1971:</strong> Three 15-kiloton bombs detonated, creating a 2,000-foot crater.</li>
<li><strong>Project Abandoned:</strong> High radiation levels and the projected need for hundreds of bombs led to cancellation.</li>
</ul>
<p><strong>Project Chariot (US)</strong></p>
<ul>
<li><strong>Goal:</strong> Create an artificial harbor at Cape Thompson, Alaska.</li>
<li><strong>Opposition:</strong> Inuit villagers and the Sierra Club raised concerns about radiation.</li>
<li><strong>Project Shelved:</strong> AEC put the project on hold in 1962 due to public unease.</li>
</ul>
<p><strong>Project Gnome (US)</strong></p>
<ul>
<li><strong>Goal:</strong> Test electricity generation by detonating a nuclear bomb in an underground water stream.</li>
<li><strong>December 10, 1961:</strong> Explosion at a salt bed near Carlsbad, New Mexico.</li>
<li><strong>Failure:</strong> Radioactive steam escaped, and the project was deemed impractical.</li>
</ul>
<p><strong>Gas Stimulation (US)</strong></p>
<ul>
<li><strong>May 17, 1973:</strong> Three explosions in Fawn Creek, Colorado, to stimulate natural gas flow.</li>
<li><strong>Result:</strong> Gas became radioactive, and the project was economically unfeasible.</li>
</ul>
</section>
<section id="legacy-of-plowshare" class="level5">
<h5 class="anchored" data-anchor-id="legacy-of-plowshare">Legacy of Plowshare</h5>
<ul>
<li><strong>Fallout Concerns:</strong> Despite attempts at positive PR, public perception of nuclear technology became increasingly negative due to fallout.</li>
<li><strong>Paradox:</strong> While nuclear bombs were tested for destructive purposes, nuclear reactions were also being used to treat cancer.</li>
</ul>
</section>
</section>
<section id="radiation-in-medicine" class="level4">
<h4 class="anchored" data-anchor-id="radiation-in-medicine">Radiation in Medicine</h4>
<section id="early-x-ray-therapy" class="level5">
<h5 class="anchored" data-anchor-id="early-x-ray-therapy">Early X-ray Therapy</h5>
<ul>
<li><strong>1896:</strong> Wilhelm Röntgen discovers <strong>X-rays</strong>.</li>
<li><strong>Rapid Adoption:</strong> Diagnostic X-rays quickly used in medicine.</li>
<li><strong>Therapeutic Potential:</strong> Emil Grube’s accidental discovery of skin peeling from X-ray exposure led to the first cancer treatment using radiation.</li>
<li><strong>Rose Lee:</strong> First cancer patient treated with X-rays, showing improvement.</li>
<li><strong>Challenges:</strong> Early X-ray machines were imprecise, risking harm to healthy tissue.</li>
</ul>
</section>
<section id="radium-and-brachytherapy" class="level5">
<h5 class="anchored" data-anchor-id="radium-and-brachytherapy">Radium and Brachytherapy</h5>
<ul>
<li><strong>1898:</strong> Marie and Pierre Curie discover <strong>radium</strong> and <strong>polonium</strong>.</li>
<li><strong>Brachytherapy:</strong> Using radium implants to treat cancer with localized radiation.</li>
<li><strong>Advantages:</strong>
<ul>
<li>Solid-state radiation source, no bulky equipment.</li>
<li><strong>Alpha particles</strong> have a short range, minimizing damage to surrounding tissue.</li>
</ul></li>
<li><strong>Disadvantages:</strong>
<ul>
<li>Radium is rare and expensive.</li>
<li><strong>Radium’s long half-life (2,600 years)</strong> poses a long-term hazard.</li>
<li>Easy to lose or misplace, leading to accidental ingestion or inhalation.</li>
</ul></li>
</ul>
</section>
<section id="radiopharmaceuticals" class="level5">
<h5 class="anchored" data-anchor-id="radiopharmaceuticals">Radiopharmaceuticals</h5>
<ul>
<li><strong>Nuclear Reactors as Isotope Producers:</strong> Reactors can create specific radioisotopes for medical use.</li>
<li><strong>Advantages:</strong>
<ul>
<li>Customized isotopes with desired radiation type, energy, and half-life.</li>
<li>Eliminates the need for dangerous radium.</li>
</ul></li>
<li><strong>Examples:</strong>
<ul>
<li><strong>Calcium-47:</strong> Bone metabolism studies.</li>
<li><strong>Yttrium-90:</strong> Prostate cancer brachytherapy.</li>
<li><strong>Technetium-99m:</strong> Widely used for imaging various organs and tumors.</li>
</ul></li>
<li><strong>Technetium-99m:</strong>
<ul>
<li>Half-life of 6 hours, minimizing patient exposure.</li>
<li>Derived from nuclear power plant waste products.</li>
<li>Over 20 million people treated annually.</li>
</ul></li>
<li><strong>Dependence on Nuclear Reactors:</strong>
<ul>
<li>Without reactors, the radiopharmaceutical industry would not exist.</li>
<li>US relies heavily on a single reactor in Canada for isotope production.</li>
</ul></li>
</ul>
</section>
</section>
<section id="project-orion-nuclear-powered-spacecraft" class="level4">
<h4 class="anchored" data-anchor-id="project-orion-nuclear-powered-spacecraft">Project Orion: Nuclear-Powered Spacecraft</h4>
<section id="limitations-of-chemical-rockets" class="level5">
<h5 class="anchored" data-anchor-id="limitations-of-chemical-rockets">Limitations of Chemical Rockets</h5>
<ul>
<li>Chemical rockets have limited energy density, making long-duration manned spaceflight challenging.</li>
<li>Manned missions beyond the Moon require a more powerful propulsion system.</li>
</ul>
</section>
<section id="ulam-and-dysons-nuclear-propulsion-concept" class="level5">
<h5 class="anchored" data-anchor-id="ulam-and-dysons-nuclear-propulsion-concept">Ulam and Dyson’s Nuclear Propulsion Concept</h5>
<ul>
<li><strong>1947:</strong> Stanislaw Ulam proposes using nuclear explosions for spacecraft propulsion (<strong>Project Helios</strong>).</li>
<li><strong>Freeman Dyson</strong> develops the concept further, leading to <strong>Project Orion</strong>.</li>
<li><strong>Nuclear Propulsion Advantages:</strong>
<ul>
<li>Millions of times more powerful than chemical rockets.</li>
<li>Enables faster travel times and larger spacecraft.</li>
</ul></li>
</ul>
</section>
<section id="orion-spacecraft-design" class="level5">
<h5 class="anchored" data-anchor-id="orion-spacecraft-design">Orion Spacecraft Design</h5>
<ul>
<li><strong>External Detonation:</strong> Small nuclear bombs detonated outside the spacecraft, propelling it forward.</li>
<li><strong>Pusher Plate:</strong> A thick steel plate absorbs the blast and transfers momentum to the spacecraft.</li>
<li><strong>Shock Absorption:</strong> Two-stage shock absorbers minimize the impact on the crew.</li>
<li><strong>Pusher Plate Protection:</strong> Grease coating prevents erosion from repeated blasts.</li>
</ul>
</section>
<section id="orion-variants" class="level5">
<h5 class="anchored" data-anchor-id="orion-variants">Orion Variants</h5>
<ul>
<li><strong>Satellite Version:</strong> 300 tons, single-stage.</li>
<li><strong>Mid-Range Version:</strong> 2,000 tons, suitable for Mars missions.</li>
<li><strong>Super Orion:</strong> 8 million tons, capable of interstellar travel at 10% the speed of light.</li>
</ul>
</section>
<section id="project-cancellation" class="level5">
<h5 class="anchored" data-anchor-id="project-cancellation">Project Cancellation</h5>
<ul>
<li><strong>1963 Limited Test Ban Treaty:</strong> Banned atmospheric nuclear explosions, making Orion launches illegal due to fallout concerns.</li>
<li><strong>Project Closed in 1964.</strong></li>
</ul>
</section>
<section id="orions-legacy" class="level5">
<h5 class="anchored" data-anchor-id="orions-legacy">Orion’s Legacy</h5>
<ul>
<li>Remains the most efficient spacecraft propulsion concept.</li>
<li>Potential for future use if fallout concerns can be addressed.</li>
</ul>
</section>
</section>
<section id="german-battleship-part-on-the-moon" class="level4">
<h4 class="anchored" data-anchor-id="german-battleship-part-on-the-moon">German Battleship Part on the Moon</h4>
<section id="scuttling-of-the-german-fleet" class="level5">
<h5 class="anchored" data-anchor-id="scuttling-of-the-german-fleet">Scuttling of the German Fleet</h5>
<ul>
<li><strong>June 21, 1919:</strong> German Navy scuttled at Scapa Flow, Scotland, following World War I defeat.</li>
</ul>
</section>
<section id="radioactive-steel" class="level5">
<h5 class="anchored" data-anchor-id="radioactive-steel">Radioactive Steel</h5>
<ul>
<li>Post-World War II steel became contaminated with radioactive fallout from nuclear testing.</li>
<li><strong>Cobalt-60</strong> used in steel furnace fire bricks further contributed to contamination.</li>
<li><strong>Pre-Atomic Steel</strong> became a valuable resource for radiation-sensitive experiments.</li>
</ul>
</section>
<section id="surveyor-5-mission" class="level5">
<h5 class="anchored" data-anchor-id="surveyor-5-mission">Surveyor 5 Mission</h5>
<ul>
<li><strong>1967:</strong> NASA’s Surveyor 5 landed on the Moon with a radiation-sensitive alpha-scattering surface analyzer.</li>
<li><strong>Need for Pre-Atomic Steel:</strong> To avoid background radiation interference.</li>
</ul>
</section>
<section id="source-of-pre-atomic-steel" class="level5">
<h5 class="anchored" data-anchor-id="source-of-pre-atomic-steel">Source of Pre-Atomic Steel</h5>
<ul>
<li>The British salvaged parts from the scuttled German fleet at Scapa Flow, providing pre-atomic steel for Surveyor 5.</li>
</ul>
</section>
<section id="notre-dame-cathedral-and-old-lead" class="level5">
<h5 class="anchored" data-anchor-id="notre-dame-cathedral-and-old-lead">Notre Dame Cathedral and Old Lead</h5>
<ul>
<li><strong>Lead-210 Contamination:</strong> Freshly mined lead contains radioactive lead-210, hindering sensitive nuclear experiments.</li>
<li><strong>Old Lead Solution:</strong> Lead used in Notre Dame Cathedral’s roof (circa 1250) was free of lead-210 due to its age.</li>
<li><strong>AEC’s Offer:</strong> Replaced the cathedral’s roof and acquired the old lead for radiation shielding.</li>
</ul>
</section>
</section>
</section>
<section id="chapter-3-the-graphites-on-fire" class="level3">
<h3 class="anchored" data-anchor-id="chapter-3-the-graphites-on-fire">Chapter 3: The Graphites on Fire</h3>
<section id="early-nuclear-power-research-surprisingly-low-fatality-rate" class="level4">
<h4 class="anchored" data-anchor-id="early-nuclear-power-research-surprisingly-low-fatality-rate">Early Nuclear Power Research: Surprisingly Low Fatality Rate</h4>
<ul>
<li><strong>The early decades of nuclear power research had a surprisingly low fatality rate.</strong> More people died in the development of the Ferris wheel than in the experimental phase of nuclear power.</li>
<li>The “peaceful atom” concept, while promising, was still in its early stages and capable of unexpected and significant accidents.</li>
<li>Numerous reactor accidents, both major and minor, occurred due to engineering flaws or operational errors.</li>
<li>Through in-depth study and analysis of these accidents, the principles of reactor design were continuously refined.</li>
</ul>
</section>
<section id="two-classic-semi-disasters-illustrating-design-evolution" class="level4">
<h4 class="anchored" data-anchor-id="two-classic-semi-disasters-illustrating-design-evolution">Two Classic Semi-Disasters: Illustrating Design Evolution</h4>
<ul>
<li>Two examples, the <strong>Windscale Incident</strong> (1957) and the <strong>SL-1 Mystery</strong> (1961), illustrate the evolution of reactor design.</li>
</ul>
</section>
<section id="the-kiss-principle-in-reactor-design" class="level4">
<h4 class="anchored" data-anchor-id="the-kiss-principle-in-reactor-design">The KISS Principle in Reactor Design</h4>
<ul>
<li>The 1950s and 1960s were characterized by the <strong>“keep it simple, stupid” (KISS)</strong> principle in engineering.</li>
<li>Simpler designs were considered better due to:
<ul>
<li>Fewer parts, reducing the probability of failure.</li>
<li>Lower manufacturing costs.</li>
</ul></li>
<li>Simplified machines were believed to be inherently safer and more economical.</li>
</ul>
</section>
<section id="public-expectations-and-the-paradox-of-nuclear-power" class="level4">
<h4 class="anchored" data-anchor-id="public-expectations-and-the-paradox-of-nuclear-power">Public Expectations and the Paradox of Nuclear Power</h4>
<ul>
<li>In the 1950s, the public desired a clean, unlimited, and inexpensive power source, with safety as an implicit expectation.</li>
<li>Early nuclear power development may have fallen short of these expectations.</li>
<li>The <strong>paradox of nuclear power</strong> is that striving for engineering simplicity often leads to accidents like fires, meltdowns, and contamination.</li>
<li>Simpler and more economical large-scale reactor projects were more prone to malfunctions.</li>
</ul>
</section>
<section id="the-windscale-incident-a-classic-example-of-simplicity-leading-to-disaster" class="level4">
<h4 class="anchored" data-anchor-id="the-windscale-incident-a-classic-example-of-simplicity-leading-to-disaster">The Windscale Incident: A Classic Example of Simplicity Leading to Disaster</h4>
<section id="the-windscale-reactors-design-and-construction" class="level5">
<h5 class="anchored" data-anchor-id="the-windscale-reactors-design-and-construction">The Windscale Reactors: Design and Construction</h5>
<ul>
<li>The <strong>Windscale plutonium production reactors</strong>, built in Sellafield, England (1947), exemplify the paradox of nuclear power.</li>
<li>The design was based on limited information about the <strong>X-10 pile at Oak Ridge, Tennessee</strong>, and a successful test of the <strong>Bepo reactor at Harwell</strong>.</li>
<li>The British nuclear industry prioritized simplicity and cost-effectiveness:
<ul>
<li><strong>Graphite moderated</strong> with <strong>metallic, natural uranium fuel</strong>.</li>
<li><strong>Air cooling</strong> was used to avoid the complexities of liquid cooling systems employed at the <strong>Hanford Works</strong>.</li>
<li>Eight large electric blowers forced air through the core and up a smokestack.</li>
</ul></li>
<li>Construction, initially problematic, was eventually completed by 5,000 workers.
<ul>
<li>Concrete was poured before the design was finalized.</li>
<li>Over 300 architects, engineers, and surveyors were rushed to complete the plans.</li>
</ul></li>
</ul>
</section>
<section id="design-problems-and-modifications" class="level5">
<h5 class="anchored" data-anchor-id="design-problems-and-modifications">Design Problems and Modifications</h5>
<ul>
<li><strong>Problems arose due to the rushed design.</strong></li>
<li>The <strong>fuel loading machine</strong>, designed to automatically insert uranium slugs, failed to function.
<ul>
<li>It was the most complex part of the project and proved too ambitious for the technology of the time.</li>
<li>A manual workaround was implemented: a worker would be lowered onto the reactor face to insert fuel cartridges using a stick.</li>
</ul></li>
<li>Issues also arose with the air blowers and, most significantly, with the graphite and fuel.</li>
</ul>
</section>
<section id="the-wigner-effect-a-hidden-danger-in-graphite" class="level5">
<h5 class="anchored" data-anchor-id="the-wigner-effect-a-hidden-danger-in-graphite">The Wigner Effect: A Hidden Danger in Graphite</h5>
<ul>
<li><strong>Existing knowledge of nuclear graphite was incomplete and, in some cases, inaccurate.</strong></li>
<li>American scientists were prohibited from assisting the British project due to the <strong>Atomic Energy Act</strong>.</li>
<li>However, warnings about the <strong>Wigner effect</strong> were conveyed to the British.</li>
<li><strong>The Wigner effect:</strong>
<ul>
<li>Predicted by <strong>Leo Szilard</strong> and <strong>Eugene Wigner</strong> during World War II.</li>
<li>High-speed neutrons, used for moderation, displace carbon atoms in the graphite’s crystal lattice.</li>
<li>This displacement can cause the graphite to change shape, potentially damaging the reactor’s precision.</li>
<li>Displaced carbon atoms store energy, which can be suddenly released, causing a fire.</li>
<li>A graphite fire can ignite the uranium fuel, which is also highly flammable.</li>
<li>Water is ineffective in extinguishing a graphite fire and can even worsen the situation by providing oxygen and releasing explosive hydrogen.</li>
<li><strong>Annealing</strong> – carefully raising and lowering the graphite’s temperature – is necessary to release the stored energy safely.</li>
</ul></li>
</ul>
</section>
<section id="teller-and-cockcrofts-warnings" class="level5">
<h5 class="anchored" data-anchor-id="teller-and-cockcrofts-warnings">Teller and Cockcroft’s Warnings</h5>
<ul>
<li><strong>Edward Teller</strong> informed the British about the Wigner effect during a visit to Sellafield in 1948.</li>
<li><strong>John Cockcroft</strong>, after a trip to the United States, warned about the risk of a burst fuel cartridge contaminating the surrounding area.
<ul>
<li>He recommended filtering the air exhaust, a suggestion that was initially met with resistance.</li>
</ul></li>
</ul>
</section>
<section id="the-windscale-reactors-structure-and-filters" class="level5">
<h5 class="anchored" data-anchor-id="the-windscale-reactors-structure-and-filters">The Windscale Reactors: Structure and Filters</h5>
<ul>
<li>The Windscale reactors were massive structures:
<ul>
<li>2,000 tons of graphite in an octagonal stack (25 feet long, 50 feet in diameter).</li>
<li>Enclosed in a 7-foot-thick concrete bio-shield lined with steel plates.</li>
<li>Cooling air drawn in by eight blowers through holes in the core and up a 410-foot stack.</li>
</ul></li>
<li>Incorporating filters into the existing design was deemed impractical.</li>
<li>Cockcroft insisted on filters, and they were eventually installed at the top of the exhaust stacks, despite being considered a suboptimal location.
<ul>
<li>These filters were dubbed <strong>“Cockcroft’s Folly.”</strong></li>
</ul></li>
</ul>
</section>
<section id="criticality-concerns-and-modifications" class="level5">
<h5 class="anchored" data-anchor-id="criticality-concerns-and-modifications">Criticality Concerns and Modifications</h5>
<ul>
<li>Before Windscale Unit 1’s startup, Cockcroft raised concerns about the critical mass calculation, suggesting it could be off by as much as 250%.</li>
<li>Engineers sought ways to improve core reactivity by reducing neutron absorption.</li>
<li>They decided to shorten the aluminum fins on the fuel cartridges by 1/16th of an inch to reduce neutron absorption.</li>
<li>This modification, implemented by a team led by <strong>Tom Toohey</strong>, proved successful.</li>
</ul>
</section>
<section id="initial-operation-and-early-issues" class="level5">
<h5 class="anchored" data-anchor-id="initial-operation-and-early-issues">Initial Operation and Early Issues</h5>
<ul>
<li><strong>Windscale Unit 1 achieved criticality in October 1950, followed by Unit 2 in June 1951.</strong></li>
<li><strong>Toohey produced the first piece of plutonium metal in Great Britain on March 28, 1952.</strong></li>
<li>Despite some operational challenges, including concerns about fuel cartridge bursts, the reactors were deemed operational.</li>
<li>The <strong>Burst Cartridge Detection Gear (BCDG)</strong>, designed to detect ruptured fuel cartridges, had a tendency to damage the cartridges itself.</li>
<li>Unexplained temperature rises occurred in both units in 1952 but were managed by increasing blower speed.</li>
</ul>
</section>
<section id="the-ninth-annealing-and-the-onset-of-the-fire" class="level5">
<h5 class="anchored" data-anchor-id="the-ninth-annealing-and-the-onset-of-the-fire">The Ninth Annealing and the Onset of the Fire</h5>
<ul>
<li>By October 1957, Windscale Unit 1 was due for its ninth graphite annealing, a routine procedure to release Wigner energy.</li>
<li><strong>The Annealing Process:</strong>
<ul>
<li>Main fans were turned off, allowing the core temperature to rise from its normal operating range (50-80°C) to approximately 250°C.</li>
<li>Thermocouples monitored the core temperature as Wigner energy was released.</li>
<li>The core was then cooled down using the blowers.</li>
</ul></li>
<li>Challenges arose due to the uneven distribution of the Wigner effect and cracks in some graphite bricks.</li>
<li><strong>The presence of polonium-210 and tritium production materials (AM and LM cans) was not considered to affect annealing.</strong></li>
<li><strong>October 7, 1957:</strong>
<ul>
<li>Annealing began at 11:45 a.m.</li>
<li>Control rods were slowly withdrawn to initiate nuclear heating.</li>
<li>Strange thermocouple readings led to temporary halts in rod withdrawal.</li>
<li>The pile reached criticality at 7:25 p.m.</li>
<li>Operators adjusted individual control rods to focus nuclear heating on the lower front of the pile.</li>
</ul></li>
</ul>
</section>
<section id="tuesday-october-8-initial-signs-of-trouble" class="level5">
<h5 class="anchored" data-anchor-id="tuesday-october-8-initial-signs-of-trouble">Tuesday, October 8: Initial Signs of Trouble</h5>
<ul>
<li><strong>October 8, 1957:</strong>
<ul>
<li>Two thermocouples reached 250°C after midnight, indicating the start of the annealing process.</li>
<li>The reactor was shut down to allow the Wigner effect to spread and release energy.</li>
<li><strong>Ian Robertson</strong>, the pile physicist, left for home at 2:00 a.m.</li>
<li>By 4:00 a.m., the reactor was fully shut down.</li>
<li>Thermocouple readings started falling by 9:00 a.m., suggesting the annealing was not self-propagating as expected.</li>
<li>Robertson returned to the control room, feeling unwell due to the flu.</li>
<li>Operators noticed unusual behavior, with one thermocouple spiking to 380°C and difficulty controlling it with a single rod.</li>
</ul></li>
</ul>
</section>
<section id="wednesday-october-9-rising-temperatures-and-abnormal-readings" class="level5">
<h5 class="anchored" data-anchor-id="wednesday-october-9-rising-temperatures-and-abnormal-readings">Wednesday, October 9: Rising Temperatures and Abnormal Readings</h5>
<ul>
<li><strong>October 9, 1957:</strong>
<ul>
<li>The reactor remained in shutdown mode, and annealing seemed to progress normally.</li>
<li>In the afternoon, core temperatures rose as high as 415°C, considered abnormal but not yet cause for panic.</li>
<li>Following the instruction manual, operators closed inspection ports and the stack hatch.</li>
<li>At 10:15 p.m., they opened fan dampers for cooling, and core temperatures decreased.</li>
<li><strong>October 10, 1957 (shortly after midnight):</strong>
<ul>
<li>Temperatures began rising again, reaching 400°C.</li>
<li>Opening the dampers had little effect.</li>
<li>By 2:15 a.m., a thermocouple reached 412°C, a highly abnormal reading.</li>
<li>Dampers were opened again, following the manual’s instructions.</li>
<li>Temperatures fluctuated as dampers were opened and closed.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="thursday-october-10-radiation-detection-and-growing-concerns" class="level5">
<h5 class="anchored" data-anchor-id="thursday-october-10-radiation-detection-and-growing-concerns">Thursday, October 10: Radiation Detection and Growing Concerns</h5>
<ul>
<li><strong>October 10, 1957:</strong>
<ul>
<li>The radiation monitor at the top of the exhaust stack detected activity, unusual for a shut-down reactor.</li>
<li>Radioactivity was also detected on the roof of the <strong>Sellafield Meteorological Station</strong>.</li>
<li><strong>Ron Gosden</strong>, the shift manager, followed procedures and opened the dampers.</li>
<li>At 1:30 p.m., the stack radiation monitor went into alarm mode.</li>
<li>Fearing a burst fuel cartridge, Gosden turned on the shutdown fans.</li>
<li>At 2:30 p.m., Gosden ordered the pile to be “blown cold,” activating all fans at high speed.</li>
<li>The BCDG, designed for lower temperatures, was ineffective in locating the suspected burst cartridge.</li>
<li>Gosden informed <strong>Tom Hughes</strong>, the acting works manager, about potential issues at Unit 1.</li>
<li><strong>Hugh Howells</strong>, the health physics manager, also alerted Hughes about abnormal air contamination.</li>
<li>Hughes contacted <strong>H.G. Davey</strong>, the works general manager, reporting a potential meltdown.</li>
</ul></li>
</ul>
</section>
<section id="discovering-the-fire" class="level5">
<h5 class="anchored" data-anchor-id="discovering-the-fire">Discovering the Fire</h5>
<ul>
<li>At Unit 1, the staff believed they had located the burst cartridge and removed the plug covering the suspect fuel channel.</li>
<li>They discovered that the channel was <strong>cherry red</strong>, indicating a fire.</li>
<li>Further investigation revealed that <strong>the reactor itself was on fire</strong>, and it had been burning for two days.</li>
<li>Attempts to push out the burning fuel cartridges with a metal rod were unsuccessful.</li>
<li>Gosden realized the severity of the situation and the need to create a firebreak to prevent the entire reactor from igniting.</li>
</ul>
</section>
<section id="fighting-the-fire" class="level5">
<h5 class="anchored" data-anchor-id="fighting-the-fire">Fighting the Fire</h5>
<ul>
<li>A team of eight men, equipped with protective gear, began manually removing burning fuel cartridges using long steel bars.</li>
<li>Scientists gathered in Davey’s office to determine the cause of the fire and assess the risks.</li>
<li>A core temperature of 1,200°C was a theoretical point for a secondary Wigner energy release, potentially leading to a catastrophic temperature spike and the uncontainable spread of fission products.</li>
<li>Thermocouples reported a core temperature of 1,200°C, and the theoretical crisis point was revised to 1,500°C.</li>
</ul>
</section>
<section id="friday-october-11-escalation-and-desperate-measures" class="level5">
<h5 class="anchored" data-anchor-id="friday-october-11-escalation-and-desperate-measures">Friday, October 11: Escalation and Desperate Measures</h5>
<ul>
<li><strong>October 11, 1957:</strong>
<ul>
<li>Davey summoned Toohey, informing him of the fire.</li>
<li>Toohey observed the fire at the reactor face and the red glow at the back end of the core through an inspection hole.</li>
<li>The fire intensified, with flames changing from red to yellow and then to hot blue.</li>
<li>Toohey, despite the risks, instructed the <strong>Works Fire Brigade</strong> to stand by with equipment.</li>
<li>By midnight, the fire was contained to 120 fuel channels (out of 3,440) by creating a firebreak.</li>
<li>Workers used scaffolding poles to push burning fuel cartridges into a water trough at the back of the core.</li>
<li>Some cartridges were jammed, and poles returned glowing red with molten uranium.</li>
<li>At 1:00 a.m., the local constable was alerted about a potential emergency.</li>
<li>Scientists attempted to smother the fire with carbon dioxide, but it proved ineffective.</li>
<li>Toohey discovered that inspection port covers were stuck due to the fire’s intense oxygen intake.</li>
<li>He observed blue flames shooting out the back of the reactor and hitting the concrete wall.</li>
<li>Fearing a breach in the bio-shield and the release of fission products, Toohey decided to use water as a last resort.</li>
</ul></li>
</ul>
</section>
<section id="using-water-to-extinguish-the-fire" class="level5">
<h5 class="anchored" data-anchor-id="using-water-to-extinguish-the-fire">Using Water to Extinguish the Fire</h5>
<ul>
<li>Four fire hoses were improvised and inserted into the core through fuel holes.</li>
<li>Water was turned on slowly, and fortunately, no explosion occurred.</li>
<li>The water cascaded down the back of the reactor, but the flames persisted.</li>
<li>After an hour, Toohey ordered the fans to be turned off, and the fire subsided rapidly.</li>
<li>Hoses were kept running for 30 hours as a precaution.</li>
<li>The ground floor flooded with highly radioactive water.</li>
</ul>
</section>
<section id="the-role-of-cockcrofts-filters" class="level5">
<h5 class="anchored" data-anchor-id="the-role-of-cockcrofts-filters">The Role of Cockcroft’s Filters</h5>
<ul>
<li><strong>Cockcroft’s filters</strong>, initially dismissed as “folly,” played a crucial role in preventing the widespread contamination of northern England.</li>
<li>They filtered out a significant portion of the 20 tons of burned reactor fuel and fission products.</li>
<li>The term “Cockcroft’s Folly” was quickly abandoned.</li>
</ul>
</section>
<section id="radioactivity-releases-and-aftermath" class="level5">
<h5 class="anchored" data-anchor-id="radioactivity-releases-and-aftermath">Radioactivity Releases and Aftermath</h5>
<ul>
<li>Despite the filters, two major radioactivity releases occurred:
<ul>
<li>Midnight on Thursday, before the firebreak was fully established.</li>
<li>Friday morning, when water was first applied to the fire.</li>
</ul></li>
<li>The estimated release was at least 20,000 curies of radioactive material.</li>
<li><strong>Comparison to other incidents:</strong>
<ul>
<li>The <strong>Sedan nuclear bomb test</strong> released 44 times more radiation.</li>
<li>The <strong>Chernobyl disaster</strong> released over 1,000 times more radiation.</li>
</ul></li>
<li>The radioactive plume primarily drifted over the Irish Sea.</li>
<li><strong>Iodine-131</strong>, with its short half-life but tendency to concentrate in the thyroid gland and milk, was a major concern.</li>
<li>The British government avoided mass evacuations but implemented measures to mitigate the impact of iodine-131 contamination.</li>
<li>Milk from surrounding areas was confiscated, diluted, and disposed of in the Irish Sea for a month.</li>
<li>Windscale Unit 2 was shut down.</li>
<li>Investigations into the incident highlighted inadequate engineering, cost-cutting measures, and a rushed schedule as contributing factors.</li>
<li>The specific cause of the fire remains a subject of debate.</li>
</ul>
</section>
<section id="lessons-learned-and-long-term-impact" class="level5">
<h5 class="anchored" data-anchor-id="lessons-learned-and-long-term-impact">Lessons Learned and Long-Term Impact</h5>
<ul>
<li>The Windscale incident revealed the limitations of the “keep it simple” approach in nuclear reactor design.</li>
<li>It demonstrated the need for a shift in engineering mindset, prioritizing safety and quality over economy and speed.</li>
<li>Air-cooled reactors were subsequently abandoned.</li>
<li>The Windscale reactors are undergoing robotic disassembly, scheduled for completion by 2037.</li>
<li>Follow-up studies of the 450 workers involved in controlling the fire have not shown unusual rates of cancer or radiation-induced illnesses.</li>
</ul>
</section>
</section>
<section id="the-search-for-a-safer-reactor-design" class="level4">
<h4 class="anchored" data-anchor-id="the-search-for-a-safer-reactor-design">The Search for a Safer Reactor Design</h4>
<section id="the-pwr-a-complex-but-safe-alternative" class="level5">
<h5 class="anchored" data-anchor-id="the-pwr-a-complex-but-safe-alternative">The PWR: A Complex but Safe Alternative</h5>
<ul>
<li><strong>Hyman Rickover’s pressurized water reactor (PWR)</strong>, used in nuclear submarines, emerged as a potentially safer alternative to the simpler designs.</li>
<li><strong>PWR Characteristics:</strong>
<ul>
<li>Complex design with expensive fuel, exotic materials, numerous moving parts, and thousands of welds.</li>
<li>Rickover’s rigorous approach to training and psychological testing of personnel.</li>
<li>Excellent operational record with no harmful incidents.</li>
</ul></li>
<li>The PWR’s complexity and cost made it less appealing to industry, which traditionally favored cheaper solutions.</li>
</ul>
</section>
<section id="the-national-reactor-testing-station-nrts" class="level5">
<h5 class="anchored" data-anchor-id="the-national-reactor-testing-station-nrts">The National Reactor Testing Station (NRTS)</h5>
<ul>
<li>The <strong>Westinghouse S-1W</strong>, Rickover’s submarine reactor, was extensively tested at the <strong>National Reactor Testing Station (NRTS)</strong> by 1953.</li>
<li><strong>NRTS:</strong>
<ul>
<li>Established in 1949 by the <strong>Atomic Energy Commission (AEC)</strong> at the former <strong>Naval Proving Ground</strong> in Idaho.</li>
<li>890 square miles of remote desert, ideal for conducting nuclear experiments without risk to populated areas.</li>
<li>Became a hub for reactor experiments, with 52 conducted over the next 30 years.</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-boiling-water-reactor-bwr-a-radical-simplification-of-the-pwr" class="level4">
<h4 class="anchored" data-anchor-id="the-boiling-water-reactor-bwr-a-radical-simplification-of-the-pwr">The Boiling Water Reactor (BWR): A Radical Simplification of the PWR</h4>
<section id="samuel-untermyers-proposal" class="level5">
<h5 class="anchored" data-anchor-id="samuel-untermyers-proposal">Samuel Untermyer’s Proposal</h5>
<ul>
<li><strong>Samuel Untermyer II</strong>, an MIT engineer, proposed a simplification of the PWR, the <strong>boiling water reactor (BWR)</strong>.</li>
<li><strong>PWR Design:</strong>
<ul>
<li>Ordinary water as both coolant and neutron moderator.</li>
<li>Closed-loop circulation of pressurized water to prevent boiling.</li>
<li>Superheated water in the primary loop heats a secondary boiling water loop, generating steam for power production.</li>
<li>Requires enriched uranium fuel due to water’s inefficiency as a moderator.</li>
<li>Inherent safety features: coolant loss leads to moderator loss and reactor shutdown.</li>
</ul></li>
</ul>
</section>
<section id="the-bwr-concept" class="level5">
<h5 class="anchored" data-anchor-id="the-bwr-concept">The BWR Concept</h5>
<ul>
<li><strong>Untermyer’s BWR eliminated the primary loop</strong>:
<ul>
<li>Water was boiled directly by the reactor, simplifying the design and reducing the number of components.</li>
<li>Steam generators and pressurizers were eliminated.</li>
</ul></li>
<li><strong>Arguments against the BWR:</strong>
<ul>
<li>Physicists argued that boiling moderator would lead to unpredictable criticality and compromise safety.</li>
<li>Concerns about fuel vibrating loose and contaminating the steam loop.</li>
</ul></li>
</ul>
</section>
<section id="untermyers-counterarguments" class="level5">
<h5 class="anchored" data-anchor-id="untermyers-counterarguments">Untermyer’s Counterarguments</h5>
<ul>
<li>Untermyer argued that the boiling moderator would enhance stability and control:
<ul>
<li>Steam bubble formation displaces moderator, reducing fission rate and power.</li>
<li>Reduced fission rate stops boiling, bubbles collapse, moderator density increases, fission rate climbs, and boiling restarts.</li>
</ul></li>
<li><strong>BWR Self-Regulation:</strong>
<ul>
<li>The BWR would be self-regulating, adjusting power output based on steam demand without constant control adjustments.</li>
<li>Increased steam demand cools the boiling action, increasing steam production.</li>
<li>Reduced demand increases boiling, powering down the reactor.</li>
<li>Coolant loss leads to immediate shutdown.</li>
</ul></li>
</ul>
</section>
<section id="advantages-of-the-bwr" class="level5">
<h5 class="anchored" data-anchor-id="advantages-of-the-bwr">Advantages of the BWR</h5>
<ul>
<li>The BWR was inherently safe, with fewer welds and valves prone to failure.</li>
</ul>
</section>
<section id="the-borax-experiments" class="level5">
<h5 class="anchored" data-anchor-id="the-borax-experiments">The BORAX Experiments</h5>
<ul>
<li>Untermyer secured an AEC contract (<strong>BORAX</strong>) to test the BWR concept at the NRTS in 1953.</li>
<li><strong>BORAX-1:</strong>
<ul>
<li>Built with minimal resources in the desert.</li>
<li>Operated during summer months due to lack of housing.</li>
<li>The core tank was semi-buried, with plumbing exposed.</li>
</ul></li>
<li><strong>Successful Testing:</strong>
<ul>
<li>The reactor performed flawlessly, validating Untermyer’s control hypothesis.</li>
<li>70 tests simulated various accident scenarios, including pipe breaks, valve failures, and operator errors.</li>
<li>BORAX-1 proved resilient under these conditions.</li>
</ul></li>
</ul>
</section>
<section id="the-maximum-accident-test" class="level5">
<h5 class="anchored" data-anchor-id="the-maximum-accident-test">The Maximum Accident Test</h5>
<ul>
<li>A final test simulated a maximum accident scenario:
<ul>
<li>Control rods were rigged to blow out of the core, inducing a prompt supercritical state.</li>
<li>The resulting steam explosion was more powerful than anticipated, categorized as a criticality accident.</li>
</ul></li>
<li><strong>Explosion and Aftermath:</strong>
<ul>
<li>The explosion was equivalent to 70 pounds of high explosive, ejecting the control mechanism and scattering fuel fragments.</li>
<li>Despite the explosion, the reactor instantly shut down due to the steam flash.</li>
<li>The damaged reactor remained in standby mode, ready for reloading.</li>
</ul></li>
</ul>
</section>
<section id="bwr-development-and-legacy" class="level5">
<h5 class="anchored" data-anchor-id="bwr-development-and-legacy">BWR Development and Legacy</h5>
<ul>
<li>Despite the overshoot in the final test, the BORAX experiments demonstrated the viability of the BWR concept.</li>
<li>Concerns about fuel contamination proved unfounded.</li>
<li>Today, 90 BWR power plants operate globally, considered among the safest reactor designs.</li>
</ul>
</section>
</section>
<section id="the-armys-nuclear-power-program-small-simple-reactors-for-remote-locations" class="level4">
<h4 class="anchored" data-anchor-id="the-armys-nuclear-power-program-small-simple-reactors-for-remote-locations">The Army’s Nuclear Power Program: Small, Simple Reactors for Remote Locations</h4>
<section id="the-distant-early-warning-dew-line" class="level5">
<h5 class="anchored" data-anchor-id="the-distant-early-warning-dew-line">The Distant Early Warning (DEW) Line</h5>
<ul>
<li>In 1953, the US Army developed the <strong>Distant Early Warning (DEW) line</strong>:
<ul>
<li>A network of radar stations above the Arctic Circle to detect potential Soviet bomber attacks.</li>
<li>Powering these remote stations posed logistical challenges.</li>
</ul></li>
</ul>
</section>
<section id="the-need-for-nuclear-power" class="level5">
<h5 class="anchored" data-anchor-id="the-need-for-nuclear-power">The Need for Nuclear Power</h5>
<ul>
<li>Diesel generators were initially used but required substantial fuel deliveries, which were difficult in the Arctic winter.</li>
<li>Accumulating fuel barrels also posed an environmental hazard.</li>
<li>The Army sought to develop nuclear power solutions for its remote installations.</li>
</ul>
</section>
<section id="army-nuclear-power-plant-configurations" class="level5">
<h5 class="anchored" data-anchor-id="army-nuclear-power-plant-configurations">Army Nuclear Power Plant Configurations</h5>
<ul>
<li>The Army envisioned three types of small, simple nuclear power plants:
<ul>
<li><strong>Stationary (S):</strong>
<ul>
<li>Transportable in pre-manufactured sections.</li>
<li>Minimal site preparation and unskilled labor for installation.</li>
<li>Low maintenance, three-year fuel cycle, and small operating crew.</li>
<li>Ideal for fixed radar stations.</li>
</ul></li>
<li><strong>Mobile (M):</strong>
<ul>
<li>Lighter than stationary plants, requiring no assembly.</li>
<li>Transportable by heavy truck for rapid deployment.</li>
<li>Suitable for encampments, similar to MASH units.</li>
</ul></li>
<li><strong>Portable (P):</strong>
<ul>
<li>Jeep-transportable, similar to portable generators.</li>
<li>Eliminated the need for liquid fuel.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="power-levels-and-designations" class="level5">
<h5 class="anchored" data-anchor-id="power-levels-and-designations">Power Levels and Designations</h5>
<ul>
<li>Three power levels were defined:
<ul>
<li><strong>L:</strong> Low</li>
<li><strong>S:</strong> Medium</li>
<li><strong>H:</strong> High</li>
</ul></li>
<li><strong>Designation System:</strong>
<ul>
<li>Configuration letter (S, M, P) + Power level letter (L, S, H) + Version number.</li>
</ul></li>
</ul>
</section>
<section id="the-sl-1-reactor-prototype-and-testing" class="level5">
<h5 class="anchored" data-anchor-id="the-sl-1-reactor-prototype-and-testing">The SL-1 Reactor: Prototype and Testing</h5>
<ul>
<li>The <strong>SL-1 (Stationary Low-power reactor, version 1)</strong> was the first prototype for testing.</li>
<li><strong>Design and Construction:</strong>
<ul>
<li>Designed by <strong>Argonne National Lab</strong> and built by <strong>Combustion Engineering</strong>.</li>
<li>Tested at the NRTS, five miles from the Navy’s S-1W compound.</li>
<li>Reactor tank housed in a steel prefab building backfilled with gravel and steel punchings (no concrete).</li>
<li>Building was not designed as a robust containment structure.</li>
<li>Three-level building:
<ul>
<li>Lower: Tank and gravel.</li>
<li>Middle: Turbine deck and reactor top access.</li>
<li>Upper: Fan room for air-cooled steam condenser.</li>
</ul></li>
<li>Control room in a separate tin building connected by an external staircase.</li>
</ul></li>
</ul>
</section>
<section id="engineering-considerations-and-design-choices" class="level5">
<h5 class="anchored" data-anchor-id="engineering-considerations-and-design-choices">Engineering Considerations and Design Choices</h5>
<ul>
<li>The SL-1 was designed for simple, rapid deployment in Arctic conditions.</li>
<li>The use of concrete was avoided due to its impracticality in freezing temperatures.</li>
<li><strong>Foolproof Design:</strong>
<ul>
<li>The Army sought a meltdown-proof reactor, resilient to mishandling.</li>
<li>Untermyer’s BWR, proven to be extremely robust in the BORAX experiments, was selected.</li>
</ul></li>
<li><strong>Simplified Control System:</strong>
<ul>
<li>A single, centrally located cruciform control rod replaced multiple independent rods.</li>
<li>Four auxiliary rods were used for neutron flux leveling and even fuel burning.</li>
</ul></li>
</ul>
</section>
<section id="sl-1-operation-and-security" class="level5">
<h5 class="anchored" data-anchor-id="sl-1-operation-and-security">SL-1 Operation and Security</h5>
<ul>
<li>SL-1 achieved criticality on August 11, 1958, and began power production on October 24.</li>
<li>The project received relatively little attention at the NRTS compared to other experiments.</li>
<li>Security was minimal, relying primarily on the remote location.</li>
</ul>
</section>
<section id="training-and-personnel" class="level5">
<h5 class="anchored" data-anchor-id="training-and-personnel">Training and Personnel</h5>
<ul>
<li>The Air Force and Navy participated in the SL-1 project, with Seabees and Airmen training alongside Army personnel.</li>
<li><strong>Training:</strong>
<ul>
<li>Four months of classroom instruction at Fort Belvoir, Virginia.</li>
<li>Four months of control room simulator training and time on a training reactor.</li>
</ul></li>
<li><strong>Initial Trainees:</strong>
<ul>
<li>Early classes were comprised of experienced power company personnel and enthusiastic engineers.</li>
<li>Later classes had less experienced and motivated trainees.</li>
</ul></li>
<li><strong>Jack Burns and Dick Legg:</strong>
<ul>
<li>Part of the fourth wave of trainees, assigned to SL-1 in late 1959.</li>
</ul></li>
<li><strong>Jack Burns:</strong>
<ul>
<li>Army private, joined at 17, married at 19, facing marital problems.</li>
<li>Reckless driver, heavy drinker, financially unstable, disliked supervision.</li>
</ul></li>
<li><strong>Dick Legg:</strong>
<ul>
<li>CB, known for pranks and a quick temper.</li>
</ul></li>
</ul>
</section>
<section id="incident-at-a-friends-house" class="level5">
<h5 class="anchored" data-anchor-id="incident-at-a-friends-house">Incident at a Friend’s House</h5>
<ul>
<li>In May 1960, Burns and Legg got into a fistfight after leaving the White Elephant Supper Club intoxicated.</li>
<li>The fight was triggered by Legg’s comments about a prostitute Burns had been with.</li>
<li>A sergeant intervened and separated them.</li>
</ul>
</section>
<section id="deteriorating-conditions-at-sl-1" class="level5">
<h5 class="anchored" data-anchor-id="deteriorating-conditions-at-sl-1">Deteriorating Conditions at SL-1</h5>
<ul>
<li>By December 1961, Burns was deemed not ready for promotion.</li>
<li>SL-1 suffered from underfunding, mismanagement, and inadequate oversight:
<ul>
<li>Limited personnel assigned to the project.</li>
<li>Lack of a policy and procedures manual.</li>
<li>Concerns about the discipline and training of new trainees.</li>
</ul></li>
<li><strong>Technical Issues:</strong>
<ul>
<li>Leaking water seals.</li>
<li>Crumbling core bottom.</li>
<li>Sticky controls.</li>
</ul></li>
<li>Despite these issues, the reactor remained functional.</li>
<li>Cobalt flux wires were recently installed to map neutron distribution.</li>
</ul>
</section>
<section id="the-night-of-the-incident" class="level5">
<h5 class="anchored" data-anchor-id="the-night-of-the-incident">The Night of the Incident</h5>
<ul>
<li><strong>January 3, 1961:</strong>
<ul>
<li>Legg and Burns reported for the second shift at SL-1 (4:00 p.m.).</li>
<li><strong>Richard McKinley</strong>, an Air Force trainee, was present for observation and assistance.</li>
<li>Their task was to reassemble the reactor top after the flux wire installation.</li>
<li>Progress was slow.</li>
<li><strong>7:00 p.m.:</strong> Arlene Burns informed her husband (Jack) about the end of their marriage.</li>
<li>Arlene called back three times but received no answer.</li>
<li><strong>9:00 p.m.:</strong> Arlene’s last call, expressing concern about a possible problem at SL-1.</li>
</ul></li>
</ul>
</section>
<section id="the-alarm-and-initial-response" class="level5">
<h5 class="anchored" data-anchor-id="the-alarm-and-initial-response">The Alarm and Initial Response</h5>
<ul>
<li><strong>9:01 p.m.:</strong> The NRTS fire stations and security center received a fire alarm signal from SL-1.</li>
<li>The nearest fire station responded, noting the potential hazards listed for SL-1.</li>
<li><strong>9:09 p.m.:</strong> Firemen arrived at the facility.</li>
<li>No visible signs of fire or damage were observed.</li>
<li>The control room was empty, despite the 24-hour staffing requirement.</li>
<li>Radiation alarms were sounding.</li>
<li>Portable radiation counters went off-scale near the reactor silo entrance.</li>
</ul>
</section>
<section id="health-physicists-investigation" class="level5">
<h5 class="anchored" data-anchor-id="health-physicists-investigation">Health Physicists’ Investigation</h5>
<ul>
<li><strong>9:17 p.m.:</strong> A health physicist (HP) from the Materials Test Reactor arrived, equipped with protective gear.</li>
<li>His radiation counter pegged near the silo staircase.</li>
<li>No personnel were found in the auxiliary buildings.</li>
<li>It was concluded that the three men must be inside the reactor silo.</li>
</ul>
</section>
<section id="entering-the-silo" class="level5">
<h5 class="anchored" data-anchor-id="entering-the-silo">Entering the Silo</h5>
<ul>
<li>Using a Jordan Redector, <strong>Assistant Chief Moschberger</strong> and two HPs, in full protective gear, approached the silo.</li>
<li>The detector registered 500 rads per hour near the silo door, an unprecedentedly high reading.</li>
<li>Moschberger briefly observed the interior:
<ul>
<li>Water on the floor.</li>
<li>Scattered gravel and steel punchings.</li>
<li>Damaged reactor top.</li>
</ul></li>
<li>Limited visibility due to fogged face mask prevented him from locating the missing men.</li>
</ul>
</section>
<section id="valerio-and-duckworths-search" class="level5">
<h5 class="anchored" data-anchor-id="valerio-and-duckworths-search">Valerio and Duckworth’s Search</h5>
<ul>
<li><strong>10:30 p.m.:</strong> <strong>Ed Valario</strong> (HP in charge of SL-1) and <strong>Paul Duckworth</strong> (Combustion Engineering) arrived.</li>
<li>They donned air packs and entered the silo.</li>
<li>Their detector registered 1,500 rads per hour, allowing for only a short exposure time.</li>
<li>Valario heard moaning and found <strong>Jack Burns</strong> on the floor, severely injured.</li>
<li><strong>Richard McKinley</strong> was found dead, thrown against a concrete block.</li>
<li><strong>Dick Legg</strong> was not visible.</li>
</ul>
</section>
<section id="rescue-attempt-and-burns-death" class="level5">
<h5 class="anchored" data-anchor-id="rescue-attempt-and-burns-death">Rescue Attempt and Burns’ Death</h5>
<ul>
<li>A five-man rescue team was assembled to retrieve Burns.</li>
<li>Each team member was limited to 60 seconds inside the silo.</li>
<li>They retrieved Burns, encountering respirator failures and limited visibility.</li>
<li>They scanned for Legg but did not find him.</li>
<li>Burns was found to be highly radioactive, emitting 1,000 rads per hour.</li>
<li>He died in the ambulance at 11:00 p.m.</li>
<li>The ambulance driver abandoned the vehicle in the desert, taking the night nurse with him.</li>
</ul>
</section>
<section id="the-aftermath-and-investigation" class="level5">
<h5 class="anchored" data-anchor-id="the-aftermath-and-investigation">The Aftermath and Investigation</h5>
<ul>
<li>The AEC faced a complex situation:
<ul>
<li>Two contaminated bodies (one still inside the silo).</li>
<li>One missing person.</li>
<li>A highly contaminated reactor.</li>
</ul></li>
<li>Extensive planning, mock-ups, training, and personnel were required to address the situation.</li>
<li>McKinley’s body was retrieved.</li>
<li>Legg was eventually found pinned to the ceiling by a piece of the control rod, his remains severely damaged.</li>
<li>A remote-operated crane extracted Legg’s body nine days after the incident.</li>
</ul>
</section>
<section id="autopsy-and-burial" class="level5">
<h5 class="anchored" data-anchor-id="autopsy-and-burial">Autopsy and Burial</h5>
<ul>
<li>Specialized autopsy procedures were developed.</li>
<li>Decontamination attempts were unsuccessful due to embedded reactor fuel fragments.</li>
<li>The bodies were buried in lead coffins, with some parts treated as radioactive waste.</li>
</ul>
</section>
<section id="cause-of-the-explosion" class="level5">
<h5 class="anchored" data-anchor-id="cause-of-the-explosion">Cause of the Explosion</h5>
<ul>
<li>The reactor exploded during the reassembly of the control mechanism.</li>
<li>The metal silo, despite not being a containment structure, contained the blast relatively well.</li>
<li>Approximately 50 curies of radioactivity were released.</li>
<li>A plume of fission products, including iodine-131, drifted 100 miles southwest.</li>
</ul>
</section>
<section id="investigation-findings" class="level5">
<h5 class="anchored" data-anchor-id="investigation-findings">Investigation Findings</h5>
<ul>
<li>The investigation revealed:
<ul>
<li>Lax project organization.</li>
<li>Inadequate worker training and screening.</li>
<li>Poor engineering practices.</li>
</ul></li>
<li>The single-control-rod design for criticality was deemed flawed.</li>
<li>Human error was likely a significant factor.</li>
</ul>
</section>
<section id="reconstruction-of-the-incident" class="level5">
<h5 class="anchored" data-anchor-id="reconstruction-of-the-incident">Reconstruction of the Incident</h5>
<ul>
<li>The incident was meticulously reconstructed using simulations and a mock-up.</li>
<li>An animated film detailed the sequence of events.</li>
</ul>
</section>
<section id="sequence-of-events" class="level5">
<h5 class="anchored" data-anchor-id="sequence-of-events">Sequence of Events</h5>
<ul>
<li><strong>Legg</strong> was positioned over the control rod penetration.</li>
<li><strong>Burns</strong> was grasping the control rod.</li>
<li><strong>McKinley</strong> was observing.</li>
<li>Burns was supposed to raise the rod by one inch, and Legg would then remove a C-clamp.</li>
<li><strong>T-0.5 seconds:</strong> Burns began pulling the rod.</li>
<li>Burns continued pulling beyond the one-inch mark.</li>
<li><strong>T-0.120 seconds:</strong> The rod was withdrawn 16.7 inches, and the reactor became critical.</li>
<li>Burns rapidly pulled the rod to 23 inches.</li>
<li><strong>T-0 seconds:</strong> The reactor went promptly supercritical (19 billion watts).</li>
<li>Fuel began to vaporize (3,740°F).</li>
<li><strong>T-0.0005 seconds:</strong> The BWR self-scrammed due to steam void formation.</li>
<li>Water above the core accelerated upward.</li>
<li><strong>T-0.034 seconds:</strong> Water hit the reactor lid (10,000 pounds of force).</li>
<li>Shield plugs cracked and parts were ejected.</li>
<li>The reactor tank began to move.</li>
<li><strong>T-0.160 seconds:</strong> A shield plug hit the ceiling, and two-thirds of the water had left the reactor.</li>
<li><strong>T-0.800 seconds:</strong> The reactor sheared off piping and hit the ceiling.</li>
<li><strong>T-4.000 seconds:</strong> The reactor fell back into the gravel, and the explosion ended.</li>
</ul>
</section>
<section id="the-unanswered-question-why-did-burns-pull-the-rod" class="level5">
<h5 class="anchored" data-anchor-id="the-unanswered-question-why-did-burns-pull-the-rod">The Unanswered Question: Why Did Burns Pull the Rod?</h5>
<ul>
<li>The reason for Burns’ actions remains unknown.</li>
<li>Experiments simulating a startled reaction did not result in control rod withdrawal.</li>
<li>The deliberate force required to pull the rod to 23 inches suggests intentional action.</li>
</ul>
</section>
<section id="possible-explanations" class="level5">
<h5 class="anchored" data-anchor-id="possible-explanations">Possible Explanations</h5>
<ul>
<li>While not explicitly stated in the final report, a murder-suicide scenario is a possibility.</li>
</ul>
</section>
<section id="lessons-learned" class="level5">
<h5 class="anchored" data-anchor-id="lessons-learned">Lessons Learned</h5>
<ul>
<li>The SL-1 incident highlighted the vulnerability of even well-engineered systems to human error.</li>
<li>It emphasized the importance of psychological screening in personnel selection.</li>
</ul>
</section>
<section id="continued-development-and-eventual-cancellation" class="level5">
<h5 class="anchored" data-anchor-id="continued-development-and-eventual-cancellation">Continued Development and Eventual Cancellation</h5>
<ul>
<li>Despite the incident, the Army continued developing small nuclear plants.</li>
<li><strong>March 8, 1961:</strong> Camp Century in Greenland became the first Army unit to operate a nuclear power plant (SL-1 with modifications).</li>
<li><strong>December 14, 1961:</strong> A nuclear reactor was installed at McMurdo Sound, Antarctica.</li>
<li><strong>Axel Heiberg Island:</strong> The PL-1 powered an automated weather station.</li>
<li><strong>1965:</strong> The program was cancelled due to budget constraints caused by the Vietnam War.</li>
</ul>
</section>
<section id="long-term-impact-of-sl-1" class="level5">
<h5 class="anchored" data-anchor-id="long-term-impact-of-sl-1">Long-Term Impact of SL-1</h5>
<ul>
<li>The SL-1 incident led to improvements in:
<ul>
<li>Radiation suit and respirator design.</li>
<li>Photography, dosimetry, and environmental monitoring procedures.</li>
</ul></li>
<li>Oversimplified BWR designs were abandoned.</li>
<li>A safety poster commemorating the incident was created.</li>
<li>Regulations were implemented to prevent single-control criticality and to eliminate the possibility of accidental rod withdrawal.</li>
<li>The emphasis on cost reduction and simplification in nuclear reactor design diminished.</li>
</ul>
</section>
</section>
<section id="the-hatch-nuclear-generating-station-a-modern-bwr-experience" class="level4">
<h4 class="anchored" data-anchor-id="the-hatch-nuclear-generating-station-a-modern-bwr-experience">The Hatch Nuclear Generating Station: A Modern BWR Experience</h4>
<section id="installing-the-safety-parameter-display-system" class="level5">
<h5 class="anchored" data-anchor-id="installing-the-safety-parameter-display-system">Installing the Safety Parameter Display System</h5>
<ul>
<li>In 1983, the author and <strong>Mark Pellegrini</strong> completed the installation of the <strong>Safety Parameter Display System (SPDS)</strong> at the <strong>EI Hatch nuclear generating station</strong> (two GE BWR-6 reactors in Mark I containments).</li>
<li>A year of testing was required before the SPDS could be used in normal operations.</li>
</ul>
</section>
<section id="the-scram-tape-feature" class="level5">
<h5 class="anchored" data-anchor-id="the-scram-tape-feature">The Scram Tape Feature</h5>
<ul>
<li>One untested feature of the SPDS was its ability to record data during a <strong>scram</strong> (unscheduled shutdown):
<ul>
<li>Upon scram, the system would record the past half-hour of reactor data on a hard disk and a nine-track magnetic tape.</li>
<li>Real-time data would then be recorded on the tape for the next hour.</li>
<li>This feature allowed operators to review the scram event in detail on the simulator system.</li>
</ul></li>
</ul>
</section>
<section id="an-unexpected-scram" class="level5">
<h5 class="anchored" data-anchor-id="an-unexpected-scram">An Unexpected Scram</h5>
<ul>
<li>While celebrating the SPDS installation, a scram occurred at Unit 1, indicated by flickering lights and resetting video games.</li>
</ul>
</section>
<section id="analyzing-the-scram" class="level5">
<h5 class="anchored" data-anchor-id="analyzing-the-scram">Analyzing the Scram</h5>
<ul>
<li>The authors obtained the scram tape and analyzed it on the simulator.</li>
<li>The scram was caused by a transistor failure in the jet pump speed control amplifier.</li>
</ul>
</section>
<section id="bwr-6-power-control" class="level5">
<h5 class="anchored" data-anchor-id="bwr-6-power-control">BWR-6 Power Control</h5>
<ul>
<li>The BWR-6 uses jet pumps to control power levels by regulating water recirculation speed:
<ul>
<li>Faster water flow reduces steam bubble formation, increasing moderator density and reactivity.</li>
<li>Slower flow increases steam bubbles, displacing moderator and reducing reactivity.</li>
</ul></li>
<li>Jet pump speed is controlled by a hydraulic coupling connected to an AC motor and a DC generator.</li>
<li>A scoop tube in the coupling, controlled by a servo motor, regulates the amount of hydraulic fluid.</li>
</ul>
</section>
<section id="the-transistor-failure-and-its-consequences" class="level5">
<h5 class="anchored" data-anchor-id="the-transistor-failure-and-its-consequences">The Transistor Failure and Its Consequences</h5>
<ul>
<li>A transistor in the amplifier controlling the scoop tube servo motor failed closed, causing the scoop tube to move to the full out position.</li>
<li>This led to jet pump overrunning and the collapse of steam bubbles in the reactor core, causing a rapid power increase.</li>
</ul>
</section>
<section id="observing-the-scram-on-the-spds" class="level5">
<h5 class="anchored" data-anchor-id="observing-the-scram-on-the-spds">Observing the Scram on the SPDS</h5>
<ul>
<li>The authors observed the effects of the transistor failure on the SPDS display:
<ul>
<li>The core temperature graph transitioned from green to red, exceeding</li>
</ul></li>
</ul>
</section>
</section>
</section>
<section id="chapter-4-nuclear-rockets-and-nuclear-airplanes" class="level3">
<h3 class="anchored" data-anchor-id="chapter-4-nuclear-rockets-and-nuclear-airplanes">Chapter 4: Nuclear Rockets and Nuclear Airplanes</h3>
<section id="introduction-1" class="level4">
<h4 class="anchored" data-anchor-id="introduction-1">Introduction</h4>
<ul>
<li><strong>Quote:</strong> “The universe is nuclear, and so we must use this energy source if we are to go there.” - Senator Clinton P. Anderson of New Mexico, in the Congressional Record, September 1, 1960</li>
<li>The author’s experience as a licensed reactor operator highlights the complexity and safety measures involved in nuclear reactor operations.</li>
<li><strong>Reactor Racing:</strong> A game devised by graduate students to test their reactor operation skills by rapidly increasing power levels without causing a <strong>scram</strong> (automatic shutdown).</li>
</ul>
</section>
<section id="the-agn-model-201-reactor" class="level4">
<h4 class="anchored" data-anchor-id="the-agn-model-201-reactor">The AGN Model 201 Reactor</h4>
<ul>
<li><strong>Description:</strong>
<ul>
<li>Developed by Aerojet General Nucleonics.</li>
<li>Small research reactor, about the size of a paint can.</li>
<li>Used 20% enriched uranium powder mixed with polyethylene as fuel.</li>
<li>Graphite neutron reflector and water bioshield.</li>
<li>Maximum power comparable to a two-cell flashlight.</li>
<li>Inherently safe design with multiple safety features.</li>
</ul></li>
<li><strong>Aerojet General Nucleonics:</strong>
<ul>
<li>Founded by <strong>Theodor von Kármán</strong>.</li>
<li>Initially focused on <strong>JATO</strong> (Jet Assisted Takeoff Rockets).</li>
<li>Expanded into electronics, ordnance, and eventually nucleonics.</li>
<li>Anticipated major involvement in nuclear rocket engine development.</li>
</ul></li>
</ul>
</section>
<section id="nuclear-powered-transportation-systems-optimism-and-paradox" class="level4">
<h4 class="anchored" data-anchor-id="nuclear-powered-transportation-systems-optimism-and-paradox">Nuclear-Powered Transportation Systems: Optimism and Paradox</h4>
<ul>
<li><strong>Early Concepts:</strong>
<ul>
<li>Nuclear-powered rockets and air-breathing jets were considered since the Manhattan Project.</li>
</ul></li>
<li><strong>Nuclear Rocket Advantages:</strong>
<ul>
<li>Significantly higher <strong>specific impulse</strong> (propellant efficiency) compared to chemical rockets.
<ul>
<li>Chemical rockets: Maximum specific impulse of 453 seconds.</li>
<li>Nuclear rockets: Specific impulse starting at 800 seconds, potentially much higher.</li>
</ul></li>
<li>Enabled one-stage trips to the moon and manned missions to Mars.</li>
</ul></li>
<li><strong>The Nuclear Power Paradox:</strong>
<ul>
<li>Despite significant investment and potential, nuclear-powered transportation systems were not realized.</li>
<li><strong>Reasons for the Paradox:</strong>
<ul>
<li>Cost: Nuclear energy is expensive.</li>
<li>Premature Development: Nuclear technology was ahead of its time, the limitations of chemical propulsion were not yet fully realized.</li>
<li>Negative Perception: Flawed development programs like the nuclear-powered airplane and cruise missile tarnished the image of nuclear technology.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-nuclear-powered-airplane-a-flawed-dream" class="level4">
<h4 class="anchored" data-anchor-id="the-nuclear-powered-airplane-a-flawed-dream">The Nuclear-Powered Airplane: A Flawed Dream</h4>
<ul>
<li><strong>Origins:</strong>
<ul>
<li>Concept explored by Enrico Fermi and the Manhattan Project team.</li>
<li>Initial goal: Develop a bomber with unlimited range.</li>
</ul></li>
<li><strong>Challenges:</strong>
<ul>
<li><strong>Shielding:</strong>
<ul>
<li>Submarines offered inherent shielding due to their heavy construction.</li>
<li>Airplanes, built for lightness, posed significant shielding challenges to protect the crew from radiation.</li>
</ul></li>
<li><strong>Safety:</strong>
<ul>
<li>Reactor scrams in flight would lead to crashes and the dispersal of radioactive materials.</li>
<li>Submarines could safely sink to the ocean floor in case of accidents.</li>
</ul></li>
</ul></li>
<li><strong>Project NEPA (Nuclear Energy for Propulsion of Aircraft):</strong>
<ul>
<li>Initiated in 1946 by the Air Force.</li>
<li>$10 million invested, but technical challenges were evident.</li>
</ul></li>
<li><strong>Project ANP (Aircraft Nuclear Propulsion Program):</strong>
<ul>
<li>Launched in 1951, jointly administered by the Air Force and the AEC.</li>
<li>Lacked a strong leader like Hyman Rickover, resulting in mismanagement and slow progress.</li>
</ul></li>
<li><strong>The X-6 Test Program (NB-36H):</strong>
<ul>
<li>Modified Convair B-36 Peacemaker bomber with an air-cooled reactor.</li>
<li>Used a <strong>shadow shield</strong> to protect the crew, weighing 12.5 tons.</li>
<li>Flew 43 successful test missions, mainly over deserts.</li>
<li>Always accompanied by a chase plane with marines to secure crash sites.</li>
</ul></li>
<li><strong>Ongoing Concerns:</strong>
<ul>
<li>Radiation exposure to people and livestock on the ground.</li>
<li>Neutron embrittlement of the fuselage.</li>
<li>Radiation effects on hydraulic fluid and electronics.</li>
</ul></li>
<li><strong>Soviet Competition:</strong>
<ul>
<li>Reports of a massive Soviet nuclear aircraft project fueled the urgency of the ANP program.</li>
</ul></li>
<li><strong>The General Electric Vallesitos Atomic Laboratory:</strong>
<ul>
<li>Awarded the reactor design contract in 1957.</li>
<li>Proposed a single, centrally located reactor with a detachable design for easier servicing.</li>
</ul></li>
<li><strong>The Heat Transfer Reactor Experiment (HTRE):</strong>
<ul>
<li>Series of GE engine tests conducted at the NRTS in Idaho.</li>
</ul></li>
<li><strong>Lockheed Aircraft’s Involvement:</strong>
<ul>
<li>Built a mock-up of the crew compartment for psychological testing.</li>
<li>Developed specialized equipment like an electric incinerator toilet.</li>
</ul></li>
<li><strong>The Shielding Development Facility (Oak Ridge, Tennessee):</strong>
<ul>
<li>Tested shielding methods for minimizing radiation effects on the ground.</li>
</ul></li>
<li><strong>The Georgia Nuclear Aircraft Laboratory (GNAL, Dawsonville, Georgia):</strong>
<ul>
<li>Studied the effects of radiation on materials and living things.</li>
<li><strong>Radiation Effects Reactor:</strong> 10-megawatt water-cooled reactor used for high-intensity radiation tests.</li>
<li><strong>Critical Experiment Facility (Staging Reactor):</strong> Low-power reactor for fuel and moderator configuration experiments.</li>
<li><strong>Unique Features:</strong>
<ul>
<li>Stainless steel buildings to prevent rust and contamination.</li>
<li>Water purification plant.</li>
<li>Concrete blockhouse with remote hot-cell arms for examining irradiated objects.</li>
<li>Meteorology towers to monitor wind conditions and potential spread of Argon-41.</li>
<li>Aircraft detection tower to prevent accidental pilot exposure.</li>
<li>Underground operations building for personnel safety.</li>
</ul></li>
</ul></li>
<li><strong>Initial Tests and Observations:</strong>
<ul>
<li>First reactor startup on December 14, 1958.</li>
<li>Tested a wide range of materials and living organisms.</li>
<li>Observed <strong>instant taxidermy</strong> phenomenon.</li>
<li>Studied the effects of radiation on hydraulic fluid, tires, and transistors.</li>
</ul></li>
<li><strong>Cancellation of the ANP Program:</strong>
<ul>
<li>President John F. Kennedy canceled the program on March 28, 1961.</li>
<li>Advancements in ICBM technology made the nuclear bomber obsolete.</li>
<li>$20 billion spent with no tangible results.</li>
</ul></li>
<li><strong>Legacy of the ANP Program:</strong>
<ul>
<li>Technically feasible but ultimately a public relations disaster.</li>
<li>Raised safety concerns and contradicted the image of nuclear power as safe and economical.</li>
</ul></li>
</ul>
</section>
<section id="project-pluto-slam-the-nuclear-ramjet-from-hell" class="level4">
<h4 class="anchored" data-anchor-id="project-pluto-slam-the-nuclear-ramjet-from-hell">Project Pluto (SLAM): The Nuclear Ramjet from Hell</h4>
<ul>
<li><strong>Origins:</strong>
<ul>
<li>Based on George Gamow’s concept of “Self-Flying Atomic Bombs”.</li>
</ul></li>
<li><strong>Objective:</strong>
<ul>
<li>Develop a nuclear-powered ramjet cruise missile capable of supersonic flight.</li>
</ul></li>
<li><strong>Design and Features:</strong>
<ul>
<li>Mach 3 speed, low altitude flight.</li>
<li>Unmanned, self-flying.</li>
<li>Chemical rocket boosters for initial launch, followed by reactor startup.</li>
<li>Intended for deployment along the western Pacific Rim.</li>
<li>Carried multiple nuclear warheads and caused destruction through its shockwave and radiation.</li>
<li>Simple engine design with no moving parts.</li>
<li>Reactor operating temperature: 2,500 degrees Fahrenheit.</li>
<li><strong>Fuel:</strong> Specialized ceramic fuel elements developed by the Coors Porcelain Company.</li>
</ul></li>
<li><strong>Project Tori:</strong>
<ul>
<li><strong>Tori-2A:</strong> First complete engine design, tested at Site 401 in Jackass Flats, Nevada.</li>
<li><strong>Tori-2C:</strong> Lighter and more powerful engine, ran at 513 megawatts for five minutes.</li>
</ul></li>
<li><strong>Challenges and Concerns:</strong>
<ul>
<li>Potential for catastrophic crashes and widespread radioactive contamination.</li>
<li>Extreme noise and heat signature.</li>
</ul></li>
<li><strong>Cancellation of Project Pluto:</strong>
<ul>
<li>Canceled on July 1, 1964, due to the development of ICBMs.</li>
<li>$260 million spent.</li>
</ul></li>
</ul>
</section>
<section id="the-nuclear-rocket-engine-project-rover-and-beyond" class="level4">
<h4 class="anchored" data-anchor-id="the-nuclear-rocket-engine-project-rover-and-beyond">The Nuclear Rocket Engine: Project Rover and Beyond</h4>
<ul>
<li><strong>Early Concepts:</strong>
<ul>
<li>Speculative papers on nuclear-powered rockets appeared in the early 20th century.</li>
<li>Fission was seen as a potential energy source for space travel.</li>
</ul></li>
<li><strong>Project Rover:</strong>
<ul>
<li>Initiated in 1955, funded by the AEC, focused on developing nuclear rocket engines for ICBMs.</li>
</ul></li>
<li><strong>Reactor Core Challenges:</strong>
<ul>
<li>Extreme operating conditions: high pressure, high temperature, liquid hydrogen flow.</li>
</ul></li>
<li><strong>Early Engine Designs:</strong>
<ul>
<li>Five initial designs with codenames like Uncle Tom, Bloodhound, Uncle Tongue, and Shish.</li>
<li><strong>Old Black Joe:</strong> 46-inch long core with ceramic uranium fuel.</li>
</ul></li>
<li><strong>Shifting Priorities:</strong>
<ul>
<li>Development of smaller hydrogen bombs made nuclear rockets less critical for ICBMs.</li>
</ul></li>
<li><strong>The Space Race and Project Kiwi:</strong>
<ul>
<li>Sputnik 1 launch in 1957 spurred the U.S. space program.</li>
<li>Nuclear rockets were considered for lunar missions.</li>
<li><strong>Space Nuclear Propulsion Office (SNPO)</strong> established.</li>
<li><strong>Kiwi:</strong> Series of test engines developed by Los Alamos, named after the flightless bird.</li>
<li><strong>Kiwi-A:</strong> First test on July 1, 1959, encountered technical difficulties.</li>
<li><strong>Kiwi A-Prime, Kiwi A-3:</strong> Further tests with improved core designs but fuel corrosion issues.</li>
</ul></li>
<li><strong>NASA’s Involvement and Project Phoebus:</strong>
<ul>
<li><strong>Nuclear Engine for Rocket Vehicle Application (NERVA)</strong> program initiated by NASA, based on Kiwi engines.</li>
<li><strong>Phoebus:</strong> Series of larger and more powerful engines.</li>
<li><strong>Phoebus 1A:</strong> Test on June 25, 1965, achieved over a billion watts of power.</li>
<li><strong>Phoebus B:</strong> Test in February 1967, reached 1.5 billion watts.</li>
<li><strong>Phoebus 2A:</strong> Test in June 1968, achieved 4 billion watts and 200,000 pounds of thrust.</li>
</ul></li>
<li><strong>The Georgia Nuclear Aircraft Laboratory’s Role:</strong>
<ul>
<li>Tested fuel tank insulation for nuclear rocket applications.</li>
</ul></li>
<li><strong>Cancellation of the Nuclear Rocket Program:</strong>
<ul>
<li>Lack of a clear mission after the Apollo program.</li>
<li>Budgetary constraints and competing priorities.</li>
<li>Program terminated in 1972.</li>
</ul></li>
<li><strong>Soviet Developments:</strong>
<ul>
<li>RIFT test in 1985: The Soviet Union conducted the first and only in-flight test of a nuclear rocket engine.</li>
</ul></li>
<li><strong>The End of Nuclear Flight:</strong>
<ul>
<li>By 1972, the era of nuclear-powered aircraft and rockets had ended.</li>
</ul></li>
</ul>
</section>
<section id="conclusion-5" class="level4">
<h4 class="anchored" data-anchor-id="conclusion-5">Conclusion</h4>
<ul>
<li>Nuclear-powered transportation systems were technically feasible but ultimately unnecessary and ahead of their time.</li>
<li>The demise of these programs foreshadowed the fate of nuclear power in general.</li>
</ul>
</section>
</section>
<section id="chapter-5-the-building-boom-the-bust-and-a-resurgence" class="level3">
<h3 class="anchored" data-anchor-id="chapter-5-the-building-boom-the-bust-and-a-resurgence">Chapter 5: The Building Boom, the Bust, and a Resurgence</h3>
<section id="the-nuclear-rocket-program-environmental-concerns" class="level4">
<h4 class="anchored" data-anchor-id="the-nuclear-rocket-program-environmental-concerns">The Nuclear Rocket Program &amp; Environmental Concerns</h4>
<section id="operational-safety-environmental-impact" class="level5">
<h5 class="anchored" data-anchor-id="operational-safety-environmental-impact">Operational Safety &amp; Environmental Impact</h5>
<ul>
<li><strong>The NRX-A5 nuclear rocket engine test</strong> in June 1966 demonstrated successful temperature control and simulated space cool-down.</li>
<li><strong>A bird incident</strong> during the NRX-A5 test highlighted the growing emphasis on operational safety in nuclear experiments.</li>
<li><strong>Increased awareness of environmental impact</strong>: The need to minimize the release of radioactive dust into the atmosphere was recognized.</li>
<li><strong>The Environmental Protection Agency (EPA)</strong> advocated for the use of scrubbers to reduce pollution from nuclear rocket tests.</li>
<li><strong>Extensive contamination in Nevada</strong>: Prior nuclear weapons tests and uranium mining had left Southern Nevada heavily contaminated with radioactive materials.</li>
</ul>
</section>
<section id="the-bren-tower-test-ban-treaty" class="level5">
<h5 class="anchored" data-anchor-id="the-bren-tower-test-ban-treaty">The BREN Tower &amp; Test Ban Treaty</h5>
<ul>
<li><strong>The BREN (Bear Reactor Experiment Nevada) Tower</strong>, also known as the BRIN Tower, was a 1,527-foot tall structure used to simulate the effects of an atomic bomb explosion.</li>
<li><strong>Purpose</strong>: To study the impact of radiation from a nuclear detonation.</li>
<li><strong>The Nuclear Test Ban Treaty</strong>, signed in 1963, halted above-ground nuclear testing, including experiments at the BREN Tower.</li>
<li><strong>Atmospheric radiation levels</strong> peaked in 1963 and began to decline following the treaty.</li>
</ul>
</section>
<section id="public-distrust-anti-nuclear-movements" class="level5">
<h5 class="anchored" data-anchor-id="public-distrust-anti-nuclear-movements">Public Distrust &amp; Anti-Nuclear Movements</h5>
<ul>
<li><strong>Nevada’s experience with nuclear testing</strong> fostered public distrust in the nuclear science establishment due to secrecy, misdirection, and perceived lack of government concern.</li>
<li><strong>Anti-nuclear movements</strong> emerged in the 1960s, fueled by concerns about nuclear armaments and later encompassing civilian nuclear power.</li>
<li><strong>Challenges for the nuclear power industry</strong>:
<ul>
<li>High construction costs and involvement of large corporations made it a target for criticism.</li>
<li>The experimental nature of early reactor designs and lack of standardization added to complexity.</li>
<li>Anti-nuclear groups raised concerns about environmental impacts and the long-term disposal of radioactive waste.</li>
</ul></li>
</ul>
</section>
</section>
<section id="nuclear-waste-disposal" class="level4">
<h4 class="anchored" data-anchor-id="nuclear-waste-disposal">Nuclear Waste Disposal</h4>
<section id="the-challenge-of-long-term-storage" class="level5">
<h5 class="anchored" data-anchor-id="the-challenge-of-long-term-storage">The Challenge of Long-Term Storage</h5>
<ul>
<li><strong>Anti-nuclear groups strategically focused on the issue of radioactive waste disposal</strong> to hinder the nuclear power industry.</li>
<li><strong>The need for permanent storage solutions</strong>: Existing nuclear plants could only store spent fuel temporarily.</li>
</ul>
</section>
<section id="transportation-and-safety" class="level5">
<h5 class="anchored" data-anchor-id="transportation-and-safety">Transportation and Safety</h5>
<ul>
<li><strong>Safe transportation of nuclear fuel</strong>: Despite public perception, nuclear fuel had been transported safely for decades using various methods.</li>
<li><strong>Regulations and testing</strong>:
<ul>
<li>The Code of Federal Regulations, Title X, Part 71 mandates the use of approved spent nuclear fuel shipping casks.</li>
<li>Sandia National Laboratories conducted extensive testing to ensure the safety of fuel containers in accidents.</li>
</ul></li>
<li><strong>The Howard Street Tunnel fire in Baltimore (2001)</strong> served as a real-world test case for evaluating the resilience of spent fuel casks in extreme conditions.</li>
</ul>
</section>
<section id="regulatory-changes-and-the-doe" class="level5">
<h5 class="anchored" data-anchor-id="regulatory-changes-and-the-doe">Regulatory Changes and the DOE</h5>
<ul>
<li><strong>Abolition of the Atomic Energy Commission (AEC) in 1974</strong>: The AEC was replaced by two new agencies:
<ul>
<li><strong>The Energy Research and Development Agency (ERDA)</strong>: Focused on research and development of nuclear technologies.</li>
<li><strong>The United States Nuclear Regulatory Commission (NRC)</strong>: Responsible for regulations, licensing, and safety oversight.</li>
</ul></li>
<li><strong>Formation of the Department of Energy (DOE) in 1977</strong>: The ERDA was reorganized into the DOE with expanded responsibilities, including radioactive waste disposal.</li>
<li><strong>Focus on deep geological repositories</strong>: The DOE initiated studies for long-term storage of nuclear waste in geologically stable formations.</li>
</ul>
</section>
<section id="international-efforts-and-the-waste-isolation-pilot-plant-wipp" class="level5">
<h5 class="anchored" data-anchor-id="international-efforts-and-the-waste-isolation-pilot-plant-wipp">International Efforts and the Waste Isolation Pilot Plant (WIPP)</h5>
<ul>
<li><strong>Deep geological repositories were being considered internationally</strong>: Several countries, including Germany, Belgium, and Canada, explored this approach for nuclear waste disposal.</li>
<li><strong>The Waste Isolation Pilot Plant (WIPP)</strong>:
<ul>
<li>Opened in 1999 in New Mexico.</li>
<li>Located 2,150 feet underground in a salt formation.</li>
<li>Designed for the disposal of nuclear waste from weapons production, not civilian power plants.</li>
</ul></li>
</ul>
</section>
<section id="yucca-mountain-and-the-screw-nevada-bill" class="level5">
<h5 class="anchored" data-anchor-id="yucca-mountain-and-the-screw-nevada-bill">Yucca Mountain and the “Screw Nevada Bill”</h5>
<ul>
<li><strong>The Nuclear Waste Policy Act of 1982</strong> mandated the construction of a larger repository for high-level waste from commercial power plants.</li>
<li><strong>Yucca Mountain, Nevada</strong>, was selected as the site for the repository after extensive study.</li>
<li><strong>Congressional mandate (“Screw Nevada Bill”)</strong>: Congress designated Yucca Mountain as the repository site despite opposition from Nevada.</li>
<li><strong>Delays and opposition</strong>: The Yucca Mountain Repository faced numerous delays due to legal challenges and opposition from Nevada, resulting in missed deadlines and financial penalties for the DOE.</li>
<li><strong>Consequences of delays</strong>: Without a permanent repository, nuclear power generation in the US faces limitations.</li>
</ul>
</section>
</section>
<section id="fuel-reprocessing" class="level4">
<h4 class="anchored" data-anchor-id="fuel-reprocessing">Fuel Reprocessing</h4>
<section id="composition-of-nuclear-waste" class="level5">
<h5 class="anchored" data-anchor-id="composition-of-nuclear-waste">Composition of Nuclear Waste</h5>
<ul>
<li><strong>Spent nuclear fuel is primarily composed of uranium-238</strong>, which does not undergo fission but can convert to plutonium-239.</li>
<li><strong>Fission products constitute a small portion (3%) of spent fuel</strong> but are highly radioactive.</li>
<li><strong>Decay rates</strong>: Many fission products decay quickly, while others, like strontium-90 and cesium-137, remain dangerous for decades.</li>
</ul>
</section>
<section id="benefits-of-reprocessing" class="level5">
<h5 class="anchored" data-anchor-id="benefits-of-reprocessing">Benefits of Reprocessing</h5>
<ul>
<li><strong>Fuel reprocessing can significantly reduce the volume and mass of radioactive waste</strong>.</li>
<li><strong>Comparison with coal waste</strong>: Nuclear waste from a lifetime of electricity use would be much smaller than the waste from coal-fired power generation.</li>
</ul>
</section>
<section id="the-purex-process-and-early-reprocessing-plants" class="level5">
<h5 class="anchored" data-anchor-id="the-purex-process-and-early-reprocessing-plants">The PUREX Process and Early Reprocessing Plants</h5>
<ul>
<li><strong>Fuel reprocessing was developed during the Manhattan Project</strong>.</li>
<li><strong>The PUREX (Plutonium and Uranium Recovery by Extraction) process</strong>: Developed in 1949, it became the standard method for separating radioactive and non-radioactive components of nuclear waste.</li>
<li><strong>The West Valley Reprocessing Plant</strong>:
<ul>
<li>Privately owned and operated in New York.</li>
<li>Faced regulatory issues and closed in 1973.</li>
<li>The DOE later took over the site for cleanup and vitrification (encasing waste in glass).</li>
</ul></li>
</ul>
</section>
<section id="the-barnwell-nuclear-fuel-reprocessing-plant" class="level5">
<h5 class="anchored" data-anchor-id="the-barnwell-nuclear-fuel-reprocessing-plant">The Barnwell Nuclear Fuel Reprocessing Plant</h5>
<ul>
<li><strong>Construction began in 1970 in South Carolina</strong>.</li>
<li><strong>Advanced design</strong>: Incorporating lessons from West Valley, it was designed for automation, high capacity, and compliance with NRC regulations.</li>
<li><strong>Successful test run in 1973</strong>.</li>
<li><strong>Presidential veto</strong>: President Carter blocked the licensing of the Barnwell plant in 1977 due to concerns about potential terrorist threats.</li>
<li><strong>Consequences of the veto</strong>: The decision halted reprocessing in the US, increased the volume of nuclear waste, and made the country reliant on foreign sources for medical isotopes.</li>
</ul>
</section>
<section id="reprocessing-in-other-countries" class="level5">
<h5 class="anchored" data-anchor-id="reprocessing-in-other-countries">Reprocessing in Other Countries</h5>
<ul>
<li><strong>Fuel reprocessing is common practice in several countries</strong>, including France, the UK, India, Japan, and Russia.</li>
<li><strong>Impact of the Barnwell veto</strong>: Anti-nuclear forces effectively made waste disposal more complex and discouraged investment in reprocessing in the US.</li>
</ul>
</section>
</section>
<section id="terrorism-and-nuclear-power-plants" class="level4">
<h4 class="anchored" data-anchor-id="terrorism-and-nuclear-power-plants">Terrorism and Nuclear Power Plants</h4>
<section id="likelihood-of-terrorist-attacks" class="level5">
<h5 class="anchored" data-anchor-id="likelihood-of-terrorist-attacks">Likelihood of Terrorist Attacks</h5>
<ul>
<li><strong>The author considers the likelihood of a successful terrorist attack on a nuclear power plant to be low</strong> due to the complexity of plant operations and security measures.</li>
<li><strong>Stealing plutonium would be difficult</strong> due to strict regulations and tracking.</li>
</ul>
</section>
<section id="the-superphénix-attack" class="level5">
<h5 class="anchored" data-anchor-id="the-superphénix-attack">The Superphénix Attack</h5>
<ul>
<li><strong>The 1982 attack on the Superphénix reactor in France</strong> is cited as the only example of a foreign terrorist attack on a nuclear power plant.</li>
<li><strong>Background</strong>: France relies heavily on nuclear power and developed a plutonium economy to reduce dependence on foreign uranium supplies.</li>
<li><strong>The attack</strong>: Anti-nuclear terrorists fired rocket-propelled grenades at the Superphénix containment building, causing minor damage but not breaching the reactor core.</li>
<li><strong>Aftermath</strong>: The plant continued operation until 1997 when it was shut down due to sodium leaks.</li>
</ul>
</section>
</section>
<section id="the-global-nuclear-landscape" class="level4">
<h4 class="anchored" data-anchor-id="the-global-nuclear-landscape">The Global Nuclear Landscape</h4>
<section id="nuclear-power-around-the-world" class="level5">
<h5 class="anchored" data-anchor-id="nuclear-power-around-the-world">Nuclear Power Around the World</h5>
<ul>
<li><strong>Nuclear power plants are operational in numerous countries</strong>.</li>
<li><strong>Reactor types</strong>: PWRs, BWRs, CANDUs, and RBMKs are among the reactor designs used globally.</li>
<li><strong>Japan</strong>, despite being the only country attacked with nuclear weapons, has a significant number of nuclear power plants.</li>
<li><strong>The United States has the largest number of active reactors (104)</strong>, but France generates the highest percentage of its electricity from nuclear power (87.5%).</li>
</ul>
</section>
</section>
<section id="the-nuclear-power-bust" class="level4">
<h4 class="anchored" data-anchor-id="the-nuclear-power-bust">The Nuclear Power Bust</h4>
<section id="economic-factors" class="level5">
<h5 class="anchored" data-anchor-id="economic-factors">Economic Factors</h5>
<ul>
<li>The decline of nuclear power plant construction in the US was primarily driven by economic factors, not anti-nuclear protests or safety concerns.</li>
<li><strong>Rising construction costs, high interest rates, and a surplus of generating capacity</strong> contributed to the slowdown.</li>
<li>The technology had matured, but societal demand for clean energy had not yet caught up.</li>
</ul>
</section>
<section id="the-uranium-mill-tailings-radiation-control-act" class="level5">
<h5 class="anchored" data-anchor-id="the-uranium-mill-tailings-radiation-control-act">The Uranium Mill Tailings Radiation Control Act</h5>
<ul>
<li><strong>Passed in 1978, this act mandated the cleanup of abandoned uranium mines and tailings</strong> to address radon gas and uranium dust contamination.</li>
<li><strong>Current status of uranium mining</strong>: There are no active uranium mines in the US due to low uranium prices.</li>
<li><strong>Shift from enrichment to dilution</strong>: The US now down-blends highly enriched uranium for use in power reactors.</li>
</ul>
</section>
</section>
<section id="the-three-mile-island-accident" class="level4">
<h4 class="anchored" data-anchor-id="the-three-mile-island-accident">The Three Mile Island Accident</h4>
<section id="background-2" class="level5">
<h5 class="anchored" data-anchor-id="background-2">Background</h5>
<ul>
<li><strong>The Three Mile Island Unit 2 (TMI-2) reactor meltdown occurred on March 28, 1979</strong>.</li>
<li><strong>Context</strong>: The accident coincided with the release of the movie “The China Syndrome,” which portrayed a nuclear disaster, amplifying public anxiety.</li>
</ul>
</section>
<section id="the-accident-sequence" class="level5">
<h5 class="anchored" data-anchor-id="the-accident-sequence">The Accident Sequence</h5>
<ul>
<li><strong>A minor mechanical failure in the secondary cooling loop</strong> initiated a chain of events.</li>
<li><strong>Operator actions</strong>:
<ul>
<li>The operators responded to alarms and attempted to manage the situation.</li>
<li>A stuck relief valve on the pressurizer and the decision to turn off emergency core cooling pumps contributed to the severity of the accident.</li>
</ul></li>
<li><strong>Core damage</strong>: Loss of coolant led to fuel rod exposure, cladding damage, hydrogen generation, and an explosion within the containment building.</li>
<li><strong>Emergency response</strong>: A site emergency was declared, and notifications were made to the NRC, Congress, and the President.</li>
</ul>
</section>
<section id="aftermath-and-consequences" class="level5">
<h5 class="anchored" data-anchor-id="aftermath-and-consequences">Aftermath and Consequences</h5>
<ul>
<li><strong>No significant radiation release</strong>: The containment building prevented a major release of radioactive material, and the only release was a controlled venting of inert gases.</li>
<li><strong>Public perception and impact</strong>: The accident caused widespread fear and distrust of nuclear power, despite the lack of significant health consequences.</li>
<li><strong>Babcock and Wilcox, the reactor manufacturer, did not sell any more reactors</strong>.</li>
<li><strong>Many planned nuclear power plants were canceled</strong>.</li>
<li><strong>Cleanup and decommissioning</strong>: The damaged TMI-2 reactor was defueled and the containment building sealed.</li>
<li><strong>TMI-1, the other reactor at the site, continued operation</strong>.</li>
</ul>
</section>
</section>
<section id="the-chernobyl-disaster" class="level4">
<h4 class="anchored" data-anchor-id="the-chernobyl-disaster">The Chernobyl Disaster</h4>
<section id="background-3" class="level5">
<h5 class="anchored" data-anchor-id="background-3">Background</h5>
<ul>
<li><strong>The Chernobyl disaster occurred on April 27, 1986, in the Soviet Union</strong>.</li>
<li><strong>Detection</strong>: The accident was first detected in Sweden when a worker was found to be contaminated with radioactive fallout.</li>
</ul>
</section>
<section id="the-accident-sequence-1" class="level5">
<h5 class="anchored" data-anchor-id="the-accident-sequence-1">The Accident Sequence</h5>
<ul>
<li><strong>The Chernobyl Unit 4 reactor was an RBMK-1000 graphite-moderated reactor</strong>, a design considered obsolete and unsafe.</li>
<li><strong>A flawed safety test</strong>: The accident occurred during a test of the reactor’s ability to run on emergency power.</li>
<li><strong>Operator errors and unstable conditions</strong>: The reactor was in an unstable state due to withdrawn control rods and a xenon build-up.</li>
<li><strong>Power surge and explosion</strong>: Shutting off steam to the turbines during the test led to a power surge, fuel melting, and explosions that destroyed the reactor and released radioactive material into the atmosphere.</li>
</ul>
</section>
<section id="aftermath-and-consequences-1" class="level5">
<h5 class="anchored" data-anchor-id="aftermath-and-consequences-1">Aftermath and Consequences</h5>
<ul>
<li><strong>Evacuation and casualties</strong>: The nearby town of Pripyat was evacuated, and there were numerous casualties from radiation exposure.</li>
<li><strong>Widespread fallout</strong>: The radioactive cloud spread across Europe.</li>
<li><strong>Impact on the Soviet Union</strong>: The disaster damaged the Soviet Union’s reputation and may have contributed to its collapse.</li>
<li><strong>Comparison with other industrial accidents</strong>: The author notes that other industrial accidents have caused more fatalities than Chernobyl, but the psychological impact of a nuclear disaster is significant.</li>
</ul>
</section>
</section>
<section id="lessons-learned-and-improvements" class="level4">
<h4 class="anchored" data-anchor-id="lessons-learned-and-improvements">Lessons Learned and Improvements</h4>
<section id="post-tmi-changes" class="level5">
<h5 class="anchored" data-anchor-id="post-tmi-changes">Post-TMI Changes</h5>
<ul>
<li>The TMI accident led to improvements in reactor design, instrumentation, and operator training.</li>
<li><strong>Enhanced safety features</strong>: Precision core water level instruments, computer-based displays, and improved safety systems were implemented.</li>
</ul>
</section>
<section id="post-chernobyl-impact" class="level5">
<h5 class="anchored" data-anchor-id="post-chernobyl-impact">Post-Chernobyl Impact</h5>
<ul>
<li>The Chernobyl disaster reinforced the need to avoid graphite-moderated reactor designs.</li>
<li>The Fort St.&nbsp;Vrain graphite reactor in the US was shut down.</li>
</ul>
</section>
</section>
<section id="the-nuclear-power-resurgence" class="level4">
<h4 class="anchored" data-anchor-id="the-nuclear-power-resurgence">The Nuclear Power Resurgence</h4>
<section id="a-period-of-dormancy" class="level5">
<h5 class="anchored" data-anchor-id="a-period-of-dormancy">A Period of Dormancy</h5>
<ul>
<li><strong>The nuclear power industry entered a period of stagnation in the 1980s</strong> due to economic factors and the negative public perception following TMI and Chernobyl.</li>
<li><strong>Safety improvements led to a decrease in excitement and perceived risk</strong> associated with nuclear power.</li>
</ul>
</section>
<section id="factors-driving-the-resurgence" class="level5">
<h5 class="anchored" data-anchor-id="factors-driving-the-resurgence">Factors Driving the Resurgence</h5>
<ul>
<li><strong>Increased demand for electricity and concerns about global warming</strong> have renewed interest in nuclear power as a clean and reliable energy source.</li>
</ul>
</section>
<section id="new-reactor-designs-and-projects" class="level5">
<h5 class="anchored" data-anchor-id="new-reactor-designs-and-projects">New Reactor Designs and Projects</h5>
<ul>
<li><strong>The first application for a new nuclear power plant in 30 years was filed in 2007</strong>.</li>
<li><strong>Advanced Boiling Water Reactors (ABWRs)</strong> are being planned for the South Texas project.</li>
<li><strong>Westinghouse AP-1000 reactors</strong> are being planned for projects in Alabama, Georgia, and Florida.</li>
<li>New reactor component factories are being built in Louisiana and Virginia.</li>
<li>The Energy Policy Act of 2005 provides incentives for new nuclear plant construction.</li>
<li>The Nuclear Power 2010 program encourages the development and deployment of advanced reactor designs.</li>
<li><strong>Enhanced security measures</strong>: New reactor buildings are designed to withstand the impact of a large jetliner.</li>
</ul>
</section>
</section>
<section id="the-future-of-nuclear-power" class="level4">
<h4 class="anchored" data-anchor-id="the-future-of-nuclear-power">The Future of Nuclear Power</h4>
<section id="the-need-for-continued-innovation" class="level5">
<h5 class="anchored" data-anchor-id="the-need-for-continued-innovation">The Need for Continued Innovation</h5>
<ul>
<li><strong>The author emphasizes that despite the maturity of nuclear technology, there is always room for improvement and innovation</strong>.</li>
<li><strong>The analogy of a PhD in nuclear physics</strong>: True understanding of a subject comes from questioning and challenging existing knowledge.</li>
<li><strong>The evolution of scientific models</strong>: Rutherford’s model of the atom was replaced by more accurate theories, demonstrating the continuous refinement of scientific understanding.</li>
</ul>
</section>
<section id="the-quest-for-simple-and-cheap-reactors" class="level5">
<h5 class="anchored" data-anchor-id="the-quest-for-simple-and-cheap-reactors">The Quest for Simple and Cheap Reactors</h5>
<ul>
<li>The author challenges the notion that nuclear power plants must be complex and expensive.</li>
<li>The goal is to simplify and reduce the cost of nuclear power while maintaining safety.</li>
</ul>
</section>
<section id="the-paradox-of-nuclear-power-1" class="level5">
<h5 class="anchored" data-anchor-id="the-paradox-of-nuclear-power-1">The Paradox of Nuclear Power</h5>
<ul>
<li>Nuclear power is a well-established technology that has become incredibly safe, yet it will always require a degree of experimentation and innovation.</li>
</ul>
</section>
<section id="the-lesson-of-the-spds-project" class="level5">
<h5 class="anchored" data-anchor-id="the-lesson-of-the-spds-project">The Lesson of the SPDS Project</h5>
<ul>
<li><strong>The author recounts an experience with a Safety Parameter Display System (SPDS) project</strong> that highlighted the importance of thorough testing and the potential for unexpected errors even in seemingly perfect systems.</li>
<li><strong>The “March Zero” bug</strong>: A leap year date caused an unforeseen error in the SPDS software, demonstrating that even rigorous testing cannot guarantee absolute perfection.</li>
</ul>
</section>
</section>
</section>
</section>
<section id="epilogue-the-radioactive-park" class="level2">
<h2 class="anchored" data-anchor-id="epilogue-the-radioactive-park">Epilogue: The Radioactive Park</h2>
<section id="early-history-and-the-gold-rush" class="level3">
<h3 class="anchored" data-anchor-id="early-history-and-the-gold-rush">Early History and the Gold Rush</h3>
<ul>
<li><strong>First Habitation:</strong> Archaeological evidence suggests Native Americans lived in Dawson Forest as early as 9,000 years ago, inhabiting rock overhangs along the Atoa River.</li>
<li><strong>19th Century Cherokee Settlement:</strong> By the 1800s, Cherokees established farms and communities in the area, focusing on corn and cattle farming.</li>
<li><strong>Georgia Gold Rush (1828):</strong>
<ul>
<li>Gold discovered near Dalanega sparked the first US gold rush.</li>
<li>Over 300 ounces of gold extracted daily by 1830, leading to a population boom in Dahlonega (reaching 15,000).</li>
<li>Dawson Forest, rich in gold and water resources for ore processing, became a prime target for mining.</li>
</ul></li>
<li><strong>Cherokee Removal:</strong>
<ul>
<li>The Cherokee population residing on gold-rich land posed an obstacle to mining expansion.</li>
<li>The federal government intervened, condemning Cherokee farms and forcing them to relocate to Oklahoma via the Trail of Tears.</li>
</ul></li>
<li><strong>Georgia Gold Lottery (1832):</strong>
<ul>
<li>Following the Cherokee removal, the forest was divided into 40-acre lots and distributed through a lottery system to promote mining.</li>
</ul></li>
<li><strong>Mining Legacy:</strong>
<ul>
<li>Extensive excavation resulted in numerous mine shafts throughout the forest.</li>
<li>The Georgia Gold Belt produced approximately 870,000 troy ounces of gold.</li>
</ul></li>
<li><strong>California Gold Rush (1849):</strong> Many Dawson Forest miners migrated to California, hoping for easier mining conditions.</li>
</ul>
</section>
<section id="moonshine-era" class="level3">
<h3 class="anchored" data-anchor-id="moonshine-era">Moonshine Era</h3>
<ul>
<li><strong>Post-Gold Rush Industry:</strong> Small-scale ethanol production (moonshining) emerged as a new industry in the forest.</li>
<li><strong>Remnants of Distilleries:</strong> Park rangers can identify the ruins of numerous old moonshine distilleries.</li>
<li><strong>Decline of Moonshining:</strong> Post-World War II, stricter enforcement by the state and the IRS led to the decline of moonshining, leaving Dawson Forest sparsely populated again.</li>
</ul>
</section>
<section id="the-georgia-nuclear-aircraft-laboratory" class="level3">
<h3 class="anchored" data-anchor-id="the-georgia-nuclear-aircraft-laboratory">The Georgia Nuclear Aircraft Laboratory</h3>
<ul>
<li><strong>Lockheed Acquisition (1957):</strong> Lockheed Aircraft purchased the forest for a secret Air Force project: the Aircraft Nuclear Propulsion Program.</li>
<li><strong>AFP-67 (Georgia Nuclear Aircraft Laboratory):</strong> The 10,000-acre site was designated AFP-67 and underwent significant development:
<ul>
<li>Clearing of trees and brush.</li>
<li>Construction of fences and concrete structures.</li>
</ul></li>
<li><strong>Nuclear Support Facility:</strong> A one-story brick building near the entrance housed engineering offices, a laboratory, and a computer room.
<ul>
<li>A 600-car parking lot was built across the street.</li>
<li>Other facilities included a fire station, warehouse, waterworks, and the Radiation Effects Laboratory.</li>
</ul></li>
<li><strong>Radiation Effects Laboratory:</strong>
<ul>
<li>A large complex with a shielded laboratory designed to handle highly radioactive rail cargo.</li>
<li>Walls up to 8 feet thick, made of high-density concrete, provided protection from gamma radiation.</li>
<li>Robotic arms, including one on overhead rails capable of handling tons of material, were used to dismantle and analyze radioactive samples.</li>
</ul></li>
<li><strong>Railroad and Lethal Fence:</strong>
<ul>
<li>A standard gauge railroad traversed the forest, crossing the Atoa River twice and leading to a clearing at the center of AFP-67.</li>
<li>A 3,600-foot radius “Lethal Fence” surrounded the clearing, accessible only through a guarded gravel road.</li>
</ul></li>
<li><strong>Radiation Effects Facility:</strong>
<ul>
<li>A two-story stainless steel building housed a 10-megawatt nuclear reactor, fueled by highly enriched uranium-235 and lacking shielding.</li>
<li>The reactor could be raised 10 feet into the air, emitting lethal radiation within and beyond the Lethal Fence.</li>
<li>It was used to test the effects of radiation on various materials, including aircraft components.</li>
</ul></li>
<li><strong>Secrecy and Local Impact:</strong>
<ul>
<li>Information about the facility was limited, causing anxiety and speculation among the local population.</li>
<li>The night sky often glowed crimson due to the reactor’s activity, fueling fears of an apocalypse.</li>
<li>Rumors circulated, including speculation about a crashed flying saucer.</li>
</ul></li>
</ul>
</section>
<section id="research-and-spinoffs" class="level3">
<h3 class="anchored" data-anchor-id="research-and-spinoffs">Research and Spinoffs</h3>
<ul>
<li><strong>Radiation Effects Research:</strong> The facility yielded new insights into the effects of intense radiation on materials.
<ul>
<li><strong>Lockwood:</strong> Lockheed developed a process to harden wood using radiation, creating “Lockwood” for use in buildings like the Atomic Energy Commission building.</li>
</ul></li>
<li><strong>Cobalt-60 Production:</strong> Lockheed attempted to commercialize Cobalt-60 production but faced challenges:
<ul>
<li>The facility was not optimized for cobalt handling, leading to widespread contamination.</li>
<li>The business failed, and the Georgia Nuclear Lab was dismantled in 1971.</li>
</ul></li>
</ul>
</section>
<section id="dismantling-and-legacy" class="level3">
<h3 class="anchored" data-anchor-id="dismantling-and-legacy">Dismantling and Legacy</h3>
<ul>
<li><strong>Dismantling (1971):</strong>
<ul>
<li>Reactor cores were removed, and most above-ground structures were demolished.</li>
<li>Georgia Tech absorbed many of the lab’s personnel.</li>
<li>Even salvaged materials like lead bricks were contaminated with Cobalt-60.</li>
</ul></li>
<li><strong>Sale to Atlanta:</strong>
<ul>
<li>The site was sold to the city of Atlanta, reportedly for $1, with warnings about potential buried hazards.</li>
<li>Initially intended for a new airport, the hilly terrain proved unsuitable, and the site became a nature preserve.</li>
</ul></li>
</ul>
</section>
<section id="exploring-the-remains" class="level3">
<h3 class="anchored" data-anchor-id="exploring-the-remains">Exploring the Remains</h3>
<ul>
<li><strong>Radiation Levels:</strong> A Geiger counter is recommended for exploring the site due to lingering radioactivity, particularly near the former Radiation Effects Laboratory.</li>
<li><strong>Nuclear Support Facility Site:</strong> The current parking lot marks the location of the former Nuclear Support Facility.</li>
<li><strong>Radiation Effects Lab Hot Cell:</strong> The fenced-off concrete blockhouse of the hot cell remains, emitting detectable radiation.
<ul>
<li>Despite decontamination efforts, Cobalt-60 persists in the area.</li>
<li>Dosimeters monitor radiation levels.</li>
<li>The hot cell’s interior is inaccessible.</li>
</ul></li>
<li><strong>Railway Remnants:</strong> The old railway path leads to the remains of a dynamited trestle.</li>
<li><strong>Shadow Shield:</strong> A concrete monolith along Dawson Forest Road marks the former location of a shadow shield near the reactor pit.</li>
<li><strong>Reactor Pit Area:</strong>
<ul>
<li>The area surrounding the former reactor pit was once devoid of life due to high radiation exposure.</li>
<li>Nature has reclaimed the area since the reactor’s removal.</li>
<li>Foundations of the reactor building and rail lines can still be found.</li>
</ul></li>
<li><strong>Europium-152:</strong> The prevalent gamma radiation in the area is primarily from Europium-152, a rare isotope created by neutron bombardment from the reactor.</li>
<li><strong>Uranium Decay:</strong> Gamma rays from decaying uranium in the concrete also contribute to background radiation.</li>
</ul>
</section>
<section id="life-and-radioactivity" class="level3">
<h3 class="anchored" data-anchor-id="life-and-radioactivity">Life and Radioactivity</h3>
<ul>
<li><strong>Subsurface Bacteria:</strong> Researchers discovered a type of bacteria (Firmicutes) that thrives on uranium decay deep underground.</li>
<li><strong>Resilience of Life:</strong> These bacteria demonstrate that life can exist even in extreme radioactive environments, relying solely on radioactive decay for energy.</li>
<li><strong>The Enduring Power of Biology:</strong> The author suggests that biology, with its adaptability and persistence, will ultimately outlast even nuclear processes.
<ul>
<li>Life and nuclear processes have coexisted throughout Earth’s history.</li>
<li>Despite human interventions and challenges, this balance persists.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>book</category>
  <category>notes</category>
  <category>history</category>
  <guid>https://christianjmills.com/posts/atomic-awakening-book-notes/</guid>
  <pubDate>Tue, 03 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Notes on Where Is My Flying Car?</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/where-is-my-flying-car-book-notes/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled" title="Book Links:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Book Links:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://press.stripe.com/where-is-my-flying-car">Publisher Page</a></li>
<li><a href="https://autogeny.org/">Author’s Website</a></li>
</ul>
</div>
</div>
<ul>
<li>Chapter 1: The World of Tomorrow<br>
</li>
<li>Chapter 2: The Graveyard of Dreams<br>
</li>
<li>Chapter 3: The Conquest of the Air<br>
</li>
<li>Chapter 4: Waldo and Magic, Inc.<br>
</li>
<li>Chapter 5: Cold Fusion<br>
</li>
<li>Chapter 6: The Machiavelli Effect<br>
</li>
<li>Chapter 7: The Age of Aquarius<br>
</li>
<li>Chapter 8: Forbidden Fruit<br>
</li>
<li>Chapter 9: Ceiling and Visibility Unlimited<br>
</li>
<li>Chapter 10: Dialogue Concerning the Two Great Systems of the World<br>
</li>
<li>Chapter 11: The Atomic Age<br>
</li>
<li>Chapter 12: When Worlds Collide<br>
</li>
<li>Chapter 13: When the Sleeper Wakes<br>
</li>
<li>Chapter 14: The Dawn of Robots<br>
</li>
<li>Chapter 15: The Second Atomic Age<br>
</li>
<li>Chapter 16: Tom Swift and His Flying Car<br>
</li>
<li>Chapter 17: Escape Velocity<br>
</li>
<li>Chapter 18: Metropolis<br>
</li>
<li>Chapter 19: Engineer’s Dreams<br>
</li>
<li>Chapter 20: Rocket to the Resistance</li>
</ul>
<section id="chapter-1-the-world-of-tomorrow" class="level2">
<h2 class="anchored" data-anchor-id="chapter-1-the-world-of-tomorrow">Chapter 1: The World of Tomorrow</h2>
<section id="the-allure-of-future-technology" class="level3">
<h3 class="anchored" data-anchor-id="the-allure-of-future-technology">The Allure of Future Technology</h3>
<ul>
<li><strong>C. L. Kelly Johnson</strong>, a renowned aeronautical engineer, was inspired by the Tom Swift Jr.&nbsp;stories, which depicted a future with flying cars and advanced technology.
<ul>
<li><blockquote class="blockquote">
<p>“I read Tom Swift and his airship, Tom Swift and his electric runabout, Tom Swift and his submarine boat, and I said, that’s for me.” - C. L. Kelly Johnson</p>
</blockquote></li>
</ul></li>
<li>The original <strong>Tom Swift Sr.</strong> series, introduced in 1910, featured gadgets like an electric runabout and a photo telephone, modeled after <strong>Thomas Edison</strong>.
<ul>
<li>Edison was a celebrated inventor who significantly shaped the 20th century with his inventions and the establishment of the <strong>Industrial Research Laboratory</strong>.</li>
</ul></li>
<li>A century ago, people held a strong belief in a bright future driven by technology, fueled by the rapid advancements of the early 20th century.
<ul>
<li>Examples of advancements: Cars, radios, airplanes, widespread electricity, and economic growth.</li>
</ul></li>
<li>This optimism persisted through the mid-20th century, with figures like Tom Swift Jr.&nbsp;continuing to inspire individuals like Kelly Johnson, who became a leading figure in aircraft design.
<ul>
<li>Johnson’s contributions included the F-104 Starfighter, SR-71 Blackbird, and the first business jet, the Jetstar.</li>
</ul></li>
</ul>
</section>
<section id="the-rise-of-technological-utopianism" class="level3">
<h3 class="anchored" data-anchor-id="the-rise-of-technological-utopianism">The Rise of Technological Utopianism</h3>
<ul>
<li>The vision of a technologically advanced future gained momentum in the early 20th century and was further fueled by the Great Depression.
<ul>
<li>Science fiction flourished during this period, offering a hopeful escape from the hardships of the time.</li>
</ul></li>
<li><strong>H.G. Wells’ film “Things to Come” (1935)</strong> depicted a technological utopia and accurately predicted the onset of World War II and the Blitz.
<ul>
<li>The film’s <strong>Art Deco futuristic style</strong> influenced subsequent popular speculations about the future.</li>
</ul></li>
<li>The <strong>1939 World’s Fair</strong>, with its “I Have Seen the Future” pin and <strong>General Motors’ Futurama exhibit</strong>, further solidified the public’s vision of a technologically advanced future.
<ul>
<li><strong>Grover Whelan</strong>, a key organizer of the fair, coined the phrase “<strong>The World of Tomorrow.</strong>”</li>
<li><strong>Norman Bel Geddes’ streamlined modern designs</strong>, featured in the Futurama exhibit, became synonymous with the future aesthetic.</li>
</ul></li>
<li>Geddes’ influence extended to various aspects of design, from trains and cars to radios and furniture, characterized by curved lines and rounded corners.
<ul>
<li>His concepts included multi-floored passenger airplanes and self-driving cars.</li>
</ul></li>
</ul>
</section>
<section id="wells-vision-and-its-influence" class="level3">
<h3 class="anchored" data-anchor-id="wells-vision-and-its-influence">Wells’ Vision and its Influence</h3>
<ul>
<li>In “Things to Come,” Wells portrays a <strong>technocratic elite</strong> called “Wings Over the World,” a group of airmen who exemplify the emerging technological professional class.</li>
<li>Wells’ concept: This new class, possessing advanced scientific knowledge and skills, would naturally assume leadership after the decline of the old order.</li>
<li>Wells’ utopian vision includes:
<ul>
<li>A technocratic elite ruling over a scientifically advanced society.</li>
<li>Aggressive deployment of technology to solve global problems.</li>
<li>Victorian-style exploration and adventurism, prioritizing results over individual safety.</li>
</ul></li>
<li>Wells’ villains in “Things to Come” are the <strong>“do-nots,”</strong> individuals who are content with their comfortable lives and resist technological progress.
<ul>
<li>This conflict is not a social class struggle but a clash between those who embrace progress (“doers”) and those who oppose it.</li>
</ul></li>
<li>The “do-nots” represent a more nuanced version of the <strong>Eloi</strong> from Wells’ “The Time Machine,” highlighting the potential for societal stagnation due to prolonged comfort and safety.</li>
</ul>
</section>
<section id="the-post-war-world-and-technological-optimism" class="level3">
<h3 class="anchored" data-anchor-id="the-post-war-world-and-technological-optimism">The Post-War World and Technological Optimism</h3>
<ul>
<li>World War II accelerated technological advancements, as promising innovations were rapidly developed, mass-produced, and deployed for military purposes.
<ul>
<li>The war witnessed significant progress in aviation, weaponry, medicine, and other fields.</li>
</ul></li>
<li>Post-war optimism: The belief that wartime scientific and technological advancements could be repurposed to improve civilian life gained widespread traction.</li>
<li>This optimism was reflected in the growing genre of <strong>post-war world literature</strong>, which often echoed the themes of H.G. Wells’ work.</li>
<li>A 1944 review of two books, “Your World Tomorrow” and “Miracles Ahead,” titled “Green Light for the Age of Miracles,” exemplified this optimistic outlook.</li>
<li>The review highlighted predictions for transportation, including:
<ul>
<li>Cars with wings for air travel.</li>
<li>Helicopter “flivers” (small personal aircraft).</li>
<li>Affordable giant airliners enabling global travel.</li>
</ul></li>
<li>While flying cars and flivers remain unrealized, the prediction of affordable air travel has come true.</li>
<li>The books also accurately predicted other advancements:
<ul>
<li>High-octane gasoline, factory-built housing, portable radios, pocket-sized televisions, air conditioning, plastics, synthetic foods and materials, electronic cooking controls, fluorescent lights, and global tourism.</li>
</ul></li>
</ul>
</section>
<section id="popularizing-the-world-of-tomorrow" class="level3">
<h3 class="anchored" data-anchor-id="popularizing-the-world-of-tomorrow">Popularizing the World of Tomorrow</h3>
<ul>
<li><strong>Walt Disney</strong> became a prominent advocate for the World of Tomorrow vision through projects like <strong>Tomorrowland</strong> and the <strong>Experimental Prototype Community of Tomorrow (EPCOT)</strong>.</li>
<li>The promise of <strong>flying cars</strong> extended beyond science fiction, with companies like <strong>Cessna</strong> and <strong>Piper</strong> running ads depicting them in the 1940s and 1960s.</li>
<li>Automakers embraced the futuristic aesthetic, designing cars with features resembling aircraft, such as tail fins and simulated jet intakes.</li>
<li>Experimental flying car projects emerged, including Ford’s Leva Car and the Curtis Wright Bee.</li>
<li>The flying car was considered a feasible achievement within the context of the burgeoning space age.</li>
<li>However, the reality of air travel has fallen short of these optimistic visions, with airports and travel experiences often being less than ideal.</li>
</ul>
</section>
<section id="the-shift-to-space-travel" class="level3">
<h3 class="anchored" data-anchor-id="the-shift-to-space-travel">The Shift to Space Travel</h3>
<ul>
<li>The focus of futuristic visions shifted from flying cars to space travel, as seen in the covers of <strong>Galaxy Science Fiction magazine</strong> from 1950 to 1980.
<ul>
<li>Only six covers featured flying cars, while over half depicted space travel.</li>
</ul></li>
<li><strong>John Glenn’s orbital flight in 1962</strong> marked a turning point, as real-world space exploration began to overshadow the futuristic visions of the 1950s.</li>
<li>The <strong>Space Age</strong> concept, while present in science fiction since the war, gained significant public attention with the launch of <strong>Sputnik in 1957</strong>.</li>
</ul>
</section>
<section id="arthur-c.-clarkes-profiles-of-the-future" class="level3">
<h3 class="anchored" data-anchor-id="arthur-c.-clarkes-profiles-of-the-future">Arthur C. Clarke’s “Profiles of the Future”</h3>
<ul>
<li><strong>Arthur C. Clarke</strong>, a renowned science fiction writer and technologist, published <strong>“Profiles of the Future” in 1962</strong>.</li>
<li>The book explored the limits of technological possibilities, ranging from existing technologies like hovercraft to speculative concepts like antigravity.</li>
<li>Clarke’s work joined a growing body of literature on futurism and technological forecasting, including <strong>Herman Kahn and Anthony J. Wiener’s “The Year 2000.”</strong></li>
<li>Clarke’s predictions focused on the mid- to far-future, acknowledging that near-term predictions would likely disappoint those seeking immediate solutions.</li>
<li>“Profiles of the Future” became a highly influential text among those who embraced technological optimism.</li>
</ul>
</section>
<section id="accurate-predictions-and-inspired-guesses" class="level3">
<h3 class="anchored" data-anchor-id="accurate-predictions-and-inspired-guesses">Accurate Predictions and Inspired Guesses</h3>
<ul>
<li>Clarke accurately predicted the development of <strong>self-driving cars</strong>:
<ul>
<li><blockquote class="blockquote">
<p>“The automobile of the future… will travel there by the most efficient route, after first checking with the highway information system for blockages and traffic jams.” - Arthur C. Clarke</p>
</blockquote></li>
<li><blockquote class="blockquote">
<p>“It may one day be a serious offense to drive an automobile on a public highway.” - Arthur C. Clarke</p>
</blockquote></li>
</ul></li>
<li><strong>Isaac Asimov</strong>, in a 1964 article, also envisioned self-driving vehicles with “robot brains.”</li>
<li>Mainstream futurists like Kahn and Wiener predicted electric cars and pneumatic tube trains but not self-driving ones.</li>
<li>Clarke’s accurate prediction of worldwide communication networks:
<ul>
<li><blockquote class="blockquote">
<p>“We could be in instant contact with each other wherever we may be… It will be possible… for a man to conduct his business from Tahiti or Bali just as well as he could from London.” - Arthur C. Clarke</p>
</blockquote></li>
</ul></li>
</ul>
</section>
<section id="predictions-from-the-1960s-a-mixed-bag" class="level3">
<h3 class="anchored" data-anchor-id="predictions-from-the-1960s-a-mixed-bag">Predictions from the 1960s: A Mixed Bag</h3>
<ul>
<li>Science fiction writers of the 1960s, including Clarke, Asimov, and Heinlein, made various predictions for the present day (2014):
<ul>
<li>Orbital space stations, lunar bases, nuclear rockets, interplanetary travel, pocket telephones, video phones, atomic power, fusion power, space-based military, modular architecture, automatic meal preparation, synthetic food, high-speed transportation, declining highways, self-driving vehicles, cyborgs, robots, automation, wireless energy transmission, translating machines, artificial intelligence, a global library, sea mining, contraception, cures for cancer and other diseases, and psychology and education as hard sciences.</li>
</ul></li>
<li>Some predictions have come true (e.g., pocket phones, global library/internet), while others have not (e.g., nuclear rockets, interplanetary travel).</li>
<li>Many predictions fall into a gray area, with varying degrees of realization (e.g., atomic power, artificial intelligence, sea mining).</li>
<li>Overall, the predictions were reasonably accurate, with a tendency to be optimistic by about a decade, except for transportation and space exploration, which lagged significantly behind expectations.</li>
</ul>
</section>
<section id="the-jetsons-a-cartoon-reflection-of-the-space-age" class="level3">
<h3 class="anchored" data-anchor-id="the-jetsons-a-cartoon-reflection-of-the-space-age">“The Jetsons”: A Cartoon Reflection of the Space Age</h3>
<ul>
<li><strong>Hanna-Barbera’s “The Jetsons” (1962)</strong> embodied the space-age zeitgeist, portraying a future where aeronautics and space travel are commonplace.</li>
<li>The show depicted a working-class family in the year 2062, mirroring the narrative structure of shows like “The Honeymooners” and “The Flintstones.”</li>
<li>The first episode showcased various futuristic concepts: flying cars, conveyor belts, powered chairs, large-screen 3D TVs, robot maids, automatic doors, and pneumatic tube transportation.</li>
<li>The show’s visual style, with its curved lines, tail fins, and antennae, reflected the futuristic aesthetics of “Things to Come” and Futurama.</li>
<li>The Jetsons’ lives were portrayed as incredibly easy and affluent, highlighting the optimistic belief that technological advancements would improve everyone’s lives.</li>
</ul>
</section>
<section id="the-subtext-of-the-jetsons" class="level3">
<h3 class="anchored" data-anchor-id="the-subtext-of-the-jetsons">The Subtext of “The Jetsons”</h3>
<ul>
<li>“The Jetsons” presented a stark contrast to the realities of 1960s America, where many lacked basic amenities like televisions and telephones.</li>
<li>The show’s depiction of effortless luxury and advanced technology implied that technological progress would lead to a future of abundance and leisure for all.</li>
<li>The subtext: Advancing technology would elevate everyone’s standard of living, making everyone a “jet-setter.”</li>
<li>This optimistic message aligned with the historical trend of rising material well-being in the early 20th century, leading to the expectation of continued progress for future generations.</li>
</ul>
</section>
<section id="the-miracles-and-the-zeitgeist" class="level3">
<h3 class="anchored" data-anchor-id="the-miracles-and-the-zeitgeist">The “Miracles” and the Zeitgeist</h3>
<ul>
<li>The remarkable technological and economic advancements of the early 20th century were considered a set of “miracles” by some economists.</li>
<li>However, these advancements were the culmination of a long process of industrial development that had been underway for centuries.</li>
<li>The <strong>Industrial Revolution</strong>, with its innovations in steam power, machinery, and transportation, laid the groundwork for the 20th century’s progress.</li>
<li>The key factor that enabled these advancements was the <strong>zeitgeist</strong>, the spirit of the times, which fostered a culture of innovation and a respect for “doers” over “do-nots.”</li>
<li>Physics remained constant; it was the change in people’s attitudes and approach to technology that drove the progress of the Industrial Revolution and beyond.</li>
</ul>
</section>
</section>
<section id="chapter-2-the-graveyard-of-dreams" class="level2">
<h2 class="anchored" data-anchor-id="chapter-2-the-graveyard-of-dreams">Chapter 2: The Graveyard of Dreams</h2>
<section id="the-great-stagnation" class="level3">
<h3 class="anchored" data-anchor-id="the-great-stagnation">The Great Stagnation</h3>
<section id="setting-the-stage" class="level4">
<h4 class="anchored" data-anchor-id="setting-the-stage">Setting the Stage</h4>
<ul>
<li><strong>Quote:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“The golden age of science fiction gave us more than just optimistic predictions of technological wonders. Gripping fiction requires conflict. Sometimes the aliens are threatening to invade. Sometimes they have already succeeded.”</p>
</blockquote></li>
</ul></li>
<li>Science fiction often presents dystopian futures alongside optimistic ones.</li>
<li><strong>Example:</strong> Philip Francis Nolan’s <em>Armageddon 2419 A.D.</em> (Buck Rogers story) depicts a future where America is in ruins and Americans are a hunted race.</li>
<li><strong>Detroit’s Decline:</strong>
<ul>
<li>Detroit in 1960 was a symbol of American prosperity, with the automobile industry as its cornerstone.</li>
<li>By 2013, Detroit had filed for bankruptcy, facing widespread urban decay and economic hardship.</li>
<li><strong>Statistics on Detroit’s decline:</strong>
<ul>
<li>40% of street lamps don’t work.</li>
<li>210 of 317 public parks are permanently closed.</li>
<li>1-hour police response time to 911 calls.</li>
<li>Only a third of ambulances are drivable.</li>
<li>One-third of the city abandoned.</li>
</ul></li>
</ul></li>
<li><strong>Quote:</strong> “To achieve this level of devastation, you usually have to be invaded by a foreign power.”</li>
<li>Detroit’s decline exemplifies a broader pessimism about the future, contrasting with the optimism of the early-to-mid 20th century.</li>
</ul>
</section>
<section id="the-flying-car-as-a-symbol-of-failed-expectations" class="level4">
<h4 class="anchored" data-anchor-id="the-flying-car-as-a-symbol-of-failed-expectations">The Flying Car as a Symbol of Failed Expectations</h4>
<ul>
<li><strong>Quote:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“It’s hard to predict what life will be like in a hundred years. There are only a few things we can say with certainty. We know that everyone will drive flying cars, that zoning laws will be relaxed to allow buildings hundreds of stories tall, that it will be dark most of the time, and that women will all be trained in the martial arts.” - Paul Graham</p>
</blockquote></li>
</ul></li>
<li><strong>Film Noir Future:</strong> This quote satirizes the common dystopian depiction of the future in film noir, exemplified by films like <em>Blade Runner</em>.</li>
<li><strong>Flying Car Expectations:</strong> In the 1930s-50s, flying cars were a widely anticipated technological advancement, with news stories reporting progress towards their production.</li>
<li><strong>Waning Optimism:</strong> This optimism faded in the 1960s and 70s, replaced by a more pessimistic outlook.</li>
<li><strong>Quote:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“We should also recall the past over optimism, including the universal prediction in the late 1940s that within a generation, each family would have its own vertical liftoff airplane, a universal society of Jetsons.” - Robert J. Gordon</p>
</blockquote></li>
</ul></li>
<li><strong>Quote:</strong> “We’re very far from the flying car.” - Tyler Cowen</li>
<li><strong>Contrasting Expectations:</strong> People in 1962 expected significant advancements in transportation technology based on the rapid progress seen in the first half of the 20th century.</li>
<li><strong>Historical Context:</strong>
<ul>
<li>In 1912, flying machines were in their infancy.
<ul>
<li>The Wright Model B, the first production airplane, was just being sold.</li>
<li>Louis Blériot’s flight across the English Channel was a major event.</li>
</ul></li>
<li>By 1962, fighter planes like the F-104 Starfighter reached speeds over 1,300 mph, and bombers like the B-52 had a range of over 10,000 miles.</li>
<li>Commercial airliners like the 727 and DC-8 could carry 170 people at 600 mph.</li>
<li>The automobile had become universally owned.</li>
</ul></li>
<li><strong>Reasonable Expectations:</strong> The rapid progress in aviation and automobile technology in the first half of the 20th century led to the reasonable expectation that private aircraft would become commonplace by the 21st century.</li>
</ul>
</section>
<section id="life-changing-technologies-and-economic-growth" class="level4">
<h4 class="anchored" data-anchor-id="life-changing-technologies-and-economic-growth">Life-Changing Technologies and Economic Growth</h4>
<ul>
<li><strong>Life in 1962:</strong> The average American in 1962 enjoyed a significantly higher standard of living than in 1900, thanks to numerous technological advancements.</li>
<li><strong>Examples of Life-Changing Technologies:</strong> Automobiles, airplanes, skyscrapers, antibiotics, movies, pre-made clothing, electric lighting, radio, television, refrigerators, vacuum cleaners, washing machines, and modern stoves.</li>
<li><strong>Economic Growth:</strong>
<ul>
<li>Americans became 3-4 times richer between 1900 and 1962.</li>
<li>GDP per capita grew from $4,000-$5,000 (constant 2005 dollars) in 1900 to $16,000 in 1962.</li>
<li>Personal income remained a consistent 50% of total productivity.</li>
<li>Innovations like assembly line manufacturing and containerized shipping boosted productivity.</li>
</ul></li>
<li><strong>Continued Progress Expected:</strong> This period of rapid progress and economic growth fueled expectations of similar advancements in the future, including the widespread adoption of private aircraft.</li>
</ul>
</section>
</section>
<section id="stagnation-point" class="level3">
<h3 class="anchored" data-anchor-id="stagnation-point">Stagnation Point</h3>
<section id="the-missing-future" class="level4">
<h4 class="anchored" data-anchor-id="the-missing-future">The Missing Future</h4>
<ul>
<li><strong>Quote:</strong> “You call this the future? Where are the flying cars?” - Calvin (from the comic strip <em>Calvin and Hobbes</em>)</li>
<li><strong>Persistent Disappointment:</strong> The absence of flying cars and other anticipated technologies highlights the perceived failure of modern technology to meet earlier expectations.</li>
<li><strong>Quote:</strong> “The question, ‘where is my flying car,’ Wikipedia tells us, is emblematic of the supposed failure of modern technology to match futuristic visions that were promoted in earlier decades.”</li>
<li><strong>Google Search Results:</strong> A Google search for “where is my flying car” returns 781,000 webpages, indicating widespread interest in this topic.</li>
<li><strong>The Future’s Uneven Distribution:</strong>
<ul>
<li><strong>Quote:</strong> “The future is already here. It’s just not very evenly distributed.” - William Gibson</li>
<li><strong>Quote:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“We wanted flying cars; instead we got the ability to instantly connect with anyone anywhere in the world to share stories pictures music podcasts ideas film animation comics feedback friendship love and our lives. Flying cars seem really cool on their face, but I somehow doubt that they would have so meaningful an impact on our lives. After all, George Jetson didn’t even have a cell phone.” - Adam Gurry</p>
</blockquote></li>
</ul></li>
</ul></li>
<li><strong>Alternative Viewpoints:</strong> Some argue that the lack of flying cars doesn’t necessarily indicate a slowdown in innovation, but rather a shift in technological focus towards other areas, such as communication and information technology.</li>
</ul>
</section>
<section id="slowing-innovation-and-cost-disease" class="level4">
<h4 class="anchored" data-anchor-id="slowing-innovation-and-cost-disease">Slowing Innovation and Cost Disease</h4>
<ul>
<li><strong>The Great Stagnation:</strong>
<ul>
<li>Tyler Cowen’s book <em>The Great Stagnation</em> (2011) argues that the US entered a period of economic slump in the 1970s after a period of rapid progress due to the exploitation of easily accessible technological advancements.</li>
<li>This stagnation is reflected in slow income growth and a decline in the “American Dream”.</li>
<li>Cowen uses median income rates as evidence, while Peter Turchin highlights the flatlining of unskilled labor wages.</li>
<li>Turchin observes a shift from an “integrative” to a “disintegrative” phase in various societal trends in the 1970s.</li>
</ul></li>
<li><strong>Cost Disease:</strong>
<ul>
<li><strong>Definition:</strong> The phenomenon where the costs of essential goods and services (e.g., housing, education, healthcare) continue to rise in real terms, even after adjusting for inflation.</li>
<li><strong>Examples:</strong>
<ul>
<li>Housing costs have doubled since the 1960s.</li>
<li>Primary education costs have tripled, without a corresponding increase in learning outcomes.</li>
<li>Healthcare costs have risen sixfold, while longevity growth has slowed.</li>
<li>College tuition and textbooks cost roughly ten times more.</li>
</ul></li>
</ul></li>
<li><strong>Distinguishing from Efficiency-Driven Price Changes:</strong> Cost disease is distinct from situations where prices decrease due to increased efficiency (e.g., mass production).</li>
<li><strong>Secular Economic Decline:</strong>
<ul>
<li>Since the 1970s, actual economic growth has fallen below the historical trend line and has not recovered.</li>
<li>The per capita GDP growth rate dropped from 2.8% (pre-1970) to 1.9% (post-1970).</li>
<li>The post-war era (1945-1975) saw consistent economic growth, leading to optimistic projections that were not realized.</li>
</ul></li>
</ul>
</section>
<section id="optimistic-projections-and-their-failure" class="level4">
<h4 class="anchored" data-anchor-id="optimistic-projections-and-their-failure">Optimistic Projections and Their Failure</h4>
<ul>
<li><strong>Quote:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“The most significant discovery emerging from our increasingly sophisticated understanding of the economic growth process is the fact that accelerated economic growth can be achieved by a combination of fiscal policy, monetary policy, and continuously increasing R&amp;D budgets, both federal and private.” - Robert Prohota</p>
</blockquote></li>
</ul></li>
<li><strong>Herbert Simon’s Prediction:</strong> Herbert Simon, in his 1966 book <em>The Shape of Automation</em>, predicted that average family income would reach $28,000 (1966 dollars) by the turn of the century, based on a 3% growth rate.</li>
<li><strong>Reality:</strong> Instead of the projected 3% growth, family income growth slowed to 0.5% in the following half-century.</li>
<li><strong>Factors Contributing to Slowdown:</strong>
<ul>
<li>The rise of single-parent households, leading to a loss of economic efficiencies associated with the traditional family structure.</li>
</ul></li>
<li><strong>Conclusion:</strong> While individual indicators of stagnation might be debatable, the combined evidence suggests a significant slowdown in technological progress and economic growth since the 1970s.</li>
</ul>
</section>
</section>
<section id="the-airplane-crash" class="level3">
<h3 class="anchored" data-anchor-id="the-airplane-crash">The Airplane Crash</h3>
<section id="decline-of-the-private-airplane-industry" class="level4">
<h4 class="anchored" data-anchor-id="decline-of-the-private-airplane-industry">Decline of the Private Airplane Industry</h4>
<ul>
<li><strong>Disappearance of the Industry:</strong> The private airplane industry, including companies like Cessna and Piper, experienced a significant decline starting in the late 1970s.</li>
<li><strong>The 1960s Boom:</strong> The 1960s was a period of growth for private aviation, with a wide variety of small family airplanes available.</li>
<li><strong>Impact of the Energy Crisis:</strong> The energy crisis of the 1970s temporarily impacted the industry, but it recovered within a few years.</li>
<li><strong>Current State:</strong> Today, only about 700 new piston airplanes, 400 turboprops, and 400 private jets are sold annually.</li>
<li><strong>Increased Costs:</strong> Due to limited demand, airplane prices have increased more than tenfold compared to the 1970s.</li>
</ul>
</section>
<section id="flatlining-of-airliner-speeds" class="level4">
<h4 class="anchored" data-anchor-id="flatlining-of-airliner-speeds">Flatlining of Airliner Speeds</h4>
<ul>
<li><strong>Exponential Growth Followed by Plateau:</strong> Airliner speeds increased exponentially until the 1960s, then plateaued.</li>
<li><strong>Reasons for the Plateau:</strong>
<ul>
<li><strong>Physics and Economics:</strong> Flying just above Mach 1 is three times more expensive than flying just below it.</li>
<li><strong>Subsidized SST Projects:</strong> The Concorde and Tupolev Tu-144 supersonic transports were heavily subsidized national projects.</li>
</ul></li>
<li><strong>Engine Technology Continued to Advance:</strong> Despite the plateau in airliner speeds, engine technology continued to improve significantly.
<ul>
<li><strong>Example:</strong> The de Havilland Ghost turbojet engine (1950s) had 5,000 pounds of thrust, while the GE-90 (1990s) had 115,000 pounds of thrust.</li>
</ul></li>
<li><strong>Unfulfilled Expectations:</strong> Based on the rapid progress in the first half of the 20th century, people in 1962 expected further significant increases in airliner speed, range, and capacity.</li>
<li><strong>Stagnation in Air Travel:</strong> Instead of further advancements, air travel has seen little improvement in the past 50 years, with some aspects even declining in the pursuit of fuel efficiency.</li>
<li><strong>Potential Market for Faster Travel:</strong> Despite the existence of technology for faster air travel, it has not been implemented, suggesting roadblocks beyond economic considerations.</li>
<li><strong>Energy Considerations:</strong> For long international flights, the energy required to fly through the atmosphere is comparable to that needed for orbital flight, which could be significantly faster.</li>
<li><strong>Iconic Example of Stagnation:</strong> The plateau in air travel serves as a representative example of the broader stagnation in life-improving technologies observed since the 1970s.</li>
<li><strong>Historical Analogy:</strong> The transition from wooden sailboats to steel steamships demonstrates that the adoption of more expensive technology can be justified by its superior performance.</li>
</ul>
</section>
</section>
<section id="the-henry-adams-curve" class="level3">
<h3 class="anchored" data-anchor-id="the-henry-adams-curve">The Henry Adams Curve</h3>
<section id="the-historical-trend-of-energy-growth" class="level4">
<h4 class="anchored" data-anchor-id="the-historical-trend-of-energy-growth">The Historical Trend of Energy Growth</h4>
<ul>
<li><strong>Quote:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“The coal output of the world, speaking roughly, doubled every ten years between 1840 and 1900, in the form of utilized power, for the ton of coal yielded three or four times as much power in 1900 as in 1840. Rapid as this rate of acceleration in volume seems, it may be tested in a thousand ways without greatly reducing it. Perhaps the ocean steamer is nearest unity and easiest to measure, for anyone might hire in 1905, for a small sum of money, the use of 30,000 steam horsepower to cross the ocean. And by halving this figure every ten years, he got back to 234 horsepower for 1835, which was accuracy enough for his purposes.” - Henry Adams</p>
</blockquote></li>
</ul></li>
<li><strong>The Henry Adams Curve:</strong> A historical trend of roughly 7% annual growth in usable energy available to civilization, observed since the early days of the steam engine.</li>
<li><strong>Factors Contributing to the Curve:</strong>
<ul>
<li>3% population growth.</li>
<li>2% energy efficiency growth.</li>
<li>2% growth in per capita energy consumption.</li>
</ul></li>
<li><strong>Flatlining of Energy Consumption:</strong> The Henry Adams curve plateaued in the 1970s, as shown by US energy consumption data.</li>
<li><strong>The 1970s Energy Crisis:</strong>
<ul>
<li>The energy crisis was caused by Nixon’s price controls (1971), followed by the OPEC oil embargo (1973).</li>
<li>The Department of Energy (established 1977) is jokingly suggested to have been created to prevent energy use.</li>
</ul></li>
<li><strong>Human Power vs.&nbsp;Modern Energy Use:</strong>
<ul>
<li>Before the Industrial Revolution, humans relied primarily on their own muscle power and animal power.</li>
<li>A human can produce about 100 watts of power daily.</li>
<li>The average South American uses 10 times this amount, while the average North American uses 100 times.</li>
</ul></li>
<li><strong>Potential for Further Growth:</strong> It’s conceivable that future technological advancements could significantly increase energy use per capita.</li>
<li><strong>Consequences of the Flatline:</strong> The plateau in energy consumption has contributed to a slowdown in life-improving technologies, including those related to productivity, health, and transportation.</li>
</ul>
</section>
<section id="correlation-between-energy-intensity-and-technological-progress" class="level4">
<h4 class="anchored" data-anchor-id="correlation-between-energy-intensity-and-technological-progress">Correlation Between Energy Intensity and Technological Progress</h4>
<ul>
<li><strong>Analysis of Science Fiction Predictions:</strong> Examining the fulfillment of technological predictions from the golden age of science fiction reveals a pattern related to energy intensity.</li>
<li><strong>Correlation with Energy Intensity:</strong>
<ul>
<li>Technologies requiring low power levels have generally been fulfilled or even exceeded expectations.</li>
<li>Technologies requiring moderate power levels have seen mixed results, with some fulfilling expectations and others falling short.</li>
<li>Technologies requiring high power levels have consistently failed to meet expectations.</li>
</ul></li>
<li><strong>Moore’s Law as an Exception:</strong> The continued progress in computing and communications, exemplified by Moore’s Law, is an exception because energy consumption was not a major constraint in this area.</li>
<li><strong>The Forbidden Zone:</strong> The top right quadrant of the graph, representing high-power technologies, appears to be a “forbidden zone” where predicted advancements have not materialized.</li>
<li><strong>Denied Futures:</strong> This “forbidden zone” represents the futures we were promised but were denied, including flying cars, due to the limitations imposed by the energy flatline.</li>
</ul>
</section>
<section id="the-consequences-of-power-limitations" class="level4">
<h4 class="anchored" data-anchor-id="the-consequences-of-power-limitations">The Consequences of Power Limitations</h4>
<ul>
<li><p><strong>Quote:</strong></p>
<ul>
<li><blockquote class="blockquote">
<p>“Power is our only lack. We generate all we can with the materials and knowledge at our disposal, but we never have enough. Our development is hindered, our birth rate must be held down to a minimum, many new cities which we need cannot be built, and many new projects cannot be started, all for lack of power.” - E.E. “Doc” Smith</p>
</blockquote></li>
</ul></li>
<li><p>This quote from E.E. “Doc” Smith highlights the profound impact of power limitations on societal development and progress.</p></li>
</ul>
</section>
</section>
</section>
<section id="chapter-3-the-conquest-of-the-air" class="level2">
<h2 class="anchored" data-anchor-id="chapter-3-the-conquest-of-the-air">Chapter 3: The Conquest of the Air</h2>
<section id="early-predictions-and-skepticism" class="level3">
<h3 class="anchored" data-anchor-id="early-predictions-and-skepticism">Early Predictions and Skepticism</h3>
<ul>
<li><strong>H.G. Wells</strong> predicted successful airplane flight before the year 2000. (Wells’ Anticipations, Circa 1900)</li>
<li>The scientific community, including astronomer <strong>Simon Newcomb</strong>, largely believed powered, heavier-than-air flight was impossible or at least a million years away. (New York Times, 1903)</li>
<li>Newcomb’s critiques, while ultimately incorrect, highlighted key challenges to be solved, such as:
<ul>
<li><strong>How to stop an airplane traveling at high speeds:</strong> “How is he ever going to stop?” (Newcomb, 1903)
<ul>
<li>Current airplanes use a “kludge” of descending to the ground at flying speed and slowing down on a runway.</li>
<li>This runway requirement prevents airplanes from being practical flying cars.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-power-curve-and-energy-management" class="level3">
<h3 class="anchored" data-anchor-id="the-power-curve-and-energy-management">The Power Curve and Energy Management</h3>
<ul>
<li><strong>The key to flying is energy management.</strong></li>
<li>Airplanes require power to:
<ul>
<li><strong>Generate lift:</strong> Stay aloft.</li>
<li><strong>Overcome drag:</strong> Maintain speed.</li>
</ul></li>
<li><strong>Three stores of energy</strong> power an airplane:
<ol type="1">
<li><strong>Speed:</strong> Provides a few seconds of flight.</li>
<li><strong>Altitude:</strong> Provides a few minutes of flight.</li>
<li><strong>Fuel:</strong> Provides a few hours of flight.</li>
</ol></li>
<li><strong>Takeoff, climb, and landing</strong> are phases of managing these energy stores.</li>
<li><strong>Landing</strong> is particularly problematic:
<ul>
<li>Descending directly downwards converts altitude energy into unwanted speed.</li>
<li>Requires a long, slanting approach to bleed off energy.</li>
<li>Airplanes must maintain flying speed until touchdown.</li>
</ul></li>
<li><strong>Induced drag</strong> (related to lift) decreases with increasing speed.</li>
<li><strong>Parasitic drag</strong> (related to other air disturbances) increases with increasing speed.</li>
<li>The <strong>power curve</strong> represents the total power needed to fly at different speeds.
<ul>
<li>Flying faster or slower than the optimal speed requires more power.</li>
</ul></li>
<li><strong>Birds</strong> can efficiently land because they can:
<ul>
<li>Spread their wings for high lift and high drag.</li>
<li>Flap vigorously to increase lift while slowing down.</li>
<li>Integrate thrust production with lift generation.</li>
</ul></li>
<li><strong>Fixed-wing airplanes</strong> cannot replicate this:
<ul>
<li>Increasing lift with the propeller also increases speed.</li>
<li>This creates a conflict during landing when slowing down is desired.</li>
</ul></li>
<li><strong>The closer flight technology can emulate birds, the closer we get to flying cars.</strong></li>
</ul>
</section>
<section id="early-attempts-at-runway-independent-flight" class="level3">
<h3 class="anchored" data-anchor-id="early-attempts-at-runway-independent-flight">Early Attempts at Runway-Independent Flight</h3>
<section id="the-flying-pancake-and-custer-channel-wing" class="level4">
<h4 class="anchored" data-anchor-id="the-flying-pancake-and-custer-channel-wing">The Flying Pancake and Custer Channel Wing</h4>
<ul>
<li><strong>Charles Zimmerman</strong> (NACA) developed the <strong>Flying Pancake</strong> in the 1930s.
<ul>
<li>Goal: Create an airplane that could descend steeply at low speeds for easier landings, eliminating the need for long runways. (Zimmerman, 1932)</li>
</ul></li>
<li><strong>Willard R. Custer’s Channel Wing (CCW)</strong> aircraft used <strong>upper surface blowing</strong>.
<ul>
<li>Patented in 1929, flew in the 1940s.</li>
<li>CCW-5:
<ul>
<li>5 passengers, 2.5 tons, 200 mph cruise speed.</li>
<li>35 mph flight speed, 250-foot takeoff roll.</li>
</ul></li>
<li>Achieved low-speed lift by positioning propellers to create high-speed airflow over the upper wing surface.</li>
</ul></li>
<li><strong>Challenges</strong> faced by the Flying Pancake and CCW:
<ul>
<li>High angle of attack required for low-speed flight, obscuring ground visibility.</li>
<li>High power consumption at low speeds.</li>
</ul></li>
</ul>
</section>
</section>
<section id="autogyros-a-promising-compromise" class="level3">
<h3 class="anchored" data-anchor-id="autogyros-a-promising-compromise">Autogyros: A Promising Compromise</h3>
<section id="juan-de-la-ciervas-innovation" class="level4">
<h4 class="anchored" data-anchor-id="juan-de-la-ciervas-innovation">Juan de la Cierva’s Innovation</h4>
<ul>
<li><strong>Juan de la Cierva</strong> invented the <strong>autogyro</strong> in the early 1920s.
<ul>
<li>Goal: Solve the stall problem by making wings move fast even at low aircraft speeds.</li>
</ul></li>
<li><strong>Autogyro features:</strong>
<ul>
<li><strong>Rotor blades</strong> act as the wing, generating lift.</li>
<li>Separate propeller provides thrust to overcome drag.</li>
<li><strong>Autorotation:</strong> Wind passing through the rotor disc causes the rotors to spin.</li>
</ul></li>
<li><strong>Innovations to overcome autogyro challenges:</strong>
<ul>
<li><strong>Dissymmetry of lift:</strong> Solved by using <strong>flapping hinges</strong> that allow blades to adjust their angle of attack.
<ul>
<li>Blades on the advancing side flap up, reducing lift; blades on the retreating side flap down, increasing lift.</li>
</ul></li>
<li><strong>Centrifugal force</strong> keeps the flapping blades extended outwards.</li>
</ul></li>
<li><strong>Development and Refinement:</strong>
<ul>
<li>De la Cierva refined the autogyro throughout the 1920s.</li>
<li><strong>Frank Courtney’s</strong> experience with blade breakage led to the addition of <strong>lead-lag hinges</strong> to accommodate blade acceleration and deceleration.</li>
</ul></li>
</ul>
</section>
<section id="harold-pitcairn-and-the-rise-of-autogyros" class="level4">
<h4 class="anchored" data-anchor-id="harold-pitcairn-and-the-rise-of-autogyros">Harold Pitcairn and the Rise of Autogyros</h4>
<ul>
<li><strong>Harold Pitcairn</strong> acquired the US rights to build and develop autogyros in 1929.</li>
<li><strong>1931 milestones:</strong>
<ul>
<li>Pitcairn autogyro landed on the White House lawn.</li>
<li><strong>Amelia Earhart</strong> set an altitude record in an autogyro.</li>
</ul></li>
<li><strong>Autogyros in popular culture:</strong>
<ul>
<li>Featured in fiction and movies (e.g., It Happened One Night, Things to Come, For Us the Living).</li>
</ul></li>
<li><strong>Direct Control Rotor Hub:</strong>
<ul>
<li>Invented by de la Cierva, allowed direct pilot control of rotor blade pitch.</li>
<li>Eliminated the need for wings on later autogyro models.</li>
</ul></li>
</ul>
</section>
<section id="the-decline-of-autogyros" class="level4">
<h4 class="anchored" data-anchor-id="the-decline-of-autogyros">The Decline of Autogyros</h4>
<ul>
<li><strong>De la Cierva’s death in 1936</strong> hindered autogyro development.
<ul>
<li>Loss of intellectual and spiritual leadership.</li>
<li>Breakdown of collaboration and information sharing.</li>
</ul></li>
<li><strong>World War II</strong> further disrupted development.</li>
<li><strong>Pitcairn’s legal battles</strong> with the US government over helicopter patents diverted resources.</li>
</ul>
</section>
<section id="autogyro-safety-and-advantages" class="level4">
<h4 class="anchored" data-anchor-id="autogyro-safety-and-advantages">Autogyro Safety and Advantages</h4>
<ul>
<li><strong>Safety features:</strong>
<ul>
<li>Low takeoff and landing speeds.</li>
<li>Less susceptible to wind gusts.</li>
<li>Inherent autorotation capability.</li>
</ul></li>
<li><strong>Advantages over helicopters:</strong>
<ul>
<li>Simpler and less expensive.</li>
<li>Autorotation is always available, unlike in some helicopter flight regimes.</li>
</ul></li>
<li><strong>Accident statistics from the 1930s</strong> showed a low fatality rate.</li>
</ul>
</section>
<section id="why-autogyros-didnt-become-flying-cars" class="level4">
<h4 class="anchored" data-anchor-id="why-autogyros-didnt-become-flying-cars">Why Autogyros Didn’t Become Flying Cars</h4>
<ul>
<li><strong>Superseded by helicopters:</strong>
<ul>
<li>Helicopters offer greater versatility (hovering, vertical takeoff).</li>
</ul></li>
<li><strong>Market specialization:</strong>
<ul>
<li>Airplanes excel in speed and fuel efficiency.</li>
<li>Helicopters excel in hovering and vertical operations.</li>
</ul></li>
<li><strong>Post-war decline in private aviation:</strong>
<ul>
<li>Government focus shifted away from pilot training.</li>
<li>Interstate highway system provided a compelling alternative for travel.</li>
</ul></li>
</ul>
</section>
</section>
<section id="convertible-car-airplanes" class="level3">
<h3 class="anchored" data-anchor-id="convertible-car-airplanes">Convertible Car-Airplanes</h3>
<section id="buckminster-fullers-dymaxion-car" class="level4">
<h4 class="anchored" data-anchor-id="buckminster-fullers-dymaxion-car">Buckminster Fuller’s Dymaxion Car</h4>
<ul>
<li><strong>Buckminster Fuller’s Dymaxion car (early 1930s):</strong>
<ul>
<li>Aerodynamic egg shape.</li>
<li>Three-wheel configuration, steered by the rear wheel.</li>
</ul></li>
<li><strong>Challenges:</strong>
<ul>
<li><strong>Ground looping:</strong> Instability in crosswinds.</li>
<li><strong>Lifting body effect:</strong> Tendency to lose ground contact at high speeds.</li>
</ul></li>
</ul>
</section>
<section id="waldo-watermans-aerobeel" class="level4">
<h4 class="anchored" data-anchor-id="waldo-watermans-aerobeel">Waldo Waterman’s Aerobeel</h4>
<ul>
<li><strong>Waldo Waterman’s Aerobeel (1937):</strong>
<ul>
<li><strong>First fully functional fixed-wing flying car.</strong></li>
<li>Tailless (flying wing) design.</li>
<li>Tricycle landing gear (more stable than tail-draggers).</li>
</ul></li>
<li><strong>Features:</strong>
<ul>
<li>Easy to fly and drive.</li>
<li>Removable wings for car mode.</li>
</ul></li>
<li><strong>Reasons for failure:</strong>
<ul>
<li>Great Depression hampered sales.</li>
<li>Loss of financial support and Waterman’s illness.</li>
<li>World War II disruption.</li>
</ul></li>
</ul>
</section>
<section id="world-war-iis-impact" class="level4">
<h4 class="anchored" data-anchor-id="world-war-iis-impact">World War II’s Impact</h4>
<ul>
<li>The war significantly hindered flying car development:
<ul>
<li>Diverted resources and personnel.</li>
<li>Halted private aviation growth.</li>
<li><strong>Examples of disrupted projects:</strong>
<ul>
<li><strong>Moulton Taylor’s</strong> flying car.</li>
<li><strong>Ted Hall’s</strong> modular flying car designs.</li>
<li><strong>Pitcairn Aviation’s</strong> autogyro development.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="moulton-taylors-aerocar" class="level4">
<h4 class="anchored" data-anchor-id="moulton-taylors-aerocar">Moulton Taylor’s AeroCar</h4>
<ul>
<li><strong>Moulton Taylor’s AeroCar (post-war):</strong>
<ul>
<li>Two-seater coupe with a 143-horsepower engine.</li>
<li>Foldable wings and tail stored in a towable trailer.</li>
<li>Well-designed, stable, and easy to fly.</li>
</ul></li>
<li><strong>Models:</strong>
<ul>
<li>Four AeroCar I, one AeroCar II, one AeroCar III (rebuilt from AeroCar I).</li>
</ul></li>
<li><strong>Achievements:</strong>
<ul>
<li>Received Federal Aircraft Certification in 1956.</li>
<li>Flew a total of 9,000 hours.</li>
<li>135 mph cruise speed.</li>
</ul></li>
<li><strong>Significance:</strong>
<ul>
<li><strong>Solved the three-vehicle problem.</strong></li>
</ul></li>
<li><strong>Reasons for limited success:</strong>
<ul>
<li>Decline in private aviation.</li>
<li>Rise of the Interstate Highway System.</li>
</ul></li>
</ul>
</section>
<section id="convair-car" class="level4">
<h4 class="anchored" data-anchor-id="convair-car">Convair Car</h4>
<ul>
<li><strong>Theodore Hall’s Convair Car (late 1940s):</strong>
<ul>
<li>Airplane designed to carry a car, not fly independently.</li>
<li>Car designed by <strong>Henry Dreyfus</strong>.</li>
<li>Specifications:
<ul>
<li>1,500 lbs empty weight, 1,000 lbs payload and fuel capacity.</li>
<li>190-horsepower engine, 125 mph airspeed.</li>
<li>25-horsepower car engine.</li>
</ul></li>
</ul></li>
<li><strong>Marketing plan:</strong>
<ul>
<li>Sell the car separately, rent the airplane part at airports.</li>
</ul></li>
<li><strong>Reason for failure:</strong>
<ul>
<li>Test pilot <strong>Ruben Snodgrass</strong> crash-landed the prototype due to fuel exhaustion.</li>
<li>Negative publicity led to project cancellation.</li>
</ul></li>
<li><strong>Significance:</strong>
<ul>
<li><strong>Nearly solved the three-vehicle problem.</strong></li>
</ul></li>
</ul>
</section>
</section>
<section id="helicopters-and-vtol-aircraft" class="level3">
<h3 class="anchored" data-anchor-id="helicopters-and-vtol-aircraft">Helicopters and VTOL Aircraft</h3>
<section id="jules-vernes-albatross" class="level4">
<h4 class="anchored" data-anchor-id="jules-vernes-albatross">Jules Verne’s Albatross</h4>
<ul>
<li><strong>Jules Verne’s Rober the Conqueror (1886)</strong> featured the <strong>Albatross</strong>, an early depiction of a <strong>VTOL</strong> flying machine.
<ul>
<li>Clipper ship lifted by numerous airscrews.</li>
</ul></li>
<li><strong>Modern feasibility:</strong>
<ul>
<li>A lighter, more aerodynamic version could be built today.</li>
</ul></li>
</ul>
</section>
<section id="helicopter-development" class="level4">
<h4 class="anchored" data-anchor-id="helicopter-development">Helicopter Development</h4>
<ul>
<li><strong>Helicopters</strong> became practical around 1940.</li>
<li><strong>Key innovations from autogyros:</strong>
<ul>
<li>Flapping hinges.</li>
<li>Dampened lead-lag hinges.</li>
<li>Collective and cyclic pitch controls.</li>
</ul></li>
<li><strong>Sikorsky’s early helicopter:</strong>
<ul>
<li>Three tail rotors for torque counteraction and pitch/roll control.</li>
</ul></li>
<li><strong>Adoption of Pitcairn’s fully articulated hub (patent 582):</strong>
<ul>
<li>Allowed for the standard single side-facing tail rotor configuration.</li>
</ul></li>
</ul>
</section>
<section id="limitations-of-helicopters" class="level4">
<h4 class="anchored" data-anchor-id="limitations-of-helicopters">Limitations of Helicopters</h4>
<ul>
<li><strong>High cost:</strong>
<ul>
<li>Complex and precise rotor hub requires expensive manufacturing and maintenance.</li>
</ul></li>
<li><strong>Solution:</strong>
<ul>
<li>Replace the single large rotor with multiple small, ducted fans (like Verne’s Albatross).</li>
</ul></li>
</ul>
</section>
<section id="ducted-fan-vtol-aircraft" class="level4">
<h4 class="anchored" data-anchor-id="ducted-fan-vtol-aircraft">Ducted Fan VTOL Aircraft</h4>
<ul>
<li><strong>Hiller Flying Platform (1950s):</strong>
<ul>
<li>Ducted fan VTOL resembling a flying Segway.</li>
</ul></li>
<li><strong>Ducted fan advantages:</strong>
<ul>
<li><strong>Court nozzle effect:</strong> Amplifies lift by ~40%.</li>
<li>Noise reduction.</li>
<li>Increased stability.</li>
</ul></li>
<li><strong>Flying Platform specifications:</strong>
<ul>
<li>7 feet wide, 370 lbs empty weight, 180 lbs payload capacity.</li>
<li>80 horsepower (two 40-horsepower engines).</li>
<li>Limited altitude (33 feet) and speed (16 mph).</li>
</ul></li>
<li><strong>Challenges:</strong>
<ul>
<li>Duct-induced stability limits forward speed.</li>
</ul></li>
</ul>
</section>
<section id="tilt-duct-vtol-aircraft" class="level4">
<h4 class="anchored" data-anchor-id="tilt-duct-vtol-aircraft">Tilt Duct VTOL Aircraft</h4>
<ul>
<li><strong>Doak VZ-4:</strong>
<ul>
<li>Tilting ducted fans for forward flight.</li>
<li>Specifications:
<ul>
<li>~1 ton empty weight, ~1.5 tons loaded weight.</li>
<li>230 mph maximum speed.</li>
</ul></li>
</ul></li>
<li><strong>Army VZ program (1950s):</strong>
<ul>
<li><strong>VZ-6 (Chrysler):</strong> Unsuccessful, crashed due to instability.</li>
<li><strong>VZ-8 (Piasecki):</strong> Reasonably successful flying jeep.
<ul>
<li>Twin 400-horsepower turboshaft engines.</li>
<li>Capable of hovering, low-altitude flight, and weapons platform use.</li>
<li>Ultimately deemed unsuitable for field operations.</li>
</ul></li>
</ul></li>
<li><strong>Navy Bell X-22A (mid-1960s):</strong>
<ul>
<li>Four-fan tilt duct VTOL.</li>
<li>Nearly 40 feet long, 9 tons loaded weight.</li>
<li>Successful tilt duct design, easy transition to forward flight.</li>
<li>255 mph top speed.</li>
<li>Potential for scaled-down flying car application.</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-unfulfilled-promise-of-flying-cars" class="level3">
<h3 class="anchored" data-anchor-id="the-unfulfilled-promise-of-flying-cars">The Unfulfilled Promise of Flying Cars</h3>
<section id="the-role-of-visionaries-and-entrepreneurs" class="level4">
<h4 class="anchored" data-anchor-id="the-role-of-visionaries-and-entrepreneurs">The Role of Visionaries and Entrepreneurs</h4>
<ul>
<li><strong>1930s:</strong>
<ul>
<li>Understanding of the “needs of the private owner” for aircraft design.</li>
<li>De la Cierva and Pitcairn’s efforts to develop the autogyro.</li>
</ul></li>
<li><strong>Post-war era:</strong>
<ul>
<li>Helicopters emerged as a potential solution.</li>
<li>Pitcairn focused on autogyros due to their lower cost and suitability for private use.</li>
<li>Legal battles hindered Pitcairn’s progress.</li>
</ul></li>
</ul>
</section>
<section id="technological-feasibility-vs.-realization" class="level4">
<h4 class="anchored" data-anchor-id="technological-feasibility-vs.-realization">Technological Feasibility vs.&nbsp;Realization</h4>
<ul>
<li>By the 1970s, various flying car technologies had been successfully demonstrated:
<ul>
<li>Convertible airplanes.</li>
<li>Ducted-fan VTOLs.</li>
</ul></li>
<li><strong>Cost</strong> remained a major barrier to widespread adoption.</li>
<li><strong>Technological advancement</strong> could have potentially overcome cost barriers over time (similar to computers).</li>
</ul>
</section>
<section id="conclusion" class="level4">
<h4 class="anchored" data-anchor-id="conclusion">Conclusion</h4>
<ul>
<li><strong>The absence of flying cars today is not due to technological limitations.</strong></li>
<li><strong>Factors contributing to the lack of flying cars:</strong>
<ul>
<li>Economic factors (Great Depression, World War II).</li>
<li>Shifting government priorities.</li>
<li>Rise of alternative transportation systems (Interstate Highway System).</li>
<li>Lack of sustained investment and development.</li>
</ul></li>
</ul>
</section>
<section id="questions-for-reflection" class="level4">
<h4 class="anchored" data-anchor-id="questions-for-reflection">Questions for Reflection</h4>
<ul>
<li>What other potentially transformative technologies have failed to materialize?</li>
<li>Are we accepting limitations that could be overcome with further innovation?</li>
<li>What is the future of personal transportation?</li>
</ul>
</section>
</section>
</section>
<section id="chapter-4-waldo-and-magic-inc." class="level2">
<h2 class="anchored" data-anchor-id="chapter-4-waldo-and-magic-inc.">Chapter 4: Waldo and Magic, Inc.</h2>
<section id="waldos-origin-and-concept" class="level3">
<h3 class="anchored" data-anchor-id="waldos-origin-and-concept">Waldo’s Origin and Concept</h3>
<ul>
<li><strong>Robert A. Heinlein</strong>, writing as Anson MacDonald, introduced the <strong>Waldo F. Jones Synchronous Reduplicating Pantograph</strong> in a 1942 Astounding science fiction story.
<ul>
<li>This concept established Heinlein as the <strong>conceptual inventor of the telemanipulator</strong>, often referred to as a <strong>Waldo</strong>.</li>
</ul></li>
<li>A <strong>Waldo</strong> is essentially a <strong>robot arm controlled remotely by a human operator</strong>, unlike programmed robots.
<ul>
<li><strong>Waldos</strong> emerged in the 1950s, driven by advancements in <strong>cybernetics and control theory</strong>, and the need to handle <strong>radioactive materials</strong> in the burgeoning <strong>nuclear field</strong>.</li>
</ul></li>
<li>Heinlein’s original <strong>Waldos</strong> had two key features:
<ul>
<li><strong>Self-replicating and reduplicating.</strong></li>
<li><strong>Scale-shifting</strong>.</li>
</ul></li>
<li><strong>Waldo’s objective</strong> was to operate on individual nerve cells by creating a series of progressively smaller Waldos.
<ul>
<li>Existing tools, like <strong>electromagnetic instruments and neural surgery</strong>, lacked the precision for Waldo’s desired level of investigation.</li>
</ul></li>
<li><strong>Waldo’s smallest Waldos</strong> at the time had <strong>half-inch palms</strong> and <strong>micro-scanners</strong>.
<ul>
<li>These were still too large for his purpose, leading him to use them to create even tinier Waldos.</li>
</ul></li>
<li><strong>Waldo’s final Waldos</strong> for nerve and brain surgery ranged from <strong>life-size mechanical hands</strong> to <strong>tiny “fairy digits”</strong> capable of manipulating objects invisible to the naked eye.
<ul>
<li>These were <strong>mounted in banks</strong> to work on the same area.</li>
<li>Waldo controlled them all from the same <strong>primary controls</strong>, switching sizes without removing his gauntlets.</li>
<li>Circuit changes automatically adjusted the <strong>scanning sweep and magnification</strong>, providing Waldo with a life-size image of his “other hands” in his stereo receiver.</li>
</ul></li>
<li>Heinlein briefly addressed the challenge of <strong>visualization at smaller scales</strong> in a science fiction context, but lacked a detailed plan.
<ul>
<li>A more concrete solution would emerge nearly two decades later.</li>
</ul></li>
</ul>
</section>
<section id="feynmans-vision-nanotechnologys-genesis" class="level3">
<h3 class="anchored" data-anchor-id="feynmans-vision-nanotechnologys-genesis">Feynman’s Vision: Nanotechnology’s Genesis</h3>
<ul>
<li><strong>Richard Feynman</strong>, a physics professor at Caltech, likely encountered Heinlein’s Waldo story.
<ul>
<li><strong>Feynman’s academic background</strong> (MIT, Princeton, Los Alamos) placed him in environments with strong science fiction communities.</li>
</ul></li>
<li>In late 1959, Feynman repurposed the Waldo idea for an after-dinner speech at an <strong>American Physics Society conference</strong>.
<ul>
<li>He <strong>added detailed technological and scientific grounding</strong> to the concept, becoming intrigued by its potential.</li>
<li>This marked Feynman as the <strong>first to envision nanotechnology</strong>.</li>
</ul></li>
<li><strong>Feynman’s revolutionary insight</strong> led him to predict:
<ul>
<li>“In the year 2000, when they look back at this age, they will wonder why it was not until the year 1960 that anybody began seriously to move in this direction.”</li>
</ul></li>
<li><strong>Feynman’s prediction was premature.</strong>
<ul>
<li>Serious progress in nanotechnology didn’t begin until the 1990s.</li>
</ul></li>
<li>By 2000, <strong>atomic-scale electronic devices</strong> like <strong>molecular transistors</strong> existed, but <strong>complex circuits</strong> like nanocomputers were still 15 years away.</li>
<li>The missing element was the <strong>infrastructure</strong> that macroscopic technology relies on:
<ul>
<li><strong>Sorting and testing parts.</strong></li>
<li><strong>Cutting and joining materials.</strong></li>
<li><strong>Creating frameworks for devices.</strong></li>
<li><strong>Placing parts into frameworks.</strong></li>
</ul></li>
<li><strong>Feynman’s 1959 talk “There’s Plenty of Room at the Bottom” outlined a plan that could have achieved this infrastructure by 2000.</strong></li>
</ul>
</section>
<section id="feynmans-plan-top-down-approach" class="level3">
<h3 class="anchored" data-anchor-id="feynmans-plan-top-down-approach">Feynman’s Plan: Top-Down Approach</h3>
<ul>
<li><strong>Feynman’s talk proposed a “weird possibility” inspired by remote manipulators used in nuclear plants:</strong>
<ul>
<li>Build a <strong>master-slave system</strong> operating electrically.</li>
<li>Create <strong>precisely-made slave hands</strong> at one-quarter the scale of the master hands.</li>
<li>Use these smaller hands to manipulate <strong>quarter-sized tools and machines</strong>, including a <strong>quarter-size lathe</strong>.</li>
<li>Repeat the process to create <strong>even smaller hands and tools</strong>, at one-sixteenth scale.</li>
<li><strong>Connect the large-scale system to the smallest servo motors</strong> through transformers for control.</li>
</ul></li>
<li><strong>Feynman’s core idea</strong> was to <strong>transition from macro-scale to nano-scale fabrication</strong> while maintaining general fabrication and manipulation capabilities, mirroring Waldo’s approach in Heinlein’s story.</li>
<li>Feynman acknowledged the difficulty but emphasized the <strong>possibility</strong> of this approach.</li>
<li>He offered <strong>$1,000 prizes</strong> for a <strong>tiny motor</strong> and <strong>tiny writing</strong>, aiming to stimulate interest.
<ul>
<li>The prizes were won, but <strong>Feynman’s vision failed to gain widespread traction</strong>.</li>
</ul></li>
</ul>
</section>
<section id="drexlers-vision-bottom-up-approach" class="level3">
<h3 class="anchored" data-anchor-id="drexlers-vision-bottom-up-approach">Drexler’s Vision: Bottom-Up Approach</h3>
<ul>
<li>Around 1976, <strong>K. Eric Drexler</strong>, an MIT undergraduate, envisioned building with <strong>designed protein molecules and other biomolecules</strong>.
<ul>
<li>He observed the <strong>mechanical and electronic functions of cellular components</strong> and questioned if humans could replicate such processes.</li>
</ul></li>
<li>By 1981, Drexler published a paper in the <strong>Proceedings of the National Academy of the Sciences</strong>, sparking the formation of a <strong>nanotechnology study group</strong> at MIT.</li>
<li>In 1986, Drexler and his group published <strong>Engines of Creation</strong>, introducing <strong>nanotechnology</strong> to a broader audience.</li>
<li><strong>Drexler’s approach</strong> differed from Feynman’s:
<ul>
<li><strong>Feynman’s was top-down</strong>, starting with machines and scaling down to atoms.</li>
<li><strong>Drexler’s was bottom-up</strong>, starting with biochemistry and scaling up to machines.</li>
</ul></li>
<li>Both approaches ultimately aimed for <strong>molecular machines</strong>.
<ul>
<li>Feynman envisioned the physicist <strong>synthesizing anything</strong>.</li>
<li>Drexler described it as <strong>complete control of the structure of matter</strong>.</li>
</ul></li>
<li><strong>Interpreting these visions requires nuance.</strong>
<ul>
<li>Creating unstable atomic arrangements like exploding dynamite atom-by-atom is not feasible.</li>
</ul></li>
<li><strong>A reasonable interpretation</strong> focuses on <strong>rearranging existing atoms</strong>, exemplified by the hamburger analogy:
<ul>
<li>Eating a hamburger rearranges atoms without creating or destroying them.</li>
<li>A <strong>general synthesis capability</strong> would allow for transforming waste products back into the original hamburger.</li>
<li><strong>Current technology achieves this indirectly</strong> through agriculture and food processing.</li>
<li>A <strong>nanotechnological machine</strong> could achieve this directly at the molecular level.</li>
</ul></li>
<li><strong>DNA</strong> has limitations: it cannot describe every possible atomic arrangement, only the linear sequence of amino acids in proteins.
<ul>
<li>However, <strong>amino acids can form diverse molecular machinery</strong>, performing life’s essential functions.</li>
<li>This parallels limitations in macroscopic technology, where machinists can create components but not infinitely complex shapes.</li>
</ul></li>
<li><strong>Self-replication</strong> was an implicit concept in nanotechnology from the outset:
<ul>
<li>Heinlein explicitly mentioned “reduplicating”.</li>
<li>Feynman adopted this idea.</li>
<li>Drexler’s work stemmed from self-reproducing biological mechanisms.</li>
</ul></li>
<li><strong>Nanotechnology surpasses limitations of cellular biochemistry</strong>:
<ul>
<li>It can operate <strong>without water</strong>, across a <strong>wider temperature range</strong>, and at <strong>higher speeds and power levels</strong>.</li>
</ul></li>
</ul>
</section>
<section id="nanotechs-potential-incomprehensible-capabilities" class="level3">
<h3 class="anchored" data-anchor-id="nanotechs-potential-incomprehensible-capabilities">Nanotech’s Potential: Incomprehensible Capabilities</h3>
<ul>
<li><strong>Nanotechnology offers immense potential</strong> due to its ability to rearrange atoms.
<ul>
<li>The difference between <strong>charcoal and diamond, sand and computer chips, diseased and healthy tissue, and even life and death</strong> lies solely in atomic arrangement.</li>
</ul></li>
<li><strong>Drexler’s Engines of Creation</strong> paints a <strong>technophile’s dream</strong>:
<ul>
<li><strong>Microscopic replicating units</strong> building <strong>skyscraper-sized objects</strong> with atomic precision.</li>
<li><strong>Artificial intelligence</strong> and <strong>complex engineering systems</strong>.</li>
<li><strong>Easy space travel</strong> with <strong>lightweight spacesuits</strong>.</li>
<li><strong>Cell repair machines</strong> and the <strong>cure for aging</strong>.</li>
<li><strong>Cryonics</strong> and <strong>resurrection</strong>.</li>
</ul></li>
<li><strong>Drexler’s vision</strong> expanded significantly on <strong>Feynman’s initial ideas</strong>:
<ul>
<li>Feynman focused on <strong>data storage</strong> and <strong>chemical synthesis</strong>.</li>
<li>Drexler explored the <strong>broader implications</strong> of “making absolutely anything”.</li>
</ul></li>
<li><strong>Drexler’s projections</strong> were based on <strong>conservative engineering estimates</strong>.</li>
<li>Despite this, <strong>science fiction writers</strong> took the concept further, often with less scientific accuracy.
<ul>
<li>A 1989 Star Trek episode featured <strong>nanites evolving into an intelligent, coordinated species</strong> in a short timeframe, defying basic scientific principles.</li>
</ul></li>
<li><strong>Growing enthusiasm for nanotechnology</strong> led to increased hype and difficulty distinguishing serious research from fictionalized portrayals.</li>
<li>The <strong>technical world’s excitement</strong> was palpable:
<ul>
<li>The <strong>Usenet Nanotechnology Discussion Group (Sci.Nanotech)</strong>, founded in 1989, received overwhelming support.</li>
<li>The <strong>first Foresight Conference on Nanotechnology</strong> in 1989 evoked comparisons to the historic <strong>Solvay Conferences</strong>.</li>
</ul></li>
<li><strong>Drexler’s influence</strong> on nanotechnology’s development in the 1980s and 1990s was substantial, exceeding that of Feynman or Heinlein.</li>
</ul>
</section>
<section id="the-mightiest-machine-understanding-nanotechs-power" class="level3">
<h3 class="anchored" data-anchor-id="the-mightiest-machine-understanding-nanotechs-power">The Mightiest Machine: Understanding Nanotech’s Power</h3>
<ul>
<li>Grasping the <strong>raw power and potential of nanotechnology</strong> can be challenging.</li>
<li><strong>Drexler’s Nanosystems</strong> highlights the <strong>immense power density of nanomotors</strong>:
<ul>
<li><strong>Greater than 10^15 watts per cubic meter</strong>.</li>
<li>For comparison, Earth receives about 10^17 watts of solar radiation.</li>
<li><strong>Cooling limitations</strong> prevent sustained operation at this density.</li>
</ul></li>
<li><strong>This implies</strong>:
<ul>
<li>A <strong>1,000 horsepower (10^6 watts) engine</strong> could fit in a <strong>1 millimeter cube (10^-9 cubic meters)</strong>.</li>
<li>One cubic foot of nanomotors would require more power (10^13 watts) than all human machinery combined.</li>
<li>A <strong>Kardashev Type I civilization’s power needs (10^17 watts)</strong> could be met by nanomotors fitting in a 500-square-foot apartment.</li>
</ul></li>
<li><strong>The Jetsons’ world</strong> becomes more realistic than traditional futurism:
<ul>
<li><strong>Microscopic motors</strong> would be ubiquitous, seamlessly moving objects like biological muscles.</li>
</ul></li>
<li><strong>Miniaturization and speed</strong> are key advantages of nanotechnology:
<ul>
<li><strong>Smaller machines can operate faster</strong>, similar to the trend in electronics.</li>
<li><strong>Birds and insects</strong> demonstrate this principle with wing flapping speeds.</li>
</ul></li>
<li><strong>Factory throughput</strong> is crucial for productivity:
<ul>
<li>A factory processing materials at walking speed (5 feet per second) across a mile takes 20 minutes.</li>
<li><strong>Scaling down to cell size (microns)</strong> reduces processing time to <strong>microseconds</strong>.</li>
<li>This explains the <strong>vast difference in reproduction speeds</strong> between humans (20 years) and E. coli (20 minutes).</li>
</ul></li>
<li><strong>Reproduction speed impacts economic growth</strong>:
<ul>
<li>A factory with a 3% annual return on investment takes 33 years to recoup its cost.</li>
<li><strong>Reinventing profits</strong> accelerates growth through <strong>compound interest</strong>.</li>
<li><strong>Self-replicating factories</strong> dramatically change the equation.</li>
</ul></li>
<li><strong>Replacing the US capital stock with mature nanotechnology</strong>:
<ul>
<li>Estimated time: <strong>about a week</strong>, based on calculations by Robert Freitas and the author.</li>
</ul></li>
<li>This seemingly outlandish claim is supported by <strong>Nanosystems</strong> and <strong>molecular manufacturing research</strong>.</li>
<li><strong>Analogy with information technology</strong>:
<ul>
<li>The <strong>power and sophistication of modern computers</strong> would seem “fantastic, ludicrous, insane” to someone from the 1960s.</li>
<li>The <strong>IBM 7094</strong>, used by NASA, had 0.35 MIPS and cost $35 million in today’s dollars.</li>
<li>A <strong>$35 Raspberry Pi</strong> in 2015 had 9,700 MIPS.</li>
<li>The author’s workstation has 2,356,230 MIPS.</li>
</ul></li>
<li><strong>Similar exponential advancements are possible with matter and energy manipulation</strong> through nanotechnology.</li>
</ul>
</section>
<section id="from-bits-to-atoms-the-digital-revolution-in-matter" class="level3">
<h3 class="anchored" data-anchor-id="from-bits-to-atoms-the-digital-revolution-in-matter">From Bits to Atoms: The Digital Revolution in Matter</h3>
<ul>
<li><strong>Nanotech</strong> is a <strong>digital technology</strong>, distinct from <strong>nanotechnology</strong> (nanoscale surface and material science).</li>
<li><strong>Atomically precise machines</strong> that build more atomically precise machines create a <strong>digital matter escalator</strong>, analogous to digital information technology.</li>
<li><strong>Hardware becomes secondary to design</strong>:
<ul>
<li>In software, <strong>hardware advancements (Moore’s Law)</strong> outpaced software complexity.</li>
<li>In nanotech, <strong>physics (the abundance of atoms)</strong> is the substrate, and <strong>machine design (the software)</strong> is the bottleneck.</li>
</ul></li>
<li><strong>The challenge lies in designing self-constructing machines in digital matter</strong>.</li>
<li><strong>Rebuilding America physically in a week</strong> highlights the need for efficient design processes.</li>
<li><strong>Biotechnology</strong> is currently the only field manipulating matter digitally, following nature’s lead.</li>
<li>Within decades, we will create machines capable of <strong>making anything</strong>, similar to 3D printers but with atomic precision and diverse materials.</li>
<li><strong>Self-replicating nanofactories</strong> will accelerate this capability, potentially following a <strong>Moore’s Law-like trajectory</strong>.</li>
<li><strong>Moore’s Law</strong> represents a 60% growth rate.</li>
<li>A 40% growth rate in physical manufacturing is plausible with nanotech, considering real-world constraints.</li>
<li><strong>Comparing the iPhone to the IBM 1401</strong> demonstrates the potential for miniaturization, increased capability, and reduced cost in physical technology.</li>
<li><strong>Feynman’s 1959 vision</strong> could have led to a drastically different present.</li>
</ul>
</section>
<section id="the-unanswered-question-why-the-delay" class="level3">
<h3 class="anchored" data-anchor-id="the-unanswered-question-why-the-delay">The Unanswered Question: Why the Delay?</h3>
<ul>
<li>Decades after 2000, we still grapple with Feynman’s question: <strong>Why the delay in pursuing nanotechnology?</strong></li>
<li>The <strong>Overton window effect</strong> might explain the resistance to revolutionary ideas.
<ul>
<li><strong>Machiavelli’s observation</strong> on the <strong>incredulity of men</strong> facing new things resonates.</li>
</ul></li>
<li>Even Feynman’s stature couldn’t overcome this inertia.</li>
<li><strong>Discarding a technology with such immense potential (flying cars, immortality, peak health)</strong> qualifies as folly.</li>
<li><strong>Other factors</strong> might be at play, requiring further exploration.</li>
</ul>
</section>
<section id="the-2020-pandemic-a-case-study-in-lost-opportunities" class="level3">
<h3 class="anchored" data-anchor-id="the-2020-pandemic-a-case-study-in-lost-opportunities">The 2020 Pandemic: A Case Study in Lost Opportunities</h3>
<ul>
<li>The <strong>COVID-19 pandemic</strong> highlights the consequences of our technological stagnation.</li>
<li><strong>Rapid vaccine development</strong> (Moderna’s mRNA vaccine) showcased the potential of biotechnology.</li>
<li><strong>Bureaucratic delays and limited manufacturing capacity</strong> hindered vaccine distribution, contributing to a disastrous year.</li>
<li><strong>Nanofactories</strong> could have addressed the manufacturing bottleneck:
<ul>
<li><strong>mRNA vaccines are arrangements of atoms</strong> that nanofactories could readily produce.</li>
</ul></li>
<li><strong>Thought experiment</strong>:
<ul>
<li>Imagine nanofactory progress mirroring computer advancements since 1960.</li>
<li><strong>Personal nanofactories</strong>, potentially integrated into smartphones, could synthesize vaccine doses on demand.</li>
</ul></li>
<li><strong>Nanotechnology’s potential has been within reach for decades</strong>.</li>
<li>The question remains: <strong>Why have we failed to capitalize on it?</strong></li>
</ul>
</section>
</section>
<section id="chapter-5-cold-fusion" class="level2">
<h2 class="anchored" data-anchor-id="chapter-5-cold-fusion">Chapter 5: Cold Fusion</h2>
<section id="the-occurrence-of-the-impossible" class="level3">
<h3 class="anchored" data-anchor-id="the-occurrence-of-the-impossible">The Occurrence of the Impossible</h3>
<ul>
<li><strong>E.E. Doc Smith’s “The Skylark of Space”</strong> provides a fictional example of a scientist discovering a new energy source through electrolysis of an unknown metal (X).
<ul>
<li>The experiment results in a sudden release of energy, causing the apparatus to move violently.</li>
<li>This fictional account foreshadows some aspects of the cold fusion controversy.</li>
</ul></li>
</ul>
</section>
<section id="cold-fusion-at-the-university-of-utah" class="level3">
<h3 class="anchored" data-anchor-id="cold-fusion-at-the-university-of-utah">Cold Fusion at the University of Utah</h3>
<ul>
<li><strong>February 1985</strong>: Kevin Ashley, a graduate student, witnessed the aftermath of an experiment in the electrochemistry lab at the University of Utah.
<ul>
<li>The lab was in disarray, with dust in the air.</li>
<li>A hole was found in the lab bench and the concrete floor beneath it.</li>
<li><strong>Stanley Pons</strong> and <strong>Martin Fleischmann</strong> appeared surprised by the results.</li>
</ul></li>
<li><strong>Pons and Fleischmann’s Belief</strong>: They believed they achieved <strong>deuterium fusion</strong> within an electrochemical beaker.
<ul>
<li>They invested significant personal funds ($100,000, equivalent to $250,000 today) in further research.</li>
<li>Their hypothesis, if true, would have revolutionized energy production.</li>
</ul></li>
<li><strong>Reality Check</strong>: The energy release, if it were truly fusion, would have been lethal and caused widespread radiation.
<ul>
<li>Their experiments over the next four years yielded inconsistent results.
<ul>
<li>Massive heat releases were infrequent.</li>
<li>More often, nothing happened.</li>
<li>Occasional bursts of heat, sometimes exceeding the input energy by tenfold, were observed after prolonged deuterium loading of a palladium electrode.</li>
<li>These bursts were unpredictable in their onset and duration.</li>
</ul></li>
</ul></li>
<li><strong>Assessment of Pons and Fleischmann</strong>:
<ul>
<li>Both were experts in electrochemistry, making systematic measurement errors unlikely.</li>
<li><strong>Fleischmann</strong> was considered a leading figure in the field.</li>
</ul></li>
</ul>
</section>
<section id="the-cold-fusion-announcement-and-its-aftermath" class="level3">
<h3 class="anchored" data-anchor-id="the-cold-fusion-announcement-and-its-aftermath">The Cold Fusion Announcement and Its Aftermath</h3>
<ul>
<li><strong>1989</strong>: Events unfolded that led to a premature public announcement.
<ul>
<li>Pons and Fleischmann sought funding from the University of Utah.</li>
<li>The university was interested in potential patent rights.</li>
<li><strong>Steve Jones</strong>, a physicist at Brigham Young University, was working on <strong>muon-catalyzed fusion (MCF)</strong>.
<ul>
<li><strong>MCF</strong> is a known phenomenon in standard physics.</li>
<li>It involves the fusion of deuterium nuclei facilitated by muons (particles similar to electrons but heavier).</li>
<li><strong>MCF</strong> is not a practical energy source due to the energy cost of muon creation.</li>
</ul></li>
<li>The University of Utah, fearing loss of patent priority, pressured Pons and Fleischmann to announce their findings.</li>
</ul></li>
<li><strong>March 1989</strong>: A press conference was held, and a preliminary paper titled “Electrochemically Induced Nuclear Fusion of Deuterium” was published.
<ul>
<li>Fleischmann expressed reservations about this hasty approach, preferring to delay publication.</li>
</ul></li>
<li><strong>Media Frenzy and Scientific Controversy</strong>: The announcement sparked intense media attention and a strong reaction from the scientific community.
<ul>
<li>The author, then a researcher at Rutgers, recalls the excitement and skepticism surrounding the announcement.
<ul>
<li>Physicists at Princeton attempted to replicate the experiment with radiation shielding, highlighting the contrast in approaches.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="from-space-opera-to-soap-opera-the-machiavelli-effect" class="level3">
<h3 class="anchored" data-anchor-id="from-space-opera-to-soap-opera-the-machiavelli-effect">From Space Opera to Soap Opera: The Machiavelli Effect</h3>
<ul>
<li><strong>Parallels with “The Skylark of Space”</strong>:
<ul>
<li>Both the fictional X and palladium are rare platinum group metals.</li>
<li>Both involve energy release through electrolysis.</li>
<li>In the novel, the fictional scientist Seton faces disbelief, theft, assassination attempts, and the abduction of his fiancée.</li>
</ul></li>
<li><strong>The Machiavelli Effect in Science</strong>:
<ul>
<li><strong>Richard Feynman</strong> emphasized the importance of admitting ignorance and uncertainty for scientific progress.</li>
<li><strong>Niccolo Machiavelli</strong>, in “The Prince” (1532), described the challenges faced by innovators who threaten the established order.
<ul>
<li>Innovators face strong opposition from those who benefit from the status quo and lukewarm support from potential beneficiaries.</li>
<li>This resistance can endanger the innovator and their supporters.</li>
</ul></li>
</ul></li>
<li><strong>Evidence of the Machiavelli Effect in Cold Fusion</strong>:
<ul>
<li>Scientists with ties to <strong>hot fusion</strong> research were particularly critical of cold fusion.</li>
<li>The <strong>Department of Energy (DOE)</strong> formed a committee (<strong>ERAB</strong>) to investigate cold fusion in April 1989.
<ul>
<li>The committee leadership had strong connections to nuclear weapons research.</li>
<li>The report, while not entirely dismissive, was interpreted as such.</li>
<li><strong>John Huizenga</strong> wrote a book debunking cold fusion, leveraging his position as committee chairman.</li>
<li>The report acknowledged the impossibility of definitively proving or disproving all claims.</li>
<li>It listed 11 positive and 13 negative experiments for excess heat.</li>
<li>At least one credible positive result from NASA was overlooked.</li>
<li>A later positive result from the Naval Air Warfare Center was initially listed as negative.</li>
<li>The evidence for excess heat was arguably balanced, if not slightly favoring cold fusion.</li>
</ul></li>
</ul></li>
<li><strong>The Role of Politics and Funding</strong>:
<ul>
<li>The <strong>Superconducting Supercollider (SSC)</strong> project was competing for funding at the time.</li>
<li>Cold fusion posed a potential threat to the SSC’s funding and the prestige of high-energy physics.</li>
<li>The <strong>Machiavelli effect</strong> explains the biased reaction, as the scientific establishment sought to protect its interests.</li>
</ul></li>
<li><strong>Examples of Bias</strong>:
<ul>
<li><strong>MIT’s Plasma Science and Fusion Center</strong> reported no excess heat, but their experimental setup was flawed.
<ul>
<li><strong>Peter Hagelstein</strong> pointed out the significantly higher measurement errors in the MIT experiments compared to Fleischmann and Pons’s work.</li>
</ul></li>
<li>The emotional and dismissive language used by some scientists against cold fusion proponents further suggests bias.</li>
</ul></li>
<li><strong>The Impact of the ERAB Report</strong>:
<ul>
<li>By November 1989, the scientific community largely dismissed cold fusion.</li>
<li>Fleischmann and Pons’s detailed paper was published only then, making proper replication attempts possible.</li>
<li>The <strong>Machiavelli effect</strong> was in full force, hindering further research.</li>
</ul></li>
<li><strong>Continued Suppression of Research</strong>:
<ul>
<li>Hagelstein’s experience with a company interested in funding cold fusion research demonstrates ongoing resistance.
<ul>
<li>A prominent physicist at MIT intervened, canceling the program and jeopardizing the careers of researchers involved.</li>
</ul></li>
</ul></li>
<li><strong>Implications of the Machiavelli Effect</strong>:
<ul>
<li>The attacks on cold fusion may not have been solely based on scientific merit.</li>
<li>There is a high prior probability of bias due to the political and financial stakes.</li>
</ul></li>
<li><strong>Challenges in Cold Fusion Research</strong>:
<ul>
<li>The field is plagued by unreliable claims from less credible sources.</li>
<li>Replication is difficult, increasing the risk of self-deception among researchers.</li>
<li>Cold fusion is often associated with pseudoscience and fringe ideas, further damaging its reputation.</li>
<li>The constant barrage of unsubstantiated claims makes it difficult for scientists to differentiate potentially valid research.</li>
</ul></li>
<li><strong>The Importance of Exploring the Impossible</strong>:
<ul>
<li><strong>Arthur C. Clarke</strong>: “The only way of discovering the limits of the possible is to venture a little way past them into the impossible.”</li>
<li>Many scientific and technological advancements resulted from challenging established limits.</li>
</ul></li>
</ul>
</section>
<section id="aftermath-and-current-status" class="level3">
<h3 class="anchored" data-anchor-id="aftermath-and-current-status">Aftermath and Current Status</h3>
<ul>
<li><strong>Lessons Learned</strong>:
<ul>
<li>Fleischmann and Pons’s focus on fusion products, an area outside their expertise, made them vulnerable to criticism.</li>
<li>They should have emphasized the observed heat amplification instead.</li>
</ul></li>
<li><strong>The National Cold Fusion Institute</strong>:
<ul>
<li>Founded at the University of Utah with $4.5 million in funding.</li>
<li>Failed to produce significant results and closed within a year.</li>
<li>Legal disputes surrounding the institute cost five times more than the research itself.</li>
</ul></li>
<li><strong>Further Research Efforts</strong>:
<ul>
<li>Toyota invested $40 million in Fleischmann and Pons’s research at IMRA Europe, with limited success.</li>
<li>Japan’s MITI spent $20 million, also with no breakthroughs.</li>
<li>These efforts did lead to a gradual improvement in producing the effect, but reliability remained elusive.</li>
</ul></li>
<li><strong>Difficulties in Replication</strong>:
<ul>
<li><strong>Richard Oriani</strong> described cold fusion experiments as the most challenging of his career.</li>
<li>Replication remains extremely difficult, requiring specific conditions and materials.</li>
</ul></li>
<li><strong>Progress in Understanding</strong>:
<ul>
<li><strong>Michael McKubre</strong>’s research at SRI International showed that a deuterium loading ratio of at least 90% in palladium is crucial.</li>
<li>The quality of palladium samples is also a significant factor.</li>
<li><strong>Dennis Cravens</strong> and <strong>Edmund Storms</strong> found that only a small percentage of palladium samples are effective.</li>
</ul></li>
<li><strong>Department of Energy Review (2004)</strong>:
<ul>
<li>Another ERAB review was conducted, resulting in a non-committal report.</li>
<li>An analysis of reviewers’ comments suggests a slight lean towards the possibility of excess heat and nuclear phenomena, but not strong support.</li>
</ul></li>
<li><strong>Ongoing Research</strong>:
<ul>
<li>Despite limited funding and skepticism, research continues at NASA, the Navy, and DARPA.</li>
</ul></li>
<li><strong>The Significance of Cold Fusion</strong>:
<ul>
<li>Cold fusion, even if not a guaranteed energy solution, highlights potential gaps in our understanding of physics.</li>
<li>The suppression of research exemplifies the <strong>Machiavelli effect</strong>, hindering scientific progress in various fields.</li>
</ul></li>
<li><strong>Conclusion</strong>:
<ul>
<li>Due to the <strong>Machiavelli effect</strong>, the viability of cold fusion as an energy source remains uncertain.</li>
<li>The controversy has cast a shadow on the openness and objectivity of the scientific establishment.</li>
<li>Many promising avenues of research may be suppressed due to similar biases</li>
</ul></li>
</ul>
</section>
</section>
<section id="chapter-6-the-machiavelli-effect" class="level2">
<h2 class="anchored" data-anchor-id="chapter-6-the-machiavelli-effect">Chapter 6: The Machiavelli Effect</h2>
<section id="introduction-rewriting-history-rethinking-cold-fusion" class="level3">
<h3 class="anchored" data-anchor-id="introduction-rewriting-history-rethinking-cold-fusion">Introduction: Rewriting History &amp; Rethinking Cold Fusion</h3>
<ul>
<li><strong>Thomas Kuhn</strong>, in “The Structure of Scientific Revolutions,” argues that members of mature scientific communities are victims of history rewritten by those in power.
<ul>
<li>Similar to characters in Orwell’s “1984.”</li>
</ul></li>
<li>By 1989, the consensus was that <strong>cold fusion</strong> was a mistake due to misinterpretations and poor lab techniques.</li>
<li>The author initially accepted this consensus.</li>
<li>Decades later, after encountering the <strong>Machiavelli Effect</strong> in <strong>nanotechnology</strong>, the author reconsidered cold fusion.</li>
</ul>
</section>
<section id="the-machiavelli-effect-in-nanotechnology" class="level3">
<h3 class="anchored" data-anchor-id="the-machiavelli-effect-in-nanotechnology">The Machiavelli Effect in Nanotechnology</h3>
<ul>
<li>The resistance to innovation in nanotechnology was less intense than in cold fusion.</li>
<li><strong>Nanotechnology</strong> gained prominence in the 1990s.
<ul>
<li><strong>Eric Drexler</strong>’s 1991 MIT dissertation, the first explicitly on nanotechnology, provided a theoretical basis for its manufacturing capabilities.</li>
<li>Republished as “Nanosystems” in 1992, it became a bestseller.</li>
<li>The Foresight Institute’s nanotechnology conferences grew, attracting top researchers.</li>
<li><strong>Richard Feynman</strong>’s “Plenty of Room” (1960) gained recognition in the late 1990s.</li>
<li>In 1997, Nobel laureate <strong>Richard Smalley</strong> (discoverer of C60) was the Foresight Institute’s keynote speaker.</li>
</ul></li>
<li>By 2000, nanotechnology gained political attention.
<ul>
<li>President Clinton proposed a <strong>National Nanotechnology Initiative (NNI)</strong>, citing Feynman’s work.</li>
</ul></li>
</ul>
</section>
<section id="machiavellis-two-classes-the-nni" class="level3">
<h3 class="anchored" data-anchor-id="machiavellis-two-classes-the-nni">Machiavelli’s Two Classes &amp; The NNI</h3>
<ul>
<li><strong>Machiavelli</strong> identified two classes:
<ol type="1">
<li><strong>Nobles:</strong> Those who benefit from the status quo and have the laws on their side. They tend to be politically and economically powerful.</li>
<li><strong>Tradesmen:</strong> Those who would benefit from innovation but fear the risks associated with challenging the nobles.</li>
</ol></li>
<li>The NNI did not introduce new funding but redistributed existing funds, creating a Machiavelli Effect scenario.
<ul>
<li><strong>Nobles:</strong> Established researchers in related fields (e.g., surface and materials science).</li>
<li><strong>Tradesmen:</strong> Researchers who could potentially work on true nanotech but were working in other areas or were still students.</li>
</ul></li>
<li><strong>The Nobles’ Reaction:</strong>
<ul>
<li>Labeled their existing work as nanotechnology.</li>
<li>Attacked Drexler’s (and implicitly Feynman’s) vision.</li>
</ul></li>
<li><strong>The Tradesmen’s Response:</strong>
<ul>
<li>Hesitated to embrace the new field due to its perceived difficulty and the risk of attacks from established researchers.</li>
</ul></li>
<li><strong>Consequences:</strong>
<ul>
<li>Innovation slowed down.</li>
<li>This dynamic is common in zero-sum science and technology funding environments.</li>
</ul></li>
</ul>
</section>
<section id="the-machiavelli-effect-as-a-systemic-immune-response" class="level3">
<h3 class="anchored" data-anchor-id="the-machiavelli-effect-as-a-systemic-immune-response">The Machiavelli Effect as a Systemic Immune Response</h3>
<ul>
<li>The Machiavelli Effect is not a conspiracy but a natural human response to protect one’s interests.</li>
<li>It’s akin to a <strong>social and economic system’s immune response</strong>.</li>
<li>It’s a part of <strong>normal science</strong> as described by Thomas Kuhn.</li>
<li><strong>Isaac Asimov</strong> observed similar resistance to technological change throughout history:
<ul>
<li><blockquote class="blockquote">
<p>“I discovered, to my amazement, that all through history there had been resistance, and bitter, exaggerated, last-ditch resistance, to every significant technological change that had taken place on Earth. Usually, the resistance came from those groups who stood to lose influence, status, money as a result of the change. Although they never advanced this as their reason for resisting it, it was always the good of humanity that rested upon their hearts.”</p>
</blockquote></li>
</ul></li>
<li>By the early 2000s, the NNI led to a full-fledged Machiavelli Effect in nanotechnology.
<ul>
<li>Researchers working on molecular machines faced funding difficulties due to partisan attacks.</li>
<li>A productive nanotech program at NASA Ames was canceled.</li>
<li>Foresight Institute experienced difficulty attracting researchers who had previously presented work.</li>
</ul></li>
<li>The attacks lacked intellectual substance.
<ul>
<li>Smalley, a prominent attacker, contradicted himself on the feasibility of molecular self-replication.</li>
</ul></li>
<li>Machiavelli’s prediction of the 20th-century behavior of nanoscience leaders does not invalidate nanotechnology itself.</li>
<li>It highlights the possibility of partisan influence in attacks on new ideas.</li>
<li>In Bayesian terms, the prior probability of such attacks was high regardless of the validity of Drexler’s or Feynman’s vision.</li>
</ul>
</section>
<section id="the-machiavelli-effect-beyond-physical-science" class="level3">
<h3 class="anchored" data-anchor-id="the-machiavelli-effect-beyond-physical-science">The Machiavelli Effect Beyond Physical Science</h3>
<ul>
<li>The Machiavelli Effect is not limited to physical sciences and engineering.</li>
<li>It’s arguably less prevalent in these fields compared to others.</li>
<li><strong>George Miller</strong> (cognitive psychologist) described the difficulty of challenging behaviorism’s dominance in psychology:
<ul>
<li><blockquote class="blockquote">
<p>“The power, the honors, the authority, the textbooks, the money, everything in psychology was owned by the behavioristic school. Those of us who wanted to be scientific psychologists couldn’t really oppose it. You just wouldn’t get a job.”</p>
</blockquote></li>
</ul></li>
<li>Distinguishing between the Machiavelli Effect and legitimate criticism of flawed ideas can be challenging.</li>
<li><strong>Textbook knowledge</strong> is generally “probably approximately correct.”</li>
<li>But in some cases (e.g., flying machines), expert consensus has been wrong.</li>
<li>The bureaucratic resistance to innovators can be detrimental to scientific progress.</li>
</ul>
</section>
<section id="the-wright-brothers-the-smithsonian" class="level3">
<h3 class="anchored" data-anchor-id="the-wright-brothers-the-smithsonian">The Wright Brothers &amp; The Smithsonian</h3>
<ul>
<li>In 1910, the Wright brothers offered their <strong>Wright Flyer</strong> (the first successful heavier-than-air flying machine) to the Smithsonian.</li>
<li>Their offer was rejected.</li>
<li>The Flyer was eventually donated to the Science Museum in London (until 1948).</li>
<li>Meanwhile, the Smithsonian exhibited <strong>Samuel Langley</strong>’s <strong>Aerodrome</strong> as the first flying machine.
<ul>
<li>Langley, a former Smithsonian director, had received significant government funding for his failed attempts at flight.</li>
<li>In 1914, the Smithsonian lent the Aerodrome to <strong>Glenn Curtiss</strong>, who modified and successfully flew it.</li>
<li>Curtiss was a competitor of the Wrights and sought to invalidate their airplane patent.</li>
</ul></li>
<li><strong>Funding Disparity:</strong>
<ul>
<li>The Wrights spent about $1,000 of their own money to build the Flyer.</li>
<li>Langley received over $50,000 in government funding for his unsuccessful Aerodrome.</li>
</ul></li>
<li>This story highlights the often-overlooked human side of scientific history.</li>
</ul>
</section>
<section id="the-public-good-of-basic-research-funding-trends" class="level3">
<h3 class="anchored" data-anchor-id="the-public-good-of-basic-research-funding-trends">The Public Good of Basic Research &amp; Funding Trends</h3>
<ul>
<li>Scientists generally believe that <strong>basic research</strong> is a <strong>public good</strong>, providing broad benefits that outweigh its costs.
<ul>
<li>Its benefits are so widespread that no individual has a private incentive to fund it.</li>
</ul></li>
<li>The author initially shared this belief and conducted federally funded research.</li>
<li>Research funding trends fluctuate (e.g., the <strong>AI winter</strong> in the 1980s).</li>
<li>The author initially assumed funding agencies simply misunderstood the potential of certain fields.</li>
<li>The nanotechnology experience changed the author’s perspective.</li>
<li>The deliberate distortion of nanotech’s core concept (as envisioned by Heinlein, Feynman, and Drexler) raised doubts about the top-down funding process’s ability to advance science, technology, and society.</li>
<li><strong>Government Funding and Innovation:</strong>
<ul>
<li>The $50,000 Langley received for the Aerodrome was exceptional before 1940.</li>
<li>The <strong>Manhattan Project</strong> (billions of dollars, massive industrial effort, successful outcome) changed perceptions about government-funded research.</li>
<li>Its success and the subsequent advancements in aircraft and missile research convinced many that federal funding could accelerate scientific progress and economic growth.</li>
<li>Defense research funding became entrenched.</li>
<li>Non-defense research spending increased in the 1960s, primarily for the space program.</li>
</ul></li>
<li><strong>Private Sector Innovation:</strong>
<ul>
<li>Major quality-of-life improvements before 1960 (refrigerators, freezers, vacuum cleaners, stoves, washing machines, indoor plumbing, detergents, electric lights, cars, trucks, tractors, fertilizer, air travel, containerized freight, vacuum tubes, transistors, telegraph, telephone, phonograph, movies, radio, television) were primarily developed privately.</li>
</ul></li>
</ul>
</section>
<section id="public-rd-and-economic-growth" class="level3">
<h3 class="anchored" data-anchor-id="public-rd-and-economic-growth">Public R&amp;D and Economic Growth</h3>
<ul>
<li>The belief that increased federal funding for scientific research would boost economic growth became widespread.</li>
<li><strong>Evidence Against This Belief:</strong>
<ul>
<li>England, where the Industrial Revolution began, had minimal public research support in the 19th century.</li>
<li>France and Germany, with strong public scientific enterprises, did not experience comparable economic growth.</li>
<li>The US, with a laissez-faire approach, surpassed Britain’s GDP per capita.</li>
<li>Public R&amp;D funding coincided with the <strong>Great Stagnation</strong>, a period of slowed technological innovation.</li>
</ul></li>
<li><strong>OECD Study (2005):</strong>
<ul>
<li>Found a positive correlation (0.26) between private R&amp;D and economic growth.</li>
<li>Found a negative correlation (-0.37) between government-funded R&amp;D and economic growth.</li>
<li>Authors suggested that public R&amp;D might <strong>crowd out</strong> private sector resources, including private R&amp;D.</li>
</ul></li>
<li><strong>Crowding Out vs.&nbsp;The Machiavelli Effect:</strong>
<ul>
<li>Some economists (e.g., Terence Keeley) favor the crowding-out explanation.</li>
<li>The author argues that the Machiavelli Effect also plays a significant role.</li>
<li>Centralized funding empowers established groups who resist new ideas.</li>
</ul></li>
</ul>
</section>
<section id="the-inventors-of-tomorrow-ivory-tower-syndrome" class="level3">
<h3 class="anchored" data-anchor-id="the-inventors-of-tomorrow-ivory-tower-syndrome">The Inventors of Tomorrow &amp; Ivory Tower Syndrome</h3>
<ul>
<li><strong>A Nation at Risk (1983):</strong>
<ul>
<li><blockquote class="blockquote">
<p>“Our nation is at risk. Our once unchallenged preeminence in commerce, industry, science, and technological innovation is being overtaken by competitors throughout the world. The educational foundations of our society are presently being eroded by a rising tide of mediocrity that threatens our very future as a nation and a people.” - National Commission on Excellence in Education</p>
</blockquote></li>
</ul></li>
<li><strong>Samuel Broder</strong> (Director of the National Cancer Institute):
<ul>
<li><blockquote class="blockquote">
<p>“If it had been up to the NIH to cure polio, we’d have the best iron lungs in the world, but we still wouldn’t have the Salk vaccine.”</p>
</blockquote></li>
</ul></li>
<li><strong>Tyler Cowen’s “The Great Stagnation” Hypothesis:</strong>
<ul>
<li>Proposes that the US ran out of talented young people leaving farms for universities in the 1970s.</li>
<li>This trend did slow down as the agricultural workforce diminished.</li>
</ul></li>
<li><strong>Counterarguments to Cowen’s Hypothesis:</strong>
<ul>
<li>The decline in manufacturing jobs continued well into the 2000s, freeing up workers for other sectors.</li>
<li>The US consistently produces more manufactured goods with fewer workers.</li>
<li>There is significant potential for increased production (e.g., flying cars) if desired.</li>
<li>The <strong>feminist revolution</strong> doubled the pool of educated young people.</li>
<li>Women’s participation in higher education increased significantly (e.g., PhDs awarded to women).</li>
<li>PhDs awarded per year increased dramatically compared to the 1950s and early 20th century.</li>
</ul></li>
<li><strong>Ivory Tower Syndrome Hypothesis:</strong>
<ul>
<li>Suggests that excessive education might hinder the economy and technological innovation.</li>
<li>Too many young people are in academia instead of pursuing real-world endeavors.</li>
</ul></li>
<li><strong>Kevin Jones’s Critique of Cowen:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“But there’s a tension here that Tyler doesn’t address. Technology grew like gangbusters in the first half of the 20th century, but it wasn’t until the second half that education took off. So, apparently, it’s not higher education that’s really responsible for dramatic technological growth. But if that’s the case, who cares about education?”</p>
</blockquote></li>
</ul></li>
<li>The correlation between the surge in PhDs and the Great Stagnation supports the ivory tower syndrome hypothesis.</li>
<li><strong>Daniel Dennett’s Analogy:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“The juvenile sea squirt wanders through the sea, searching for a suitable rock or hunk of coral to cling to and make its home for life. For this task, it has a rudimentary nervous system. When it finds its spot and takes root, it doesn’t need its brain anymore, so it eats it. It’s rather like getting tenure.”</p>
</blockquote></li>
</ul></li>
</ul>
</section>
<section id="academia-vs.-real-world-innovation" class="level3">
<h3 class="anchored" data-anchor-id="academia-vs.-real-world-innovation">Academia vs.&nbsp;Real-World Innovation</h3>
<ul>
<li><strong>DARPA Grand Challenge (2005):</strong>
<ul>
<li>Five autonomous vehicles successfully completed a 131.2-mile course, a significant improvement over the previous challenge.</li>
</ul></li>
<li><strong>An AAAI Researcher’s Perspective:</strong>
<ul>
<li>Dismissed the achievement as merely combining existing techniques, highlighting an academic bias towards novel intellectual concepts over practical solutions.</li>
</ul></li>
<li><strong>Real-World Innovation:</strong>
<ul>
<li>Often involves combining existing technologies to achieve previously impossible outcomes.</li>
<li>The Grand Challenge demonstrated the difference between working and not working in the real world.</li>
</ul></li>
<li><strong>Academia’s Focus:</strong>
<ul>
<li>Favors “mind candy” - intellectually stimulating ideas that impress other academics - over mundane but functional techniques.</li>
</ul></li>
<li><strong>The Importance of Practical Results:</strong>
<ul>
<li>While specialists might recognize the building blocks of a new invention, the world cares about whether it works.</li>
<li>The Grand Challenge marked a major milestone in self-driving car technology, despite lacking groundbreaking academic novelty.</li>
</ul></li>
</ul>
</section>
<section id="failure-of-foresight-failures-of-nerve-and-imagination" class="level3">
<h3 class="anchored" data-anchor-id="failure-of-foresight-failures-of-nerve-and-imagination">Failure of Foresight: Failures of Nerve and Imagination</h3>
<ul>
<li><strong>Arthur C. Clarke</strong> (“Profiles of the Future”) identified two types of failure in technological forecasting:
<ol type="1">
<li><strong>Failure of Nerve:</strong> Occurs when the science and engineering are understood, but the predicted outcome is too unconventional.
<ul>
<li>Example: The scientific community’s denial of heavier-than-air flight (even after the Wright brothers’ success).</li>
<li><strong>Simon Newcomb</strong>’s argument against airplanes (falling out of the sky when they stopped) exemplifies a failure of nerve.</li>
<li>He failed to consider the possibility of runways for takeoff and landing.</li>
<li><strong>Arthur C. Clarke</strong> encountered similar resistance in the field of rocketry.</li>
<li><strong>New York Times Editorial (1920):</strong>
<ul>
<li><blockquote class="blockquote">
<p>“That Professor Goddard, with his chair in Clark College and the countenancing of the Smithsonian Institution, does not know the relation of action and reaction, and of the need to have something better than a vacuum against which to react, to say that would be absurd. Of course, he only seems to lack the knowledge ladled out daily in high schools.”</p>
</blockquote></li>
</ul></li>
<li>The editorial displays arrogance and ignorance.</li>
<li>It illustrates the potential for influential figures to stifle innovation through biased funding decisions.</li>
<li>The Times retracted the claim in 1969 during the Apollo 11 mission:
<ul>
<li><blockquote class="blockquote">
<p>“Further investigation and experimentation have confirmed the findings of Isaac Newton in the 17th century, and it is now definitely established that a rocket can function in a vacuum as well as in an atmosphere. The Times regrets the error.”</p>
</blockquote></li>
</ul></li>
<li><strong>Nanotechnology as a Modern Example:</strong>
<ul>
<li>Standard physics, chemistry, and quantum mechanics predict the feasibility of atomically precise machines.</li>
<li>The failure of nerve is essentially thinking within limitations that do not actually exist.</li>
<li><strong>Feynman</strong>’s breakthrough was recognizing the potential of manipulating matter at the atomic level.</li>
<li><strong>Drexler</strong> further weakened the resistance by drawing parallels with molecular machines in cells.</li>
</ul></li>
</ul></li>
<li><strong>Failure of Imagination:</strong> Occurs when the knowledge required to make accurate predictions is simply unavailable.
<ul>
<li>Example: <strong>Ernest Rutherford</strong>’s dismissal of atomic energy:
<ul>
<li><blockquote class="blockquote">
<p>“The energy produced by the breaking down of the atom is a very poor kind of thing. Anyone who expects a source of power from transformation of these atoms is talking moonshine.”</p>
</blockquote></li>
</ul></li>
<li>Rutherford, a leading nuclear physicist, was unaware of the neutron and nuclear fission, concepts that were unknown at the time.</li>
<li>Failures of imagination are difficult to identify except in hindsight.</li>
<li>It’s essential to acknowledge the existence of unknown unknowns.</li>
<li>Technological progress often involves venturing beyond the known.</li>
<li><strong>Crystal Radio Example:</strong>
<ul>
<li>Someone familiar with crystal radios might have envisioned the transistor, not through knowledge of quantum mechanics, but by recognizing the possibility of undiscovered solid-state phenomena.</li>
</ul></li>
</ul></li>
</ol></li>
</ul>
</section>
<section id="the-consequences-of-centralization" class="level3">
<h3 class="anchored" data-anchor-id="the-consequences-of-centralization">The Consequences of Centralization</h3>
<ul>
<li><p>The increasing centralization and bureaucratization of science and research funding in the late 20th century had negative consequences.</p></li>
<li><p>It amplified the impact of failures of nerve and imagination, turning them into self-fulfilling prophecies.</p></li>
<li><p><strong>Shift in Focus:</strong></p>
<ul>
<li>A century ago, talented individuals faced real-world challenges, leading to innovative solutions.</li>
<li>Today, many of their successors are trapped in academia, focused on securing funding rather than addressing practical problems.</li>
</ul></li>
<li><p><strong>Eisenhower’s Warning (1961):</strong></p>
<ul>
<li><blockquote class="blockquote">
<p>“The free university, historically the fountainhead of free ideas and scientific discovery, has experienced a revolution in the conduct of research. Partly because of the huge costs involved, a government contract becomes virtually a substitute for intellectual curiosity. The prospect of domination of the nation’s scholars by federal employment, project allocations, and the power of money is ever-present and is gravely to be regarded.”</p>
</blockquote></li>
</ul></li>
<li><p><strong>Scientific Knowledge Explosion vs.&nbsp;Application:</strong></p>
<ul>
<li>The amount of scientific knowledge has grown exponentially in recent decades.</li>
<li>Ivory tower syndrome may contribute to this growth but hinder practical applications.</li>
</ul></li>
</ul>
</section>
<section id="the-french-scientific-boom-and-the-british-industrial-revolution" class="level3">
<h3 class="anchored" data-anchor-id="the-french-scientific-boom-and-the-british-industrial-revolution">The French Scientific Boom and the British Industrial Revolution</h3>
<ul>
<li><strong>France in the Early 19th Century:</strong>
<ul>
<li>Experienced a remarkable surge in scientific talent (e.g., Carnot, Lavoisier, Laplace, Montgolfier, Doulon, Petit, Pion, Freynell, Gay-Lussac, Ampère, Saval, Fourier, Corioli, Cauchy, Lamarck).</li>
<li>Science and technology advancement was a national priority.</li>
<li>The École Polytechnique was a leading institution, unmatched in England or elsewhere.</li>
</ul></li>
<li><strong>The Industrial Revolution:</strong>
<ul>
<li>Despite France’s scientific prowess, the Industrial Revolution occurred in Britain.</li>
<li>By 1850, Britain led in railroads, steamships, engines, machine tools, and textiles.</li>
</ul></li>
</ul>
</section>
<section id="ivory-tower-syndrome-in-the-united-states" class="level3">
<h3 class="anchored" data-anchor-id="ivory-tower-syndrome-in-the-united-states">Ivory Tower Syndrome in the United States</h3>
<ul>
<li>The US is a global leader in science and technology.</li>
<li>It boasts numerous top-tier research universities and substantial public research funding.</li>
<li><strong>Ivory tower syndrome is evident:</strong>
<ul>
<li>The Great Stagnation demonstrates a decline in transformative innovation.</li>
<li>The focus on academic pursuits may be hindering practical applications of knowledge.</li>
</ul></li>
<li><strong>Conclusion:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“The trees of knowledge are growing taller than ever. But someone appears to have been spraying paraquat on the low-hanging fruit.”</p>
</blockquote></li>
<li>While scientific knowledge expands, the development of impactful, real-world innovations has slowed down.</li>
</ul></li>
</ul>
</section>
</section>
<section id="chapter-7-the-age-of-aquarius" class="level2">
<h2 class="anchored" data-anchor-id="chapter-7-the-age-of-aquarius">Chapter 7: The Age of Aquarius</h2>
<section id="the-shift-from-science-to-emotionalism" class="level3">
<h3 class="anchored" data-anchor-id="the-shift-from-science-to-emotionalism">The Shift from Science to Emotionalism</h3>
<ul>
<li><strong>The 17th-century Scientific Revolution:</strong> Isaac Newton’s discoveries in motion, gravitation, and calculus built upon the work of previous scientists, marking a shift in understanding the universe from anthropomorphic gods to logic, mathematics, observation, and experiment.</li>
<li><strong>The Beauty and Value of Science:</strong> Science builds upon itself, incorporating insights from previous generations, unlike other forms of knowledge.
<ul>
<li>Example: Ptolemy’s epicycles predicted planetary positions, while Newton’s celestial mechanics allowed for the discovery of Neptune based on observations of Uranus.</li>
</ul></li>
<li><strong>Scientific and Technological Progress until the 1960s:</strong> Knowledge and capabilities continued to grow, culminating in the moon landing, driven by celestial mechanics and Newton’s third law.</li>
<li><strong>The Age of Aquarius and the Decline of Science:</strong> The 1960s saw a cultural shift away from scientific reasoning towards emotionalism, symbolized by the “Age of Aquarius.”
<ul>
<li>Example: The movie “Flash Gordon” (1974) mirrored the cultural atmosphere of the 1970s, emphasizing sexual liberation and a departure from traditional values.</li>
</ul></li>
</ul>
</section>
<section id="h.g.-wells-prediction-of-societal-decline" class="level3">
<h3 class="anchored" data-anchor-id="h.g.-wells-prediction-of-societal-decline">H.G. Wells’ Prediction of Societal Decline</h3>
<ul>
<li><strong>H.G. Wells’ “The Time Machine” (1895) Foreshadowed the Cultural Shift:</strong> Wells described a future society, the Eloi, characterized by a decline in strength, intelligence, and vigor due to a life of ease and security.
<ul>
<li><strong>Strength as a Consequence of Need:</strong> Wells argued that hardship and freedom fostered strength, intelligence, and cooperation, while security led to feebleness.</li>
<li><strong>The Fate of Energy in Security:</strong> Wells suggested that in a secure society, energy is diverted towards art and eroticism, eventually leading to languor and decay.</li>
</ul></li>
<li><strong>Wells’ Predictions about the Sexual Revolution and Family Breakdown:</strong> Wells anticipated the shift away from traditional family structures and the embrace of sexual liberation.</li>
<li><strong>The Rapid Pace of Societal Transformation:</strong> The cultural changes Wells predicted occurred within a century, much faster than the 8,000 centuries he envisioned.</li>
</ul>
</section>
<section id="the-cultural-transformation-of-the-1960s-and-70s" class="level3">
<h3 class="anchored" data-anchor-id="the-cultural-transformation-of-the-1960s-and-70s">The Cultural Transformation of the 1960s and 70s</h3>
<ul>
<li><strong>The 1960s as a Cultural Phase Change:</strong> Western culture, particularly in America, underwent a significant transformation in the 1960s and 70s.
<ul>
<li><strong>Examples of Cultural Movements:</strong> Hippies, Woodstock, environmentalism, Earth Day, free love, zero population growth, civil rights, passivism, and feminism.</li>
<li><strong>Similarities to the Bloomsbury Set:</strong> The 1960s counterculture echoed sentiments of the earlier Bloomsbury Group in London, but on a much larger scale.</li>
</ul></li>
<li><strong>The Mimetic Cambrian Explosion of the 1960s:</strong> The simultaneous emergence of various social and cultural revolutions can be seen as a mimetic Cambrian explosion.
<ul>
<li><strong>Preexisting Concerns:</strong> Many of the issues championed by the counterculture had existed before the 1960s (e.g., slavery, women’s suffrage, free love, conservationism).</li>
</ul></li>
<li><strong>The Question of Simultaneous Revolutions:</strong> The key question is why all these movements converged and intensified in the 1960s.
<ul>
<li><strong>Analogy of Flowers in the Desert:</strong> The widespread emergence of social movements suggests a common underlying cause, like rain in a desert causing widespread blooming.</li>
</ul></li>
</ul>
</section>
<section id="maslows-hierarchy-of-needs-and-the-cultural-shift" class="level3">
<h3 class="anchored" data-anchor-id="maslows-hierarchy-of-needs-and-the-cultural-shift">Maslow’s Hierarchy of Needs and the Cultural Shift</h3>
<ul>
<li><strong>Maslow’s Hierarchy of Needs as an Explanation:</strong> Abraham Maslow’s hierarchy of needs can help explain the cultural shift of the 1960s.
<ul>
<li><strong>Hierarchy Levels:</strong>
<ul>
<li>Basic needs: Physical safety, food, clothing, shelter.</li>
<li>Social needs: Friendship, status.</li>
<li>Higher needs: Spiritual fulfillment, self-actualization.</li>
</ul></li>
<li><strong>Motivation and Hierarchy:</strong> Individuals are motivated by the lowest unmet need in the hierarchy.</li>
</ul></li>
<li><strong>Western Culture’s Fulfillment of Lower-Level Needs:</strong> By the 1960s, Western culture had largely fulfilled the basic needs of its citizens, allowing them to focus on higher-level needs.</li>
<li><strong>The Modern Elite and Higher-Level Needs:</strong> The “modern elite” could take basic needs for granted and focus on love, esteem, self-actualization, etc.</li>
<li><strong>Emancipation of Women and Technological Advancements:</strong> Labor-saving machines of the 20th century freed women from some domestic drudgery, allowing them to pursue other interests.
<ul>
<li>Example: The character of Stella in “The Jetsons” (1962) represented this shift, although it was still emerging at the time.</li>
</ul></li>
<li><strong>Rising Productivity and the “Good Life”:</strong> Increased productivity throughout the 19th and 20th centuries led to a higher standard of living, making the “good life” accessible to more people.</li>
</ul>
</section>
<section id="the-decline-of-evolutionary-pressure-and-the-rise-of-the-eloi" class="level3">
<h3 class="anchored" data-anchor-id="the-decline-of-evolutionary-pressure-and-the-rise-of-the-eloi">The Decline of Evolutionary Pressure and the Rise of the Eloi</h3>
<ul>
<li><strong>Medieval Europe and the Constant Threat of War:</strong> Medieval life was shaped by the constant presence of war, creating an evolutionary pressure for moral codes that prioritized productivity, efficiency, hard work, and the needs of the polity over the individual.</li>
<li><strong>The Forging of Western Civilization:</strong> This pressure shaped Western civilization, promoting values that led to a better standard of living and the development of science.</li>
<li><strong>The Impact of Nuclear Weapons on Warfare:</strong> The advent of nuclear weapons and the concept of mutually assured destruction (MAD) fundamentally changed the nature of warfare.
<ul>
<li><strong>Short-Circuiting the Evolutionary Process:</strong> MAD removed the pressure on societies to maintain efficient cultural and governmental practices for survival.</li>
</ul></li>
<li><strong>The Nuclear Umbrella and the Cambrian Explosion of Eloi:</strong> The nuclear umbrella allowed societies with less efficient practices to survive, leading to a proliferation of “Eloi” (those focused on higher-level needs).</li>
<li><strong>Proxy Wars and Reduced Societal Pressure:</strong> Wars like the Korean War became proxy conflicts, reducing the direct pressure on American society compared to World War II.</li>
<li><strong>Peter Turchin’s Historical Analysis:</strong> Historian Peter Turchin observed a pattern of empires becoming complacent and vulnerable to internal decay when their survival is no longer threatened.</li>
<li><strong>The Vietnam War and the Decline of Technological Optimism:</strong> The Vietnam War, perceived as cruel and useless, contributed to a decline in American faith in technological progress and military strength.</li>
<li><strong>World War II’s Influence on Post-War Culture:</strong> The experience of World War II shaped American culture and institutions, promoting a belief in centralized bureaucratic government and fostering a cooperative spirit.</li>
<li><strong>The Unsustainability of the 1950s Boom:</strong> The post-war boom of the 1950s relied on the cooperative spirit inherited from the war, which began to fade in subsequent generations.</li>
<li><strong>The Baby Boomers and the Two Cultures:</strong> The baby boomer generation split into two distinct cultures with differing values and worldviews, exemplified by the contrasting responses to the Apollo 11 moon landing and Woodstock.</li>
<li><strong>The Corporate State and the Age of Aquarius:</strong> The centralized corporate state that worked with the cooperative Greatest Generation struggled to adapt to the individualistic and rebellious spirit of the Age of Aquarius.</li>
<li><strong>Science Fiction’s Misjudgment of Societal Progress:</strong> Science fiction writers often assumed that social decision-making would become more scientific and rational, failing to anticipate the cultural shift towards emotionalism and individualism.</li>
<li><strong>The Role of Ease and Plenty in Moral and Intellectual Decay:</strong> Contrary to some post-apocalyptic narratives, it was ease and abundance, not hardship, that fostered moral and intellectual decline.</li>
<li><strong>The Limitations of War as a Shaper of Culture:</strong> War is no longer a viable mechanism for shaping culture due to the destructive potential of modern technology.</li>
<li><strong>The Question of Corrective Mechanisms for False Beliefs:</strong> In the absence of war, it is unclear what mechanisms will correct societal false beliefs.</li>
</ul>
</section>
<section id="the-eloi-agonists-and-the-search-for-meaning" class="level3">
<h3 class="anchored" data-anchor-id="the-eloi-agonists-and-the-search-for-meaning">The Eloi Agonists and the Search for Meaning</h3>
<ul>
<li><strong>The Modern Eloi’s Perception of Struggle:</strong> Despite living in relative ease and security, many people today perceive their lives as a struggle and believe they are contributing to something meaningful.</li>
<li><strong>Maslow’s Hierarchy and the Need for Belonging and Esteem:</strong> The need for belonging and esteem drives individuals to seek purpose and validation in their lives.</li>
<li><strong>The Human Psyche’s Resistance to Uselessness:</strong> Humans are psychologically averse to a life devoid of purpose and contribution to others, as depicted in Wells’ portrayal of the Eloi.</li>
<li><strong>The Post-Industrial Age’s Fulfillment of the Need for Meaning:</strong> The post-industrial age has created a system where people can believe they are doing important work even when it is not objectively productive.</li>
<li><strong>The Illusion of Progress and Societal Stagnation:</strong> While the Great Stagnation indicates a decline in actual progress, many believe they are making the world a better place.</li>
<li><strong>The Shift from Conquering the Physical World to Conquering Minds:</strong> The focus has shifted from technological advancement to influencing the beliefs and behaviors of others.</li>
<li><strong>The Role of Emotion and Self-Deception:</strong> In this new struggle, objective truth is often disregarded in favor of emotional appeals and self-deception.</li>
<li><strong>The Evolutionary Basis for Self-Deception:</strong> Humans have evolved the ability to deceive themselves as a means of more effectively deceiving others.
<ul>
<li><strong>Research on Self-Deception:</strong> The work of Robert Trivers and Robin Hanson highlights the evolutionary advantages of self-deception.</li>
</ul></li>
<li><strong>Literature’s Exploration of Self-Deception:</strong> The theme of self-deception and hypocrisy is prevalent in literature, showcasing our tendency to distort reality to maintain a positive self-image.
<ul>
<li>Example: T.S. Eliot’s observation about people’s desire to feel important and their capacity for self-justification.</li>
</ul></li>
<li><strong>The Rise of Science and the Advantage of Truth:</strong> Science emerged because, in specific historical contexts, knowing the objective truth became more advantageous than not knowing it.</li>
<li><strong>The Rise of Virtue Signaling and Cost Disease:</strong> Today, many social institutions gain prestige through virtue signaling rather than demonstrable results, leading to cost disease in areas like healthcare, education, and environmental regulation.</li>
</ul>
</section>
<section id="risk-homeostasis-and-the-appeal-of-scare-stories" class="level3">
<h3 class="anchored" data-anchor-id="risk-homeostasis-and-the-appeal-of-scare-stories">Risk Homeostasis and the Appeal of Scare Stories</h3>
<ul>
<li><strong>Risk Homeostasis and Risk Compensation:</strong> People tend to maintain a constant level of perceived risk, adjusting their behavior to compensate for changes in actual risk.
<ul>
<li><strong>The Peltzman Effect:</strong> Introducing safety features can lead to riskier behavior, as people compensate to maintain their preferred risk level.</li>
</ul></li>
<li><strong>Societal Risk Homeostasis and the Appeal of Scare Stories:</strong> The decline in perceived exogenous risk after World War II may have led to increased susceptibility to scare stories, such as those related to environmental hazards.</li>
<li><strong>The Correlation between Energy Intensity and Failed Predictions:</strong> Technologies with higher energy intensity are easier to portray as dangerous and are further removed from everyday experience, making them more susceptible to scare stories.
<ul>
<li>Example: Cell phones vs.&nbsp;nuclear reactors – personal experience with cell phones counteracts scare stories, while the lack of experience with nuclear power makes it easier to believe exaggerated risks.</li>
</ul></li>
</ul>
</section>
<section id="the-green-religion-and-the-demonization-of-humanity" class="level3">
<h3 class="anchored" data-anchor-id="the-green-religion-and-the-demonization-of-humanity">The Green Religion and the Demonization of Humanity</h3>
<ul>
<li><strong>The Rise of Environmentalism as a Religion:</strong> The decline of organized religion has been accompanied by the rise of environmentalism, which, in its extreme form, can be considered a religion.
<ul>
<li><strong>John Burroughs’ Observation:</strong> Burroughs noted the increasing tendency to treat nature as a temple.</li>
</ul></li>
<li><strong>Homeostasis in the Human Psyche for Religion:</strong> The human psyche appears to have a need for religious or spiritual belief systems, which environmentalism may be fulfilling for some.</li>
<li><strong>Bill McKibben’s Biocentrism:</strong> McKibben’s writings express a biocentric worldview, where human impact on nature is inherently bad, regardless of observable consequences.
<ul>
<li><strong>“The End of Nature”:</strong> McKibben lamented the loss of nature’s independence and mystery due to human influence.</li>
</ul></li>
<li><strong>The Doctrine of Original Sin on Steroids:</strong> This view can be seen as an extreme version of the doctrine of original sin, where humanity’s very existence is seen as a blight on nature.</li>
<li><strong>Calls for Human Extinction:</strong> Some environmental extremists advocate for human extinction as a solution to environmental problems.
<ul>
<li>Example: David Graeber’s hope for a virus to eliminate humanity.</li>
</ul></li>
<li><strong>The Green Religion’s Dominance in Western Culture:</strong> The green religion has become the default belief system for many in Western civilization, particularly in academia.</li>
<li><strong>Climate Change as the Central Focus:</strong> Climate change has become the central apocalyptic narrative of the green religion.</li>
<li><strong>The Intertwining of Environmentalism and a Desire for a Healthy Environment:</strong> It is important to distinguish between a reasonable desire for a clean environment and the religious aspects of the green movement.</li>
</ul>
</section>
<section id="the-climate-change-debate-science-vs.-religion" class="level3">
<h3 class="anchored" data-anchor-id="the-climate-change-debate-science-vs.-religion">The Climate Change Debate: Science vs.&nbsp;Religion</h3>
<ul>
<li><strong>The Fundamentalist Green View of Humanity:</strong> Fundamentalist greens view human impact on nature as inherently negative, regardless of the specific activity.</li>
<li><strong>The Eloi Agonists and Climate Change:</strong> Many climate change believers are not scientists but are motivated by moral and social factors, attaching a sense of moral superiority to their beliefs.</li>
<li><strong>The Author’s Position on Climate Change:</strong> The author distinguishes between green activism, which is largely religious, and the scientific study of climate change.</li>
<li><strong>The Apocalyptic Nature Cult:</strong> A significant portion of the American public believes climate change poses an existential threat to humanity, reflecting an apocalyptic worldview.</li>
<li><strong>The IPCC’s Assessment of Climate Change’s Economic Impact:</strong> The Intergovernmental Panel on Climate Change (IPCC) concludes that the economic impact of climate change will be relatively small compared to other factors.</li>
<li><strong>The Disconnect between Scientific Consensus and Public Perception:</strong> There is a vast gap between the IPCC’s scientific assessment and the apocalyptic narrative promoted by climate activists.</li>
</ul>
</section>
<section id="baptists-and-bootleggers-the-political-economy-of-climate-change" class="level3">
<h3 class="anchored" data-anchor-id="baptists-and-bootleggers-the-political-economy-of-climate-change">Baptists and Bootleggers: The Political Economy of Climate Change</h3>
<ul>
<li><strong>Baptists and Bootleggers Analogy:</strong> The climate change debate can be understood through the “Baptists and bootleggers” framework from public choice theory, where seemingly opposed groups support the same policies for different reasons.</li>
<li><strong>The Dark Green Religion and Climate Science:</strong> The dark green true believers, like the Baptists, are motivated by moral and religious convictions, while scientists and renewable energy entrepreneurs, like the bootleggers, may benefit from climate concern.</li>
<li><strong>The Reversal of the Baptists and Bootleggers Dynamic:</strong> Unlike the original analogy, where bootleggers pretended to be Baptists, in the climate change debate, the Baptists (dark green activists) often pretend to be bootleggers (scientists) to gain wider support.</li>
<li><strong>The Distortion of Scientific Findings:</strong> This dynamic can lead to the exaggeration of climate change’s risks and the suppression of dissenting scientific views.</li>
<li><strong>The Negative Impacts of Agriculture and Highways on Habitat:</strong> The author notes that agriculture and highways are major contributors to habitat destruction, but these are often overlooked in favor of focusing on energy production.</li>
<li><strong>The Paradox of Opposition to Nuclear Power:</strong> The green movement’s opposition to nuclear power, a clean energy source, is paradoxical given their concern for habitat destruction.</li>
<li><strong>The Prevalence of “Schrodinger’s Cats”:</strong> The author suggests that many individuals hold contradictory beliefs, supporting green causes while also engaging in activities that harm the environment.</li>
</ul>
</section>
<section id="ergophobia-the-irrational-fear-of-energy" class="level3">
<h3 class="anchored" data-anchor-id="ergophobia-the-irrational-fear-of-energy">Ergophobia: The Irrational Fear of Energy</h3>
<ul>
<li><strong>Ergophobia: The Fear of Work/Energy:</strong> Ergophobia is the irrational fear of work, which can be extended to mean the fear of using energy.</li>
<li><strong>The Origins of Ergophobia:</strong> Ergophobia in American culture predates climate change concerns, as seen in the anti-nuclear power movement.</li>
<li><strong>The Climate Movement as a Repackaged Crusade Against Energy:</strong> The modern climate change movement can be seen as a continuation of the anti-energy crusade, using climate change as a justification.</li>
<li><strong>The Contradiction of Opposing Nuclear Power While Fearing Climate Change:</strong> The green movement’s opposition to nuclear power, a carbon-free energy source, is a central contradiction within their ideology.</li>
<li><strong>The Assumption that Anything Human is Bad:</strong> The fundamentalist green perspective seems to stem from the belief that any human impact on nature is inherently negative.</li>
</ul>
</section>
<section id="the-meme-plague-and-the-suppression-of-doubt" class="level3">
<h3 class="anchored" data-anchor-id="the-meme-plague-and-the-suppression-of-doubt">The Meme Plague and the Suppression of Doubt</h3>
<ul>
<li><strong>The Xhosa Cattle Killing:</strong> The Xhosa cattle killing of 1856-57 serves as an example of a meme plague, where a self-destructive belief spreads rapidly through a population, leading to devastating consequences.</li>
<li><strong>The Power of Social Feedback and Suppression of Doubt:</strong> The Xhosa example highlights how social feedback, superstition, and the suppression of skepticism can lead to the adoption of harmful beliefs.</li>
<li><strong>Meme Plagues and Societal Stagnation:</strong> In modern societies, meme plagues may not cause catastrophic collapse but can contribute to societal stagnation.</li>
<li><strong>Eric Hoffer’s Observation on Mass Movements:</strong> Hoffer noted that mass movements in America tend to evolve into rackets, cults, or corporations.</li>
<li><strong>The Eloi-Machiavelli Effect Dynamic:</strong> The Eloi agonists’ crusades, driven by religious fervor, can gain widespread acceptance and be exploited by those seeking power or profit.</li>
<li><strong>Evolutionary Game Theory and Morality:</strong> Evolutionary game theory suggests that morality arises from non-zero-sum interactions, where cooperation benefits all parties.</li>
<li><strong>The Zero-Sum Mentality and the Erosion of Morality:</strong> In a static, no-growth society, the zero-sum mentality prevails, leading to a decline in cooperation and morality.</li>
<li><strong>The Green Religion’s Zero-Sum Approach:</strong> The green religion’s focus on limiting human impact can promote a zero-sum worldview, hindering progress and fostering conflict.</li>
<li><strong>The Corruption of Science by Zero-Sum Politics:</strong> Zero-sum political funding can bias scientific research, promoting agendas rather than objective truth.</li>
<li><strong>The Fragility of Science and the Resurgence of Religion:</strong> The author argues that science is not the default human mode of thinking and that the resurgence of religious and value-laden approaches threatens its integrity.</li>
</ul>
</section>
<section id="science-fictions-predictions-of-societal-decline-and-the-suppression-of-science" class="level3">
<h3 class="anchored" data-anchor-id="science-fictions-predictions-of-societal-decline-and-the-suppression-of-science">Science Fiction’s Predictions of Societal Decline and the Suppression of Science</h3>
<ul>
<li><strong>Science Fiction’s Depiction of Civilizational Cycles:</strong> Many science fiction writers have explored the rise and fall of civilizations, often attributing decline to the loss of scientific knowledge or the suppression of technology.
<ul>
<li>Examples: Wells’ “The Time Machine,” Campbell’s “Twilight,” Asimov’s “Foundation,” Piper’s “Tarot,” and Heinlein’s “Future History” series.</li>
</ul></li>
<li><strong>Heinlein’s “Crazy Years” and the Deterioration of Mores:</strong> Heinlein’s “Future History” chart predicted a period of technological advancement accompanied by a decline in morals and social institutions, culminating in mass psychosis.</li>
<li><strong>The Ubiquity of Perceived Moral Decline:</strong> The perception of moral decline is a recurring theme throughout history, as each generation tends to judge subsequent generations’ values against their own.</li>
<li><strong>Heinlein’s Prediction of a “New Crusade”:</strong> Heinlein also predicted a hiatus in space travel and the rise of a religious dictatorship that suppresses scientific research and technological progress.</li>
<li><strong>The Potential Accuracy of Heinlein’s Predictions:</strong> The author suggests that Heinlein’s predictions, particularly regarding the suppression of science and the rise of religious fervor, may be becoming increasingly accurate.</li>
<li><strong>Carl Sagan’s Warning about the Decline of Critical Thinking:</strong> Carl Sagan warned about the potential for a decline in critical thinking and a resurgence of superstition in a society dominated by technology controlled by a few.</li>
</ul>
</section>
</section>
<section id="chapter-8-forbidden-fruit" class="level2">
<h2 class="anchored" data-anchor-id="chapter-8-forbidden-fruit">Chapter 8: Forbidden Fruit</h2>
<section id="the-cultural-shift-and-its-consequences" class="level3">
<h3 class="anchored" data-anchor-id="the-cultural-shift-and-its-consequences">The Cultural Shift and Its Consequences</h3>
<ul>
<li><strong>The 1960s and 70s Cultural Shift:</strong> A significant cultural shift occurred in the 1960s and 70s, marked by a decline in trust, the rise of “culture wars,” and changes in fashion.</li>
<li><strong>Impact of the Shift:</strong> This shift contributed to the lack of technological progress, particularly in areas like flying cars, due to increased susceptibility to baseless fears and hostility towards technology, especially energy.</li>
<li><strong>Ergophobia:</strong>
<ul>
<li>Defined as the fear or hatred of work or energy.</li>
<li>Grew from a rare condition in the 1950s to a widespread phenomenon by the 1970s.</li>
</ul></li>
<li><strong>Hypothetical Consequences:</strong>
<ul>
<li>If this cultural shift had occurred in a smaller, isolated community, it could have led to economic collapse, similar to historical examples like the Xhosa cattle-killing movement.</li>
<li>Even in a free market, areas with strong ergophobia might have failed, similar to many religiously-based utopian experiments.</li>
</ul></li>
</ul>
</section>
<section id="the-three-barriers-to-future-technology" class="level3">
<h3 class="anchored" data-anchor-id="the-three-barriers-to-future-technology">The Three Barriers to Future Technology</h3>
<ul>
<li><strong>Cerberus Analogy:</strong> The barriers to achieving the futuristic technologies we were promised are compared to Cerberus, the three-headed dog guarding the underworld in Greek mythology.</li>
<li><strong>The Three Heads:</strong>
<ol type="1">
<li><strong>Bureaucratic Structure of Science and Technology:</strong> Amplifies the Machiavelli Effect, where institutions prioritize self-preservation and power over their intended goals.</li>
<li><strong>Ergophobic Religion of the Eloi Agonists:</strong> The widespread fear and rejection of energy and technology, driven by those who benefit from fear-mongering and regulation.</li>
<li><strong>Strangling Red Tape of Regulation:</strong> Excessive government rules and regulations that hinder innovation and development.</li>
</ol></li>
<li><strong>Synergistic Effect:</strong> These three forces have increasingly reinforced each other, creating a powerful barrier to progress.</li>
<li><strong>Historical Impact of Regulation:</strong> Even in isolation, regulation was sufficient to hinder early attempts at developing flying cars.</li>
</ul>
</section>
<section id="the-case-of-the-aero-car-and-potential-economic-impact" class="level3">
<h3 class="anchored" data-anchor-id="the-case-of-the-aero-car-and-potential-economic-impact">The Case of the Aero Car and Potential Economic Impact</h3>
<ul>
<li><strong>Moulton Taylor’s Aero Car:</strong> A hypothetical scenario explores what might have happened if the Aero Car and similar designs had followed the same development path as the automobile.</li>
<li><strong>Assumptions:</strong>
<ul>
<li>Starting point in 1950 with high pilot registration levels.</li>
<li>Initial ownership by wealthy enthusiasts and hobbyists, followed by broader adoption.</li>
<li>Technological improvements in areas like wing attachment, power, speed, reliability, and ease of use.</li>
</ul></li>
<li><strong>Potential Economic Impact:</strong>
<ul>
<li>By 1975, a significant new industry comparable to the automotive sector could have emerged, boosting GDP directly and indirectly.</li>
<li>Analogy to the Interstate Highway System: The Interstate system significantly impacted the U.S. economy, contributing to growth, lower prices, time savings, and reduced accidents.</li>
<li>Increased Property Values: Similar to the impact of new highways, flying cars could have increased property values and economic activity in previously isolated areas.</li>
<li>New Businesses and Increased Economic Radius: Flying cars could have spawned new industries (e.g., landing strips) and expanded the economic reach of households.</li>
<li>Addressing the Great Stagnation: Flying cars could have mitigated the Great Stagnation by increasing connectivity and reducing transportation costs to remote areas.</li>
</ul></li>
<li><strong>Lost Potential:</strong> If this path had been taken, we might have achieved significantly more advanced technologies by now.</li>
</ul>
</section>
<section id="bureaucracy-and-regulation-hindering-innovation" class="level3">
<h3 class="anchored" data-anchor-id="bureaucracy-and-regulation-hindering-innovation">Bureaucracy and Regulation: Hindering Innovation</h3>
<section id="a-multitude-of-officers" class="level4">
<h4 class="anchored" data-anchor-id="a-multitude-of-officers">A Multitude of Officers</h4>
<ul>
<li><strong>Bureaucracy as a Perennial Problem:</strong> Throughout history, excessive bureaucracy and regulation have been identified as obstacles to progress, as noted by figures like Thomas Jefferson and Winston Churchill.</li>
<li><strong>The Wright Brothers and French Customs:</strong>
<ul>
<li>In 1908, Wilbur Wright encountered damage to his airplane due to careless handling by French customs officials.</li>
<li>This incident highlights the potential for bureaucratic interference to hinder even groundbreaking innovations.</li>
</ul></li>
<li><strong>Bruce Halleck and the Rotaplane:</strong>
<ul>
<li>Bruce Halleck, inventor of the Rotaplane flying car, faced legal trouble due to a misapplication of the Neutrality Act, illustrating how regulations can stifle inventors.</li>
</ul></li>
<li><strong>Robert Edison Fulton Jr.&nbsp;and the Airphibian:</strong>
<ul>
<li>The Airphibian, another promising flying car design, faced regulatory hurdles and ultimately failed to achieve production due to the high costs of meeting government standards.</li>
</ul></li>
<li><strong>Moulton Taylor’s Perspective:</strong>
<ul>
<li>Moulton Taylor attributed the failure of his Aero Car to government regulation, specifically the FAA and DOT.</li>
<li>He claimed the agencies feared the widespread adoption of flying cars and the resulting air traffic challenges.</li>
</ul></li>
</ul>
</section>
<section id="the-corvair-ralph-nader-and-the-rise-of-fear-mongering" class="level4">
<h4 class="anchored" data-anchor-id="the-corvair-ralph-nader-and-the-rise-of-fear-mongering">The Corvair, Ralph Nader, and the Rise of Fear-Mongering</h4>
<ul>
<li><strong>The Chevrolet Corvair:</strong>
<ul>
<li>The 1960 Chevrolet Corvair, with its rear-engine design, faced criticism despite its handling being comparable to or even superior to other cars of its time.</li>
<li>It became a target for <strong>Eloi Agonist</strong> fear-mongering, exemplified by Ralph Nader’s book “Unsafe at Any Speed.”</li>
</ul></li>
<li><strong>Societal Shift and Susceptibility to Scare Stories:</strong>
<ul>
<li>By the 1960s, fewer people had direct experience with machinery, making them more vulnerable to scare stories about technology.</li>
<li>This increased susceptibility created an environment where fear-mongering by individuals like Nader and the perceived need for regulation could thrive.</li>
</ul></li>
</ul>
</section>
<section id="the-great-explosion" class="level4">
<h4 class="anchored" data-anchor-id="the-great-explosion">The Great Explosion</h4>
<ul>
<li><strong>The Regulatory Explosion:</strong> The Great Stagnation coincided with a massive increase in federal regulation, particularly during the Nixon administration in the 1970s.</li>
<li><strong>Examples of New Regulations:</strong> This period saw the passage of major environmental and safety regulations like the Clean Air Act, Clean Water Act, and the creation of agencies like OSHA and the EPA.</li>
<li><strong>Growth of the Federal Register:</strong> The Federal Register, which documents new regulations, grew dramatically under Nixon and continued to expand in subsequent decades.</li>
<li><strong>Complexity and Burden of Regulations:</strong>
<ul>
<li>Modern regulations are often complex and difficult to understand, as illustrated by an example from the Federal Air Regulations.</li>
<li>The sheer volume and complexity of regulations create a significant burden for businesses and individuals.</li>
</ul></li>
<li><strong>Economic Impact of Regulation:</strong>
<ul>
<li>A study by Dawson and Seder found that excessive regulation has significantly reduced U.S. household income compared to a scenario with lower regulation.</li>
<li>They linked slower economic growth to heavier regulatory burdens.</li>
</ul></li>
<li><strong>Overestimation of Regulatory Benefits:</strong>
<ul>
<li>The actual benefits of regulation are often overstated, as demonstrated by an analysis of the 1962 drug laws, which slowed innovation without improving quality.</li>
</ul></li>
<li><strong>Impact on Life Expectancy:</strong>
<ul>
<li>Life expectancy gains in the U.S. were greater in the first half of the 20th century (pre-heavy regulation) than in the latter half, suggesting that regulation may not be the primary driver of safety improvements.</li>
</ul></li>
<li><strong>Burden on Aviation:</strong>
<ul>
<li>Regulation has significantly increased the cost of components for certified aircraft.</li>
</ul></li>
<li><strong>Airline Deregulation as a Counter-Example:</strong>
<ul>
<li>The deregulation of the airline industry in 1978 led to lower fares, increased safety, and overall benefits for consumers.</li>
<li>This example demonstrates that deregulation can lead to positive outcomes, challenging the assumption that heavy regulation is always necessary.</li>
</ul></li>
</ul>
</section>
<section id="product-liability-and-the-destruction-of-general-aviation" class="level4">
<h4 class="anchored" data-anchor-id="product-liability-and-the-destruction-of-general-aviation">Product Liability and the Destruction of General Aviation</h4>
<ul>
<li><strong>Rise of Product Liability:</strong> The 1970s saw a surge in product liability lawsuits, often driven by scare stories and large jury awards.</li>
<li><strong>Impact on the General Aviation Industry:</strong>
<ul>
<li>This increase in lawsuits devastated the general aviation industry, leading to the cessation of production by major manufacturers like Cessna and Piper.</li>
</ul></li>
<li><strong>Explanation of the Collapse:</strong>
<ul>
<li>The Concise Encyclopedia of Economics attributes the collapse to the dramatic increase in liability costs, which made it unsustainable for aircraft manufacturers to operate.</li>
</ul></li>
<li><strong>The Role of Regulation:</strong>
<ul>
<li>While the energy crisis initially impacted sales, the subsequent collapse of the industry was primarily driven by the product liability environment, not cyclical factors.</li>
</ul></li>
<li><strong>General Aviation Revitalization Act:</strong>
<ul>
<li>Congress passed the General Aviation Revitalization Act in 1994 to limit liability for older aircraft, but the industry never fully recovered.</li>
</ul></li>
<li><strong>Long-Term Consequences:</strong>
<ul>
<li>The cost of private airplanes has skyrocketed, and the number of new aircraft produced annually is a fraction of what it once was.</li>
</ul></li>
<li><strong>Broader Impact of Liability Costs:</strong>
<ul>
<li>The general aviation industry’s experience is just one example of how product liability costs have negatively impacted various industries and the economy as a whole.</li>
</ul></li>
<li><strong>Economic Costs of the Tort System:</strong>
<ul>
<li>The U.S. tort system, including product liability, consumes a significant portion of GDP, potentially slowing overall economic growth.</li>
<li>This cost also includes the loss of talented individuals who are drawn into legal professions instead of contributing to innovation and production.</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-german-economic-miracle-a-case-for-deregulation" class="level3">
<h3 class="anchored" data-anchor-id="the-german-economic-miracle-a-case-for-deregulation">The German Economic Miracle: A Case for Deregulation</h3>
<section id="miracles" class="level4">
<h4 class="anchored" data-anchor-id="miracles">Miracles</h4>
<ul>
<li><strong>Robert Gordon’s “Miracle”:</strong> Economist Robert Gordon described the early 20th century’s productivity boom as a “miracle,” implying that the Great Stagnation was a lack of such miracles.</li>
<li><strong>The German Economic Miracle:</strong> The post-WWII recovery of West Germany demonstrates that economic miracles can be intentionally created through deregulation.</li>
<li><strong>Post-War Germany’s Dire Situation:</strong>
<ul>
<li>Germany faced widespread destruction, food shortages, and severely hampered industrial production after the war.</li>
</ul></li>
<li><strong>Ludwig Erhardt’s Reforms:</strong>
<ul>
<li>Ludwig Erhardt, influenced by Hayek’s free-market ideas, implemented sweeping deregulation, including the removal of price controls and rationing.</li>
</ul></li>
<li><strong>Dramatic Economic Rebound:</strong>
<ul>
<li>Deregulation had an immediate and positive impact on the West German economy, leading to rapid increases in industrial production and a resurgence of economic activity.</li>
</ul></li>
<li><strong>Contrast with East Germany:</strong>
<ul>
<li>East Germany, under communist rule, experienced economic stagnation, highlighting the benefits of a free market approach.</li>
</ul></li>
<li><strong>The Importance of Ignoring “Right-Thinking” People:</strong>
<ul>
<li>The German example shows that progress can be achieved by disregarding the conventional wisdom of those who advocate for excessive control and regulation.</li>
</ul></li>
</ul>
</section>
<section id="the-great-strangulation" class="level4">
<h4 class="anchored" data-anchor-id="the-great-strangulation">The Great Strangulation</h4>
<ul>
<li><strong>Regulation and Long-Term Decline:</strong> Over time, excessive regulation hinders learning, stifles innovation, protects inefficiency, and ultimately reverses progress.</li>
<li><strong>The Role of Energy and Sanity:</strong> The optimistic predictions of the mid-20th century relied on continued growth in energy consumption and a reasonable regulatory environment.</li>
<li><strong>The Great Stagnation as Self-Inflicted:</strong> The Great Stagnation was not a natural phenomenon but a consequence of choices that stifled innovation and progress.</li>
</ul>
</section>
</section>
<section id="the-unexpected-rise-of-the-family-car" class="level3">
<h3 class="anchored" data-anchor-id="the-unexpected-rise-of-the-family-car">The Unexpected Rise of the Family Car</h3>
<section id="the-family-car" class="level4">
<h4 class="anchored" data-anchor-id="the-family-car">The Family Car</h4>
<ul>
<li><strong>H.G. Wells’ Predictions:</strong> H.G. Wells’ “Anticipations” accurately predicted the development of motor trucks, private motor carriages, and motor omnibuses.</li>
<li><strong>Limited Vision:</strong>
<ul>
<li>Wells saw the private car as a luxury for the wealthy, similar to private jets today.</li>
<li>He failed to foresee the widespread adoption of the automobile by the general population.</li>
</ul></li>
<li><strong>The Missing Element: Productivity:</strong>
<ul>
<li>D.S.L. Cardwell points out that contemporary thinkers failed to anticipate the universal motor car because they did not grasp the potential impact of increased productivity.</li>
</ul></li>
<li><strong>The Importance of Productivity:</strong>
<ul>
<li>High productivity is essential for making goods affordable and accessible to the masses.</li>
<li>The assembly line and other innovations dramatically increased automobile production, making the family car a reality.</li>
</ul></li>
<li><strong>The Rise of the Suburbs:</strong> The automobile and the highway system facilitated the growth of suburbs, allowing people to live further from urban centers.</li>
<li><strong>The Decline of Infrastructure Investment:</strong>
<ul>
<li>Investment in transportation infrastructure peaked in the 1960s and has declined since, contributing to the stagnation.</li>
</ul></li>
<li><strong>The Demonization of Cars and the Rise of Regulation:</strong>
<ul>
<li>The rise of environmental concerns in the 1970s led to increased regulation and the demonization of cars, further hindering progress in transportation.</li>
</ul></li>
</ul>
</section>
</section>
<section id="leveling-up-and-the-eloi-agonists" class="level3">
<h3 class="anchored" data-anchor-id="leveling-up-and-the-eloi-agonists">Leveling Up and the Eloi Agonists</h3>
<section id="leveling-up" class="level4">
<h4 class="anchored" data-anchor-id="leveling-up">Leveling Up</h4>
<ul>
<li><strong>Hans Rosling’s Levels of Wealth:</strong> Hans Rosling categorized global wealth into four levels based on income and access to transportation: Barefoot, Bicycle, Motorbike, and Car.</li>
<li><strong>The Industrial Revolution’s Impact:</strong> The Industrial Revolution dramatically reduced the percentage of the world’s population at the lowest level of wealth.</li>
<li><strong>Progress in the U.S.:</strong> The average American progressed through Rosling’s levels throughout the 20th century.</li>
<li><strong>Global Wealth Distribution:</strong> Over the past 50 years, global wealth distribution has become more bell-shaped as many people moved up from the lowest levels.</li>
<li><strong>The Absence of Level 5:</strong> The Great Stagnation can be seen as the absence of a “Level 5” in Rosling’s framework, representing a significant leap beyond car ownership.</li>
<li><strong>Continued Energy Growth in Developing Countries:</strong> Developing countries continue to experience growth in energy use per capita, unlike developed countries where it has stagnated.</li>
<li><strong>Maslow’s Hierarchy and the Eloi Agonists:</strong>
<ul>
<li>The rise of <strong>Eloi agonists</strong> in developed countries may be linked to Maslow’s hierarchy of needs; once basic needs are met, people may focus on virtue signaling and fear-mongering rather than material progress.</li>
</ul></li>
<li><strong>Economic Growth in Developed vs.&nbsp;Developing Countries:</strong> Developing countries like China and India are experiencing faster economic growth than developed countries like France, Germany, and the U.S.</li>
</ul>
</section>
<section id="the-great-strangulation-revisited" class="level4">
<h4 class="anchored" data-anchor-id="the-great-strangulation-revisited">The Great Strangulation Revisited</h4>
<ul>
<li><strong>The Root Cause of the Failed Future:</strong> The failure to achieve the futuristic technologies we were promised is primarily due to the stagnation of energy growth and the rise of ergophobia, fueled by the Eloi agonists.</li>
<li><strong>The Role of Bureaucracy and Regulation:</strong> Bureaucracy, the Machiavelli effect, and excessive regulation have further exacerbated the stagnation.</li>
<li><strong>Moving Forward:</strong> Understanding the causes of the Great Stagnation is crucial for exploring possibilities for reversing it and achieving a more technologically advanced future.</li>
</ul>
</section>
</section>
</section>
<section id="chapter-9-ceiling-and-visibility-unlimited" class="level2">
<h2 class="anchored" data-anchor-id="chapter-9-ceiling-and-visibility-unlimited">Chapter 9: Ceiling and Visibility Unlimited</h2>
<section id="the-potential-of-flying-cars" class="level3">
<h3 class="anchored" data-anchor-id="the-potential-of-flying-cars">The Potential of Flying Cars</h3>
<ul>
<li><strong>Flying cars</strong> and <strong>helicopters</strong>, offering point-to-point travel, have been technologically feasible since the 1930s and 1940s, respectively.</li>
<li>Despite this feasibility, widespread adoption hasn’t occurred, representing a “failure of nerve” in technological development.</li>
<li>This chapter explores the human element in adopting flying cars, particularly focusing on the feasibility of average individuals piloting them.</li>
</ul>
</section>
<section id="public-perception-and-reality-of-flying" class="level3">
<h3 class="anchored" data-anchor-id="public-perception-and-reality-of-flying">Public Perception and Reality of Flying</h3>
<ul>
<li>A common reaction to the idea of flying cars is skepticism and the belief that they are impossible or impractical.
<ul>
<li>Concerns include:
<ul>
<li>Difficulty and fear associated with flying, especially for those without helicopter experience.</li>
<li>High cost of ownership and operation.</li>
<li>The perceived inability of average car drivers to pilot aircraft.</li>
</ul></li>
</ul></li>
<li>The author challenges this perception by arguing that flying is a learnable skill, comparable to riding a bicycle, and that planes can be as safe as cars.</li>
<li>The author’s personal experience of becoming a pilot supports this claim, highlighting the accessibility of flying with proper training and technology.</li>
</ul>
</section>
<section id="the-authors-journey-to-becoming-a-pilot" class="level3">
<h3 class="anchored" data-anchor-id="the-authors-journey-to-becoming-a-pilot">The Author’s Journey to Becoming a Pilot</h3>
<ul>
<li>Motivated by a lack of practical experience in flying, the author obtained a pilot’s license and purchased a 1977 Beechcraft airplane as part of his research for the book.</li>
<li>This experience provided valuable insights into the realities of flying and informed his analysis of flying cars.</li>
<li>Beyond practical considerations, the author emphasizes the inherent joy and wonder of flying, offering a unique perspective on the world.</li>
</ul>
</section>
<section id="the-state-of-general-aviation" class="level3">
<h3 class="anchored" data-anchor-id="the-state-of-general-aviation">The State of General Aviation</h3>
<ul>
<li><strong>General aviation (GA)</strong> aircraft in the US are often older models, similar to classic cars, reflecting a stagnation in the industry.</li>
<li>This stagnation is partly attributed to regulatory issues that have stifled innovation and production of new aircraft.</li>
<li>The author suggests that without these regulatory hurdles, the GA industry could be significantly larger and more vibrant, with newer and potentially safer aircraft.</li>
</ul>
</section>
<section id="safety-in-general-aviation" class="level3">
<h3 class="anchored" data-anchor-id="safety-in-general-aviation">Safety in General Aviation</h3>
<ul>
<li>Despite anecdotal perceptions of danger, general aviation is statistically relatively safe.</li>
<li>The author’s low airplane insurance cost (less than $800 per year) suggests that insurance companies assess the risk as comparable to cars or homes.</li>
<li>The leading cause of death among active pilots is motorcycle accidents, further highlighting the relative safety of flying.</li>
</ul>
</section>
<section id="the-mechanics-of-flight" class="level3">
<h3 class="anchored" data-anchor-id="the-mechanics-of-flight">The Mechanics of Flight</h3>
<ul>
<li>Airplanes are mechanically simpler than cars, with basic models requiring only a glider-like structure, a motor, and a propeller.</li>
<li>However, flying is more challenging than driving due to the three-dimensional nature of flight, requiring adjustments to human instincts.</li>
<li>The Wright brothers’ significant contribution was solving the problem of control, altitude, and steering in flight.</li>
<li>Learning to fly involves mastering four key tasks:
<ol type="1">
<li><strong>Aviate:</strong> Maintaining control of the aircraft.</li>
<li><strong>Navigate:</strong> Ensuring the plane is on the correct course.</li>
<li><strong>Communicate:</strong> Interacting with air traffic control and other pilots.</li>
<li><strong>Engineer:</strong> Monitoring and managing the engine and other mechanical systems.</li>
</ol></li>
<li>While each task is manageable individually, performing all four simultaneously requires practice and skill.</li>
</ul>
</section>
<section id="the-dangers-of-slow-flight" class="level3">
<h3 class="anchored" data-anchor-id="the-dangers-of-slow-flight">The Dangers of Slow Flight</h3>
<ul>
<li>Unlike cars, airplanes are most vulnerable at low speeds, especially during landing.</li>
<li>Maintaining a minimum speed is crucial to prevent stalling, which is the loss of lift due to a disrupted airflow over the wings.</li>
<li><strong>Stall speed</strong> is the speed at which the stall angle of attack generates lift equal to the airplane’s weight. Going below this speed can result in a loss of altitude.</li>
<li>The author estimates that around half of current car drivers might not be suited to manually piloting planes due to the challenges of slow flight.</li>
</ul>
</section>
<section id="technological-advancements-and-automation" class="level3">
<h3 class="anchored" data-anchor-id="technological-advancements-and-automation">Technological Advancements and Automation</h3>
<ul>
<li>Modern technology offers solutions to some of the challenges of flying.
<ul>
<li>Automated engine control and monitoring systems reduce the pilot’s workload.</li>
<li><strong>GPS</strong> simplifies navigation significantly.</li>
<li><strong>Autopilots</strong> can automate various aspects of flight.</li>
<li>Fully autonomous aircraft are also emerging, capable of flying without human intervention.</li>
</ul></li>
</ul>
</section>
<section id="the-allure-and-challenges-of-flight" class="level3">
<h3 class="anchored" data-anchor-id="the-allure-and-challenges-of-flight">The Allure and Challenges of Flight</h3>
<ul>
<li>Despite the challenges, flying offers a unique and rewarding experience.</li>
<li>The author notes that some people are hesitant to fly in small planes due to concerns about motion sickness and noise.
<ul>
<li>Motion sickness can be a factor, especially on turbulent days, but the forces experienced are often no greater than in a car, just different in direction and frequency.</li>
<li>Noise is also a concern, but technological advancements can potentially address this issue.</li>
</ul></li>
<li>Perhaps the biggest hurdle is the lack of intuitive understanding of how airplanes work, contributing to fear and apprehension.</li>
</ul>
</section>
<section id="understanding-how-airplanes-fly" class="level3">
<h3 class="anchored" data-anchor-id="understanding-how-airplanes-fly">Understanding How Airplanes Fly</h3>
<section id="windy" class="level4">
<h4 class="anchored" data-anchor-id="windy">Windy</h4>
<ul>
<li>The force exerted by wind increases with the square of its speed, making high-speed flight a significant challenge.</li>
<li>Airplanes utilize aerodynamic principles to generate lift and overcome drag, allowing them to stay aloft.</li>
</ul>
</section>
<section id="how-it-flies" class="level4">
<h4 class="anchored" data-anchor-id="how-it-flies">How It Flies</h4>
<ul>
<li>Airplane wings generate lift by creating a pressure difference between the upper and lower surfaces.
<ul>
<li>The curved upper surface forces the air to travel a longer distance, creating a lower pressure area.</li>
<li>The higher pressure underneath the wing pushes the wing upward, generating lift.</li>
</ul></li>
<li><strong>Lift</strong> is proportional to the square of the speed and the <strong>angle of attack</strong> (the angle between the wing and the oncoming airflow).</li>
<li><strong>Stall</strong> occurs when the angle of attack exceeds a critical point, causing the airflow to separate from the wing and resulting in a loss of lift.</li>
<li>The Wright brothers initially modeled wings on bird wings but later adopted more rounded and flatter designs for easier handling.</li>
</ul>
</section>
<section id="the-power-curve" class="level4">
<h4 class="anchored" data-anchor-id="the-power-curve">The Power Curve</h4>
<ul>
<li>The <strong>power curve</strong> illustrates the relationship between airspeed and vertical speed (rate of climb or descent) for an airplane.</li>
<li>The curve shifts up or down depending on engine power (throttle setting).</li>
<li>At the front end of the curve, pushing the nose down increases speed, both forward and downward.</li>
<li>At the back end of the curve (slower speeds), pulling the nose up can actually cause the plane to slow down further and descend, increasing the risk of a stall.</li>
</ul>
</section>
<section id="airplane-balance-and-weight" class="level4">
<h4 class="anchored" data-anchor-id="airplane-balance-and-weight">Airplane Balance and Weight</h4>
<ul>
<li>Airplanes are balanced on their wings, and the <strong>elevator</strong> (a control surface on the tail) provides pitch control.</li>
<li>Proper weight distribution and balance are crucial for safe flight, similar to loading a rowboat.</li>
<li>Aerodynamic forces increase with the square of the speed, allowing heavier planes to maintain lift by flying faster.</li>
<li>However, increased weight also requires higher landing speeds, potentially making runways seem shorter during landing.</li>
</ul>
</section>
</section>
<section id="weather-as-a-limiting-factor" class="level3">
<h3 class="anchored" data-anchor-id="weather-as-a-limiting-factor">Weather as a Limiting Factor</h3>
<ul>
<li>Weather is a major constraint on flying, especially for general aviation.</li>
<li>Pilots who are <strong>instrument-rated</strong> and fly aircraft equipped for icing conditions have more flexibility but still face limitations.</li>
<li><strong>Wind shear</strong>, a sudden change in wind speed or direction, can be particularly dangerous, especially during landing.</li>
<li>Clouds, haze, and fog can reduce visibility, posing a risk of collision with terrain or other aircraft.</li>
<li>Flying in clouds or over featureless terrain can lead to <strong>spatial disorientation</strong>, where pilots lose their sense of direction and may inadvertently enter a dangerous flight attitude.</li>
<li>Learning to trust instruments over instincts is crucial for safe flight in such conditions.</li>
</ul>
</section>
<section id="air-traffic-control" class="level3">
<h3 class="anchored" data-anchor-id="air-traffic-control">Air Traffic Control</h3>
<ul>
<li><strong>Air Traffic Control (ATC)</strong> plays a vital role in ensuring the safe and orderly flow of air traffic.</li>
<li>Pilots communicate with ATC using radio, providing information about their position, intentions, and altitude.</li>
<li>ATC provides instructions and clearances to pilots, helping them avoid collisions and navigate through controlled airspace.</li>
<li>The author uses a fictional scenario of driving a car in a town with strict traffic control to illustrate the complexities of ATC procedures.</li>
<li>Airplanes are surprisingly difficult to see at a distance, making radio communication essential for avoiding collisions.</li>
</ul>
</section>
<section id="the-100-hamburger" class="level3">
<h3 class="anchored" data-anchor-id="the-100-hamburger">The $100 Hamburger</h3>
<ul>
<li>The <strong>$100 hamburger</strong> is a common phrase among pilots, referring to a short flight to a nearby airport with a restaurant.</li>
<li>It represents a blend of the practical and the recreational aspects of general aviation.</li>
<li>While sometimes used humorously to justify a flight, it also highlights the potential of flying as a convenient mode of transportation, especially when the destination is near an airport.</li>
<li>The author contrasts this with the complexities and inconveniences of commercial air travel, emphasizing the “last-mile problem” of aviation.</li>
<li>The $100 hamburger experience offers a glimpse of the convenience that flying cars could provide.</li>
</ul>
</section>
<section id="conclusion-1" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-1">Conclusion</h3>
<ul>
<li>The chapter concludes by reiterating that flying, while challenging, is a learnable skill and that technological advancements are making it more accessible.</li>
<li>Overcoming the psychological barriers and embracing the potential of flight could unlock a new era of personal transportation, where flying cars become a practical reality.</li>
</ul>
</section>
</section>
<section id="chapter-10-dialogue-concerning-the-two-great-systems-of-the-world" class="level2">
<h2 class="anchored" data-anchor-id="chapter-10-dialogue-concerning-the-two-great-systems-of-the-world">Chapter 10: Dialogue Concerning the Two Great Systems of the World</h2>
<section id="the-history-and-technology-of-flying-cars" class="level3">
<h3 class="anchored" data-anchor-id="the-history-and-technology-of-flying-cars">The History and Technology of Flying Cars</h3>
<ul>
<li>The question of whether people could fly cars was answered with a qualified yes.
<ul>
<li>Many people could pilot the simpler flying cars from the 1950s.</li>
<li>Modern craft with automated assistance would be even easier to pilot.</li>
</ul></li>
<li>The harder question is whether people would be willing to put in the effort to fly them.</li>
<li><strong>Convertibles</strong> and <strong>VTOLs (Vertical Take-Off and Landing)</strong> are the two major categories of flying cars.</li>
</ul>
</section>
<section id="vtols-helicopters-and-beyond" class="level3">
<h3 class="anchored" data-anchor-id="vtols-helicopters-and-beyond">VTOLs: Helicopters and Beyond</h3>
<section id="helicopters" class="level4">
<h4 class="anchored" data-anchor-id="helicopters">Helicopters</h4>
<ul>
<li><strong>Helicopters</strong> offer a significant advantage in certain terrains and situations.
<ul>
<li>New Zealand, with its rugged terrain and sparse roads, has a high rate of helicopter ownership (1 per 6,000 people).</li>
<li>The US has a much lower rate (1 per 35,000 people).</li>
</ul></li>
<li><strong>Comparison of Helicopter (Robinson R-44) and Airplane (Author’s)</strong>:
<ul>
<li>Similarities:
<ul>
<li>Total weight</li>
<li>Interior size</li>
<li>Useful load</li>
<li>Cruise speed</li>
<li>Operational ceiling</li>
<li>Engine type (Lycoming air-cooled horizontally opposed aero engine)</li>
</ul></li>
<li>Differences:
<ul>
<li>Airplane has twice the range.</li>
<li>Helicopter requires a much smaller landing area (10 ft x 10 ft pad vs.&nbsp;thousands of feet of runway).</li>
</ul></li>
</ul></li>
<li><strong>Advantages of Helicopters:</strong>
<ul>
<li><strong>Smaller landing area:</strong> This allows for helipads in places like hospitals, resorts, and corporate headquarters.</li>
<li><strong>More civilized takeoff:</strong> No taxiing or runway required, simply a smooth vertical ascent.</li>
<li><strong>Less susceptible to wind gusts:</strong>
<ul>
<li>The fast-moving rotor (at airliner speeds) is less affected by wind speed variations.</li>
<li>The smaller rotor area reduces the impact of gusts.</li>
</ul></li>
</ul></li>
<li><strong>Disadvantages of Helicopters:</strong>
<ul>
<li><strong>More complex piloting:</strong>
<ul>
<li>More links in the energy chain (engine speed, altitude, rotor speed).</li>
<li>More demanding control due to instability and non-intuitive rotor dynamics.</li>
<li>Lag between control input and response (unlike airplanes that can be briefly left uncontrolled).</li>
</ul></li>
<li><strong>Pilot seat placement:</strong>
<ul>
<li>Helicopter pilot seats are typically on the right, a tradition stemming from the Sikorsky R-4’s demanding controls which favored right-handed stick operation and left-handed collective control and radio operation.</li>
</ul></li>
<li><strong>Mechanical complexity:</strong>
<ul>
<li>Individually hinged, flapped, and tilted rotor blades.</li>
<li>Collective and cyclic controls for adjusting blade angle of attack.</li>
<li>Secondary driveshaft for the tail rotor with its own collective pitch control.</li>
</ul></li>
<li><strong>Higher Cost:</strong>
<ul>
<li>More powerful engine required.</li>
<li>Higher maintenance needs.</li>
<li>New helicopters: $1 million - $10 million.</li>
<li>Used helicopters: $100,000 - $1 million.</li>
<li>Five times more expensive than small piston planes.</li>
</ul></li>
<li><strong>Engine Cost:</strong>
<ul>
<li>Lycoming IO540-AE1A5 (used in R-44): $118,481.</li>
<li>Most helicopters use turbines, increasing the cost.</li>
<li>Piston-powered Robinsons: $300,000 - $400,000.</li>
<li>Guimbal Cabri G2: $410,000.</li>
</ul></li>
<li><strong>Performance Trade-offs:</strong>
<ul>
<li>Lower top speed.</li>
<li>Higher fuel costs per mile.</li>
</ul></li>
</ul></li>
<li><strong>Speed Limitations:</strong>
<ul>
<li><strong>Hovering:</strong> Rotor blade tips must remain subsonic to avoid noise, shockwaves, and power loss.</li>
<li><strong>Forward Flight:</strong> Advancing blade approaches the sound barrier, while retreating blade risks stalling.</li>
<li>Standard small helicopter design limited to around 125 knots.</li>
</ul></li>
</ul>
</section>
<section id="autogyros" class="level4">
<h4 class="anchored" data-anchor-id="autogyros">Autogyros</h4>
<ul>
<li><strong>Autogyros</strong> offer a compromise between airplanes and helicopters.</li>
<li><strong>Power Efficiency:</strong> All engine power goes to thrust, unlike helicopters that use some power to counteract torque.</li>
<li><strong>Speed:</strong> Can achieve higher speeds than helicopters (experimental models up to 150 mph).</li>
<li><strong>Takeoff:</strong> Requires a short takeoff roll (around 50 feet).</li>
<li><strong>Landing:</strong> Can land in very small spaces (“on a dime”).</li>
<li><strong>Vertical Takeoff Autogyros:</strong>
<ul>
<li>Pitcairn PA-36 Whirlwing (1930s) could achieve a 20-foot hop using a pre-rotator.</li>
<li>The mechanism added complexity and risk.</li>
</ul></li>
<li><strong>Simplest Vertical Takeoff Solution:</strong> A stationary fan creating a headwind.</li>
<li><strong>Benson Teeter Hub (1950s):</strong>
<ul>
<li>Simplified rotor design by eliminating the need for individually hinged blades in two-bladed rotors.</li>
<li>Reduced cost and increased reliability.</li>
</ul></li>
<li><strong>Recent Resurgence:</strong>
<ul>
<li>Driven by the Benson-style teeter hub and light sport category regulations.</li>
<li>Offer a good compromise in terms of cost, takeoff roll, performance, and training.</li>
<li>Easier to make roadable.</li>
</ul></li>
</ul>
</section>
<section id="the-flying-car-spectrum" class="level4">
<h4 class="anchored" data-anchor-id="the-flying-car-spectrum">The Flying Car Spectrum</h4>
<ul>
<li>Helicopters at one end (high cost, VTOL).</li>
<li>Roadable airplanes at the other end (lower cost, long runways).</li>
<li>Gyros in the middle (compromise between cost and takeoff/landing requirements).</li>
</ul>
</section>
</section>
<section id="travel-theory-and-the-value-of-flying-cars" class="level3">
<h3 class="anchored" data-anchor-id="travel-theory-and-the-value-of-flying-cars">Travel Theory and the Value of Flying Cars</h3>
<section id="the-value-of-time" class="level4">
<h4 class="anchored" data-anchor-id="the-value-of-time">The Value of Time</h4>
<ul>
<li><strong>Convertible Planes (e.g., Aero Car):</strong>
<ul>
<li>Significant overhead time for conversion and airport travel (at least 1 hour).</li>
<li>Fit well with existing infrastructure.</li>
</ul></li>
<li><strong>VTOLs:</strong>
<ul>
<li>Require helipads but offer much faster travel for short distances.</li>
</ul></li>
<li><strong>The Jevons Paradox:</strong>
<ul>
<li>Increased efficiency leads to increased consumption (e.g., more efficient steam engines led to increased coal use).</li>
<li>Applied to flying cars: Reduced travel time (increased efficiency) will lead to more travel.</li>
<li>Increased efficiency leads to greater overall value.</li>
</ul></li>
<li><strong>Travel Theory:</strong>
<ul>
<li>Studies how much people travel in different environments and modes.</li>
<li>Shows that people travel more when long-distance travel becomes more convenient.</li>
</ul></li>
<li><strong>Travel Time Universal:</strong> People in all societies spend about an hour a day traveling on average.</li>
<li><strong>Effective Car Speed Universal:</strong> The effective speed of a car, considering detours and road networks, is about 40 mph for trips of any length.</li>
<li><strong>Trip Values Graph:</strong>
<ul>
<li>Shows the value of destinations at various distances based on people’s willingness to travel.</li>
<li>Peak for trips under 10 miles due to low time cost and shadowing effect (nearby destinations are preferred).</li>
<li>“Hump” for trips around 50 miles, likely due to day trip destinations (e.g., ballpark, hospital).</li>
</ul></li>
<li><strong>Flying Car Value Analysis:</strong>
<ul>
<li><strong>Helicopter-like VTOL (100 knots):</strong> Dominates for short distances.</li>
<li><strong>Convertible Airplane (200 knots):</strong> Better for longer distances.</li>
<li><strong>Jet Car (400 mph, requires airport):</strong> Dominates for very long distances, but not used for short trips.</li>
</ul></li>
<li><strong>Value Calculation:</strong>
<ul>
<li>A jet car VTOL (400 mph, no latency) would be worth 7 times the value of a regular car.</li>
<li>A jet car with 1-hour overhead: 3.5 times the value of a car.</li>
<li>Fast prop-driven convertible (250 mph): 2.5 times the value of a car.</li>
<li>Slow convertible (100 mph, airport required): 1.4 times the value of a car.</li>
<li>Commercial air travel (400 knots, 3-hour overhead): Similar value increase to the slow convertible.</li>
</ul></li>
<li><strong>Hypothetical Jet Car Value:</strong> If the average car costs $35,000, a fast VTOL jet car could be worth $245,000 based on travel time value alone.</li>
</ul>
</section>
</section>
<section id="the-potential-for-autogyros-and-the-path-not-taken" class="level3">
<h3 class="anchored" data-anchor-id="the-potential-for-autogyros-and-the-path-not-taken">The Potential for Autogyros and the Path Not Taken</h3>
<ul>
<li><strong>The Importance of VTOL:</strong> Zimmerman, Custer, de la Sierra, and Pitcairn recognized the importance of VTOL capability for widespread adoption of flying cars.</li>
<li><strong>Helicopter Limitations:</strong> Despite solving many airplane problems, helicopters are expensive due to their mechanical complexity and power requirements.</li>
<li><strong>A Possible Autogyro Future:</strong>
<ul>
<li>With mass production and deregulation, autogyros could have become affordable by now.</li>
<li>Pitcairn PCA2: $15,000 in 1931, under $5,000 by the late 1930s.</li>
<li>Autogyros could have enabled widespread private landing strips and facilitated helicopter development.</li>
<li>Eastern Airlines used mail-carrying autogyros from the Philadelphia Post Office rooftop in the 1930s.</li>
</ul></li>
<li><strong>Ideal Flying Car Specs (Travel Theory):</strong> 5 minutes overhead, 250 knots speed (worth 5 times a car).</li>
<li><strong>Power Requirements for 250 Knots:</strong>
<ul>
<li>Need horsepower between 0.15 and 0.25 times the aircraft weight in pounds.</li>
<li>Estimated 600 horsepower needed for a 3,000-pound vehicle (2,000-pound empty weight, 1,000-pound payload).</li>
</ul></li>
<li><strong>Piston Engines vs.&nbsp;Turbines:</strong>
<ul>
<li>Piston engines are too heavy for this application (a 600 hp engine weighs around 900 pounds).</li>
<li>Turbines offer a much higher power-to-weight ratio (e.g., Lycoming Honeywell LTS 101-650C: 675 hp, 241 pounds).</li>
</ul></li>
<li><strong>The Turbine Advantage:</strong>
<ul>
<li>High power-to-weight ratio.</li>
<li>Higher reliability (10,000-hour overhaul interval vs.&nbsp;2,000 for piston engines).</li>
</ul></li>
<li><strong>Turbine Cost:</strong> Expensive, but potentially within reach if mass production and innovation had continued.</li>
<li><strong>Potential for Turbine-Powered Flying Cars:</strong>
<ul>
<li>Could have achieved car-like adoption levels in a non-stagnated present with higher incomes.</li>
</ul></li>
<li><strong>Futurist Predictions:</strong> Flying cars of the future were envisioned with turbines, enabling both VTOL and high speeds.</li>
</ul>
</section>
<section id="the-vtol-dilemma-and-potential-solutions" class="level3">
<h3 class="anchored" data-anchor-id="the-vtol-dilemma-and-potential-solutions">The VTOL Dilemma and Potential Solutions</h3>
<section id="the-vtol-trade-off" class="level4">
<h4 class="anchored" data-anchor-id="the-vtol-trade-off">The VTOL Trade-off</h4>
<ul>
<li>Fast aircraft are generally not VTOL, and VTOL aircraft are generally not fast.</li>
<li><strong>Power Consumption:</strong>
<ul>
<li>Turbines use a lot of fuel because they produce a lot of power.</li>
<li>Power requirements increase with the cube of speed.</li>
<li>VTOL requires significant power for hovering, leading to high fuel consumption per mile.</li>
</ul></li>
<li><strong>Design Dilemma:</strong> Choosing between speed and VTOL capability.</li>
</ul>
</section>
<section id="quadcopter-vtol-example" class="level4">
<h4 class="anchored" data-anchor-id="quadcopter-vtol-example">Quadcopter VTOL Example</h4>
<ul>
<li>Four 10-foot propellers (total disc area: 314 sq ft).</li>
<li>3,000-pound car (requires 6,000 pounds of thrust for safe VTOL).</li>
<li>Disc loading: 19 pounds per sq ft.</li>
<li>Lift capacity: 6 pounds per horsepower.</li>
<li>Required horsepower: 1,000.</li>
<li>Helicopters use more thrust area and don’t follow quadcopter peak power guidelines due to differences in rotor design and energy storage.</li>
</ul>
</section>
<section id="solutions-to-the-vtol-dilemma" class="level4">
<h4 class="anchored" data-anchor-id="solutions-to-the-vtol-dilemma">Solutions to the VTOL Dilemma</h4>
<ol type="1">
<li><strong>High-Powered Jets:</strong>
<ul>
<li>Use powerful jets for both lift and forward thrust (e.g., Harrier).</li>
<li>Inefficient at low speeds, high fuel consumption.</li>
</ul></li>
<li><strong>Tilt Rotor/Ducted Fan:</strong>
<ul>
<li>Compromise using prop rotors or tilting ducted fans for both takeoff and cruise (e.g., V-22 Osprey, Joby Aviation VTOL Air Taxi).</li>
<li>Variable-pitch propeller blades enhance efficiency.</li>
</ul></li>
<li><strong>Separate Lift and Cruise Fans:</strong>
<ul>
<li>Lift fans pose a drag challenge in forward flight.</li>
<li>Retracting mechanisms add complexity.</li>
<li><strong>Ryan XV-5 (1960s):</strong> Experimental design with lift fans inside the wings, covered by lids in forward flight.</li>
</ul></li>
</ol>
</section>
</section>
<section id="the-convertible-jet-car-and-its-challenges" class="level3">
<h3 class="anchored" data-anchor-id="the-convertible-jet-car-and-its-challenges">The Convertible Jet Car and Its Challenges</h3>
<section id="potential-of-the-convertible-jet-car" class="level4">
<h4 class="anchored" data-anchor-id="potential-of-the-convertible-jet-car">Potential of the Convertible Jet Car</h4>
<ul>
<li>The Ryan XV-5 offers high theoretical value (7 times that of a car) but faces manufacturing cost challenges.</li>
<li>A jet-powered convertible is potentially feasible in a non-stagnated present.</li>
<li>Would integrate well with existing road and airspace systems.</li>
<li>Offers the most value for longer, high-speed trips.</li>
<li>Example: 300-knot convertible (similar to Cirrus Vision Jet) with 20-minute airport drive would be worth 5 times a car.</li>
</ul>
</section>
<section id="challenges-of-the-convertible-jet-car" class="level4">
<h4 class="anchored" data-anchor-id="challenges-of-the-convertible-jet-car">Challenges of the Convertible Jet Car</h4>
<ol type="1">
<li><strong>Piloting Difficulty:</strong>
<ul>
<li>Jets are generally easier to fly than propeller planes (no torque, no lift effects from power changes).</li>
<li>However, higher speeds require more advanced planning and maneuvering skills.</li>
</ul></li>
<li><strong>Airport Congestion:</strong>
<ul>
<li>Increased jet car usage could lead to airport backups, increasing travel latency and reducing the value proposition.</li>
</ul></li>
</ol>
</section>
</section>
<section id="the-quad-gyro-a-promising-compromise" class="level3">
<h3 class="anchored" data-anchor-id="the-quad-gyro-a-promising-compromise">The Quad Gyro: A Promising Compromise</h3>
<section id="advantages-of-rotorcraft" class="level4">
<h4 class="anchored" data-anchor-id="advantages-of-rotorcraft">Advantages of Rotorcraft</h4>
<ul>
<li><strong>Landing Flexibility:</strong> Can land in more places than fixed-wing aircraft.</li>
<li><strong>Weather Resilience:</strong> Less affected by gusty winds and fog.</li>
</ul>
</section>
<section id="the-quad-gyro-concept" class="level4">
<h4 class="anchored" data-anchor-id="the-quad-gyro-concept">The Quad Gyro Concept</h4>
<ul>
<li>Combines advantages of autogyros and quadcopters.</li>
<li>Optimized for forward flight with pusher propellers.</li>
<li>Electric motors in the hubs replace lead bars for momentum and energy storage.</li>
<li>Benefits of the Quadcopter Design:
<ul>
<li>Separate or mixed tilt control for hubs.</li>
<li>Quick response to gusts for a smoother ride.</li>
</ul></li>
<li>Power Requirements:
<ul>
<li>Lower power needed due to autogyro design (around 250 hp).</li>
<li>Piston engine or turbine generator possible.</li>
</ul></li>
<li>Enhanced Autorotation: Motors assist takeoff and shorten takeoff roll.</li>
<li>Landing: Requires minimal space (50-foot circle).</li>
<li>Increased Efficiency: Motors supplement autorotation, allowing for faster flight.</li>
<li>Potential Speed: Could achieve 150 mph.</li>
</ul>
</section>
<section id="cost-and-value" class="level4">
<h4 class="anchored" data-anchor-id="cost-and-value">Cost and Value</h4>
<ul>
<li>Estimated cost: Three times the price of a high-end car.</li>
<li>Estimated value: Three times the value of a car.</li>
<li>Multi-fan tilt rotors (e.g., Joby) offer even higher value (four times that of a car).</li>
</ul>
</section>
<section id="provisos-for-quad-gyro-and-multi-fan-tilt-rotors" class="level4">
<h4 class="anchored" data-anchor-id="provisos-for-quad-gyro-and-multi-fan-tilt-rotors">Provisos for Quad Gyro and Multi-fan Tilt Rotors</h4>
<ol type="1">
<li><strong>Stability in Gusty Wind:</strong> Susceptibility needs further investigation.</li>
<li><strong>Power Source and Range:</strong>
<ul>
<li>Joby’s claimed 150-mile range for its battery-powered craft limits its value, especially for longer trips.</li>
<li>Turbine generators, fuel cells, and ultimately non-chemical power sources are needed for these vehicles to reach their full potential.</li>
</ul></li>
</ol>
</section>
</section>
</section>
<section id="chapter-11-the-atomic-age" class="level2">
<h2 class="anchored" data-anchor-id="chapter-11-the-atomic-age">Chapter 11: The Atomic Age</h2>
<section id="the-dream-of-abundant-energy" class="level3">
<h3 class="anchored" data-anchor-id="the-dream-of-abundant-energy">The Dream of Abundant Energy</h3>
<ul>
<li><strong>The Atomic Age Promise:</strong> The latter half of the 20th century saw tremendous advancements in information technology, but progress in energy technology seemed to stagnate.</li>
<li><strong>The Henry Adams Curve:</strong> Historical trends show that societal progress and optimism are linked to increasing energy availability.
<ul>
<li>This is not tied to a specific energy source (wood, coal, oil transitions have occurred).</li>
</ul></li>
<li><strong>Science Fiction’s Vision:</strong> Science fiction authors, unlike many in the real world, recognized the potential of nuclear energy as the next major energy source (e.g., H.G. Wells, E.E. Smith, Heinlein, Asimov).</li>
<li><strong>Asimov’s Prediction:</strong> “The appliances of 2014 will have no electric cords, of course, for they will be powered by long-lived batteries running on radioisotopes.” (Isaac Asimov)</li>
</ul>
</section>
<section id="the-case-for-nuclear-power" class="level3">
<h3 class="anchored" data-anchor-id="the-case-for-nuclear-power">The Case for Nuclear Power</h3>
<section id="energy-density-and-cost-comparison" class="level4">
<h4 class="anchored" data-anchor-id="energy-density-and-cost-comparison">Energy Density and Cost Comparison</h4>
<ul>
<li><strong>Jet Fuel Example (Boeing 747-400):</strong>
<ul>
<li>Fuel capacity: 57,285 gallons</li>
<li>Equivalent to 114 years of gasoline consumption for the average American (500 gallons/year).</li>
<li>Fuel weight: 194.6 tons</li>
<li>Energy produced: 7.5 terajoules (TJ)</li>
<li>Fuel cost: $343,710 (at $6/gallon)</li>
</ul></li>
<li><strong>Uranium Fission Equivalent:</strong>
<ul>
<li>Amount of uranium needed for 7.5 TJ: 94.3 grams (3.3 ounces)</li>
<li>Cost of uranium: $8.66 (based on $49.50/pound for yellowcake U-308, with 84.8% uranium content).</li>
</ul></li>
<li><strong>Energy Cost Comparison:</strong>
<ul>
<li><strong>Terajoule Definition:</strong> A terajoule is the amount of energy the average American uses in all forms (including manufacturing, shipping, military) over about three years.</li>
<li><strong>Consumer vs.&nbsp;Commodity Prices:</strong> Consumer retail energy prices are generally about five times higher than commodity prices for the raw fuel (except for gasoline).</li>
<li><strong>Uranium Price Markup:</strong> Uranium has a higher markup (around 30x) due to isotopic enrichment.</li>
<li><strong>Thorium Potential:</strong> A thorium fuel cycle could reduce uranium costs by a factor of 10.</li>
<li><strong>Average Annual Energy Cost:</strong>
<ul>
<li>Chemical fuels: $6,553</li>
<li>Nuclear: $5.80</li>
</ul></li>
</ul></li>
<li><strong>“Too Cheap to Meter”:</strong> Early in the atomic age, some believed nuclear electricity might be so cheap that metering wouldn’t be necessary.
<ul>
<li><strong>Marginal Price vs.&nbsp;Absolute Price:</strong> Metering decisions are based on the marginal cost (cost to produce one more kilowatt-hour) rather than the absolute price.</li>
</ul></li>
</ul>
</section>
<section id="the-stalled-nuclear-revolution" class="level4">
<h4 class="anchored" data-anchor-id="the-stalled-nuclear-revolution">The Stalled Nuclear Revolution</h4>
<ul>
<li><strong>Historical Energy Transitions:</strong> The 20th century saw transitions from wood to coal, then to oil and natural gas. Nuclear power started its growth around 1960 but stalled by 1975.</li>
<li><strong>Potential Growth Curve:</strong> If nuclear power had followed the same growth trajectory as natural gas from 1920 to 1970, it could be the dominant source of electricity today.</li>
<li><strong>Nuclear Fuel Efficiency:</strong> Nuclear fuels generate 1 million to 10 million times more energy per weight than chemical fuels, requiring less raw material extraction and producing less waste.</li>
<li><strong>Wind Turbine Comparison:</strong> A wind turbine uses more lubricating oil than a nuclear plant uses uranium per kilowatt-hour generated.</li>
</ul>
</section>
<section id="headroom-for-improvement" class="level4">
<h4 class="anchored" data-anchor-id="headroom-for-improvement">Headroom for Improvement</h4>
<ul>
<li><strong>Molten Salt Reactors (MSR) and Integral Fast Reactors (IFR):</strong> These designs, using thorium and uranium-plutonium alloys respectively, could achieve 99% fuel burn-up, significantly improving efficiency and reducing waste compared to 1960s designs.</li>
<li><strong>Oak Ridge MSR Project:</strong> A molten salt reactor operated at Oak Ridge for about a year but was canceled by Richard Nixon.</li>
<li><strong>Advantages of Thorium Reactors (as noted by Fortune magazine, February 2015):</strong>
<ul>
<li>Meltdown-proof</li>
<li>Less long-lived waste</li>
<li>More difficult to weaponize waste</li>
<li>Operates at safer atmospheric pressure</li>
<li>Higher operating temperatures, making them more efficient</li>
<li>No enrichment step needed</li>
<li>Higher fuel utilization (nearly 100% vs.&nbsp;less than 1% for uranium reactors)</li>
<li>Thorium is 3-4 times more abundant than uranium.</li>
</ul></li>
<li><strong>Fuel Reserves:</strong>
<ul>
<li>Proven uranium reserves: 77 years of global power</li>
<li>Proven thorium reserves: 6,472 years of global power</li>
</ul></li>
<li><strong>Additional Thorium Reactor Advantages:</strong>
<ul>
<li>Proliferation resistance (difficult to divert fuel for weapons)</li>
<li>Walk-away safety (passive cooling system using frozen salt plug that melts in case of failure).</li>
</ul></li>
</ul>
</section>
<section id="potential-for-future-reactors" class="level4">
<h4 class="anchored" data-anchor-id="potential-for-future-reactors">Potential for Future Reactors</h4>
<ul>
<li><strong>Efficiency Gains:</strong> With continued development, it’s estimated that we could get 100 times more power from each ton of nuclear fuel.</li>
</ul>
</section>
</section>
<section id="the-obstacle-of-radiophobia" class="level3">
<h3 class="anchored" data-anchor-id="the-obstacle-of-radiophobia">The Obstacle of Radiophobia</h3>
<section id="the-fukushima-disaster-a-case-study" class="level4">
<h4 class="anchored" data-anchor-id="the-fukushima-disaster-a-case-study">The Fukushima Disaster: A Case Study</h4>
<ul>
<li><strong>Impact of Earthquake and Tsunami (2011):</strong>
<ul>
<li>Deaths: ~16,000 (mostly from drowning)</li>
<li>Injuries: 6,000</li>
<li>Missing: 2,500</li>
<li>Homeless: 250,000</li>
<li>Building damage: Extensive</li>
</ul></li>
<li><strong>Fukushima Power Plant Damage:</strong> The disaster caused damage to the power plant, leading to the release of radioactive materials.</li>
<li><strong>Radiation-Related Deaths and Injuries:</strong> Zero</li>
<li><strong>UNSCEAR Report (2021):</strong> “No adverse health effects among Fukushima residents have been documented that could be directly attributed to radiation exposure,” and further delayed effects are unlikely.</li>
<li><strong>Media Coverage Bias:</strong> News coverage heavily focused on the power plant incident, overshadowing the far greater human toll from the earthquake and tsunami.</li>
<li><strong>Evacuation Consequences:</strong>
<ul>
<li>Approximately 100,000 people were evacuated from the Fukushima area.</li>
<li>Radiation levels in the evacuated area were comparable to natural background radiation in Finland.</li>
<li>Around 1,600 evacuees died from various causes, including privation and suicide.</li>
</ul></li>
<li><strong>Fukushima Plume Area:</strong>
<ul>
<li>Radiation doses in most of the release area were less than the dose from a couple of CT scans in a year (2011 data).</li>
<li>By 2012, radiation levels had significantly decreased.</li>
</ul></li>
</ul>
</section>
<section id="the-cost-of-fear" class="level4">
<h4 class="anchored" data-anchor-id="the-cost-of-fear">The Cost of Fear</h4>
<ul>
<li><strong>Nuclear Power Safety Record:</strong> Nuclear power is statistically the cleanest and safest form of large-scale energy generation, even with older reactor designs.</li>
<li><strong>Clean Air Act Benefits:</strong> The Clean Air Act, which reduced coal-fired pollution, saved over 50,000 lives per year in the U.S.</li>
<li><strong>Missed Opportunity:</strong> If the environmental movement had focused on promoting nuclear power instead of opposing it, pollution-related deaths and CO2 emissions could have been dramatically reduced.</li>
<li><strong>Misinformation and Public Perception:</strong> Activists spread the false claim that nuclear power plants could explode like atom bombs.
<ul>
<li><strong>Post-Three Mile Island Poll:</strong> 66% of Americans believed a power reactor could explode like an atomic bomb.</li>
<li><strong>Reactor Explosions: Why They Can’t Happen:</strong>
<ul>
<li>Explosive chain reactions require unmoderated critical mass with 80%+ enrichment.</li>
<li>Power reactors use moderated reactions with only 3% enriched uranium.</li>
</ul></li>
</ul></li>
<li><strong>Energy Poverty Deaths:</strong> An estimated 28,000 U.S. residents die annually from cold due to energy poverty (primarily affecting the poor).</li>
<li><strong>Potential Lives Saved:</strong> Wider deployment of nuclear power could have saved around a million lives over the past 25 years.</li>
</ul>
</section>
<section id="proliferation-concerns" class="level4">
<h4 class="anchored" data-anchor-id="proliferation-concerns">Proliferation Concerns</h4>
<ul>
<li><strong>Weaponization of Reactor-Grade Uranium:</strong> The risk of rogue states or terrorists obtaining nuclear material from power reactors is exaggerated.
<ul>
<li>Enriching reactor-grade uranium (3%) to weapons-grade (80%) requires significant resources and effort, comparable to refining it from natural uranium.</li>
<li>Nations with nuclear ambitions are closely monitored.</li>
</ul></li>
<li><strong>Small Modular Reactors (SMRs):</strong> SMRs, which are factory-built, self-contained, and buried, would further reduce the risk of proliferation.</li>
</ul>
</section>
<section id="the-regulatory-burden" class="level4">
<h4 class="anchored" data-anchor-id="the-regulatory-burden">The Regulatory Burden</h4>
<ul>
<li><strong>Impact of Regulation on Nuclear Power Costs:</strong> Excessive regulations have drastically increased the cost of nuclear power plants.</li>
<li><strong>Speed Limit Analogy:</strong> Regulating nuclear power based on extreme safety standards is like setting a speed limit of 1 mph because people have been injured at 100 mph.</li>
<li><strong>Peter Lang’s Study:</strong>
<ul>
<li>During the 1950s and 60s, the cost of nuclear plants decreased by 25% with each doubling of capacity.</li>
<li>This trend reversed after increased regulation.</li>
<li>If the trend had continued, the price of nuclear power could be 10% of its current level (2020).</li>
<li>Coal generation could have been largely replaced by nuclear by 2000.</li>
<li>Millions of deaths and gigatons of CO2 emissions could have been avoided.</li>
</ul></li>
<li><strong>Suppression of Innovation:</strong> The high cost and regulatory burden stifle innovation in the nuclear industry.
<ul>
<li>Cheryl Green (Oak Ridge): The current environment is hostile to innovation due to regulations, high costs, and risk aversion.</li>
</ul></li>
<li><strong>Lack of R&amp;D Investment:</strong> The nuclear industry invests less in R&amp;D as a percentage of revenue than most other major industries.</li>
<li><strong>The U.S. Navy Exception:</strong> The U.S. Navy’s successful nuclear program demonstrates that a strong, accountable leadership can overcome bureaucratic obstacles.
<ul>
<li>Over 6,000 reactor years of accident-free operation.</li>
<li>526 reactor cores built.</li>
<li>86 nuclear-powered vessels in use.</li>
</ul></li>
<li><strong>Historical Cost and Potential Savings:</strong>
<ul>
<li>Pre-regulatory cost of nuclear power: $1,175/kilowatt.</li>
<li>Had the Henry Adams curve continued, a 2% annual increase in per capita power consumption (10 kW average) would have required a $235 investment per year.</li>
<li>With continued learning, new capacity could now cost $495/kilowatt.</li>
<li>A 2% annual increase in the average American’s 25 kW consumption would cost less than $250.</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-great-physics-stagnation" class="level3">
<h3 class="anchored" data-anchor-id="the-great-physics-stagnation">The Great Physics Stagnation</h3>
<section id="decline-in-nuclear-physics-research" class="level4">
<h4 class="anchored" data-anchor-id="decline-in-nuclear-physics-research">Decline in Nuclear Physics Research</h4>
<ul>
<li><strong>Public Awareness vs.&nbsp;Scientific Understanding:</strong> Despite the political prominence of nuclear issues, there is a lack of public understanding of nuclear physics.</li>
<li><strong>Limited Availability of Current Literature:</strong> Bookstores have a scarcity of recent texts on nuclear physics, with many older books being reprinted without updates.</li>
<li><strong>Norman Cook’s Observation:</strong> Nuclear physics lacks a unified theoretical framework comparable to quantum electrodynamics in atomic physics. This necessitates a phenomenological approach with separate formulations for different nuclear phenomena.</li>
<li><strong>Used Bookstore Experience:</strong> A search in a well-stocked used bookstore revealed only three books on nuclear physics, the most recent being from 1991. This indicates a decline in interest and demand for the subject.</li>
<li><strong>Declining PhDs in Nuclear Physics:</strong> The number of PhDs awarded in nuclear physics has decreased significantly since the 1970s, reflecting limited career prospects.</li>
<li><strong>Consequences of Stagnation:</strong>
<ul>
<li>Most operating reactors are still based on 1960s Generation 2 pressurized water designs.</li>
<li>A shrinking field becomes more political, resistant to change (Machiavelli effect), and less likely to produce breakthroughs.</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-anti-abundance-mindset" class="level3">
<h3 class="anchored" data-anchor-id="the-anti-abundance-mindset">The Anti-Abundance Mindset</h3>
<section id="opposition-to-cheap-clean-energy" class="level4">
<h4 class="anchored" data-anchor-id="opposition-to-cheap-clean-energy">Opposition to Cheap, Clean Energy</h4>
<ul>
<li><strong>Quotes from Green Activists:</strong>
<ul>
<li>“The prospect of cheap fusion energy is the worst thing that could happen to the planet.” (Jeremy Rifkin)</li>
<li>“Giving society cheap, abundant energy would be the equivalent of giving an idiot child a machine gun.” (Paul Ehrlich)</li>
<li>“It would be little short of disastrous for us to discover a source of clean, cheap, abundant energy because of what we might do with it.” (Amory Lovins)</li>
</ul></li>
<li><strong>History of Energy Source Attacks:</strong> Green activists have consistently attacked various sources of energy, including:
<ul>
<li>Coal: Despite its role in industrialization and improving living standards.</li>
<li>Oil: The foundation of modern transportation and industry.</li>
<li>Hydropower, nuclear fission, natural gas: Have all faced opposition.</li>
</ul></li>
<li><strong>Renewables Exception:</strong> Renewables like wind and solar have largely escaped criticism, but this is because they currently lack the capacity to meet society’s energy needs at an affordable price.</li>
<li><strong>The True Motive:</strong> The underlying motivation behind these attacks is not solely about environmental concerns but also about controlling human impact on the environment. Green agonists view the ability to alter the Earth as inherently negative.</li>
</ul>
</section>
<section id="fusions-potential-and-future-opposition" class="level4">
<h4 class="anchored" data-anchor-id="fusions-potential-and-future-opposition">Fusion’s Potential and Future Opposition</h4>
<ul>
<li><strong>Fusion as a “Future” Energy Source:</strong> Fusion has been perpetually “20 years away,” allowing it to avoid serious scrutiny.</li>
<li><strong>Cold Fusion and the Unveiling of Opposition:</strong> The brief excitement around cold fusion revealed the true anti-abundance stance of some activists.</li>
<li><strong>Fission vs.&nbsp;Fusion:</strong> Fusion might have offered advantages in terms of reactor size and cost, but its current leading project (ITER) is massive and expensive.</li>
<li><strong>Predicted Opposition to Fusion:</strong> If fusion becomes viable, it will likely face the same exaggerated safety and environmental concerns that have been used to suppress fission.</li>
</ul>
</section>
<section id="a-call-to-action-for-energy-innovators" class="level4">
<h4 class="anchored" data-anchor-id="a-call-to-action-for-energy-innovators">A Call to Action for Energy Innovators</h4>
<ul>
<li><strong>Challenges for Energy Pioneers:</strong> Technologists working on new energy sources should expect strong opposition if they succeed.</li>
<li><strong>The Real Rewards:</strong> Despite the challenges, the potential to improve human lives through abundant, clean energy is a worthy goal.</li>
</ul>
</section>
</section>
<section id="conclusion-2" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-2">Conclusion</h3>
<ul>
<li><strong>Missed Opportunities:</strong> Progress in nuclear power and other advanced energy technologies has been stifled by fear, misinformation, and excessive regulation.</li>
<li><strong>The Link Between Energy and Progress:</strong> Cheap, abundant energy is essential for economic growth, poverty reduction, and improving living standards.</li>
<li><strong>Arthur C. Clarke’s Warnings:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“In this inconceivably enormous universe, we can never run out of energy or matter, but we can all too easily run out of brains.”</p>
</blockquote></li>
<li><blockquote class="blockquote">
<p>“If, as is perfectly possible, we are short of energy two generations from now, it will be through our own incompetence. We will be like stone-age men freezing to death on top of a coal bed.”</p>
</blockquote></li>
</ul></li>
<li><strong>The Great Stagnation:</strong> The stagnation in energy technology is a major factor contributing to broader societal stagnation.</li>
<li><strong>The Need for Rationality and Courage:</strong> Overcoming the obstacles to progress requires overcoming irrational fears, promoting scientific literacy, and adopting a more sensible approach to regulation.</li>
</ul>
</section>
</section>
<section id="chapter-12-when-worlds-collide" class="level2">
<h2 class="anchored" data-anchor-id="chapter-12-when-worlds-collide">Chapter 12: When Worlds Collide</h2>
<section id="the-urgency-of-time-and-the-feynman-path" class="level3">
<h3 class="anchored" data-anchor-id="the-urgency-of-time-and-the-feynman-path">The Urgency of Time and the Feynman Path</h3>
<ul>
<li><strong>The Feynman Path:</strong> A concept proposed by Richard Feynman in his 1959 lecture “Plenty of Room at the Bottom,” suggesting a top-down approach to <strong>nanotechnology</strong> by building progressively smaller machine shops, each capable of creating a smaller copy of itself, eventually reaching the molecular scale.
<ul>
<li>This path aims to establish a broad-based industrial capability at the atomic scale.</li>
<li>It emphasizes the importance of <strong>atomic precision</strong> in fabrication.</li>
</ul></li>
<li><strong>Historical Context:</strong>
<ul>
<li>The 1950s and the space race instilled a sense of urgency in technological development, exemplified by projects like the Manhattan Project and the Apollo program.</li>
<li>This urgency has since diminished, leading to stagnation in fields like nanotechnology.</li>
</ul></li>
<li><strong>The Foresight Institute’s Battelle Roadmap to Productive Nanosystems:</strong>
<ul>
<li>An attempt to guide nanotechnology research towards Feynman’s and Drexler’s original vision of atomically precise manufacturing.</li>
<li>Focused on techniques producing atomically precise products, excluding broader approaches like the Feynman path.</li>
</ul></li>
<li><strong>Feynman’s Vision:</strong>
<ul>
<li>Build an automated machine shop, operable by remote control.</li>
<li>Capable of building a complete working copy of itself at its own scale and a smaller scale.</li>
<li>The challenge lies in fabricating parts with better tolerances than the machine itself.</li>
<li>The ultimate goal is to reach molecular manipulation capabilities through iterative miniaturization.</li>
</ul></li>
</ul>
</section>
<section id="obstacles-and-misconceptions" class="level3">
<h3 class="anchored" data-anchor-id="obstacles-and-misconceptions">Obstacles and Misconceptions</h3>
<ul>
<li><strong>The Giggle Factor:</strong> A common reaction of skepticism and dismissal towards the idea of macro-scale self-replicating machines (<strong>SRMs</strong>).
<ul>
<li>This stems from the intuition that factories are inherently larger and more complex than their products (e.g., a car factory vs.&nbsp;a car).</li>
<li>The Feynman path challenges this intuition by proposing machines that can build copies of themselves.</li>
</ul></li>
<li><strong>Skepticism about Self-Replication:</strong>
<ul>
<li><strong>George Friedman</strong>, engineering professor at USC, highlighted the lack of self-replicating machines despite the perceived simplicity of biological self-replication.</li>
<li><strong>Mark Reed</strong>, Yale nanotech researcher, expressed skepticism about the self-replication capabilities of machines built with atomically-sized parts.</li>
</ul></li>
<li><strong>Challenges in SRM Design:</strong>
<ul>
<li>SRMs defy standard top-down design methodologies, as the product (the machine itself) is unknown until the design is complete.</li>
<li>Many SRM designs either:
<ul>
<li>Oversimplify construction capabilities by relying on pre-made complex subsystems.</li>
<li>Become overly complex by incorporating capabilities like mining and refining raw materials (e.g., the 1980 NASA moon base study).</li>
</ul></li>
</ul></li>
<li><strong>The Misconception of MEMS as a Failed Feynman Path:</strong>
<ul>
<li><strong>MEMS (Micro-Electro-Mechanical Systems):</strong> A technology for creating micromachines using photolithography (similar to integrated circuit manufacturing).</li>
<li>While MEMS allows for the creation of incredibly small machines, their <strong>relative tolerances</strong> (accuracy of fabrication relative to size) are significantly lower than those achieved in traditional machining.
<ul>
<li>Standard machining: Relative tolerances of one in a million.</li>
<li>MEMS: Relative tolerances of one in one hundred.</li>
</ul></li>
<li>This leads to issues like <strong>stiction</strong> (super-friction), hindering the creation of complex mechanisms like bearings, gears, and screws.</li>
</ul></li>
<li><strong>Feynman’s Emphasis on Precision:</strong>
<ul>
<li>Feynman recognized the need for improving precision at each stage of miniaturization.</li>
<li>He proposed techniques like lapping and polishing to achieve higher tolerances at smaller scales.</li>
<li>This iterative improvement of precision is crucial for achieving the Feynman path’s goals.</li>
</ul></li>
</ul>
</section>
<section id="the-potential-of-the-feynman-path" class="level3">
<h3 class="anchored" data-anchor-id="the-potential-of-the-feynman-path">The Potential of the Feynman Path</h3>
<ul>
<li><strong>Benefits of a MEMS-scale Machine Shop:</strong>
<ul>
<li>Even a millimeter-sized system with 10-micron parts, built using the Feynman path, would have immense value, particularly in medical applications.</li>
<li><strong>Example:</strong> The COVID-19 pandemic highlighted the need for high-throughput microfluidic devices (like <strong>ILINPs</strong>) for vaccine manufacturing. A Feynman path approach could have significantly accelerated their production.</li>
</ul></li>
<li><strong>Synergy with Bottom-Up Approaches:</strong>
<ul>
<li>The Feynman path and bottom-up approaches (e.g., chemistry, molecular biology, DNA origami) are not mutually exclusive.</li>
<li>They can complement each other, with bottom-up methods producing atomically precise parts and top-down methods assembling them.</li>
<li><strong>Example:</strong> Nanoscientists creating atomically precise nanogears could be utilized directly by Feynman-Path machines.</li>
</ul></li>
<li><strong>Accelerated Timeline for Nanotech:</strong>
<ul>
<li>Pursuing the Feynman path alongside bottom-up approaches could potentially cut the development time for “real nanotech” from 20 years to 10 years.</li>
</ul></li>
</ul>
</section>
<section id="key-questions-and-challenges" class="level3">
<h3 class="anchored" data-anchor-id="key-questions-and-challenges">Key Questions and Challenges</h3>
<ul>
<li><strong>Feasibility of Compact Macro-scale SRMs:</strong>
<ul>
<li>Can a compact, self-replicating machine be built using macroscopic parts and standard fabrication techniques?</li>
<li>We know that non-compact (global industrial infrastructure) and compact microscopic (bacteria) replicators exist, but the macro-scale compact case remains unexplored.</li>
</ul></li>
<li><strong>“Cheating” with Vitamins:</strong>
<ul>
<li>What external resources (“vitamins”) can be legitimately provided to the system at various scales?</li>
<li>Examples: control signals, pre-synthesized molecular gears, single-crystal materials, advanced surface treatment techniques.</li>
</ul></li>
<li><strong>Roadblocks and Phase Changes:</strong>
<ul>
<li>What are the specific challenges and fundamental shifts in physics that will be encountered during miniaturization?</li>
<li><strong>Examples:</strong>
<ul>
<li><strong>Motor Scaling:</strong> Transition from electromagnetic motors (poor at small scales) to electrostatic motors.</li>
<li><strong>Ontological Phase Boundary:</strong> Shift from continuous materials to discrete atoms.</li>
<li><strong>Changes in Physics:</strong>
<ul>
<li>Diminishing gravity.</li>
<li>Increased adhesion (stiction).</li>
<li>Loss of fluid lubrication.</li>
<li>Decreased stiffness of materials.</li>
<li>Quantum tunneling of hydrogen atoms.</li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Forming Techniques:</strong>
<ul>
<li>What methods can be used to shape and assemble materials at different scales?</li>
<li><strong>Additive Manufacturing (3D Printing):</strong>
<ul>
<li>Likely to play a major role across a wide range of scales.</li>
<li>Macro-scale: Melting and depositing materials drop by drop.</li>
<li>Smaller scales: Electrodeposition and electroremoval.</li>
<li>Nanoscale: Atomically precise deposition and removal techniques.</li>
</ul></li>
</ul></li>
<li><strong>Visualization and Measurement:</strong>
<ul>
<li>How can we observe and measure the fabrication process at smaller scales?</li>
<li><strong>Scanning Probes:</strong> Limited by their ability to operate on relatively flat surfaces.</li>
<li><strong>Physical Surface Scanners:</strong> Likely to be necessary, drawing inspiration from existing contact measurement techniques in machining.</li>
</ul></li>
</ul>
</section>
<section id="plan-of-attack" class="level3">
<h3 class="anchored" data-anchor-id="plan-of-attack">Plan of Attack</h3>
<section id="the-difficult-immediate-goals" class="level4">
<h4 class="anchored" data-anchor-id="the-difficult-immediate-goals">The Difficult (Immediate Goals)</h4>
<ol type="1">
<li><strong>Design a Scalable SRM Workstation:</strong>
<ul>
<li>Develop a remotely operated workstation capable of manufacturing and manipulating parts, and replicating itself at its own scale and at one-quarter scale.</li>
<li>Utilize “vitamins” or external inputs as needed at different scales.</li>
</ul></li>
<li><strong>Macro-Scale Implementation:</strong>
<ul>
<li>Build a physical prototype of the architecture at desktop scale, using materials like plastic.</li>
<li>Include operator controls (not intended for replication).</li>
<li>Identify scaling challenges and potential roadblocks.</li>
<li>Determine appropriate scaling steps.</li>
</ul></li>
<li><strong>Simulation-Based Verification:</strong>
<ul>
<li>Use simulations to verify the scalability of the architecture through identified phase changes.</li>
<li><strong>Example:</strong> Simulate the transition from electromagnetic to electrostatic motors.</li>
</ul></li>
<li><strong>Develop a Roadmap:</strong>
<ul>
<li>Create a detailed and actionable roadmap for achieving the desired fabrication and manipulation techniques at the nanoscale.</li>
<li>Define the starting point based on current state-of-the-art fabrication technology, considering materials and scale.</li>
<li>The roadmap should guide the development of the actual scaling sequence.</li>
</ul></li>
</ol>
</section>
<section id="the-impossible-long-term-goals" class="level4">
<h4 class="anchored" data-anchor-id="the-impossible-long-term-goals">The Impossible (Long-Term Goals)</h4>
<ol type="1">
<li><strong>Identify the Optimal Starting Scale:</strong>
<ul>
<li>Determine the best scale for initiating the Feynman path based on available fabrication and assembly technology.</li>
<li>Consider the trade-off between building a smaller system directly or building a larger system capable of producing a smaller copy.</li>
<li><strong>Example:</strong> The Nippon Denso microcar (one-thousandth scale) demonstrates the feasibility of manipulating micron-scale parts. Advances in nanotechnology since 1994 likely enable even finer tolerances and roughnesses.</li>
</ul></li>
<li><strong>Additive Manufacturing Strategies:</strong>
<ul>
<li>Identify and develop appropriate additive manufacturing techniques for different scales.</li>
<li>Focus on deposition methods that can be adapted for progressively smaller feature sizes.</li>
</ul></li>
<li><strong>Addressing Tolerance Challenges:</strong>
<ul>
<li>Recognize that atomic-scale tolerances become crucial even at micron-scale part sizes.</li>
<li>Focus on surface forming and reforming techniques to achieve the required precision.</li>
<li>Design machine elements with flat bearing surfaces (e.g., thrust bearings, sliders) to leverage crystal planes until strained shell circular bearings become feasible.</li>
<li><strong>Example:</strong> Explore the use of multi-walled carbon nanotubes for such applications.</li>
</ul></li>
</ol>
</section>
</section>
<section id="the-future-of-additive-manufacturing-and-its-impact" class="level3">
<h3 class="anchored" data-anchor-id="the-future-of-additive-manufacturing-and-its-impact">The Future of Additive Manufacturing and its Impact</h3>
<ul>
<li><strong>H.G. Wells’ Vision:</strong>
<ul>
<li>Wells anticipated the revolutionary potential of additive manufacturing (3D printing), envisioning automated construction methods that surpass traditional building techniques.</li>
</ul></li>
<li><strong>Evolution of 3D Printing:</strong>
<ul>
<li>Future advancements will likely lead to:
<ul>
<li>Increased speed and lower cost of 3D printers.</li>
<li>Expanded range of printable materials.</li>
<li>Improved precision, enabling the creation of complex objects and machines.</li>
</ul></li>
</ul></li>
<li><strong>Economic and Social Consequences:</strong>
<ul>
<li>Similar to the computer revolution, nanomanufacturing could lead to:
<ul>
<li>Decentralization of production.</li>
<li>Increased personal autonomy and creativity.</li>
<li>A Cambrian explosion of new physical machines and applications, analogous to the growth of software applications.</li>
</ul></li>
</ul></li>
<li><strong>The Resurgence of the Industrial Revolution:</strong>
<ul>
<li>Nanotech has the potential to dramatically increase productivity, just as the Industrial Revolution did.</li>
<li><strong>Example:</strong> The cost of producing a woolen tunic today is significantly lower than it was in the year 300, thanks to machine-based manufacturing.</li>
</ul></li>
<li><strong>The Promise of Nanotech:</strong>
<ul>
<li>Nanotech could lead to another leap in productivity, enabling us to accomplish tasks in a day that currently take a year.</li>
<li>This could drastically reduce the cost of complex products like flying cars.</li>
</ul></li>
</ul>
</section>
<section id="conclusion-3" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-3">Conclusion</h3>
<ul>
<li>The Feynman path to nanotechnology, though largely unexplored, offers a promising route to achieving atomically precise manufacturing.</li>
<li>It complements bottom-up approaches and could potentially accelerate the development of nanotech.</li>
<li>Addressing the key questions and challenges outlined above is crucial for realizing Feynman’s vision.</li>
<li>The potential benefits of nanotech are vast, ranging from medical advancements to increased personal autonomy and a resurgence of the Industrial Revolution.</li>
<li>Taking Feynman’s path is a long and difficult program, but it is a possibility with immense potential to transform our future.</li>
</ul>
</section>
</section>
<section id="chapter-13-when-the-sleeper-wakes" class="level2">
<h2 class="anchored" data-anchor-id="chapter-13-when-the-sleeper-wakes">Chapter 13: When the Sleeper Wakes</h2>
<section id="the-unfulfilled-promise-of-future-technology" class="level3">
<h3 class="anchored" data-anchor-id="the-unfulfilled-promise-of-future-technology">The Unfulfilled Promise of Future Technology</h3>
<section id="science-fictions-role-and-the-kernel-of-truth" class="level4">
<h4 class="anchored" data-anchor-id="science-fictions-role-and-the-kernel-of-truth">Science Fiction’s Role and The Kernel of Truth</h4>
<ul>
<li>Science fiction emerged when humanity envisioned a future beyond its current limitations.</li>
<li><strong>Science fiction fans</strong>, unlike people of the past, believe their dreams have a <strong>kernel of truth</strong> and can be realized.</li>
<li>“The fantastic fiction of today may well become the fact of tomorrow.” - Sam Moskowitz, <em>The Immortal Storm</em></li>
</ul>
</section>
<section id="flying-cars-a-case-study-in-technological-stagnation" class="level4">
<h4 class="anchored" data-anchor-id="flying-cars-a-case-study-in-technological-stagnation">Flying Cars: A Case Study in Technological Stagnation</h4>
<ul>
<li>Flying cars, a frequent topic in discussions about the future, are <strong>technologically feasible</strong>.</li>
<li>They have been built and flown since the 1930s.
<ul>
<li>Example: The <strong>auto gyro</strong> had innovative design and funding but faced challenges during the Great Depression.</li>
</ul></li>
<li><strong>Obstacles to development:</strong>
<ul>
<li>1930s: Great Depression hampered marketing.</li>
<li>1940s: World War II diverted engineering talent and resources to war production.</li>
<li>1950s:
<ul>
<li><strong>Aircraft regulations caused delays in supply.</strong></li>
<li><strong>Investment in highways and infrastructure reduced demand.</strong></li>
<li>The government hindered Pickhairn’s efforts to develop flying cars.</li>
</ul></li>
<li>1960s:
<ul>
<li>Passenger jet travel and private aviation boomed.</li>
<li>Military developed <strong>VTOLs (Vertical Take-Off and Landing aircraft)</strong>, like air jeeps.</li>
</ul></li>
<li>1970s:
<ul>
<li>The <strong>Henry Adams Curve</strong>, representing long-term energy growth, <strong>flatlined</strong>, impacting technology dependent on energy.</li>
<li>Academia shifted towards virtue-signaling and self-deception, hindering technological advancement.</li>
<li>A “Baptists and bootleggers” alliance formed between those who believed in progressive policies and those who benefited from the associated funding and influence.</li>
<li>Public spending and PhDs tripled between 1960 and 1980.</li>
<li>The <strong>“war on cars”</strong> gained traction, leading to policies that discouraged car use.</li>
<li>Supersonic flight was banned.</li>
<li>Bridge building, which peaked in the 1960s, declined, leading to increased traffic congestion (five times worse than in the 1960s).</li>
</ul></li>
<li>Around 1980:
<ul>
<li><strong>Liability law developments crippled the private aviation industry.</strong></li>
<li><strong>Regulation increased significantly.</strong></li>
<li>Bureaucrats, unconcerned with costs, replaced those who balanced costs and benefits in decision-making.</li>
<li>The <strong>cost disease</strong> replaced the <strong>learning curve</strong> in the economy.</li>
<li>The nuclear industry faced escalating costs and stagnated.</li>
<li>Interest and research in nuclear physics declined.</li>
</ul></li>
</ul></li>
<li><strong>Green Fundamentalism</strong> became a dominant ideology, contributing to pessimism despite objective improvements in living standards.</li>
</ul>
</section>
<section id="the-missed-opportunities" class="level4">
<h4 class="anchored" data-anchor-id="the-missed-opportunities">The Missed Opportunities</h4>
<ul>
<li>Flying cars were achievable in 1950 if not for the Depression and World War II.</li>
<li>The <strong>Henry Adams Curve flatline</strong> is the proximate cause for their absence today.</li>
<li>Complacent naysayers and bureaucrats have stifled progress.</li>
</ul>
</section>
<section id="comparing-predictions-flying-cars-space-travel-and-nuclear-power" class="level4">
<h4 class="anchored" data-anchor-id="comparing-predictions-flying-cars-space-travel-and-nuclear-power">Comparing Predictions: Flying Cars, Space Travel, and Nuclear Power</h4>
<ul>
<li>Science fiction writers accurately predicted the technology for flying cars and nuclear power.</li>
<li>Their overestimation of <strong>fusion power</strong> was based on the opinions of experts at the time (estimated to be 50 years optimistic).</li>
<li><strong>Flying cars:</strong>
<ul>
<li>Development hindered by historical events, government actions, regulations, and liability concerns.</li>
</ul></li>
<li><strong>Space travel:</strong>
<ul>
<li>Received substantial government funding for military and prestige reasons.</li>
<li>Writers like <strong>Clark</strong> were overly optimistic about colonization, while <strong>Heinlein</strong> predicted a government takeover hostile to technology and a pause in space travel.</li>
</ul></li>
<li><strong>Nuclear power:</strong>
<ul>
<li>The Manhattan Project, while costly, did not yield economically beneficial technology like the B-29 project.</li>
<li>Military restrictions hindered private development of nuclear power.</li>
<li>It took decades for nuclear power to become economically viable, and then it was stifled by regulation.</li>
</ul></li>
<li><strong>Computing:</strong>
<ul>
<li>Experienced a <strong>phase change</strong> from centralized computing centers to decentralized personal computers.</li>
<li>Combined with the internet, it progressed as predicted by technological optimists.</li>
<li><strong>Asimov</strong> and <strong>Clark’s</strong> predictions about applications like robots and information access were largely accurate.</li>
<li>Ordering online and receiving quick delivery is similar to predictions by <strong>Nolan (1927)</strong> and <strong>Heinlein (1938).</strong></li>
</ul></li>
<li>Other technologies, particularly high-energy ones, remain in the centralized era. Example: Airline travel.</li>
</ul>
</section>
</section>
<section id="science-and-technological-progress-despite-stagnation" class="level3">
<h3 class="anchored" data-anchor-id="science-and-technological-progress-despite-stagnation">Science and Technological Progress Despite Stagnation</h3>
<ul>
<li><strong>Scientific knowledge has continued to advance:</strong>
<ul>
<li>Discovery of exoplanets and new bodies in our solar system.</li>
<li>Understanding of the molecular mechanisms of life and the human genome.</li>
<li>Mapping of the human brain.</li>
<li>Construction of neutrino telescopes and detection of neutrinos from the sun.</li>
<li>Detection of gravitational waves from a stellar collapse.</li>
</ul></li>
<li>Many unfulfilled technological predictions were due to misplaced faith in culture, governance, and information providers, not inaccurate technological foresight.</li>
<li>Resources were diverted towards academia and virtue-signaling instead of improving lives.</li>
</ul>
</section>
<section id="a-hypothetical-pro-technology-present" class="level3">
<h3 class="anchored" data-anchor-id="a-hypothetical-pro-technology-present">A Hypothetical Pro-Technology Present</h3>
<ul>
<li><strong>Scenario:</strong>
<ul>
<li>The best and brightest focused on science and engineering instead of activism and regulation.</li>
<li>Education, healthcare, and public works were not affected by the cost disease.</li>
<li>The private aircraft industry thrived.</li>
<li>The Henry Adams curve continued its upward trend.</li>
<li>Technology and quality of life continued to improve as in the previous 50 years.</li>
</ul></li>
<li><strong>Potential Outcomes:</strong>
<ul>
<li><strong>Increased wealth:</strong> Average American income would be four times higher (median $200,000 vs.&nbsp;$50,000 today).</li>
<li><strong>Wider homeownership:</strong> The top 50% of families could afford two homes, compared to the top 5% today.</li>
<li><strong>Shift in GDP composition:</strong> More focus on machines and less on paperwork.</li>
<li><strong>Reduced financial sector dominance:</strong> Its share of GDP has doubled since 1980, exceeding the energy sector.</li>
<li><strong>More efficient education and healthcare sectors:</strong> Similar outcomes as today, but at a lower cost.</li>
<li><strong>Advanced high-power and high-tech experience:</strong> Further progress in areas like turbine aero engines.</li>
</ul></li>
<li><strong>Decentralization and Urban Expansion:</strong>
<ul>
<li><strong>The Economist’s</strong> study on the economic history of cities (April 4, 2015) highlights the impact of transportation costs on city growth.</li>
<li><strong>Declining transportation costs</strong>, especially time costs, would have spurred continued expansion into exurbs.</li>
<li>A flight-based transportation system would expand the reach of urban centers and make rural living more viable.</li>
<li>Businesses could be located almost anywhere.</li>
</ul></li>
<li><strong>Mountainside Living:</strong>
<ul>
<li>Economical mountainside living without roads or physical utilities would become possible.</li>
<li><strong>Helicopter deliveries</strong> and <strong>personal VTOLs</strong> would address transportation needs.</li>
<li><strong>Telecommunications</strong> are already readily available.</li>
<li><strong>Power options:</strong>
<ul>
<li><strong>Solar power with batteries.</strong></li>
<li><strong>Fuel cells fed by delivered fuel.</strong></li>
<li><strong>Advanced nuclear technology:</strong>
<ul>
<li>NASA’s <strong>kilopower reactor</strong> (10 kilowatts).</li>
<li>Chargeable atomic batteries (20 kilowatts, half-ton).</li>
<li><strong>Isotopic batteries</strong> (direct electric conversion, as envisioned by Asimov).</li>
</ul></li>
<li><strong>Cellular power systems with small modular reactors.</strong></li>
<li><strong>Space-based solar power transmission</strong> (as studied in the 1970s High Frontier project).</li>
<li><strong>Geothermal energy:</strong> Tapping into the Earth’s internal heat (fission-driven).</li>
</ul></li>
</ul></li>
<li><strong>Diaspora from Cities:</strong> Continued movement towards the sea, mountains, and other areas.</li>
<li><strong>Space Travel and Exploration:</strong> Increased activity, but not large-scale colonization yet.</li>
<li><strong>Nanotechnology:</strong> Early applications would be emerging, similar to personal computing in the 1980s.</li>
<li><strong>Flying Cars:</strong> Early adopters would be transitioning to fuel cells.</li>
</ul>
</section>
<section id="the-current-landscape-and-potential-renaissance" class="level3">
<h3 class="anchored" data-anchor-id="the-current-landscape-and-potential-renaissance">The Current Landscape and Potential Renaissance</h3>
<ul>
<li><strong>Flying car resurgence:</strong> Many new designs are being proposed, including battery and electric powered.</li>
<li><strong>Investment in e-VTOL taxis:</strong> Potentially excessive, given the limitations of current battery technology.</li>
<li><strong>Battery technology:</strong>
<ul>
<li>Potential for an eightfold increase in energy density and halving the price.</li>
<li>Suitable for ground cars and fixed-wing aircraft, but not for VTOLs requiring a 500-mile range.</li>
</ul></li>
<li><strong>Fuel cells:</strong> Promising for early nanotech applications and could replace batteries in existing aircraft designs.</li>
<li><strong>Electric flying car enthusiasm:</strong> Likely sustainable, potentially on the verge of a technological renaissance.</li>
<li><strong>Anhydrous ammonia:</strong> Gaining traction as a potential fuel for fuel cells (carbon-free and easier to handle than hydrogen).</li>
<li><strong>Startups exploring small modular reactors:</strong> Both fission and fusion.</li>
<li><strong>Biotechnology boom.</strong></li>
<li><strong>Drones, video phones, digital assistants, and robot vacuum cleaners.</strong></li>
<li><strong>Reusable rockets for space travel.</strong></li>
</ul>
</section>
<section id="the-future-of-technological-progress" class="level3">
<h3 class="anchored" data-anchor-id="the-future-of-technological-progress">The Future of Technological Progress</h3>
<ul>
<li>Many new technologies may emerge in the coming century.</li>
<li><strong>The question remains:</strong> Will these technologies recreate the transformative impact of the Industrial Revolution and significantly improve the lives of ordinary people?</li>
</ul>
</section>
</section>
<section id="chapter-14-the-dawn-of-robots" class="level2">
<h2 class="anchored" data-anchor-id="chapter-14-the-dawn-of-robots">Chapter 14: The Dawn of Robots</h2>
<section id="epigraph-h.-g.-wells-things-to-come" class="level3">
<h3 class="anchored" data-anchor-id="epigraph-h.-g.-wells-things-to-come">Epigraph: H. G. Wells, Things to Come</h3>
<ul>
<li><strong>Quote:</strong> “And now for the world of the airmen, and a new start for mankind.”</li>
</ul>
</section>
<section id="introduction-rosie-the-robot-and-the-state-of-ai" class="level3">
<h3 class="anchored" data-anchor-id="introduction-rosie-the-robot-and-the-state-of-ai">Introduction: Rosie the Robot and the State of AI</h3>
<ul>
<li>Popular culture, like The Jetsons, envisioned robots like Rosie the Robot Housemaid.</li>
<li><strong>Robots</strong> are technologically more challenging than flying cars.</li>
<li><strong>Artificial intelligence (AI)</strong> and robotics are progressing, aligning with Asimov’s predictions.</li>
<li>This chapter examines the future of AI and robots, grounding predictions in current capabilities and avoiding limitations in imagination.</li>
</ul>
</section>
<section id="the-wright-brothers-analogy-and-the-ai-boom" class="level3">
<h3 class="anchored" data-anchor-id="the-wright-brothers-analogy-and-the-ai-boom">The Wright Brothers Analogy and the AI Boom</h3>
<ul>
<li><strong>The author previously argued against a sudden AI takeoff driven by self-improving super AI.</strong></li>
<li>Instead, he predicted a more gradual but effective progress:
<ul>
<li><strong>AI would start to work, attract investment, and experience rapid development.</strong></li>
<li>This progress would mirror the aviation boom after the Wright Brothers’ successful flight:
<ul>
<li>Initial skepticism followed by widespread recognition.</li>
<li><strong>Rapid influx of resources and development effort.</strong></li>
<li>Exponential growth in capabilities.</li>
</ul></li>
</ul></li>
<li><strong>This AI boom is currently underway:</strong>
<ul>
<li><strong>Deep learning in multi-level neural networks</strong> has brought significant advancements.</li>
<li><strong>Deep learning</strong> is essentially back-propagation of error terms (used since the 1980s) but with improvements:
<ul>
<li><strong>Small improvements combined with increased processing power (GPUs).</strong></li>
<li><strong>Training networks with many more levels (e.g., 22 vs.&nbsp;2-3).</strong></li>
<li><strong>Faster training times (hours instead of weeks).</strong></li>
<li><strong>Availability of large datasets for training, providing broader experience.</strong></li>
</ul></li>
<li>These advancements are supported by progress in other AI areas (e.g., processing power, robotics).</li>
<li><strong>Examples of recent AI advancements:</strong>
<ul>
<li><strong>Robots learning manual tasks by observation and practice.</strong></li>
<li><strong>Improved speech recognition surpassing typing accuracy.</strong></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="example-training-a-deep-neural-net-on-text" class="level3">
<h3 class="anchored" data-anchor-id="example-training-a-deep-neural-net-on-text">Example: Training a Deep Neural Net on Text</h3>
<ul>
<li><strong>Experiment:</strong> Training a multi-level recurrent neural net on a 50 MB corpus of fiction novels.</li>
<li><strong>Initial output:</strong> Random characters (e.g., “W98VWMA0N&amp;W47T**KNQ4”).</li>
<li><strong>After one night’s training:</strong> More English-like but nonsensical text (e.g., “The jets of the hundred for the idea of the mini-poor, from a seamed planet…”).</li>
<li><strong>After a few days:</strong> More coherent, grammatically correct, and even creative text (e.g., “Dejah Thoris, he said, I’ll be somewhere…”).</li>
<li><strong>Significance:</strong> The model learned language structure (words, sentences, punctuation) solely from predicting the next character in a sequence.</li>
<li><strong>This demonstrates powerful learning capabilities that can be integrated with other AI techniques.</strong></li>
</ul>
</section>
<section id="prediction-ai-capabilities-by-the-2020s" class="level3">
<h3 class="anchored" data-anchor-id="prediction-ai-capabilities-by-the-2020s">Prediction: AI Capabilities by the 2020s</h3>
<ul>
<li><strong>Prediction:</strong> By the end of the 2020s, AI systems will achieve human-like performance in tasks involving reading, writing, talking, and listening.</li>
</ul>
</section>
<section id="alphago-mastering-the-game-of-go" class="level3">
<h3 class="anchored" data-anchor-id="alphago-mastering-the-game-of-go">AlphaGo: Mastering the Game of Go</h3>
<ul>
<li><strong>AlphaGo</strong> was the first program to play Go at a professional level.</li>
<li><strong>Go</strong> was previously considered a significant AI challenge:
<ul>
<li><strong>Quote (from Beyond AI):</strong> “By contrast to chess, programs playing Go have yet to challenge even serious amateurs, much less the top professionals.”</li>
<li><strong>Complexity:</strong> Go requires concept formation and dynamic assessment of game pieces (clusters).</li>
<li><strong>Quote (from Beyond AI):</strong> “playing go well requires solving the real AI problem, that of creating useful concepts from experience.”</li>
</ul></li>
<li><strong>AlphaGo’s success:</strong>
<ul>
<li>Utilizes two deep neural nets integrated with a traditional game-playing program.</li>
<li><strong>Rapid improvement:</strong> Beat top-ranked player Lee Sedol in 2016.</li>
</ul></li>
<li><strong>Criticisms and Rebuttals:</strong>
<ul>
<li>Some dismissed AlphaGo’s achievement as “brute force” due to its reliance on substantial computing power (1,920 CPUs and 280 GPUs).</li>
<li><strong>Counterargument:</strong> Access to and effective deployment of computing power is a significant real-world advantage.</li>
<li><strong>Google developed custom chips to accelerate deep learning algorithms.</strong></li>
</ul></li>
<li><strong>Shift from Academia to Industry:</strong>
<ul>
<li><strong>DeepMind’s AlphaGo paper had 20 authors.</strong></li>
<li><strong>Machine learning engineer is the fastest-growing job (LinkedIn 2017).</strong></li>
<li><strong>Numerous AI/machine learning conferences held annually (e.g., 225 in 2018).</strong></li>
</ul></li>
<li><strong>Conclusion:</strong> The AI field is experiencing a boom similar to aviation after the Wright Brothers.</li>
</ul>
</section>
<section id="robo-habilis-the-wozniak-test" class="level3">
<h3 class="anchored" data-anchor-id="robo-habilis-the-wozniak-test">Robo Habilis: The Wozniak Test</h3>
<ul>
<li><strong>Heinlein Quote (Time Enough for Love):</strong> Emphasizes the versatility of humans compared to specialized insects.</li>
<li><strong>Steve Wozniak’s opinion:</strong> Robots will never be able to enter an unfamiliar house and make coffee.</li>
<li><strong>The Wozniak Test:</strong> A proposed test for embodied AI (robots in the Asimovian sense):
<ol type="1">
<li>Robot enters an unfamiliar house.</li>
<li>Finds and uses the doorbell/knocker.</li>
<li>Explains its purpose and gains entry.</li>
<li>Locates the kitchen and coffee-making supplies.</li>
<li>Makes coffee to the householder’s taste (asking questions if needed).</li>
<li>Serves the coffee in another room.</li>
</ol></li>
<li><strong>Challenges for current robotics:</strong>
<ul>
<li><strong>Vision:</strong> Navigation, object recognition, gesture understanding.</li>
<li><strong>Manipulation:</strong> Coordinating complex movements, physical modeling, learning loops.</li>
<li><strong>Speech:</strong> Recognition, natural language understanding and generation.</li>
<li><strong>Planning:</strong> Multi-level planning from manipulation paths to coffee brewing sequences.</li>
<li><strong>Coordination:</strong> Integrating all capabilities towards the overall goal.</li>
</ul></li>
<li><strong>The Wozniak Test assesses adaptability and common sense.</strong></li>
<li><strong>It emphasizes general learning skills over pre-programmed routines.</strong></li>
<li><strong>Comparison to Homo habilis:</strong> The test evaluates tool use and recognition, a milestone towards human-level intelligence.</li>
<li><strong>The Nielsen Test:</strong> A broader concept proposed by Nils Nielsen, suggesting that human-level AI should be able to perform human jobs (the “employment test”).</li>
</ul>
</section>
<section id="limitations-of-deep-learning-in-robotics" class="level3">
<h3 class="anchored" data-anchor-id="limitations-of-deep-learning-in-robotics">Limitations of Deep Learning in Robotics</h3>
<ul>
<li><strong>Challenge:</strong> Applying deep learning to robotics is limited by the lack of vast real-world data.</li>
<li><strong>Deep learning thrives on massive datasets (e.g., text, game records).</strong></li>
<li><strong>Real-world robotics data is expensive and difficult to collect.</strong></li>
<li><strong>Quote (Gary Marcus):</strong> “Rosie the robot, you can’t have it knock over your furniture a hundred thousand times to learn.”</li>
<li><strong>Deep learning needs to improve its ability to learn quickly from limited experience.</strong></li>
<li><strong>Future research directions:</strong>
<ul>
<li>Learning from instruction.</li>
<li>Learning by imitation.</li>
<li>Learning by trial and error.</li>
</ul></li>
</ul>
</section>
<section id="the-dawn-of-robots-and-realistic-expectations" class="level3">
<h3 class="anchored" data-anchor-id="the-dawn-of-robots-and-realistic-expectations">The Dawn of Robots and Realistic Expectations</h3>
<ul>
<li><strong>We are at the beginning of the age of robots.</strong></li>
<li><strong>Expectations of robots are becoming more realistic.</strong></li>
<li><strong>Compared to other future technologies, robots are closest to happening on schedule.</strong></li>
</ul>
</section>
<section id="profession-automation-and-productivity" class="level3">
<h3 class="anchored" data-anchor-id="profession-automation-and-productivity">Profession: Automation and Productivity</h3>
<ul>
<li><strong>Quote (Philip Francis Nolan, Armageddon, 2419 A.D.):</strong> Depicts a future where machines replace human labor.</li>
<li><strong>The Jetsons oversimplified the implications of automation.</strong></li>
<li><strong>Real-world trend:</strong> Technology has consistently increased productivity, requiring fewer people to produce more goods.</li>
<li><strong>Examples:</strong>
<ul>
<li><strong>Agriculture:</strong> Farmers in 1790 fed 1.1 people each; now they feed 40.</li>
<li><strong>Manufacturing:</strong> US manufacturing jobs declined from over 33% in the 1940s to under 9% now, while output tripled.</li>
</ul></li>
<li><strong>Manufacturing productivity:</strong>
<ul>
<li>Output per worker increased from $25,000 in 1962 to $160,000 in 2012 (constant 2010 dollars).</li>
<li><strong>Hyper-exponential growth:</strong> Productivity increases are accelerating.</li>
</ul></li>
<li><strong>Projected manufacturing worker productivity in 2062:</strong> $661,000 (constant 2010 dollars) or $1,854,392 (with 3% inflation).</li>
<li><strong>The question of work in a highly automated future:</strong>
<ul>
<li><strong>Thought experiment:</strong> Lining up the US population along I-80 in order of productivity.</li>
<li><strong>Finding the cutoff point:</strong> Where the fewest people can maintain a desired level of consumption.</li>
<li><strong>With 1790’s consumption levels and 2020’s technology, only a small fraction of the population would need to work.</strong></li>
</ul></li>
<li><strong>Unemployment is not at 98% because we desire a higher level of consumption than our ancestors.</strong></li>
<li><strong>Keynes’ observation (1933):</strong> Technological advancements in economizing labor need to be matched by finding new uses for labor.</li>
<li><strong>Labor force participation:</strong>
<ul>
<li>Historically around 90% until the mid-20th century.</li>
<li>Declined to around 70% for men and 50% overall by 2020.</li>
</ul></li>
<li><strong>Truck driver example:</strong>
<ul>
<li>Self-driving trucks are a potential source of job displacement.</li>
<li><strong>However, automation often leads to increased efficiency within an industry rather than complete job elimination.</strong></li>
<li><strong>Trucking will likely follow the pattern of manufacturing, with fewer workers handling more freight.</strong></li>
</ul></li>
<li><strong>Conclusion:</strong> Technological advancements have consistently improved living standards and reduced extreme poverty.</li>
</ul>
</section>
<section id="a-cleaner-better-breed-machine-ethics" class="level3">
<h3 class="anchored" data-anchor-id="a-cleaner-better-breed-machine-ethics">A Cleaner, Better Breed: Machine Ethics</h3>
<ul>
<li><strong>Early AI ethics concerns:</strong> Focused on the potential threat of superintelligent AI (e.g., turning us all into paperclips).</li>
<li><strong>Critique of early AI:</strong> Little attention was given to imbuing AI with a sense of morality.</li>
<li><strong>Analogy to natural language processing:</strong>
<ul>
<li>AI struggled for decades to achieve competent language understanding and generation.</li>
<li><strong>Moral reasoning might be similarly complex.</strong></li>
</ul></li>
<li><strong>Lack of research in computational ethics:</strong> No significant work compared to computational linguistics.</li>
<li><strong>Beyond AI (2007):</strong> One of the first books dedicated to machine ethics.</li>
<li><strong>GPT-3 and the illusion of understanding:</strong>
<ul>
<li><strong>GPT-3</strong> is a powerful language model that can generate impressive text.</li>
<li><strong>However, it lacks true understanding; it primarily relies on statistical patterns in its training data.</strong></li>
<li><strong>Understanding requires mental models that enable recognition, imitation, prediction, and manipulation of concepts.</strong></li>
</ul></li>
<li><strong>The challenge of building a corpus of moral judgments:</strong>
<ul>
<li><strong>Unlike language data, there’s no readily available massive dataset for training ethical AI.</strong></li>
</ul></li>
<li><strong>Short-term solution: Asimov’s robots - “Do what the humans tell you to do.”</strong></li>
<li><strong>Humans can train robots through feedback and reinforcement.</strong></li>
<li><strong>Building a corpus of practical and moral judgments:</strong>
<ul>
<li>Robots can learn from human instructions and examples.</li>
<li><strong>Sharing learned judgments can create a collective knowledge base for ethical decision-making.</strong></li>
</ul></li>
<li><strong>The potential for morally superior robots:</strong>
<ul>
<li><strong>Quote (Asimov):</strong> “They’re a cleaner, better breed than we are.”</li>
<li><strong>Focusing on the positive aspects of human behavior can lead to robots with enhanced ethical capabilities.</strong></li>
</ul></li>
<li><strong>Example: Ethical retail clerk robot:</strong> No extra effort needed to prevent it from stealing, highlighting the inherent reliability of robots.</li>
<li><strong>Benefits of robots in positions of trust:</strong>
<ul>
<li>Reliability, 24/7 availability, no human biases or misconduct.</li>
<li>Reduced financial losses due to employee theft.</li>
</ul></li>
<li><strong>The Sorcerer’s Apprentice problem:</strong>
<ul>
<li>The hypothetical scenario of a robot tasked with maximizing paperclip production leading to disastrous consequences.</li>
<li><strong>This scenario is considered unrealistic:</strong> It assumes a combination of superhuman intelligence and a lack of common sense.</li>
</ul></li>
<li><strong>Robots will be developed incrementally, with continuous improvements addressing potential flaws.</strong></li>
<li><strong>Example: Robot doctors:</strong>
<ul>
<li>Future robots could combine the knowledge of general practitioners and specialists, potentially exceeding human capabilities.</li>
<li><strong>Benefits:</strong> Encyclopedic expertise, instant access to research, high IQ, no fatigue or errors.</li>
</ul></li>
<li><strong>Programming robots through natural language:</strong>
<ul>
<li>Advanced AI will understand human instructions, leading to easier and more intuitive programming.</li>
</ul></li>
<li><strong>Robots’ impact on quality of life:</strong>
<ul>
<li><strong>Increased competence in professional services.</strong></li>
<li><strong>Affordable domestic help (like Rosie the Robot).</strong></li>
<li><strong>Self-driving cars (like personal chauffeurs).</strong></li>
<li><strong>Combined with nanotechnology, robots can significantly enhance living standards.</strong></li>
</ul></li>
<li><strong>Conclusion:</strong> While challenges remain, the dawn of robots promises significant advancements and improvements to our lives. We can see enough of the future to be optimistic about the potential benefits of this technology.</li>
<li><blockquote class="blockquote">
<p>“We can only see a short distance ahead, but we can see plenty there that needs to be done.” - Alan Turing.</p>
</blockquote></li>
</ul>
</section>
</section>
<section id="chapter-15-the-second-atomic-age" class="level2">
<h2 class="anchored" data-anchor-id="chapter-15-the-second-atomic-age">Chapter 15: The Second Atomic Age</h2>
<section id="the-synergy-of-nanotech-and-nuclear-technology" class="level3">
<h3 class="anchored" data-anchor-id="the-synergy-of-nanotech-and-nuclear-technology">The Synergy of Nanotech and Nuclear Technology</h3>
<ul>
<li><strong>The Second Atomic Age</strong> will be defined by the convergence of <strong>nanotechnology</strong> and <strong>nuclear technology</strong>, resulting in atomically precise machinery and a new era of atomic energy.
<ul>
<li>Like the relationship between chemical fuels and steel machines, nanotech enables and complements nuclear technology.</li>
</ul></li>
</ul>
</section>
<section id="nanotechs-role-in-nuclear-advancement" class="level3">
<h3 class="anchored" data-anchor-id="nanotechs-role-in-nuclear-advancement">Nanotech’s Role in Nuclear Advancement</h3>
<section id="isotopic-separation" class="level4">
<h4 class="anchored" data-anchor-id="isotopic-separation">1. Isotopic Separation</h4>
<ul>
<li><strong>Isotopes:</strong> Nuclei with the same number of protons but different numbers of neutrons.
<ul>
<li>Chemically identical, but differ in nuclear properties.</li>
<li><strong>Examples:</strong>
<ul>
<li>U-235 (fissile) vs.&nbsp;U-238 (not fissile)</li>
<li>Xenon-134 (stable, low neutron cross-section) vs.&nbsp;Xenon-135 (radioactive, high neutron cross-section)</li>
</ul></li>
</ul></li>
<li><strong>Current Limitations:</strong> Conventional chemical separation techniques are expensive and inefficient.</li>
<li><strong>Nanotech’s Advantage:</strong> Atom-by-atom manipulation allows for sorting by weight or nuclear magnetic properties.
<ul>
<li><strong>Challenges:</strong> Radioactive atoms can damage nanoscale machinery.</li>
<li><strong>Benefits:</strong>
<ul>
<li><strong>Cheaper isotopic separation.</strong></li>
<li><strong>Cleanup of low-level nuclear waste:</strong> “Given current technology, isotopic separation is far too expensive to be used to clean up stuff that has been exposed to neutrons. Low-level nuclear waste. But with nanotech, that process would be straightforward.”</li>
<li><strong>Transformation of nuclear power into a clean, contained technology.</strong></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="building-extreme-and-precise-nuclear-structures" class="level4">
<h4 class="anchored" data-anchor-id="building-extreme-and-precise-nuclear-structures">2. Building Extreme and Precise Nuclear Structures</h4>
<ul>
<li><strong>Nanotech’s Ability:</strong> Construct precise structures at the atomic scale within nuclear mechanisms.
<ul>
<li><strong>Influence on Nuclear Reactions:</strong> Enables the creation of intense electric and magnetic fields that can influence nuclear reactions.</li>
</ul></li>
<li><strong>Example: Californium-251 Reactor:</strong>
<ul>
<li>A working moderated reactor can be built with just 25 grams of Californium-251.</li>
<li><strong>Challenges:</strong> Californium-251 is synthetic and currently produced in minute quantities.</li>
</ul></li>
<li><strong>Current Transmutation Limitations:</strong>
<ul>
<li>Neutron bombardment is the primary method for changing isotopes.</li>
<li>Highly reactive isotopes are more susceptible to damage during the process.</li>
</ul></li>
<li><strong>Nanotech’s Advantage:</strong> Individual atom handling allows for precise nuclear processing that is currently impossible with bulk technology.</li>
</ul>
</section>
<section id="enhanced-productivity-and-radiation-resistance" class="level4">
<h4 class="anchored" data-anchor-id="enhanced-productivity-and-radiation-resistance">3. Enhanced Productivity and Radiation Resistance</h4>
<ul>
<li><strong>Continuous Reconstruction:</strong> Nanotech enables continuous replacement of reactor parts, minimizing radiation-induced defects.</li>
<li><strong>Biological Analogy:</strong> Similar to the radiation resistance mechanism of Deinococcus radiodurans (Conan the Bacterium).</li>
<li><strong>Benefits:</strong>
<ul>
<li><strong>Reduced vulnerability to radiation’s health effects.</strong></li>
<li><strong>Cell repair machines could enhance radiation resistance.</strong></li>
<li><strong>Possibility of living in space.</strong></li>
</ul></li>
</ul>
</section>
</section>
<section id="the-power-imbalance-nanotech-and-energy-needs" class="level3">
<h3 class="anchored" data-anchor-id="the-power-imbalance-nanotech-and-energy-needs">The Power Imbalance: Nanotech and Energy Needs</h3>
<ul>
<li><strong>Nanotech’s Power Requirements:</strong> Nanotech machines have extremely high power densities.
<ul>
<li><strong>Drexler Electric Motor:</strong> 3 billion horsepower per pound.</li>
</ul></li>
<li><strong>Nuclear Power’s Advantage:</strong> Nuclear power densities are well-matched to nanotech’s energy needs, similar to the relationship between chemical fuels and steel machines.</li>
</ul>
</section>
<section id="renewable-energy-uranium-from-seawater" class="level3">
<h3 class="anchored" data-anchor-id="renewable-energy-uranium-from-seawater">Renewable Energy: Uranium from Seawater</h3>
<ul>
<li><p><strong>Julian Simon’s Prediction:</strong> “It’s reasonable to expect the supply of energy to continue becoming more available and less scarce forever.”</p></li>
<li><p><strong>Uranium in Oceans:</strong></p>
<ul>
<li>4 billion tons of dissolved uranium.</li>
<li>Equivalent to over 100 quadrillion watt-years of energy.</li>
<li>Enough to power 10 billion people at the current American energy consumption level (10 kilowatts per person) for 10,000 years.</li>
</ul></li>
<li><p><strong>Current Technology:</strong> Economical extraction of uranium from seawater is nearing feasibility.</p></li>
<li><p><strong>Nanotech’s Potential:</strong></p>
<ul>
<li><p><strong>Simplified and efficient extraction.</strong></p></li>
<li><p><strong>Minimal environmental impact:</strong> Maintaining the homeostatic equilibrium of uranium concentration in seawater.</p></li>
<li><blockquote class="blockquote">
<p>“If we start taking uranium out of seawater and use it for the entire world’s energy economy, indeed a robustly growing energy economy, the concentration in seawater will not decline for millions of years.”</p>
</blockquote></li>
</ul></li>
</ul>
</section>
<section id="safe-reactor-design-the-triga-reactor" class="level3">
<h3 class="anchored" data-anchor-id="safe-reactor-design-the-triga-reactor">Safe Reactor Design: The TRIGA Reactor</h3>
<ul>
<li><strong>General Atomic’s TRIGA Reactors:</strong>
<ul>
<li>Based on Freeman Dyson’s design.</li>
<li><strong>Inherent Safety:</strong> Do not require external quenching rods or cooling.</li>
</ul></li>
<li><strong>Negative Coefficient of Reactivity:</strong>
<ul>
<li><strong>Mechanism:</strong> The hotter the fuel gets, the less it supports the fission chain reaction.</li>
<li><strong>Opposite of an Implosion Bomb:</strong> In a bomb, compression increases criticality; in the TRIGA, thermal expansion reduces criticality.</li>
</ul></li>
<li><strong>Safety Record:</strong> 70 TRIGA reactors have operated for 60 years without significant accidents.</li>
<li><strong>Proof of Concept:</strong> Demonstrates the feasibility of designing inherently safe reactors.</li>
</ul>
</section>
<section id="miniaturization-of-reactors" class="level3">
<h3 class="anchored" data-anchor-id="miniaturization-of-reactors">Miniaturization of Reactors</h3>
<ul>
<li><strong>Critical Mass in Small Reactors:</strong>
<ul>
<li><strong>Plutonium-241:</strong> 0.246 kilograms (just over half a pound) in a neutron-reflected solution-based moderated reaction.</li>
<li><strong>Californium-251:</strong> Less than an ounce (one-third of a teaspoon).</li>
</ul></li>
<li><strong>Aqueous Homogeneous Reactors:</strong>
<ul>
<li>Reactors with fuel dissolved in a liquid moderator.</li>
<li>History dating back to Los Alamos and Oak Ridge in the 1950s.</li>
<li><strong>Theoretical Minimum Size:</strong>
<ul>
<li>Spherical aqueous homogeneous reactor powered by Americium-242m nitrate solution in water.</li>
<li>Mass: 4.95 kg (0.7 kg of Americium-242m fuel).</li>
<li>Diameter: 19 cm (7.5 inches).</li>
<li>Power output: A few kilowatts.</li>
<li>Potential applications: Space program and portable neutron sources.</li>
</ul></li>
</ul></li>
<li><strong>Sandia Reactor Design:</strong>
<ul>
<li>Requires about 5 gallons of water for moderation and reflection.</li>
<li>Reactor core smaller than a cubic foot.</li>
</ul></li>
</ul>
</section>
<section id="the-hanford-b-site-reactor-and-xenon-poisoning" class="level3">
<h3 class="anchored" data-anchor-id="the-hanford-b-site-reactor-and-xenon-poisoning">The Hanford B-Site Reactor and Xenon Poisoning</h3>
<ul>
<li><strong>Hanford B-Site Reactor:</strong> The first full-scale reactor, built for plutonium production during the Manhattan Project.</li>
<li><strong>Xenon-135 Poisoning:</strong>
<ul>
<li>Xenon-135, a fission byproduct, absorbs neutrons and temporarily shuts down the reactor.</li>
<li>Xenon-135 decays with a half-life of 8 hours, allowing the reactor to restart after a period of inactivity.</li>
</ul></li>
<li><strong>Overbuilding for Mitigation:</strong> The Hanford reactor was built twice as large as calculated to overcome xenon poisoning.</li>
<li><strong>Nanotech Solution:</strong>
<ul>
<li><strong>Liquid-core reactors with continuous fuel circulation and xenon-135 filtering.</strong></li>
<li><strong>Eliminates the need for overbuilding.</strong></li>
<li><strong>Self-quenching in case of filter malfunction.</strong></li>
</ul></li>
</ul>
</section>
<section id="nanotech-enabled-reactor-possibilities" class="level3">
<h3 class="anchored" data-anchor-id="nanotech-enabled-reactor-possibilities">Nanotech-Enabled Reactor Possibilities</h3>
<ul>
<li><strong>Potential Size and Power:</strong>
<ul>
<li><strong>Estimated Size:</strong> Closet-sized reactor.</li>
<li><strong>Estimated Power Output:</strong> On the order of a megawatt.</li>
</ul></li>
<li><strong>NASA’s Kilopower Project:</strong>
<ul>
<li>Developing a 10-kilowatt reactor for space probes.</li>
<li>Solid U-235 molybdenum alloy core, the size of a roll of paper towels.</li>
</ul></li>
<li><strong>Economic Viability with Nanotech:</strong>
<ul>
<li>Nanotech’s productive power could make small-scale reactors economically feasible.</li>
</ul></li>
<li><strong>Benefits of Home Reactors:</strong>
<ul>
<li><strong>Location Independence:</strong> No reliance on power lines or fuel deliveries.</li>
<li><strong>Reduced Environmental Impact:</strong> No emissions.</li>
<li><strong>Example:</strong> A 100-kilowatt home reactor would produce about an ounce of fission byproducts per year.</li>
</ul></li>
</ul>
</section>
<section id="fissionable-vs.-fissile-isotopes" class="level3">
<h3 class="anchored" data-anchor-id="fissionable-vs.-fissile-isotopes">Fissionable vs.&nbsp;Fissile Isotopes</h3>
<ul>
<li><strong>Thermal Neutrons:</strong> Neutrons slowed down to the energy level of atoms at room temperature (0.025 electron volts).</li>
<li><strong>Fissile Isotopes:</strong>
<ul>
<li>Fissionable by thermal neutrons.</li>
<li>Capable of sustaining a chain reaction.</li>
</ul></li>
<li><strong>High Cross-Section for Thermal Neutrons:</strong> The probability of neutron capture is higher for thermal neutrons.</li>
<li><strong>Moderated Chain Reactions:</strong> Use smaller quantities of fissile material due to neutron moderation.</li>
<li><strong>Fissionable Isotopes:</strong>
<ul>
<li>Not fissile but can be fissioned by high-energy neutrons.</li>
<li><strong>Example:</strong> Uranium-238.</li>
</ul></li>
</ul>
</section>
<section id="chainless-reactors" class="level3">
<h3 class="anchored" data-anchor-id="chainless-reactors">Chainless Reactors</h3>
<ul>
<li><strong>Mechanism:</strong> Use a source of high-energy neutrons to fission non-fissile isotopes like U-238.</li>
<li><strong>Safety Advantages:</strong>
<ul>
<li>Runaway-proof and meltdown-proof.</li>
<li>No chain reaction.</li>
</ul></li>
<li><strong>Fuel Advantages:</strong>
<ul>
<li>Can use natural unenriched uranium or thorium.</li>
<li>Eliminates the need for enrichment facilities, reducing proliferation risks.</li>
</ul></li>
</ul>
</section>
<section id="sources-of-high-energy-neutrons" class="level3">
<h3 class="anchored" data-anchor-id="sources-of-high-energy-neutrons">Sources of High-Energy Neutrons</h3>
<section id="particle-accelerators" class="level4">
<h4 class="anchored" data-anchor-id="particle-accelerators">1. Particle Accelerators</h4>
<ul>
<li><strong>Direct Neutron Acceleration:</strong> Accelerating neutrons directly.</li>
<li><strong>Spallation:</strong> Bombarding materials with charged particles (e.g., protons) to release neutrons.</li>
</ul>
</section>
<section id="fusion" class="level4">
<h4 class="anchored" data-anchor-id="fusion">2. Fusion</h4>
<ul>
<li><strong>Deuterium-Tritium Fusion:</strong> Produces helium and a 14 MeV neutron.</li>
<li><strong>Lattice Confinement Fusion:</strong>
<ul>
<li>Pre-loading erbium with deuterium and bombarding it with high-energy particles to induce fusion.</li>
<li>Under investigation as a spacecraft power source.</li>
</ul></li>
</ul>
</section>
</section>
<section id="assassins-and-accidents-the-case-of-polonium-210" class="level3">
<h3 class="anchored" data-anchor-id="assassins-and-accidents-the-case-of-polonium-210">Assassins and Accidents: The Case of Polonium-210</h3>
<ul>
<li><strong>Alexander Litvinenko’s Assassination:</strong> Killed by polonium-210 poisoning in 2006.</li>
<li><strong>Polonium-210:</strong>
<ul>
<li>Vigorous alpha emitter.</li>
<li>Fatal dose: 1 microgram if introduced internally.</li>
</ul></li>
<li><strong>Addressing Concerns about Nuclear Safety:</strong>
<ul>
<li><strong>Cost and Rarity:</strong> Polonium-210 is expensive and rare, not a byproduct of power generation.</li>
<li><strong>Comparison to Botulinum Toxin:</strong> Botulinum toxin is more deadly and can be produced accidentally.</li>
</ul></li>
<li><strong>Toxicity vs.&nbsp;Public Hazard:</strong>
<ul>
<li>A substance’s toxicity alone does not determine its public hazard.</li>
<li>Factors to consider: Quantity handled, purpose of use, precautions taken.</li>
</ul></li>
<li><strong>Example: Tritium:</strong>
<ul>
<li>Can be dangerous if incorporated into water and absorbed by the body.</li>
<li>High cost ($30,000 per gram) incentivizes careful handling.</li>
</ul></li>
<li><strong>Handling Large Quantities of Fuel vs.&nbsp;Small Quantities of Nuclear Material:</strong>
<ul>
<li>The high energy density of nuclear materials means smaller quantities are needed, reducing handling risks.</li>
<li><strong>Example:</strong> Half an ounce of thorium has the same energy content as 60,000 pounds of gasoline.</li>
</ul></li>
<li><strong>Nanotech’s Role in Accident Mitigation:</strong>
<ul>
<li>Cell repair machines and artificial organs could counteract radiation exposure.</li>
</ul></li>
</ul>
</section>
<section id="cold-fusion-reassessing-the-possibilities" class="level3">
<h3 class="anchored" data-anchor-id="cold-fusion-reassessing-the-possibilities">Cold Fusion: Reassessing the Possibilities</h3>
<ul>
<li><strong>Shifting Perceptions:</strong> Cold fusion research has gained some credibility over time.</li>
<li><strong>Evidence of a Heat Effect:</strong> More reproducible experiments suggest a genuine heat effect, though the fusion pathway remains unclear.</li>
<li><strong>The Navy’s Role:</strong> Research at the Naval Surface Warfare Center has produced peer-reviewed publications and patents related to cold fusion.</li>
</ul>
</section>
<section id="the-three-miracles-of-cold-fusion" class="level3">
<h3 class="anchored" data-anchor-id="the-three-miracles-of-cold-fusion">The Three Miracles of Cold Fusion</h3>
<ul>
<li><strong>John Huizenga’s Critique:</strong> Identified three key challenges that a theory of cold fusion must address:
<ul>
<li><strong>1. The Coulomb Barrier:</strong> The energy required for nuclear fusion is much higher than what electrochemical processes can provide.</li>
<li><strong>2. Reaction Pathways:</strong> Deuterium fusion typically produces tritium and a proton or helium-3 and a neutron, which are not detected in expected quantities.</li>
<li><strong>3. Energy Output:</strong> Even if fusion occurs, the expected high-energy gamma rays are not detected. Instead, heat is observed.</li>
</ul></li>
</ul>
</section>
<section id="peter-hagelsteins-quantum-coherence-theory" class="level3">
<h3 class="anchored" data-anchor-id="peter-hagelsteins-quantum-coherence-theory">Peter Hagelstein’s Quantum Coherence Theory</h3>
<ul>
<li><strong>Quantum Coherence:</strong> Proposes a direct quantum mechanical coupling between nuclear transitions and <strong>phonons</strong> (quantized vibrations in solids).</li>
<li><strong>Mechanism:</strong>
<ul>
<li>Phonons could provide a channel for excitation to overcome the Coulomb barrier.</li>
<li>Phonons could influence the reaction pathway and facilitate energy dissipation as heat instead of radiation.</li>
</ul></li>
<li><strong>Experimental Support:</strong> Optical stimulation at specific phonon frequencies has been shown to enhance the excess heat effect in some experiments.</li>
</ul>
</section>
<section id="implications-of-a-quantum-coupling" class="level3">
<h3 class="anchored" data-anchor-id="implications-of-a-quantum-coupling">Implications of a Quantum Coupling</h3>
<ul>
<li><strong>Relativistic Effects:</strong> The coupling between phonons and nuclear degrees of freedom might involve relativistic terms in the Dirac equation that are usually neglected.</li>
</ul>
</section>
<section id="potential-of-cold-fusion-assuming-its-real" class="level3">
<h3 class="anchored" data-anchor-id="potential-of-cold-fusion-assuming-its-real">Potential of Cold Fusion (Assuming it’s Real)</h3>
<ul>
<li><strong>Challenges:</strong>
<ul>
<li>Palladium (a key material in some cold fusion experiments) is rare and expensive.</li>
<li>Current cold fusion experiments are not economically viable.</li>
<li><strong>Example:</strong> Mitchell-Schwarz’s NANR wires produce 100 milliwatts of heat from 1 milliwatt of electricity but cost over $100,000 to make.</li>
</ul></li>
<li><strong>The Spaywar Navy Labs Approach:</strong>
<ul>
<li>Co-deposited palladium with deuterium during electrolysis.</li>
<li>Detected high-energy neutrons, suggesting a potential pathway for chainless reactors.</li>
</ul></li>
<li><strong>The Need for Nanotech:</strong>
<ul>
<li>Nanotech could enable precise analysis and control of atomic-scale conditions to unlock and optimize cold fusion.</li>
</ul></li>
</ul>
</section>
<section id="the-real-tragedy-of-cold-fusion" class="level3">
<h3 class="anchored" data-anchor-id="the-real-tragedy-of-cold-fusion">The Real Tragedy of Cold Fusion</h3>
<ul>
<li><strong>Loss of Imagination in Research:</strong> The cold fusion controversy highlights the decline of purely experimental, observation-driven research.</li>
<li><strong>Failure of Imagination:</strong> The inability to explore unconventional ideas has become a significant barrier to scientific progress.</li>
</ul>
</section>
<section id="hot-fusion-the-power-source-of-the-future-still" class="level3">
<h3 class="anchored" data-anchor-id="hot-fusion-the-power-source-of-the-future-still">Hot Fusion: The Power Source of the Future (Still)</h3>
<ul>
<li><strong>Louis Strauss’s Prediction (1954):</strong> “Energy too cheap to meter” from fusion power.</li>
<li><strong>Over-Expectation:</strong> Science fiction writers and even scientists were overly optimistic about the timeline for fusion power.</li>
<li><strong>Challenges of Replicating Solar Fusion:</strong>
<ul>
<li><strong>Extreme Conditions in the Sun’s Core:</strong> 15 million degrees Celsius, 265 billion atmospheres pressure, extremely dense plasma.</li>
<li><strong>Slow Reaction Rate:</strong> The first step in solar fusion (proton-proton fusion) takes an average of a billion years.</li>
<li><strong>Low Power Density:</strong> A volume of the sun’s core the size of a car engine produces only half a watt of power.</li>
</ul></li>
</ul>
</section>
<section id="hydrogen-bombs-and-fusion" class="level3">
<h3 class="anchored" data-anchor-id="hydrogen-bombs-and-fusion">Hydrogen Bombs and Fusion</h3>
<ul>
<li><strong>Differences from Solar Fusion:</strong>
<ul>
<li>Uses deuterium, tritium, and lithium, bypassing the slow initial steps of solar fusion.</li>
<li>Ignition temperature of 400 million degrees Celsius (from a fission bomb).</li>
</ul></li>
<li><strong>Challenges of Thermonuclear Bomb Design:</strong>
<ul>
<li>Took five years after WWII to develop a working design.</li>
<li>Requires a complex sequence of four explosions.</li>
</ul></li>
<li><strong>Project Pacer:</strong>
<ul>
<li>A 1970s study exploring the use of thermonuclear bombs for power generation.</li>
<li>Technically feasible but faced logistical and economic challenges.</li>
</ul></li>
</ul>
</section>
<section id="progress-in-hot-fusion" class="level3">
<h3 class="anchored" data-anchor-id="progress-in-hot-fusion">Progress in Hot Fusion</h3>
<ul>
<li><strong>Technological Advancements:</strong> Superconductors and other technologies have enabled smaller and more efficient fusion reactor designs.</li>
<li><strong>Private Sector Involvement:</strong> Numerous startups are actively researching various fusion approaches.</li>
<li><strong>Challenges Remain:</strong>
<ul>
<li><strong>Radiation and Neutron Production:</strong> Fusion reactions, particularly deuterium-tritium fusion, produce significant radiation and neutrons.</li>
<li><strong>The Quest for Aneutronic Fusion:</strong> Fusion reactions that produce most of their energy as alpha particles (helium nuclei) are highly desirable.
<ul>
<li><strong>Examples:</strong> Proton-Boron-11 and Proton-Lithium-7 reactions.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="examples-of-aneutronic-fusion-research" class="level3">
<h3 class="anchored" data-anchor-id="examples-of-aneutronic-fusion-research">Examples of Aneutronic Fusion Research</h3>
<ul>
<li><strong>TAE (formerly Tri-Alpha) and LPP Fusion:</strong> Using magnetic confinement for aneutronic fusion.</li>
<li><strong>Laser-Driven Fusion:</strong> High-intensity lasers can be used to initiate fusion reactions.
<ul>
<li><strong>Example:</strong> Simulation study at New South Wales demonstrating the potential for capturing 1 gigajoule of electricity from a 14-milligram sample of hydrogen and boron-11 using a laser-driven approach.</li>
</ul></li>
</ul>
</section>
<section id="the-second-atomic-age-a-new-era-of-energy-abundance" class="level3">
<h3 class="anchored" data-anchor-id="the-second-atomic-age-a-new-era-of-energy-abundance">The Second Atomic Age: A New Era of Energy Abundance</h3>
<ul>
<li><strong>Transformative Potential:</strong> The combination of nanotech and advanced nuclear technologies could unlock unprecedented energy abundance.</li>
<li><strong>Henry Adams’s Analogy:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“We will have been like a boy playing on the seashore, diverting ourselves in now, and then finding a smoother pebble or a prettier shell than ordinary, whilst the great ocean of energy lay all undiscovered before us.”</p>
</blockquote></li>
</ul></li>
<li><strong>Overcoming Impossibilities:</strong> Technological advancements have consistently surpassed expectations throughout history.</li>
<li><strong>The Importance of Pursuing Force (Energy):</strong>
<ul>
<li><blockquote class="blockquote">
<p>“He had seen the number of mines engaged in pursuing force, the truest measure of its attraction, increase from a few scores or hundreds in 1838 to many thousands in 1905, trained to sharpness never before reached, and armed with instruments amounting to new senses of indefinite power and accuracy, while they chased force into hiding places where nature herself had never known it to be, making analyses that contradicted being and syntheses that endangered the elements.” - Henry Adams, The Education of Henry Adams</p>
</blockquote></li>
</ul></li>
</ul>
</section>
</section>
<section id="chapter-16-tom-swift-and-his-flying-car" class="level2">
<h2 class="anchored" data-anchor-id="chapter-16-tom-swift-and-his-flying-car">Chapter 16: Tom Swift and His Flying Car</h2>
<section id="feasibility-of-flying-cars" class="level3">
<h3 class="anchored" data-anchor-id="feasibility-of-flying-cars">Feasibility of Flying Cars</h3>
<section id="current-technological-feasibility" class="level4">
<h4 class="anchored" data-anchor-id="current-technological-feasibility">Current Technological Feasibility</h4>
<ul>
<li>A “parked-in-your-garage” flying car is feasible with today’s technology.</li>
<li><strong>Pre-1970 Advancement Rates:</strong> Continued advancement at these rates would have made flying cars affordable for many.
<ul>
<li>These cars would likely have:
<ul>
<li>Visible wings, rotors, or ducted fans</li>
<li>Turbine generators for power</li>
<li>Cruise speeds under 250 knots</li>
<li>Potentially foldable designs for road driving</li>
<li>Compact size for fuel efficiency</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-great-stagnation-and-energy-poverty" class="level4">
<h4 class="anchored" data-anchor-id="the-great-stagnation-and-energy-poverty">The Great Stagnation and Energy Poverty</h4>
<ul>
<li><strong>The Great Stagnation:</strong> A period of slowed technological advancement, particularly in energy technology.</li>
<li><strong>Ergophobic Religion:</strong> A viewpoint that regards energy as undesirable or problematic.</li>
<li><strong>Energy Poverty:</strong> A major obstacle to achieving the futuristic vision of flying cars.</li>
<li>We have limited ourselves through our attitudes towards energy, but we can change our mindset and regain our potential.</li>
</ul>
</section>
</section>
<section id="hypersonic-runabouts-and-the-future-of-flight" class="level3">
<h3 class="anchored" data-anchor-id="hypersonic-runabouts-and-the-future-of-flight">Hypersonic Runabouts and the Future of Flight</h3>
<section id="airliner-speed-trends-and-space-travel" class="level4">
<h4 class="anchored" data-anchor-id="airliner-speed-trends-and-space-travel">Airliner Speed Trends and Space Travel</h4>
<ul>
<li><strong>Airliner Speeds Trend Chart:</strong> Without stagnation, airliners would potentially reach speeds of 16,000 mph today.</li>
<li><strong>Space Travel:</strong> 16,000 mph is essentially space travel, with reduced gravity inside the aircraft.</li>
<li><strong>Drag Considerations:</strong> At such speeds, air resistance would be extremely high, requiring extremely thin air.</li>
<li><strong>Day-Trip Effect:</strong> The radius of travel possible within a day would encompass the entire world.</li>
<li><strong>Alan Shepard’s Mercury Redstone:</strong> A historical example of achieving such speeds, though with significant fuel consumption (50,000 pounds).</li>
<li><strong>Chemical Energy Limitations:</strong> Hypersonic travel with chemical energy sources is impractical.</li>
</ul>
</section>
<section id="electric-jets-and-propulsion-technologies" class="level4">
<h4 class="anchored" data-anchor-id="electric-jets-and-propulsion-technologies">Electric Jets and Propulsion Technologies</h4>
<section id="electric-ducted-fans" class="level5">
<h5 class="anchored" data-anchor-id="electric-ducted-fans">Electric Ducted Fans</h5>
<ul>
<li><strong>Electric Jet (Model Aircraft):</strong> A ducted fan powered by an electric motor.</li>
<li><strong>Modern Technology:</strong> Rare earth magnets and other innovations allow for electric motors with power-to-weight ratios comparable to turbines.</li>
<li><strong>Superconducting Motors:</strong> Full-size superconducting motors could achieve even better ratios.</li>
<li><strong>Optimization:</strong> Electric motors enable better placement and control of thrusters, potentially allowing for separate lift and cruise motors.</li>
<li><strong>Schubeler DS215DIA HST:</strong> Example of a high-thrust electric ducted fan:
<ul>
<li>56 pounds of thrust from 15.6 kilowatts (21 horsepower)</li>
<li>8-inch package</li>
<li>75 units could lift a flying car (noisy)</li>
<li>1,170 kilowatts total power needed</li>
</ul></li>
<li><strong>Winged Aircraft with Runway:</strong>
<ul>
<li>Only about 10 units needed (150 kilowatts)</li>
</ul></li>
<li><strong>Advantages of Multiple Small Fans:</strong>
<ul>
<li>Increased reliability (redundancy)</li>
<li>Improved flight efficiency (better airflow control)</li>
<li>Reduced noise</li>
</ul></li>
<li><strong>NASA’s X-57 Maxwell:</strong> Example of an electric airplane using multiple small fans.</li>
</ul>
</section>
<section id="battery-limitations" class="level5">
<h5 class="anchored" data-anchor-id="battery-limitations">Battery Limitations</h5>
<ul>
<li><strong>Weight:</strong> Batteries are significantly heavier than equivalent energy in fuel.
<ul>
<li>Example: 360 pounds of Avgas (aviation fuel) vs.&nbsp;3 tons of lithium-ion batteries for the same energy.</li>
<li>Cost of batteries: $170,000 (without charging circuitry)</li>
</ul></li>
<li><strong>Spontaneous Combustion:</strong> Lithium-ion batteries are prone to catching fire.
<ul>
<li>Examples: Electric aircraft companies experiencing battery-caused ground fires.</li>
</ul></li>
<li><strong>Crash Safety Concerns:</strong> Ruptured batteries release energy instantly, potentially causing more severe fires than ruptured fuel tanks.
<ul>
<li>Example: Tesla crash requiring 30,000 gallons of water over 4 hours to extinguish.</li>
</ul></li>
</ul>
</section>
<section id="fuel-cells" class="level5">
<h5 class="anchored" data-anchor-id="fuel-cells">Fuel Cells</h5>
<ul>
<li><strong>Fuel Cells:</strong> Electrochemical devices that convert chemical energy into electricity.</li>
<li><strong>Improvements since the 1960s:</strong> Steady improvements in efficiency and power density.</li>
<li><strong>Current State-of-the-Art:</strong>
<ul>
<li>Ultralight custom-built fuel cells at $10,000 per kilowatt.</li>
<li>Power density comparable to piston engines (1 kilowatt per kilogram).</li>
<li>Example: 250-pound piston engine vs.&nbsp;300-pound fuel cell equivalent.</li>
</ul></li>
<li><strong>Limitations:</strong>
<ul>
<li>Suitable for conventional airplanes and helicopters, but not compact VTOLs.</li>
<li><strong>Hydrogen Storage:</strong> Fuel cells typically use pure hydrogen, which is difficult to store and handle.
<ul>
<li>Hydrogen causes metal embrittlement and sealing issues.</li>
<li>Hydrogen is very light, requiring large storage containers.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="ammonia-as-a-hydrogen-source" class="level5">
<h5 class="anchored" data-anchor-id="ammonia-as-a-hydrogen-source">Ammonia as a Hydrogen Source</h5>
<ul>
<li><strong>Ammonia (NH3):</strong> A potential solution for hydrogen storage.</li>
<li><strong>Advantages:</strong>
<ul>
<li>Higher hydrogen density per gallon than liquid hydrogen.</li>
<li>Widely produced industrial chemical with existing infrastructure (pipelines).</li>
<li>Price per energy comparable to fossil fuels.</li>
</ul></li>
<li><strong>Ammonia Fuel Cells:</strong>
<ul>
<li>Advanced from laboratory to commercial deployment in the 2010s.</li>
<li>Currently used for remote power generation and backup, but too heavy for vehicles.</li>
<li>Potential for improvement in the coming decade.</li>
</ul></li>
</ul>
</section>
<section id="turbine-generators" class="level5">
<h5 class="anchored" data-anchor-id="turbine-generators">Turbine Generators</h5>
<ul>
<li><strong>Turbine Generators:</strong> As of 2021, the best option for powering electric fan VTOLs.</li>
<li><strong>Availability:</strong> Can be bought off-the-shelf (used as auxiliary power units in airliners).</li>
<li><strong>Weight Advantage:</strong> Turbine generator plus electric fan motors can be lighter than a direct-coupled piston engine.</li>
<li><strong>Future Potential of Fuel Cells:</strong> Fuel cells are expected to become lighter and quieter in the future.</li>
</ul>
</section>
<section id="hypersonic-runabout-power-source" class="level5">
<h5 class="anchored" data-anchor-id="hypersonic-runabout-power-source">Hypersonic Runabout Power Source</h5>
<ul>
<li><strong>Alan Shepard’s Mercury Redstone:</strong> Carried 50,000 pounds of fuel and oxidizer (7 terajoules of energy).</li>
<li><strong>Energy Requirements for Hypersonic Flight:</strong> 50 gigajoules for a 3,000-pound car (140 times less than the Redstone).</li>
<li><strong>Uranium as a Potential Fuel:</strong> With efficient energy extraction, a hypersonic trip could cost about 15 cents worth of uranium (0.1 grams).</li>
</ul>
</section>
<section id="ionic-thrusters" class="level5">
<h5 class="anchored" data-anchor-id="ionic-thrusters">Ionic Thrusters</h5>
<ul>
<li><strong>Ionic Thrust:</strong> A method of propulsion that uses electric charge to accelerate air.</li>
<li><strong>Mechanism:</strong>
<ul>
<li>Electric charge sprayed into the air, creating ions.</li>
<li>Electric field applied to the charged air, generating thrust.</li>
</ul></li>
<li><strong>History:</strong> Ionic fans have been laboratory curiosities for decades.</li>
<li><strong>MIT Research (2013):</strong> Rigorous evaluation of ionic thrust by Stephen Barrett and Kento Masuyama.</li>
<li><strong>Findings:</strong>
<ul>
<li>Ionic thrusters could produce over 100 newtons (22 pounds) of thrust per kilowatt.</li>
<li>Significantly more efficient than electric jets (6.25 kilowatts per 100 newtons).</li>
<li>A 3,000-pound car could achieve VTOL with a 180-horsepower motor.</li>
</ul></li>
<li><strong>Limitations:</strong>
<ul>
<li>High efficiency depends on moving a large volume of air slowly (similar to helicopter blades).</li>
<li><strong>Safety Concerns:</strong> High voltage sprayed into the air presents potential hazards (especially in rain).</li>
</ul></li>
<li><strong>MIT’s First Powered Flight with No Moving Parts (2018):</strong> Demonstrated the potential of ionic thrust.</li>
<li><strong>Power Supply Weight:</strong> High-power, high-voltage power supplies are currently heavy but could be improved with second atomic age technology.</li>
</ul>
</section>
<section id="stratospheric-applications-of-ionic-thrust" class="level5">
<h5 class="anchored" data-anchor-id="stratospheric-applications-of-ionic-thrust">Stratospheric Applications of Ionic Thrust</h5>
<ul>
<li><strong>Stratospheric Advantages:</strong> Thin, cold, and dry air is ideal for ionic thrust.</li>
<li><strong>Natural Ionization:</strong> The sun already ionizes the air at high altitudes.</li>
<li><strong>Ozone Layer Benefit:</strong> Ionic thrusters could potentially benefit the ozone layer.</li>
<li><strong>Potential Synergy with Nuclear Energy:</strong> Beta emission (high-energy electrons) could be used to power ionic thrusters.</li>
</ul>
</section>
<section id="circulation-control" class="level5">
<h5 class="anchored" data-anchor-id="circulation-control">Circulation Control</h5>
<ul>
<li><strong>Circulation Control:</strong> A technique that uses high-pressure air jets to enhance lift and control airflow.</li>
<li><strong>Dyson Bladeless Fan:</strong> An example of circulation control in a consumer product.</li>
<li><strong>Benefits:</strong>
<ul>
<li>Improved lift-to-drag ratios</li>
<li>High-lift effects without external moving parts</li>
<li>Increased effective wing aspect ratio</li>
</ul></li>
<li><strong>Advantages for Telescoping/Folding Wings:</strong> Eliminates the need for hinges, flaps, and actuators, leading to lighter wings.</li>
<li><strong>Research and Development:</strong> NASA and other institutions have been researching circulation control since the 1970s.</li>
<li><strong>Mark Moore’s Research:</strong> Exploring the use of circulation control in propeller ducts for optimizing performance in different flight regimes.</li>
</ul>
</section>
</section>
</section>
<section id="designing-your-flying-car" class="level3">
<h3 class="anchored" data-anchor-id="designing-your-flying-car">Designing Your Flying Car</h3>
<section id="wingless-aircraft-and-lifting-bodies" class="level4">
<h4 class="anchored" data-anchor-id="wingless-aircraft-and-lifting-bodies">Wingless Aircraft and Lifting Bodies</h4>
<ul>
<li><strong>Do We Need Wings?</strong> Wingless aircraft, known as <strong>lifting bodies</strong>, have been tested.</li>
<li><strong>NASA’s M2F-1:</strong>
<ul>
<li>Car-sized lifting body built of plywood and steel.</li>
<li>Capable of gliding at 100 knots.</li>
<li>Towed by a Pontiac in many tests.</li>
</ul></li>
</ul>
</section>
<section id="stability-considerations" class="level4">
<h4 class="anchored" data-anchor-id="stability-considerations">Stability Considerations</h4>
<ul>
<li><strong>Airplane Tie-Downs:</strong> Airplanes are susceptible to being blown around by wind gusts.</li>
<li><strong>Car Stability:</strong> Cars are much less affected by wind due to their lower profile and higher weight relative to surface area.</li>
<li><strong>Wing Loading:</strong> Weight of the aircraft per unit area of the wing.</li>
</ul>
</section>
<section id="designing-a-car-sized-lifting-body" class="level4">
<h4 class="anchored" data-anchor-id="designing-a-car-sized-lifting-body">Designing a Car-Sized Lifting Body</h4>
<ul>
<li><strong>Assumptions:</strong>
<ul>
<li>One-ton aircraft with 1,000-pound payload (typical for a small plane).</li>
<li>Multiple small thrusters, circulation control, and a lifting body design.</li>
<li>Wing loading of 30 pounds per square foot.</li>
</ul></li>
<li><strong>Comparison to Other Aircraft:</strong>
<ul>
<li>High for a small plane (Piper Cub: 6, Beechcraft Bonanza: 25).</li>
<li>Low for a jet (Cessna Citation: 40, Boeing 747: 150).</li>
</ul></li>
<li><strong>Takeoff and Landing Speed:</strong> Around 100 knots.</li>
<li><strong>Low Aspect Ratio Wing:</strong> Requires air curtains and boundary layer control for efficient flight.</li>
</ul>
</section>
<section id="arthur-c.-clarkes-vision-of-aircars" class="level4">
<h4 class="anchored" data-anchor-id="arthur-c.-clarkes-vision-of-aircars">Arthur C. Clarke’s Vision of Aircars</h4>
<ul>
<li><strong>Childhood’s End:</strong> Depicts small, wingless aircars propelled by jet reaction and boundary layer control.</li>
<li><strong>Differences from Potential Reality:</strong>
<ul>
<li>Flying cars would likely be larger than ground cars to interact with enough air for flight.</li>
<li>Crumple zones would be needed for ground safety.</li>
</ul></li>
<li><strong>High Wing Loading:</strong> Smaller cars or heavier full-size cars could be used to increase wing loading, improving stability and reducing turbulence sensitivity.</li>
<li><strong>Power Requirements:</strong> 1,000 horsepower turbine or equivalent power source would be needed due to the use of forced air for circulation control.</li>
</ul>
</section>
<section id="vtol-capability-and-drag-considerations" class="level4">
<h4 class="anchored" data-anchor-id="vtol-capability-and-drag-considerations">VTOL Capability and Drag Considerations</h4>
<ul>
<li><strong>VTOL Feasibility:</strong> Theoretically possible with down-blowing fans in the trunk and hood.</li>
<li><strong>Historical Examples:</strong> Air jeeps of the 1960s used similar designs.</li>
<li><strong>Space Constraints:</strong> Room for engine, passenger compartment, and other components is a challenge.</li>
<li><strong>Schubeler Electric Jets:</strong>
<ul>
<li>Only 20 square feet of footprint needed for 3,000 pounds of lift (54 jets, 850 kilowatts).</li>
<li>De-rated jets (10 kilowatts, 64 jets) could be used for lower power consumption (640 kilowatts).</li>
</ul></li>
<li><strong>Doke VZ-4:</strong> Used 1,000 horsepower in 50 square feet of lift fan area.</li>
<li><strong>Footprint Options:</strong>
<ul>
<li>50 square feet for passengers, engine, etc.</li>
<li>Expanding to 100 square feet (similar to a Ford F-150 or 1959 Cadillac) is possible.</li>
</ul></li>
<li><strong>Battery Limitations:</strong> Current battery technology would limit flight time to about 10 minutes.</li>
<li><strong>Turbine Power:</strong> Currently the most practical power source for VTOL flying cars.</li>
<li><strong>VTOL vs.&nbsp;Range/Load Trade-Off:</strong> VTOL capability reduces range and/or payload capacity.</li>
<li><strong>Doke VZ-4 Range:</strong> One hour of flight time.</li>
<li><strong>Passenger Capacity:</strong> VTOL design likely limits capacity to two passengers.</li>
</ul>
</section>
<section id="nanotech-and-the-future-of-flying-cars" class="level4">
<h4 class="anchored" data-anchor-id="nanotech-and-the-future-of-flying-cars">Nanotech and the Future of Flying Cars</h4>
<ul>
<li><strong>Nanotech Advantages:</strong> Eliminates the need to thermalize chemical energy, leading to higher efficiency and lighter engines.</li>
<li><strong>Fuel Efficiency:</strong> Three to four times more usable energy from fuel.</li>
<li><strong>Hydrogen Fuel:</strong> Three times the energy-to-weight ratio of gasoline.</li>
<li><strong>Nanotech Power Mills:</strong> Could further increase efficiency by a factor of 3.</li>
<li><strong>Hydrogen Storage:</strong> Lighter than carbon-based fuels, but potentially just as bulky.</li>
<li><strong>Engine Weight Reduction:</strong> Nanotech could significantly reduce engine weight.</li>
<li><strong>Structural Weight Reduction:</strong> Nanotech could also reduce the weight of the aircraft structure.</li>
<li><strong>Morphing Structures:</strong> Nanotech enables the creation of powered, morphing wings and propellers.</li>
<li><strong>Impeller Arrays:</strong> Instead of propellers or ducted fans, designs could use arrays of smaller impellers.</li>
<li><strong>Advantages of Impeller Arrays:</strong>
<ul>
<li>Robustness to individual impeller failure</li>
<li>Improved control responsiveness</li>
<li>Reduced noise and turbulence</li>
</ul></li>
<li><strong>Quiet VTOL:</strong> Nanotech could enable VTOL aircraft that are significantly quieter.</li>
<li><strong>Design Challenge:</strong> Maintaining subsonic airflow and minimizing turbulence.</li>
</ul>
</section>
</section>
<section id="autopilots-for-flying-cars" class="level3">
<h3 class="anchored" data-anchor-id="autopilots-for-flying-cars">Autopilots for Flying Cars</h3>
<section id="autopilot-technology" class="level4">
<h4 class="anchored" data-anchor-id="autopilot-technology">Autopilot Technology</h4>
<ul>
<li><strong>Autopilot Capabilities:</strong> Even older airplanes can have autopilots that navigate to destinations.</li>
<li><strong>Mechanical Autopilots:</strong> Systems for maintaining heading and altitude have existed since the 1930s.</li>
<li><strong>GPS Integration:</strong> Modern autopilots use GPS for navigation.</li>
<li><strong>Commercial Autopilot Systems:</strong> Can land planes automatically.</li>
<li><strong>Garmin Autoland System:</strong> An example of an emergency auto-landing system available in high-end private aircraft.</li>
<li><strong>Autoland Functionality:</strong>
<ul>
<li>Alerts air traffic control</li>
<li>Plots a course to the nearest airport</li>
<li>Flies to the airport and lands</li>
</ul></li>
<li><strong>Autopilot Reliability:</strong> Autopilots can fail, and pilots must be ready to take over.</li>
<li><strong>Pilot Training:</strong> Learning to turn off the autopilot is a crucial first step in pilot training.</li>
<li><strong>Autopilot Kill Switches:</strong> Multiple ways to disable the autopilot are typically provided.</li>
</ul>
</section>
<section id="autopilots-for-flying-cars-1" class="level4">
<h4 class="anchored" data-anchor-id="autopilots-for-flying-cars-1">Autopilots for Flying Cars</h4>
<ul>
<li><strong>Safety Considerations:</strong> The reliability of autopilots is a key concern for flying cars.</li>
<li><strong>Human Pilot vs.&nbsp;Autopilot Reliability:</strong> The goal is to make autopilots at least as reliable as human pilots.</li>
<li><strong>Pilot Instincts:</strong> Humans lack natural instincts for flight, making piloting more challenging than driving.</li>
<li><strong>VTOL Difficulty:</strong> Flying in VTOL mode is particularly challenging.</li>
<li><strong>Remote-Controlled Quadrotor Experience:</strong> VTOL drones are significantly harder to fly than conventional airplanes.</li>
<li><strong>VTOL Crash History:</strong> Many experimental VTOL aircraft have been crashed by experienced pilots.</li>
<li><strong>Automatic Pilot with Artificial Sensorium:</strong>
<ul>
<li>A potential solution for safer VTOL flight.</li>
<li>Direct connection to sensors that provide detailed information about airflow and aircraft status.</li>
</ul></li>
<li><strong>Existing Technology:</strong> Commercial airplanes and hobby drones already have sophisticated autopilots.</li>
</ul>
</section>
</section>
<section id="highways-in-the-sky" class="level3">
<h3 class="anchored" data-anchor-id="highways-in-the-sky">Highways in the Sky</h3>
<section id="roadway-infrastructure" class="level4">
<h4 class="anchored" data-anchor-id="roadway-infrastructure">Roadway Infrastructure</h4>
<ul>
<li><strong>U.S. Roadway Mileage:</strong> Approximately 4 million miles (2.6 million paved).</li>
<li><strong>Interstate System:</strong> About 50,000 miles.</li>
</ul>
</section>
<section id="airspace-as-usable-right-of-way" class="level4">
<h4 class="anchored" data-anchor-id="airspace-as-usable-right-of-way">Airspace as Usable Right of Way</h4>
<ul>
<li><strong>Contiguous U.S. Area:</strong> Around 3 million square miles.</li>
<li><strong>Usable Altitude:</strong> About 10 miles.</li>
<li><strong>Safe Altitude for Non-Pressurized Aircraft:</strong> 2 miles.</li>
<li><strong>Current Aircraft Separation Regulations:</strong>
<ul>
<li>1,000 feet vertical separation</li>
<li>5 miles horizontal separation</li>
</ul></li>
<li><strong>Limitations of Current Regulations:</strong> Based on manual altitude control and voice communication with air traffic controllers.</li>
<li><strong>Potential for Closer Spacing:</strong> Aircraft could safely fly closer together with advanced electronic control systems.</li>
<li><strong>Hypothetical Airspace Capacity:</strong>
<ul>
<li>Current regulations: 30 million miles of high-speed “highway” (600 times the length of the interstate system).</li>
<li>1-mile horizontal separation: 150 million miles of lanes.</li>
</ul></li>
<li><strong>Potential Number of Aircraft:</strong> Millions of aircraft could potentially be accommodated in the airspace simultaneously.</li>
</ul>
</section>
<section id="limitations-of-current-air-traffic-control-atc" class="level4">
<h4 class="anchored" data-anchor-id="limitations-of-current-air-traffic-control-atc">Limitations of Current Air Traffic Control (ATC)</h4>
<ul>
<li><strong>ATC System:</strong> Outdated compared to modern distributed control systems like the internet.</li>
<li><strong>Voice Communication:</strong> ATC relies on voice communication in English with human controllers.</li>
<li><strong>Capacity Limitations:</strong> The system often operates near its capacity limits.</li>
<li><strong>Fragility:</strong> The system is vulnerable to disruptions (e.g., the Chicago Center incident).</li>
<li><strong>Expansion Challenges:</strong> Difficult and costly to expand the current system.</li>
<li><strong>Inability to Handle Flying Car Traffic:</strong> The current ATC system could not manage the traffic volume of widespread flying car usage.</li>
</ul>
</section>
<section id="decentralized-traffic-control" class="level4">
<h4 class="anchored" data-anchor-id="decentralized-traffic-control">Decentralized Traffic Control</h4>
<ul>
<li><strong>Ground Traffic Control Analogy:</strong> We don’t need centralized control for ground traffic (cars or pedestrians).</li>
<li><strong>Bird Flocking:</strong> Birds demonstrate the feasibility of complex flight patterns with decentralized control.</li>
<li><strong>Seagull Flock Tornado:</strong> An example of highly coordinated flight without centralized control.</li>
</ul>
</section>
<section id="technologies-for-decentralized-aircraft-control" class="level4">
<h4 class="anchored" data-anchor-id="technologies-for-decentralized-aircraft-control">Technologies for Decentralized Aircraft Control</h4>
<ul>
<li><strong>Anti-Collision Strobes:</strong> Visible at night, but would create excessive light pollution with high traffic density.</li>
<li><strong>Radar Frequency Beacons:</strong> Could transmit aircraft position, altitude, and course data.</li>
<li><strong>Autopilot Integration:</strong> Autopilots could use beacon data to maintain safe separation.</li>
<li><strong>Cell Phone Tower Network:</strong>
<ul>
<li>Approximately 200,000 cell towers in the U.S. (one per 15 square miles, average distance of 4 miles).</li>
<li>Aircraft are typically in view of 10-100 towers at cruising altitude.</li>
</ul></li>
<li><strong>Tower-Based Aircraft Tracking:</strong> Towers could be equipped to track and communicate with aircraft, similar to how they handle cell phones.</li>
<li><strong>GPS and Inter-Car Communication:</strong> These technologies, combined with tower-based tracking, could enable decentralized air traffic management.</li>
</ul>
</section>
<section id="automatic-dependent-surveillance-broadcast-ads-b" class="level4">
<h4 class="anchored" data-anchor-id="automatic-dependent-surveillance-broadcast-ads-b">Automatic Dependent Surveillance-Broadcast (ADS-B)</h4>
<ul>
<li><strong>ADS-B:</strong> A system that broadcasts aircraft position and altitude data to ground stations and other aircraft.</li>
<li><strong>Implementation:</strong>
<ul>
<li>Uses 634 government-run ground stations (covers most of the continental U.S.).</li>
<li>ADS-B Out (mandatory in some areas): Aircraft transmit their position and altitude.</li>
<li>ADS-B In (optional): Aircraft receive traffic information from the system.</li>
</ul></li>
<li><strong>Benefits:</strong>
<ul>
<li>Provides more complete and accurate information to air traffic controllers.</li>
<li>Gives pilots situational awareness they wouldn’t otherwise have.</li>
</ul></li>
<li><strong>Limitations:</strong> Still requires a major overhaul of ATC to handle flying car traffic.</li>
</ul>
</section>
<section id="unmanned-aircraft-system-traffic-management-utm" class="level4">
<h4 class="anchored" data-anchor-id="unmanned-aircraft-system-traffic-management-utm">Unmanned Aircraft System Traffic Management (UTM)</h4>
<ul>
<li><strong>UTM:</strong> A system designed to manage low-altitude drone operations.</li>
<li><strong>Purpose:</strong> To organize, coordinate, and manage multiple Beyond Visual Line of Sight (BVLOS) drone flights.</li>
<li><strong>Current Capabilities:</strong> Primarily supports automatic notification of airports about drone activity.</li>
<li><strong>Potential for Development:</strong> Increased drone usage and experimentation could drive advancements in UTM.</li>
</ul>
</section>
<section id="drone-traffic-control-systems" class="level4">
<h4 class="anchored" data-anchor-id="drone-traffic-control-systems">Drone Traffic Control Systems</h4>
<ul>
<li><strong>Industry Projects:</strong> Various companies are developing distributed drone traffic control systems.</li>
<li><strong>Drone Coordination Research:</strong> Active research and development in this area.</li>
<li><strong>Drones as a Testing Ground:</strong> Drones provide a platform for exploring and testing decentralized air traffic management solutions.</li>
</ul>
</section>
</section>
<section id="conclusion-4" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-4">Conclusion</h3>
<ul>
<li><strong>Technical Feasibility:</strong> Building a flying car with VTOL capability and high speed is technically possible today.</li>
<li><strong>Cost:</strong> Currently too expensive for the average person, but nanotech could make it affordable in the future.</li>
<li><strong>Noise Reduction:</strong> Nanotech could also lead to quieter flying cars.</li>
<li><strong>Spectrum of Flying Car Capabilities:</strong> A range of options will likely exist, from small airport-based planes to high-speed, long-range VTOL vehicles.</li>
<li><strong>Performance vs.&nbsp;Price:</strong> Unlike ground cars, the price of flying cars will likely be directly related to their capabilities.</li>
<li><strong>The Ultimate Flying Car:</strong> Full second atomic age technology could lead to private spaceships.</li>
</ul>
</section>
</section>
<section id="chapter-17-escape-velocity" class="level2">
<h2 class="anchored" data-anchor-id="chapter-17-escape-velocity">Chapter 17: Escape Velocity</h2>
<section id="jules-vernes-vision-of-space-travel" class="level3">
<h3 class="anchored" data-anchor-id="jules-vernes-vision-of-space-travel">Jules Verne’s Vision of Space Travel</h3>
<ul>
<li><strong>Quote:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“In spite of the opinions of certain narrow-minded people, who would shut up the human race upon this globe as within some magic circle it must never outstep, we shall one day travel to the moon, the planets, the stars, with the same facility, rapidity, and certainty as we now make the voyage from Liverpool to New York.” - Jules Verne, From the Earth to the Moon</p>
</blockquote></li>
</ul></li>
</ul>
</section>
<section id="technological-stagnation-in-space-travel" class="level3">
<h3 class="anchored" data-anchor-id="technological-stagnation-in-space-travel">Technological Stagnation in Space Travel</h3>
<ul>
<li><strong>Question:</strong> How can futurists be optimistic about future technology when space travel, a highly hyped technological application, has seen regression rather than progress since 1962?</li>
<li><strong>Answer 1 (Political Stunt):</strong>
<ul>
<li>Project Apollo was a political stunt.</li>
<li>Once publicity was achieved, there was no reason to continue moon missions due to the cost.</li>
<li>Repeating political stunts is ineffective.</li>
</ul></li>
<li><strong>Answer 2 (Bureaucracy):</strong>
<ul>
<li>Technological stagnation is caused by bureaucratic ossification and incompetence.</li>
</ul></li>
</ul>
</section>
<section id="the-challenger-disaster-and-nasas-bureaucracy" class="level3">
<h3 class="anchored" data-anchor-id="the-challenger-disaster-and-nasas-bureaucracy">The Challenger Disaster and NASA’s Bureaucracy</h3>
<ul>
<li><strong>Example:</strong> The Challenger disaster on January 28, 1986, illustrates bureaucratic failure.
<ul>
<li><strong>Cold Weather and O-Rings:</strong> A cold wave stiffened the O-rings in the Space Shuttle Challenger’s solid rocket boosters, causing a gas leak and the vehicle’s breakup.</li>
<li><strong>Rogers Commission and Feynman’s Demonstration:</strong> The Rogers Commission investigated the disaster, with Richard Feynman demonstrating the O-ring issue using ice water.</li>
<li><strong>Ignored Warnings:</strong> Alan MacDonald, director of the Solid Rocket Motor Project, warned about the O-ring problem and refused to approve the launch.</li>
<li><strong>Punishment for Foresight:</strong> MacDonald was demoted for his responsible actions.</li>
<li><strong>Communication Gap:</strong> Feynman threatened to resign from the commission unless it addressed the communication gap between NASA engineers and management.</li>
</ul></li>
<li><strong>Dilbertization of NASA:</strong> NASA’s bureaucratic issues worsened over time, though the agency represented a best-case scenario in the 1960s due to its talented personnel, common goals, and well-defined tasks.</li>
<li><strong>Shuttle Program Failure:</strong> The Space Shuttle program, aimed at reducing the cost to orbit, ultimately failed to meet its goals.
<ul>
<li><strong>Cost Goal vs.&nbsp;Reality:</strong> The goal was $100 per pound; the lowest achieved was $10,000 per pound.</li>
<li><strong>Launch Frequency Goal vs.&nbsp;Reality:</strong> The goal was once a week; the average was once in 11 weeks.</li>
<li><strong>Shuttle Reliability:</strong> The shuttle had a 1.5% failure rate, resulting in the death of everyone on board during failures.</li>
<li><strong>Airliner Comparison:</strong> If airliners had the same reliability, there would be 1,600 fatal crashes daily.</li>
</ul></li>
</ul>
</section>
<section id="the-failure-of-space-colonies" class="level3">
<h3 class="anchored" data-anchor-id="the-failure-of-space-colonies">The Failure of Space Colonies</h3>
<ul>
<li><strong>Space Colonies Vision:</strong> The idea of space colonies, envisioned by Gerard O’Neill, gained significant support through the L5 Society and technical/economic analysis.</li>
<li><strong>Failure due to NASA and Shuttle:</strong> The movement failed largely because of NASA’s and the shuttle program’s failures.</li>
</ul>
</section>
<section id="lessons-from-the-moon-landings-and-airliner-speed-trends" class="level3">
<h3 class="anchored" data-anchor-id="lessons-from-the-moon-landings-and-airliner-speed-trends">Lessons from the Moon Landings and Airliner Speed Trends</h3>
<ul>
<li><strong>Moon Landings as Exploration:</strong> The moon landings were similar to the Lewis and Clark expedition, exploring both physical and technological territory and changing perceptions of spaceflight.</li>
<li><strong>Airliner Speed Trend Curve:</strong> The curve shows the capabilities of underlying technology, which continued to evolve even during the Great Stagnation.</li>
<li><strong>Future of Commercial Space Travel:</strong> Commercial space travel will likely reappear along the same curve when technology matches useful and economical activities.</li>
<li><strong>Orbital Travel Prediction:</strong> The curve suggests aircraft could reach low Earth orbital speeds in the coming decade, making orbital travel an efficient option.</li>
<li><strong>Rise of Private Space Launch:</strong> Private space launch capabilities are surpassing government ones in the U.S., potentially leading to a significant orbital presence and a return to the moon before 2030.</li>
<li><strong>Orbital Space Stations:</strong> Fast, long-distance orbital travel will likely make orbital space stations economically viable.</li>
</ul>
</section>
<section id="rocket-science-and-fuel-requirements" class="level3">
<h3 class="anchored" data-anchor-id="rocket-science-and-fuel-requirements">Rocket Science and Fuel Requirements</h3>
<ul>
<li><strong>Rockets and Fuel:</strong> Rockets require a massive amount of fuel.</li>
<li><strong>Understanding Fuel Requirements (Analogy):</strong>
<ul>
<li>Imagine standing in mid-air, 10 miles up, and needing to prevent falling.</li>
<li>You jump off a rock your weight, staying up briefly.</li>
<li>To stay up longer, you need to jump off progressively larger rocks, doubling the weight for each additional second.</li>
</ul></li>
<li><strong>Rockets and Specific Impulse:</strong>
<ul>
<li><strong>Specific Impulse:</strong> The velocity at which you can jump off the rock (analogy), measured in seconds before needing another jump.</li>
<li><strong>Mass Ratio:</strong> The total weight of the rocks (analogy) you bring, in multiples of your own weight.</li>
<li><strong>Chemical Rocket Specific Impulse:</strong> Ranges from 300 to 400 seconds.</li>
</ul></li>
</ul>
</section>
<section id="nuclear-powered-rockets-in-science-fiction-and-reality" class="level3">
<h3 class="anchored" data-anchor-id="nuclear-powered-rockets-in-science-fiction-and-reality">Nuclear-Powered Rockets in Science Fiction and Reality</h3>
<ul>
<li><strong>Nuclear Rockets in Science Fiction:</strong> Science fiction writers in the 1950s often envisioned nuclear-powered rockets for space exploration.
<ul>
<li><strong>Heinlein’s Novels and Movies:</strong> Featured nuclear rockets.</li>
<li><strong>Blake Savage (Hal Goodwin):</strong> A scientist and writer who accurately depicted nuclear spaceships in his 1952 novel, Rip Foster Rides the Gray Planet.</li>
<li><strong>2001: A Space Odyssey:</strong> The Discovery One spaceship featured a nuclear reactor for propulsion, with design considerations for radiation shielding.</li>
</ul></li>
<li><strong>NERVA Project:</strong>
<ul>
<li>A real-life project in the 1960s that experimented with nuclear thermal rockets.</li>
<li>Limited by material capabilities, achieving a specific impulse of around 800 seconds, twice that of chemical rockets.</li>
</ul></li>
<li><strong>Lack of Research and Development:</strong> The predicted research and development of gaseous core nuclear reactors in the 1980s and 90s did not materialize.</li>
<li><strong>Potential Revival of Nuclear Rockets:</strong>
<ul>
<li>DARPA has awarded a contract to General Atomics to design a small nuclear reactor for space propulsion.</li>
<li>Advances in technologies like superconducting magnets could benefit fusion rocket engines.</li>
</ul></li>
<li><strong>Nuclear-to-Electric-to-Ion Rockets:</strong>
<ul>
<li>Not yet demonstrated but a potential next step.</li>
<li>Prototypes suggest a specific impulse of around 3,000 seconds.</li>
</ul></li>
<li><strong>Direct Fusion-to-Jet Rockets:</strong>
<ul>
<li>Potentially the ultimate reaction rocket, using processes like the Proton Plus Lithium-7 fusion fission reaction.</li>
<li>Could achieve a specific impulse of roughly 2 million seconds.</li>
<li>Example: A 10-ton spaceship with 1 ton of fuel could accelerate at 1G for two days.</li>
</ul></li>
</ul>
</section>
<section id="advantages-of-nuclear-rockets-for-solar-system-exploration" class="level3">
<h3 class="anchored" data-anchor-id="advantages-of-nuclear-rockets-for-solar-system-exploration">Advantages of Nuclear Rockets for Solar System Exploration</h3>
<ul>
<li><strong>Limitations of Chemical Rockets:</strong> Chemical rockets are limited to low-energy, long-duration trajectories, such as the eight-month Hohmann transfer orbit to Mars, with launch windows every 26 months.</li>
<li><strong>High-Energy, Low-Time Trajectories with Nuclear Rockets:</strong> Nuclear rockets enable faster travel with more flexible trajectories.</li>
<li><strong>Example:</strong>
<ul>
<li>Accelerating at 1G for one day covers 50 gigameters and achieves a speed of 3.6 gigameters per hour.</li>
<li>Earth and Mars orbital speeds are around 0.1 gigameters per hour.</li>
<li>A typical trip could involve one day of acceleration, a few days of coasting, and one day of deceleration, resulting in a near-straight-line trajectory.</li>
</ul></li>
</ul>
</section>
<section id="project-orion-a-spaceship-propelled-by-nuclear-explosions" class="level3">
<h3 class="anchored" data-anchor-id="project-orion-a-spaceship-propelled-by-nuclear-explosions">Project Orion: A Spaceship Propelled by Nuclear Explosions</h3>
<section id="ted-taylors-vision" class="level4">
<h4 class="anchored" data-anchor-id="ted-taylors-vision">Ted Taylor’s Vision</h4>
<ul>
<li><strong>Ted Taylor:</strong> A nuclear engineer who designed both the smallest and largest fission devices in the U.S.</li>
<li><strong>Barber Chair in a Spaceship:</strong> Taylor’s insistence on a barber chair symbolized his vision of a spaceship as a large, comfortable vessel like an ocean liner, not a small capsule.</li>
</ul>
</section>
<section id="project-orions-development" class="level4">
<h4 class="anchored" data-anchor-id="project-orions-development">Project Orion’s Development</h4>
<ul>
<li><strong>Project Orion:</strong> The first study funded by ARPA (later DARPA) and the second major project of General Atomics.</li>
<li><strong>Serious Engineering Effort:</strong> Started in 1959, involving top minds like Freeman Dyson, with some design elements still classified.</li>
<li><strong>Nuclear Propulsion:</strong> Orion was designed to be propelled by a series of nuclear explosions behind it.</li>
<li><strong>Inspiration:</strong> The idea came from a nuclear test where metal spheres survived a nearby explosion relatively unharmed.</li>
<li><strong>Stanislav Ulam’s Influence:</strong> Ulam, co-inventor of the hydrogen bomb, was intrigued by using nuclear explosions for propulsion, leading to Taylor heading the project.</li>
</ul>
</section>
<section id="orions-design-and-feasibility" class="level4">
<h4 class="anchored" data-anchor-id="orions-design-and-feasibility">Orion’s Design and Feasibility</h4>
<ul>
<li><strong>Design:</strong> 150 feet in diameter, 4,000 tons, built of steel using shipbuilding techniques.</li>
<li><strong>Feasibility:</strong> Deemed feasible with 1960s technology.</li>
<li><strong>Expectations:</strong> Scientists anticipated visiting Saturn’s moons by the 1970s.</li>
</ul>
</section>
<section id="super-orion-and-interstellar-travel" class="level4">
<h4 class="anchored" data-anchor-id="super-orion-and-interstellar-travel">Super-Orion and Interstellar Travel</h4>
<ul>
<li><strong>Super-Orion:</strong> A concept using hydrogen fusion bombs for propulsion.</li>
<li><strong>Dyson’s Quote:</strong>
<ul>
<li><blockquote class="blockquote">
<p>“A ship with a million-ton payload could escape from the Earth with the expenditure of about 1,000 H-bombs with yields of a few megatons. The fuel cost of such a mission would be about five cents per pound of payload, at present prices. Each bomb would be surrounded by a thousand tons of inert propellant material, and it would be easy to load this material with boron to such an extent that practically no neutrons escape to the atmosphere. The atmospheric contamination would only arise from tritium and from fission products. Preliminary studies indicate that the tritium contamination from such a series of high-yield explosions would not approach biologically significant levels.”</p>
</blockquote></li>
</ul></li>
<li><strong>Largest Ship Size:</strong> Estimated at 8 million tons, potentially carrying 200,000 people in comfort (compared to a modern cruise ship at 126,000 tons carrying 3,000 people).</li>
<li><strong>Atmospheric Contamination:</strong> Total contamination per launch remained roughly constant regardless of ship size, encouraging larger designs.</li>
</ul>
</section>
<section id="orion-and-end-of-the-world-scenarios" class="level4">
<h4 class="anchored" data-anchor-id="orion-and-end-of-the-world-scenarios">Orion and End-of-the-World Scenarios</h4>
<ul>
<li><strong>Science Fiction Staple:</strong> Stories of launching a remnant of humanity into space to escape Earth’s destruction.</li>
<li><strong>Mega-Orion’s Potential:</strong> Could save the entire human population with 35,000 launches (compared to 100,000 daily airliner flights worldwide).</li>
</ul>
</section>
<section id="orions-demise" class="level4">
<h4 class="anchored" data-anchor-id="orions-demise">Orion’s Demise</h4>
<ul>
<li><strong>Reasons for Failure:</strong> Lack of political support and concerns about fallout from atmospheric nuclear explosions.</li>
<li><strong>Cleaner Explosions:</strong> It’s possible to engineer cleaner explosions than those used in the past, especially with fusion.</li>
</ul>
</section>
<section id="the-linear-no-threshold-hypothesis-and-radiation-risk" class="level4">
<h4 class="anchored" data-anchor-id="the-linear-no-threshold-hypothesis-and-radiation-risk">The Linear No-Threshold Hypothesis and Radiation Risk</h4>
<ul>
<li><strong>LNT Hypothesis:</strong> Assumes that any amount of radiation, however small, poses a risk proportional to the number of people exposed.</li>
<li><strong>Impact on Orion:</strong> The LNT hypothesis significantly affects risk calculations for radiation-producing projects like Orion.</li>
<li><strong>Dyson’s Fallout Analysis:</strong> Calculated 10 excess cancer deaths per launch using the LNT hypothesis (1 death per 10,000 REM).</li>
<li><strong>LNT and Cancer Deaths:</strong> Applying the LNT hypothesis globally would mean an Orion launch would result in 10 more cancer deaths out of the hundreds of millions expected annually.</li>
<li><strong>Actual Dose vs.&nbsp;Background Radiation:</strong> The calculated dose per person from an Orion launch would be 0.02 millirem, compared to natural background radiation of 300 millirem and a likely no-damage threshold of 50,000 millirem.</li>
<li><strong>LNT’s Impact on Research:</strong> Adherence to the LNT hypothesis hinders research on radiation effects.</li>
</ul>
</section>
<section id="the-importance-of-understanding-radiation" class="level4">
<h4 class="anchored" data-anchor-id="the-importance-of-understanding-radiation">The Importance of Understanding Radiation</h4>
<ul>
<li><strong>Space Radiation Environment:</strong> Outer space has high radiation levels.</li>
<li><strong>Need for Radiation Tolerance:</strong> Humans must learn to live with radiation to explore the universe, which requires honest scientific study.</li>
</ul>
</section>
</section>
<section id="the-cold-equations-and-space-colonization" class="level3">
<h3 class="anchored" data-anchor-id="the-cold-equations-and-space-colonization">The Cold Equations and Space Colonization</h3>
<section id="proxy-wars-in-history" class="level4">
<h4 class="anchored" data-anchor-id="proxy-wars-in-history">Proxy Wars in History</h4>
<ul>
<li><strong>18th-Century North America:</strong> The French and Indian War and the American Revolution were proxy wars between England and France.</li>
<li><strong>Post-World War II:</strong> Many wars were Cold War proxies fought in colonies.</li>
</ul>
</section>
<section id="potential-future-cold-war" class="level4">
<h4 class="anchored" data-anchor-id="potential-future-cold-war">Potential Future Cold War</h4>
<ul>
<li><strong>US-China Cold War:</strong> A potential future Cold War could involve the U.S. and China, with Russia and India as contenders, vying for control of the oceans and outer space.</li>
</ul>
</section>
<section id="thought-experiment-reactions-to-actions-in-space" class="level4">
<h4 class="anchored" data-anchor-id="thought-experiment-reactions-to-actions-in-space">Thought Experiment: Reactions to Actions in Space</h4>
<ul>
<li><strong>Scenario 1:</strong> Chinese Space Force destroys 10 U.S. spy satellites.</li>
<li><strong>Scenario 2:</strong> Chinese Space Force destroys a space station with 10 people aboard.</li>
<li><strong>Political vs.&nbsp;Monetary Impact:</strong> These scenarios are comparable financially and in terms of national capability, but their political implications are vastly different.</li>
</ul>
</section>
<section id="tripwires-in-space" class="level4">
<h4 class="anchored" data-anchor-id="tripwires-in-space">Tripwires in Space</h4>
<ul>
<li><strong>Cold War Analogy:</strong> U.S. forces in Europe during the Cold War served as a tripwire, potentially triggering a larger conflict if attacked.</li>
<li><strong>Space Colonization and Political Logic:</strong> Similar dynamics might shape space exploration and colonization, leading to a larger human presence in space than strictly necessary for economic or scientific reasons.</li>
<li><strong>Colonization of the New World:</strong> This mirrors how the New World was colonized.</li>
</ul>
</section>
</section>
<section id="cradle-earths-future-and-the-need-for-expansion" class="level3">
<h3 class="anchored" data-anchor-id="cradle-earths-future-and-the-need-for-expansion">Cradle: Earth’s Future and the Need for Expansion</h3>
<section id="earths-transformation-and-the-need-for-population-control" class="level4">
<h4 class="anchored" data-anchor-id="earths-transformation-and-the-need-for-population-control">Earth’s Transformation and the Need for Population Control</h4>
<ul>
<li><strong>Asimov’s Vision:</strong> Isaac Asimov imagined a planet-sized city as the capital of the Galactic Empire.</li>
<li><strong>Earth’s Future:</strong> In 1,000 years, if current trends continue, Earth could become entirely urbanized, like New York City or Los Angeles.</li>
<li><strong>Consequences:</strong> Natural landscapes would disappear, and animal life would be confined to zoos, farms (potentially replaced by nanotech food production), and pets.</li>
<li><strong>Undesirable Outcome:</strong> This is not a desirable future.</li>
<li><strong>Population Control:</strong> Population control is essential, the question is when and how.</li>
</ul>
</section>
<section id="wealth-as-a-means-of-population-control" class="level4">
<h4 class="anchored" data-anchor-id="wealth-as-a-means-of-population-control">Wealth as a Means of Population Control</h4>
<ul>
<li><strong>Link Between Wealth and Population Growth:</strong> Wealth is the only known way to moderate population growth (outside of catastrophic events).</li>
<li><strong>China’s Example:</strong> Even in China, birth restrictions are linked to rising incomes and are being phased out.</li>
<li><strong>Technophobia’s Flaw:</strong> Technophobic approaches that reduce individual ecological footprints are ultimately self-defeating because population growth outweighs individual reductions.</li>
</ul>
</section>
<section id="human-centric-arguments-for-population-control" class="level4">
<h4 class="anchored" data-anchor-id="human-centric-arguments-for-population-control">Human-Centric Arguments for Population Control</h4>
<ul>
<li><strong>Quality of Life:</strong> A human-centric perspective also supports population control. 10 billion people living in poverty is worse than 10 billion living prosperous lives.</li>
<li><strong>Need for More Space and Energy:</strong> Whether prioritizing Earth or people, the conclusion is the same: more living space and energy are needed.</li>
</ul>
</section>
<section id="long-term-survival-and-diversification" class="level4">
<h4 class="anchored" data-anchor-id="long-term-survival-and-diversification">Long-Term Survival and Diversification</h4>
<ul>
<li><strong>Diversifying Risk:</strong> Humanity’s long-term survival depends on diversification and not keeping all “eggs in one basket.”</li>
<li><strong>Existential Threats:</strong>
<ul>
<li>Nuclear war</li>
<li>Global pandemics</li>
<li>Asteroid impacts</li>
<li>Unknown unknowns</li>
</ul></li>
<li><strong>Sagan’s Quip:</strong> “All civilizations either become spacefaring or extinct.”</li>
<li><strong>Sagan’s Published Statements:</strong> Extinction is the norm for species, survival is the exception.</li>
<li><strong>Spaceflight as a Necessity:</strong> Intelligent beings must unify their planets, leave, and move small worlds – the choice is spaceflight or extinction.</li>
</ul>
</section>
<section id="resources-and-opportunities-in-space" class="level4">
<h4 class="anchored" data-anchor-id="resources-and-opportunities-in-space">Resources and Opportunities in Space</h4>
<ul>
<li><strong>Solar Energy:</strong> The solar system receives 10,000 times more solar energy than Earth, available for utilization.</li>
<li><strong>Asteroids and Matter:</strong> Asteroids contain at least tens of thousands of times more usable matter than Earth.</li>
<li><strong>Potential for Wealth and Expansion:</strong> Space provides ample room and resources for a vast, wealthy human population without relying on Earth.</li>
</ul>
</section>
<section id="benefits-of-space-colonization" class="level4">
<h4 class="anchored" data-anchor-id="benefits-of-space-colonization">Benefits of Space Colonization</h4>
<ul>
<li><strong>Earth as a Preserve:</strong> Earth could be set aside as a natural preserve or managed park.</li>
<li><strong>Experimentation:</strong> Space colonies allow for experimentation with different ecologies and governmental systems.</li>
<li><strong>Climate and Ecology Experiments:</strong> We can experiment with Earth’s climate and ecology with the resources to fix mistakes, preventing extinction-level risks.</li>
<li><strong>Resource Abundance:</strong> Space resources would dwarf Earth’s, reducing conflict over them.</li>
</ul>
</section>
</section>
<section id="adapting-to-space-environments" class="level3">
<h3 class="anchored" data-anchor-id="adapting-to-space-environments">Adapting to Space Environments</h3>
<section id="human-bodys-limitations" class="level4">
<h4 class="anchored" data-anchor-id="human-bodys-limitations">Human Body’s Limitations</h4>
<ul>
<li><strong>Earth-Bound Adaptation:</strong> The human body is adapted for life on Earth’s surface but still requires clothing and shelter in many regions and seasons.</li>
<li><strong>Technological Mediation:</strong> Humans use inventions to interact with the environment and overcome limitations.</li>
</ul>
</section>
<section id="nanotech-and-space-colonization" class="level4">
<h4 class="anchored" data-anchor-id="nanotech-and-space-colonization">Nanotech and Space Colonization</h4>
<ul>
<li><strong>Science Fiction’s Assumption:</strong> Science fiction envisioned humans continuing to adapt to space environments through advanced technology.</li>
<li><strong>Nanotech’s Role:</strong> Nanotech is likely to be crucial for widespread space colonization by enabling the rearrangement of atoms and providing the necessary energy.</li>
</ul>
</section>
<section id="modifying-and-replacing-the-human-body" class="level4">
<h4 class="anchored" data-anchor-id="modifying-and-replacing-the-human-body">Modifying and Replacing the Human Body</h4>
<ul>
<li><strong>Limited Modification in Science Fiction:</strong> Science fiction typically features limited human modifications (e.g., radiation resistance, gills) to maintain character relatability.</li>
<li><strong>Alien Forms:</strong> More radical body modifications were often reserved for alien characters.</li>
<li><strong>Adapting to Freefall:</strong> Different body forms might be more advantageous in space environments.</li>
</ul>
</section>
<section id="earth-like-habitats-vs.-adapted-humans" class="level4">
<h4 class="anchored" data-anchor-id="earth-like-habitats-vs.-adapted-humans">Earth-Like Habitats vs.&nbsp;Adapted Humans</h4>
<ul>
<li><strong>High Frontier Movement:</strong> The movement in the 1970s and 80s aimed to build Earth-like habitats in orbit, which was technologically possible but more expensive than anticipated.</li>
<li><strong>Adapted Humans for Space:</strong> Space colonization is more likely to succeed when humans are adapted to their environments, making living in space as comfortable as living on Earth.</li>
</ul>
</section>
</section>
<section id="the-century-of-enhancement-and-beyond" class="level3">
<h3 class="anchored" data-anchor-id="the-century-of-enhancement-and-beyond">The Century of Enhancement and Beyond</h3>
<section id="enhanced-body-parts" class="level4">
<h4 class="anchored" data-anchor-id="enhanced-body-parts">Enhanced Body Parts</h4>
<ul>
<li><strong>Future of Replacements:</strong> In the next half-century, we can expect replacement body parts that surpass the originals in function.</li>
<li><strong>The Century of Enhancement:</strong> The coming century will focus on human enhancement.</li>
<li><strong>Enhanced Humans:</strong> Humans of the future will have improved senses, strength, and adaptability to diverse environments.</li>
</ul>
</section>
<section id="beyond-enhancement-new-forms-and-capabilities" class="level4">
<h4 class="anchored" data-anchor-id="beyond-enhancement-new-forms-and-capabilities">Beyond Enhancement: New Forms and Capabilities</h4>
<ul>
<li><strong>Diverse Body Forms:</strong> In the future, humans may adopt diverse body forms as varied as our current machines, adapted to specific environments and needs.</li>
<li><strong>Matter Processing and Energy Consumption:</strong> We will be able to process various forms of matter and utilize different energy sources.</li>
<li><strong>Integrated Biosphere Capabilities:</strong> Humans will have built-in capabilities for rearranging atoms, eliminating the need for an ecological footprint.</li>
</ul>
</section>
</section>
<section id="the-need-for-a-frontier" class="level3">
<h3 class="anchored" data-anchor-id="the-need-for-a-frontier">The Need for a Frontier</h3>
<ul>
<li><strong>Avoiding Degeneration:</strong> Without external challenges, human society risks degenerating into internal conflict and stagnation.</li>
<li><strong>Space as a Challenge:</strong> The solar system and the galaxy offer vast challenges for humanity to overcome.</li>
<li><strong>Unifying Humanity:</strong> We can focus on conquering the universe instead of fighting amongst ourselves.</li>
</ul>
</section>
</section>
<section id="chapter-18-metropolis" class="level2">
<h2 class="anchored" data-anchor-id="chapter-18-metropolis">Chapter 18: Metropolis</h2>
<section id="introduction-mile-high-buildings-and-artificial-environments" class="level3">
<h3 class="anchored" data-anchor-id="introduction-mile-high-buildings-and-artificial-environments">Introduction: Mile-High Buildings and Artificial Environments</h3>
<ul>
<li><strong>Dennis Poon</strong>, Lead Engineer of Chengdu Tower, expresses interest in designing a mile-high building.</li>
<li>The 21st century marks a shift where over half of humanity lives in cities, highlighting the increasing prevalence of artificial environments.</li>
</ul>
</section>
<section id="the-burj-khalifa-a-real-world-skyscraper" class="level3">
<h3 class="anchored" data-anchor-id="the-burj-khalifa-a-real-world-skyscraper">The Burj Khalifa: A Real-World Skyscraper</h3>
<ul>
<li>The <strong>Burj Khalifa</strong>, opened in 2010 in Dubai, is the world’s tallest building at approximately half a mile high (2,600 feet).</li>
<li>It surpassed Toronto’s CN Tower (1975-2007) as the tallest building.</li>
<li>The Burj Khalifa resembles Frank Lloyd Wright’s proposed mile-high tower in shape.</li>
<li>It could potentially house and provide infrastructure for 5,000 people.</li>
<li>The actual Burj Khalifa contains 900 luxury residences and 37 floors of offices.</li>
<li>A mile-high skyscraper could potentially house 40,000 people.</li>
<li>The Burj Khalifa has a small footprint (less than two acres) due to its shape.</li>
<li>A mile-high version could potentially be built on a seven-acre footprint.</li>
<li>With one such tower per square mile (1% land usage), the Earth’s population could be housed in an area the size of Montana.</li>
<li><strong>Flying cars</strong> or <strong>underground high-speed trains</strong> could connect towers, potentially transforming the Earth into a park-like environment.</li>
</ul>
</section>
<section id="engineering-challenges-of-skyscrapers" class="level3">
<h3 class="anchored" data-anchor-id="engineering-challenges-of-skyscrapers">Engineering Challenges of Skyscrapers</h3>
<ul>
<li><strong>Wind load</strong> is a major engineering challenge for tall buildings.
<ul>
<li>Wind load increases with building height.</li>
<li>The Eiffel Tower’s structural members experience tension, not compression, on the windward side at the second platform level.</li>
</ul></li>
<li>Modern skyscrapers utilize interesting shapes (twists, holes) to mitigate wind load.
<ul>
<li>These shapes break up wind vortex streets generated by simple, regular shapes.</li>
</ul></li>
<li><strong>Wind loading</strong> increases significantly up to 20,000 feet (4 miles), plateaus until 40,000 feet, and then decreases due to lower air density.</li>
<li><strong>Pressurization</strong> becomes necessary for buildings between 5,000 and 10,000 feet to accommodate human habitation.
<ul>
<li>Alternatively, increasing the oxygen fraction of interior air could maintain sea level partial pressure up to about 35,000 feet (7 miles).</li>
</ul></li>
<li>Building a world of towers would require advanced technology and significant resources (steel, concrete).</li>
<li><strong>Nanotechnology</strong>, specifically <strong>nanotubes</strong> and <strong>diamond</strong>, could potentially simplify the construction of such towers.</li>
</ul>
</section>
<section id="materials-science-and-skyscraper-construction" class="level3">
<h3 class="anchored" data-anchor-id="materials-science-and-skyscraper-construction">Materials Science and Skyscraper Construction</h3>
<ul>
<li><strong>Materials science</strong>, sometimes referred to as nanotechnology, has advanced rapidly.</li>
<li>An <strong>aluminum-steel alloy</strong> with the strength of titanium and the price of steel is under development.
<ul>
<li>This alloy could enable the construction of a mile-high Eiffel Tower with simple scaling.</li>
</ul></li>
<li>The original Eiffel Tower (984 feet) is made of wrought iron with a maximum design stress of 10 KSI and a safety factor of three.</li>
<li><strong>Steel</strong>, while strong, is also springy, making it unsuitable for extremely tall structures due to wind sway.</li>
<li><strong>Concrete</strong> provides stiffness and inertia, making it more suitable for tall buildings.
<ul>
<li>The Burj Khalifa utilized high-strength concrete that could be pumped to greater heights.</li>
</ul></li>
<li><strong>Diamond</strong> or <strong>nanotube composites</strong> could enable the construction of much taller towers.</li>
</ul>
</section>
<section id="timeline-for-mile-high-and-ten-mile-high-towers" class="level3">
<h3 class="anchored" data-anchor-id="timeline-for-mile-high-and-ten-mile-high-towers">Timeline for Mile-High and Ten-Mile-High Towers</h3>
<ul>
<li>The surge in building heights coincided with the Industrial Revolution and the use of iron and steel (e.g., the Eiffel Tower).</li>
<li>The trend line suggests that mile-high buildings could be achieved around 2065.</li>
<li>However, a shift to nanomanufacturing and advanced materials could accelerate this timeline.</li>
<li>A 10-mile tower, with a footprint of a square mile, could potentially house 40 million people.
<ul>
<li>Eight such towers could house the entire 2021 U.S. population.</li>
</ul></li>
</ul>
</section>
<section id="governance-and-maintenance-challenges" class="level3">
<h3 class="anchored" data-anchor-id="governance-and-maintenance-challenges">Governance and Maintenance Challenges</h3>
<ul>
<li><strong>Honest and trustworthy governance, management, planning, and maintenance</strong> are crucial for the success of large-scale tower projects.</li>
<li>Without proper governance, potential disasters (e.g., a tower collapse) could have significant consequences.</li>
</ul>
</section>
<section id="city-services-rethinking-urban-planning" class="level3">
<h3 class="anchored" data-anchor-id="city-services-rethinking-urban-planning">City Services: Rethinking Urban Planning</h3>
<ul>
<li><strong>Jane Jacobs</strong>, author of “The Death and Life of Great American Cities,” criticizes conventional city planning approaches.</li>
<li>Many science fiction writers envisioned <strong>automatic package delivery</strong> as a key feature of future cities.
<ul>
<li>Philip Francis Nolan’s Buck Rogers novels (1929) described a system where food and entertainment were delivered directly to apartments.</li>
<li>Nolan also predicted <strong>radio-controlled flying drones</strong> for military use.</li>
</ul></li>
<li>Early to mid-20th century science fiction often depicted cities with advanced transportation infrastructure for automated movement of goods and people.</li>
</ul>
</section>
<section id="the-value-of-cities-reducing-travel-time" class="level3">
<h3 class="anchored" data-anchor-id="the-value-of-cities-reducing-travel-time">The Value of Cities: Reducing Travel Time</h3>
<ul>
<li>The primary value of a city lies in its ability to reduce <strong>travel time</strong> between destinations (homes, businesses, institutions, etc.).</li>
<li>The average person travels about 1.1 hours per day, regardless of location.</li>
<li>Cities offer more valuable destinations within a given travel time.</li>
<li><strong>Traffic congestion</strong> is a major issue in many cities, increasing travel time.
<ul>
<li>Megan McArdle’s experience in New York City highlights the challenges of navigating a city with inadequate transportation infrastructure.</li>
</ul></li>
<li>Travel between distant points in a city can be significantly faster with a car or helicopter if there were no congestion.</li>
</ul>
</section>
<section id="city-design-and-transportation-infrastructure" class="level3">
<h3 class="anchored" data-anchor-id="city-design-and-transportation-infrastructure">City Design and Transportation Infrastructure</h3>
<ul>
<li>Current city design, particularly transportation infrastructure, is considered primitive compared to advancements in other fields (manufacturing, electronics, software).</li>
<li>Cities typically have only one level of interconnect for transportation.</li>
<li><strong>Multi-level streets</strong>, as envisioned by Robert Heinlein in his 1938 utopia, could significantly reduce travel times and improve pedestrian safety.
<ul>
<li>Separate pedestrian levels with awnings could enhance the walking experience.</li>
</ul></li>
<li><strong>Pedestrian levels</strong> should prioritize functionality (e.g., shopping malls) over purely aesthetic green spaces.
<ul>
<li>Jane Jacobs advocated for integrating commercial activities within residential districts.</li>
</ul></li>
<li>Recent utopia-building projects often lack innovation in transportation infrastructure, relying on conventional road systems.</li>
<li>A well-designed city should incorporate a multi-level transportation infrastructure similar to the complex wiring systems found in brains, bodies, processor chips, etc.</li>
</ul>
</section>
<section id="densification-vs.-quality-of-life" class="level3">
<h3 class="anchored" data-anchor-id="densification-vs.-quality-of-life">Densification vs.&nbsp;Quality of Life</h3>
<ul>
<li>The tension between <strong>densification</strong> and quality of life arises from the incentives of bureaucrats and politicians.
<ul>
<li>They often benefit from increased interaction and contention among citizens, which creates opportunities for control and favors.</li>
</ul></li>
<li>This incentive contributes to the prevalence of flat, one-level cities where various modes of transportation and pedestrians compete for space.</li>
<li><strong>Jane Jacobs</strong> recognized the importance of community interaction in neighborhoods, but this concept is more applicable to smaller communities than large metropolises.</li>
<li>Apartment buildings can foster a sense of community if designed and managed properly.</li>
<li><strong>Densification proponents</strong> often cite the paradox of road closures not always leading to increased traffic on remaining streets.
<ul>
<li>This phenomenon can be explained by <strong>travel theory</strong>: when something becomes more expensive (in time or effort), people demand less of it.</li>
</ul></li>
<li>Building more roads can lead to more traffic, but this new traffic represents increased access to desired activities.</li>
<li>An optimal city design would incorporate multiple levels of traffic interconnect, pedestrian walkways, and potentially towering structures.</li>
</ul>
</section>
<section id="tower-cities-and-flying-cars" class="level3">
<h3 class="anchored" data-anchor-id="tower-cities-and-flying-cars">Tower Cities and Flying Cars</h3>
<ul>
<li><strong>Tower cities</strong>, with limited ground-level transportation, could make cars useless.</li>
<li>Cars, conversely, reduce the necessity of cities, as demonstrated by the rise of suburbia.</li>
<li>A city consisting of loosely clustered towers, each with a <strong>flying car garage</strong>, could provide efficient transportation without multi-level highways.</li>
<li><strong>VTOL flying cars</strong> offer a viable solution for transportation in a tower city environment.</li>
<li><strong>Online shopping</strong> and <strong>drone delivery</strong> further reduce the need for conventional transportation.</li>
<li><strong>Nanotechnology</strong> and advanced 3D printing could enhance the capabilities of flying cars and personalize delivery systems.</li>
<li>With flying cars, destinations could be located in diverse environments (e.g., mountainsides) without sacrificing accessibility.</li>
</ul>
</section>
<section id="seasteading-colonizing-the-oceans" class="level3">
<h3 class="anchored" data-anchor-id="seasteading-colonizing-the-oceans">Seasteading: Colonizing the Oceans</h3>
<ul>
<li><strong>Seasteading</strong>, the creation of permanent dwellings at sea, is an underpredicted trend for the coming century.</li>
<li><strong>Cruise ships</strong> represent a basic form of seagoing city, but they rely on Victorian technology.</li>
<li><strong>Nanotechnology</strong> could enable the construction of more advanced and self-sufficient seagoing structures.</li>
<li>An <strong>AeroCity</strong>, a massive flying wing structure, could potentially house millions of people and incorporate multi-level roadways, service cores, and nuclear power plants.</li>
<li><strong>Island construction</strong> using materials dredged from the seafloor could create desirable living spaces in the oceans.</li>
<li>The <strong>tropical oceans</strong> offer vast areas with favorable climates, potentially suitable for island communities.</li>
<li><strong>Airships</strong> or <strong>Cloud Cities</strong> composed of numerous small balloons could provide unique and mobile living environments.</li>
</ul>
</section>
<section id="seasteading-advantages-and-technologies" class="level3">
<h3 class="anchored" data-anchor-id="seasteading-advantages-and-technologies">Seasteading Advantages and Technologies</h3>
<ul>
<li><strong>Seasteading</strong> offers advantages such as:
<ul>
<li>Escape from incompetent government (potentially leading to increased economic growth).</li>
<li>Abundant free space.</li>
<li>Mobility (allowing for climate control and potential escape from government restrictions).</li>
</ul></li>
<li><strong>Seaplanes</strong> could provide efficient transportation between distributed seastead communities.</li>
<li><strong>Seawater</strong> contains significant energy resources (deuterium, lithium, boron, uranium) and dissolved minerals that could be utilized by nanofactories.</li>
<li>The development of seasteading technologies requires focused research and problem-solving efforts.</li>
<li>Economically viable ocean communities could potentially emerge early in this century, with self-sufficient family-sized units becoming possible in later decades.</li>
</ul>
</section>
<section id="conclusion-reimagining-cities-and-habitats" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-reimagining-cities-and-habitats">Conclusion: Reimagining Cities and Habitats</h3>
<ul>
<li><strong>Nanotechnology</strong> could revolutionize city design and enable the construction of innovative structures like AeroCities and Cloud Cities.</li>
<li><strong>Seasteading</strong> offers a promising alternative to land-based living, with potential benefits in terms of freedom, space, and mobility.</li>
<li>The future of human habitats could involve a combination of advanced tower cities, seastead communities, and innovative airborne structures, potentially leaving the Earth’s surface largely untouched.</li>
<li><strong>Psychological surveys</strong> consistently show that people are happier and healthier in rural environments compared to large cities.
<ul>
<li><strong>Greenery</strong> has been linked to reduced mortality rates.</li>
</ul></li>
<li>The <strong>COVID-19 pandemic</strong> highlighted the vulnerabilities of densely populated cities.</li>
<li>The development of <strong>flying cars</strong> and other advanced technologies could reshape the relationship between cities and transportation, potentially leading to more distributed and desirable living environments.</li>
</ul>
</section>
</section>
<section id="chapter-19-engineers-dreams" class="level2">
<h2 class="anchored" data-anchor-id="chapter-19-engineers-dreams">Chapter 19: Engineer’s Dreams</h2>
<section id="engineers-dreams-introduction" class="level3">
<h3 class="anchored" data-anchor-id="engineers-dreams-introduction">Engineer’s Dreams: Introduction</h3>
<ul>
<li><strong>Quote:</strong> “I’d settle for flying cars. They need to be real flying cars with anti-gravity or reactionless thrusters, not ducted fan kludges.” - Glenn Instapundit Reynolds (Source: Opening quote)</li>
<li>Science fiction writers and astronautics professionals believe there must be a better way to reach other planets than rockets.
<ul>
<li><strong>Desired characteristics of future space travel:</strong> Safer, quieter, cheaper, and less messy.</li>
</ul></li>
<li><strong>Reactionless thrusters</strong> are problematic in current physics, but opposing gravity is achievable (e.g., tables, balloons, wings, magnets).</li>
</ul>
</section>
<section id="the-mystery-of-gravity-and-quantum-mechanics" class="level3">
<h3 class="anchored" data-anchor-id="the-mystery-of-gravity-and-quantum-mechanics">The Mystery of Gravity and Quantum Mechanics</h3>
<ul>
<li><strong>The Composition of the Universe:</strong>
<ul>
<li><strong>Normal matter (stars and planets):</strong> 5%</li>
<li><strong>Dark energy and dark matter:</strong> 95%
<ul>
<li>“Dark” signifies our inability to observe or understand their nature.</li>
<li>Their existence is inferred due to discrepancies between our theories of gravitation and observed behavior of normal matter.</li>
</ul></li>
</ul></li>
<li><strong>The Future of Gravity and Physics:</strong>
<ul>
<li>New physics related to gravity is likely to be discovered.</li>
<li>Whether this will lead to anti-gravity technology is unknown.</li>
<li>A significant revolution in basic physics, particularly <strong>quantum mechanics</strong>, is anticipated.</li>
</ul></li>
<li><strong>Discrepancies in Current Physics:</strong>
<ul>
<li>Theories of gravity are estimated to be off by a factor of 20.</li>
<li>A much larger discrepancy exists between theoretical and observed <strong>vacuum energy density</strong>.
<ul>
<li><blockquote class="blockquote">
<p>“Depending on the Planck energy cutoff and other factors, the discrepancy is as high as 120 orders of magnitude, a state of affairs described by physicists as ‘the largest discrepancy between theory and experiment in all of science,’ and ‘the worst theoretical prediction in the history of physics.’” - Wikipedia</p>
</blockquote></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="carver-meads-perspective-on-quantum-mechanics" class="level3">
<h3 class="anchored" data-anchor-id="carver-meads-perspective-on-quantum-mechanics">Carver Mead’s Perspective on Quantum Mechanics</h3>
<ul>
<li><strong>Carver Mead:</strong> A prominent figure in 20th-century technology, a colleague of Richard Feynman, and a key contributor to Moore’s Law. (Source: Background information on Mead)</li>
<li><strong>Mead’s Critique of 20th Century Physics:</strong>
<ul>
<li><strong>Quote:</strong> “It is my firm belief that the last seven decades of the 20th century will be characterized in history as the dark ages of theoretical physics.” - Carver Mead (Source: Mead)</li>
</ul></li>
<li><strong>Einstein vs.&nbsp;Bohr:</strong>
<ul>
<li><strong>Niels Bohr:</strong> The dominant figure in quantum mechanics during the early to mid-20th century, particularly known for the <strong>Copenhagen Interpretation</strong>.</li>
<li><strong>Albert Einstein:</strong> Opposed the Copenhagen Interpretation, arguing against the probabilistic nature of quantum mechanics. (“God doesn’t play dice with the universe.”)</li>
<li>Bohr was generally considered to have “won” the debates within the physics community.</li>
</ul></li>
<li><strong>The Success and Challenges of Quantum Mechanics:</strong>
<ul>
<li>The mathematics of quantum mechanics has been highly successful in predicting experimental outcomes statistically.</li>
<li>However, the <strong>interpretation</strong> of quantum mechanics remains a source of contention and seemingly incoherent explanations.
<ul>
<li><strong>Schrödinger’s cat:</strong> A thought experiment highlighting the absurdity of certain interpretations.</li>
<li><strong>Copenhagen Interpretation:</strong> The cat is neither alive nor dead until observed.</li>
<li><strong>Many-worlds interpretation:</strong> The universe splits, with the cat alive in one and dead in another.</li>
</ul></li>
</ul></li>
<li><strong>The Limitations of Experimentation:</strong>
<ul>
<li>Different interpretations of quantum mechanics yield the same experimental results, making it difficult to determine which is correct.</li>
<li>They differ significantly in their descriptions of unobservable aspects of reality.</li>
</ul></li>
<li><strong>The Case of the Laser:</strong>
<ul>
<li>Bohr and John von Neumann advised Charles Townes that his attempt to build a laser was impossible according to the Copenhagen Interpretation.</li>
<li>Townes proved them wrong with a working model and later won the Nobel Prize.</li>
</ul></li>
</ul>
</section>
<section id="the-central-mystery-and-alternative-interpretations" class="level3">
<h3 class="anchored" data-anchor-id="the-central-mystery-and-alternative-interpretations">The Central Mystery and Alternative Interpretations</h3>
<ul>
<li><strong>The Wave-Particle Duality:</strong>
<ul>
<li>Energy, such as a photon of light, behaves like a wave when traveling but interacts like a particle upon detection.</li>
<li><strong>Analogy:</strong> A rubber ducky thrown into water creates a wave that spreads out. The ducky disappears, and then reappears somewhere else with a probability related to the wave’s amplitude at that location. The wave then instantly vanishes everywhere else.</li>
</ul></li>
<li><strong>The Copenhagen Interpretation’s Limitations:</strong>
<ul>
<li>It claims that the ducky’s path between sightings is unknowable and that the wave is a mental construct.</li>
<li>This is seen as a denial of deeper knowledge, similar to behaviorism’s focus on stimulus and response.</li>
</ul></li>
<li><strong>Problems with the Copenhagen Interpretation:</strong>
<ul>
<li>The insistence on the electron being both a wave and a point particle leads to issues like:
<ul>
<li><strong>Renormalization:</strong> Mathematical adjustments that Einstein and Schrödinger criticized as being akin to Ptolemaic epicycles.</li>
<li><strong>Vacuum energy discrepancy:</strong> The vast difference between theoretical and observed vacuum energy density.</li>
</ul></li>
</ul></li>
<li><strong>Alternative Perspectives:</strong>
<ul>
<li>Carver Mead, along with Einstein, Schrödinger, Fred Hoyle, Jayant Narlikar, Paul Davies, and John Cramer (with contributions from Wheeler and Feynman), advocate for alternative interpretations.</li>
<li>They believe that a deeper reality exists and that Schrödinger’s equation, when properly interpreted, can explain quantum phenomena without resorting to “magic.”</li>
</ul></li>
<li><strong>The Electron as a Wave:</strong>
<ul>
<li>The electron is seen as the wave itself, not a point particle guided by a non-physical wave.</li>
<li>Particle-like behavior arises from the mathematics of wave mechanics.</li>
</ul></li>
<li><strong>The Advanced Wave Solution:</strong>
<ul>
<li>Standard practice often discards the <strong>advanced wave</strong> solution of the wave equation.</li>
<li>Keeping and utilizing the advanced wave leads to a better understanding of coherent quantum phenomena (e.g., lasers, superconductors, resonant tunneling, Bose-Einstein condensates).</li>
</ul></li>
</ul>
</section>
<section id="towards-a-copernican-revolution-in-quantum-mechanics" class="level3">
<h3 class="anchored" data-anchor-id="towards-a-copernican-revolution-in-quantum-mechanics">Towards a Copernican Revolution in Quantum Mechanics</h3>
<ul>
<li><strong>The Future of Quantum Mechanics:</strong>
<ul>
<li>Extensive research is still needed to fully develop a “Copernican” interpretation of quantum mechanics.</li>
<li>It is acknowledged that the Copenhagen Interpretation, like Ptolemaic epicycles, might provide more accurate predictions for a time.</li>
</ul></li>
<li><strong>Benefits of a New Perspective:</strong>
<ul>
<li>A new interpretation will likely be more intuitively satisfying and will reveal new mechanisms and insights.</li>
</ul></li>
</ul>
</section>
<section id="space-piers-a-second-atomic-age-approach-to-space-travel" class="level3">
<h3 class="anchored" data-anchor-id="space-piers-a-second-atomic-age-approach-to-space-travel">Space Piers: A Second Atomic Age Approach to Space Travel</h3>
<ul>
<li><strong>Making Space Travel Achievable:</strong>
<ul>
<li>The chapter explores how Second Atomic Age technology, specifically <strong>nanotechnology</strong>, could revolutionize space travel.</li>
</ul></li>
<li><strong>The Rocket Equation:</strong>
<ul>
<li>While lighter and stronger materials improve rocket efficiency, the <strong>rocket equation</strong> remains a significant obstacle due to the need to carry vast amounts of propellant.</li>
</ul></li>
<li><strong>Space Piers as an Alternative:</strong>
<ul>
<li><strong>Space pier:</strong> A structure that bridges the gap between Earth and the environment where spaceships operate (vacuum and orbital velocity).</li>
</ul></li>
<li><strong>Space Pier Design:</strong>
<ul>
<li><strong>Height:</strong> 100 km (62 miles)</li>
<li><strong>Length:</strong> 300 km (186 miles)</li>
<li><strong>Shape:</strong> Curved to account for Earth’s curvature, with the center bowed nearly 2 km away from a straight line.</li>
<li><strong>Accelerator Track:</strong> Located at the top, nearly 5 km longer than the base due to the curvature.</li>
<li><strong>Atmospheric Layers:</strong> Extends through the stratosphere (50 km) and mesosphere (90 km) into the ionosphere.</li>
<li><strong>Propulsion:</strong> Utilizes a linear induction motor or other electromagnetic motor along the top track.</li>
<li><strong>Elevator:</strong> Transports payloads to the top of the tower.</li>
<li><strong>Launch Acceleration:</strong> 10 Gs horizontally for 80 seconds, achievable with appropriate cushioning for humans.</li>
</ul></li>
<li><strong>Advantages of Space Piers:</strong>
<ul>
<li>Only the payload is accelerated to orbital velocity, unlike rockets that must accelerate propellant as well.</li>
</ul></li>
<li><strong>Construction with Nanotechnology:</strong>
<ul>
<li><strong>Material:</strong> Flawless diamond with a compressive strength of 50 gigapascals (GPA) could be used, requiring no taper for a 100 km tower.</li>
<li><strong>Strength:</strong> A 100 km diamond column weighs 3.5 billion Newtons per square meter but can support 50 billion.</li>
<li><strong>Alternative Material:</strong> Commercially available polycrystalline synthetic diamond (5 GPA strength) could also be used.</li>
<li><strong>Tapering:</strong> In practice, columns would be tapered to conserve material.</li>
<li><strong>Base Broadening:</strong> The base would be broadened to handle transverse forces like wind.</li>
<li><strong>Weather Considerations:</strong> Only the bottom 15 km (troposphere) needs to account for weather.</li>
</ul></li>
</ul>
</section>
<section id="accelerator-and-structural-considerations" class="level3">
<h3 class="anchored" data-anchor-id="accelerator-and-structural-considerations">Accelerator and Structural Considerations</h3>
<ul>
<li><strong>Electromagnetic Accelerator:</strong>
<ul>
<li><strong>Weight:</strong> Potentially heavy, with some designs using iron cores (e.g., NASA’s Marshall prototype at 100 pounds per foot).</li>
<li><strong>Example:</strong> A 1-ton per meter accelerator would weigh 300,000 tons (comparable to the Golden Gate Bridge at 800,000 tons).</li>
<li><strong>Material:</strong> Mostly iron, which is relatively inexpensive.</li>
<li><strong>Stability:</strong> Heavier construction might be preferred for stability.</li>
<li><strong>Support:</strong> Even a relatively small column of currently available polycrystalline diamond could support the entire accelerator weight.</li>
</ul></li>
<li><strong>Overall Structure:</strong>
<ul>
<li><strong>Design:</strong> Openwork, similar to a radio tower.</li>
<li><strong>Footprints:</strong> Approximately 60 footprints spaced 10 km apart.</li>
<li><strong>Land Use:</strong> Footprints would occupy a minimal amount of land (0.02% of the area under the tower).</li>
<li><strong>Foundation Loads:</strong> Each footprint would bear a load comparable to a small office building.</li>
</ul></li>
<li><strong>Construction with Teleoperated Robots:</strong>
<ul>
<li><strong>Teleoperated scale-shifting robots</strong> would facilitate construction, eliminating the need for humans to work in the challenging environment at high altitudes.</li>
</ul></li>
<li><strong>The Kármán Line (100 km):</strong>
<ul>
<li>The edge of space, where the air is a million times thinner than at ground level.</li>
<li>Still enough air density to prevent objects from orbiting for long at this altitude.</li>
</ul></li>
<li><strong>Material Requirements and Cost:</strong>
<ul>
<li><strong>Estimated Material:</strong> Around a million tons for a 300 km structure.</li>
<li><strong>Comparison to Highways:</strong> A typical 300 km superhighway uses about 15 million tons of material and costs $1-5 billion.</li>
<li><strong>Land Value:</strong> The land under the tower may retain or even increase in value, particularly near the embarkation port.</li>
</ul></li>
<li><strong>Major Obstacle:</strong> Likely to be legal and regulatory hurdles rather than technical challenges.</li>
</ul>
</section>
<section id="energy-costs-and-launch-procedure" class="level3">
<h3 class="anchored" data-anchor-id="energy-costs-and-launch-procedure">Energy Costs and Launch Procedure</h3>
<ul>
<li><strong>Elevator Energy Cost:</strong>
<ul>
<li><strong>Energy:</strong> 10 gigajoules (2,778 kilowatt-hours) to send a 10-ton payload to the top.</li>
<li><strong>Cost:</strong> $138.89 at 5 cents per kilowatt-hour (1.4 cents per kilogram).</li>
<li><strong>Speed:</strong> An express elevator speed of 50 meters per second would take about 30 minutes to reach the top.</li>
<li><strong>Efficiency:</strong> Elevators can be made efficient at various climb rates.</li>
</ul></li>
<li><strong>Payload and Passengers:</strong>
<ul>
<li><strong>Freight:</strong> Inert freight would be loaded into projectiles on the ground.</li>
<li><strong>Passengers:</strong> Would ascend in the elevator, potentially enjoying amenities like a revolving restaurant at the top (with a 1,000 km view).</li>
</ul></li>
<li><strong>Launch Acceleration and Passenger Comfort:</strong>
<ul>
<li><strong>Acceleration:</strong> 10 Gs during horizontal launch.</li>
<li><strong>Passenger Accommodations:</strong> Form-fitting, fluid-filled sarcophagi to mitigate the effects of high acceleration.</li>
</ul></li>
<li><strong>Orbital Injection:</strong>
<ul>
<li><strong>Acceleration:</strong> 10 Gs for 80 seconds, reaching a velocity of 8 km/s.</li>
<li><strong>Orbit:</strong> Achieves an orbit with a 100 km perigee and a 500 km apogee.</li>
<li><strong>Earth Rotation Assist:</strong> The launch benefits from Earth’s rotation.</li>
</ul></li>
<li><strong>Launch Energy Cost:</strong>
<ul>
<li><strong>Energy:</strong> 300 gigajoules.</li>
<li><strong>Cost:</strong> $4,166 at current prices (42 cents per kilogram).</li>
<li><strong>Estimated Cost with Second Atomic Age Tech:</strong> Pennies per kilogram, due to advancements in energy production and resource utilization.</li>
</ul></li>
<li><strong>Power Requirements:</strong>
<ul>
<li><strong>Average Power:</strong> 3,750 megawatts during the 80-second launch.</li>
<li><strong>Peak Power:</strong> 7,500 megawatts at the end of the launch.</li>
<li><strong>Comparison:</strong> A typical suburb on the same land might have a peak power demand of 750 megawatts.</li>
</ul></li>
<li><strong>Energy Storage:</strong>
<ul>
<li><strong>Requirement:</strong> Local, short-term energy storage capable of rapid discharge for load averaging.</li>
<li><strong>Storage Density:</strong> 1 megajoule per meter of track length.</li>
<li><strong>Examples of 1 MJ:</strong> 15 pounds of lead-acid batteries, an ounce of butter, or a grain-of-salt-sized speck of uranium.</li>
<li><strong>Potential Storage Method:</strong> Storing energy in the magnetic fields of the accelerator coils.</li>
</ul></li>
<li><strong>Recharge Time:</strong>
<ul>
<li>A typical power station (1,000 megawatts) could recharge the tower in about 5 minutes.</li>
</ul></li>
</ul>
</section>
<section id="orbit-circularization-and-vehicle-design" class="level3">
<h3 class="anchored" data-anchor-id="orbit-circularization-and-vehicle-design">Orbit Circularization and Vehicle Design</h3>
<ul>
<li><strong>Spacecraft Requirements:</strong>
<ul>
<li>The launched vehicle must be capable of approximately 330 meters per second (m/s) delta-v to circularize its orbit.</li>
</ul></li>
<li><strong>Orbit Correction Strategy:</strong>
<ul>
<li>Inject into an orbit with the same energy as the desired circular orbit.</li>
<li>Perform a correction maneuver at the point where the orbits intersect (only changes direction, not energy).</li>
<li>This minimizes delta-v requirements at the correction stage, which is more expensive than delta-v at launch.</li>
</ul></li>
<li><strong>Propellant Requirements:</strong>
<ul>
<li><strong>Chemical Rockets:</strong> Propellant for orbit correction would be about 10-15% of the vehicle’s gross weight.</li>
<li><strong>High-Specific Impulse Rockets (e.g., direct fusion):</strong> Propellant requirements would be significantly lower.</li>
</ul></li>
<li><strong>The Evolution of Spacecraft:</strong>
<ul>
<li><strong>Analogy:</strong> “Zeppelins breed like elephants, but airplanes breed like rabbits.” (Source: Early aviation saying)</li>
<li><strong>Prediction:</strong> Space piers will likely be built only after space travel becomes more frequent and economically viable.</li>
</ul></li>
<li><strong>Multi-Purpose Vehicles:</strong>
<ul>
<li>Second Atomic Age vehicles could potentially serve as cars, boats, airplanes, and spaceships.</li>
</ul></li>
</ul>
</section>
<section id="flying-cars-and-atmospheric-propulsion" class="level3">
<h3 class="anchored" data-anchor-id="flying-cars-and-atmospheric-propulsion">Flying Cars and Atmospheric Propulsion</h3>
<ul>
<li><strong>Passenger Comfort and Acceleration:</strong>
<ul>
<li>A 1G thrust would be comfortable for passengers, achieving orbital velocity in about 13 minutes.</li>
<li>This would cover a distance of 3,000 kilometers.</li>
</ul></li>
<li><strong>Energy Requirements:</strong>
<ul>
<li><strong>Energy per kilometer:</strong> 100 megajoules.</li>
<li><strong>Nitrogen Fusion:</strong> If achievable, a cubic foot of air could provide the necessary fuel.</li>
<li><strong>Uranium Fuel:</strong> With a direct fusion rocket (bypassing the rocket equation), 50 cents worth of uranium could provide the total 300 gigajoules needed.</li>
</ul></li>
<li><strong>Atmospheric Propulsion:</strong>
<ul>
<li><strong>Electric Jets (Ionic Thrusters):</strong> Potentially efficient at hypersonic speeds, without the need for supersonic combustion or thermodynamic cycles (as in ramjets).</li>
<li><strong>Power Requirement:</strong> Peaks at 80 megawatts.</li>
</ul></li>
<li><strong>Limitations of Electric Jets:</strong>
<ul>
<li>Thrust would need to be reduced near orbital velocity.</li>
<li>A rocket would still be required for maneuvering in space.</li>
</ul></li>
</ul>
</section>
<section id="world-weather-control-introduction" class="level3">
<h3 class="anchored" data-anchor-id="world-weather-control-introduction">World Weather Control: Introduction</h3>
<ul>
<li><strong>Science Fiction and Climate Catastrophes:</strong>
<ul>
<li><strong>Against the Fall of Night (Arthur C. Clarke):</strong> The sun expands, boiling away Earth’s oceans.</li>
<li><strong>A Pail of Air (Fritz Leiber):</strong> Earth is flung into interstellar space, causing the atmosphere to freeze.</li>
<li><strong>Seven Eves (Neal Stephenson):</strong> The moon explodes, causing a meteor bombardment that devastates Earth.</li>
<li><strong>This Island Earth (movie):</strong> The planet Metaluna suffers a similar fate.</li>
<li><strong>When Worlds Collide (novel and movie):</strong> A rogue planet collides with Earth.</li>
</ul></li>
<li><strong>Climate Change and the Henry Adams Curve:</strong>
<ul>
<li><strong>Anthropogenic climate change</strong> is a major concern, but it was not the cause of the Henry Adams curve flatline in the 1970s. The concept gained prominence later.</li>
<li>Media portrayals often exaggerate the scientific and economic understanding of climate change.</li>
</ul></li>
<li><strong>Second Atomic Age Solutions:</strong>
<ul>
<li>Second Atomic Age technology could power civilization without CO2 emissions.</li>
<li>Returning to the Henry Adams curve requires moving beyond fossil fuels, particularly for space exploration.</li>
</ul></li>
<li><strong>The CO2 Problem of the Future:</strong>
<ul>
<li><strong>Too little CO2:</strong> May become a greater concern in the future than too much CO2.</li>
<li><strong>Current Levels:</strong> Around 400 parts per million (ppm), lower than optimal for plant growth.</li>
<li><strong>Commercial Greenhouses:</strong> Operate at 1,000 ppm.</li>
<li><strong>Consequences of Reduced CO2:</strong> Halving CO2 levels could threaten plant life and the ecosystem.</li>
</ul></li>
<li><strong>Pocket Synthesizers and CO2 Demand:</strong>
<ul>
<li><strong>Pocket synthesizers:</strong> Second Atomic Age devices capable of creating objects from the air, utilizing carbon from CO2.</li>
<li><strong>CO2 Replenishment:</strong> May require reopening coal mines or other sources to maintain adequate atmospheric CO2 for plant life.</li>
</ul></li>
</ul>
</section>
<section id="weather-control-as-a-superior-alternative" class="level3">
<h3 class="anchored" data-anchor-id="weather-control-as-a-superior-alternative">Weather Control as a Superior Alternative</h3>
<ul>
<li><strong>The Cost of Climate Regulation:</strong>
<ul>
<li>Current efforts cost approximately $1 trillion annually, excluding externalities like energy poverty.</li>
<li>These efforts are not effectively reducing global CO2 emissions.</li>
</ul></li>
<li><strong>A More Effective Approach:</strong>
<ul>
<li><strong>Proposal:</strong> Invest the $1 trillion in building orbital infrastructure and deploying sunshades.</li>
<li><strong>Sunshade Requirements:</strong> A 2-mile-wide ribbon around the equator could negate the enhanced greenhouse effect.</li>
<li><strong>Benefits:</strong> Climate control and a valuable orbital infrastructure (potentially a solar power satellite).</li>
</ul></li>
<li><strong>Decoupling Temperature and CO2:</strong>
<ul>
<li>This approach would decouple Earth’s temperature from atmospheric CO2 concentration, allowing independent control of each.</li>
</ul></li>
<li><strong>CO2 Adjustment with Second Atomic Age Tech:</strong>
<ul>
<li>Adjusting atmospheric CO2 levels would be straightforward with the ability to manipulate atoms at the molecular level.</li>
</ul></li>
</ul>
</section>
<section id="the-weather-machine-mark-i" class="level3">
<h3 class="anchored" data-anchor-id="the-weather-machine-mark-i">The Weather Machine: Mark I</h3>
<ul>
<li><strong>Design:</strong>
<ul>
<li><strong>Aerostat:</strong> Small, hydrogen-filled balloon (centimeter-scale).</li>
<li><strong>Shell:</strong> Very thin diamond shell (nanometer-thick).</li>
<li><strong>Shape:</strong> Spherical with a mirrored equatorial plane, possibly extending outwards like Saturn’s rings.</li>
<li><strong>Thickness:</strong> A few nanometers if flattened into a disk.</li>
</ul></li>
<li><strong>Material Considerations:</strong>
<ul>
<li>While constructible with current balloon materials, nanotechnology makes it more feasible and economical.</li>
<li><strong>Material Requirements:</strong> A nanometer-thick design requires about 10 million tons of material (comparable to 100 miles of freeway construction).</li>
<li><strong>Comparison to Conventional Balloons:</strong> Covering Earth with a 100-micron-thick layer would require 100 billion tons of material.</li>
</ul></li>
<li><strong>Altitude and Functionality:</strong>
<ul>
<li><strong>Altitude:</strong> Floats at approximately 20 miles (32 km) in the stratosphere, above weather systems and jet streams.</li>
<li><strong>Control Unit:</strong>
<ul>
<li>Radio receiver</li>
<li>Computer</li>
<li>GPS receiver</li>
</ul></li>
<li><strong>Power and Actuation:</strong> Minimal power and actuators (fans or other mechanisms) to adjust orientation.</li>
</ul></li>
<li><strong>Operation:</strong>
<ul>
<li>Receives commands via radio.</li>
<li>Tilts its mirror based on latitude, longitude, and desired effect.</li>
</ul></li>
<li><strong>Global Coverage:</strong>
<ul>
<li>Requires a vast number of aerostats (quintillions for centimeter-scale). Nanotechnology enables this scale.</li>
</ul></li>
<li><strong>Functionality:</strong>
<ul>
<li>Acts as a <strong>programmable greenhouse gas</strong>.</li>
<li><strong>Cooling:</strong> Reflects sunlight back into space when mirrors face the sun.</li>
<li><strong>Warming:</strong> Reflects outgoing long-wave (infrared) radiation back towards Earth when mirrors are angled appropriately.</li>
</ul></li>
<li><strong>Energy Balance:</strong> The Earth radiates away the same amount of energy it receives from the Sun (to within tenths of a percent).</li>
<li><strong>Climate Control:</strong>
<ul>
<li>Only a small fraction (tenths of a percent) of a full weather machine would be needed for climate control (a few watts per square meter).</li>
</ul></li>
<li><strong>Mirror Control:</strong>
<ul>
<li>Simple control systems can be used.</li>
<li>When letting sunlight through, mirrors can be slightly angled, causing scattering (haze) without significantly reducing insolation.</li>
</ul></li>
</ul>
</section>
<section id="the-kardashev-scale" class="level3">
<h3 class="anchored" data-anchor-id="the-kardashev-scale">The Kardashev Scale</h3>
<ul>
<li><strong>Kardashev Scale:</strong> Proposed by Russian astronomer Nikolai Kardashev in 1964, classifying civilizations based on energy utilization.</li>
<li><strong>Type I:</strong> Controls the energy of a planet (typically the amount of sunlight hitting it).</li>
<li><strong>Type II:</strong> Controls the energy of a star.</li>
<li><strong>Type III:</strong> Controls the energy of a galaxy.</li>
<li><strong>Scale Comparisons:</strong>
<ul>
<li>The difference between a Type III and a hypothetical ergophobic (energy-avoiding) Type I civilization is comparable to the difference between current human civilization and a single bacterium.</li>
</ul></li>
</ul>
</section>
<section id="the-weather-machine-and-kardashev-type-i-status" class="level3">
<h3 class="anchored" data-anchor-id="the-weather-machine-and-kardashev-type-i-status">The Weather Machine and Kardashev Type I Status</h3>
<ul>
<li><strong>Weather Machine as a Type I Enabler:</strong>
<ul>
<li>A weather machine could grant humanity Type I status by controlling the energy equivalent of all sunlight hitting Earth.</li>
</ul></li>
<li><strong>Human Energy Use:</strong>
<ul>
<li><strong>Current Power Use:</strong> 2 x 10^13 watts, a tiny fraction of the 10^17 watts a weather machine could control.</li>
</ul></li>
<li><strong>Benefits of Weather/Climate Control:</strong>
<ul>
<li><strong>Economic Value:</strong> Controlling climate could make currently unproductive land (e.g., northern Canada, Russia) as valuable as fertile regions like California.</li>
<li><strong>Historical Desire:</strong> Weather control has been a long-held aspiration, appearing in myths and science fiction.</li>
</ul></li>
<li><strong>Weather vs.&nbsp;Climate Control:</strong>
<ul>
<li>Finer control over individual aerostats could enable influence over daily weather patterns in addition to long-term climate.</li>
<li><strong>Hurricane Steering:</strong> Shading specific areas could potentially redirect hurricanes away from populated areas.</li>
</ul></li>
</ul>
</section>
<section id="asteroid-deflection-with-the-weather-machine" class="level3">
<h3 class="anchored" data-anchor-id="asteroid-deflection-with-the-weather-machine">Asteroid Deflection with the Weather Machine</h3>
<ul>
<li><strong>Apophis Asteroid:</strong>
<ul>
<li><strong>Close Approach:</strong> Will pass near Earth in 2029 (within the Moon’s orbit).</li>
<li><strong>Uncertain Trajectory:</strong> The close encounter will make its future orbit difficult to predict.</li>
<li><strong>Potential Impact:</strong> Could potentially strike Earth in 2036.</li>
</ul></li>
<li><strong>Weather Machine Intervention:</strong>
<ul>
<li>A highly controllable weather machine could focus sunlight on Apophis during its 2029 flyby to alter its trajectory and prevent a future impact.</li>
</ul></li>
</ul>
</section>
<section id="the-weather-machine-mark-ii" class="level3">
<h3 class="anchored" data-anchor-id="the-weather-machine-mark-ii">The Weather Machine: Mark II</h3>
<ul>
<li><strong>Advanced Functionality:</strong>
<ul>
<li><strong>Aerogel:</strong> Contains electronically switchable optical frequency antennas within the aerostat.</li>
<li><strong>Frequency and Direction Control:</strong> Can absorb or transmit radiation at any desired frequency and direction.</li>
<li><strong>Phase Control:</strong> Potentially capable of controlling the phase of transmitted radiation.</li>
</ul></li>
<li><strong>Solid-State Control:</strong> No need for physical orientation changes.</li>
<li><strong>Applications:</strong>
<ul>
<li><strong>Directional Video Screen/Hologram:</strong> The entire Earth could become a giant, programmable display.</li>
<li><strong>Telescope:</strong> Turns Earth into a telescope with an 8,000-mile aperture.</li>
</ul></li>
</ul>
</section>
<section id="weather-machine-mark-ii-power-and-capabilities" class="level3">
<h3 class="anchored" data-anchor-id="weather-machine-mark-ii-power-and-capabilities">Weather Machine Mark II: Power and Capabilities</h3>
<ul>
<li><strong>Astronomical Applications:</strong>
<ul>
<li><strong>Phobos Targeting:</strong> At Mars’ closest approach, a Mark II weather machine could focus a petawatt beam (equivalent to a quarter megaton per second) onto a 2.7 mm spot on Phobos.</li>
<li><strong>Phobos Manipulation:</strong> This could be used to:
<ul>
<li>Destroy Phobos.</li>
<li>Write on its surface.</li>
<li>Create controlled ablation for propulsion, maneuvering it around Mars.</li>
</ul></li>
</ul></li>
<li><strong>Nighttime Power:</strong>
<ul>
<li>Mark II can be powered at night by capturing outgoing infrared radiation.</li>
</ul></li>
<li><strong>Energy Sources and Power Density:</strong>
<ul>
<li><strong>Incoming Solar Power:</strong> Roughly 1 kilowatt per square meter at the surface (at noon, near the equator).</li>
<li><strong>Outgoing Infrared Power:</strong> About 250 watts per square meter (averaged over the entire surface).</li>
</ul></li>
<li><strong>Mark II Power Utilization:</strong>
<ul>
<li>Absorbs outgoing infrared for various applications (e.g., street lighting, displays).</li>
<li>Can act as a hologram, creating different effects for different locations.</li>
</ul></li>
<li><strong>Power Beaming:</strong>
<ul>
<li>Can focus power to flying cars, ships, trains, ground vehicles, and buildings.</li>
<li><strong>Optimal Frequency:</strong> Microwave atmospheric window at 15 GHz or less (wavelength of 20 mm or longer) for efficient electricity conversion.</li>
<li><strong>Power Density:</strong> A 1 km patch of weather machine could focus 250 megawatts onto a 1-meter rectenna at 15 GHz (even at midnight).</li>
</ul></li>
</ul>
</section>
<section id="the-inevitability-and-implications-of-the-weather-machine" class="level3">
<h3 class="anchored" data-anchor-id="the-inevitability-and-implications-of-the-weather-machine">The Inevitability and Implications of the Weather Machine</h3>
<ul>
<li><strong>Prediction:</strong> A weather machine, or something similar, will likely be built this century.</li>
<li><strong>Reasons for Development:</strong>
<ul>
<li><strong>Technological Feasibility:</strong> Molecular manufacturing makes it achievable.</li>
<li><strong>Addressing Global Threats:</strong> Climate change and asteroid impacts are motivating factors.</li>
<li><strong>Economic Value:</strong> Weather/climate control has significant economic potential.</li>
<li><strong>Military Applications:</strong> Weather control offers a powerful strategic advantage.</li>
</ul></li>
<li><strong>Military Implications:</strong>
<ul>
<li>Mark I could be used to induce climate disruptions (e.g., denying summers or springs to adversaries).</li>
<li>Mark II could be used for targeted destruction (as demonstrated with Phobos).</li>
</ul></li>
<li><strong>The Dead Man’s Switch:</strong>
<ul>
<li>A partially built Mark I (around 5%) could act as a doomsday device.</li>
<li>If the controlling entity is destroyed, the aerostats could default to a “snowball Earth” scenario.</li>
</ul></li>
<li><strong>Geopolitical Consequences:</strong>
<ul>
<li>Control of the weather machine would grant immense power.</li>
<li>Competing weather machine networks are likely to emerge.</li>
<li>Negotiations and potentially a “weather control world government” might be necessary.</li>
</ul></li>
<li><strong>Ultimate Implications:</strong>
<ul>
<li>The far-reaching consequences of a weather machine are difficult to fully grasp, but its development seems probable.</li>
</ul></li>
</ul>
</section>
</section>
<section id="chapter-20-rocket-to-the-resistance" class="level2">
<h2 class="anchored" data-anchor-id="chapter-20-rocket-to-the-resistance">Chapter 20: Rocket to the Resistance</h2>
<section id="benjamin-franklins-vision" class="level3">
<h3 class="anchored" data-anchor-id="benjamin-franklins-vision">Benjamin Franklin’s Vision</h3>
<ul>
<li><blockquote class="blockquote">
<p>“The rapid progress true science now makes occasions my regretting sometimes that I was born so soon. It is impossible to imagine the height to which may be carried in a one thousand years the power of man over matter. We may perhaps learn to deprive large masses of their gravity and give them absolute levity for the sake of easy transport. Agriculture may diminish its labor and double its produce. All diseases may by sure means be prevented or cured, not accepting even that of old age, and our lives lengthened at pleasure even beyond the antediluvian standard. Oh, that moral science were in as fair a way of improvement, that men would cease to be wolves to one another, and the human beings would at length learn what they now improperly call humanity.” - Benjamin Franklin</p>
</blockquote></li>
</ul>
</section>
<section id="the-end-of-agriculture" class="level3">
<h3 class="anchored" data-anchor-id="the-end-of-agriculture">The End of Agriculture</h3>
<section id="technological-advancements-in-food-production" class="level4">
<h4 class="anchored" data-anchor-id="technological-advancements-in-food-production">Technological Advancements in Food Production</h4>
<ul>
<li><strong>Vertical Farming:</strong>
<ul>
<li><strong>Description:</strong> Warehouse-sized buildings with shelves stacked high, growing lettuce under specialized LED lights.</li>
<li><strong>Advantages:</strong>
<ul>
<li><strong>Increased Efficiency:</strong> Produces 300 times more lettuce per square foot compared to traditional farming.</li>
<li><strong>Controlled Environment:</strong> Allows for year-round production, regardless of location or weather.</li>
<li><strong>Resource Optimization:</strong> Recycles water, filters air, and eliminates the need for pesticides.</li>
<li><strong>Example:</strong> Growing strawberries in Siberia or avocados in Antarctica becomes feasible with sufficient power.</li>
</ul></li>
</ul></li>
<li><strong>Lab-Grown Meat:</strong>
<ul>
<li><strong>Progress:</strong>
<ul>
<li><strong>2013:</strong> Cost $325,000 per pound.</li>
<li><strong>2018:</strong> Cost $363 per pound.</li>
</ul></li>
<li><strong>Investment:</strong> Attracting substantial investments from agribusiness giants like Tyson Foods.</li>
<li><strong>Current Status (2021):</strong> Singapore approved and began selling cultured bioreactor-grown chicken meat.</li>
</ul></li>
</ul>
</section>
<section id="impact-on-land-use-and-energy-consumption" class="level4">
<h4 class="anchored" data-anchor-id="impact-on-land-use-and-energy-consumption">Impact on Land Use and Energy Consumption</h4>
<ul>
<li><strong>Current Land Use:</strong>
<ul>
<li>80% of cultivated land in the U.S. produces animal feed (corn, soybeans, hay).</li>
<li>Significant land area dedicated to grazing.</li>
</ul></li>
<li><strong>Inefficient Solar Collection:</strong> Existing agriculture acts as an inefficient solar collector, converting sunlight into food through biological processes.</li>
<li><strong>Second Atomic Age Technology:</strong>
<ul>
<li><strong>Bypasses Biological Processes:</strong> Directly converts energy into food, bypassing the need for extensive land and inefficient solar collection.</li>
<li><strong>Potential Impact:</strong> Could free up vast amounts of land currently used for agriculture.</li>
</ul></li>
</ul>
</section>
<section id="the-choice-static-comfort-or-dynamic-expansion" class="level4">
<h4 class="anchored" data-anchor-id="the-choice-static-comfort-or-dynamic-expansion">The Choice: Static Comfort or Dynamic Expansion?</h4>
<ul>
<li><strong>Door Number One: Static Comfort</strong>
<ul>
<li><strong>Description:</strong> Society chooses a comfortable level of existence, with robots providing for basic needs.</li>
<li><strong>Potential Problems:</strong>
<ul>
<li><strong>Make-Work and Self-Deception:</strong> People may engage in meaningless activities to fill their time.</li>
<li><strong>Social Conflict:</strong> “Being wolves to each other” – increased conflict and competition in a resource-abundant society.</li>
<li><strong>Evolutionary Concerns:</strong>
<ul>
<li><strong>H.G. Wells’s “The Time Machine”:</strong> Predicted the degeneration of humanity into the Eloi (idle, harmless) and Morlocks (subterranean, predatory).</li>
<li><strong>Game Theory and Simulations:</strong> Suggest that even in comfortable environments, humans do not become uniformly benevolent.</li>
<li><strong>Virtue Signaling:</strong> May conceal underlying selfish motivations.</li>
<li><strong>Zero-Sum Society:</strong> A recipe for evil, as resources are finite and competition is fierce.</li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Door Number Two: Dynamic Expansion</strong>
<ul>
<li><strong>Description:</strong> Society embraces continued growth and innovation, using increased productivity to enhance everyone’s lives.</li>
<li><strong>Potential Benefits:</strong>
<ul>
<li><strong>A World of Makers:</strong> People engage in creative and productive pursuits.</li>
<li><strong>Increased Access to Resources:</strong> Everyone can afford advanced technology (e.g., flying cars, space travel).</li>
<li><strong>Expansion Beyond Earth:</strong> Building cities on the sea, colonies in space, preserving Earth as a park.</li>
<li><strong>Challenges and Opportunities:</strong> Provides challenges commensurate with human abilities, fostering growth and preventing stagnation.</li>
</ul></li>
</ul></li>
<li><strong>The Need for a Frontier:</strong> Humans need challenges and opportunities for exploration and expansion to thrive.</li>
</ul>
</section>
</section>
<section id="the-technium-and-the-great-stagnation" class="level3">
<h3 class="anchored" data-anchor-id="the-technium-and-the-great-stagnation">The Technium and the Great Stagnation</h3>
<section id="the-technium-an-analogy-for-technological-progress" class="level4">
<h4 class="anchored" data-anchor-id="the-technium-an-analogy-for-technological-progress">The Technium: An Analogy for Technological Progress</h4>
<ul>
<li><strong>Definition:</strong> The sum total of human-made things and capabilities, growing and interdependent like an ecosystem. (Kevin Kelly’s term).</li>
<li><strong>Analogy:</strong>
<ul>
<li><strong>Water Level:</strong> Represents the level of the technium.</li>
<li><strong>Landscape:</strong> Represents the constraints and opportunities imposed by physics and economics.</li>
<li><strong>Habitable Shores:</strong> Represent the areas where humans can live and thrive based on the current level of the technium.</li>
</ul></li>
</ul>
</section>
<section id="two-explanations-for-the-great-stagnation" class="level4">
<h4 class="anchored" data-anchor-id="two-explanations-for-the-great-stagnation">Two Explanations for the Great Stagnation</h4>
<ul>
<li><strong>Default Stagnation Explanation:</strong>
<ul>
<li><strong>The Barren Desert:</strong> The technium has risen, but the landscape offers few new opportunities (except for computing).</li>
<li><strong>Low-Hanging Fruit:</strong> All the easy advancements have been made.</li>
</ul></li>
<li><strong>The Forbidden Valleys:</strong>
<ul>
<li><strong>Abundant Valleys:</strong> Many opportunities for technological advancement exist.</li>
<li><strong>Angels with Flaming Swords:</strong> Cultural and regulatory barriers prevent access to these valleys.</li>
<li><strong>Multiple Entry Points:</strong> The rising technium can find ways into these valleys through various means:
<ul>
<li><strong>Technological End-Runs:</strong> Bypassing existing barriers with new technologies (e.g., drones).</li>
<li><strong>Escape from the Ban:</strong> Individuals or groups circumventing restrictions.</li>
<li><strong>Global Competition:</strong> Other nations forging ahead while stagnating societies fall behind.</li>
<li><strong>Political Shifts:</strong> Changes in policy or leadership that open up new possibilities.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="technology-leading-science-historical-perspective" class="level4">
<h4 class="anchored" data-anchor-id="technology-leading-science-historical-perspective">Technology Leading Science: Historical Perspective</h4>
<ul>
<li><strong>Historical Pattern:</strong> Technological innovation often precedes scientific understanding.
<ul>
<li><strong>Examples:</strong>
<ul>
<li><strong>Candles:</strong> Used for millennia before Faraday explained the science of combustion.</li>
<li><strong>Wine and Cheese:</strong> Made using microbes long before Pasteur’s discoveries.</li>
<li><strong>Steam Engines:</strong> Invented before Carnot developed thermodynamics.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-scientific-overhang-dammed-potential" class="level4">
<h4 class="anchored" data-anchor-id="the-scientific-overhang-dammed-potential">The Scientific Overhang: Dammed Potential</h4>
<ul>
<li><strong>Cause of Stagnation:</strong> Not a lack of opportunity, but cultural and regulatory barriers hindering experimentation and innovation, particularly in high-power technologies.</li>
<li><strong>Examples:</strong>
<ul>
<li><strong>Nuclear Power:</strong> Molten salt reactors and nuclear rocket engines developed decades ago but not widely adopted.</li>
<li><strong>Nanotechnology:</strong> Potential recognized by Feynman in 1960, but progress hindered by fear and regulation.</li>
</ul></li>
<li><strong>Potential for Rapid Advancement:</strong> Existing scientific knowledge could fuel rapid progress if barriers are removed.</li>
</ul>
</section>
<section id="the-collapse-of-pax-britannica-a-historical-parallel" class="level4">
<h4 class="anchored" data-anchor-id="the-collapse-of-pax-britannica-a-historical-parallel">The Collapse of Pax Britannica: A Historical Parallel</h4>
<ul>
<li><strong>Pax Britannica:</strong> A period of British dominance fueled by the Industrial Revolution.</li>
<li><strong>Overhang Technologies:</strong> Nuclear power and nanotechnology could enable other nations to rapidly catch up with and potentially surpass stagnating Western societies.</li>
<li><strong>Weapons Development:</strong> Nanotech could democratize access to advanced weapons technology, potentially destabilizing the global balance of power.</li>
</ul>
</section>
<section id="the-future-isnt-what-it-used-to-be-shifting-technological-focus" class="level4">
<h4 class="anchored" data-anchor-id="the-future-isnt-what-it-used-to-be-shifting-technological-focus">The Future Isn’t What It Used to Be: Shifting Technological Focus</h4>
<ul>
<li><strong>Hot Technologies of Today:</strong> Computing, communication, biotechnology.</li>
<li><strong>Linear Extrapolation:</strong> Science fiction and futurism often rely on simple linear projections, failing to anticipate paradigm shifts.</li>
<li><strong>The Second Atomic Age:</strong> Represents a potential resurgence of high-power technologies, driven by nuclear power, nanotechnology, biotechnology, and AI.</li>
</ul>
</section>
<section id="the-importance-of-moral-science-and-governance" class="level4">
<h4 class="anchored" data-anchor-id="the-importance-of-moral-science-and-governance">The Importance of Moral Science and Governance</h4>
<ul>
<li><strong>Benjamin Franklin’s Moral Science:</strong> If humans could overcome their destructive tendencies, technological progress could lead to a far better world.</li>
<li><strong>The Quality of Governance:</strong> Good governance is essential for maximizing the benefits of technological advancement.
<ul>
<li><strong>Rosling’s Level 4:</strong> Represents a high level of development and well-being.</li>
<li><strong>Potential for Improvement:</strong> The world could be significantly wealthier and happier with improved governance.</li>
</ul></li>
<li><strong>Incentives for Positive Change:</strong> The potential for immense wealth and global improvement could drive innovation in governance.</li>
</ul>
</section>
</section>
<section id="futures-past-dystopia-vs.-optimism" class="level3">
<h3 class="anchored" data-anchor-id="futures-past-dystopia-vs.-optimism">Futures Past: Dystopia vs.&nbsp;Optimism</h3>
<section id="philip-k.-dicks-dystopian-vision" class="level4">
<h4 class="anchored" data-anchor-id="philip-k.-dicks-dystopian-vision">Philip K. Dick’s Dystopian Vision</h4>
<ul>
<li><strong>Philip K. Dick:</strong> A mid-20th century science fiction writer known for his dystopian stories (e.g., Blade Runner, Minority Report).</li>
<li><strong>Characteristics of Dick’s Work:</strong> Lack of optimism, a focus on social decay, and a sense of hopelessness.</li>
<li><strong>Influence:</strong> Despite his pessimism, Dick’s work has been highly influential, particularly among intellectuals.</li>
</ul>
</section>
<section id="jill-lepores-critique-of-dystopian-fiction" class="level4">
<h4 class="anchored" data-anchor-id="jill-lepores-critique-of-dystopian-fiction">Jill Lepore’s Critique of Dystopian Fiction</h4>
<ul>
<li><blockquote class="blockquote">
<p>“Dystopia used to be a fiction of resistance. It’s become a fiction of submission. The fiction of an untrusting, lonely, and sullen 21st century. The fiction of fake news and info wars. The fiction of helplessness and hopelessness. It cannot imagine a better future, and it doesn’t ask anyone to bother to make one. It nurses grievances and indulges resentments. It doesn’t call for courage. It finds that cowardice suffices. Its only admonition is, despair more.” - Jill Lepore, Harvard historian</p>
</blockquote>
<ul>
<li><strong>Context:</strong> Criticizing the trend of dystopian fiction as a reflection of societal pessimism and a lack of hope for the future.</li>
</ul></li>
</ul>
</section>
<section id="the-great-stagnation-a-dickian-future" class="level4">
<h4 class="anchored" data-anchor-id="the-great-stagnation-a-dickian-future">The Great Stagnation: A Dickian Future</h4>
<ul>
<li><strong>Quip:</strong> “We are not living in the future of Robert Heinlein. We are living in the future of Philip K. Dick.”</li>
<li><strong>Pessimism as Intellectual Fashion:</strong> Throughout history, pessimism has often been seen as a sign of intellectual sophistication.
<ul>
<li><strong>John Stuart Mill’s Observation:</strong> “Not the man who hopes when others despair, but the man who despairs when others hope, is admired by a large class of persons as a sage.”</li>
</ul></li>
</ul>
</section>
<section id="thomas-macaulays-optimism-1830" class="level4">
<h4 class="anchored" data-anchor-id="thomas-macaulays-optimism-1830">Thomas Macaulay’s Optimism (1830)</h4>
<ul>
<li><blockquote class="blockquote">
<p>“On what principle is it that, when we see nothing but betterment behind us, we are to expect nothing but deterioration before us? If we were to prophesy that in the year 1930 a population of fifty million, better fed, clad, and lodged than the English of our time, will cover these islands, that Sussex and Huntington Shire will be wealthier than the wealthiest parts of the West Riding of Yorkshire now are, that machines constructed on principles yet undiscovered will be in every house, many people would think us insane.” - Thomas Macaulay.</p>
</blockquote>
<ul>
<li><strong>Context:</strong> Macaulay’s optimistic prediction during the Victorian era proved accurate, highlighting the dangers of assuming future decline based on past progress.</li>
</ul></li>
</ul>
</section>
<section id="the-role-of-science-fiction-in-shaping-visions-of-the-future" class="level4">
<h4 class="anchored" data-anchor-id="the-role-of-science-fiction-in-shaping-visions-of-the-future">The Role of Science Fiction in Shaping Visions of the Future</h4>
<ul>
<li><strong>Golden Age Science Fiction:</strong> Provided inspiring visions of a better future, driven by technological advancement and human ingenuity.
<ul>
<li><strong>Authors:</strong> Verne, Wells, Burroughs, Gernsback, Bellamy, Campbell, Docksmith, Van Vogt, Heinlein, Asimov, Garrett, Piper, Niven, Pournelle.</li>
</ul></li>
<li><strong>Science Fiction since the 1960s:</strong> Largely shifted towards dystopian themes, focusing on the potential dangers and negative consequences of technology.</li>
</ul>
</section>
<section id="the-faustian-bargain-of-science-fiction" class="level4">
<h4 class="anchored" data-anchor-id="the-faustian-bargain-of-science-fiction">The Faustian Bargain of Science Fiction</h4>
<ul>
<li><strong>Gaining Respectability:</strong> By embracing dystopia, science fiction gained academic acceptance and moved beyond its genre niche.</li>
<li><strong>Losing its Soul:</strong> In the process, it lost its focus on technological optimism, adventure, and hope for a better future.</li>
</ul>
</section>
<section id="can-science-fiction-regain-its-soul" class="level4">
<h4 class="anchored" data-anchor-id="can-science-fiction-regain-its-soul">Can Science Fiction Regain its Soul?</h4>
<ul>
<li><strong>The Time Machine and its Influence:</strong>
<ul>
<li><strong>H.G. Wells’s Prediction:</strong> Predicted the decline of humanity into the Eloi.</li>
<li><strong>Robert Heinlein’s Response:</strong> Took Wells’s prediction as a challenge and explored ways to prevent it in his novel “Beyond This Horizon.”</li>
</ul></li>
</ul>
</section>
<section id="robert-heinleins-beyond-this-horizon-countering-dystopia" class="level4">
<h4 class="anchored" data-anchor-id="robert-heinleins-beyond-this-horizon-countering-dystopia">Robert Heinlein’s “Beyond This Horizon”: Countering Dystopia</h4>
<ul>
<li><strong>Premise:</strong> Accepting Wells’s prediction of decline, Heinlein explores solutions to maintain human intelligence and vigor.</li>
<li><strong>Three Possibilities:</strong>
<ul>
<li><strong>Reduced Safety, Enhanced Competition:</strong> Creating a society where intelligence and vigor are advantageous for survival (e.g., dueling).</li>
<li><strong>Genetic Selection:</strong> Using technology to choose beneficial genes for offspring while maintaining natural variation (the Heinlein solution).</li>
<li><strong>Higher Purposes:</strong> Recognizing the importance of goals beyond mere comfort and survival, such as exploration and understanding the universe.</li>
</ul></li>
</ul>
</section>
<section id="the-need-for-a-higher-purpose-disturbing-the-universe" class="level4">
<h4 class="anchored" data-anchor-id="the-need-for-a-higher-purpose-disturbing-the-universe">The Need for a Higher Purpose: Disturbing the Universe</h4>
<ul>
<li><strong>Heinlein’s Third Possibility (reinterpreted):</strong> Humans need challenges and goals beyond basic needs to thrive.</li>
<li><strong>Examples:</strong>
<ul>
<li><strong>Harnessing Creative Energies:</strong> Focusing on innovation and improvement instead of internal conflict and virtue signaling.</li>
<li><strong>Expanding Beyond Earth:</strong> Protecting the Earth’s biosphere and venturing into space.</li>
<li><strong>Exploring the Solar System and Beyond:</strong> Recognizing the vastness of the universe and humanity’s potential to explore it.</li>
</ul></li>
</ul>
</section>
</section>
<section id="looking-upward-regaining-optimism-and-a-sense-of-wonder" class="level3">
<h3 class="anchored" data-anchor-id="looking-upward-regaining-optimism-and-a-sense-of-wonder">Looking Upward: Regaining Optimism and a Sense of Wonder</h3>
<section id="henry-adams-shifting-perspective-on-technology" class="level4">
<h4 class="anchored" data-anchor-id="henry-adams-shifting-perspective-on-technology">Henry Adams’ Shifting Perspective on Technology</h4>
<ul>
<li><strong>1862 (Pessimistic):</strong>
<ul>
<li><blockquote class="blockquote">
<p>“Man has mounted science and is now run away with. I firmly believe that before many centuries more, science will be the master of men. The engines he will have invented will be beyond his strength to control. Someday, science may have the existence of mankind in its power, and the human race commit suicide by blowing up the world.”</p>
</blockquote></li>
</ul></li>
<li><strong>1907 (Optimistic):</strong>
<ul>
<li><blockquote class="blockquote">
<p>“He could see that the new American, the child of incalculable coal power, chemical power, electric power, and radiating energy, as well as of new forces yet undetermined, must be a sort of God compared with any former creation of nature. At the rate of progress since 1800, every American who lived into the year 2000 would know how to control unlimited power. He would think in complexities unimaginable to an earlier mind. He would deal with problems altogether beyond the range of earlier society.”</p>
</blockquote></li>
</ul></li>
<li><strong>Context:</strong> Adams’ views shifted from pessimism during the Civil War to optimism during the Edwardian era, illustrating the influence of the zeitgeist on perceptions of technology.</li>
</ul>
</section>
<section id="the-great-stagnation-and-the-information-age" class="level4">
<h4 class="anchored" data-anchor-id="the-great-stagnation-and-the-information-age">The Great Stagnation and the Information Age</h4>
<ul>
<li><strong>The Qing Dynasty Analogy:</strong> The Great Stagnation can be seen as a rapid repeat of the Qing Dynasty’s self-imposed decline due to resistance to change.</li>
<li><strong>The Internet as the Printing Press:</strong> The internet has democratized access to information, similar to the printing press during the Reformation.</li>
<li><strong>The Reformation and the Power of Information:</strong> The printing press facilitated the Reformation by challenging the Catholic Church’s control over information.</li>
<li><strong>Challenging Bureaucracy:</strong> The internet has the potential to challenge the power of entrenched bureaucracies and promote positive change.</li>
<li><strong>History as a Source of Hope:</strong> Historical examples of overcoming stagnation and oppression offer reasons for optimism.</li>
</ul>
</section>
<section id="exceeding-science-fictions-predictions-the-potential-of-the-second-atomic-age" class="level4">
<h4 class="anchored" data-anchor-id="exceeding-science-fictions-predictions-the-potential-of-the-second-atomic-age">Exceeding Science Fiction’s Predictions: The Potential of the Second Atomic Age</h4>
<ul>
<li><strong>Underestimated Possibilities:</strong> Science fiction often underestimated the potential of technology to transform the world.
<ul>
<li><strong>Examples:</strong>
<ul>
<li><strong>Environmental Transformation:</strong> The ability to reshape environments on a large scale (e.g., turning deserts into fertile lands).</li>
<li><strong>Human Augmentation:</strong> Enhancing human capabilities beyond what was previously imagined (e.g., enabling unassisted flight).</li>
<li><strong>Space Colonization:</strong> Building new worlds and living comfortably in space, exceeding the limitations of traditional space travel.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-importance-of-vision-and-cultural-change" class="level4">
<h4 class="anchored" data-anchor-id="the-importance-of-vision-and-cultural-change">The Importance of Vision and Cultural Change</h4>
<ul>
<li><strong>The 2062 Vision:</strong> By 2062, significant technological progress could be achieved if cultural attitudes towards regulation and scientific bureaucracy change.
<ul>
<li><strong>Examples:</strong>
<ul>
<li><strong>Flying Cars and Domestic Robots:</strong> Becoming commonplace.</li>
<li><strong>Synthesizers:</strong> Enabling on-demand production of goods through 3D printing.</li>
<li><strong>Increased Life Expectancy:</strong> Extending lifespans beyond 100 years.</li>
<li><strong>Clean Energy:</strong> Eliminating the need for fossil fuels.</li>
<li><strong>Space Exploration and Colonization:</strong> Establishing cities on the sea, the moon, and beyond.</li>
</ul></li>
</ul></li>
<li><strong>Cultural Prerequisites:</strong> Achieving this vision requires a culture that values innovation, experimentation, and individual freedom.</li>
</ul>
</section>
<section id="failure-of-imagination-the-limits-of-extrapolation" class="level4">
<h4 class="anchored" data-anchor-id="failure-of-imagination-the-limits-of-extrapolation">Failure of Imagination: The Limits of Extrapolation</h4>
<ul>
<li><strong>Limitations of Current Knowledge:</strong> Predicting the future based solely on current scientific understanding is inherently limited.</li>
<li><strong>The 1900 Example:</strong> Predicting today’s technology in 1900 would have been impossible without knowledge of relativity, quantum mechanics, DNA, nuclear physics, etc.</li>
<li><strong>The Continued Advancement of Science:</strong> Science is an ongoing process, and future discoveries will likely lead to technologies beyond our current imagination.</li>
</ul>
</section>
<section id="the-tom-swift-jr.-analogy-embracing-experimentation-and-discovery" class="level4">
<h4 class="anchored" data-anchor-id="the-tom-swift-jr.-analogy-embracing-experimentation-and-discovery">The Tom Swift Jr.&nbsp;Analogy: Embracing Experimentation and Discovery</h4>
<ul>
<li><strong>Tom Swift Jr.’s Flying Lab:</strong> A fictional example of a mobile laboratory equipped with tools for experimentation and invention.</li>
<li><strong>The Internet as a Flying Lab:</strong> The internet provides access to vast amounts of information, computing power, and design tools, enabling anyone to engage in experimentation and innovation.</li>
<li><strong>The Power of Individual Initiative:</strong> With the right tools and mindset, individuals can make significant contributions to scientific and technological progress.</li>
</ul>
</section>
<section id="the-kardashev-scale-and-the-future-of-humanity" class="level4">
<h4 class="anchored" data-anchor-id="the-kardashev-scale-and-the-future-of-humanity">The Kardashev Scale and the Future of Humanity</h4>
<ul>
<li><strong>Kardashev Type I Civilization:</strong> A civilization that can harness all the energy available on its planet.</li>
<li><strong>Projected Timeline:</strong> If humanity resumes a path of growth and innovation, it could achieve Type I status by 2200.</li>
<li><strong>Solar System-Scale Civilization:</strong> This level of development would necessitate expanding beyond Earth and utilizing resources throughout the solar system.</li>
</ul>
</section>
<section id="the-importance-of-frontiers-and-a-dynamic-ethic" class="level4">
<h4 class="anchored" data-anchor-id="the-importance-of-frontiers-and-a-dynamic-ethic">The Importance of Frontiers and a Dynamic Ethic</h4>
<ul>
<li><strong>Reducing Virtue Signaling and Cost Disease:</strong> Expanding into new frontiers can shift societal focus away from internal conflicts and towards external challenges.</li>
<li><strong>The Key to the Future:</strong>
<ul>
<li><strong>Imagination:</strong> Envisioning a better future and believing in the possibility of achieving it.</li>
<li><strong>Desire:</strong> Wanting to achieve great things and improve the human condition.</li>
<li><strong>Effort:</strong> Working diligently towards achieving those goals.</li>
</ul></li>
</ul>
</section>
<section id="the-need-for-hopers-dreamers-and-visionaries" class="level4">
<h4 class="anchored" data-anchor-id="the-need-for-hopers-dreamers-and-visionaries">The Need for Hopers, Dreamers, and Visionaries</h4>
<ul>
<li><strong>Call to Action:</strong> Humanity needs individuals who can imagine and inspire others towards a better future.</li>
<li><strong>The Role of Science Fiction:</strong> Science fiction can play a crucial role in shaping these visions and fostering a sense of wonder and optimism.</li>
<li><strong>Looking Up at the Stars:</strong> A metaphorical call to embrace ambition, exploration, and the pursuit of grand challenges.</li>
</ul>
</section>
<section id="conclusion-opening-the-roads-to-the-future" class="level4">
<h4 class="anchored" data-anchor-id="conclusion-opening-the-roads-to-the-future">Conclusion: Opening the Roads to the Future</h4>
<ul>
<li><strong>Focus on the Near Term:</strong> Even without looking too far into the future, the potential for technological and societal progress is evident.</li>
<li><strong>Wilbur Wright’s Quote (1908):</strong> “It is not really necessary to look too far into the future. We see enough already to be certain it will be magnificent. Only let us hurry and open the roads.”</li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>
</section>

 ]]></description>
  <category>book</category>
  <category>notes</category>
  <category>history</category>
  <guid>https://christianjmills.com/posts/where-is-my-flying-car-book-notes/</guid>
  <pubDate>Mon, 02 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>CUDA MODE Lecture 6: Optimizing Optimizers in PyTorch</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/lecture-006/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Resource Links:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Resource Links:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube Recording:</strong> <a href="https://www.youtube.com/watch?v=hIop0mWKPHc">Lecture 6 Optimizing Optimizers</a><br>
</li>
<li><strong>Slides:</strong> <a href="https://docs.google.com/presentation/d/13WLCuxXzwu5JRZo0tAfW0hbKHQMvFw4O/edit#slide=id.p1">Optimizing optimizers in PyTorch</a></li>
</ul>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li><strong>Presenter:</strong> Jane, a member of the PyTorch core team specializing in optimizers.</li>
<li><strong>Focus:</strong> Runtime optimization (speed) of optimizers, not memory optimization.</li>
<li><strong>Disclaimer:</strong> Some optimization techniques discussed may require increased memory usage.</li>
</ul>
</section>
<section id="optimization-analogy-towing-cars" class="level2">
<h2 class="anchored" data-anchor-id="optimization-analogy-towing-cars">Optimization Analogy: Towing Cars</h2>
<ul>
<li><strong>Scenario:</strong> Towing 512 cars from point A to point B with a single truck.</li>
<li><strong>Options:</strong>
<ul>
<li>Small truck: Carries one car at a time, requiring 512 trips (slow).</li>
<li>Large truck: Carries eight cars at a time, requiring 64 trips (fast).</li>
</ul></li>
<li><strong>Constraint:</strong> A low-clearance bridge on the route that the large truck cannot pass through.</li>
<li><strong>Trade-off:</strong> Runtime optimization (large truck) is desirable, but constraints (bridge) may necessitate choosing memory optimization (small truck) instead.</li>
<li><strong>Today’s Focus:</strong> Speed optimization, assuming no constraints.</li>
</ul>
</section>
<section id="optimizer-basics-and-optimization-levels" class="level2">
<h2 class="anchored" data-anchor-id="optimizer-basics-and-optimization-levels">Optimizer Basics and Optimization Levels</h2>
<ul>
<li><strong>Optimizers:</strong> Take a list of parameters (tensors) and gradients, and update parameters based on gradients.</li>
<li><strong>Example: SGD:</strong> Simple add and multiply operations between parameters, gradients, and a step size.
<ul>
<li><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1">  parameter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parameter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> learning_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> gradient</span></code></pre></div></li>
</ul></li>
<li><strong>Optimization Levels:</strong>
<ol type="1">
<li><strong>Loop-Based:</strong>
<ul>
<li><p><strong>Implementation:</strong> Processes parameters one by one in a for loop.</p>
<ul>
<li><strong>torch/optim/adamw.py:</strong> <a href="https://github.com/pytorch/pytorch/blob/b5ba80828f77c565bcda7558da97c792af32d517/torch/optim/adamw.py#L362">_single_tensor_adamw()</a></li>
</ul></li>
<li><p><strong>Simplified Example:</strong></p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> param <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> params:</span>
<span id="cb2-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Retrieve necessary data for the current parameter</span></span>
<span id="cb2-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform operations (add, multiply, lerp, etc.)</span></span>
<span id="cb2-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update the parameter</span></span></code></pre></div></li>
<li><p><strong>Visualization:</strong> Each parameter update is a sequence of operations (gray circles), represented as a column. M operations per parameter, N parameters total, resulting in M x N operations. <img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-006/images/simple-optimizer-1.png" class="img-fluid" alt="Slide 6"></p></li>
</ul></li>
<li><strong>ForEach:</strong>
<ul>
<li><p><strong>Implementation:</strong> PyTorch’s current default; operates on entire parameter lists at once using vectorized operations.</p>
<ul>
<li><strong>torch/optim/adamw.py:</strong> <a href="https://github.com/pytorch/pytorch/blob/b5ba80828f77c565bcda7558da97c792af32d517/torch/optim/adamw.py#L480"><code>_multi_tensor_adamw()</code></a></li>
</ul></li>
<li><p><strong>Simplified Example:</strong></p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a constant to all parameters in the list</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply all parameters by a constant</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... other operations</span></span></code></pre></div></li>
<li><p><strong>Visualization:</strong> Each operation (blue circles) is performed on all parameters simultaneously. M operations total. <img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-006/images/simple-optimizer-foreach.png" class="img-fluid" alt="Slide 7"></p></li>
</ul></li>
<li><strong>Fused:</strong>
<ul>
<li><strong>Implementation:</strong> Fastest option; uses a single CUDA kernel to perform all operations on all parameters at once.
<ul>
<li><strong>torch/optim/adamw.py:</strong> <a href="https://github.com/pytorch/pytorch/blob/b5ba80828f77c565bcda7558da97c792af32d517/torch/optim/adamw.py#L616"><code>_fused_adamw()</code></a></li>
</ul></li>
<li><strong>Kernel Source:</strong> Inspired by NVIDIA Apex, PyTorch collaborates with NVIDIA to port and utilize fused CUDA kernels.</li>
</ul></li>
</ol></li>
<li><strong>Key Idea:</strong> Reducing the number of CUDA kernel launches improves performance because kernel launches are expensive.</li>
</ul>
</section>
<section id="multi-tensor-apply-the-powerhouse" class="level2">
<h2 class="anchored" data-anchor-id="multi-tensor-apply-the-powerhouse">Multi-Tensor Apply: The Powerhouse</h2>
<ul>
<li><strong>Multi-Tensor Apply:</strong> An internal PyTorch function that enables operating on lists of tensors simultaneously.</li>
<li><strong>Analogy:</strong> Mitochondria is the powerhouse of the cell; multi-tensor apply is the “power truck” of PyTorch’s speedy optimizers.</li>
<li><strong>Example: Torch.add:</strong>
<ul>
<li><strong>Standard Add:</strong> Takes two tensors (self and other) and returns a result tensor.</li>
<li><strong>ForEach Add:</strong> Takes two tensor lists (self and other) and returns a result tensor list.</li>
</ul></li>
<li><strong>CUDA Kernel Signatures:</strong>
<ul>
<li><p><strong>Standard Add (Simplified):</strong></p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1">__device__ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">void</span> add_kernel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">(</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> self<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> other<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> res<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">float</span> alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">);</span> </span></code></pre></div></li>
<li><p><strong>ForEach Add (Challenge):</strong> How would you design a CUDA kernel signature to handle tensor lists?</p></li>
</ul></li>
</ul>
</section>
<section id="attempt-1-passing-standard-vector-failed" class="level2">
<h2 class="anchored" data-anchor-id="attempt-1-passing-standard-vector-failed">Attempt 1: Passing Standard Vector (Failed)</h2>
<ul>
<li><strong>Idea:</strong> Pass a <code>std::vector</code> of pointers to tensors into the CUDA kernel.</li>
<li><strong>Problem:</strong> CUDA does not support <code>std::vector</code> as a kernel argument; it won’t even compile.</li>
</ul>
</section>
<section id="attempt-2-passing-pointers-to-pointers-failed" class="level2">
<h2 class="anchored" data-anchor-id="attempt-2-passing-pointers-to-pointers-failed">Attempt 2: Passing Pointers to Pointers (Failed)</h2>
<ul>
<li><strong>Idea:</strong> Pass a <code>float**</code> (pointer to a pointer) representing an array of tensor pointers.</li>
<li><strong>Problem:</strong> The outer pointer resides on the CPU, leading to illegal memory access when the kernel tries to dereference it.</li>
<li><strong>Explanation:</strong>
<ul>
<li><strong>Standard Add:</strong> Pointers passed to the kernel are CUDA memory addresses, so dereferencing them within the kernel is valid.</li>
<li><strong>Pointers to Pointers:</strong> The outer pointer is a CPU memory address. When dereferenced within the kernel, it attempts to access CPU memory, resulting in an illegal memory access error.</li>
</ul></li>
</ul>
</section>
<section id="attempt-3-passing-by-chonky-boy-partially-successful" class="level2">
<h2 class="anchored" data-anchor-id="attempt-3-passing-by-chonky-boy-partially-successful">Attempt 3: Passing by Chonky Boy (Partially Successful)</h2>
<ul>
<li><p><strong>Idea:</strong> Pass tensor data pointers by value using a struct.</p></li>
<li><p><strong>Implementation:</strong></p>
<ul>
<li>Create a struct containing arrays of <code>float*</code> for self, other, and result tensors.</li>
<li>Allocate memory for the struct on the CPU.</li>
<li>Copy the data pointers of all tensors into the struct’s arrays.</li>
<li>Pass the struct to the CUDA kernel.</li>
</ul></li>
<li><p><strong>Outcome:</strong> Works initially, but encounters issues with the kernel argument space limit.</p></li>
<li><p><strong>Kernel Argument Space Limit:</strong> The kernel argument space has a maximum size of 4 kilobytes.</p></li>
<li><p><strong>Problem:</strong> If the struct containing tensor pointers exceeds 4 kilobytes, only a portion of the struct gets passed to the kernel, leading to illegal memory access when accessing pointers beyond the limit.</p></li>
<li><p><strong>Repro Example:</strong></p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cuda"</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(N)]</span>
<span id="cb5-2">torch._foreach_norm(params, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ord</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-3">torch.cuda.synchronize()</span></code></pre></div>
<ul>
<li>Create a tensor list with a variable number of small tensors on CUDA.</li>
<li>Call <code>foreach_norm</code> (similar to <code>foreach_add</code>) on the tensor list.</li>
<li>Synchronize CUDA to ensure errors are immediately visible.</li>
</ul></li>
<li><p><strong>Observation:</strong> Illegal memory access occurs when the number of tensors exceeds 423.</p></li>
<li><p><strong>Conclusion:</strong> The struct approach works as long as the number of tensor pointers does not exceed the 4 kilobyte limit.</p></li>
</ul>
</section>
<section id="solution-1-batching-current-implementation" class="level2">
<h2 class="anchored" data-anchor-id="solution-1-batching-current-implementation">Solution 1: Batching (Current Implementation)</h2>
<ul>
<li><strong>Idea:</strong> Divide the tensor list into smaller batches that fit within the 4 kilobyte limit.</li>
<li><strong>Implementation:</strong>
<ul>
<li>Create multiple structs, each containing a subset of the tensor pointers.</li>
<li>Launch the kernel multiple times, once for each struct.</li>
</ul></li>
<li><strong>Outcome:</strong> Works reliably but requires multiple kernel launches, which can be inefficient.</li>
<li><strong>Visualization:</strong> Instead of a single fused kernel, multiple smaller kernels are launched. <img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-006/images/solution-1-viz.png" class="img-fluid" alt="Slide 41"></li>
</ul>
</section>
<section id="solution-2-revisiting-pointers-to-pointers-with-memcpy" class="level2">
<h2 class="anchored" data-anchor-id="solution-2-revisiting-pointers-to-pointers-with-memcpy">Solution 2: Revisiting Pointers to Pointers with Memcpy</h2>
<ul>
<li><strong>Idea:</strong> Combine the struct approach with a memcpy operation to move the pointers to CUDA memory beforehand.</li>
<li><strong>Implementation:</strong>
<ul>
<li>Pack the standard vectors of tensor addresses into a single tensor on the CPU.</li>
<li>Copy the tensor to CUDA memory.</li>
<li>Pass a pointer to the tensor data (now on CUDA) to the kernel.</li>
<li>Within the kernel, access the tensor data as an array of pointers and dereference them to access the actual tensors.</li>
</ul></li>
<li><strong>Outcome:</strong> Avoids the kernel argument space limit and enables launching a single kernel for the entire tensor list.</li>
<li><strong>Advantages:</strong>
<ul>
<li>Reduces the number of kernel launches, improving performance, especially for large tensor lists.</li>
<li>Memcpy overhead can be negligible compared to the cost of multiple kernel launches.</li>
</ul></li>
<li><strong>Considerations:</strong>
<ul>
<li>Requires careful memory management to avoid dangling pointers and memory leaks.</li>
<li>Assumes that pointer values are consistent between CPU and GPU memory.</li>
</ul></li>
</ul>
</section>
<section id="solution-3-unified-memory-future-exploration" class="level2">
<h2 class="anchored" data-anchor-id="solution-3-unified-memory-future-exploration">Solution 3: Unified Memory (Future Exploration)</h2>
<ul>
<li><strong>Unified Memory:</strong> Allows CUDA threads to access data allocated in CPU memory.</li>
<li><strong>Potential Benefits:</strong> Simplifies memory management and potentially reduces memcpy overhead.</li>
<li><strong>Challenges:</strong>
<ul>
<li>Not currently usable directly from PyTorch (requires CUDA).</li>
<li>Performance can be unpredictable depending on access patterns.</li>
</ul></li>
<li><strong>Example: Paged Optimizer (Tim Dettmers):</strong> Uses unified memory to implement a paged optimizer, achieving efficient memory management.</li>
<li><strong>Future Work:</strong> Explore the feasibility and benefits of integrating unified memory support into PyTorch optimizers.</li>
</ul>
</section>
<section id="fused-optimizers-and-multi-tensor-apply" class="level2">
<h2 class="anchored" data-anchor-id="fused-optimizers-and-multi-tensor-apply">Fused Optimizers and Multi-Tensor Apply</h2>
<ul>
<li><strong>Fused Optimizers:</strong> Implementations like <code>fusedAdamW</code> rely on multi-tensor apply to achieve vertical fusion of operations within a single kernel.</li>
<li><strong>Example: FusedAdamW:</strong>
<ul>
<li><strong>aten/src/ATen/native/cuda/fused_adam_utils.cuh:</strong> <a href="https://github.com/pytorch/pytorch/blob/45f11094b6cda4998e482d0eda424c2d7cc7861e/aten/src/ATen/native/cuda/fused_adam_utils.cuh#L111">FusedAdamMathFunctor</a></li>
<li><strong>Multi-Tensor Apply Callable:</strong> Uses a custom functor (<code>FusedAdamMathFunctor</code>) to perform all AdamW operations within the kernel.</li>
<li><strong>Functor Implementation:</strong> Handles pointer management, memory alignment, vectorization, and finally calls a math function to perform the actual AdamW calculations.</li>
</ul></li>
<li><strong>Observation:</strong> Writing fused kernels manually is complex and requires detailed CUDA knowledge.</li>
</ul>
</section>
<section id="torch-compile-and-the-future-of-fused-optimizers" class="level2">
<h2 class="anchored" data-anchor-id="torch-compile-and-the-future-of-fused-optimizers">Torch Compile and the Future of Fused Optimizers</h2>
<ul>
<li><p><strong>Torch Compile (Inductor):</strong> PyTorch’s compiler that excels at <strong>vertical fusion</strong> of operations.</p></li>
<li><p><strong>Potential:</strong> Automate the vertical fusion of optimizer operations, eliminating the need for handwritten CUDA kernels.</p></li>
<li><p><strong>Benefits:</strong></p>
<ul>
<li>Simplifies the implementation of fused optimizers.</li>
<li>Enables fusion of optimizer operations with surrounding operations (e.g., backward pass, zero grad).</li>
</ul></li>
<li><p><strong>Current Status:</strong></p>
<ul>
<li>Works with all PyTorch optimizers that use <code>forEach</code> (except L-BFGS and SparseAdam).</li>
<li>Requires CUDA 7.0+ and Triton.</li>
<li>Can be used by wrapping the optimizer’s <code>step</code> function with <code>torch.compile</code>.</li>
</ul></li>
<li><p><strong>Example:</strong></p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1">optimizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.optim.AdamW(model.parameters())</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.compile</span>(fullgraph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb6-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> compiled_step():</span>
<span id="cb6-5">    optimizer.step()</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... training loop</span></span>
<span id="cb6-8">compiled_step()</span></code></pre></div></li>
<li><p><strong>Limitations:</strong></p>
<ul>
<li><strong>Horizontal fusion</strong> (across parameters) is not yet supported by Torch Compile.</li>
<li>Triton itself has limitations (e.g., thread indexing).</li>
<li>Compile times can be significant, especially for large models.</li>
</ul></li>
<li><p><strong>Future Directions:</strong></p>
<ul>
<li>Improve Torch Compile’s horizontal fusion capabilities.</li>
<li>Enhance Triton’s features and performance.</li>
<li>Reduce compile times through caching and optimization.</li>
</ul></li>
</ul>
</section>
<section id="qa-session" class="level2">
<h2 class="anchored" data-anchor-id="qa-session">Q&amp;A Session</h2>
<section id="obtaining-triton-kernel-code" class="level3">
<h3 class="anchored" data-anchor-id="obtaining-triton-kernel-code">Obtaining Triton Kernel Code</h3>
<ul>
<li><strong>Question:</strong> How to obtain the low-level Triton kernel code from PyTorch code?</li>
<li><strong>Answer:</strong>
<ul>
<li>Use <code>torch.compile</code> with the <code>inductor</code> backend.
<ul>
<li><code>TORCH_LOGS=inductor</code></li>
</ul></li>
<li>When running the compiled code, Inductor will print the path to the generated Triton kernel file.</li>
<li>Alternatively, use the <code>output_code</code> option with <code>torch.compile</code> to print the kernel code directly.</li>
<li>Jane recommends using the <code>inductor</code> approach as it’s more reliable and the output location is consistent.</li>
</ul></li>
</ul>
</section>
<section id="visualizing-kernel-graphs" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-kernel-graphs">Visualizing Kernel Graphs</h3>
<ul>
<li><strong>Question:</strong> Is it possible to generate a visual graph of the kernel?</li>
<li><strong>Answer:</strong>
<ul>
<li>Jane hasn’t personally tried it, but it might be an advanced feature worth exploring.</li>
<li>Triton kernels are generated from a dependency graph (fxGraph) created by PT2 (PyTorch 2.0).</li>
<li>Accessing and visualizing the fxGraph might be more useful than a Triton kernel graph.</li>
</ul></li>
</ul>
</section>
<section id="compile-time-dependency-on-number-of-tensors" class="level3">
<h3 class="anchored" data-anchor-id="compile-time-dependency-on-number-of-tensors">Compile Time Dependency on Number of Tensors</h3>
<ul>
<li><strong>Question:</strong> Does the compile time of Torch Compile depend on the number of tensors being processed?</li>
<li><strong>Answer:</strong>
<ul>
<li>Yes, there is overhead related to the number of tensors.</li>
<li><strong>Functionalization:</strong> Compilers prefer functional code for optimization, but optimizers inherently update parameters in-place (non-functional).</li>
<li><strong>Initial Challenges:</strong> Early versions of PT2 struggled with optimizer compilation due to functionalization requirements, leading to long compile times (minutes for 1000 parameters).</li>
<li><strong>Improvements:</strong> Significant improvements have been made, but overhead still exists for tracing and processing large numbers of parameters.</li>
<li><strong>Ongoing Work:</strong> Torch Compile is actively addressing this general problem to reduce compile times further.</li>
</ul></li>
</ul>
</section>
<section id="caching-compiled-results" class="level3">
<h3 class="anchored" data-anchor-id="caching-compiled-results">Caching Compiled Results</h3>
<ul>
<li><strong>Question:</strong> Is it possible to cache compiled optimizer results to avoid recompilation on subsequent runs?</li>
<li><strong>Answer:</strong>
<ul>
<li>Yes, caching is possible and has been explored (e.g., work by Mark).</li>
<li><strong>Benefits:</strong> Primarily improves warm compilation times (when the cached result is available).</li>
<li><strong>Limitations:</strong> Doesn’t significantly address cold start compilation times (first-time compilation).</li>
<li><strong>Focus on Cold Starts:</strong> Efforts are underway to improve cold start performance by profiling and optimizing the compilation process itself.</li>
</ul></li>
</ul>
</section>
<section id="memory-management-with-structs-containing-pointers" class="level3">
<h3 class="anchored" data-anchor-id="memory-management-with-structs-containing-pointers">Memory Management with Structs Containing Pointers</h3>
<ul>
<li><strong>Question:</strong> How to manage deep copying and memory when dealing with structs containing pointers, especially regarding garbage collection and dangling pointers?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>CUDA Limitations:</strong> CUDA doesn’t automatically handle garbage collection for pointers in structs passed to kernels.</li>
<li><strong>Developer Responsibility:</strong> The developer is responsible for managing the memory associated with these pointers explicitly.</li>
<li><strong>Smart Pointers (C++):</strong> Using smart pointers (e.g., shared pointers) in C++ can help with automatic memory management.</li>
<li><strong>Deep Copying Considerations:</strong> Deep copying pointers requires careful handling to avoid freeing memory prematurely or creating dangling pointers.</li>
<li><strong>Security Risks:</strong> Dangling pointers can lead to security vulnerabilities. Developers should be vigilant and report any potential issues.</li>
</ul></li>
<li><strong>Additional Clarification:</strong>
<ul>
<li>When copying structs containing pointers, dangling pointers can arise on both CPU and GPU sides.</li>
<li>Explicit tracking and management of pointer lifecycles are crucial to prevent issues.</li>
</ul></li>
</ul>
</section>
<section id="memcpy-size-limit" class="level3">
<h3 class="anchored" data-anchor-id="memcpy-size-limit">Memcpy Size Limit</h3>
<ul>
<li><strong>Question:</strong> Is there a size limit for memcpy operations?</li>
<li><strong>Answer:</strong>
<ul>
<li>There is likely a limit, but it’s typically very large.</li>
<li>Since memcpy is used to copy pointers (not entire tensors), the amount of data copied is relatively small.</li>
<li>In most cases, a single memcpy operation is sufficient for transferring the necessary pointers.</li>
</ul></li>
</ul>
</section>
<section id="memcpy-direction-argument" class="level3">
<h3 class="anchored" data-anchor-id="memcpy-direction-argument">Memcpy Direction Argument</h3>
<ul>
<li><strong>Question:</strong> Why does memcpy require an argument to specify the direction of the copy operation (e.g., host-to-device)? Can’t it be inferred from the pointers?</li>
<li><strong>Answer:</strong>
<ul>
<li>Possibly due to historical reasons.</li>
<li>CUDA supports various types of memcpy operations (device-to-device, host-to-device, etc.).</li>
<li>Explicitly specifying the direction might be necessary to handle these different scenarios efficiently.</li>
<li>Vikram suggests checking with CUDA API developers for a definitive answer.</li>
</ul></li>
</ul>
</section>
<section id="device-to-device-copy" class="level3">
<h3 class="anchored" data-anchor-id="device-to-device-copy">Device-to-Device Copy</h3>
<ul>
<li><strong>Question:</strong> What are the requirements for direct device-to-device memory copy?</li>
<li><strong>Answer:</strong>
<ul>
<li>Clarification: Device-to-device copy refers to copying within the same device (e.g., between different memory regions on the GPU), while peer-to-peer copy refers to copying between different devices (e.g., GPU 0 to GPU 1).</li>
<li>Device-to-device copy can be performed through CPU API calls or directly within GPU threads using warp-level primitives.</li>
<li>Specific requirements for direct peer-to-peer copy are not readily available but involve factors like GPU topology and interconnect capabilities.</li>
<li>Device-to-device copy is less common than other types of memory transfers.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/lecture-006/</guid>
  <pubDate>Mon, 02 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Notes on Why Greatness Cannot Be Planned</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/why-greatness-cannot-be-planned-book-notes/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Book LInks:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://link.springer.com/book/10.1007/978-3-319-15524-1">Publisher Page</a></li>
<li><a href="https://www.kenstanley.net/home">Author’s Website: Kenneth O. Stanley</a></li>
<li><a href="http://joellehman.com/">Author’s Website: Joel Lehman</a></li>
</ul>
</div>
</div>
<ul>
<li>Preface</li>
<li>Chapter 1: Questioning Objectives<br>
</li>
<li>Chapter 2: Victory for the Aimless<br>
</li>
<li>Chapter 3: The Art of Breeding Art<br>
</li>
<li>Chapter 4: The False Compass<br>
</li>
<li>Chapter 5: The Interesting and the Novel<br>
</li>
<li>Chapter 6: Long Live the Treasure Hunter<br>
</li>
<li>Chapter 7: Unshackling Education<br>
</li>
<li>Chapter 8: Unchaining Innovation<br>
</li>
<li>Chapter 9: Farewell to the Mirage<br>
</li>
<li>Chapter 10: Case Study 1 - Reinterpreting Natural Evolution<br>
</li>
<li>Chapter 11: Case Study 2 - Objectives and the Quest for AI</li>
</ul>
<section id="preface" class="level2">
<h2 class="anchored" data-anchor-id="preface">Preface</h2>
<section id="the-origin-of-the-book" class="level3">
<h3 class="anchored" data-anchor-id="the-origin-of-the-book">The Origin of the Book</h3>
<ul>
<li><p>This book originated from a radical idea in <strong>Artificial Intelligence (AI)</strong> about algorithms achieving amazing things without explicit objectives.</p></li>
<li><p>Initial experiments yielded surprising results, prompting further exploration beyond AI.</p></li>
<li><p>The idea expanded to encompass broader implications for life, culture, society, innovation, achievement, biology, and more.</p></li>
<li><blockquote class="blockquote">
<p><strong>“If you don’t understand why I say that’s unusual, just consider how rare or bizarre it is for a computer algorithm to change how you think about life.”</strong></p>
</blockquote></li>
</ul>
</section>
<section id="public-reaction-and-books-purpose" class="level3">
<h3 class="anchored" data-anchor-id="public-reaction-and-books-purpose">Public Reaction and Book’s Purpose</h3>
<ul>
<li><p>Stanley, a professor, began incorporating the idea into public talks, observing its impact on audiences.</p></li>
<li><p>The book aims to communicate this novel insight and its broad implications to a wider audience.</p></li>
<li><blockquote class="blockquote">
<p><strong>“There is a story here—a story about an idea in AI and how it grew into something bigger—but there’s also a journey through a dizzying set of surprisingly broad implications for everything from personal dating, to the march of science, to the evolution of the human brain.”</strong></p>
</blockquote></li>
</ul>
</section>
</section>
<section id="chapter-1-questioning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="chapter-1-questioning-objectives">Chapter 1: Questioning Objectives</h2>
<section id="introduction-a-world-driven-by-objectives" class="level3">
<h3 class="anchored" data-anchor-id="introduction-a-world-driven-by-objectives">Introduction: A World Driven by Objectives</h3>
<ul>
<li><strong>Objectives</strong> are deeply ingrained in our culture, influencing everything from education and careers to personal goals and societal aspirations.</li>
<li>We rarely question the value of framing our pursuits with objectives.</li>
<li>Examples of objective-driven pursuits:
<ul>
<li>Education: Mastering subjects, achieving high test scores.</li>
<li>Careers: Job promotions, financial success.</li>
<li>Personal life: Finding a partner, improving physical appearance.</li>
<li>Societal goals: Low crime rates, economic growth, environmental sustainability.</li>
</ul></li>
<li>The assumption is that any worthy accomplishment is best achieved by setting it as an objective and pursuing it with conviction.</li>
</ul>
</section>
<section id="the-prevalence-of-objectives-in-various-fields" class="level3">
<h3 class="anchored" data-anchor-id="the-prevalence-of-objectives-in-various-fields">The Prevalence of Objectives in Various Fields</h3>
<ul>
<li><strong>Engineering:</strong> Objectives are set through rigorous specifications, and progress is measured against these specifications.</li>
<li><strong>Science:</strong> Objectives are essential for securing funding and judging project success.</li>
<li><strong>Investing:</strong> Objectives focus on earnings and profits.</li>
<li><strong>Art and Design:</strong> Objectives involve conceiving a design and pursuing its realization.</li>
<li><strong>Evolutionary Biology:</strong> Objectives are framed in terms of survival and reproduction.</li>
<li><strong>Artificial Intelligence:</strong> Algorithms are designed to work towards specific objectives.</li>
</ul>
</section>
<section id="the-appeal-and-comfort-of-objectives" class="level3">
<h3 class="anchored" data-anchor-id="the-appeal-and-comfort-of-objectives">The Appeal and Comfort of Objectives</h3>
<ul>
<li>Objectives offer a sense of order and predictability in an unpredictable world.</li>
<li>The belief that setting an objective creates possibility and that hard work leads to success provides a sense of optimism.</li>
</ul>
</section>
<section id="the-downside-of-objectives-limitations-and-costs" class="level3">
<h3 class="anchored" data-anchor-id="the-downside-of-objectives-limitations-and-costs">The Downside of Objectives: Limitations and Costs</h3>
<ul>
<li><strong>Limitations:</strong>
<ul>
<li>Objectives can limit freedom and exploration.</li>
<li>They can stifle playful discovery and creativity.</li>
</ul></li>
<li><strong>Costs:</strong>
<ul>
<li>Objectives can lead to an overwhelming focus on measurements, assessments, and metrics.</li>
<li>They can become straitjackets, hindering our ability to explore new possibilities.</li>
</ul></li>
</ul>
</section>
<section id="the-paradox-of-ambitious-objectives" class="level3">
<h3 class="anchored" data-anchor-id="the-paradox-of-ambitious-objectives">The Paradox of Ambitious Objectives</h3>
<ul>
<li><strong>Ambitious objectives</strong>, those whose achievement is uncertain, often become obstacles to their own fulfillment.</li>
<li>The stepping stones to achieving ambitious objectives are often unpredictable and counterintuitive.</li>
<li>Focusing solely on the objective can blind us to the necessary stepping stones.</li>
</ul>
</section>
<section id="achievement-as-a-process-of-discovery" class="level3">
<h3 class="anchored" data-anchor-id="achievement-as-a-process-of-discovery">Achievement as a Process of Discovery</h3>
<ul>
<li><strong>Achievement</strong> can be viewed as a process of <strong>discovery</strong> within a vast <strong>search space</strong> of possibilities.</li>
<li><strong>Search space:</strong> The set of all possible things relevant to a particular domain (e.g., all possible images, inventions, musical genres).</li>
<li><strong>Stepping stones:</strong> Discoveries or innovations that pave the way for further progress within the search space.</li>
<li>Exploration of the search space and the discovery of stepping stones are crucial for reaching ambitious objectives.</li>
</ul>
</section>
<section id="the-unpredictability-of-stepping-stones" class="level3">
<h3 class="anchored" data-anchor-id="the-unpredictability-of-stepping-stones">The Unpredictability of Stepping Stones</h3>
<ul>
<li><strong>Stepping stones</strong> often bear little resemblance to the final objective.</li>
<li>Examples of unpredictable stepping stones:
<ul>
<li>Vacuum tubes (originally for electricity and radio) became crucial for early computers.</li>
<li>Engines (not initially intended for flight) were essential for airplanes.</li>
<li>Microwave technology (developed for radar) led to microwave ovens.</li>
</ul></li>
<li>The structure of the search space is often <strong>unpredictable</strong> and <strong>deceptive</strong>.</li>
<li>Focusing solely on the objective can distract us from the unexpected stepping stones that are necessary for its achievement.</li>
</ul>
</section>
<section id="the-power-of-no-objective-serendipity-and-discovery" class="level3">
<h3 class="anchored" data-anchor-id="the-power-of-no-objective-serendipity-and-discovery">The Power of No Objective: Serendipity and Discovery</h3>
<ul>
<li><strong>Great ideas</strong> often emerge without being explicitly pursued as objectives.</li>
<li>Examples of serendipitous discoveries:
<ul>
<li>Rock and roll music emerged from the fusion of various musical genres without a conscious objective to create it.</li>
<li>Elvis Presley’s unique sound was a result of unplanned experimentation rather than a deliberate objective.</li>
</ul></li>
<li><strong>Serendipity</strong> can play a significant role in achieving greatness.</li>
</ul>
</section>
<section id="exploring-the-search-space-without-objectives" class="level3">
<h3 class="anchored" data-anchor-id="exploring-the-search-space-without-objectives">Exploring the Search Space Without Objectives</h3>
<ul>
<li>It’s possible to explore a search space intelligently and creatively without a specific objective.</li>
<li>Abandoning objectives doesn’t necessitate aimless wandering; we can align ourselves towards discovery and exploration.</li>
<li><strong>The Paradox:</strong> Sometimes the best way to achieve greatness is to stop trying to achieve a specific great thing.</li>
</ul>
</section>
<section id="implications-and-benefits-of-questioning-objectives" class="level3">
<h3 class="anchored" data-anchor-id="implications-and-benefits-of-questioning-objectives">Implications and Benefits of Questioning Objectives</h3>
<ul>
<li><strong>Personal Liberation:</strong> Freedom from the pressure of objectives and metrics, allowing for greater creativity and exploration.</li>
<li><strong>Scientific Advancements:</strong> Potentially fostering breakthroughs by encouraging open-ended exploration and serendipitous discoveries.</li>
<li><strong>Engineering and Design:</strong> Promoting innovative solutions that might not be conceived under strict objective-driven approaches.</li>
<li><strong>Understanding Evolution:</strong> Recognizing the role of serendipity and unexpected adaptations in the development of life.</li>
<li><strong>Algorithm Development:</strong> Exploring new approaches to AI that move beyond objective-driven algorithms.</li>
</ul>
</section>
<section id="conclusion-breaking-free-from-the-myth-of-the-objective" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-breaking-free-from-the-myth-of-the-objective">Conclusion: Breaking Free from the Myth of the Objective</h3>
<ul>
<li>The objective-driven culture can be limiting and stifling.</li>
<li>We can achieve greatness by embracing exploration, serendipity, and the freedom to deviate from predetermined objectives.</li>
<li>By questioning the myth of the objective, we can unlock our potential for creativity, innovation, and true fulfillment.</li>
</ul>
</section>
</section>
<section id="chapter-2-victory-for-the-aimless" class="level2">
<h2 class="anchored" data-anchor-id="chapter-2-victory-for-the-aimless">Chapter 2: Victory for the Aimless</h2>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<ul>
<li><strong>Paradox of ambitious objectives:</strong> The most significant successes often arise unexpectedly, deviating from initial plans and objectives.</li>
<li><strong>Serendipity:</strong> Embracing unexpected opportunities and being open to changing direction can lead to greater achievements than rigidly adhering to a predetermined path.</li>
<li><strong>Stepping stones:</strong> Unforeseen events or choices can act as stepping stones towards unanticipated, fulfilling outcomes.</li>
</ul>
</section>
<section id="the-deception-of-career-planning" class="level3">
<h3 class="anchored" data-anchor-id="the-deception-of-career-planning">The Deception of Career Planning</h3>
<ul>
<li><strong>Abundance of Career Guidance:</strong> Numerous resources, tests, and experts aim to help individuals identify and pursue their ideal careers.
<ul>
<li>Examples: <em>What Color Is Your Parachute?</em> by Richard Bolles, Career Key test, Campbell Interest and Skill Survey, Myers-Briggs Type Indicator, Keirsey Temperament Sorter.</li>
</ul></li>
<li><strong>Success Stories that Defy Planning:</strong> Many highly successful individuals achieved their accomplishments through unplanned detours and unexpected opportunities.
<ul>
<li><strong>Key Idea:</strong> Anticipating the most fulfilling path is challenging in open-ended problems like career choice, making openness and flexibility crucial.</li>
</ul></li>
<li><strong>The Value of Openness (Wiseman’s Experiment):</strong>
<ul>
<li>Subjects tasked with counting photographs in a newspaper.</li>
<li>Those less focused on the objective noticed a message revealing the answer earlier, demonstrating that excessive focus on a goal can hinder discoveries.</li>
<li><strong>Key Idea:</strong> Openness to unexpected information or opportunities can lead to faster and more efficient solutions.</li>
</ul></li>
</ul>
</section>
<section id="serendipity-in-action-examples-of-unplanned-success" class="level3">
<h3 class="anchored" data-anchor-id="serendipity-in-action-examples-of-unplanned-success">Serendipity in Action: Examples of Unplanned Success</h3>
<ul>
<li><strong>Johnny Depp:</strong>
<ul>
<li>Joined a band, leading to marriage and introduction to acting through his wife (a makeup artist).</li>
<li><strong>Key Idea:</strong> A passion for music (not acting) became an unexpected stepping stone to a successful acting career.</li>
</ul></li>
<li><strong>John Grisham:</strong>
<ul>
<li>Practiced law for 10 years before a courtroom experience inspired him to write.</li>
<li><strong>Key Idea:</strong> Legal experience, seemingly unrelated to writing, provided the inspiration and material for a successful writing career.</li>
</ul></li>
<li><strong>J.K. Rowling:</strong>
<ul>
<li>Worked as a bilingual secretary and English teacher before writing Harry Potter.</li>
</ul></li>
<li><strong>Haruki Murakami:</strong>
<ul>
<li>Ran a jazz bar, providing time for observation and inspiration for his writing.</li>
<li>Didn’t consider writing novels until age 29.</li>
</ul></li>
<li><strong>Raymond Chandler:</strong>
<ul>
<li>Started writing at age 45 after being fired from his oil company executive job.</li>
</ul></li>
<li><strong>Mary Midgley:</strong>
<ul>
<li>Didn’t write books until after age 50.</li>
</ul></li>
<li><strong>Key Idea (for writers):</strong> Diverse experiences and unexpected life changes can be valuable stepping stones for a writing career, even if they seem unrelated to the craft.</li>
</ul>
</section>
<section id="challenging-the-realistic-objectives-mindset" class="level3">
<h3 class="anchored" data-anchor-id="challenging-the-realistic-objectives-mindset">Challenging the “Realistic Objectives” Mindset</h3>
<ul>
<li><strong>Pressure to be Practical:</strong> Societal pressure often pushes individuals towards “realistic” objectives, discouraging them from following their passions.
<ul>
<li><strong>Examples:</strong> John Lennon and Elton John both received discouragement from family regarding their musical aspirations.</li>
</ul></li>
<li><strong>“Get your head out of the clouds”:</strong> This common saying reflects a cultural bias against pursuing paths based on passion rather than practicality.</li>
<li><strong>Colonel Sanders:</strong>
<ul>
<li>Cooked from a young age but didn’t find success until age 40 after a varied career path.</li>
<li><strong>Key Idea:</strong> A willingness to explore different paths and embrace change (“catching the winds of serendipity”) eventually led to success.</li>
</ul></li>
</ul>
</section>
<section id="the-common-thread-embracing-change" class="level3">
<h3 class="anchored" data-anchor-id="the-common-thread-embracing-change">The Common Thread: Embracing Change</h3>
<ul>
<li><strong>Successful individuals often deviate from initial paths:</strong> Whether self-chosen or imposed, original objectives can transform into stepping stones towards something unforeseen.</li>
<li><strong>Openness to 180-degree turns:</strong> A willingness to abandon initial goals and seize opportunities is a common characteristic of highly successful people.</li>
<li><strong>Serendipity is widespread:</strong> A study found that nearly two-thirds of adults attribute some aspect of their career choice to serendipity.
<ul>
<li><strong>Example:</strong> “I happened to visit an animal hospital and became interested in veterinary medicine.”</li>
</ul></li>
</ul>
</section>
<section id="career-experts-acknowledge-serendipity" class="level3">
<h3 class="anchored" data-anchor-id="career-experts-acknowledge-serendipity">Career Experts Acknowledge Serendipity</h3>
<ul>
<li><strong>Shifting Focus:</strong> Some career experts are recognizing the importance of unplanned experiences in career development.</li>
<li><strong>Encouraging Exploration:</strong> Activities like volunteering, joining clubs, and networking are recommended to increase chances of serendipitous encounters.</li>
<li><strong>Emphasis on the Unplanned:</strong> This approach moves away from rigid career planning and emphasizes exploration without a fixed destination.</li>
</ul>
</section>
<section id="the-non-objective-principle-beyond-careers" class="level3">
<h3 class="anchored" data-anchor-id="the-non-objective-principle-beyond-careers">The Non-Objective Principle: Beyond Careers</h3>
<ul>
<li><strong>Applicability:</strong> The principle of “finding without trying to find” extends beyond careers to any search process, including personal discoveries.</li>
<li><strong>Openness to Change:</strong> Embracing a flexible mindset and recognizing that appearances can be deceiving is crucial.</li>
<li><strong>Recognizing Potential:</strong> Sensing potential in unexpected areas, even without a clear understanding of its nature, can lead to significant discoveries.</li>
</ul>
</section>
<section id="cultural-echoes-of-the-non-objective-principle" class="level3">
<h3 class="anchored" data-anchor-id="cultural-echoes-of-the-non-objective-principle">Cultural Echoes of the Non-Objective Principle</h3>
<ul>
<li><strong>Love as an Example:</strong> The paradoxical nature of finding love is widely acknowledged.
<ul>
<li><strong>Loretta Young:</strong> “Love isn’t something you find. Love is something that finds you.”</li>
<li><strong>D.H. Lawrence:</strong> “Those that go searching for love, only manifest their own lovelessness… only the loving find love. And they never have to seek for it.”</li>
</ul></li>
<li><strong>The deceptive nature of ideals:</strong> Preconceived notions about ideal outcomes often lead to disappointment, highlighting the unpredictable nature of great discoveries.</li>
<li><strong>The Surprise of Love Stories:</strong> Love stories often emphasize the unexpected and unplanned nature of finding happiness, contrasting with traditional goal-oriented approaches.
<ul>
<li><strong>Example:</strong> Calvin and Grace Coolidge’s unconventional first encounter.</li>
</ul></li>
</ul>
</section>
<section id="hobbies-and-recreation-embracing-the-unplanned" class="level3">
<h3 class="anchored" data-anchor-id="hobbies-and-recreation-embracing-the-unplanned">Hobbies and Recreation: Embracing the Unplanned</h3>
<ul>
<li><strong>Hobbies chosen for enjoyment:</strong> Unlike careers, hobbies are often pursued without a specific objective, providing intrinsic satisfaction.
<ul>
<li><strong>Examples of unusual hobbies:</strong> Snail racing, underwater hockey, limbo skating, extreme unicycling, extreme ironing.</li>
</ul></li>
<li><strong>Hobbies as Stepping Stones:</strong> Some hobbies can unexpectedly evolve into successful careers.
<ul>
<li><strong>Example:</strong> Nathan Sawaya, a corporate attorney, turned his Lego building hobby into a full-time career.</li>
</ul></li>
<li><strong>The Value of “Pointless” Pursuits:</strong> Activities without a clear objective can still have significant benefits.
<ul>
<li><strong>Example:</strong> Joseph Herscher’s Rube Goldberg machines, initially created for entertainment, gained widespread recognition and led to media appearances.</li>
</ul></li>
<li><strong>Unstructured Play:</strong> Psychologists recognize the importance of unstructured play for children’s development, suggesting a similar need for adults.</li>
<li><strong>The Potential for Unexpected Discoveries:</strong> “Pointless” pursuits can lead to unforeseen solutions or innovations.
<ul>
<li><strong>Example:</strong> Marcelino de Sautuola’s caving and artifact hobbies led to the discovery of ancient cave paintings.</li>
</ul></li>
</ul>
</section>
<section id="pivoting-and-adapting-in-business" class="level3">
<h3 class="anchored" data-anchor-id="pivoting-and-adapting-in-business">Pivoting and Adapting in Business</h3>
<ul>
<li><strong>Internet Businesses:</strong> Many successful online ventures evolved from initial concepts through pivoting and adapting to user behavior.
<ul>
<li><strong>Example:</strong> YouTube, initially envisioned as a video dating site, transitioned to video sharing.</li>
<li><strong>Example:</strong> Flickr, a photo-sharing service, emerged from a larger social online game.</li>
</ul></li>
<li><strong>Nintendo:</strong>
<ul>
<li>Started in 1889 selling playing cards.</li>
<li>Explored diverse ventures (taxi service, hotels, instant rice, toys) before finding success in electronic toys and video games.</li>
<li><strong>Key Idea:</strong> Adapting to changing markets and embracing new opportunities led to Nintendo’s eventual dominance in the video game industry.</li>
</ul></li>
</ul>
</section>
<section id="the-right-to-follow-your-passions" class="level3">
<h3 class="anchored" data-anchor-id="the-right-to-follow-your-passions">The Right to Follow Your Passions</h3>
<ul>
<li><strong>Embrace serendipity:</strong> Be willing to deviate from original plans and follow passions, even if they seem to conflict with initial objectives.</li>
<li><strong>Acknowledge the unknown:</strong> Recognize that the path to happiness and fulfillment is often unpredictable.</li>
<li><strong>Value stepping stones:</strong> View seemingly unrelated experiences as potential stepping stones towards something greater.</li>
<li><strong>Trust your intuition:</strong> Be open to following a path that feels right, even without a clear objective justification.</li>
</ul>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<ul>
<li><strong>Success often arises from embracing the unplanned:</strong> Many great achievements result from a willingness to deviate from initial objectives and follow unexpected opportunities.</li>
<li><strong>Openness and flexibility are key:</strong> A rigid adherence to predetermined plans can hinder serendipitous discoveries and limit potential.</li>
<li><strong>Follow your passions:</strong> Embrace activities that resonate with you, even if they don’t seem to have a clear objective or practical application.</li>
<li><strong>Recognize the value of stepping stones:</strong> Seemingly unrelated experiences can be crucial stepping stones towards unexpected and fulfilling outcomes.</li>
</ul>
</section>
</section>
<section id="chapter-3-the-art-of-breeding-art" class="level2">
<h2 class="anchored" data-anchor-id="chapter-3-the-art-of-breeding-art">Chapter 3: The Art of Breeding Art</h2>
<section id="introduction-questioning-objectives" class="level3">
<h3 class="anchored" data-anchor-id="introduction-questioning-objectives">Introduction: Questioning Objectives</h3>
<ul>
<li><strong>The book challenges the common assumption that having an objective is always beneficial.</strong></li>
<li>The authors, AI researchers, initially embraced objectives like everyone else.</li>
<li>Their research on Picbreeder, a website for breeding pictures, led them to question the value of objectives.</li>
<li>Quote: “This book is about questioning the value of objectives.”</li>
</ul>
</section>
<section id="picbreeder-a-novel-experiment" class="level3">
<h3 class="anchored" data-anchor-id="picbreeder-a-novel-experiment"><a href="https://nbenko1.github.io/#/">Picbreeder</a>: A Novel Experiment</h3>
<ul>
<li><strong>Picbreeder was designed as a website where users could “breed” pictures, similar to animal breeding.</strong></li>
<li>The idea was to allow users to create visually appealing images through an evolutionary process, even without artistic skills.</li>
<li><strong>Genetic Art:</strong> Pictures are assigned artificial “DNA,” allowing them to be bred like animals (first introduced by Richard Dawkins).</li>
<li>Users select “parent” pictures based on their preferences, influencing the characteristics of the next generation.</li>
<li><strong>Branching:</strong> Users can continue breeding images evolved by others, enabling evolution over many generations.</li>
</ul>
</section>
<section id="the-role-of-objectives-in-picbreeder" class="level3">
<h3 class="anchored" data-anchor-id="the-role-of-objectives-in-picbreeder">The Role of Objectives in Picbreeder</h3>
<ul>
<li><strong>Objectives in Picbreeder relate to the desired outcome of the breeding process (e.g., evolving a face or an animal).</strong></li>
<li>Surprisingly, users achieved the best results when they were not explicitly focused on a specific objective.</li>
<li><strong>Serendipity played a crucial role in major discoveries on Picbreeder.</strong></li>
</ul>
</section>
<section id="picbreeders-mechanics-and-discoveries" class="level3">
<h3 class="anchored" data-anchor-id="picbreeders-mechanics-and-discoveries">Picbreeder’s Mechanics and Discoveries</h3>
<ul>
<li><strong>Picbreeder allows users to start from scratch (random blobs) or branch from existing images.</strong></li>
<li><strong>Starting from scratch:</strong>
<ul>
<li>Users select parent blobs from a randomly generated set.</li>
<li>Evolution progresses as users repeatedly choose parents for subsequent generations.</li>
</ul></li>
<li><strong>Branching:</strong>
<ul>
<li>Users can continue evolving images published by other users.</li>
<li>This extends the evolutionary process beyond the typical attention span of a single user.</li>
</ul></li>
<li><strong>Despite starting from simple blobs, Picbreeder users evolved remarkably complex and compelling images.</strong></li>
<li>These discoveries were made by non-artists who were simply exploring the platform.</li>
</ul>
</section>
<section id="the-paradox-of-objectives-in-picbreeder" class="level3">
<h3 class="anchored" data-anchor-id="the-paradox-of-objectives-in-picbreeder">The Paradox of Objectives in Picbreeder</h3>
<ul>
<li><strong>It’s often impossible to breed a specific image if it’s set as an objective.</strong></li>
<li>Even images previously discovered on Picbreeder cannot be reliably reproduced when targeted directly.</li>
<li>Computer simulations confirmed this: programs attempting to evolve towards a target image consistently failed.</li>
<li><strong>Discoveries happen when the desired image is <em>not</em> the objective.</strong></li>
</ul>
</section>
<section id="the-car-example-serendipity-in-action" class="level3">
<h3 class="anchored" data-anchor-id="the-car-example-serendipity-in-action">The Car Example: Serendipity in Action</h3>
<ul>
<li>Ken Stanley (one of the authors) discovered the “Car” image on Picbreeder.</li>
<li><strong>Ken was not trying to breed a car; he started from an “Alien Face” image and aimed to breed more alien faces.</strong></li>
<li><strong>Serendipity:</strong> Random mutations caused the alien’s eyes to gradually descend, eventually resembling wheels.</li>
<li>This unexpected stepping stone led to the discovery of the Car.</li>
</ul>
</section>
<section id="stepping-stones-and-open-minds" class="level3">
<h3 class="anchored" data-anchor-id="stepping-stones-and-open-minds">Stepping Stones and Open Minds</h3>
<ul>
<li><strong>Most attractive images on Picbreeder were discovered through serendipitous stepping stones.</strong></li>
<li>The stepping stones rarely resemble the final product.</li>
<li><strong>Picbreeder’s success stems from its lack of a unified objective.</strong> Users follow individual instincts, laying stepping stones for others.</li>
<li><strong>The most successful users are those with open minds, who avoid fixating on a specific objective.</strong></li>
</ul>
</section>
<section id="implications-beyond-picbreeder" class="level3">
<h3 class="anchored" data-anchor-id="implications-beyond-picbreeder">Implications Beyond Picbreeder</h3>
<ul>
<li><strong>The principle observed on Picbreeder may apply to other areas of life:</strong>
<ul>
<li>Focusing too much on a distant objective might cause us to miss crucial stepping stones.</li>
<li>Stepping stones may not resemble the final destination.</li>
</ul></li>
<li><strong>The distant objective can be a misleading guide.</strong></li>
</ul>
</section>
<section id="conclusion-1" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-1">Conclusion</h3>
<ul>
<li>Abandoning objectives is often the best strategy for achieving significant breakthroughs.</li>
<li>This is because stepping stones rarely resemble the final destination, regardless of whether it was planned.</li>
<li>The next chapter will explore the reasons behind this pattern and explain why distant objectives can be deceptive.</li>
</ul>
</section>
</section>
<section id="chapter-4-the-false-compass" class="level2">
<h2 class="anchored" data-anchor-id="chapter-4-the-false-compass">Chapter 4: The False Compass</h2>
<section id="introduction-the-problem-of-stepping-stones-in-a-fog" class="level3">
<h3 class="anchored" data-anchor-id="introduction-the-problem-of-stepping-stones-in-a-fog">Introduction: The Problem of Stepping Stones in a Fog</h3>
<ul>
<li><strong>Stepping stones</strong> represent the necessary waypoints to reach an objective in a large, uncharted search space.</li>
<li>The challenge of search and discovery is that we usually don’t know the stepping stones to the objective at the outset.</li>
<li><strong>Ambitious objectives</strong> are particularly difficult because their solutions are multiple stepping stones away, making them hard to predict.</li>
<li>The human condition is akin to being marooned on a stepping stone with limited foresight.</li>
</ul>
</section>
<section id="the-deception-of-objective-functions" class="level3">
<h3 class="anchored" data-anchor-id="the-deception-of-objective-functions">The Deception of Objective Functions</h3>
<ul>
<li><strong>Objective functions</strong> (measures of progress) are used to track progress towards objectives.</li>
<li>The assumption that improving objective function scores guarantees progress towards the objective is often <strong>wrong</strong>.</li>
<li><strong>Deception</strong> occurs when the objective function is a false compass, meaning it may not register progress even when moving closer to the objective.</li>
<li><strong>Example:</strong> The Chinese finger trap, where moving away from freedom (pushing inward) is the stepping stone to achieving freedom.</li>
<li>Ambitious problems are likely to involve multiple deceptive stepping stones.</li>
<li><strong>Deception is universal</strong> in complex problems because the stepping stones to solve them are not obvious.</li>
<li><strong>Examples:</strong> Chess moves that seem promising but lead to trouble, vacuum tubes leading to computers, ragtime leading to rock and roll.</li>
</ul>
</section>
<section id="non-objective-systems-of-discovery-picbreeder-evolution-and-innovation" class="level3">
<h3 class="anchored" data-anchor-id="non-objective-systems-of-discovery-picbreeder-evolution-and-innovation">Non-Objective Systems of Discovery: Picbreeder, Evolution, and Innovation</h3>
<section id="picbreeder-a-stepping-stone-collector" class="level4">
<h4 class="anchored" data-anchor-id="picbreeder-a-stepping-stone-collector">Picbreeder: A Stepping-Stone Collector</h4>
<ul>
<li>Picbreeder has no final objective; it’s a <strong>stepping-stone collector</strong>, creating the potential for finding more stepping stones.</li>
<li>Collecting stepping stones is not about pursuing a specific objective but about creating a road to everywhere.</li>
</ul>
</section>
<section id="natural-evolution-a-non-objective-process" class="level4">
<h4 class="anchored" data-anchor-id="natural-evolution-a-non-objective-process">Natural Evolution: A Non-Objective Process</h4>
<ul>
<li><strong>Thought experiment:</strong> Evolving human-level intelligence from single-celled organisms in a Petri dish.</li>
<li><strong>Flawed strategy:</strong> Administering intelligence tests to single-celled organisms and selecting the highest scorers for reproduction.</li>
<li><strong>Reason for failure:</strong> Stepping stones to intelligence (e.g., multicellularity, bilateral symmetry) do not resemble intelligence.</li>
<li>Human-level intelligence is a <strong>deceptive objective</strong> for evolution.</li>
<li><strong>Evolution’s success:</strong> It did not try to evolve human-level intelligence.</li>
<li><strong>Nature as a stepping-stone collector:</strong> Organisms reproduce based on their success in their own niche, not based on their potential to lead to humans.</li>
<li><strong>Examples of non-objective outcomes:</strong> Flight, photosynthesis, the human mind were not objectives of evolution but arose as byproducts.</li>
</ul>
</section>
<section id="survive-and-reproduce-a-constraint-not-an-objective" class="level4">
<h4 class="anchored" data-anchor-id="survive-and-reproduce-a-constraint-not-an-objective">Survive and Reproduce: A Constraint, Not an Objective</h4>
<ul>
<li>The common belief that evolution’s objective is to survive and reproduce is misleading.</li>
<li><strong>Constraints vs.&nbsp;Objectives:</strong> Survive and reproduce is a minimal criterion for continued evolution, not a well-defined product to be produced.</li>
<li>Every organism in the lineage leading to humans satisfied the “survive and reproduce” constraint, making it an odd type of objective.</li>
<li><strong>Survive and reproduce as a constraint:</strong> It allows evolution to identify successful organisms that may lead to other successful organisms, facilitating stepping-stone collection.</li>
</ul>
</section>
<section id="human-innovation-a-non-objective-process" class="level4">
<h4 class="anchored" data-anchor-id="human-innovation-a-non-objective-process">Human Innovation: A Non-Objective Process</h4>
<ul>
<li><strong>Thought experiment:</strong> Gathering brilliant minds 5,000 years ago to build a computer.</li>
<li><strong>Reason for failure:</strong> The stepping stones to computers (e.g., vacuum tubes, electricity) were not yet discovered.</li>
<li><strong>Deceptive objective:</strong> Focusing on the computer diverts attention from pursuing the necessary prerequisites.</li>
<li><strong>Hypothesis about invention:</strong> Almost no prerequisite to any major invention was invented with that invention in mind.</li>
<li><strong>Example:</strong> The Wright brothers’ invention of the airplane relied on pre-existing innovations like the internal combustion engine, which was not invented with flight in mind.</li>
<li><strong>The chain of innovation:</strong> Each link (e.g., induction coil, internal combustion engine, airplane) was not invented with the next link in mind.</li>
<li><strong>Great invention:</strong> Recognizing that existing stepping stones, laid by predecessors with unrelated ambitions, can be combined and enhanced to reach a new stepping stone.</li>
<li><strong>Human innovation as a stepping-stone collector:</strong> The tree of human innovation grows outward, driven by individual pursuits and discoveries, leading to unexpected outcomes.</li>
</ul>
</section>
</section>
<section id="the-disconnect-between-the-myth-of-the-objective-and-reality" class="level3">
<h3 class="anchored" data-anchor-id="the-disconnect-between-the-myth-of-the-objective-and-reality">The Disconnect Between the Myth of the Objective and Reality</h3>
<ul>
<li><strong>Conventional wisdom:</strong> We’re supposed to know our dreams and strive for them with passion and commitment.</li>
<li><strong>Reality:</strong> Ambitious objectives often lead to deception and failure because the stepping stones do not resemble the final destination.</li>
<li><strong>Examples:</strong>
<ul>
<li>Evolving intelligence by measuring intelligence is flawed.</li>
<li>Building a computer without the necessary stepping stones is impossible.</li>
<li>Becoming rich solely by seeking a higher salary is unlikely.</li>
</ul></li>
<li><strong>The power of ignoring objectives:</strong> Astonishing achievements often occur when the objective is ignored, and exploration is allowed to roam freely.</li>
<li><strong>Ambitious objectives vs.&nbsp;Stepping Stones:</strong> Objectives close at hand can be pursued effectively, but ambitious objectives require a different approach.</li>
<li><strong>The paradox of search:</strong> The world’s greatest compass can lead us astray, while a form of ignorance (not being fixated on a distant objective) can be surprisingly powerful.</li>
</ul>
</section>
<section id="conclusion-embracing-non-objective-search" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-embracing-non-objective-search">Conclusion: Embracing Non-Objective Search</h3>
<ul>
<li>The disconnect between conventional wisdom and the reality of search presents an opportunity.</li>
<li>We can leverage the way the world really works (stepping-stone collection) to our advantage.</li>
<li>The next chapter will explore how to play the game of discovery on its own terms, without relying on the false compass of objectives.</li>
<li>This approach involves embracing untamed, wild, and unfamiliar exploration.</li>
</ul>
</section>
</section>
<section id="chapter-5-the-interesting-and-the-novel" class="level2">
<h2 class="anchored" data-anchor-id="chapter-5-the-interesting-and-the-novel">Chapter 5: The Interesting and the Novel</h2>
<section id="introduction-the-problem-with-objectives" class="level3">
<h3 class="anchored" data-anchor-id="introduction-the-problem-with-objectives">Introduction: The Problem with Objectives</h3>
<ul>
<li><strong>Anecdote:</strong> New Year’s resolutions often fail because people focus on the end goal without identifying the steps to get there.</li>
<li><strong>Central Argument:</strong> Instead of focusing on objectives, we should focus on identifying and exploring <strong>novel stepping stones</strong>, even if they don’t directly lead to a pre-defined objective.
<ul>
<li><strong>Novelty:</strong> Discovering something genuinely new that can potentially lead to further novelties.</li>
<li><strong>Stepping Stone:</strong> A discovery or development that opens up new possibilities and avenues for exploration.</li>
</ul></li>
</ul>
</section>
<section id="judging-progress-by-novelty-not-objectives" class="level3">
<h3 class="anchored" data-anchor-id="judging-progress-by-novelty-not-objectives">Judging Progress by Novelty, Not Objectives</h3>
<ul>
<li><strong>Problem with Objectives:</strong>
<ul>
<li><strong>Preoccupation with the future:</strong> We constantly compare our present state to an idealized future objective.</li>
<li><strong>Deception:</strong> Objectives can be misleading and may not reveal the necessary stepping stones (e.g., air travel and induction coils).</li>
</ul></li>
<li><strong>Solution: Comparing to the Past:</strong>
<ul>
<li><strong>The past is a guide to novelty:</strong> We can objectively compare our current state to our past, identifying how we’ve deviated and created something new.</li>
<li><strong>Focus on escaping the outdated:</strong> This opens up new possibilities and potential stepping stones.</li>
</ul></li>
</ul>
</section>
<section id="the-power-of-novelty-and-interestingness" class="level3">
<h3 class="anchored" data-anchor-id="the-power-of-novelty-and-interestingness">The Power of Novelty and Interestingness</h3>
<ul>
<li><strong>Novelty as a Stepping Stone Detector:</strong> Novel discoveries are potential stepping stones to further novelties.</li>
<li><strong>Interestingness:</strong>
<ul>
<li><strong>Definition:</strong> Interesting ideas open up new possibilities.</li>
<li><strong>Philosophical Significance:</strong>
<ul>
<li>Alfred Whitehead: “It is more important that a proposition be interesting than it be true.”</li>
<li>W.T. Stace: “The criticism that interestingness is a trivial end proceeds from a scale of values thus perverted and turned upside down.”</li>
</ul></li>
</ul></li>
<li><strong>Compounding Novelty:</strong> Continually seeking novelty creates an endless chain of stepping stones, branching out into an open future.</li>
<li><strong>Examples:</strong> Picbreeder, natural evolution, and human innovation illustrate this <strong>ratcheting process</strong> of building upon stepping stones without a specific end goal.</li>
</ul>
</section>
<section id="embracing-the-unknown-novelty-search" class="level3">
<h3 class="anchored" data-anchor-id="embracing-the-unknown-novelty-search">Embracing the Unknown: Novelty Search</h3>
<ul>
<li><strong>Fear of Aimlessness:</strong> Searching for novelty might seem unanchored and random.</li>
<li><strong>Information in Novelty:</strong>
<ul>
<li>Novelty provides information about how something is different from the past.</li>
<li>This information is arguably more plentiful and reliable than information provided by an objective (which can be deceptive).</li>
</ul></li>
<li><strong>Human Sensitivity to Novelty:</strong> We are naturally drawn to explore novel paths and ideas, even without knowing where they might lead.
<ul>
<li><strong>Intuition and Hunches:</strong> These can guide us towards interesting and novel directions.</li>
</ul></li>
</ul>
</section>
<section id="the-myth-of-serendipity" class="level3">
<h3 class="anchored" data-anchor-id="the-myth-of-serendipity">The Myth of Serendipity</h3>
<ul>
<li><strong>Traditional View:</strong> Serendipity is seen as accidental, like a mad scientist stumbling upon a breakthrough.</li>
<li><strong>Reality:</strong> Most serendipitous discoveries are made by intelligent, educated, and accomplished individuals who have a <strong>strong intuition for what is interesting</strong>.</li>
<li><strong>Examples:</strong>
<ul>
<li>Isaac Newton: Observing an apple falling led to the discovery of the universal law of gravitation.</li>
<li>Louis Pasteur: Made accidental discoveries like chiral molecules and bacterial vaccines.</li>
<li>Archimedes: Eureka moment in the bathtub led to understanding displacement and volume.</li>
</ul></li>
<li><strong>Prepared Minds:</strong>
<ul>
<li>These individuals were able to recognize the significance of their observations and connect them to broader concepts.</li>
<li>Louis Pasteur: “In the fields of observation chance favors only the prepared mind.”</li>
</ul></li>
</ul>
</section>
<section id="formalizing-novelty-search-an-algorithm-without-an-objective" class="level3">
<h3 class="anchored" data-anchor-id="formalizing-novelty-search-an-algorithm-without-an-objective">Formalizing Novelty Search: An Algorithm Without an Objective</h3>
<ul>
<li><strong>Algorithms:</strong>
<ul>
<li>Traditional View: Recipes for solving specific problems.</li>
<li>Broader Definition: A way of clearly describing a process, with or without an objective.</li>
</ul></li>
<li><strong>Novelty Search Algorithm:</strong> Formalizes the process of searching for novelty as a computer program.</li>
<li><strong>Domain:</strong> The specific area or category within which the algorithm searches for novelty (e.g., art, music, robot behaviors).</li>
<li><strong>Robot Behavior Example:</strong>
<ul>
<li><strong>Traditional Approach (Objective-Driven):</strong> A robot learns to navigate a hallway to reach an open door by incrementally improving its ability to move closer to the door.</li>
<li><strong>Novelty Search Approach:</strong>
<ul>
<li>The robot seeks novel behaviors, initially crashing into walls in various ways.</li>
<li>By exhausting simple behaviors, it eventually learns to avoid walls and navigate the hallway to find further novelties, eventually reaching the door even though it wasn’t an objective.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-order-of-discovery-in-novelty-search" class="level3">
<h3 class="anchored" data-anchor-id="the-order-of-discovery-in-novelty-search">The Order of Discovery in Novelty Search</h3>
<ul>
<li><strong>Traditional Objective-Driven Search:</strong> Expects an order from bad to good behavior, with incremental improvements towards the objective.</li>
<li><strong>Problem with Bad-to-Good Ordering:</strong>
<ul>
<li><strong>Deceptive Problems:</strong> Like the Chinese finger trap, progress may require temporarily moving away from the objective (from bad to worse before getting better).</li>
</ul></li>
<li><strong>Novelty Search Ordering:</strong> From simple to complex behaviors.
<ul>
<li><strong>Novelty is Context-Dependent:</strong> What is considered novel changes over time as new behaviors are discovered.</li>
<li><strong>Simplicity to Complexity:</strong>
<ul>
<li>Initially, simple behaviors (requiring little knowledge of the world) are novel.</li>
<li>To continue finding novelty, the search must learn about the world and produce increasingly complex behaviors.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="novelty-search-as-an-information-accumulator" class="level3">
<h3 class="anchored" data-anchor-id="novelty-search-as-an-information-accumulator">Novelty Search as an Information Accumulator</h3>
<ul>
<li><strong>Information Accumulation:</strong> Both novelty search and other non-objective searches (like natural evolution) accumulate information about the world as they progress from simple to complex.</li>
<li><strong>Natural Evolution:</strong>
<ul>
<li>Increasing complexity is driven by the need to find new niches and species as simple options are exhausted.</li>
<li>Organisms reflect aspects of the world in their structure and behavior (e.g., eyes reflect light, lungs reflect oxygen).</li>
<li>Evolution can be seen as a process of accumulating information about the universe.</li>
</ul></li>
<li><strong>Picbreeder:</strong> Reflects aspects of the human world (its environment) by discovering familiar themes like faces, butterflies, and castles.</li>
<li><strong>Novelty Search:</strong> The robot in the hallway example illustrates how it must learn about walls and doors to continue finding novel behaviors.</li>
</ul>
</section>
<section id="constraints-and-meaningfulness-in-novelty-search" class="level3">
<h3 class="anchored" data-anchor-id="constraints-and-meaningfulness-in-novelty-search">Constraints and Meaningfulness in Novelty Search</h3>
<ul>
<li><strong>Concern:</strong> Without an objective, novelty search might explore meaningless behaviors.</li>
<li><strong>World as a Constraint:</strong>
<ul>
<li>Physical laws limit the space of possible behaviors.</li>
<li>Many imaginable behaviors are impossible in reality (e.g., walking through walls).</li>
</ul></li>
<li><strong>Information Accumulation and Meaning:</strong>
<ul>
<li>Behaviors that respect the laws of physics and exploit how the world works are better stepping stones to further novelty.</li>
<li>Novelty search tends to focus on meaningful behaviors because they lead to more possibilities.</li>
</ul></li>
</ul>
</section>
<section id="novelty-as-an-objective-a-misinterpretation" class="level3">
<h3 class="anchored" data-anchor-id="novelty-as-an-objective-a-misinterpretation">Novelty as an Objective: A Misinterpretation</h3>
<ul>
<li><strong>Argument:</strong> Some argue that novelty itself is an objective.</li>
<li><strong>Problems with this View:</strong>
<ul>
<li><strong>Achieving Novelty is Different from Achieving an Objective:</strong> With novelty, the specific outcome is not the goal.</li>
<li><strong>Novelty is Fleeting:</strong> What is novel quickly becomes less novel, unlike achieving a fixed objective.</li>
<li><strong>Multiple Fulfillments:</strong> A novelty-driven search might achieve “novelty” many times before reaching a specific outcome, making it unclear how that outcome fulfills the “objective”.</li>
</ul></li>
<li><strong>Distinction is Important:</strong> Using the word “objective” for both traditional goals and novelty muddles the important differences between them.</li>
<li><strong>Similarities to “Survive and Reproduce”:</strong> Both are constraints rather than objectives, can be satisfied from the beginning, and lead to discoveries that weren’t initially intended.</li>
</ul>
</section>
<section id="divergence-and-novelty-search" class="level3">
<h3 class="anchored" data-anchor-id="divergence-and-novelty-search">Divergence and Novelty Search</h3>
<ul>
<li><strong>Objectives and Convergence:</strong> Objectives naturally lead to convergence, limiting exploration of other possibilities.</li>
<li><strong>Novelty Search and Divergence:</strong> Without objectives, novelty search can branch out in many directions, exploring a wider range of possibilities.</li>
<li><strong>Divergent Thinking and Creativity:</strong> Divergent thinking is associated with finding novel and surprising solutions that others miss.</li>
</ul>
</section>
<section id="testing-novelty-search-the-robot-maze-experiment" class="level3">
<h3 class="anchored" data-anchor-id="testing-novelty-search-the-robot-maze-experiment">Testing Novelty Search: The Robot Maze Experiment</h3>
<ul>
<li><strong>Scientific Approach:</strong> Implement novelty search as a computer algorithm to test its effectiveness.</li>
<li><strong>Robot Maze Simulation:</strong>
<ul>
<li>The computer simulates a robot in a maze.</li>
<li>The program generates new robot behaviors.</li>
<li>Novel behaviors are considered “good” and explored further by making slight modifications.</li>
</ul></li>
<li><strong>Results:</strong>
<ul>
<li><strong>Novelty Search:</strong> Successfully found maze-solving behaviors in 39 out of 40 trials.</li>
<li><strong>Objective-Based Search:</strong> Succeeded in only 3 out of 40 trials.</li>
</ul></li>
<li><strong>Explanation:</strong>
<ul>
<li><strong>Deception:</strong> Objective-based search was misled by cul-de-sacs that appeared to be closer to the goal.</li>
<li><strong>Novelty Search:</strong> Unaffected by deception because it wasn’t focused on the goal.</li>
</ul></li>
</ul>
</section>
<section id="further-experiments-and-applications" class="level3">
<h3 class="anchored" data-anchor-id="further-experiments-and-applications">Further Experiments and Applications</h3>
<ul>
<li><strong>Biped Robot:</strong>
<ul>
<li>Novelty search produced better walking gaits than objective-based search (which aimed to maximize walking distance).</li>
<li><strong>Deception:</strong> Falling down and kicking, which are stepping stones to walking, were penalized by the objective-based approach.</li>
</ul></li>
<li><strong>Other Applications:</strong>
<ul>
<li>Replicating maze results.</li>
<li>Evolving artificial ants that follow food trails.</li>
<li>Solving deceptive problems in robot body-brain co-evolution.</li>
<li>Finding bugs in computer programs.</li>
<li>Evolving robots that learn and adapt.</li>
</ul></li>
</ul>
</section>
<section id="limitations-and-the-future-of-novelty-search" class="level3">
<h3 class="anchored" data-anchor-id="limitations-and-the-future-of-novelty-search">Limitations and the Future of Novelty Search</h3>
<ul>
<li><strong>Limitations:</strong> Novelty search is not a universal solution and can fail in very complex problems.</li>
<li><strong>Maze Experiment with Varying Difficulty:</strong>
<ul>
<li>Both novelty search and objective-based search struggled with increasingly complex mazes.</li>
<li>Objective-based search’s performance declined more rapidly.</li>
</ul></li>
<li><strong>No Magic Bullet:</strong> There may not be a single method that can consistently solve all problems.</li>
<li><strong>Embracing Futility:</strong> Accepting that we can’t always achieve our objectives allows us to appreciate the interesting and novel discoveries made along the way, even if they don’t lead to a specific destination.</li>
<li><strong>The Treasure Hunter:</strong> Instead of seeking a magic bullet, we can become treasure hunters, exploring the possibilities opened up by novelty and enjoying the unexpected discoveries we make.</li>
</ul>
</section>
</section>
<section id="chapter-6-long-live-the-treasure-hunter" class="level2">
<h2 class="anchored" data-anchor-id="chapter-6-long-live-the-treasure-hunter">Chapter 6: Long Live the Treasure Hunter</h2>
<section id="introduction-the-limitations-of-possibility-and-the-power-of-novelty-search" class="level3">
<h3 class="anchored" data-anchor-id="introduction-the-limitations-of-possibility-and-the-power-of-novelty-search">Introduction: The Limitations of Possibility and the Power of Novelty Search</h3>
<ul>
<li><strong>Novelty search</strong>, as discussed in previous chapters, suggests that finding objectives can sometimes be easier when not directly searching for them.</li>
<li>This chapter explores the limitations of novelty search and the concept of <strong>objectives</strong> in problem-solving.</li>
<li>It challenges the cultural notion that “anything is possible” and acknowledges the existence of limitations.</li>
<li>The chapter aims to find a balance between optimism and realism when considering future possibilities.</li>
</ul>
</section>
<section id="the-paradox-of-novelty-search-and-the-myth-of-the-objective" class="level3">
<h3 class="anchored" data-anchor-id="the-paradox-of-novelty-search-and-the-myth-of-the-objective">The Paradox of Novelty Search and the Myth of the Objective</h3>
<ul>
<li><strong>Novelty search as a tool:</strong> While novelty search can be a useful tool, it’s not a universal solution. It may not work for all problems, particularly those involving vast, complex search spaces (e.g., an endless maze).</li>
<li><strong>Myth of the objective:</strong> Despite novelty search’s successes in certain scenarios, the belief in the necessity of objectives persists.</li>
<li><strong>Diversity as a compromise:</strong> One argument is that objectives are still valuable but require a <strong>diversity of ideas</strong> during the search process to avoid being misled by deceptive paths.</li>
<li><strong>Horse racing analogy:</strong> This perspective is compared to betting on multiple horses in a race to increase the chances of winning, suggesting that maintaining a variety of alternatives is beneficial even when pursuing an objective.</li>
<li><strong>Hybrid approach:</strong> This leads to the idea of combining objective-driven search with novelty search, using the objective for guidance and novelty to prevent deception.</li>
</ul>
</section>
<section id="the-deception-of-objectives-and-the-futility-of-search" class="level3">
<h3 class="anchored" data-anchor-id="the-deception-of-objectives-and-the-futility-of-search">The Deception of Objectives and the Futility of Search</h3>
<ul>
<li><strong>Ambitious objectives and deception:</strong> The chapter argues that the more ambitious the objective, the more deceptive it becomes.</li>
<li><strong>False compass analogy:</strong> A deceptive objective acts like a compass pointing in the wrong direction, rendering open-mindedness ineffective.</li>
<li><strong>Maze-navigating robot example:</strong> Even in a simple maze, the objective of reaching the end can be deceptive due to walls that attract the robot based on proximity but hinder actual progress.</li>
<li><strong>Limitations of objectives with novelty:</strong> Combining novelty with objectives doesn’t fully solve the deception problem in ambitious situations.</li>
<li><strong>Five thousand year old computer example:</strong> The objective of building a computer five thousand years ago would have been deeply deceptive, as the necessary stepping stones (e.g., vacuum tubes) were unimaginable at the time.</li>
<li><strong>Futility at the heart of search:</strong> The chapter concludes that no single search approach can guarantee reaching a specific objective, especially for highly ambitious goals.</li>
<li><strong>Limitations of objective-driven search:</strong> The fact that novelty search outperforms objective-driven search in some simple problems raises concerns about the latter’s effectiveness in more complex scenarios.</li>
<li><strong>No Free Lunch Theorem:</strong> This theorem supports the idea that there’s no universally best search algorithm, as improving performance on one set of problems can negatively impact performance on others.</li>
<li><strong>Black box optimization:</strong> This field in machine learning also acknowledges that general rules or heuristics can be misleading in specific circumstances.</li>
</ul>
</section>
<section id="the-treasure-hunter-embracing-discovery-without-objectives" class="level3">
<h3 class="anchored" data-anchor-id="the-treasure-hunter-embracing-discovery-without-objectives">The Treasure Hunter: Embracing Discovery Without Objectives</h3>
<ul>
<li><strong>Finding the unexpected:</strong> Despite the limitations of search, the chapter argues that we can reliably find amazing things, even if we can’t predefine them.</li>
<li><strong>Great discoveries as undefined:</strong> This idea is based on the success of Picbreeder, natural evolution, and human innovation, all of which involve processes without predefined objectives.</li>
<li><strong>Non-objective search as a treasure hunter:</strong> It’s presented as a powerful tool for finding unexpected treasures while exploring the search space.</li>
<li><strong>Picbreeder Car example:</strong> The Picbreeder Car, a surprising and complex image, was discovered without anyone explicitly searching for it, demonstrating the potential of non-objective search.</li>
<li><strong>The paradox of trying vs.&nbsp;not trying:</strong> The chapter highlights the irony that actively trying to achieve a specific objective can hinder progress, while exploring without a fixed goal can lead to unexpected breakthroughs.</li>
<li><strong>Treasure hunter’s approach:</strong> The treasure hunter collects as many stepping stones as possible, recognizing that any one of them could lead to something valuable, even if the ultimate destination is unknown.</li>
<li><strong>Collective exploration:</strong> The chapter emphasizes the importance of diverse individuals with different interests contributing to the exploration of the search space, rather than relying on a single objective or individual.</li>
<li><strong>The inevitability of the future:</strong> While the future may not unfold as planned, the continuous exploration of diverse individuals ensures that unexpected discoveries and advancements will emerge.</li>
</ul>
</section>
<section id="building-treasure-hunting-systems-harnessing-non-objective-principles" class="level3">
<h3 class="anchored" data-anchor-id="building-treasure-hunting-systems-harnessing-non-objective-principles">Building Treasure-Hunting Systems: Harnessing Non-Objective Principles</h3>
<ul>
<li><strong>Novelty search as a model:</strong> The chapter suggests that novelty search and Picbreeder demonstrate the feasibility of building systems based on non-objective principles.</li>
<li><strong>Human feedback and collaboration:</strong> Human feedback, as seen in Picbreeder, can play a crucial role in guiding non-objective search and capitalizing on the diverse tastes and insights of individuals.</li>
<li><strong>Internet as a platform for treasure hunting:</strong> The internet provides an ideal platform for organizing and facilitating collaborative treasure hunting through interconnected systems.</li>
<li><strong>Interactive catalog example:</strong> The chapter presents the concept of an interactive catalog (e.g., for furniture) where users can explore and “breed” new designs based on existing ones.</li>
<li><strong>Customer-driven design:</strong> This system allows customers to become active participants in the design process, discovering unique and personalized products that wouldn’t have been conceived through traditional methods.</li>
<li><strong>Collaborative stepping stone collection:</strong> The catalog evolves into a repository of user-generated designs, each potentially serving as a stepping stone for further exploration and innovation.</li>
<li><strong>Trusting the non-objective catalog:</strong> The chapter raises the question of whether users would trust a catalog where designs are generated through a collaborative, non-objective process rather than by expert designers.</li>
<li><strong>The role of experts:</strong> While acknowledging the importance of expert designers, the chapter suggests that non-objective systems can uncover hidden treasures that experts might miss due to their focus on specific objectives.</li>
<li><strong>Potential of non-objective systems:</strong> The chapter argues that non-objective systems, like the interactive catalog, can lead to the creation of innovative concepts that would otherwise remain undiscovered.</li>
</ul>
</section>
<section id="conclusion-embracing-the-futility-and-power-of-search" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-embracing-the-futility-and-power-of-search">Conclusion: Embracing the Futility and Power of Search</h3>
<ul>
<li><strong>Relinquishing the myth of the objective:</strong> The chapter concludes that we must accept the futility of searching for a guaranteed path to a predetermined destination, especially for ambitious goals.</li>
<li><strong>Embracing the treasure hunter:</strong> Instead, we should embrace the treasure hunter approach, exploring the search space without a fixed objective and collecting stepping stones that may lead to unexpected and valuable discoveries.</li>
<li><strong>Natural evolution, human innovation, Picbreeder, and novelty search as examples:</strong> These examples demonstrate the power and success of non-objective processes in generating innovation and progress.</li>
<li><strong>Liberation from objectives:</strong> Freeing ourselves from the grip of objectives can lead to a new perspective on the world and open up new possibilities for innovation and discovery.</li>
<li><strong>Implications for society:</strong> The next chapters will explore the implications of this non-objective perspective for how we organize and operate our society.</li>
<li><strong>The future of innovation:</strong> The chapter concludes with an optimistic outlook on the future of innovation, suggesting that it will be driven by the collective exploration of diverse individuals without a unified objective, leading to unexpected and exciting discoveries.</li>
</ul>
</section>
</section>
<section id="chapter-7-unshackling-education" class="level2">
<h2 class="anchored" data-anchor-id="chapter-7-unshackling-education">Chapter 7: Unshackling Education</h2>
<section id="societal-harms-of-objective-obsession" class="level3">
<h3 class="anchored" data-anchor-id="societal-harms-of-objective-obsession">Societal Harms of Objective Obsession</h3>
<section id="the-deception-of-objectives" class="level4">
<h4 class="anchored" data-anchor-id="the-deception-of-objectives">The Deception of Objectives</h4>
<ul>
<li><p><strong>Campbell’s law</strong>:</p>
<blockquote class="blockquote">
<p>“The more any quantitative social indicator is used for social decision-making, the more subject it will be to corruption pressures and the more apt it will be to distort and corrupt the social processes it is intended to monitor.” - David Campbell, <em>Assessing the impact of planned social change</em></p>
</blockquote>
<ul>
<li>Social indicators, like academic achievement tests, become less effective when used as objectives for improvement.</li>
<li>Focusing on simple metrics can lead to <strong>deception</strong>, as they often fail to capture the essence of the desired outcome.
<ul>
<li>Example: Judging teachers based on student test scores encourages teaching to the test, resulting in students who are good at test-taking but lack meaningful knowledge.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="gdp-fetishism" class="level4">
<h4 class="anchored" data-anchor-id="gdp-fetishism">GDP Fetishism</h4>
<ul>
<li><strong>GDP (gross domestic product)</strong>, a measure of national productivity, is often treated as a national objective.</li>
<li><strong>GDP fetishism</strong>: The tendency to overemphasize GDP as the primary indicator of economic health.</li>
<li>Increasing GDP doesn’t guarantee a healthy economy.
<ul>
<li>Policies that boost GDP in the short term may be detrimental in the long run.</li>
<li>GDP is a simple measure that fails to capture the complexity of a healthy economy.</li>
</ul></li>
</ul>
</section>
<section id="perverse-incentives" class="level4">
<h4 class="anchored" data-anchor-id="perverse-incentives">Perverse Incentives</h4>
<ul>
<li><strong>Perverse incentives</strong>: When rewards or measures intended to improve a situation actually make it worse.
<ul>
<li>Examples:
<ul>
<li>Paying citizens for dead snakes in India led to cobra breeding.</li>
<li>Paying for rat tails in Hanoi led to rat farming.</li>
<li>Campaigns to reduce alcohol or drug abuse can lead to the abuse of more dangerous substances.</li>
<li>Paying workers for dinosaur bone fragments led to the destruction of whole bones.</li>
<li>Paying executives with bonuses for higher earnings can incentivize short-term profits at the expense of long-term stability.</li>
</ul></li>
</ul></li>
</ul>
</section>
</section>
<section id="the-myth-of-the-objective-in-education" class="level3">
<h3 class="anchored" data-anchor-id="the-myth-of-the-objective-in-education">The Myth of the Objective in Education</h3>
<section id="the-aimless-youth-vs.-the-overachiever" class="level4">
<h4 class="anchored" data-anchor-id="the-aimless-youth-vs.-the-overachiever">The Aimless Youth vs.&nbsp;The Overachiever</h4>
<ul>
<li><p>The <strong>aimless youth</strong>, with no clear career goals, is often seen as a negative stereotype.</p></li>
<li><p>The <strong>overachiever</strong>, driven by ambitious career objectives, may be more susceptible to <strong>deception</strong>.</p>
<ul>
<li>Focusing on distant career aspirations as objectives can lead to pursuing steps that don’t actually contribute to achieving the desired outcome.</li>
</ul></li>
<li><p>The aimless youth, unburdened by specific objectives, has the freedom to explore and discover interesting paths.</p>
<ul>
<li><p>Example: Steve Jobs dropping out of college and exploring courses that interested him.</p>
<ul>
<li><blockquote class="blockquote">
<p>“After six months, I couldn’t see the value in it…So I decided to drop out and trust that it would all work out okay…The minute I dropped out I could stop taking the required classes that didn’t interest me, and begin dropping in on the ones that looked interesting.”</p>
</blockquote></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="assessing-schools-based-on-standardized-tests" class="level4">
<h4 class="anchored" data-anchor-id="assessing-schools-based-on-standardized-tests">Assessing Schools Based on Standardized Tests</h4>
<ul>
<li>Assessing schools based on standardized test scores can lead to <strong>deception</strong>.
<ul>
<li>Example: No Child Left Behind Act in Florida setting annual measurable objectives (AMO) for student proficiency in reading and mathematics.
<ul>
<li>The assumption is that increasing test scores indicate progress towards the objective of near-perfect proficiency.</li>
<li>However, this approach can lead to a focus on teaching to the test rather than fostering genuine understanding.</li>
</ul></li>
</ul></li>
<li>The complexity of education makes it unlikely that simple metrics like standardized test scores can accurately reflect progress towards ambitious objectives.</li>
</ul>
</section>
<section id="the-software-engineering-analogy" class="level4">
<h4 class="anchored" data-anchor-id="the-software-engineering-analogy">The Software Engineering Analogy</h4>
<ul>
<li>Early software engineering embraced metrics to improve productivity and quality.
<ul>
<li>“You can’t control what you can’t measure.” - Tom DeMarco, <em>Controlling software projects</em></li>
</ul></li>
<li>DeMarco later acknowledged the limitations of metrics in complex software projects.
<ul>
<li>“Metrics…must be used with careful moderation.”</li>
<li>Strict control through metrics is only appropriate for projects with modest goals.</li>
</ul></li>
<li>The obsession with metrics in software engineering led to engineers focusing on improving measurements rather than addressing underlying issues.</li>
<li>A similar situation may be occurring in the US educational system, with teachers and students pressured to improve test scores at the expense of genuine learning.</li>
</ul>
</section>
<section id="the-illusion-of-accuracy-in-assessment" class="level4">
<h4 class="anchored" data-anchor-id="the-illusion-of-accuracy-in-assessment">The Illusion of Accuracy in Assessment</h4>
<ul>
<li>The push for more accurate assessments in education, like the Race to the Top initiative, is based on the assumption that accuracy improves performance in objective-driven pursuits.</li>
<li>However, <strong>accuracy doesn’t necessarily lead to better outcomes in complex search spaces</strong>.
<ul>
<li>Example: The Picbreeder Skull image evolved through stepping stones that didn’t resemble the final image.
<ul>
<li>Even with accurate assessment of “Skull-ness,” an objective-driven approach would have failed to discover the Skull because the stepping stones looked nothing like it.</li>
</ul></li>
</ul></li>
<li>Accuracy becomes meaningless when the underlying compass (objective) is flawed.</li>
</ul>
</section>
<section id="the-pitfalls-of-uniform-standards" class="level4">
<h4 class="anchored" data-anchor-id="the-pitfalls-of-uniform-standards">The Pitfalls of Uniform Standards</h4>
<ul>
<li>The drive towards uniform standards, like the Common Core State Standards Initiative, aims to ensure equal access to quality education and facilitate comparisons.</li>
<li>However, uniformity can hinder progress by:
<ul>
<li><strong>Potentially adopting a flawed standard</strong>: Even a well-chosen standard may be rooted in the myth of the objective.</li>
<li><strong>Extinguishing diversity</strong>: Uniformity eliminates alternative standards that individual schools or states might be exploring, limiting future innovation.</li>
</ul></li>
<li>Uniformity doesn’t guarantee better outcomes and can stifle progress by reducing the diversity of approaches.</li>
</ul>
</section>
</section>
<section id="non-objective-thinking-in-education" class="level3">
<h3 class="anchored" data-anchor-id="non-objective-thinking-in-education">Non-Objective Thinking in Education</h3>
<section id="embracing-the-treasure-hunter" class="level4">
<h4 class="anchored" data-anchor-id="embracing-the-treasure-hunter">Embracing the Treasure Hunter</h4>
<ul>
<li>The alternative to objective deception in education is to adopt the <strong>treasure hunter</strong> approach.</li>
<li>Instead of focusing on assessments tied to ambitious objectives, we can encourage exploration and the sharing of diverse ideas.</li>
<li>Example: Replacing standardized tests with teacher portfolios assessed by peer review.
<ul>
<li>Teachers create portfolios showcasing their teaching methods, student work, etc.</li>
<li>Portfolios are anonymously reviewed by other teachers.</li>
<li>Standardized tests are only administered if a teacher’s portfolio receives a failing grade.</li>
</ul></li>
<li>This approach fosters a culture of sharing and learning from each other’s experiences, promoting innovation and creativity.</li>
</ul>
</section>
<section id="shifting-the-focus-from-assessment-to-exploration" class="level4">
<h4 class="anchored" data-anchor-id="shifting-the-focus-from-assessment-to-exploration">Shifting the Focus from Assessment to Exploration</h4>
<ul>
<li>Instead of prioritizing assessment, we can reframe education as a <strong>treasure hunt</strong> for the best teaching approaches.</li>
<li>This shift requires:
<ul>
<li>Reducing the emphasis on standardized tests.</li>
<li>Empowering teachers to utilize their creativity and intuition.</li>
<li>Encouraging experimentation and the exploration of diverse methods.</li>
</ul></li>
<li>Finland’s education system, which grants greater autonomy to teachers and doesn’t impose standardized tests, serves as an example of a non-objective approach.</li>
</ul>
</section>
<section id="embracing-uncertainty" class="level4">
<h4 class="anchored" data-anchor-id="embracing-uncertainty">Embracing Uncertainty</h4>
<ul>
<li>Rejecting the myth of the objective in education requires embracing uncertainty.</li>
<li>We must accept that there may not be a single, objective solution to achieving exceptional education for all students.</li>
<li>By focusing on exploration, diversity, and the sharing of ideas, we can foster a more dynamic and innovative educational landscape.</li>
</ul>
</section>
</section>
</section>
<section id="chapter-8-unchaining-innovation" class="level2">
<h2 class="anchored" data-anchor-id="chapter-8-unchaining-innovation">Chapter 8: Unchaining Innovation</h2>
<section id="introduction-the-allure-of-exploration-and-the-myth-of-the-objective" class="level3">
<h3 class="anchored" data-anchor-id="introduction-the-allure-of-exploration-and-the-myth-of-the-objective">Introduction: The Allure of Exploration and the Myth of the Objective</h3>
<ul>
<li>The chapter opens with captivating stories of early explorers like Magellan, Verrazzano, and Scott who braved the unknown, highlighting the inherent risks and potential rewards of exploration.</li>
<li><strong>Innovation</strong>, particularly in science, is presented as a modern form of exploration with the power to reshape society.</li>
<li>The chapter aims to explore how the <strong>myth of the objective</strong> hinders innovation in various fields, including science, business, and art.</li>
<li>The rapid pace of scientific progress is emphasized through examples like George Washington’s letter-writing predicament and the evolution of communication from handwritten letters to real-time video chats.</li>
<li>The chapter acknowledges that scientific exploration may not be as visually thrilling as geographical expeditions, but the discoveries it yields can be equally transformative, potentially leading to advancements like a universal cure for cancer or cheap energy through nuclear fusion.</li>
<li>The chapter establishes that the pursuit of scientific innovation is often constrained by the <strong>myth of the objective</strong>, particularly in funding decisions, which tend to prioritize projects with clear objectives and predictable outcomes.</li>
</ul>
</section>
<section id="the-problem-with-consensus-in-science-funding" class="level3">
<h3 class="anchored" data-anchor-id="the-problem-with-consensus-in-science-funding">The Problem with Consensus in Science Funding</h3>
<ul>
<li><strong>Science funding</strong> is identified as a key area where the myth of the objective plays a significant role.</li>
<li>Government funding agencies like the NSF and ESF rely on <strong>peer review</strong> to evaluate grant proposals, favoring projects that achieve consensus among expert reviewers.</li>
<li>The chapter argues that <strong>consensus can be detrimental to innovation</strong> because it discourages exploration of diverse and potentially groundbreaking ideas.</li>
<li><strong>Picbreeder</strong> is used as an analogy to illustrate how consensus can stifle creativity.
<ul>
<li>Picbreeder’s success in generating novel images stems from the fact that users are free to explore diverse paths without needing to agree on which images are “better.”</li>
<li>If a panel of experts were to vote on the next image in Picbreeder, the number of explored paths would be severely limited.</li>
</ul></li>
<li>The chapter suggests that <strong>rewarding disagreement</strong> instead of consensus might be a more effective strategy for promoting innovation.
<ul>
<li>Unanimous agreement on a project might indicate that it merely echoes the status quo.</li>
<li><strong>Interesting ideas are more likely to split expert opinions</strong> because they often challenge existing paradigms and explore uncharted territory.</li>
<li>Examples like Darwin’s theory of evolution and Thomas Kuhn’s concept of paradigm shifts are cited to demonstrate how groundbreaking ideas initially faced resistance from the scientific community.</li>
</ul></li>
<li>The chapter clarifies that it’s not advocating for funding all projects with disagreement, but rather suggesting that some resources should be allocated to support <strong>interesting and potentially transformative research</strong>, even if it lacks consensus.</li>
<li>The emphasis on consensus in science funding is linked to <strong>objective thinking</strong>, which prioritizes reaching a predetermined destination over exploring diverse and potentially serendipitous paths.</li>
<li>The chapter concludes that <strong>science needs to embrace the role of a treasure hunter and a stepping stone collector</strong>, allowing researchers to explore diverse and unpredictable paths rather than being solely focused on achieving predefined objectives.</li>
</ul>
</section>
<section id="the-illusion-of-predictable-scientific-progress-and-impact" class="level3">
<h3 class="anchored" data-anchor-id="the-illusion-of-predictable-scientific-progress-and-impact">The Illusion of Predictable Scientific Progress and Impact</h3>
<ul>
<li>The myth of the objective leads to the assumption that scientific progress is predictable and that the stepping stones to important discoveries can be laid out in an orderly fashion.</li>
<li>The chapter challenges this assumption by highlighting the <strong>serendipitous nature of many scientific breakthroughs</strong>.</li>
<li><strong>Grand, objective-driven projects</strong> aimed at solving specific problems are discussed, with examples like Japan’s Fifth Generation Computer Systems project and the War on Cancer.
<ul>
<li>These projects, despite significant funding and targeted research, often fail to achieve their stated objectives or produce unexpected outcomes.</li>
</ul></li>
<li>The chapter acknowledges that some ambitious projects, like the space race, can be successful, but emphasizes that such success often relies on <strong>pre-existing stepping stones</strong> developed outside the scope of the project itself.</li>
<li>The chapter argues that <strong>predicting the impact of scientific research is challenging</strong> and that focusing solely on projects with perceived high impact can be short-sighted.
<ul>
<li>Many important discoveries are unexpected and may not seem immediately impactful.</li>
<li><strong>Interesting research, even if not deemed immediately important, can lead to unanticipated breakthroughs in the future</strong>.</li>
</ul></li>
<li><strong>Picbreeder and novelty search</strong> are again used as analogies to illustrate how systems can produce remarkable results even when individual components are not evaluated based on their progress towards a specific objective.</li>
<li>The chapter suggests that funding agencies should consider supporting <strong>interesting and potentially transformative research</strong>, even if its immediate impact is unclear.</li>
<li>Examples from pure mathematics, such as group theory and public-key cryptography, are provided to demonstrate how seemingly “useless” research can later have significant practical applications.</li>
<li>The chapter cautions against <strong>funding science based solely on its alignment with specific national interests or short-term economic goals</strong>.
<ul>
<li>This approach can stifle basic research and limit the potential for serendipitous discoveries.</li>
<li>The chapter criticizes policies that prioritize research with immediate economic benefits over curiosity-driven exploration.</li>
</ul></li>
<li>The chapter concludes that while scientific progress is possible, it is not always predictable, and that embracing <strong>curiosity-driven research</strong> and exploring diverse paths is essential for achieving transformative breakthroughs.</li>
</ul>
</section>
<section id="embracing-risk-and-uncertainty-in-scientific-funding" class="level3">
<h3 class="anchored" data-anchor-id="embracing-risk-and-uncertainty-in-scientific-funding">Embracing Risk and Uncertainty in Scientific Funding</h3>
<ul>
<li>The chapter argues that <strong>objectives can hinder scientific progress by promoting risk aversion</strong>.</li>
<li>Funding agencies often require researchers to clearly define objectives and demonstrate a high likelihood of success, which can discourage exploration of risky but potentially groundbreaking ideas.</li>
<li>The chapter suggests that <strong>some research should be pursued simply because it’s interesting</strong>, even if the potential outcomes are uncertain.</li>
<li>The chapter proposes funding researchers with a track record of interesting discoveries without requiring them to specify detailed objectives, similar to the MacArthur Fellowships.</li>
<li>The chapter acknowledges that <strong>risk is inherent in scientific research</strong>, and that embracing uncertainty is necessary for achieving significant progress.</li>
<li>The chapter draws a parallel between <strong>business investing and scientific funding</strong>.
<ul>
<li>In business, investors tend to favor projects with <strong>realistic, short-term objectives</strong> that are achievable within a few stepping stones.</li>
<li><strong>Innovative business ideas</strong> often reveal nearby stepping stones that were previously unseen, but investors typically require a clear understanding of these stepping stones before providing funding.</li>
</ul></li>
<li>The example of Tesla Motors is used to illustrate how <strong>innovation in business can arise from unexpected combinations of existing technologies</strong>.</li>
<li>The chapter concludes that both scientists and businesspeople should focus on exploring <strong>nearby stepping stones</strong> rather than setting overly ambitious long-term objectives.</li>
<li><strong>Innovation often arises from unexpected discoveries</strong> made while exploring seemingly unrelated paths.</li>
</ul>
</section>
<section id="the-role-of-objectives-in-art-and-design" class="level3">
<h3 class="anchored" data-anchor-id="the-role-of-objectives-in-art-and-design">The Role of Objectives in Art and Design</h3>
<ul>
<li>The chapter suggests that <strong>artists and designers</strong> have a more intuitive understanding of the myth of the objective compared to scientists or businesspeople.</li>
<li><strong>Art is often driven by creative exploration</strong> rather than the pursuit of specific objectives.</li>
<li>The chapter acknowledges that <strong>objectives can play a role in design</strong>, particularly when functionality and safety are concerned.
<ul>
<li>These objectives are compared to the <strong>constraints faced by organisms in natural evolution</strong>, which must survive and reproduce but can do so in a vast array of ways.</li>
</ul></li>
<li>The chapter argues that <strong>innovation in art and design often involves finding new ways to work within existing constraints</strong>.</li>
<li>Examples from art history, such as the evolution from Impressionism to Expressionism to Surrealism, are used to demonstrate how <strong>new artistic movements often arise unexpectedly</strong> from the exploration of previous styles.</li>
<li>The chapter highlights that <strong>individual artists may also struggle with the pressure to justify their work in terms of objectives</strong>.
<ul>
<li>The example of an art student who created sculptures by beating metal with an axe and rusting them is used to illustrate this point.</li>
</ul></li>
<li>The chapter concludes that <strong>art is valuable for its own sake</strong> and for the potential it has to inspire future creative explorations.</li>
</ul>
</section>
<section id="conclusion-embracing-non-objective-thinking-for-a-brighter-future" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-embracing-non-objective-thinking-for-a-brighter-future">Conclusion: Embracing Non-Objective Thinking for a Brighter Future</h3>
<ul>
<li>The chapter reiterates the <strong>pervasiveness of objective thinking</strong> in various aspects of our lives, from education and science to art and design.</li>
<li>The chapter emphasizes that <strong>non-objective thinking is not a universal solution</strong>, but rather an alternative approach that can lead to greater creativity and innovation in certain contexts.</li>
<li><strong>Escaping the myth of the objective</strong> can be challenging but potentially rewarding, as it allows for exploration of diverse and unpredictable paths.</li>
<li>The chapter encourages readers to <strong>consider the potential of non-objective thinking</strong> in their own lives and endeavors.</li>
<li>The chapter concludes with a call to <strong>embrace the uncertainty and freedom</strong> that comes with abandoning the rigid pursuit of predefined objectives.</li>
<li>The chapter suggests that <strong>non-objective thinking can help us move forward</strong> and achieve breakthroughs in various fields, acting as a stepping stone towards a brighter future.</li>
<li>The book concludes with two case studies exploring non-objective thinking in the context of natural evolution and AI research (found after the book’s main conclusion).</li>
</ul>
</section>
</section>
<section id="chapter-9-farewell-to-the-mirage" class="level2">
<h2 class="anchored" data-anchor-id="chapter-9-farewell-to-the-mirage">Chapter 9: Farewell to the Mirage</h2>
<section id="introduction-the-problem-with-objectives-1" class="level3">
<h3 class="anchored" data-anchor-id="introduction-the-problem-with-objectives-1">Introduction: The Problem with Objectives</h3>
<ul>
<li><strong>Objectives</strong>, especially ambitious ones, can hinder progress in various fields, from education to scientific research.
<ul>
<li>Overemphasis on objectives often leads to suboptimal outcomes.</li>
<li>Examples include stifling creativity in education and biasing funding decisions in science.</li>
</ul></li>
<li>This book challenges the conventional wisdom that objectives are essential for success, particularly in ambitious endeavors.</li>
<li>It proposes a <strong>non-objective perspective</strong>, suggesting that focusing on what we love and believe in can lead to more significant achievements.</li>
</ul>
</section>
<section id="beyond-objectives-embracing-a-new-perspective" class="level3">
<h3 class="anchored" data-anchor-id="beyond-objectives-embracing-a-new-perspective">Beyond Objectives: Embracing a New Perspective</h3>
<ul>
<li><strong>Ambitious objectives</strong> are the focus of this critique, not everyday objectives like following a recipe or meeting a project deadline.</li>
<li>The authors argue that objectives become less effective when we aim for breakthroughs, deep insights, or radical innovation in areas such as:
<ul>
<li>Scientific discoveries (e.g., cures for diseases)</li>
<li>Artistic creations (e.g., beautiful structures, soul-stirring melodies)</li>
<li>Technological advancements (e.g., travel beyond the stars)</li>
</ul></li>
<li>In these ambitious domains, objectives can become deceptive, hindering our potential.</li>
</ul>
</section>
<section id="the-stepping-stone-principle-a-paradoxical-approach-to-achievement" class="level3">
<h3 class="anchored" data-anchor-id="the-stepping-stone-principle-a-paradoxical-approach-to-achievement">The Stepping Stone Principle: A Paradoxical Approach to Achievement</h3>
<ul>
<li>The book proposes a <strong>paradoxical approach</strong>: We can achieve ambitious outcomes by <em>not</em> directly aiming for them.</li>
<li><strong>Evolution</strong> serves as a prime example:
<ul>
<li>It produced complex organisms without a predetermined objective.</li>
<li>Humans have created incredible machines without initially envisioning the final product.</li>
</ul></li>
<li>This approach involves <strong>conceding control of the final destination</strong> and focusing on the process of discovery.</li>
</ul>
</section>
<section id="the-illusion-of-control-objectives-as-deceptive-guides" class="level3">
<h3 class="anchored" data-anchor-id="the-illusion-of-control-objectives-as-deceptive-guides">The Illusion of Control: Objectives as Deceptive Guides</h3>
<ul>
<li><strong>Ambitious objectives often offer an illusion of control.</strong>
<ul>
<li>They may seem like a roadmap to success, but they can lead us down unproductive paths.</li>
<li>The complexity of the search space makes it impossible to predict the steps required for groundbreaking discoveries.</li>
</ul></li>
<li>Examples:
<ul>
<li>No breeder could have intentionally steered evolution from single-celled organisms to complex brains.</li>
<li>No Stone Age human could have conceived of a computer.</li>
</ul></li>
<li><strong>Conceding control of the destination is like discarding a faulty compass.</strong>
<ul>
<li>Great achievements often seem mysterious because there’s no clear, predictable path to them.</li>
<li>Objectives can become mere good luck charms, providing a false sense of direction.</li>
</ul></li>
</ul>
</section>
<section id="the-treasure-hunter-embracing-interestingness-and-novelty" class="level3">
<h3 class="anchored" data-anchor-id="the-treasure-hunter-embracing-interestingness-and-novelty">The Treasure Hunter: Embracing Interestingness and Novelty</h3>
<ul>
<li><strong>The alternative to objective-driven pursuit is to become a treasure hunter.</strong>
<ul>
<li>This involves exploring the unknown and seeking out valuable discoveries, even if they weren’t the initial target.</li>
<li><strong>Stepping stones</strong> are the key: One good idea leads to another, creating a chain of discoveries.</li>
</ul></li>
<li><strong>Clues</strong> guide the treasure hunter, but these clues are not about the objective itself. Instead, they indicate the potential for something worthwhile nearby.
<ul>
<li><strong>Novelty</strong> can be a clue: Something new may lead to something even newer.
<ul>
<li>Novelty search algorithms in robotics demonstrate this principle: Robots discover complex behaviors by pursuing novelty.</li>
</ul></li>
<li><strong>Interestingness</strong> is another crucial clue, particularly for humans:
<ul>
<li>We are drawn to things that pique our interest, whether it’s music, writing, or exploration.</li>
<li>Interestingness is subjective and varies among individuals, but this diversity benefits society.</li>
<li>Following interestingness leads us across unique chains of stepping stones.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="interestingness-a-principled-guide-in-the-unknown" class="level3">
<h3 class="anchored" data-anchor-id="interestingness-a-principled-guide-in-the-unknown">Interestingness: A Principled Guide in the Unknown</h3>
<ul>
<li><strong>Following interestingness</strong> may seem subjective, but it can be a more effective principle than objectivity, especially in the pursuit of discovery and innovation.</li>
<li>The book provides numerous examples where ignoring objectives led to superior results compared to pursuing them.</li>
<li><strong>Justification for following interestingness:</strong>
<ul>
<li>We don’t know the structure of the search space, so we can’t predict which discoveries will be crucial stepping stones.</li>
<li>Interestingness forms a network of interconnected discoveries, leading us from one valuable finding to another.</li>
</ul></li>
<li><strong>Objectives, in contrast, act as false beacons, limiting our exploration to a single, predetermined direction.</strong></li>
</ul>
</section>
<section id="the-innovators-mindset-focusing-on-the-edge-of-the-possible" class="level3">
<h3 class="anchored" data-anchor-id="the-innovators-mindset-focusing-on-the-edge-of-the-possible">The Innovator’s Mindset: Focusing on the Edge of the Possible</h3>
<ul>
<li>True innovators don’t focus on distant, grandiose visions. Instead, they concentrate on the <strong>edge of what’s currently possible</strong>.</li>
<li>They ask: “Where can we get from here?” rather than “How can we get there?”</li>
<li>They build upon existing capabilities and knowledge, taking small but significant steps forward.</li>
<li><strong>Examples:</strong>
<ul>
<li><strong>Markus “Notch” Persson</strong> created Minecraft by combining elements from existing games, resulting in a groundbreaking success despite its unconventional design.</li>
<li><strong>Steve Jobs</strong> and Apple recognized the opportune moment for a commercially viable tablet computer (the iPad), capitalizing on existing technological advancements and societal trends.</li>
<li><strong>The Wright brothers</strong> built upon their expertise in bicycles to achieve flight, demonstrating that stepping stones can come from unexpected sources.</li>
</ul></li>
<li><strong>Objective-driven companies</strong> often struggle, clinging to ambitious visions that are not yet feasible.</li>
<li><strong>Success often comes from recognizing the potential in the present</strong>, rather than trying to force a preconceived future into existence.</li>
</ul>
</section>
<section id="embracing-divergence-letting-go-of-the-right-path" class="level3">
<h3 class="anchored" data-anchor-id="embracing-divergence-letting-go-of-the-right-path">Embracing Divergence: Letting Go of the “Right Path”</h3>
<ul>
<li><strong>Letting go of objectives also means abandoning the idea of a single “right path.”</strong></li>
<li>Instead of judging projects based on their likelihood of achieving a specific objective, we should assess their <strong>potential to spawn new projects, new stepping stones.</strong></li>
<li><strong>The value of a stepping stone lies in its ability to lead to further exploration, regardless of its immediate outcome.</strong></li>
<li><strong>Divergence is a virtue:</strong>
<ul>
<li>Different people pursuing different paths lead to a greater diversity of discoveries.</li>
<li>Consensus can stifle innovation by limiting the exploration of alternative approaches.</li>
</ul></li>
<li><strong>The world is too complex to know with certainty which path is “right” in the long run.</strong></li>
<li><strong>Embracing diverse paths allows for a wider range of possibilities to be explored.</strong></li>
</ul>
</section>
<section id="following-your-instinct-the-power-of-interestingness" class="level3">
<h3 class="anchored" data-anchor-id="following-your-instinct-the-power-of-interestingness">Following Your Instinct: The Power of Interestingness</h3>
<ul>
<li><strong>To escape the myth of the objective, do things because they’re interesting.</strong></li>
<li><strong>Trust your gut feelings:</strong> If you feel drawn to a particular direction, explore it, even if you don’t have a clear objective.</li>
<li><strong>Don’t be afraid to deviate from your initial plans:</strong>
<ul>
<li>If you’ve shifted from computer programming to filmmaking, or from AI research to art, you might be on the right track.</li>
<li><strong>Stepping stones lead to unexpected and potentially valuable destinations.</strong></li>
</ul></li>
<li><strong>Great achievements often arise from chains of innovation that weren’t initially planned.</strong></li>
</ul>
</section>
<section id="conclusion-abandoning-objectives-to-achieve-greatness" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-abandoning-objectives-to-achieve-greatness">Conclusion: Abandoning Objectives to Achieve Greatness</h3>
<ul>
<li><strong>The prevailing culture often prioritizes objectives and chains exploration to them.</strong></li>
<li><strong>However, evidence suggests that a treasure-hunting approach, guided by interestingness and novelty, is more effective for achieving breakthroughs.</strong></li>
<li><strong>We should encourage divergence and allow people to pursue different paths, even if they seem unconventional or “wrong.”</strong></li>
<li><strong>Ultimately, to achieve our highest goals, we must be willing to abandon them temporarily and embrace the unpredictable journey of exploration.</strong></li>
<li><strong>By following the scent of interestingness, we can unlock our potential and contribute to a future filled with unexpected and valuable discoveries.</strong></li>
</ul>
</section>
</section>
<section id="chapter-10-case-study-1---reinterpreting-natural-evolution" class="level2">
<h2 class="anchored" data-anchor-id="chapter-10-case-study-1---reinterpreting-natural-evolution">Chapter 10: Case Study 1 - Reinterpreting Natural Evolution</h2>
<section id="introduction-1" class="level3">
<h3 class="anchored" data-anchor-id="introduction-1">Introduction</h3>
<ul>
<li>Every living organism, including humans, is a product of <strong>natural evolution</strong>.</li>
<li><strong>Natural evolution</strong> is an unguided process that has designed every organism on Earth.</li>
<li>Unlike most things, evolution continually creates new from old.</li>
<li><strong>Intelligent design</strong> movement skeptics argue that the complexity of life suggests an intelligent creator.</li>
<li>Charles Darwin’s theory of <strong>natural selection</strong> offers an alternative explanation: slightly imperfect self-copying can lead to the appearance of intelligent design.</li>
<li><strong>Natural selection:</strong> Genes that enhance survival and reproduction are more likely to spread throughout a population.</li>
<li>Evolutionary biologists debate the importance of <strong>natural selection</strong> compared to other evolutionary forces (e.g., chance, history).</li>
<li>This chapter explores an alternative interpretation of <strong>natural evolution</strong> inspired by <strong>non-objective search</strong>.</li>
</ul>
</section>
<section id="common-interpretations-of-evolution" class="level3">
<h3 class="anchored" data-anchor-id="common-interpretations-of-evolution">Common Interpretations of Evolution</h3>
<section id="survival-of-the-fittest" class="level4">
<h4 class="anchored" data-anchor-id="survival-of-the-fittest">Survival of the Fittest</h4>
<ul>
<li>“Survival of the fittest” is a popular catchphrase summarizing a core concept of evolution, though it wasn’t coined by Darwin himself.</li>
<li><strong>Fitness</strong>, in biology, refers to the average number of offspring an organism produces.</li>
<li>“Survival of the fittest” implies a <strong>competitive search</strong> for ever-more-fit organisms.</li>
<li>This perspective aligns with <strong>objective thinking</strong>, suggesting that evolution aims to achieve the objective of maximizing fitness.</li>
</ul>
</section>
<section id="evolution-as-a-progressive-force" class="level4">
<h4 class="anchored" data-anchor-id="evolution-as-a-progressive-force">Evolution as a Progressive Force</h4>
<ul>
<li>“Survival of the fittest” can lead to the view of evolution as a <strong>bloody competition</strong> where only the fittest survive.</li>
<li>Early evolutionists believed that evolution is <strong>progressive</strong>, striving for an <strong>objective perfection</strong> or an <strong>über-organism</strong>.</li>
<li>Some interpretations place humans as the pinnacle of evolution, suggesting objective superiority over other organisms.</li>
<li>However, a <strong>human-centric view</strong> is not supported by modern biology and leads to the <strong>objective paradox</strong>.
<ul>
<li>If evolution aimed directly at humans, the intermediate steps (e.g., flatworms) wouldn’t resemble the final product, making the path implausible.</li>
</ul></li>
</ul>
</section>
<section id="survival-and-reproduction-as-the-objective" class="level4">
<h4 class="anchored" data-anchor-id="survival-and-reproduction-as-the-objective">Survival and Reproduction as the Objective</h4>
<ul>
<li>Most scientists consider <strong>survival and reproduction</strong> as evolution’s objective.</li>
<li>All living species inherently survive and reproduce; otherwise, they wouldn’t exist.</li>
<li><strong>Natural selection</strong> drives towards improved survival and reproduction, leading to the view that increasing fitness is evolution’s objective.</li>
<li>This perspective fits the <strong>objective paradigm</strong> and aligns with common understanding.</li>
<li>However, this interpretation faces some challenges:
<ul>
<li><strong>Survive and reproduce</strong> was already achieved at the start of evolution with the first reproducing cell, contradicting the typical notion of an objective as something to be achieved.</li>
<li>If the objective is to maximize fitness, bacteria (with high reproductive rates) would be considered more “successful” than humans, which doesn’t align with our intuition about evolution’s most interesting products.</li>
<li>The diversity of life suggests an <strong>accumulation of stepping stones</strong>, similar to other <strong>non-objective creative processes</strong> (e.g., Picbreeder, human innovation).</li>
</ul></li>
</ul>
</section>
</section>
<section id="a-non-objective-interpretation-of-evolution" class="level3">
<h3 class="anchored" data-anchor-id="a-non-objective-interpretation-of-evolution">A Non-Objective Interpretation of Evolution</h3>
<section id="survive-and-reproduce-as-a-constraint" class="level4">
<h4 class="anchored" data-anchor-id="survive-and-reproduce-as-a-constraint">Survive and Reproduce as a Constraint</h4>
<ul>
<li>Instead of an objective, <strong>survive and reproduce</strong> can be viewed as a <strong>constraint</strong>.</li>
<li>Organisms that fail to reproduce are eliminated, while those that reproduce persist.</li>
<li>This perspective suggests that selection <strong>restricts exploration</strong> by pruning away parts of the search space.</li>
</ul>
</section>
<section id="gentle-earth-thought-experiment" class="level4">
<h4 class="anchored" data-anchor-id="gentle-earth-thought-experiment">Gentle Earth Thought Experiment</h4>
<ul>
<li>Imagine <strong>Gentle Earth</strong>: a hypothetical world without natural selection where every organism reproduces.</li>
<li>Even organisms that wouldn’t survive on their own are helped to reproduce.</li>
<li>This removes the pressure of selection and allows for broader exploration of the search space.</li>
<li>On Gentle Earth, we would observe all the variety of life on Earth, plus many more organisms that wouldn’t have survived under selection.</li>
<li>This thought experiment demonstrates that selection is not a creative force, but rather a <strong>restrictive force</strong> that limits exploration.</li>
</ul>
</section>
<section id="evolution-as-a-treasure-hunter" class="level4">
<h4 class="anchored" data-anchor-id="evolution-as-a-treasure-hunter">Evolution as a Treasure Hunter</h4>
<ul>
<li>Evolution accumulates <strong>novelty and diversity</strong>, similar to other <strong>non-objective search processes</strong>.</li>
<li>The <strong>tree of life</strong> branches outward, collecting new stepping stones as it goes.</li>
<li><strong>Diversity arises from avoiding competition</strong> by founding new niches.</li>
<li>New niches often make founding newer niches possible, leading to a chain reaction of diversification.</li>
<li>Examples:
<ul>
<li>An organism developing the ability to digest a new compound.</li>
<li>The first land animal to fly escaping land-based predation.</li>
<li>The invention of the computer enabling the ecosystem of software.</li>
<li>The discovery of grass providing a platform for herbivores and their associated ecosystems.</li>
</ul></li>
</ul>
</section>
<section id="serendipity-and-exaptation" class="level4">
<h4 class="anchored" data-anchor-id="serendipity-and-exaptation">Serendipity and Exaptation</h4>
<ul>
<li><strong>Serendipity</strong> plays a significant role in evolution through <strong>mutation</strong>.</li>
<li><strong>Mutation:</strong> Slight copying errors during reproduction that can lead to variations in offspring.</li>
<li><strong>Neutral genetic changes</strong> (not affecting fitness) evolve through <strong>genetic drift</strong>.</li>
<li><strong>Exaptation:</strong> A feature evolved for one function becomes useful in a different context.</li>
<li>Examples:
<ul>
<li>Birds’ feathers initially evolved for temperature regulation, later exapted for flight.</li>
<li>Bones initially evolved for mineral storage, later exapted for structural support.</li>
<li>The Picbreeder Car’s wheels exapted from the eyes of the Alien Face.</li>
<li>The vacuum tube exapted from early electrical investigations to enable computation.</li>
</ul></li>
</ul>
</section>
</section>
<section id="abstraction-and-interpretation" class="level3">
<h3 class="anchored" data-anchor-id="abstraction-and-interpretation">Abstraction and Interpretation</h3>
<section id="evolution-as-a-minimal-criteria-search" class="level4">
<h4 class="anchored" data-anchor-id="evolution-as-a-minimal-criteria-search">Evolution as a Minimal Criteria Search</h4>
<ul>
<li><strong>Abstraction</strong> helps to understand natural processes by focusing on essential features and discarding unimportant details.</li>
<li>Viewing “survive and reproduce” as a <strong>constraint</strong> allows us to abstract away fitness differences between successful organisms.</li>
<li>The <strong>single-cell bottleneck</strong> highlights the diversity of methods nature has found to start from one cell and ultimately produce another.</li>
<li>Organisms can be seen as <strong>Rube Goldberg machines</strong>, performing complex processes to achieve the simple goal of reproduction.</li>
<li>Evolution can be viewed as a <strong>minimal criteria search</strong>, accumulating all the different ways to survive and reproduce.</li>
<li>As simple means of living are exhausted, the search explores more complex ones, driven by the “spill” of possibilities expanding in the search space.</li>
<li><strong>Minimal Criteria Novelty Search:</strong> An algorithm inspired by this perspective, demonstrating the practical implications of the abstraction.</li>
</ul>
</section>
<section id="the-role-of-competition" class="level4">
<h4 class="anchored" data-anchor-id="the-role-of-competition">The Role of Competition</h4>
<ul>
<li>The <strong>spilled-milk view</strong> abstracts away competition entirely.</li>
<li>However, <strong>competition</strong> does play a role in natural evolution, though it may be less important for creativity than <strong>diversity</strong>.</li>
<li><strong>Local competition</strong> (within niches) shapes organisms but encourages the founding of new niches to escape competition.</li>
<li><strong>Global competition</strong> (across all organisms) would lead to convergence towards a single optimal organism.</li>
<li><strong>Evolution can be seen as a novelty-generating search with local competition</strong>, balancing creativity and optimization.</li>
<li><strong>Novelty Search with Local Competition:</strong> Another algorithm formalizing this abstraction, demonstrating its ability to generate diverse virtual creatures.</li>
</ul>
</section>
</section>
<section id="the-fossil-record-and-non-objective-evolution" class="level3">
<h3 class="anchored" data-anchor-id="the-fossil-record-and-non-objective-evolution">The Fossil Record and Non-Objective Evolution</h3>
<ul>
<li>Evolution’s successes result from its <strong>mindless accumulation of stepping stones</strong>, not from planning or intelligence.</li>
<li>The <strong>tree of life</strong> branches outward, reflecting the exploration of diverse niches without a specific objective.</li>
<li>The fossil record shows a constant branching and diversification, with the earliest life forms (bacteria) still persisting today.</li>
<li>The <strong>Cambrian explosion</strong> represents a period of rapid diversification, similar to the early stages of other creative processes.</li>
<li>The fossil record can be seen as a testament to the power of <strong>non-objective search</strong> and <strong>serendipity</strong>.</li>
</ul>
</section>
<section id="conclusion-2" class="level3">
<h3 class="anchored" data-anchor-id="conclusion-2">Conclusion</h3>
<ul>
<li>Evolution’s creativity arises from <strong>escaping competition</strong> to form new niches, not just from out-competing others.</li>
<li><strong>Diversity</strong> and the <strong>accumulation of stepping stones</strong> are key to evolution’s success.</li>
<li>Evolution is more like <strong>open-ended brainstorming</strong> than single-minded pursuit of a goal.</li>
<li>It’s more about <strong>exploration</strong> than about <strong>bloody competition</strong>.</li>
<li>It’s more like constructing novel <strong>Rube Goldberg machines</strong> than aspiring towards perfection.</li>
<li>Evolution is the ultimate <strong>treasure hunter</strong>, searching for nothing and finding everything as it explores the space of possible organisms.</li>
<li>It’s the world’s most prolific inventor, achieving its discoveries without pre-defined objectives.</li>
<li>This <strong>non-objective perspective</strong> offers a deeper understanding of evolution’s creative power, challenging the myth of the objective.</li>
</ul>
</section>
</section>
<section id="chapter-11-case-study-2---objectives-and-the-quest-for-ai" class="level2">
<h2 class="anchored" data-anchor-id="chapter-11-case-study-2---objectives-and-the-quest-for-ai">Chapter 11: Case Study 2 - Objectives and the Quest for AI</h2>
<section id="introduction-science-objectives-and-the-ai-community" class="level3">
<h3 class="anchored" data-anchor-id="introduction-science-objectives-and-the-ai-community">Introduction: Science, Objectives, and the AI Community</h3>
<ul>
<li><strong>Science</strong> is a search for knowledge, expanding possibilities and shaping the quality of our lives.</li>
<li>Scientific progress is influenced by how scientists communicate and interact, particularly within specialized communities called <strong>disciplines</strong>.</li>
<li><strong>Objectives</strong>, while useful for measurement and encouragement, can introduce risks and unintended consequences in the scientific process.</li>
<li>The <strong>Artificial Intelligence (AI) community</strong> serves as a case study for examining the impact of objective-driven thinking on science due to its ambitious objective of creating highly intelligent machines.</li>
<li>The AI community’s focus on this objective allows us to analyze the effects of objective thinking in a field where it’s particularly prominent.</li>
<li>Understanding the role of objectives in AI research provides insights into how objectives affect decision-making in broader contexts, including other scientific fields and society.</li>
</ul>
</section>
<section id="the-ai-community-a-search-for-algorithms" class="level3">
<h3 class="anchored" data-anchor-id="the-ai-community-a-search-for-algorithms">The AI Community: A Search for Algorithms</h3>
<ul>
<li><strong>Algorithms</strong> are the core product of AI research.
<ul>
<li>AI algorithms are designed to perform a wide range of tasks, from object recognition to game playing.</li>
<li>The ultimate goal is a single algorithm capable of performing all human (and potentially more) tasks.</li>
</ul></li>
<li>The field of AI can be viewed as a <strong>search for algorithms</strong>.
<ul>
<li>Researchers work together to find new and improved algorithms.</li>
<li>AI researchers also study how to search effectively, creating algorithms that automate search processes.</li>
</ul></li>
<li>This creates a <strong>meta-search</strong>, where AI researchers search for algorithms that themselves search.
<ul>
<li>This is analogous to searching for a curious puppy or hiring a skilled treasure hunter.</li>
</ul></li>
<li>The connection between the AI community’s meta-search and the insights from search algorithms is rarely discussed.
<ul>
<li>While research analyzes search at the algorithm level, the AI community’s own search for algorithms is less examined.</li>
</ul></li>
<li>The question arises whether AI researchers, experts in search, are immune to the pitfalls of objective-driven search or if they are also susceptible to its deceptive nature.</li>
</ul>
</section>
<section id="gradients-and-heuristics-in-ai-research" class="level3">
<h3 class="anchored" data-anchor-id="gradients-and-heuristics-in-ai-research">Gradients and Heuristics in AI Research</h3>
<ul>
<li>AI researchers use <strong>heuristics</strong> (rules of thumb) to guide their search for promising algorithms.</li>
<li>Two main heuristics dominate AI research:
<ul>
<li><strong>Experimentalist Heuristic:</strong> Judges algorithms based on their performance in benchmark tasks. Better performance indicates a more promising algorithm.</li>
<li><strong>Theoretical Heuristic:</strong> Favors algorithms that have desirable properties proven through mathematical guarantees.</li>
</ul></li>
<li>These heuristics act as <strong>gatekeepers</strong> in the AI community, influencing which ideas are published and explored further.</li>
<li>The widespread acceptance of these heuristics shapes the direction of AI research and can lead to unintended consequences.</li>
</ul>
</section>
<section id="problems-with-the-experimentalist-heuristic" class="level3">
<h3 class="anchored" data-anchor-id="problems-with-the-experimentalist-heuristic">Problems with the Experimentalist Heuristic</h3>
<ul>
<li>The experimentalist heuristic can lead to <strong>deception</strong>: Algorithms that appear promising based on performance may not lead to further advancements.</li>
<li>Focusing solely on performance can <strong>stifle exploration</strong> and prevent the discovery of novel algorithms that may not initially outperform existing ones.</li>
<li><strong>Example: Algorithm “Weird”</strong>
<ul>
<li>Weird is a novel algorithm that performs 5% worse than the established algorithm “OldReliable” in a standard benchmark.</li>
<li>The experimentalist heuristic would favor rejecting Weird due to its lower performance.</li>
<li>However, rejecting Weird prevents the exploration of its unique potential and the stepping stones it could open up.</li>
</ul></li>
<li>The experimentalist heuristic can be likened to a <strong>Chinese finger trap</strong>, encouraging pulling harder (improving performance) when pushing (exploring novel, even if initially worse-performing, directions) might be necessary.</li>
<li><strong>Comparisons between algorithms can be misleading</strong>: The reasons for finding an algorithm interesting may be unrelated to its performance compared to others.
<ul>
<li><strong>Example: Humanoid Robot vs.&nbsp;Windup Toy Footrace</strong>
<ul>
<li>The windup toy wins easily, but this doesn’t invalidate humanoid robot research.</li>
<li>The comparison is irrelevant to the reasons for finding humanoid robots interesting.</li>
</ul></li>
</ul></li>
<li>The experimentalist heuristic may be suitable for <strong>AI practitioners</strong> who need to choose the best currently available algorithm for a specific task.</li>
<li>However, it is not ideal for <strong>AI researchers</strong> who are searching for future innovations and breakthroughs.</li>
<li>The experimentalist heuristic promotes an <strong>objective-driven search</strong> for perfect performance, which can be counterproductive in complex search spaces like the space of AI algorithms.</li>
</ul>
</section>
<section id="problems-with-the-theoretical-heuristic" class="level3">
<h3 class="anchored" data-anchor-id="problems-with-the-theoretical-heuristic">Problems with the Theoretical Heuristic</h3>
<ul>
<li>The <strong>theoretical heuristic</strong> prioritizes algorithms with strong theoretical guarantees.</li>
<li>While guarantees provide certainty, the theoretical heuristic also has limitations.</li>
<li><strong>“Theoretical Heuristic” as a Paradox:</strong>
<ul>
<li>Heuristics are rules of thumb, while theorems offer absolute guarantees.</li>
<li>The term “theoretical heuristic” refers to using theorems (theoretical) as a rule of thumb (heuristic) for judging an algorithm’s potential as a stepping stone.</li>
</ul></li>
<li><strong>Theorems about individual algorithms do not guarantee progress in the meta-search</strong>:
<ul>
<li>A theorem about algorithm OldReliable doesn’t guarantee that future algorithms derived from it will inherit the same guarantees or be better.</li>
<li>Focusing solely on algorithms with proven guarantees can restrict exploration and prevent the discovery of novel algorithms that may not initially have strong theoretical backing.</li>
</ul></li>
<li>The theoretical heuristic assumes a specific structure of the search space, where more guarantees indicate closer proximity to AI objectives.
<ul>
<li>This assumption may not hold true in the vast and complex space of AI algorithms.</li>
</ul></li>
<li><strong>Waiting for guarantees can hinder progress</strong>:
<ul>
<li>If algorithm Weird lacks guarantees but has the potential to lead to an interesting algorithm Weirder, waiting for Weird’s guarantees delays or prevents the discovery of Weirder.</li>
</ul></li>
<li><strong>Natural Evolution as a Counterexample</strong>:
<ul>
<li>Evolution produced human intelligence without proving any theorems.</li>
<li>This demonstrates that guarantees are not a necessity for achieving complex outcomes.</li>
</ul></li>
<li>The theoretical heuristic, like the experimentalist heuristic, fosters an <strong>objective-driven search</strong> within the space of AI algorithms, which may not be the most effective approach.</li>
</ul>
</section>
<section id="the-iron-yardsticks-and-their-consequences" class="level3">
<h3 class="anchored" data-anchor-id="the-iron-yardsticks-and-their-consequences">The Iron Yardsticks and Their Consequences</h3>
<ul>
<li>The experimentalist and theoretical heuristics act as <strong>iron yardsticks</strong> wielded by gatekeepers in the AI community.</li>
<li>They heavily influence which ideas are shared and explored, limiting the search to algorithms that satisfy these heuristics.</li>
<li>These heuristics can hinder discovery and progress by:
<ul>
<li><strong>Pruning away large parts of the search space</strong>: Algorithms that don’t meet the heuristics are ignored, preventing the exploration of their potential and the stepping stones beyond them.</li>
<li><strong>Fostering a competitive environment</strong>: Researchers focus on outperforming each other in benchmarks rather than collaborating to explore the space of algorithms.</li>
<li><strong>Shifting the focus away from the substance of ideas</strong>: Discussions revolve around performance and guarantees instead of exploring the intrinsic value and potential of new algorithms.</li>
</ul></li>
</ul>
</section>
<section id="rethinking-good-ai-algorithms-and-a-non-objective-approach" class="level3">
<h3 class="anchored" data-anchor-id="rethinking-good-ai-algorithms-and-a-non-objective-approach">Rethinking “Good” AI Algorithms and a Non-Objective Approach</h3>
<ul>
<li><strong>A “good” AI algorithm should be judged by its potential to inspire new algorithms and research directions</strong>, not solely by its performance.</li>
<li>The AI community’s obsession with performance improvements often leads to incremental advancements that lack significant insights.</li>
<li><strong>Algorithms should be evaluated as stepping stones</strong>: The focus should be on whether an algorithm leads to new and interesting algorithms, regardless of its initial performance.</li>
<li><strong>Picbreeder as an Example</strong>:
<ul>
<li>The Picbreeder community successfully finds complex and meaningful images without relying on objective rules, expert panels, or performance comparisons.</li>
<li>This demonstrates that communities can achieve significant results without rigid objective heuristics.</li>
</ul></li>
<li><strong>The Role of Experts</strong>:
<ul>
<li>Expertise is crucial in evaluating new ideas, but objective heuristics should not replace expert judgment.</li>
<li>Experts should be trusted to use their knowledge and intuition to assess the potential of new algorithms, even if they don’t meet traditional performance or theoretical standards.</li>
</ul></li>
<li><strong>The Journal of AI Discovery (JAID) Thought Experiment</strong>:
<ul>
<li>JAID is a hypothetical journal where reviewers are not allowed to consider experimental or theoretical results in their reviews.</li>
<li>This forces reviewers to engage with the core ideas of an algorithm and judge its potential as a stepping stone based on its intrinsic value.</li>
<li>The success or failure of JAID would reveal insights about the effectiveness of current heuristics and the role of expert judgment in AI research.</li>
</ul></li>
</ul>
</section>
<section id="embracing-non-objective-clues-and-the-importance-of-open-mindedness" class="level3">
<h3 class="anchored" data-anchor-id="embracing-non-objective-clues-and-the-importance-of-open-mindedness">Embracing Non-Objective Clues and the Importance of Open-mindedness</h3>
<ul>
<li>Relying solely on objective heuristics can hinder the discovery of truly groundbreaking ideas.</li>
<li><strong>Non-objective clues</strong> can provide valuable insights into an algorithm’s potential:
<ul>
<li>Inspiration, elegance, potential to provoke creativity, thought-provoking construction, challenge to the status quo, novelty, analogy to nature, beauty, simplicity, and imagination.</li>
</ul></li>
<li><strong>Experts should embrace open-mindedness and consider a broader range of factors when evaluating new ideas</strong>:
<ul>
<li>It’s more challenging to deeply consider an idea’s potential than to rely on simple heuristics.</li>
<li>However, this effort is crucial for fostering innovation and progress in AI research.</li>
</ul></li>
<li><strong>Science cannot rely on a fixed method for discovering great ideas</strong>:
<ul>
<li>The most significant advancements often come from unexpected sources and don’t necessarily follow predictable paths.</li>
<li>Open-mindedness and a willingness to explore unconventional ideas are essential for scientific progress.</li>
</ul></li>
<li><strong>Conclusion</strong>:
<ul>
<li>The AI community, and scientific communities in general, should move beyond rigid objective heuristics and embrace a more open-minded approach to evaluating new ideas, focusing on their potential to inspire further creativity and lead to unforeseen discoveries.<br>
</li>
<li>This shift requires trusting experts to use their judgment and considering a broader range of factors beyond performance and guarantees, ultimately fostering a more fruitful and innovative scientific landscape.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>book</category>
  <category>notes</category>
  <category>personal-growth</category>
  <category>professional-growth</category>
  <category>ai</category>
  <guid>https://christianjmills.com/posts/why-greatness-cannot-be-planned-book-notes/</guid>
  <pubDate>Sun, 01 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>CUDA MODE Lecture 5: Going Further with CUDA for Python Programmers</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/lecture-005/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<ul>
<li>Introduction and Overview</li>
<li>Resources and Setup</li>
<li>Matrix Multiplication Example<br>
</li>
<li>Optimizing with Shared Memory<br>
</li>
<li>Implementing Tiling with Numba</li>
<li>Q&amp;A Session</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Resource Links:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Resource Links:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube Recording:</strong> <a href="https://www.youtube.com/watch?v=wVsR-YhaHlM">Lecture 5: Going Further with CUDA for Python Programmers</a></li>
<li><strong>Jupyter Notebook:</strong> <a href="https://github.com/cuda-mode/lectures/blob/main/lecture_005/matmul_l5.ipynb">lecture_005/matmul_l5.ipynb</a></li>
<li><strong>utils.py:</strong> <a href="https://github.com/cuda-mode/lectures/blob/main/utils.py">utils.py</a></li>
</ul>
</div>
</div>
<section id="introduction-and-overview" class="level2">
<h2 class="anchored" data-anchor-id="introduction-and-overview">Introduction and Overview</h2>
<ul>
<li><strong>Going Further with CUDA for Python Programmers:</strong> This lecture builds upon the foundational knowledge presented in “<a href="https://www.youtube.com/watch?v=4sgKnKbR-WE">Getting Started with CUDA for Python Programmers</a>” and focuses on optimizing CUDA code for performance by leveraging fast memory.</li>
<li><strong>Prerequisites:</strong> Familiarity with basic CUDA concepts and Python programming, including thread utilization.</li>
<li><strong>Recommended Resources:</strong>
<ul>
<li>“<a href="https://www.amazon.com/Programming-Massively-Parallel-Processors-Hands/dp/0323912311/">Programming Massively Parallel Processes</a>” (book), Chapter 5.</li>
<li><a href="https://www.youtube.com/watch?v=lTmYrKwjSOU">CUDA Mode lecture by Thomas Viehmann</a> (covers Chapter 4 &amp; 5).</li>
</ul></li>
<li><strong>Lecture Focus:</strong> Utilizing <strong>shared memory</strong>, a faster memory type within the GPU, to improve performance.</li>
<li><strong>Memory Hierarchy:</strong>
<ul>
<li><strong>Global Memory:</strong> Default memory used in CUDA, relatively fast but not the fastest.
<ul>
<li>Accessed by all threads.</li>
<li>(e.g., with <code>tensor.cuda()</code> in PyTorch)</li>
</ul></li>
<li><strong>Shared Memory:</strong> Significantly faster than global memory (about 10x).
<ul>
<li>Accessible only by threads within a specific <strong>block</strong> (on a streaming multiprocessor).</li>
</ul></li>
</ul></li>
<li><strong>Importance of Memory Access Speed:</strong> Due to the high processing speed of GPUs, memory access becomes a performance bottleneck. Utilizing shared memory effectively is crucial for optimization.</li>
</ul>
</section>
<section id="resources-and-setup" class="level2">
<h2 class="anchored" data-anchor-id="resources-and-setup">Resources and Setup</h2>
<ul>
<li><p><strong>Repository:</strong> CUDA Mode lectures repository, specifically lecture 5 notebook.</p>
<ul>
<li><strong>GitHub Repository:</strong> <a href="https://github.com/cuda-mode/lectures">https://github.com/cuda-mode/lectures</a></li>
</ul></li>
<li><p><strong><a href="https://github.com/cuda-mode/lectures/blob/main/utils.py">utils.py</a>:</strong> Contains helper functions (e.g., ceiling division, CUDA code loading, prefix for CUDA code).</p></li>
<li><p><strong><code>dim3</code>:</strong> Python namedtuple representing a 3D grid (x, y, z) for blocks and threads, mirroring CUDA’s Dim3 structure.</p></li>
<li><p><strong>Debugging Tools:</strong> Wurlitzer for printing from CUDA kernels, CUDA launch blocking for debugging.</p></li>
<li><p><strong>Setup Code:</strong></p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Operating system interfaces</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mathematical functions</span></span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># System-specific parameters and functions</span></span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PyTorch library for tensor computations and neural networks</span></span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regular expression operations</span></span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NumPy library for numerical computations</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> types <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SimpleNamespace <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ns  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Allows creation of attribute-accessible objects</span></span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> namedtuple  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Factory function for creating tuple subclasses with named fields</span></span></code></pre></div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a custom 3D dimension namedtuple with default values</span></span>
<span id="cb2-2">dim3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> namedtuple(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dim3'</span>, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'z'</span>], defaults<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a 2D dimension instance</span></span>
<span id="cb3-2">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the full dimension object</span></span>
<span id="cb3-5">d</span></code></pre></div>
<pre class="text"><code>dim3(x=2, y=3, z=1)</code></pre>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display x and y components of the dimension</span></span>
<span id="cb5-2">d.x, d.y</span></code></pre></div>
<pre class="text"><code>(2, 3)</code></pre>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure NumPy print options for cleaner output</span></span>
<span id="cb7-2">np.set_printoptions(precision<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure PyTorch print options for cleaner output and disable scientific notation</span></span>
<span id="cb7-5">torch.set_printoptions(precision<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>, sci_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Import utility functions</span></span>
<span id="cb8-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> show_img, load_cuda, cuda_begin, cdiv</span></code></pre></div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the wurlitzer IPython extension for capturing C-level output</span></span>
<span id="cb9-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext wurlitzer</span></code></pre></div>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set a random seed for reproducibility</span></span>
<span id="cb10-2">torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span></code></pre></div>
<pre class="text"><code>&lt;torch._C.Generator at 0x728ffff23630&gt;</code></pre></li>
</ul>
</section>
<section id="matrix-multiplication-example" class="level2">
<h2 class="anchored" data-anchor-id="matrix-multiplication-example">Matrix Multiplication Example</h2>
<ul>
<li><p><strong>Problem:</strong> Multiplying a 5120x256 matrix (M1) by a 256x5120 matrix (M2).</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a large random tensor (5120x256)</span></span>
<span id="cb12-2">m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5120</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the first 4 rows of m1</span></span>
<span id="cb12-5">m1s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m1[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb12-6"></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create another large random tensor (256x5120)</span></span>
<span id="cb12-8">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5120</span>)</span>
<span id="cb12-9"></span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the first 4 columns of m2</span></span>
<span id="cb12-11">m2s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2[:, :<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span></code></pre></div></li>
</ul>
<section id="previous-approaches-recap" class="level3">
<h3 class="anchored" data-anchor-id="previous-approaches-recap">Previous Approaches (Recap)</h3>
<ul>
<li><p><strong>Naive Matrix Multiplication Kernel:</strong></p>
<ul>
<li>Calculates dot product for each element in the output matrix.</li>
<li>Accesses global memory repeatedly within the inner loop, leading to performance issues.</li>
</ul></li>
<li><p><strong>Pure Python Baseline:</strong> Extremely slow, uses a small sample of the matrices (4x4) for demonstration.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> blk_kernel2d(f, blocks, threads, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args):</span>
<span id="cb13-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Simulate a 2D GPU kernel execution on CPU.</span></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function emulates the behavior of a 2D GPU kernel by iterating over</span></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    blocks and threads in a nested loop structure.</span></span>
<span id="cb13-7"></span>
<span id="cb13-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        f (function): The kernel function to be executed.</span></span>
<span id="cb13-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blocks (dim3): The number of blocks in x and y dimensions.</span></span>
<span id="cb13-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threads (dim3): The number of threads per block in x and y dimensions.</span></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        *args: Additional arguments to be passed to the kernel function.</span></span>
<span id="cb13-13"></span>
<span id="cb13-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb13-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        None</span></span>
<span id="cb13-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb13-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i0 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks.y):</span>
<span id="cb13-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks.x):</span>
<span id="cb13-19">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j0 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(threads.y):</span>
<span id="cb13-20">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(threads.x):</span>
<span id="cb13-21">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Execute the kernel function for each thread</span></span>
<span id="cb13-22">                    f(dim3(i1,i0), dim3(j1,j0), threads, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args)</span></code></pre></div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_bk(blockIdx, threadIdx, blockDim, m, n, out, h, w, k):</span>
<span id="cb14-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform matrix multiplication for a single element in the output matrix.</span></span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function calculates one element of the output matrix by multiplying</span></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    a row from the first matrix with a column from the second matrix.</span></span>
<span id="cb14-7"></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockIdx (dim3): The current block index.</span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threadIdx (dim3): The current thread index within the block.</span></span>
<span id="cb14-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockDim (dim3): The dimensions of the block.</span></span>
<span id="cb14-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (Tensor): Flattened first input matrix.</span></span>
<span id="cb14-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (Tensor): Flattened second input matrix.</span></span>
<span id="cb14-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out (Tensor): Flattened output matrix.</span></span>
<span id="cb14-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        h (int): Height of the output matrix.</span></span>
<span id="cb14-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        w (int): Width of the output matrix.</span></span>
<span id="cb14-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        k (int): Common dimension of input matrices.</span></span>
<span id="cb14-18"></span>
<span id="cb14-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb14-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        None</span></span>
<span id="cb14-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb14-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate global thread indices</span></span>
<span id="cb14-23">    r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx.y</span>
<span id="cb14-24">    c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadIdx.x</span>
<span id="cb14-25"></span>
<span id="cb14-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if the thread is within the output matrix dimensions</span></span>
<span id="cb14-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">or</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> w):</span>
<span id="cb14-28">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span></span>
<span id="cb14-29"></span>
<span id="cb14-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform dot product of row from m and column from n</span></span>
<span id="cb14-31">    o <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb14-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(k):</span>
<span id="cb14-33">        o <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> m[r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c]</span>
<span id="cb14-34"></span>
<span id="cb14-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store the result in the output matrix</span></span>
<span id="cb14-36">    out[r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o</span></code></pre></div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_2d(m, n):</span>
<span id="cb15-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform matrix multiplication using a simulated 2D GPU kernel.</span></span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function sets up the execution configuration and launches the</span></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    matrix multiplication kernel.</span></span>
<span id="cb15-7"></span>
<span id="cb15-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb15-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (Tensor): First input matrix.</span></span>
<span id="cb15-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (Tensor): Second input matrix.</span></span>
<span id="cb15-11"></span>
<span id="cb15-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb15-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Tensor: Result of matrix multiplication.</span></span>
<span id="cb15-14"></span>
<span id="cb15-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Raises:</span></span>
<span id="cb15-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        AssertionError: If the inner dimensions of input matrices don't match.</span></span>
<span id="cb15-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb15-18">    h, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.shape</span>
<span id="cb15-19">    k2, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n.shape</span>
<span id="cb15-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> k2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Size mismatch!"</span></span>
<span id="cb15-21"></span>
<span id="cb15-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize output matrix</span></span>
<span id="cb15-23">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(h, w, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m.dtype)</span>
<span id="cb15-24"></span>
<span id="cb15-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up thread and block dimensions</span></span>
<span id="cb15-26">    tpb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Threads per block</span></span>
<span id="cb15-27">    blocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(cdiv(w, tpb.x), cdiv(h, tpb.y))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of blocks</span></span>
<span id="cb15-28"></span>
<span id="cb15-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Launch the kernel</span></span>
<span id="cb15-30">    blk_kernel2d(matmul_bk, blocks, tpb,</span>
<span id="cb15-31">                 m.flatten(), n.flatten(), output.flatten(), h, w, k)</span>
<span id="cb15-32"></span>
<span id="cb15-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> output</span></code></pre></div>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify the result by comparing with PyTorch's built-in matrix multiplication</span></span>
<span id="cb16-2">torch.isclose(matmul_2d(m1s, m2s), m1s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>m2s).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True)</code></pre>
<ul>
<li><strong>Simple Kernel Runner:</strong> Iterates through simulated blocks and threads, calling a kernel function (not a real CUDA kernel).</li>
</ul></li>
<li><p><strong>CUDA Kernel Runner:</strong> Similar to the simple kernel runner but uses CUDA’s syntax for launching kernels (triple angle brackets).</p>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA kernel definition and PyTorch C++ extension implementation</span></span>
<span id="cb18-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb18-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void matmul_k(float* m, float* n, float* out, int h, int w, int k) {</span></span>
<span id="cb18-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Calculate global thread indices</span></span>
<span id="cb18-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r = blockIdx.y*blockDim.y + threadIdx.y;</span></span>
<span id="cb18-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int c = blockIdx.x*blockDim.x + threadIdx.x;</span></span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Check if thread is within matrix bounds</span></span>
<span id="cb18-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if (r &gt;= h || c &gt;= w) return;</span></span>
<span id="cb18-10"></span>
<span id="cb18-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Perform dot product for this element</span></span>
<span id="cb18-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float o = 0;</span></span>
<span id="cb18-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (int i = 0; i &lt; k; ++i) o += m[r*k+i] * n[i*w+c];</span></span>
<span id="cb18-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    out[r*w+c] = o;</span></span>
<span id="cb18-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-16"></span>
<span id="cb18-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor matmul(torch::Tensor m, torch::Tensor n) {</span></span>
<span id="cb18-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(m); CHECK_INPUT(n);</span></span>
<span id="cb18-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int h = m.size(0);</span></span>
<span id="cb18-20"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int w = n.size(1);</span></span>
<span id="cb18-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int k = m.size(1);</span></span>
<span id="cb18-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    TORCH_CHECK(k==n.size(0), "Size mismatch!");</span></span>
<span id="cb18-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::zeros({h, w}, m.options());</span></span>
<span id="cb18-24"></span>
<span id="cb18-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Define thread block and grid dimensions</span></span>
<span id="cb18-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 tpb(16,16);</span></span>
<span id="cb18-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 blocks(cdiv(w, tpb.x), cdiv(h, tpb.y));</span></span>
<span id="cb18-28"></span>
<span id="cb18-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch CUDA kernel</span></span>
<span id="cb18-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    matmul_k&lt;&lt;&lt;blocks, tpb&gt;&gt;&gt;(</span></span>
<span id="cb18-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        m.data_ptr&lt;float&gt;(), n.data_ptr&lt;float&gt;(), output.data_ptr&lt;float&gt;(), h, w, k);</span></span>
<span id="cb18-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb18-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb18-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb18-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">fname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matmul'</span></span></code></pre></div>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_sig(fname, src):</span>
<span id="cb20-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb20-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Extract the function signature from the source code.</span></span>
<span id="cb20-4"></span>
<span id="cb20-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb20-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        fname (str): The name of the function to extract.</span></span>
<span id="cb20-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        src (str): The source code to search.</span></span>
<span id="cb20-8"></span>
<span id="cb20-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb20-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        str: The function signature with a semicolon appended, or None if not found.</span></span>
<span id="cb20-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb20-12">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.findall(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">rf'^(.+\s+</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fname<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">\(.*?\))\s*</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">{{</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">?\s*$'</span>, src, re.MULTILINE)</span>
<span id="cb20-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> res[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">';'</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> res <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_sig(fname, cuda_src)</span>
<span id="cb21-2">cpp_src</span></code></pre></div>
<pre class="text"><code>'torch::Tensor matmul(torch::Tensor m, torch::Tensor n);'</code></pre>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the CUDA module</span></span>
<span id="cb23-2">module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_cuda(cuda_src, cpp_src, [fname])</span></code></pre></div>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Move tensors to GPU and ensure they are contiguous</span></span>
<span id="cb24-2">m1c, m2c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m1.contiguous().cuda(), m2.contiguous().cuda()</span></code></pre></div>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check the shape of the output</span></span>
<span id="cb25-2">module.matmul(m1c, m2c).shape</span></code></pre></div>
<pre class="text"><code>torch.Size([5120, 5120])</code></pre>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify correctness by comparing with PyTorch's built-in matrix multiplication</span></span>
<span id="cb27-2">torch.isclose(module.matmul(m1c, m2c), m1c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>m2c).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True, device='cuda:0')</code></pre>
<ul>
<li><strong>CUDA Kernel (Naive):</strong> ChatGPT-generated CUDA code based on the naive Python kernel.</li>
</ul></li>
<li><p><strong>Performance:</strong> CUDA version is significantly faster than pure Python.</p>
<div class="sourceCode" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>timeit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb29-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Benchmark the custom CUDA matmul implementation</span></span>
<span id="cb29-3">module.matmul(m1c, m2c)</span>
<span id="cb29-4">torch.cuda.synchronize()</span></code></pre></div>
<pre class="text"><code>3 ms ± 177 μs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre></li>
</ul>
</section>
</section>
<section id="optimizing-with-shared-memory" class="level2">
<h2 class="anchored" data-anchor-id="optimizing-with-shared-memory">Optimizing with Shared Memory</h2>
<section id="tiling" class="level3">
<h3 class="anchored" data-anchor-id="tiling">Tiling</h3>
<ul>
<li><strong>Problem:</strong> Repeated global memory access in the inner loop of the matrix multiplication kernel.</li>
<li><strong>Solution:</strong> <strong>Tiling</strong> – dividing the matrices into smaller <strong>tiles</strong> and performing the multiplication tile-by-tile.</li>
<li><strong>Tile Width (TW):</strong> The dimension of a square tile (e.g., 16x16).</li>
<li><strong>Process:</strong>
<ol type="1">
<li>Load a tile from <code>m1</code> and a tile from <code>m2</code> into shared memory.</li>
<li>Calculate the partial dot products for all elements within the output tile using the shared memory tiles.</li>
<li>Repeat for all tiles, accumulating the partial dot products to get the final result.</li>
</ol></li>
<li><strong>Benefits:</strong>
<ul>
<li>Each input element is read from global memory only once.</li>
<li>Dot products are calculated using much faster shared memory.</li>
</ul></li>
</ul>
</section>
<section id="implementing-tiling-in-python" class="level3">
<h3 class="anchored" data-anchor-id="implementing-tiling-in-python">Implementing Tiling in Python</h3>
<ul>
<li><p><strong>Dynamic Shared Memory Simulation:</strong> Using NumPy or PyTorch tensor views to simulate dynamic shared memory allocation in CUDA.</p></li>
<li><p><strong>Shared Memory Kernel Runner:</strong></p>
<div class="sourceCode" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> blk_kernel2d_shar(f, blocks, threads, sh_sz, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb31-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb31-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Execute a 2D block kernel with shared memory.</span></span>
<span id="cb31-4"></span>
<span id="cb31-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb31-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        f (function): The kernel function to execute</span></span>
<span id="cb31-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blocks (dim3): Number of blocks in x and y dimensions</span></span>
<span id="cb31-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threads (dim3): Number of threads per block</span></span>
<span id="cb31-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        sh_sz (int): Size of shared memory</span></span>
<span id="cb31-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        *args: Additional positional arguments for the kernel function</span></span>
<span id="cb31-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        **kwargs: Additional keyword arguments for the kernel function</span></span>
<span id="cb31-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb31-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i0 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks.y):</span>
<span id="cb31-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks.x):</span>
<span id="cb31-15">            shared <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(sh_sz)</span>
<span id="cb31-16">            f(dim3(i1, i0), threads, shared, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span></code></pre></div>
<ul>
<li>Iterates through blocks.</li>
<li>Creates a simulated shared memory array.</li>
<li>Calls the kernel function, passing the shared memory.</li>
</ul></li>
<li><p><strong>Tiled Matrix Multiplication Kernel (Python):</strong></p>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_tiled_bk(blockIdx, blockDim, shared, m, n, out, h, w, k, tw):</span>
<span id="cb32-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb32-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform tiled matrix multiplication using block-wise computation.</span></span>
<span id="cb32-4"></span>
<span id="cb32-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb32-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockIdx (dim3): Current block index</span></span>
<span id="cb32-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockDim (dim3): Block dimensions</span></span>
<span id="cb32-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        shared (Tensor): Shared memory tensor</span></span>
<span id="cb32-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (Tensor): First input matrix (flattened)</span></span>
<span id="cb32-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (Tensor): Second input matrix (flattened)</span></span>
<span id="cb32-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out (Tensor): Output matrix (flattened)</span></span>
<span id="cb32-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        h (int): Height of the first matrix</span></span>
<span id="cb32-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        w (int): Width of the second matrix</span></span>
<span id="cb32-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        k (int): Shared dimension of the two matrices</span></span>
<span id="cb32-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tw (int): Tile width</span></span>
<span id="cb32-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb32-17">    shar_sz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tw</span>
<span id="cb32-18">    ms, ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[:shar_sz], shared[shar_sz:]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split shared memory for both matrices</span></span>
<span id="cb32-19"></span>
<span id="cb32-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ph <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(cdiv(k, tw)):</span>
<span id="cb32-21">        idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ph <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tw</span>
<span id="cb32-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fill shared memory with tiles from input matrices</span></span>
<span id="cb32-23">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tr <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blockDim.y):</span>
<span id="cb32-24">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tc <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blockDim.x):</span>
<span id="cb32-25">                r, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tr, blockIdx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tc</span>
<span id="cb32-26">                ms[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m[tc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb32-27">                ns[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n[(tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>idx)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb32-28"></span>
<span id="cb32-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute dot products using shared memory</span></span>
<span id="cb32-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tr <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blockDim.y):</span>
<span id="cb32-31">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tc <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blockDim.x):</span>
<span id="cb32-32">                r, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tr, blockIdx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tc</span>
<span id="cb32-33">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(tw):</span>
<span id="cb32-34">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(out):</span>
<span id="cb32-35">                        out[r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> ms[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ns[tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc]</span></code></pre></div>
<ul>
<li><strong>Fill Shared Memory:</strong>
<ul>
<li>Loops through each tile.</li>
<li>Calculates the starting index (<strong>idx</strong>) of the tile in the original matrix.</li>
<li>Loops through threads within the tile.</li>
<li>Calculates the row (<strong>r</strong>) and column (<strong>c</strong>) in the original matrix based on the tile index and thread index.</li>
<li>Copies the corresponding elements from the input matrices to the shared memory tiles (<code>ms</code>, <code>ns</code>).</li>
<li><strong>Padding:</strong> Fills elements outside the matrix boundaries with zeros.</li>
</ul></li>
<li><strong>Dot Product from Shared Memory:</strong>
<ul>
<li>Loops through threads within the tile.</li>
<li>Calculates the row and column in the output matrix.</li>
<li>Performs the dot product using elements from the shared memory tiles.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_2d(m, n, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>):</span>
<span id="cb33-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb33-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform 2D matrix multiplication using tiled block-wise computation.</span></span>
<span id="cb33-4"></span>
<span id="cb33-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb33-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (Tensor): First input matrix</span></span>
<span id="cb33-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (Tensor): Second input matrix</span></span>
<span id="cb33-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tw (int, optional): Tile width. Defaults to 16.</span></span>
<span id="cb33-9"></span>
<span id="cb33-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb33-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Tensor: Result of matrix multiplication</span></span>
<span id="cb33-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb33-13">    h, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.shape</span>
<span id="cb33-14">    k2, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n.shape</span>
<span id="cb33-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> k2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Size mismatch!"</span></span>
<span id="cb33-16"></span>
<span id="cb33-17">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(h, w, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m.dtype)</span>
<span id="cb33-18">    tpb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(tw, tw)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Threads per block</span></span>
<span id="cb33-19">    blocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(cdiv(w, tpb.x), cdiv(h, tpb.y))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of blocks</span></span>
<span id="cb33-20"></span>
<span id="cb33-21">    blk_kernel2d_shar(matmul_tiled_bk, blocks, tpb, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb33-22">                      m.flatten(), n.flatten(), output.flatten(),</span>
<span id="cb33-23">                      h, w, k, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tw)</span>
<span id="cb33-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> output</span></code></pre></div>
<div class="sourceCode" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize a tensor 'a' with 5 zeros</span></span>
<span id="cb34-2">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb34-3"></span>
<span id="cb34-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split 'a' into two parts: 'b' (first 3 elements) and 'c' (last 2 elements)</span></span>
<span id="cb34-5">b, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], a[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:]</span></code></pre></div>
<div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Modify specific elements in 'b' and 'c'</span></span>
<span id="cb35-2">b[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb35-3">c[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span></span>
<span id="cb35-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The value of 'a' is now implicitly modified due to tensor slicing</span></span>
<span id="cb35-5">a</span></code></pre></div>
<pre class="text"><code>tensor([0., 2., 0., 6., 0.])</code></pre>
<div class="sourceCode" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check shapes of matrices m1s and m2s</span></span>
<span id="cb37-2">m1s.shape, m2.shape</span></code></pre></div>
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1">(torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>]), torch.Size([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5120</span>]))</span></code></pre></div></li>
<li><p><strong>Result:</strong> The Python tiled matrix multiplication produces the same result as the previous versions.</p>
<div class="sourceCode" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify if the custom matmul_2d function produces the same result as PyTorch's built-in matrix multiplication</span></span>
<span id="cb39-2">torch.isclose(matmul_2d(m1s, m2s, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>), m1s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>m2s).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True)</code></pre></li>
</ul>
</section>
<section id="refactoring-the-python-kernel" class="level3">
<h3 class="anchored" data-anchor-id="refactoring-the-python-kernel">Refactoring the Python Kernel</h3>
<ul>
<li><p><strong><code>run_threads</code> Function:</strong> Introduced to abstract the looping through threads within a tile.</p>
<div class="sourceCode" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> run_threads(f, blockDim, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb41-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb41-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Simulate thread execution in a 2D block.</span></span>
<span id="cb41-4"></span>
<span id="cb41-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb41-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        f (callable): Function to be executed by each thread.</span></span>
<span id="cb41-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockDim (object): Object containing x and y dimensions of the block.</span></span>
<span id="cb41-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        *args: Variable length argument list to be passed to f.</span></span>
<span id="cb41-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        **kwargs: Arbitrary keyword arguments to be passed to f.</span></span>
<span id="cb41-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb41-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i0 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blockDim.y):</span>
<span id="cb41-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blockDim.x):</span>
<span id="cb41-13">            f(i0, i1, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Execute function for each thread</span></span></code></pre></div></li>
<li><p><strong>Refactored Kernel:</strong></p>
<div class="sourceCode" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_tiled_bk(blockIdx, blockDim, shared, m, n, out, h, w, k, tw):</span>
<span id="cb42-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb42-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform tiled matrix multiplication for a single block.</span></span>
<span id="cb42-4"></span>
<span id="cb42-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb42-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockIdx (object): Block index in the grid.</span></span>
<span id="cb42-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockDim (object): Dimensions of the block.</span></span>
<span id="cb42-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        shared (list): Shared memory for the block.</span></span>
<span id="cb42-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (Tensor): First input matrix.</span></span>
<span id="cb42-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (Tensor): Second input matrix.</span></span>
<span id="cb42-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out (Tensor): Output matrix.</span></span>
<span id="cb42-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        h (int): Height of the output matrix.</span></span>
<span id="cb42-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        w (int): Width of the output matrix.</span></span>
<span id="cb42-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        k (int): Common dimension of input matrices.</span></span>
<span id="cb42-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tw (int): Tile width.</span></span>
<span id="cb42-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb42-17">    shar_sz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw</span>
<span id="cb42-18">    ms, ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[:shar_sz], shared[shar_sz:]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split shared memory for matrices m and n</span></span>
<span id="cb42-19"></span>
<span id="cb42-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_rc(tr, tc):</span>
<span id="cb42-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Calculate global row and column indices from thread indices."""</span></span>
<span id="cb42-22">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> blockIdx.y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>blockDim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tr, blockIdx.x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tc</span>
<span id="cb42-23"></span>
<span id="cb42-24">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> fill_shared_tk(tr, tc, ph):</span>
<span id="cb42-25">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Fill shared memory with a tile of input matrices."""</span></span>
<span id="cb42-26">        r, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_rc(tr, tc)</span>
<span id="cb42-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load elements from matrix m, use 0 if out of bounds</span></span>
<span id="cb42-28">        ms[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m[tc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (ph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb42-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load elements from matrix n, use 0 if out of bounds</span></span>
<span id="cb42-30">        ns[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n[(tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (ph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tr) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb42-31"></span>
<span id="cb42-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> dotprod_tk(tr, tc):</span>
<span id="cb42-33">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Compute partial dot product for a tile."""</span></span>
<span id="cb42-34">        r, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_rc(tr, tc)</span>
<span id="cb42-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(tw):</span>
<span id="cb42-36">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(out):</span>
<span id="cb42-37">                out[r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> ms[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ns[tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Accumulate dot product</span></span>
<span id="cb42-38"></span>
<span id="cb42-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Iterate over tiles in the k dimension</span></span>
<span id="cb42-40">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ph <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(math.ceil(k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>tw))):</span>
<span id="cb42-41">        run_threads(fill_shared_tk, blockDim, ph)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load tile into shared memory</span></span>
<span id="cb42-42">        run_threads(dotprod_tk, blockDim)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute partial dot products</span></span></code></pre></div>
<ul>
<li>Uses <code>run_threads</code> to simplify the code and make it more readable.</li>
<li>Separates the “fill shared memory” and “dot product” logic into distinct functions.</li>
</ul>
<div class="sourceCode" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_2d(m, n, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>):</span>
<span id="cb43-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb43-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform 2D matrix multiplication using tiled algorithm.</span></span>
<span id="cb43-4"></span>
<span id="cb43-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb43-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (Tensor): First input matrix.</span></span>
<span id="cb43-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (Tensor): Second input matrix.</span></span>
<span id="cb43-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tw (int, optional): Tile width. Defaults to 16.</span></span>
<span id="cb43-9"></span>
<span id="cb43-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb43-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Tensor: Result of matrix multiplication.</span></span>
<span id="cb43-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb43-13">    h, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.shape</span>
<span id="cb43-14">    k2, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n.shape</span>
<span id="cb43-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> k2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Size mismatch!"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure matrices can be multiplied</span></span>
<span id="cb43-16"></span>
<span id="cb43-17">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(h, w, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m.dtype)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize output matrix</span></span>
<span id="cb43-18">    tpb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(tw, tw)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define threads per block</span></span>
<span id="cb43-19">    blocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(cdiv(w, tpb.x), cdiv(h, tpb.y))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate number of blocks needed</span></span>
<span id="cb43-20"></span>
<span id="cb43-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Launch kernel for tiled matrix multiplication</span></span>
<span id="cb43-22">    blk_kernel2d_shar(matmul_tiled_bk, blocks, tpb, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb43-23">                      m.flatten(), n.flatten(), output.flatten(),</span>
<span id="cb43-24">                      h, w, k, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tw)</span>
<span id="cb43-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> output</span></code></pre></div></li>
<li><p><strong>Result:</strong> The refactored kernel is functionally equivalent to the previous version.</p>
<div class="sourceCode" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check shapes of input matrices</span></span>
<span id="cb44-2">m1s.shape, m2s.shape</span></code></pre></div>
<pre class="text"><code>(torch.Size([4, 256]), torch.Size([256, 4]))</code></pre>
<div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify the result of matmul_2d against PyTorch's built-in matrix multiplication</span></span>
<span id="cb46-2">torch.isclose(matmul_2d(m1s, m2s, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>), m1s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>m2s).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True)</code></pre></li>
</ul>
</section>
<section id="cuda-like-python-implementation-with-threads" class="level3">
<h3 class="anchored" data-anchor-id="cuda-like-python-implementation-with-threads">CUDA-Like Python Implementation with Threads</h3>
<ul>
<li><p><strong>Motivation:</strong> CUDA kernels don’t have explicit loops for threads; threads are executed concurrently.</p></li>
<li><p><strong>Simulating Concurrent Threads:</strong> Python’s <code>threading</code> library is used to simulate concurrent thread execution.</p>
<div class="sourceCode" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> threading</span>
<span id="cb48-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> threading <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Barrier, Thread  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For thread synchronization and creation</span></span>
<span id="cb48-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> concurrent.futures <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ThreadPoolExecutor  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For managing a pool of worker threads</span></span></code></pre></div>
<div class="sourceCode" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> g(x, sb):</span>
<span id="cb49-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb49-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A function that prints a number, its negative, and its tenfold value using a synchronization barrier.</span></span>
<span id="cb49-4"></span>
<span id="cb49-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb49-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x (int): The input number to be processed.</span></span>
<span id="cb49-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        sb (threading.Barrier): A synchronization barrier to coordinate threads.</span></span>
<span id="cb49-8"></span>
<span id="cb49-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function demonstrates the use of a barrier for thread synchronization.</span></span>
<span id="cb49-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb49-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x)</span>
<span id="cb49-12">    sb.wait()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wait for all threads to reach this point</span></span>
<span id="cb49-13">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x)</span>
<span id="cb49-14">    sb.wait()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wait again for all threads to reach this point</span></span>
<span id="cb49-15">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="sourceCode" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the number of threads to use</span></span>
<span id="cb50-2">num <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb50-3"></span>
<span id="cb50-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a Barrier object for synchronizing 'num' threads</span></span>
<span id="cb50-5">sb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Barrier(num)</span>
<span id="cb50-6"></span>
<span id="cb50-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use a ThreadPoolExecutor to manage a pool of worker threads</span></span>
<span id="cb50-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> ThreadPoolExecutor(num) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ex:</span>
<span id="cb50-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Execute the function g for each number in range(1, num+1) using the thread pool</span></span>
<span id="cb50-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The lambda function is used to pass both the number and the Barrier object to g</span></span>
<span id="cb50-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># list() is used to force immediate execution of all tasks</span></span>
<span id="cb50-12">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(ex.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> i: g(i, sb), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span></code></pre></div>
<pre class="text"><code>1
2
3
-3
-1
-2
10
20
30</code></pre></li>
<li><p><strong>Synchronization Barrier:</strong> A <code>Barrier</code> object is used to synchronize threads, ensuring that all threads complete the “fill shared memory” step before proceeding to the “dot product” step.</p></li>
<li><p><strong>Kernel Runner:</strong></p>
<div class="sourceCode" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> blk_kernel2d_shar(f, blocks, tpb, sh_sz, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb52-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb52-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Execute a 2D block kernel function with shared memory.</span></span>
<span id="cb52-4"></span>
<span id="cb52-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb52-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        f (function): The kernel function to be executed.</span></span>
<span id="cb52-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blocks (dim3): The number of blocks in x and y dimensions.</span></span>
<span id="cb52-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tpb (dim3): Threads per block in x and y dimensions.</span></span>
<span id="cb52-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        sh_sz (int): Size of shared memory.</span></span>
<span id="cb52-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        *args: Variable length argument list for the kernel function.</span></span>
<span id="cb52-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        **kwargs: Arbitrary keyword arguments for the kernel function.</span></span>
<span id="cb52-12"></span>
<span id="cb52-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function creates a grid of threads to execute the given kernel function.</span></span>
<span id="cb52-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb52-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i0 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks.y):</span>
<span id="cb52-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks.x):</span>
<span id="cb52-17">            shar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(sh_sz)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shared memory for the block</span></span>
<span id="cb52-18">            syncb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Barrier(tpb.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tpb.x)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Synchronization barrier for threads in a block</span></span>
<span id="cb52-19"></span>
<span id="cb52-20">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create threads for each element in the block</span></span>
<span id="cb52-21">            threads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Thread(target<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>f, args<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(dim3(i1,i0), dim3(p,o), tpb, shar, syncb, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args), kwargs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>kwargs)</span>
<span id="cb52-22">                       <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(tpb.y) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(tpb.x)]</span>
<span id="cb52-23"></span>
<span id="cb52-24">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Start and join all threads in the block</span></span>
<span id="cb52-25">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tr <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> threads: tr.start()</span>
<span id="cb52-26">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tr <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> threads: tr.join()</span></code></pre></div>
<ul>
<li>Creates a synchronization barrier.</li>
<li>Creates a thread for each element within a tile.</li>
<li>Passes the block index, thread index, shared memory, synchronization barrier, and kernel arguments to each thread.</li>
</ul></li>
<li><p><strong>Kernel (Python with Threads):</strong></p>
<div class="sourceCode" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_tiled_bk(blockIdx, threadIdx, blockDim, shared, syncb, m, n, out, h, w, k, tw):</span>
<span id="cb53-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb53-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform tiled matrix multiplication for a single block.</span></span>
<span id="cb53-4"></span>
<span id="cb53-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb53-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockIdx (dim3): Block index in the grid.</span></span>
<span id="cb53-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threadIdx (dim3): Thread index within the block.</span></span>
<span id="cb53-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockDim (dim3): Dimensions of the block.</span></span>
<span id="cb53-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        shared (torch.Tensor): Shared memory for the block.</span></span>
<span id="cb53-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        syncb (threading.Barrier): Synchronization barrier for threads in the block.</span></span>
<span id="cb53-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (torch.Tensor): First input matrix (flattened).</span></span>
<span id="cb53-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (torch.Tensor): Second input matrix (flattened).</span></span>
<span id="cb53-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out (torch.Tensor): Output matrix (flattened).</span></span>
<span id="cb53-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        h (int): Height of the first matrix.</span></span>
<span id="cb53-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        w (int): Width of the second matrix.</span></span>
<span id="cb53-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        k (int): Shared dimension of the matrices.</span></span>
<span id="cb53-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tw (int): Tile width.</span></span>
<span id="cb53-18"></span>
<span id="cb53-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function computes a portion of the matrix multiplication result for a single block.</span></span>
<span id="cb53-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb53-21">    tc, tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threadIdx.x, threadIdx.y</span>
<span id="cb53-22">    r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tr</span>
<span id="cb53-23">    c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockIdx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockDim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tc</span>
<span id="cb53-24">    shar_sz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tw</span>
<span id="cb53-25">    ms, ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shared[:shar_sz], shared[shar_sz:]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split shared memory for two matrices</span></span>
<span id="cb53-26">    p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb53-27"></span>
<span id="cb53-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ph <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(cdiv(k, tw)):</span>
<span id="cb53-29">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load data into shared memory</span></span>
<span id="cb53-30">        ms[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m[tc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (ph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb53-31">        ns[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n[(tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> (ph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tr) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb53-32">        syncb.wait()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Synchronize threads after loading data</span></span>
<span id="cb53-33"></span>
<span id="cb53-34">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute partial dot product</span></span>
<span id="cb53-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(tw):</span>
<span id="cb53-36">            p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> ms[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ns[tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc]</span>
<span id="cb53-37">        syncb.wait()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Synchronize threads before next iteration</span></span>
<span id="cb53-38"></span>
<span id="cb53-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> w):</span>
<span id="cb53-40">        out[r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store the result in the output matrix</span></span></code></pre></div>
<ul>
<li>Calculates row and column in the output matrix based on block and thread indices.</li>
<li>Fills shared memory (same as before).</li>
<li>Waits at the synchronization barrier (<code>syncb.wait()</code>).</li>
<li>Performs the dot product using shared memory.</li>
<li>Waits at the synchronization barrier again.</li>
</ul>
<div class="sourceCode" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_2d(m, n, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>):</span>
<span id="cb54-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb54-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform 2D matrix multiplication using tiled algorithm.</span></span>
<span id="cb54-4"></span>
<span id="cb54-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb54-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (torch.Tensor): First input matrix.</span></span>
<span id="cb54-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (torch.Tensor): Second input matrix.</span></span>
<span id="cb54-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tw (int, optional): Tile width. Defaults to 16.</span></span>
<span id="cb54-9"></span>
<span id="cb54-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb54-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        torch.Tensor: Result of matrix multiplication.</span></span>
<span id="cb54-12"></span>
<span id="cb54-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function orchestrates the tiled matrix multiplication using block kernels.</span></span>
<span id="cb54-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb54-15">    h, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.shape</span>
<span id="cb54-16">    k2, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n.shape</span>
<span id="cb54-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> k2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Size mismatch!"</span></span>
<span id="cb54-18"></span>
<span id="cb54-19">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(h, w, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m.dtype)</span>
<span id="cb54-20">    tpb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(tw, tw)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Threads per block</span></span>
<span id="cb54-21">    blocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim3(cdiv(w, tpb.x), cdiv(h, tpb.y))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of blocks</span></span>
<span id="cb54-22"></span>
<span id="cb54-23">    blk_kernel2d_shar(matmul_tiled_bk, blocks, tpb, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb54-24">                      m.flatten(), n.flatten(), output.flatten(),</span>
<span id="cb54-25">                      h, w, k, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tw)</span>
<span id="cb54-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> output</span></code></pre></div></li>
<li><p><strong>Result:</strong> The Python implementation using threads simulates CUDA’s concurrent thread execution and produces the same result.</p>
<div class="sourceCode" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify the correctness of the implementation</span></span>
<span id="cb55-2">torch.isclose(matmul_2d(m1s, m2s, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>), m1s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>m2s).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True)</code></pre></li>
</ul>
</section>
<section id="implementing-tiling-in-cuda" class="level3">
<h3 class="anchored" data-anchor-id="implementing-tiling-in-cuda">Implementing Tiling in CUDA</h3>
<ul>
<li><p><strong>CUDA Kernel (Tiled):</strong> ChatGPT-generated CUDA code based on the tiled Python kernel.</p>
<blockquote class="blockquote">
<p>Code auto-generated by ChatGPT 4, using the following prompt:</p>
<blockquote class="blockquote">
<p>Convert the following python code to CUDA C, keeping formatting and variable names the same where possible. You can remove <code>blockIdx, threadIdx, blockDim, shared</code> from the argument list, since they’re already provided by CUDA. Change <code>syncb.wait()</code> to <code>__syncthreads</code>. Use <code>extern __shared__ float shared[]</code> to create the <code>shared</code> array. Use the C ternary operator to replace the Python equivalent where appropriate. If the Python code uses any non-standard functions, you can assume the same functions are also available to the translated C code with the same name and signature.</p>
</blockquote>
<p>The generated code worked first time, although we did some minor cleanups afterwards (e.g.&nbsp;renaming <code>shared</code> to <code>ms</code>).</p>
</blockquote></li>
<li><p><strong>Dynamic Shared Memory Allocation:</strong> Uses <code>extern __shared__ float ms[];</code> to declare shared memory dynamically. The size is specified when launching the kernel.</p>
<div class="sourceCode" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA kernel code for matrix multiplication</span></span>
<span id="cb57-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb57-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb57-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @brief CUDA kernel for matrix multiplication.</span></span>
<span id="cb57-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb57-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param m Pointer to the first input matrix</span></span>
<span id="cb57-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param n Pointer to the second input matrix</span></span>
<span id="cb57-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param out Pointer to the output matrix</span></span>
<span id="cb57-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param h Height of the first matrix</span></span>
<span id="cb57-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param w Width of the second matrix</span></span>
<span id="cb57-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param k Width of the first matrix / Height of the second matrix</span></span>
<span id="cb57-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param tw Tile width for shared memory optimization</span></span>
<span id="cb57-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb57-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void matmul_k(float *m, float *n, float *out, int h, int w, int k, int tw) {</span></span>
<span id="cb57-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int tc=threadIdx.x, tr=threadIdx.y;</span></span>
<span id="cb57-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r=blockIdx.y*blockDim.y+tr, c=blockIdx.x*blockDim.x+tc;</span></span>
<span id="cb57-17"></span>
<span id="cb57-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    extern __shared__ float ms[];  // Shared memory for the first matrix</span></span>
<span id="cb57-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float *ns = &amp;ms[tw*tw];  // Shared memory for the second matrix</span></span>
<span id="cb57-20"></span>
<span id="cb57-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float p = 0.0f;  // Accumulator for the dot product</span></span>
<span id="cb57-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (int ph = 0; ph &lt; cdiv(k,tw); ++ph) {</span></span>
<span id="cb57-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        int idx = ph*tw;</span></span>
<span id="cb57-24"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Load data into shared memory, with bounds checking</span></span>
<span id="cb57-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        ms[tr*tw + tc] = r&lt;h &amp;&amp; idx+tc&lt;k ? m[ tc+idx + r*k ] : 0.0f;</span></span>
<span id="cb57-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        ns[tr*tw + tc] = c&lt;w &amp;&amp; idx+tr&lt;k ? n[(tr+idx)*w + c] : 0.0f;</span></span>
<span id="cb57-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        __syncthreads();  // Ensure all threads have loaded data</span></span>
<span id="cb57-28"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Compute partial dot product</span></span>
<span id="cb57-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        for (int i=0; i&lt;tw; ++i) p += ms[tr*tw + i] * ns[tw*i + tc];</span></span>
<span id="cb57-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        __syncthreads();  // Ensure all threads have finished computation</span></span>
<span id="cb57-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb57-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Write result to global memory</span></span>
<span id="cb57-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if (r&lt;h &amp;&amp; c&lt;w) out[r*w + c] = p;</span></span>
<span id="cb57-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb57-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div>
<div class="sourceCode" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PyTorch C++ extension for dynamic matrix multiplication</span></span>
<span id="cb58-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb58-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb58-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @brief Perform matrix multiplication using CUDA.</span></span>
<span id="cb58-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb58-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param m First input tensor</span></span>
<span id="cb58-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param n Second input tensor</span></span>
<span id="cb58-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @return torch::Tensor Result of matrix multiplication</span></span>
<span id="cb58-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb58-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor matmul_dyn(torch::Tensor m, torch::Tensor n) {</span></span>
<span id="cb58-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(m); CHECK_INPUT(n);</span></span>
<span id="cb58-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int h=m.size(0), w=n.size(1), k=m.size(1);</span></span>
<span id="cb58-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    TORCH_CHECK(k==n.size(0), "Size mismatch!");</span></span>
<span id="cb58-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::zeros({h, w}, m.options());</span></span>
<span id="cb58-15"></span>
<span id="cb58-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    /*</span></span>
<span id="cb58-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Commented out section demonstrating basic idea of dynamic size calculation</span></span>
<span id="cb58-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    cudaDeviceProp devProp;</span></span>
<span id="cb58-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CUDA_ERR(cudaGetDeviceProperties(&amp;devProp, 0));</span></span>
<span id="cb58-20"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int maxThreads = devProp.maxThreadsPerBlock;</span></span>
<span id="cb58-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    size_t requiredSize = static_cast&lt;size_t&gt;(maxThreads) * 2 * sizeof(float);</span></span>
<span id="cb58-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    size_t size = min(devProp.sharedMemPerBlock, requiredSize);</span></span>
<span id="cb58-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int TW = std::sqrt(maxThreads);</span></span>
<span id="cb58-24"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    */</span></span>
<span id="cb58-25"></span>
<span id="cb58-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Fixed size configuration</span></span>
<span id="cb58-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int TW = 16;  // Tile width</span></span>
<span id="cb58-28"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    size_t size = TW*TW * 2 * sizeof(float);  // Shared memory size</span></span>
<span id="cb58-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 tpb(TW,TW);  // Threads per block</span></span>
<span id="cb58-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 blocks(cdiv(w, tpb.x), cdiv(h, tpb.y));  // Number of blocks</span></span>
<span id="cb58-31"></span>
<span id="cb58-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch CUDA kernel</span></span>
<span id="cb58-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    matmul_k&lt;&lt;&lt;blocks,tpb,size&gt;&gt;&gt;(</span></span>
<span id="cb58-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        m.data_ptr&lt;float&gt;(), n.data_ptr&lt;float&gt;(), output.data_ptr&lt;float&gt;(), h, w, k, TW);</span></span>
<span id="cb58-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb58-36"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb58-37"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb58-38"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div>
<div class="sourceCode" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Name of the function to be called</span></span>
<span id="cb59-2">fname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matmul_dyn'</span></span></code></pre></div>
<div class="sourceCode" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate C++ function signature</span></span>
<span id="cb60-2">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_sig(fname, cuda_src)</span></code></pre></div>
<div class="sourceCode" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1">module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_cuda(cuda_src, cpp_src, [fname], opt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<pre><code># Test for correctness by comparing with PyTorch's built-in matrix multiplication
torch.isclose(module.matmul_dyn(m1c,m2c), m1c@m2c).all()</code></pre>
<pre class="text"><code>tensor(True, device='cuda:0')</code></pre></li>
<li><p><strong>Static Shared Memory Allocation:</strong> Declares shared memory arrays with fixed sizes at compile time (e.g., <code>__shared__ float ms[tw][tw];</code>).</p>
<div class="sourceCode" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA kernel and PyTorch extension for efficient matrix multiplication</span></span>
<span id="cb64-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb64-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">constexpr int tw = 16;  // Tile width for shared memory optimization</span></span>
<span id="cb64-4"></span>
<span id="cb64-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb64-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * CUDA kernel for matrix multiplication using shared memory tiling.</span></span>
<span id="cb64-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb64-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param m Pointer to the first input matrix</span></span>
<span id="cb64-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param n Pointer to the second input matrix</span></span>
<span id="cb64-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param out Pointer to the output matrix</span></span>
<span id="cb64-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param h Height of the first input matrix and output matrix</span></span>
<span id="cb64-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param w Width of the second input matrix and output matrix</span></span>
<span id="cb64-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param k Width of the first input matrix / Height of the second input matrix</span></span>
<span id="cb64-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb64-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void matmul_ks(float *m, float *n, float *out, int h, int w, int k) {</span></span>
<span id="cb64-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    __shared__ float ms[tw][tw], ns[tw][tw];  // Shared memory for tiling</span></span>
<span id="cb64-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int tc = threadIdx.x, tr = threadIdx.y;</span></span>
<span id="cb64-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r = blockIdx.y * blockDim.y + tr, c = blockIdx.x * blockDim.x + tc;</span></span>
<span id="cb64-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float p = 0.0f;  // Accumulator for dot product</span></span>
<span id="cb64-20"></span>
<span id="cb64-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Iterate over tiles</span></span>
<span id="cb64-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (int ph = 0; ph &lt; cdiv(k, tw); ++ph) {</span></span>
<span id="cb64-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        int idx = ph * tw;</span></span>
<span id="cb64-24"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Load data into shared memory, with bounds checking</span></span>
<span id="cb64-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        ms[tr][tc] = r &lt; h &amp;&amp; idx + tc &lt; k ? m[tc + idx + r * k] : 0.0f;</span></span>
<span id="cb64-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        ns[tr][tc] = c &lt; w &amp;&amp; idx + tr &lt; k ? n[(tr + idx) * w + c] : 0.0f;</span></span>
<span id="cb64-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        __syncthreads();  // Ensure all threads have loaded data</span></span>
<span id="cb64-28"></span>
<span id="cb64-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Compute partial dot product for this tile</span></span>
<span id="cb64-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        for (int i = 0; i &lt; tw; ++i) p += ms[tr][i] * ns[i][tc];</span></span>
<span id="cb64-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        __syncthreads();  // Ensure computation is complete before next iteration</span></span>
<span id="cb64-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb64-33"></span>
<span id="cb64-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Write result to global memory</span></span>
<span id="cb64-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if (r &lt; h &amp;&amp; c &lt; w) out[r * w + c] = p;</span></span>
<span id="cb64-36"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb64-37"></span>
<span id="cb64-38"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb64-39"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * PyTorch extension for static matrix multiplication using CUDA.</span></span>
<span id="cb64-40"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb64-41"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param m First input tensor</span></span>
<span id="cb64-42"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param n Second input tensor</span></span>
<span id="cb64-43"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @return Resulting tensor from matrix multiplication</span></span>
<span id="cb64-44"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb64-45"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor matmul_static(torch::Tensor m, torch::Tensor n) {</span></span>
<span id="cb64-46"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(m); CHECK_INPUT(n);  // Validate input tensors</span></span>
<span id="cb64-47"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int h = m.size(0), w = n.size(1), k = m.size(1);</span></span>
<span id="cb64-48"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    TORCH_CHECK(k == n.size(0), "Size mismatch!");  // Ensure matrices can be multiplied</span></span>
<span id="cb64-49"></span>
<span id="cb64-50"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::zeros({h, w}, m.options());  // Initialize output tensor</span></span>
<span id="cb64-51"></span>
<span id="cb64-52"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Set up CUDA kernel launch parameters</span></span>
<span id="cb64-53"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 tpb(tw, tw);  // Threads per block</span></span>
<span id="cb64-54"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 blocks(cdiv(w, tpb.x), cdiv(h, tpb.y));  // Number of blocks</span></span>
<span id="cb64-55"></span>
<span id="cb64-56"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch CUDA kernel</span></span>
<span id="cb64-57"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    matmul_ks&lt;&lt;&lt;blocks, tpb&gt;&gt;&gt;(m.data_ptr&lt;float&gt;(), n.data_ptr&lt;float&gt;(), output.data_ptr&lt;float&gt;(), h, w, k);</span></span>
<span id="cb64-58"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();  // Check for CUDA errors</span></span>
<span id="cb64-59"></span>
<span id="cb64-60"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb64-61"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb64-62"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div>
<div class="sourceCode" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Name of the function to be exported</span></span>
<span id="cb65-2">fname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matmul_static'</span></span>
<span id="cb65-3"></span>
<span id="cb65-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate C++ source code for the CUDA extension</span></span>
<span id="cb65-5">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_sig(fname, cuda_src)</span>
<span id="cb65-6"></span>
<span id="cb65-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the CUDA module</span></span>
<span id="cb65-8">module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_cuda(cuda_src, cpp_src, [fname])</span>
<span id="cb65-9"></span>
<span id="cb65-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify correctness by comparing with PyTorch's built-in matrix multiplication</span></span>
<span id="cb65-11">torch.isclose(module.matmul_static(m1c, m2c), m1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> m2c).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True, device='cuda:0')</code></pre></li>
<li><p><strong>Synchronization:</strong> <code>__syncthreads();</code> ensures all threads within a block have finished a step before proceeding to the next.</p></li>
<li><p><strong>Performance:</strong></p>
<ul>
<li><p>Dynamic shared memory version is unexpectedly slower than the naive CUDA version.</p>
<div class="sourceCode" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>timeit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb67-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Benchmark the custom CUDA matrix multiplication</span></span>
<span id="cb67-3">module.matmul_dyn(m1c,m2c)</span>
<span id="cb67-4">torch.cuda.synchronize()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure CUDA operations are completed before timing</span></span></code></pre></div>
<pre class="text"><code>3.2 ms ± 57.5 μs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre></li>
<li><p>Static shared memory version with a fixed tile width is faster.</p>
<div class="sourceCode" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>timeit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb69-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Benchmark the custom matrix multiplication</span></span>
<span id="cb69-3">module.matmul_static(m1c, m2c)</span>
<span id="cb69-4">torch.cuda.synchronize()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure CUDA operations are complete before timing</span></span></code></pre></div>
<pre class="text"><code>2.1 ms ± 23.9 μs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre></li>
</ul></li>
</ul>
</section>
<section id="dynamic-shared-memory-performance-issue-and-solution-update-from-the-future" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-shared-memory-performance-issue-and-solution-update-from-the-future">Dynamic Shared Memory Performance Issue and Solution (Update from the Future)</h3>
<ul>
<li><p><strong>Cause:</strong> CUDA struggles to optimize dynamic shared memory allocation when the tile width is not known at compile time, leading to slower performance.</p></li>
<li><p><strong>Solution:</strong> Use C++ templates to make the tile width a template parameter, enabling the compiler to generate optimized code for specific tile widths.</p></li>
<li><p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA kernel for matrix multiplication</span></span>
<span id="cb71-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb71-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">template&lt;int tw&gt;</span></span>
<span id="cb71-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void matmul_k(float *m, float *n, float *out, int h, int w, int k) {</span></span>
<span id="cb71-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Thread and block indices</span></span>
<span id="cb71-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int tc = threadIdx.x, tr = threadIdx.y;</span></span>
<span id="cb71-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r = blockIdx.y * blockDim.y + tr, c = blockIdx.x * blockDim.x + tc;</span></span>
<span id="cb71-8"></span>
<span id="cb71-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Shared memory allocation</span></span>
<span id="cb71-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    extern __shared__ float ms[];</span></span>
<span id="cb71-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float *ns = &amp;ms[tw*tw];</span></span>
<span id="cb71-12"></span>
<span id="cb71-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float p = 0.0f;  // Accumulator for dot product</span></span>
<span id="cb71-14"></span>
<span id="cb71-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Iterate over blocks of the input matrices</span></span>
<span id="cb71-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (int ph = 0; ph &lt; cdiv(k,tw); ++ph) {</span></span>
<span id="cb71-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        int idx = ph * tw;</span></span>
<span id="cb71-18"></span>
<span id="cb71-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Load data into shared memory</span></span>
<span id="cb71-20"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        ms[tr*tw + tc] = r &lt; h &amp;&amp; idx+tc &lt; k ? m[tc+idx + r*k] : 0.0f;</span></span>
<span id="cb71-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        ns[tr*tw + tc] = c &lt; w &amp;&amp; idx+tr &lt; k ? n[(tr+idx)*w + c] : 0.0f;</span></span>
<span id="cb71-22"></span>
<span id="cb71-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        __syncthreads();  // Ensure all threads have loaded data</span></span>
<span id="cb71-24"></span>
<span id="cb71-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Compute partial dot product</span></span>
<span id="cb71-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        for (int i = 0; i &lt; tw; ++i) {</span></span>
<span id="cb71-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">            p += ms[tr*tw + i] * ns[tw*i + tc];</span></span>
<span id="cb71-28"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        }</span></span>
<span id="cb71-29"></span>
<span id="cb71-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        __syncthreads();  // Ensure all threads have used the data</span></span>
<span id="cb71-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb71-32"></span>
<span id="cb71-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Write result to global memory</span></span>
<span id="cb71-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if (r &lt; h &amp;&amp; c &lt; w) {</span></span>
<span id="cb71-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        out[r*w + c] = p;</span></span>
<span id="cb71-36"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb71-37"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb71-38"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div>
<div class="sourceCode" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ wrapper function for the CUDA kernel</span></span>
<span id="cb72-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb72-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor matmul_dyn1(torch::Tensor m, torch::Tensor n) {</span></span>
<span id="cb72-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(m);</span></span>
<span id="cb72-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(n);</span></span>
<span id="cb72-6"></span>
<span id="cb72-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Get dimensions of input matrices</span></span>
<span id="cb72-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int h = m.size(0), w = n.size(1), k = m.size(1);</span></span>
<span id="cb72-9"></span>
<span id="cb72-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Check if matrices can be multiplied</span></span>
<span id="cb72-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    TORCH_CHECK(k == n.size(0), "Size mismatch!");</span></span>
<span id="cb72-12"></span>
<span id="cb72-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Create output tensor</span></span>
<span id="cb72-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::zeros({h, w}, m.options());</span></span>
<span id="cb72-15"></span>
<span id="cb72-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int TW = 16;  // Thread block width (TODO: Calculate this dynamically)</span></span>
<span id="cb72-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    size_t size = TW*TW*2 * sizeof(float) + 1;  // Shared memory size</span></span>
<span id="cb72-18"></span>
<span id="cb72-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Define thread block and grid dimensions</span></span>
<span id="cb72-20"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 tpb(TW, TW);</span></span>
<span id="cb72-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 blocks(cdiv(w, tpb.x), cdiv(h, tpb.y));</span></span>
<span id="cb72-22"></span>
<span id="cb72-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Lambda function to launch kernel</span></span>
<span id="cb72-24"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto f = [&amp;](auto kf) {</span></span>
<span id="cb72-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        kf&lt;&lt;&lt;blocks, tpb, size&gt;&gt;&gt;(</span></span>
<span id="cb72-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">            m.data_ptr&lt;float&gt;(), n.data_ptr&lt;float&gt;(), output.data_ptr&lt;float&gt;(), h, w, k</span></span>
<span id="cb72-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        );</span></span>
<span id="cb72-28"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    };</span></span>
<span id="cb72-29"></span>
<span id="cb72-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch kernel based on thread block size</span></span>
<span id="cb72-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    switch(TW) {</span></span>
<span id="cb72-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        case 8: f(matmul_k&lt;8&gt;); break;</span></span>
<span id="cb72-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        case 16: f(matmul_k&lt;16&gt;); break;</span></span>
<span id="cb72-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        case 32: f(matmul_k&lt;32&gt;); break;</span></span>
<span id="cb72-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        default: break;</span></span>
<span id="cb72-36"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb72-37"></span>
<span id="cb72-38"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Check for CUDA errors</span></span>
<span id="cb72-39"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb72-40"></span>
<span id="cb72-41"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb72-42"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb72-43"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div>
<ul>
<li>Define a C++ template function with tile width as a template parameter.</li>
<li>Support a fixed set of tile widths and compile a separate kernel version for each.</li>
<li>Use a lambda function to call the appropriate kernel version based on the chosen tile width.</li>
</ul></li>
<li><p><strong>Benefits:</strong> Enables optimized performance while allowing for some flexibility in tile width selection.</p>
<div class="sourceCode" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb73-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure execution time of the following code</span></span>
<span id="cb73-3"></span>
<span id="cb73-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define function name</span></span>
<span id="cb73-5">fname <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matmul_dyn1'</span></span>
<span id="cb73-6"></span>
<span id="cb73-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate C++ function signature</span></span>
<span id="cb73-8">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_sig(fname, cuda_src)</span>
<span id="cb73-9"></span>
<span id="cb73-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load CUDA module with optimization</span></span>
<span id="cb73-11">module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_cuda(cuda_src, cpp_src, [fname], opt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb73-12"></span>
<span id="cb73-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the function from the loaded module</span></span>
<span id="cb73-14">func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(module, fname)</span></code></pre></div>
<pre class="text"><code>CPU times: user 49.5 ms, sys: 63.7 ms, total: 113 ms
Wall time: 41.1 s</code></pre>
<div class="sourceCode" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify correctness of the custom matrix multiplication</span></span>
<span id="cb75-2">torch.isclose(func(m1c, m2c), m1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> m2c).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True, device='cuda:0')</code></pre>
<div class="sourceCode" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>timeit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb77-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure execution time of the custom matrix multiplication</span></span>
<span id="cb77-3">func(m1c, m2c)</span>
<span id="cb77-4"></span>
<span id="cb77-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure all CUDA operations are completed</span></span>
<span id="cb77-6">torch.cuda.synchronize()</span></code></pre></div>
<pre class="text"><code>2.06 ms ± 51.2 μs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre></li>
</ul>
</section>
</section>
<section id="implementing-tiling-with-numba" class="level2">
<h2 class="anchored" data-anchor-id="implementing-tiling-with-numba">Implementing Tiling with Numba</h2>
<ul>
<li><p><strong><a href="https://numba.readthedocs.io/en/stable/index.html">Numba</a>:</strong> An alternative library for writing CUDA code directly in Python.</p>
<div class="sourceCode" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb79-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install numba</span>
<span id="cb79-2"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-U</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"numpy&lt;2.1"</span></span></code></pre></div>
<div class="sourceCode" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numba <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> cuda</span>
<span id="cb80-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numba.cuda <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> as_cuda_array <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ca</span></code></pre></div></li>
<li><p><strong>CUDA Kernel (Numba):</strong> Python code decorated with <code>@cuda.jit</code> to indicate it’s a CUDA kernel.</p>
<div class="sourceCode" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@cuda.jit</span></span>
<span id="cb81-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_k_numba(m, n, out, tw):</span>
<span id="cb81-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb81-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform matrix multiplication on GPU using CUDA.</span></span>
<span id="cb81-5"></span>
<span id="cb81-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This kernel function multiplies matrices 'm' and 'n', storing the result in 'out'.</span></span>
<span id="cb81-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    It uses shared memory and tiling for improved performance.</span></span>
<span id="cb81-8"></span>
<span id="cb81-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb81-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    m (ndarray): First input matrix</span></span>
<span id="cb81-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    n (ndarray): Second input matrix</span></span>
<span id="cb81-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    out (ndarray): Output matrix to store the result</span></span>
<span id="cb81-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tw (int): Tile width for shared memory optimization</span></span>
<span id="cb81-14"></span>
<span id="cb81-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Note: This function is designed to be called from a host function, not directly.</span></span>
<span id="cb81-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb81-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get CUDA thread and block information</span></span>
<span id="cb81-18">    cbi, cbd, tid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda.blockIdx, cuda.blockDim, cuda.threadIdx</span>
<span id="cb81-19">    tc, tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tid.x, tid.y</span>
<span id="cb81-20"></span>
<span id="cb81-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate global row and column indices</span></span>
<span id="cb81-22">    r, c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cbi.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cbd.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tr, cbi.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cbd.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> tc</span>
<span id="cb81-23"></span>
<span id="cb81-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get input matrix dimensions</span></span>
<span id="cb81-25">    h, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.shape</span>
<span id="cb81-26">    k2, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n.shape</span>
<span id="cb81-27"></span>
<span id="cb81-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Allocate shared memory for tile-based computation</span></span>
<span id="cb81-29">    shar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda.shared.array(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.float32)</span>
<span id="cb81-30">    ms, ns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> shar[:tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw], shar[tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split shared memory for both input matrices</span></span>
<span id="cb81-31"></span>
<span id="cb81-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize partial sum</span></span>
<span id="cb81-33">    p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.float32(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb81-34"></span>
<span id="cb81-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Iterate over tiles</span></span>
<span id="cb81-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ph <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(math.ceil(k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>tw)):</span>
<span id="cb81-37">        idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ph <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tw</span>
<span id="cb81-38"></span>
<span id="cb81-39">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load data into shared memory, with boundary checks</span></span>
<span id="cb81-40">        ms[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m[r, tc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>idx] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb81-41">        ns[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>idx, c] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> w <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> idx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb81-42"></span>
<span id="cb81-43">        cuda.syncthreads()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure all threads have loaded data</span></span>
<span id="cb81-44"></span>
<span id="cb81-45">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute partial dot product for this tile</span></span>
<span id="cb81-46">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(tw):</span>
<span id="cb81-47">            p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> ms[tr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ns[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>tc]</span>
<span id="cb81-48"></span>
<span id="cb81-49">        cuda.syncthreads()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure all threads have used the data before next iteration</span></span>
<span id="cb81-50"></span>
<span id="cb81-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store the result if within output matrix bounds</span></span>
<span id="cb81-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> w:</span>
<span id="cb81-53">        out[r, c] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p</span></code></pre></div>
<ul>
<li><strong>Shared Memory:</strong> <code>cuda.shared.array</code> creates dynamic shared memory arrays.</li>
<li><strong>Synchronization:</strong> <code>cuda.syncthreads()</code> for thread synchronization.</li>
</ul></li>
<li><p><strong>Kernel Launching:</strong> Uses square brackets instead of triple angle brackets (e.g., <code>kernel[blocks, threadsperblock, stream, shared_mem_size](...)</code>).</p>
<div class="sourceCode" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_2d_numba(m, n, tw<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>):</span>
<span id="cb82-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb82-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform matrix multiplication using CUDA.</span></span>
<span id="cb82-4"></span>
<span id="cb82-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function prepares the CUDA kernel call for matrix multiplication.</span></span>
<span id="cb82-6"></span>
<span id="cb82-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb82-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    m (Tensor): First input matrix (PyTorch tensor on CUDA)</span></span>
<span id="cb82-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    n (Tensor): Second input matrix (PyTorch tensor on CUDA)</span></span>
<span id="cb82-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tw (int): Tile width for shared memory optimization (default: 16)</span></span>
<span id="cb82-11"></span>
<span id="cb82-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb82-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Tensor: Result of matrix multiplication</span></span>
<span id="cb82-14"></span>
<span id="cb82-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Raises:</span></span>
<span id="cb82-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    AssertionError: If input matrices have mismatched inner dimensions</span></span>
<span id="cb82-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb82-18">    h, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.shape</span>
<span id="cb82-19">    k2, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n.shape</span>
<span id="cb82-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> k2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Size mismatch!"</span></span>
<span id="cb82-21"></span>
<span id="cb82-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize output matrix</span></span>
<span id="cb82-23">    out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(h, w, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m.device)</span>
<span id="cb82-24"></span>
<span id="cb82-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up CUDA kernel parameters</span></span>
<span id="cb82-26">    dyn_shared_mem_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Size of shared memory in bytes</span></span>
<span id="cb82-27">    tpb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tw, tw  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Threads per block</span></span>
<span id="cb82-28">    blocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cdiv(w, tpb[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]), cdiv(h, tpb[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate grid dimensions</span></span>
<span id="cb82-29"></span>
<span id="cb82-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Launch CUDA kernel</span></span>
<span id="cb82-31">    matmul_k_numba[blocks, tpb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, dyn_shared_mem_size](ca(m), ca(n), ca(out), tw)</span>
<span id="cb82-32"></span>
<span id="cb82-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> out</span></code></pre></div>
<div class="sourceCode" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify correctness of the implementation</span></span>
<span id="cb83-2">torch.isclose(matmul_2d_numba(m1c, m2c), m1c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>m2c).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True, device='cuda:0')</code></pre></li>
<li><p><strong>Performance:</strong> The Numba version with dynamic shared memory is slower than the optimized CUDA C version but still provides CUDA-level speed.</p>
<div class="sourceCode" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>timeit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb85-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Benchmark the implementation</span></span>
<span id="cb85-3">matmul_2d_numba(m1c, m2c)</span>
<span id="cb85-4">torch.cuda.synchronize()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure all CUDA operations are completed before timing</span></span></code></pre></div>
<pre class="text"><code>7.8 ms ± 80.7 μs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre></li>
<li><p><strong>Benefits:</strong></p>
<ul>
<li>Faster compilation times compared to PyTorch’s CUDA C/C++ approach.
<ul>
<li>Allows for faster iteration during development.</li>
</ul></li>
<li>No need to flatten tensors (supports multidimensional indexing).</li>
<li>Access to tensor shape information within the kernel.</li>
</ul></li>
<li><p><strong><a href="https://numba.readthedocs.io/en/stable/cuda/simulator.html">CUDA Simulator</a>:</strong> Numba provides a built-in CUDA simulator by setting the environment variable <code>NUMBA_ENABLE_CUDASIM=1</code>.</p>
<ul>
<li>Executes CUDA code as pure Python on the CPU, allowing for debugging and experimentation with small datasets.</li>
</ul></li>
<li><p><strong>Development Workflow:</strong></p>
<ol type="1">
<li>Develop and debug CUDA kernels in Numba with the simulator enabled.</li>
<li>Disable the simulator to run the code on the GPU.</li>
<li>Optionally, convert the Numba code to CUDA C/C++ using ChatGPT for deployment.</li>
</ol></li>
</ul>
</section>
<section id="qa-session" class="level2">
<h2 class="anchored" data-anchor-id="qa-session">Q&amp;A Session</h2>
<ul>
<li><strong>Shipping Numba Kernels and AOT Compilation:</strong>
<ul>
<li><strong>AOT Compilation:</strong> Numba’s AOT was discussed as a potential deployment simplification solution.</li>
<li><strong>AOT Deprecation:</strong> Numba’s AOT is deprecated (February 2024), with a replacement planned but unspecified.</li>
</ul></li>
<li><strong>Performance Comparisons and Optimization Opportunities:</strong>
<ul>
<li><strong>Optimization Tools:</strong> TVM and Mojo GPU’s auto-tune (expected late February/March 2024) were mentioned as potential optimization aids.</li>
</ul></li>
<li><strong>PyTorch’s Matrix Multiplication Implementation:</strong>
<ul>
<li>PyTorch primarily uses cuBLAS.</li>
<li><strong>Torch Compile and Inductor:</strong> Torch Compile’s experimental mode (torch.inductor.config) was mentioned as a potential alternative backend.</li>
<li><strong>Profiling for Backend Identification:</strong> PyTorch’s profiler can reveal the backend used through function signatures.</li>
</ul></li>
<li><strong>Compilation Speed and Iterative Development:</strong>
<ul>
<li><strong>Compilation Speed Importance:</strong> Fast compilation was emphasized as crucial for iterative development.</li>
<li><strong>Fast Compilation Benefits:</strong> Fast compilation, aided by tools like the CUDA simulator and Numba’s CUDA JIT, enhances productivity and reduces debugging time.</li>
</ul></li>
<li><strong>ChatGPT’s Role in CUDA Development:</strong>
<ul>
<li><strong>ChatGPT’s Code Generation Capabilities:</strong> ChatGPT is useful for code conversion and API usage but less effective for novel algorithms.</li>
</ul></li>
<li><strong>Numba vs.&nbsp;Triton:</strong>
<ul>
<li><strong>Different Purposes:</strong> Numba and Triton were recognized as valuable tools with distinct strengths, suitable for different use cases. Triton’s limitations in expressing certain CUDA constructs (e.g., 4-bit discretization) were noted.</li>
<li><strong>Complementary Tools:</strong> Numba and Triton were seen as complementary, each offering unique advantages.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/lecture-005/</guid>
  <pubDate>Sun, 01 Sep 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>CUDA MODE Lecture 4: Compute and Memory Basics</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/lecture-004/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<ul>
<li><strong>Compute Architecture and Scheduling</strong></li>
<li><strong>Memory Architecture and Data Locality</strong><br>
</li>
<li><strong>Conclusions and Key Takeaways</strong></li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Resource Links:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Resource Links:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube Recording:</strong> <a href="https://www.youtube.com/watch?v=lTmYrKwjSOU">Lecture 4 Compute and Memory Basics</a></li>
<li><strong>Jupyter Notebook:</strong> <a href="https://github.com/cuda-mode/lectures/blob/main/lecture_004/cuda-mode-session-4.ipynb">lecture_004/cuda-mode-session-4.ipynb</a></li>
<li><strong>Paper:</strong> <a href="https://www.nvidia.com/content/PDF/nvidia-ampere-ga-102-gpu-architecture-whitepaper-v2.pdf">GA102 Whitepaper</a></li>
</ul>
</div>
</div>
<section id="compute-architecture-and-scheduling" class="level2">
<h2 class="anchored" data-anchor-id="compute-architecture-and-scheduling"><strong>Compute Architecture and Scheduling</strong></h2>
<section id="gpu-architecture-vs.-cpu" class="level3">
<h3 class="anchored" data-anchor-id="gpu-architecture-vs.-cpu"><strong>GPU Architecture vs.&nbsp;CPU</strong></h3>
<ul>
<li><strong>CPUs:</strong>
<ul>
<li>Complex cores with multiple specialized units (fetch, decode, ALU).</li>
<li>Typically, one or few Arithmetic Logic Units (ALUs) per core. <img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-004/images/cpu-core.png" class="img-fluid quarto-figure quarto-figure-center"></li>
</ul></li>
<li><strong>GPUs:</strong>
<ul>
<li>Streaming Multiprocessors (SMs) with many ALUs.</li>
<li><strong>Threads</strong> share context and resources within an SM.</li>
<li>Each thread has its own program counter in newer GPUs (e.g., Volta and later).</li>
<li>Older GPUs shared program counters among threads in a warp. <img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-004/images/gpu-sm.png" class="img-fluid quarto-figure quarto-figure-center"></li>
</ul></li>
</ul>
</section>
<section id="gpu-architecture-details-rtx-3090-example" class="level3">
<h3 class="anchored" data-anchor-id="gpu-architecture-details-rtx-3090-example">GPU Architecture Details (RTX 3090 Example)</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-004/images/rtx-3090.png" class="img-fluid figure-img"></p>
<figcaption>Figure 2. GA102 Full GPU with 84 SMs</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Note:</strong> The GA102 GPU also features 168 FP64 units (two per SM), which are not depicted in this diagram. The FP64 TFLOP rate is 1/64th the TFLOP rate of FP32 operations. The small number of FP64 hardware units are included to ensure any programs with FP64 code operate correctly, including FP64 Tensor Core code.</p>
</div>
</div>
<ul>
<li><strong>Streaming Multiprocessors (SMs):</strong>
<ul>
<li>RTX 3090 has 82 SMs.</li>
<li>SMs are largely independent.</li>
<li>Share a common L2 cache.</li>
</ul></li>
<li><strong>Floating-Point Cores:</strong>
<ul>
<li>Consumer GPUs lack dedicated FP64 cores.</li>
<li>RTX 3090 has a limited FP64 rate (1/64th of FP32).</li>
<li>Accidental use of FP64 constants can significantly slow down computation.</li>
</ul></li>
<li><strong>Streaming Multiprocessor Structure:</strong>
<ul>
<li>Each SM has four units, each with:
<ul>
<li>Register file.</li>
<li>Scheduling and dispatch unit (32 threads/clock).</li>
<li>Compute units: 32 FP32 units (half can do INT32).</li>
<li>Tensor cores.</li>
</ul></li>
</ul></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-004/images/figure-3-ga10x-streaming-multiprocessor-sm.png" class="img-fluid figure-img"></p>
<figcaption>Figure 3. GA10x Streaming Multiprocessor (SM)</figcaption>
</figure>
</div>
<ul>
<li><strong>Kernel Execution:</strong>
<ul>
<li><strong>Thread blocks</strong> are assigned to SMs (no user control over assignment).</li>
<li>Multiple blocks can be assigned to one SM if resource limits allow.</li>
<li>RTX 3090 can handle up to 1536 threads per SM.</li>
<li>Ideal block size divides 1536 (e.g., 256 or 512).</li>
</ul></li>
<li><strong>Warp Execution:</strong>
<ul>
<li>Each SM processes one <strong>warp</strong> (32 threads) at a time.</li>
<li><strong>Warp divergence</strong> occurs when threads within a warp are not in sync, leading to partial execution.</li>
</ul></li>
<li><strong>Registers:</strong>
<ul>
<li>Shared register file (64K 32-bit registers per SM).</li>
<li>Registers are not cleared when switching between warps, requiring careful management of register usage.</li>
</ul></li>
<li><strong>L1 Cache and Shared Memory:</strong>
<ul>
<li>128KB of on-chip memory per SM, split between L1 cache and shared memory.</li>
</ul></li>
</ul>
</section>
<section id="threads-warps-and-blocks" class="level3">
<h3 class="anchored" data-anchor-id="threads-warps-and-blocks"><strong>Threads, Warps, and Blocks</strong></h3>
<ul>
<li><strong>Kernel Launch:</strong> Defined by block layout (threads per block) and grid layout (number of blocks).</li>
<li><strong>Thread Block:</strong>
<ul>
<li>Assigned to a single SM.</li>
<li>Threads within a block execute in parallel on the same SM.</li>
<li>Threads within a block can access <strong>shared memory</strong>.</li>
</ul></li>
<li><strong>Blocks:</strong>
<ul>
<li>Independent of each other.</li>
<li>CUDA assigns blocks to SMs arbitrarily (no programmer control).</li>
<li>Execution order of blocks is not guaranteed.</li>
</ul></li>
<li><strong>SM Thread Capacity:</strong>
<ul>
<li>SMs can process more threads than the maximum threads in a block.</li>
<li>Multiple blocks can be assigned to a single SM, if resource limits allow.</li>
<li><strong>Example (RTX 3090):</strong> Maximum 1536 threads per SM.</li>
<li><strong>Recommendation:</strong> Choose block sizes (e.g., 256, 512) that divide the maximum thread capacity for optimal SM utilization.</li>
</ul></li>
<li><strong>Warp:</strong>
<ul>
<li>A group of 32 threads.</li>
<li>SMs process one warp at a time.</li>
<li><strong>Warp Divergence:</strong> Occurs when threads within a warp follow different execution paths (e.g., due to conditional statements).
<ul>
<li>Leads to reduced performance as only a subset of threads in a warp execute at a time.</li>
</ul></li>
</ul></li>
<li><strong>AMD Terminology:</strong>
<ul>
<li><strong>Wavefronts:</strong> AMD’s term for warps.</li>
<li>Typically 64 threads, but can be reduced to 32 via compiler options.</li>
</ul></li>
</ul>
</section>
<section id="multi-dimensional-thread-grids" class="level3">
<h3 class="anchored" data-anchor-id="multi-dimensional-thread-grids"><strong>Multi-Dimensional Thread Grids</strong></h3>
<ul>
<li><p><strong>Linearization:</strong> Multi-dimensional thread grids are linearized for execution.</p></li>
<li><p><strong>Thread Index Order:</strong> <code>threadIdx.x</code> is the fastest moving dimension, followed by <code>threadIdx.y</code>, and then <code>threadIdx.z</code>.</p></li>
<li><p><strong>Example:</strong> An <code>8x8x8</code> thread block:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA kernel and C++ function declaration</span></span>
<span id="cb1-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#include &lt;c10/cuda/CUDAException.h&gt;</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb1-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> * CUDA kernel to compute thread indices of neighbors in a 3D grid.</span></span>
<span id="cb1-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb1-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param out Pointer to output array where neighbor indices will be stored.</span></span>
<span id="cb1-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb1-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void thread_idx_of_neighbors_kernel(int32_t* out) {</span></span>
<span id="cb1-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Grid dimensions: 8x8x8 threads per block, 32 neighbors per thread, 3 coordinates per neighbor</span></span>
<span id="cb1-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int x = threadIdx.x;</span></span>
<span id="cb1-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int y = threadIdx.y;</span></span>
<span id="cb1-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int z = threadIdx.z;</span></span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Iterate over all 32 threads in the warp</span></span>
<span id="cb1-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (int i = 0; i &lt; 32; i++) {</span></span>
<span id="cb1-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Use warp shuffle to get coordinates of other threads</span></span>
<span id="cb1-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        int other_x = __shfl_sync(0xffffffff, x, i);</span></span>
<span id="cb1-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        int other_y = __shfl_sync(0xffffffff, y, i);</span></span>
<span id="cb1-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        int other_z = __shfl_sync(0xffffffff, z, i);</span></span>
<span id="cb1-22"></span>
<span id="cb1-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Calculate offset in output array and store neighbor coordinates</span></span>
<span id="cb1-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        int offset = z * 8*8*32*3 + y * 8*32*3 + x * 32*3 + i*3;</span></span>
<span id="cb1-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        out[offset] = other_x;</span></span>
<span id="cb1-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        out[offset + 1] = other_y;</span></span>
<span id="cb1-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">        out[offset + 2] = other_z;</span></span>
<span id="cb1-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb1-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-30"></span>
<span id="cb1-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb1-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> * C++ wrapper function to launch the CUDA kernel and return results as a Torch tensor.</span></span>
<span id="cb1-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb1-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @return torch::Tensor A 5D tensor containing thread indices of neighbors.</span></span>
<span id="cb1-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb1-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor thread_idx_of_neighbors() {</span></span>
<span id="cb1-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Create output tensor: 8x8x8 threads, 32 neighbors, 3 coordinates</span></span>
<span id="cb1-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::empty({8, 8, 8, 32, 3}, torch::TensorOptions().device(torch::kCUDA).dtype(torch::kInt));</span></span>
<span id="cb1-39"></span>
<span id="cb1-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Set up kernel launch parameters</span></span>
<span id="cb1-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 block(8, 8, 8);</span></span>
<span id="cb1-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 grid(1);</span></span>
<span id="cb1-43"></span>
<span id="cb1-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch kernel</span></span>
<span id="cb1-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    thread_idx_of_neighbors_kernel&lt;&lt;&lt;grid, block&gt;&gt;&gt;(output.data_ptr&lt;int32_t&gt;());</span></span>
<span id="cb1-46"></span>
<span id="cb1-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Check for CUDA errors</span></span>
<span id="cb1-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb1-49"></span>
<span id="cb1-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb1-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span></code></pre></div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ function declaration</span></span>
<span id="cb2-2">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb2-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor thread_idx_of_neighbors();</span></span>
<span id="cb2-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span></code></pre></div>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the CUDA kernel and C++ function as a PyTorch extension</span></span>
<span id="cb3-2">thread_idx_of_neighbors_module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.utils.cpp_extension.load_inline(</span>
<span id="cb3-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_thread_idx"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Name of the extension</span></span>
<span id="cb3-4">    cpp_src,            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ source code</span></span>
<span id="cb3-5">    cuda_src,           <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA source code</span></span>
<span id="cb3-6">    functions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'thread_idx_of_neighbors'</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># List of functions to expose</span></span>
<span id="cb3-7">    extra_cuda_cflags<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--ptxas-options=-v'</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Additional CUDA compiler flags</span></span>
<span id="cb3-8">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enable verbose output during compilation</span></span>
<span id="cb3-9">)</span></code></pre></div>
<ul>
<li>Threads within a warp have consecutive <code>threadIdx.x</code> values.</li>
<li><code>threadIdx.y</code> changes less frequently than <code>threadIdx.x</code>.</li>
<li><code>threadIdx.z</code> changes least frequently.</li>
</ul></li>
<li><p><strong>Verification:</strong> Kernel code demonstrates thread indexing using shuffle instructions.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Call the CUDA kernel through the PyTorch extension</span></span>
<span id="cb4-2">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thread_idx_of_neighbors_module.thread_idx_of_neighbors()</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Access the first element of the result tensor</span></span>
<span id="cb4-5">t[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<pre class="text"><code>tensor([[0, 0, 0],
        [1, 0, 0],
        [2, 0, 0],
        [3, 0, 0],
        [4, 0, 0],
        [5, 0, 0],
        [6, 0, 0],
        [7, 0, 0],
        [0, 1, 0],
        [1, 1, 0],
        [2, 1, 0],
        [3, 1, 0],
        [4, 1, 0],
        [5, 1, 0],
        [6, 1, 0],
        [7, 1, 0],
        [0, 2, 0],
        [1, 2, 0],
        [2, 2, 0],
        [3, 2, 0],
        [4, 2, 0],
        [5, 2, 0],
        [6, 2, 0],
        [7, 2, 0],
        [0, 3, 0],
        [1, 3, 0],
        [2, 3, 0],
        [3, 3, 0],
        [4, 3, 0],
        [5, 3, 0],
        [6, 3, 0],
        [7, 3, 0]], device='cuda:0', dtype=torch.int32)</code></pre></li>
</ul>
</section>
<section id="warp-divergence-and-control-flow" class="level3">
<h3 class="anchored" data-anchor-id="warp-divergence-and-control-flow"><strong>Warp Divergence and Control Flow</strong></h3>
<ul>
<li><strong>Traditional GPUs (Single Program Counter per Warp):</strong>
<ul>
<li><strong>Conditional Statements (if-else):</strong> Threads not satisfying the condition are disabled, leading to warp divergence.</li>
<li>Only the active threads execute the corresponding branch.</li>
<li>Threads are re-enabled/disabled as needed at each branch point.</li>
<li><strong>Limitations:</strong>
<ul>
<li>Inter-thread communication within a warp is not possible during divergence (waiting threads would stall the warp).</li>
<li>Performance is reduced due to idle threads and sequential execution of branches.</li>
</ul></li>
</ul></li>
<li><strong>Newer GPUs (&gt;= Volta) (Independent Program Counters):</strong>
<ul>
<li>Each thread has its own program counter.</li>
<li>GPU can interleave execution of different branches, improving utilization.</li>
<li><strong>Advantages:</strong>
<ul>
<li>Can hide memory latency by switching to other warps while one warp waits for memory access.</li>
</ul></li>
<li><strong>Disadvantages:</strong>
<ul>
<li>Reconvergence of threads after divergence is not automatic.</li>
<li>Requires explicit synchronization using <code>__syncwarp()</code> to ensure all threads are at the same point before continuing.</li>
</ul></li>
</ul></li>
<li><strong>Loop Divergence:</strong> Similar divergence occurs in loops with variable iteration counts across threads in a warp.</li>
</ul>
</section>
<section id="achieving-good-occupancy" class="level3">
<h3 class="anchored" data-anchor-id="achieving-good-occupancy"><strong>Achieving Good Occupancy</strong></h3>
<ul>
<li><strong>Occupancy:</strong> A measure of how well the GPU’s resources are utilized.</li>
<li><strong>Goals:</strong>
<ul>
<li>Keep all SMs busy.</li>
<li>Maximize the number of active threads per SM.</li>
<li>Minimize warp divergence.</li>
<li>Avoid slow FP64 and INT64 operations (especially on consumer GPUs).</li>
</ul></li>
<li><strong>Strategies:</strong>
<ul>
<li><strong>Many Blocks:</strong> Utilize all available SMs.</li>
<li><strong>Optimal Block Size:</strong> Choose a power of two smaller than 512 (or a divisor of the maximum threads per SM) to maximize concurrent threads.</li>
<li><strong>Minimize Divergence:</strong>
<ul>
<li>Use conditional load/store instructions to avoid control flow divergence.</li>
<li>Structure code to minimize branching within warps.</li>
</ul></li>
<li><strong>Avoid FP64/INT64:</strong> Use FP32/INT32 whenever possible for better performance.</li>
</ul></li>
<li><strong>Shared Memory and Registers:</strong>
<ul>
<li>Excessive use of shared memory or registers can limit the number of threads scheduled per SM.</li>
<li><strong>Launch Bounds:</strong> Use <code>__launch_bounds__</code> to advise the compiler about expected thread counts, allowing for better register allocation.</li>
<li><strong>Register Spills:</strong> If register usage exceeds the limit, variables are spilled to slower local memory, impacting performance.</li>
</ul></li>
<li><strong>Occupancy Calculation Tools:</strong>
<ul>
<li><strong>Previously:</strong> Excel sheets.</li>
<li><strong>Currently:</strong> NVIDIA Nsight Compute provides occupancy analysis.</li>
</ul></li>
</ul>
</section>
<section id="querying-gpu-properties" class="level3">
<h3 class="anchored" data-anchor-id="querying-gpu-properties"><strong>Querying GPU Properties</strong></h3>
<ul>
<li><strong>PyTorch:</strong> <code>torch.cuda.get_device_properties(device)</code> provides basic properties (name, compute architecture, memory, processor count, registers per SM, max threads per SM).</li>
<li><strong>CUDA C API:</strong> More detailed properties are available through the CUDA Runtime API.</li>
</ul>
</section>
</section>
<section id="memory-architecture-and-data-locality" class="level2">
<h2 class="anchored" data-anchor-id="memory-architecture-and-data-locality"><strong>Memory Architecture and Data Locality</strong></h2>
<section id="performance-bottlenecks" class="level3">
<h3 class="anchored" data-anchor-id="performance-bottlenecks"><strong>Performance Bottlenecks</strong></h3>
<ul>
<li><strong>Memory Accesses:</strong> Often a major bottleneck in kernel performance.</li>
<li><strong>Kernel Fusion:</strong> Combining multiple kernels into one can reduce memory transfers by avoiding intermediate reads and writes.</li>
</ul>
</section>
<section id="pytorch-performance-breakdown" class="level3">
<h3 class="anchored" data-anchor-id="pytorch-performance-breakdown"><strong>PyTorch Performance Breakdown</strong></h3>
<ul>
<li><p><strong>High-Level:</strong></p>
<ul>
<li>Python processing.</li>
<li>Data administrative overhead (tensor allocation, etc.).</li>
<li>Data acquisition.</li>
<li>GPU computation.</li>
</ul></li>
<li><p><strong>Data Acquisition:</strong> Often a significant bottleneck if not optimized.</p></li>
<li><p><strong>GPU Computation:</strong></p>
<ul>
<li>Fixed costs (kernel launches).</li>
<li>Memory accesses (reading inputs, writing outputs).</li>
<li>Actual computation (influenced by occupancy).</li>
</ul></li>
<li><p><strong>Rules of Thumb:</strong></p>
<ul>
<li><p>As long as you don’t have close to 100% GPU utilization in nvidia-smi, work on data acquisition etc.</p></li>
<li><p>As long as you have Tensors with a few 100s of elements, “Python is slow” and data administrative over head is single digit percentages.</p></li>
<li><p>Algorithms also matter (parallel algorithms in the following chapters)</p></li>
</ul></li>
</ul>
</section>
<section id="memory-access-as-a-bottleneck" class="level3">
<h3 class="anchored" data-anchor-id="memory-access-as-a-bottleneck"><strong>Memory Access as a Bottleneck</strong></h3>
<ul>
<li><strong>Eager PyTorch:</strong> Typically loads inputs, computes, and stores outputs for each operation.</li>
<li><strong>Fusion Benefits:</strong> Reduces memory transfers by combining multiple operations into a single kernel.</li>
<li><strong>PyTorch JIT:</strong>
<ul>
<li>First generation: Fused point-wise operations.</li>
<li>Second generation (NVFuser): Added support for contractions.</li>
</ul></li>
<li><strong>NVFuser:</strong>
<ul>
<li>Evolved beyond PyTorch.</li>
<li>Active git repository with ongoing development.
<ul>
<li><strong>GitHub Repository:</strong> <a href="https://github.com/NVIDIA/Fuser">https://github.com/NVIDIA/Fuser</a></li>
</ul></li>
</ul></li>
<li><strong>Inductor and Triton:</strong> Support more complex operations through a specialized language and templates.</li>
<li><strong>Flash Attention:</strong> Minimizes global memory accesses by leveraging shared memory effectively.</li>
</ul>
</section>
<section id="flash-attention-example" class="level3">
<h3 class="anchored" data-anchor-id="flash-attention-example"><strong>Flash Attention Example</strong></h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-004/images/flash-attention-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ul>
<li><strong>Paper:</strong> <a href="https://arxiv.org/abs/2205.14135">FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness</a></li>
<li><strong>Figure:</strong> (from the Flash Attention paper) Shows the relative speeds of different memory types.
<ul>
<li><strong>High Bandwidth Memory (HBM):</strong> 1.5 TB/s (900 GB/s on the RTX 3090).</li>
<li><strong>Shared Memory:</strong> More than 10x faster than HBM.</li>
<li><strong>Shared Memory Limitation:</strong> Significantly smaller capacity (0.2% of global memory).</li>
</ul></li>
<li><strong>Goal:</strong> Minimize global memory accesses and maximize shared memory usage.</li>
</ul>
</section>
<section id="kernel-fusion-example-approximated-gelu" class="level3">
<h3 class="anchored" data-anchor-id="kernel-fusion-example-approximated-gelu"><strong>Kernel Fusion Example: Approximated Gelu</strong></h3>
<ul>
<li><p><strong>Approximated Gelu Formula:</strong> (from <a href="https://pytorch.org/docs/stable/generated/torch.nn.GELU.html">PyTorch documentation</a>) Uses <code>tanh</code> for an approximation of the Gaussian error linear unit (GELU) activation function. <img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BGELU%7D(x)%20=%200.5%20*%20x%20*%20(1%20+%20%5Ctext%7BTanh%7D(%5Csqrt%7B2%20/%20%5Cpi%7D%20*%20(x%20+%200.044715%20*%20x%5E3)))%0A"></p></li>
<li><p><strong>PyTorch Implementation:</strong> Highly optimized, around 13.3 microseconds.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit torch.nn.functional.gelu(x, approximate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tanh'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> torch.cuda.synchronize()</span></code></pre></div>
<pre class="text"><code>13.3 μs ± 331 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)</code></pre></li>
<li><p><strong>Naive Implementation:</strong></p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> gelu(x):</span>
<span id="cb8-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Compute the Gaussian Error Linear Unit (GELU) activation function.</span></span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    GELU is defined as: GELU(x) = 0.5 * x * (1 + tanh(sqrt(2/pi) * (x + 0.044715 * x^3)))</span></span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x (torch.Tensor): Input tensor</span></span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        torch.Tensor: Output tensor after applying GELU activation</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb8-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the constant term (2/pi)^0.5</span></span>
<span id="cb8-14">    const <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.pi) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb8-15"></span>
<span id="cb8-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the inner term: x + 0.044715 * x^3</span></span>
<span id="cb8-17">    inner_term <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.044715</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb8-18"></span>
<span id="cb8-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply the GELU formula</span></span>
<span id="cb8-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> torch.tanh(const <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> inner_term))</span></code></pre></div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a random tensor of size 1024x1024 on the GPU</span></span>
<span id="cb9-2">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cuda"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure the execution time of the GELU function</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Synchronize CUDA operations to ensure accurate timing</span></span>
<span id="cb10-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit gelu(x)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> torch.cuda.synchronize()</span></code></pre></div>
<pre class="text"><code>67.2 μs ± 1.41 μs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</code></pre>
<ul>
<li>Separate kernels for each operation.</li>
<li>Significantly slower due to numerous memory accesses.</li>
</ul></li>
<li><p><strong>PyTorch Profiler:</strong> Can be used to identify individual kernel calls and their execution times.</p>
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use torch.profiler to analyze the performance of the GELU function</span></span>
<span id="cb12-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.profiler.profile() <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> prof:</span>
<span id="cb12-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure the execution time of the GELU function</span></span>
<span id="cb12-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the function 1000 times for more accurate timing</span></span>
<span id="cb12-5">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> gelu(x)</span>
<span id="cb12-6"></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print a table of key performance metrics</span></span>
<span id="cb12-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(prof.key_averages().table())</span></code></pre></div>
<div style="overflow-x:auto; max-height:500px">
<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
Name
</th>
<th>
Self CPU %
</th>
<th>
Self CPU
</th>
<th>
CPU total %
</th>
<th>
CPU total
</th>
<th>
CPU time avg
</th>
<th>
Self CUDA
</th>
<th>
Self CUDA %
</th>
<th>
CUDA total
</th>
<th>
CUDA time avg
</th>
<th>
# of Calls
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
aten::mul
</td>
<td>
30.34%
</td>
<td>
130.980ms
</td>
<td>
50.70%
</td>
<td>
218.874ms
</td>
<td>
7.817us
</td>
<td>
88.571ms
</td>
<td>
49.36%
</td>
<td>
88.571ms
</td>
<td>
3.163us
</td>
<td>
28000
</td>
</tr>
<tr>
<td>
cudaLaunchKernel
</td>
<td>
37.49%
</td>
<td>
161.833ms
</td>
<td>
37.49%
</td>
<td>
161.833ms
</td>
<td>
2.890us
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
56000
</td>
</tr>
<tr>
<td>
aten::pow
</td>
<td>
9.45%
</td>
<td>
40.780ms
</td>
<td>
14.16%
</td>
<td>
61.140ms
</td>
<td>
8.734us
</td>
<td>
20.920ms
</td>
<td>
11.66%
</td>
<td>
20.920ms
</td>
<td>
2.989us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
aten::result_type
</td>
<td>
0.18%
</td>
<td>
785.257us
</td>
<td>
0.18%
</td>
<td>
785.257us
</td>
<td>
0.112us
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
aten::to
</td>
<td>
0.14%
</td>
<td>
603.008us
</td>
<td>
0.14%
</td>
<td>
603.008us
</td>
<td>
0.086us
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
aten::add
</td>
<td>
15.28%
</td>
<td>
65.959ms
</td>
<td>
23.82%
</td>
<td>
102.833ms
</td>
<td>
7.345us
</td>
<td>
46.930ms
</td>
<td>
26.16%
</td>
<td>
46.930ms
</td>
<td>
3.352us
</td>
<td>
14000
</td>
</tr>
<tr>
<td>
aten::tanh
</td>
<td>
7.13%
</td>
<td>
30.763ms
</td>
<td>
11.32%
</td>
<td>
48.857ms
</td>
<td>
6.980us
</td>
<td>
23.008ms
</td>
<td>
12.82%
</td>
<td>
23.008ms
</td>
<td>
3.287us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
void at::native::vectorized_elementwise_kernel&lt;4, at…
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
62.472ms
</td>
<td>
34.82%
</td>
<td>
62.472ms
</td>
<td>
2.975us
</td>
<td>
21000
</td>
</tr>
<tr>
<td>
void at::native::vectorized_elementwise_kernel&lt;4, at…
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
20.920ms
</td>
<td>
11.66%
</td>
<td>
20.920ms
</td>
<td>
2.989us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
void at::native::vectorized_elementwise_kernel&lt;4, at…
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
26.045ms
</td>
<td>
14.52%
</td>
<td>
26.045ms
</td>
<td>
3.721us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
void at::native::vectorized_elementwise_kernel&lt;4, at…
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
23.008ms
</td>
<td>
12.82%
</td>
<td>
23.008ms
</td>
<td>
3.287us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
void at::native::vectorized_elementwise_kernel&lt;4, at…
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
20.886ms
</td>
<td>
11.64%
</td>
<td>
20.886ms
</td>
<td>
2.984us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
void at::native::vectorized_elementwise_kernel&lt;4, at…
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
26.099ms
</td>
<td>
14.55%
</td>
<td>
26.099ms
</td>
<td>
3.728us
</td>
<td>
7000
</td>
</tr>
<tr>
<td>
cudaDeviceSynchronize
</td>
<td>
0.00%
</td>
<td>
5.062us
</td>
<td>
0.00%
</td>
<td>
5.062us
</td>
<td>
5.062us
</td>
<td>
0.000us
</td>
<td>
0.00%
</td>
<td>
0.000us
</td>
<td>
0.000us
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
<p>
Self CPU time total: 431.709ms
</p>
<p>
Self CUDA time total: 179.430ms
</p>
</div>
<ul>
<li>Shows a large number of separate kernels for point-wise operations in the naive implementation.</li>
</ul></li>
<li><p><strong>Fused Kernel:</strong></p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define CUDA source code as a string</span></span>
<span id="cb13-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb13-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void my_gelu_kernel(float* out, float* inp, int n) {</span></span>
<span id="cb13-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Calculate global thread index</span></span>
<span id="cb13-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span></span>
<span id="cb13-6"></span>
<span id="cb13-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Return if thread index is out of bounds</span></span>
<span id="cb13-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if (i &gt;= n) return;</span></span>
<span id="cb13-9"></span>
<span id="cb13-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Load input value</span></span>
<span id="cb13-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float x = inp[i];</span></span>
<span id="cb13-12"></span>
<span id="cb13-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Compute GELU (Gaussian Error Linear Unit) activation</span></span>
<span id="cb13-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // GELU(x) = 0.5 * x * (1 + tanh(sqrt(2/π) * (x + 0.044715 * x^3)))</span></span>
<span id="cb13-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    out[i] = 0.5f * x * (1.0f + tanhf(sqrtf(2.0f/3.141592653589793f) * (x + 0.044715f * (x*x*x))));</span></span>
<span id="cb13-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-17"></span>
<span id="cb13-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor my_gelu_out(torch::Tensor output, const torch::Tensor&amp; inp) {</span></span>
<span id="cb13-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(inp);  // Validate input tensor</span></span>
<span id="cb13-20"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int n = inp.numel();  // Get total number of elements in input tensor</span></span>
<span id="cb13-21"></span>
<span id="cb13-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Ensure output tensor has same properties as input tensor</span></span>
<span id="cb13-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    TORCH_CHECK((output.sizes() == inp.sizes()) || (output.device() == inp.device())</span></span>
<span id="cb13-24"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">                || (output.scalar_type() == inp.scalar_type()));</span></span>
<span id="cb13-25"></span>
<span id="cb13-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int threads = 256;  // Set number of threads per block</span></span>
<span id="cb13-27"></span>
<span id="cb13-28"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch CUDA kernel</span></span>
<span id="cb13-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    my_gelu_kernel&lt;&lt;&lt;cdiv(n, threads), threads&gt;&gt;&gt;(</span></span>
<span id="cb13-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        output.data_ptr&lt;float&gt;(), inp.data_ptr&lt;float&gt;(), n);</span></span>
<span id="cb13-31"></span>
<span id="cb13-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();  // Check for CUDA errors</span></span>
<span id="cb13-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb13-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-35"></span>
<span id="cb13-36"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor my_gelu(const torch::Tensor&amp; inp) {</span></span>
<span id="cb13-37"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(inp);  // Validate input tensor</span></span>
<span id="cb13-38"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::empty_like(inp);  // Create output tensor with same properties as input</span></span>
<span id="cb13-39"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    my_gelu_out(output, inp);  // Compute GELU activation</span></span>
<span id="cb13-40"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb13-41"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb13-42"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span>
<span id="cb13-43"></span>
<span id="cb13-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define C++ source code as a string</span></span>
<span id="cb13-45">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb13-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor my_gelu(const torch::Tensor&amp; inp);</span></span>
<span id="cb13-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor my_gelu_out(torch::Tensor output, const torch::Tensor&amp; inp);</span></span>
<span id="cb13-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb13-49"></span>
<span id="cb13-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set environment variables for compiler paths</span></span>
<span id="cb13-51"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb13-52">os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CXX'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/usr/lib/ccache/g++-11'</span></span>
<span id="cb13-53">os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CC'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/usr/lib/ccache/gcc-11'</span></span>
<span id="cb13-54"></span>
<span id="cb13-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load and compile the CUDA extension</span></span>
<span id="cb13-56">gelu_module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.utils.cpp_extension.load_inline(</span>
<span id="cb13-57">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_ext_gelu"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Name of the extension</span></span>
<span id="cb13-58">    cpp_src,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ source code</span></span>
<span id="cb13-59">    cuda_src,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA source code</span></span>
<span id="cb13-60">    functions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'my_gelu'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'my_gelu_out'</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functions to expose</span></span>
<span id="cb13-61">    extra_cuda_cflags<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--ptxas-options=-v'</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Additional CUDA compiler flags</span></span>
<span id="cb13-62">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enable verbose output during compilation</span></span>
<span id="cb13-63">)</span></code></pre></div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit gelu_module.my_gelu(x)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span> torch.cuda.synchronize()</span></code></pre></div>
<pre class="text"><code>17 μs ± 246 ns per loop (mean ± std. dev. of 7 runs, 100,000 loops each)</code></pre>
<ul>
<li>Combines all operations into a single C++ kernel.</li>
<li>Slightly slower than PyTorch’s implementation (tested on an RTX 4090 with PyTorch 2.4.0).</li>
</ul></li>
<li><p><strong>Numerical Accuracy:</strong> Results are the same as PyTorch’s implementation, “up to numerical accuracy.”</p></li>
</ul>
</section>
<section id="numerical-accuracy-and-floating-point-operations" class="level3">
<h3 class="anchored" data-anchor-id="numerical-accuracy-and-floating-point-operations"><strong>Numerical Accuracy and Floating Point Operations</strong></h3>
<ul>
<li><strong>Floating Point Addition:</strong> Not strictly associative due to limited precision.
<ul>
<li>The order of operations can affect the result, especially when adding numbers with vastly different magnitudes.</li>
<li><strong>Example:</strong> Adding a very small number to a large number might result in no change if the small number is below the precision threshold.</li>
</ul></li>
<li><strong>Relative Accuracy:</strong>
<ul>
<li>FP32: Typically around 10⁻⁷ or 10⁻⁸.</li>
<li>FP64: Higher precision.</li>
</ul></li>
</ul>
</section>
<section id="theoretical-maximum-speed-level-rgb-to-gray-kernel" class="level3">
<h3 class="anchored" data-anchor-id="theoretical-maximum-speed-level-rgb-to-gray-kernel"><strong>Theoretical Maximum Speed: Level RGB to Gray Kernel</strong></h3>
<ul>
<li><strong>Kernel Operations:</strong>
<ul>
<li>Load 3 bytes (R, G, B).</li>
<li>Compute index (1 multiplication, 1 addition - INT32).</li>
<li>Compute grayscale value (3 multiplications, 2 additions - FP32).</li>
<li>Data conversion.</li>
<li>Store 1 byte.</li>
</ul></li>
<li><strong>Memory Bandwidth (RTX 3090):</strong> 900 GB/s.</li>
<li><strong>Image Size:</strong> 2048 x 2048.</li>
<li><strong>Theoretical Memory Transfer Time (“Speed of Light”):</strong> ~18 microseconds (assuming ideal access patterns).</li>
<li><strong>Compute Performance (RTX 3090):</strong>
<ul>
<li>FP32: 35.6 TFLOPs.</li>
<li>INT32: 16.8 TFLOPs.</li>
</ul></li>
<li><strong>Theoretical Compute Time:</strong> ~2 microseconds (excluding parallelism and memory latency).</li>
<li><strong>Kernel Launch Overhead:</strong> ~3 microseconds (measured using an empty kernel).</li>
<li><strong>Measured Kernel Time:</strong> ~26-27 microseconds.</li>
<li><strong>Efficiency:</strong> Achieves about 75% of the theoretical maximum speed.</li>
</ul>
</section>
<section id="roofline-model" class="level3">
<h3 class="anchored" data-anchor-id="roofline-model"><strong>Roofline Model</strong></h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-004/images/roofline-model.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ul>
<li><strong>Purpose:</strong> Helps analyze the performance limitations of a kernel.</li>
<li><strong>Computational Intensity:</strong> Key metric, defined as the number of floating-point operations (FLOPs) per byte of memory transfer.</li>
<li><strong>Memory-Bound Kernels:</strong>
<ul>
<li>Low computational intensity.</li>
<li>Performance limited by memory bandwidth.</li>
<li>Throughput limited by the diagonal line in the roofline model representing memory bandwidth.</li>
</ul></li>
<li><strong>Compute-Bound Kernels:</strong>
<ul>
<li>High computational intensity.</li>
<li>Performance limited by the GPU’s compute capabilities.</li>
<li>Throughput limited by the horizontal line in the roofline model representing peak compute performance.</li>
</ul></li>
<li><strong>Roofline Shape:</strong> The characteristic “roof” shape arises from the fact that memory latency can be hidden if other warps can compute while one warp waits for memory.
<ul>
<li>The performance becomes the maximum of the memory bandwidth and compute throughput, leading to the minimum of the two limiting factors.</li>
</ul></li>
</ul>
</section>
<section id="gpu-memory-hierarchy" class="level3">
<h3 class="anchored" data-anchor-id="gpu-memory-hierarchy"><strong>GPU Memory Hierarchy</strong></h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-004/images/cuda-device-memory-model.png" class="img-fluid figure-img"></p>
<figcaption>Figure 5.2</figcaption>
</figure>
</div>
<table class="caption-top table">
<colgroup>
<col style="width: 60%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th>Variable declaration</th>
<th>Memory</th>
<th>Scope</th>
<th>Lifetime</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Automatic variables other than arrays</td>
<td>Register</td>
<td>Thread</td>
<td>Grid</td>
</tr>
<tr class="even">
<td>Automatic array variables</td>
<td>Local</td>
<td>Thread</td>
<td>Grid</td>
</tr>
<tr class="odd">
<td><code>__device__ __shared__ int SharedVar;</code></td>
<td>Shared</td>
<td>Block</td>
<td>Grid</td>
</tr>
<tr class="even">
<td><code>__device__ int GlobalVar;</code></td>
<td>Global</td>
<td>Grid</td>
<td>Application</td>
</tr>
<tr class="odd">
<td><code>__device__ __constant__ int ConstVar;</code></td>
<td>Constant</td>
<td>Grid</td>
<td>Application</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Registers:</strong> Fastest, used for local variables within a thread.</li>
<li><strong>Local Memory:</strong> Slower than registers, used for arrays declared within a thread or for register spills.</li>
<li><strong>Shared Memory:</strong> Per-block memory, faster than global memory, accessible by all threads in a block, declared using <code>__shared__</code>.</li>
<li><strong>Global Memory:</strong> Main GPU memory, accessible by all threads, typically accessed through pointers.</li>
<li><strong>Constant Memory:</strong> Read-only memory, cached, used for kernel launch parameters and can be explicitly declared.</li>
</ul>
</section>
<section id="shared-memory-and-tiling" class="level3">
<h3 class="anchored" data-anchor-id="shared-memory-and-tiling"><strong>Shared Memory and Tiling</strong></h3>
<ul>
<li><p><strong>Tiling:</strong> A technique to improve data locality by loading data from global memory into shared memory and reusing it multiple times within a block.</p></li>
<li><p><strong>Matrix Multiplication Example:</strong></p>
<ul>
<li><p><strong>Naive Approach:</strong> Each output element reads 2n inputs from global memory n times.</p>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA kernel for matrix multiplication</span></span>
<span id="cb16-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb16-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void simple_matmul_k(float* m, float* n, float* out, int h, int w, int k) {</span></span>
<span id="cb16-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Calculate global thread indices</span></span>
<span id="cb16-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r = blockIdx.y*blockDim.y + threadIdx.y;</span></span>
<span id="cb16-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int c = blockIdx.x*blockDim.x + threadIdx.x;</span></span>
<span id="cb16-7"></span>
<span id="cb16-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Boundary check</span></span>
<span id="cb16-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if (r&gt;=h || c&gt;=w) return;</span></span>
<span id="cb16-10"></span>
<span id="cb16-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float o = 0;</span></span>
<span id="cb16-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Perform dot product for this element</span></span>
<span id="cb16-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (int i = 0; i&lt;k; ++i) o += m[r*k+i] * n[i*w+c];</span></span>
<span id="cb16-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    out[r*w+c] = o;</span></span>
<span id="cb16-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-16"></span>
<span id="cb16-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor simple_matmul(const torch::Tensor&amp; m, const torch::Tensor&amp; n) {</span></span>
<span id="cb16-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(m); CHECK_INPUT(n);</span></span>
<span id="cb16-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int h = m.size(0);</span></span>
<span id="cb16-20"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int w = n.size(1);</span></span>
<span id="cb16-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int k = m.size(1);</span></span>
<span id="cb16-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    TORCH_CHECK(k==n.size(0), "Size mismatch!");</span></span>
<span id="cb16-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::zeros({h, w}, m.options());</span></span>
<span id="cb16-24"></span>
<span id="cb16-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Define thread block and grid dimensions</span></span>
<span id="cb16-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 tpb(16,16);</span></span>
<span id="cb16-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 blocks(cdiv(w, tpb.x), cdiv(h, tpb.y));</span></span>
<span id="cb16-28"></span>
<span id="cb16-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch CUDA kernel</span></span>
<span id="cb16-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    simple_matmul_k&lt;&lt;&lt;blocks, tpb&gt;&gt;&gt;(</span></span>
<span id="cb16-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        m.data_ptr&lt;float&gt;(), n.data_ptr&lt;float&gt;(), output.data_ptr&lt;float&gt;(), h, w, k);</span></span>
<span id="cb16-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb16-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb16-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb16-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span>
<span id="cb16-36"></span>
<span id="cb16-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ function declaration</span></span>
<span id="cb16-38">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb16-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor simple_matmul(const torch::Tensor&amp; m, const torch::Tensor&amp; n);</span></span>
<span id="cb16-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb16-41"></span>
<span id="cb16-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the custom CUDA extension</span></span>
<span id="cb16-43">simple_matmul_module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.utils.cpp_extension.load_inline(</span>
<span id="cb16-44">    name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_ext_simple_matmul"</span>,</span>
<span id="cb16-45">    cpp_sources<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cpp_src,</span>
<span id="cb16-46">    cuda_sources<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cuda_src,</span>
<span id="cb16-47">    functions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'simple_matmul'</span>],</span>
<span id="cb16-48">    extra_cuda_cflags<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--ptxas-options=-v'</span>],</span>
<span id="cb16-49">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb16-50">)</span></code></pre></div>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create two random 1024x1024 matrices on the GPU</span></span>
<span id="cb17-2">a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cuda"</span>)</span>
<span id="cb17-3">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1024</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cuda"</span>)</span>
<span id="cb17-4"></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Benchmark the custom matrix multiplication function</span></span>
<span id="cb17-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit simple_matmul_module.simple_matmul(a, b)</span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the maximum absolute difference between custom and built-in matrix multiplication</span></span>
<span id="cb17-9">max_diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (simple_matmul_module.simple_matmul(a, b) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>b).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()</span></code></pre></div>
<pre class="text"><code>426 μs ± 9.98 μs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)</code></pre></li>
<li><p><strong>Tiling:</strong> Reduces the number of global memory accesses by reading input tiles into shared memory and reusing them for multiple output tiles.</p>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Constants and CUDA kernel definition</span></span>
<span id="cb19-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"""</span></span>
<span id="cb19-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">constexpr int TILE_SIZE = 16;  // Size of each tile for matrix multiplication</span></span>
<span id="cb19-4"></span>
<span id="cb19-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb19-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @brief Tiled matrix multiplication kernel.</span></span>
<span id="cb19-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb19-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * This kernel performs matrix multiplication using shared memory tiles to improve performance.</span></span>
<span id="cb19-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb19-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param out Pointer to the output matrix</span></span>
<span id="cb19-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param M Pointer to the first input matrix</span></span>
<span id="cb19-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param N Pointer to the second input matrix</span></span>
<span id="cb19-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param h Height of matrix M</span></span>
<span id="cb19-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param w Width of matrix N</span></span>
<span id="cb19-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param k Width of matrix M / Height of matrix N</span></span>
<span id="cb19-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb19-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void tiled_matmul_kernel(float* out, float* M, float* N, int h, int w, int k) {</span></span>
<span id="cb19-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    __shared__ float M_tile[TILE_SIZE][TILE_SIZE];  // Shared memory for M matrix tile</span></span>
<span id="cb19-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    __shared__ float N_tile[TILE_SIZE][TILE_SIZE];  // Shared memory for N matrix tile</span></span>
<span id="cb19-20"></span>
<span id="cb19-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Thread indices within a tile</span></span>
<span id="cb19-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int ir = threadIdx.y;</span></span>
<span id="cb19-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int ic = threadIdx.x;</span></span>
<span id="cb19-24"></span>
<span id="cb19-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Global thread indices</span></span>
<span id="cb19-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r = blockIdx.y * blockDim.y + threadIdx.y;</span></span>
<span id="cb19-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int c = blockIdx.x * blockDim.x + threadIdx.x;</span></span>
<span id="cb19-28"></span>
<span id="cb19-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    float res = 0.0f;  // Accumulator for dot product result</span></span>
<span id="cb19-30"></span>
<span id="cb19-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Iterate over tiles</span></span>
<span id="cb19-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (int K_tileidx = 0; K_tileidx &lt; (k + TILE_SIZE -1) / TILE_SIZE; K_tileidx++) {</span></span>
<span id="cb19-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Load data into shared memory tiles, with bounds checking</span></span>
<span id="cb19-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        M_tile[ir][ic] = (((r &lt; h) &amp;&amp; (K_tileidx * TILE_SIZE + ic &lt; k)) ? M[r * k + K_tileidx * TILE_SIZE + ic] : 0.f);</span></span>
<span id="cb19-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        N_tile[ir][ic] = ((((K_tileidx * TILE_SIZE + ir) &lt; k) &amp;&amp; (c &lt; w)) ? N[(K_tileidx * TILE_SIZE + ir) * w + c] : 0.f);</span></span>
<span id="cb19-36"></span>
<span id="cb19-37"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        __syncthreads();  // Ensure all threads have loaded data before computation</span></span>
<span id="cb19-38"></span>
<span id="cb19-39"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Compute dot product for this tile</span></span>
<span id="cb19-40"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        for (int idx = 0; idx &lt; TILE_SIZE; idx++) {</span></span>
<span id="cb19-41"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">           res += M_tile[ir][idx] * N_tile[idx][ic];</span></span>
<span id="cb19-42"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        }</span></span>
<span id="cb19-43"></span>
<span id="cb19-44"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        __syncthreads();  // Ensure all computations are done before loading next tile</span></span>
<span id="cb19-45"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb19-46"></span>
<span id="cb19-47"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Write result to global memory if within bounds</span></span>
<span id="cb19-48"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if ((r &lt; h) &amp;&amp; (c &lt; w)) {</span></span>
<span id="cb19-49"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        out[r * w + c] = res;</span></span>
<span id="cb19-50"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb19-51"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-52"></span>
<span id="cb19-53"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb19-54"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @brief Wrapper function for tiled matrix multiplication kernel.</span></span>
<span id="cb19-55"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb19-56"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * This function checks input tensors, sets up kernel parameters, and launches the CUDA kernel.</span></span>
<span id="cb19-57"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb19-58"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param m First input matrix</span></span>
<span id="cb19-59"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param n Second input matrix</span></span>
<span id="cb19-60"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @return torch::Tensor Result of matrix multiplication</span></span>
<span id="cb19-61"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb19-62"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor tiled_matmul(const torch::Tensor&amp; m, const torch::Tensor&amp; n) {</span></span>
<span id="cb19-63"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(m); CHECK_INPUT(n);</span></span>
<span id="cb19-64"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int h = m.size(0);</span></span>
<span id="cb19-65"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int w = n.size(1);</span></span>
<span id="cb19-66"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int k = m.size(1);</span></span>
<span id="cb19-67"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    TORCH_CHECK(k==n.size(0), "Size mismatch");</span></span>
<span id="cb19-68"></span>
<span id="cb19-69"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::empty({h, w}, m.options());</span></span>
<span id="cb19-70"></span>
<span id="cb19-71"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Define thread block and grid dimensions</span></span>
<span id="cb19-72"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 tpb(TILE_SIZE, TILE_SIZE);</span></span>
<span id="cb19-73"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 blocks(cdiv(w, tpb.x), cdiv(h, tpb.y));</span></span>
<span id="cb19-74"></span>
<span id="cb19-75"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch kernel</span></span>
<span id="cb19-76"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    tiled_matmul_kernel&lt;&lt;&lt;blocks, tpb&gt;&gt;&gt;(</span></span>
<span id="cb19-77"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        output.data_ptr&lt;float&gt;(), m.data_ptr&lt;float&gt;(), n.data_ptr&lt;float&gt;(), h, w, k);</span></span>
<span id="cb19-78"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb19-79"></span>
<span id="cb19-80"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb19-81"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb19-82"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-83"></span>
<span id="cb19-84"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ interface definition</span></span>
<span id="cb19-85">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-86"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor tiled_matmul(const torch::Tensor&amp; m, const torch::Tensor&amp; n);</span></span>
<span id="cb19-87"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-88"></span>
<span id="cb19-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the CUDA kernel as a PyTorch C++ extension</span></span>
<span id="cb19-90">tiled_matmul_module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.utils.cpp_extension.load_inline(</span>
<span id="cb19-91">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test_ext_tiled_matmul"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Name of the extension</span></span>
<span id="cb19-92">    cpp_src,                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ interface</span></span>
<span id="cb19-93">    cuda_src,                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA source code</span></span>
<span id="cb19-94">    functions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tiled_matmul'</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exported functions</span></span>
<span id="cb19-95">    extra_cuda_cflags<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--ptxas-options=-v'</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Additional CUDA compilation flags</span></span>
<span id="cb19-96">    verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Enable verbose output during compilation</span></span>
<span id="cb19-97">)</span></code></pre></div>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit tiled_matmul_module.tiled_matmul(a, b)</span></code></pre></div>
<pre class="text"><code>323 μs ± 2.73 μs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</code></pre></li>
</ul></li>
<li><p><strong>Tiled Matrix Multiplication (Square Matrices):</strong></p>
<ul>
<li><strong>Tile Size:</strong> A parameter that determines the size of the tiles.</li>
<li><strong>Thread Block:</strong> Typically, the tile size squared (e.g., <code>16x16</code> threads for a tile size of <code>16</code>).</li>
<li><strong>Shared Memory:</strong> Two shared memory arrays to store tiles from matrices A and B.</li>
<li><strong>Algorithm:</strong>
<ol type="1">
<li>Load tiles from global memory into shared memory.</li>
<li>Perform matrix multiplication within the tiles using shared memory.</li>
<li>Loop over all tiles to compute the complete result.</li>
<li>Store the result back to global memory.</li>
</ol></li>
</ul></li>
<li><p><strong>Synchronization:</strong> <code>__syncthreads()</code> is crucial to ensure that all threads have finished reading/writing to shared memory before proceeding.</p></li>
<li><p><strong>Padding:</strong> For matrices where the size is not a multiple of the tile size, padding with zeros is used to complete the tiles.</p></li>
<li><p><strong>Performance Improvement:</strong> Reduces memory accesses and improves performance (e.g., from 426 microseconds to 323 microseconds in the example).</p></li>
</ul>
</section>
<section id="future-considerations" class="level3">
<h3 class="anchored" data-anchor-id="future-considerations"><strong>Future Considerations</strong></h3>
<ul>
<li><strong>Thread Coarsening:</strong>
<ul>
<li><strong>Concept:</strong> Increasing the amount of work done by each thread to improve performance.</li>
<li><strong>Application to Tiling:</strong> Allows for larger tile sizes.</li>
<li><strong>Details:</strong> Covered in the next session.</li>
</ul></li>
<li><strong>Flash Attention Implementation:</strong>
<ul>
<li><strong>Exercise:</strong> Implement the original Flash Attention algorithm from scratch based on the pseudocode.</li>
<li><strong>Key Aspect:</strong> Blocking of inputs and output for efficient kernel fusion.</li>
</ul></li>
</ul>
</section>
</section>
<section id="conclusions-and-key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="conclusions-and-key-takeaways"><strong>Conclusions and Key Takeaways</strong></h2>
<section id="gpu-computation" class="level3">
<h3 class="anchored" data-anchor-id="gpu-computation"><strong>GPU Computation:</strong></h3>
<ul>
<li>GPUs use a hierarchy of threads, warps, and blocks to organize computation.</li>
<li>Understanding the hardware architecture and scheduling is crucial for performance optimization.</li>
<li>Occupancy, a measure of resource utilization, should be maximized.</li>
<li>Thread divergence should be minimized.</li>
</ul>
</section>
<section id="memory-management" class="level3">
<h3 class="anchored" data-anchor-id="memory-management"><strong>Memory Management:</strong></h3>
<ul>
<li>Memory accesses are often a major bottleneck.</li>
<li>Kernel fusion can reduce memory transfers.</li>
<li>The roofline model provides insights into the performance limitations of a kernel.</li>
<li>Tiling is a powerful technique to improve data locality by leveraging shared memory.</li>
</ul>
</section>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps"><strong>Next Steps:</strong></h3>
<ul>
<li>The next chapter will focus on <strong>coalesced memory access</strong>, a technique to optimize global memory reads and writes for maximum efficiency.</li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/lecture-004/</guid>
  <pubDate>Sat, 31 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>CUDA MODE Lecture 3: Getting Started With CUDA for Python Programmers</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/cuda-mode-notes/lecture-003/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/cuda-mode-notes.html"><strong>CUDA Mode Lecture Notes</strong></a>: My notes from the <strong>CUDA MODE</strong> reading group lectures run by <strong>Andreas Kopf</strong> and <strong>Mark Saroufim</strong>.</li>
</ul>
</div>
</div>
<ul>
<li>Introduction</li>
<li>Setup</li>
<li>Exercise 1: RGB to Grayscale Conversion<br>
</li>
<li>Exercise 2: Matrix Multiplication<br>
</li>
<li>Conclusion and Next Steps</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Resource Links">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Resource Links
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>YouTube Recording:</strong> <a href="https://www.youtube.com/watch?v=4sgKnKbR-WE&amp;t=2715s">Lecture 3: Getting Started With CUDA for Python Programmers</a></li>
<li><strong>Jupyter Notebook:</strong> <a href="https://github.com/cuda-mode/lectures/blob/main/lecture_003/pmpp.ipynb">lecture_003/pmpp.ipynb</a></li>
<li><strong>Google Colab:</strong> <a href="https://colab.research.google.com/drive/180uk6frvMBeT4tywhhYXmz3PJaCIA_uk?usp=sharing">lecture_003/pmpp.ipynb</a>
<ul>
<li>Select the T4 GPU runtime in Colab.</li>
</ul></li>
<li><strong>Textbook:</strong> <a href="https://www.amazon.com/Programming-Massively-Parallel-Processors-Hands/dp/0323912311/">Programming Massively Parallel Processors</a></li>
</ul>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li><strong>CUDA (Compute Unified Device Architecture):</strong> A parallel computing platform and programming model developed by NVIDIA for programming NVIDIA GPUs.</li>
<li>Enables high-performance computing and maximum flexibility.</li>
<li>Has a reputation for being difficult to learn, but can be approachable with the right techniques.</li>
<li><strong>Prerequisites:</strong>
<ul>
<li><strong>Basic PyTorch Knowledge</strong>:
<ul>
<li>Familiarity with tensors, indexing, and basic operations.</li>
<li><strong>Recommended:</strong> <a href="https://course.fast.ai/">Practical Deep Learning for Coders</a> (especially Part 1).</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<ul>
<li><p><strong>Import Dependencies:</strong></p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Core libraries for various functionalities</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PyTorch library for deep learning</span></span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Operating system interfaces</span></span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mathematical functions</span></span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gzip   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compression/decompression using gzip</span></span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pickle <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Object serialization</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plotting library</span></span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For downloading files from URLs</span></span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> urllib.request <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> urlretrieve</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># File and directory handling</span></span>
<span id="cb1-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Specific PyTorch imports</span></span>
<span id="cb1-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tensor  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tensor data structure</span></span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Computer vision libraries</span></span>
<span id="cb1-21"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torchvision <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tv  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PyTorch's computer vision library</span></span>
<span id="cb1-22"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torchvision.transforms.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> tvf  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functional image transformations</span></span>
<span id="cb1-23"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torchvision <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> io  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I/O operations for images and videos</span></span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For loading custom CUDA extensions</span></span>
<span id="cb1-26"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.utils.cpp_extension <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_inline, CUDA_HOME</span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify the CUDA install path </span></span>
<span id="cb1-29"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(CUDA_HOME)</span></code></pre></div>
<pre class="text"><code>/home/innom-dt/mambaforge/envs/cuda-mode</code></pre></li>
</ul>
</section>
<section id="exercise-1-rgb-to-grayscale-conversion" class="level2">
<h2 class="anchored" data-anchor-id="exercise-1-rgb-to-grayscale-conversion">Exercise 1: RGB to Grayscale Conversion</h2>
<section id="understanding-the-problem" class="level3">
<h3 class="anchored" data-anchor-id="understanding-the-problem">1. Understanding the Problem</h3>
<ul>
<li><strong>Goal:</strong> Convert an RGB color image to a grayscale image.</li>
<li><strong>Formula:</strong> Grayscale (luminance) = 0.2989 * Red + 0.5870 * Green +0.1140 * Blue</li>
<li>This formula is a standard way to calculate luminance from RGB values.</li>
</ul>
</section>
<section id="loading-and-displaying-the-image" class="level3">
<h3 class="anchored" data-anchor-id="loading-and-displaying-the-image">2. Loading and Displaying the Image</h3>
<ul>
<li><p><strong>Image Source:</strong> A puppy image downloaded from a URL.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> download_image(url: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, path: Path) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb3-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Download an image from a given URL and save it to the specified path.</span></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        url (str): The URL of the image to download.</span></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        path (Path): The local path where the image will be saved.</span></span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        None</span></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> path.exists():</span>
<span id="cb3-13">        urlretrieve(url, path)</span></code></pre></div>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># URL of the image to be downloaded</span></span>
<span id="cb4-2">url <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/Cute_dog.jpg/1600px-Cute_dog.jpg?20140729055059'</span></span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the local path where the image will be saved</span></span>
<span id="cb4-5">path_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'puppy.jpg'</span>)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download the image if it doesn't exist locally</span></span>
<span id="cb4-8">download_image(url, path_img)</span></code></pre></div></li>
<li><p><strong>Loading:</strong> Use <code>torchvision.io.read_image</code> to load the image.</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read the downloaded image</span></span>
<span id="cb5-2">img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> io.read_image(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'puppy.jpg'</span>)</span></code></pre></div></li>
<li><p><strong>Image Shape:</strong> The image is a 3D tensor with dimensions (channels, height, width).</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print the shape of the image (channels, height, width)</span></span>
<span id="cb6-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(img.shape)</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display a small portion of the image data (top-left corner)</span></span>
<span id="cb6-5">img[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span></code></pre></div>
<pre class="text"><code>torch.Size([3, 1066, 1600])

tensor([[[117, 119, 117, 113],
         [119, 129, 129, 113],
         [130, 126, 122, 115]],

        [[ 83,  85,  85,  80],
         [ 85,  97,  97,  82],
         [ 98,  93,  89,  83]]], dtype=torch.uint8)</code></pre>
<ul>
<li><strong>Shape:</strong> (3, 1066, 1600) means 3 channels (RGB), 1066 rows (height), 1600 columns (width).</li>
</ul></li>
<li><p><strong>Data Type:</strong> The image pixels are stored as unsigned 8-bit integers (bytes).</p></li>
<li><p><strong>Displaying:</strong> Use a custom <code>showImage</code> function that uses <code>matplotlib</code> to display the image.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> show_img(x, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb8-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Display an image using matplotlib.</span></span>
<span id="cb8-4"></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb8-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x (Tensor): The image tensor to display.</span></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        figsize (tuple): The size of the figure (width, height).</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        **kwargs: Additional keyword arguments to pass to plt.imshow().</span></span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        None</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb8-13">    plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>figsize)</span>
<span id="cb8-14">    plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb8-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x.shape) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>:</span>
<span id="cb8-16">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.permute(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert from CHW to HWC format</span></span>
<span id="cb8-17">    plt.imshow(x.cpu(), <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span></code></pre></div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Resize the image to a height of 150 pixels while maintaining aspect ratio</span></span>
<span id="cb9-2">img2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tvf.resize(img, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, antialias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the dimensions of the resized image</span></span>
<span id="cb9-5">ch, h, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> img2.shape</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print the channel count, height, width, and total number of pixels</span></span>
<span id="cb9-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(ch, h, w, h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w)</span>
<span id="cb9-9"></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the resized image</span></span>
<span id="cb9-11">show_img(img2)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-003/images/output_8_1.png" class="img-fluid figure-img"></p>
<figcaption>resized image</figcaption>
</figure>
</div>
<ul>
<li>Resizes the image to a smaller size (smallest dimension = 150) for faster processing in the initial Python example.</li>
</ul></li>
</ul>
</section>
<section id="grayscale-conversion-in-python" class="level3">
<h3 class="anchored" data-anchor-id="grayscale-conversion-in-python">3. Grayscale Conversion in Python</h3>
<ul>
<li><p><strong>Approach:</strong> Iterate through every pixel and apply the gray scale formula.</p></li>
<li><p><strong>Implementation:</strong></p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> rgb2grey_py(x):</span>
<span id="cb10-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Convert an RGB image to grayscale.</span></span>
<span id="cb10-4"></span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x (torch.Tensor): Input RGB image tensor of shape (C, H, W).</span></span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        torch.Tensor: Grayscale image tensor of shape (H, W).</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-11">    c, h, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.shape</span>
<span id="cb10-12">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w</span>
<span id="cb10-13">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.flatten()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten the input tensor</span></span>
<span id="cb10-14">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty(n, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.device)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize result tensor</span></span>
<span id="cb10-15"></span>
<span id="cb10-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert RGB to grayscale using weighted sum</span></span>
<span id="cb10-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb10-18">        res[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2989</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5870</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1140</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n]</span>
<span id="cb10-19"></span>
<span id="cb10-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> res.view(h, w)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape result to original dimensions</span></span></code></pre></div>
<ul>
<li>Flatten the image into a 1D vector to simplify indexing.
<ul>
<li>Flattening arranges the pixels in memory linearly
<ul>
<li>(channel 1, row 1, col 1, channel 1, row 1, col 2, etc.).</li>
</ul></li>
</ul></li>
<li>Calculate the luminance for each pixel using the formula and store it in an output vector.</li>
<li>Reshape the output vector back into a 2D matrix (height, width).</li>
</ul></li>
<li><p><strong>Performance:</strong> This Python implementation is very slow (726 ms for a small image).</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert image to grayscale and display</span></span>
<span id="cb11-3">img_g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rgb2grey_py(img2)</span>
<span id="cb11-4">show_img(img_g, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>)</span></code></pre></div>
<pre class="text"><code>CPU times: user 724 ms, sys: 51 μs, total: 724 ms
Wall time: 726 ms</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-003/images/output_13_1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div></li>
</ul>
</section>
<section id="understanding-cuda-and-gpus" class="level3">
<h3 class="anchored" data-anchor-id="understanding-cuda-and-gpus">4. Understanding CUDA and GPUs</h3>
<ul>
<li><strong>CUDA Speedup:</strong> CUDA enables significant speedup by utilizing the parallel processing capabilities of GPUs.</li>
<li><strong>GPU Architecture:</strong>
<ul>
<li><strong>Streaming Multiprocessors (SMs):</strong> Independent processing units within a GPU (e.g., 82 in an RTX 3090).</li>
<li><strong>CUDA Cores:</strong> Parallel processing units within each SM (e.g., 128 per SM in an RTX 3090).</li>
<li>An RTX 3090 has 10,496 CUDA cores that can operate simultaneously.</li>
</ul></li>
<li><strong>CUDA Programming Model:</strong>
<ul>
<li><strong>Kernels:</strong> Functions designed to be executed in parallel on many CUDA cores.</li>
<li><strong>Parallel Execution:</strong> CUDA automatically distributes the kernel execution across multiple CUDA cores.</li>
<li><strong>Memory Modification:</strong> Kernels primarily modify memory; they do not return values directly.</li>
</ul></li>
</ul>
</section>
<section id="simulating-a-cuda-kernel-in-python" class="level3">
<h3 class="anchored" data-anchor-id="simulating-a-cuda-kernel-in-python">5. Simulating a CUDA Kernel in Python</h3>
<ul>
<li><p><strong>Limitations:</strong> This simulation does not run in parallel and is not faster than the original Python loop.</p></li>
<li><p><strong>Purpose:</strong> To demonstrate the conceptual behavior of a CUDA kernel.</p></li>
<li><p><strong><code>runKernel</code> Function:</strong> Simulates a CUDA kernel execution in Python using a single for loop.</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> run_kernel(f, times, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args):</span>
<span id="cb13-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Run a kernel function multiple times.</span></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb13-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        f (function): Kernel function to run.</span></span>
<span id="cb13-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        times (int): Number of times to run the kernel.</span></span>
<span id="cb13-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        *args: Additional arguments to pass to the kernel function.</span></span>
<span id="cb13-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb13-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(times):</span>
<span id="cb13-11">        f(i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args)</span></code></pre></div>
<ul>
<li>Takes a function, the number of times to run it, and arguments as input.</li>
<li>Calls the function repeatedly with an index and the provided arguments.</li>
</ul></li>
<li><p><strong>Grayscale Conversion (Simulated Kernel)</strong>:</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> rgb2grey_k(i, x, out, n):</span>
<span id="cb14-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Kernel function for RGB to grayscale conversion.</span></span>
<span id="cb14-4"></span>
<span id="cb14-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        i (int): Current index.</span></span>
<span id="cb14-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x (torch.Tensor): Flattened input RGB tensor.</span></span>
<span id="cb14-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out (torch.Tensor): Output grayscale tensor.</span></span>
<span id="cb14-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (int): Number of pixels in a single channel.</span></span>
<span id="cb14-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb14-11">    out[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2989</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5870</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> n] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1140</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n]</span></code></pre></div>
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> rgb2grey_pyk(x):</span>
<span id="cb15-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Convert an RGB image to grayscale using a kernel approach.</span></span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x (torch.Tensor): Input RGB image tensor of shape (C, H, W).</span></span>
<span id="cb15-7"></span>
<span id="cb15-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb15-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        torch.Tensor: Grayscale image tensor of shape (H, W).</span></span>
<span id="cb15-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb15-11">    c, h, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.shape</span>
<span id="cb15-12">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w</span>
<span id="cb15-13">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.flatten()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten the input tensor</span></span>
<span id="cb15-14">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty(n, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.device)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize result tensor</span></span>
<span id="cb15-15"></span>
<span id="cb15-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply the kernel function to convert RGB to grayscale</span></span>
<span id="cb15-17">    run_kernel(rgb2grey_k, h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w, x, res, n)</span>
<span id="cb15-18"></span>
<span id="cb15-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> res.view(h, w)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape result to original dimensions</span></span></code></pre></div>
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert image to grayscale using kernel approach and display</span></span>
<span id="cb16-2">img_g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rgb2grey_pyk(img2)</span>
<span id="cb16-3">show_img(img_g, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-003/images/output_19_0.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ul>
<li><strong>Call <code>runKernel</code></strong>: Pass the grayscale conversion logic as the kernel function.</li>
<li><strong>No Parallelism</strong>: This simulation does not achieve true parallelism, but demonstrates the concept.</li>
</ul></li>
</ul>
</section>
<section id="cuda-blocks-and-threads" class="level3">
<h3 class="anchored" data-anchor-id="cuda-blocks-and-threads">6. CUDA Blocks and Threads</h3>
<ul>
<li><p><strong>Blocks and Threads:</strong> CUDA organizes kernel execution into blocks and threads.</p>
<ul>
<li><strong>Blocks:</strong> Groups of threads.</li>
<li><strong>Threads:</strong> Individual execution units within a block.</li>
</ul></li>
<li><p><strong>Kernel Runner with Blocks and Threads:</strong></p>
<ul>
<li>CUDA kernel execution is simulated using nested for loops (one for blocks, one for threads).</li>
<li>Each thread gets a unique index calculated from its block index and thread index.</li>
</ul></li>
<li><p><strong>Reason for Blocks and Threads:</strong></p>
<ul>
<li><strong>Shared Memory:</strong> Threads within a block share a small, fast memory space (shared memory).
<ul>
<li>256 KB Register File &amp; 128 KB of L1/Shared Memory in an RTX 3090</li>
</ul></li>
<li><strong>Synchronization:</strong> Threads within a block can synchronize their execution.</li>
<li><strong>Streaming Multiprocessor (SM) Execution:</strong> All threads within a block are executed on the same SM.</li>
</ul></li>
<li><p><strong>Choosing Block and Thread Dimensions:</strong></p>
<ul>
<li><strong>Threads per Block:</strong> Often set to 256 as a default.</li>
<li><strong>Number of Blocks:</strong> Calculated based on the total number of iterations needed and the threads per block.</li>
</ul></li>
<li><p><strong>Guard Block:</strong> An <code>if</code> statement within the kernel to prevent out-of-bounds memory access due to potential block size mismatches.</p></li>
<li><p><strong>Python Block Kernel:</strong></p>
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> blk_kernel(f, blocks, threads, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args):</span>
<span id="cb17-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb17-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Simulate a GPU-like block and thread execution model.</span></span>
<span id="cb17-4"></span>
<span id="cb17-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function emulates the behavior of GPU kernels by executing a given function</span></span>
<span id="cb17-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    across a specified number of blocks and threads.</span></span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb17-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        f (function): The function to be executed in a block-thread manner.</span></span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blocks (int): The number of blocks to simulate.</span></span>
<span id="cb17-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threads (int): The number of threads per block to simulate.</span></span>
<span id="cb17-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        *args: Additional arguments to be passed to the function f.</span></span>
<span id="cb17-13"></span>
<span id="cb17-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb17-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        None</span></span>
<span id="cb17-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb17-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks):</span>
<span id="cb17-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(threads):</span>
<span id="cb17-19">            f(i, j, threads, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args)</span></code></pre></div>
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> rgb2grey_bk(blockidx, threadidx, blockdim, x, out, n):</span>
<span id="cb18-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb18-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Convert RGB to greyscale for a single pixel in a block-thread execution model.</span></span>
<span id="cb18-4"></span>
<span id="cb18-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function calculates the greyscale value for a single pixel using the formula:</span></span>
<span id="cb18-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    grey = 0.2989*R + 0.5870*G + 0.1140*B</span></span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb18-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockidx (int): The current block index.</span></span>
<span id="cb18-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threadidx (int): The current thread index within the block.</span></span>
<span id="cb18-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockdim (int): The number of threads per block.</span></span>
<span id="cb18-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x (torch.Tensor): The flattened input RGB image tensor.</span></span>
<span id="cb18-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out (torch.Tensor): The output tensor to store the greyscale result.</span></span>
<span id="cb18-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (int): The total number of pixels in the image.</span></span>
<span id="cb18-15"></span>
<span id="cb18-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb18-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        None</span></span>
<span id="cb18-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb18-19">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockidx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockdim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadidx  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate global index</span></span>
<span id="cb18-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure we're within the image bounds</span></span>
<span id="cb18-21">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate greyscale value using standard coefficients</span></span>
<span id="cb18-22">        out[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2989</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5870</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>n] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1140</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n]</span></code></pre></div>
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> rgb2grey_pybk(x):</span>
<span id="cb19-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Convert an RGB image to greyscale using a block-thread execution model.</span></span>
<span id="cb19-4"></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function simulates GPU-like parallel processing to convert an RGB image</span></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    to greyscale efficiently.</span></span>
<span id="cb19-7"></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x (torch.Tensor): The input RGB image tensor with shape (3, height, width).</span></span>
<span id="cb19-10"></span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb19-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        torch.Tensor: The resulting greyscale image tensor with shape (height, width).</span></span>
<span id="cb19-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb19-14">    c, h, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.shape</span>
<span id="cb19-15">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w</span>
<span id="cb19-16">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.flatten()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten the input tensor</span></span>
<span id="cb19-17"></span>
<span id="cb19-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare output tensor</span></span>
<span id="cb19-19">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.empty(n, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.device)</span>
<span id="cb19-20"></span>
<span id="cb19-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up block and thread dimensions</span></span>
<span id="cb19-22">    threads <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span></span>
<span id="cb19-23">    blocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(math.ceil(h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>threads))</span>
<span id="cb19-24"></span>
<span id="cb19-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Execute the conversion using our simulated block-thread model</span></span>
<span id="cb19-26">    blk_kernel(rgb2grey_bk, blocks, threads, x, res, n)</span>
<span id="cb19-27"></span>
<span id="cb19-28">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> res.view(h, w)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape the result back to 2D</span></span></code></pre></div>
<div class="sourceCode" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the image to greyscale</span></span>
<span id="cb20-2">img_g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rgb2grey_pybk(img2)</span>
<span id="cb20-3"></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the greyscale image</span></span>
<span id="cb20-5">show_img(img_g, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-003/images/output_26_0.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div></li>
</ul>
</section>
<section id="cuda-setup-in-a-notebook" class="level3">
<h3 class="anchored" data-anchor-id="cuda-setup-in-a-notebook">7. CUDA Setup in a Notebook</h3>
<ul>
<li><p><strong>Setup:</strong></p>
<div class="sourceCode" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set CUDA launch blocking to '1' for synchronous kernel launches</span></span>
<span id="cb21-2">os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CUDA_LAUNCH_BLOCKING'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'1'</span></span></code></pre></div>
<div class="sourceCode" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>q wurlitzer ninja</span></code></pre></div>
<div class="sourceCode" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the wurlitzer extension for capturing and redirecting output</span></span>
<span id="cb23-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>load_ext wurlitzer</span></code></pre></div>
<ul>
<li>Set environment variable <code>CUDA_LAUNCH_BLOCKING=1</code> for debugging (slows down execution).</li>
<li>Install <code>ninja</code> (build tool) and <code>wurlitzer</code> (to enable printing from CUDA code in notebooks).</li>
</ul></li>
<li><p><strong><code>load_cuda</code> Function:</strong> A wrapper around <a href="https://pytorch.org/docs/stable/cpp_extension.html#torch.utils.cpp_extension.load_inline"><code>torch.utils.cpp_extension.load_inline</code></a> to simplify loading CUDA code.</p>
<ul>
<li><code>load_inline</code>: A powerful function for compiling and loading CUDA code directly from Python strings.</li>
</ul>
<div class="sourceCode" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> load_cuda(cuda_src, cpp_src, funcs, opt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>):</span>
<span id="cb24-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb24-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Load CUDA and C++ source code as a Python extension.</span></span>
<span id="cb24-4"></span>
<span id="cb24-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function compiles and loads CUDA and C++ source code as a Python extension,</span></span>
<span id="cb24-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    allowing for the use of custom CUDA kernels in Python.</span></span>
<span id="cb24-7"></span>
<span id="cb24-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb24-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        cuda_src (str): CUDA source code as a string.</span></span>
<span id="cb24-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        cpp_src (str): C++ source code as a string.</span></span>
<span id="cb24-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        funcs (list): List of function names to be exposed from the extension.</span></span>
<span id="cb24-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        opt (bool, optional): Whether to enable optimization flags. Defaults to False.</span></span>
<span id="cb24-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        verbose (bool, optional): Whether to print verbose output during compilation. Defaults to False.</span></span>
<span id="cb24-14"></span>
<span id="cb24-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb24-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        module: Loaded Python extension module containing the compiled functions.</span></span>
<span id="cb24-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb24-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use load_inline to compile and load the CUDA and C++ source code</span></span>
<span id="cb24-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> load_inline(cuda_sources<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[cuda_src], cpp_sources<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[cpp_src], functions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>funcs,</span>
<span id="cb24-20">                       extra_cuda_cflags<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-O2"</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> opt <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> [], verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>verbose, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inline_ext"</span>)</span></code></pre></div></li>
<li><p><strong>Common C++ Code:</strong> Define common C++ code, including header files, macros for checking tensor properties (CUDA, contiguous), and a macro for ceiling division.</p>
<div class="sourceCode" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define CUDA boilerplate code and utility macros</span></span>
<span id="cb25-2">cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb25-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">#include &lt;torch/extension.h&gt;</span></span>
<span id="cb25-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">#include &lt;stdio.h&gt;</span></span>
<span id="cb25-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">#include &lt;c10/cuda/CUDAException.h&gt;</span></span>
<span id="cb25-6"></span>
<span id="cb25-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">// Macro to check if a tensor is a CUDA tensor</span></span>
<span id="cb25-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">#define CHECK_CUDA(x) TORCH_CHECK(x.device().is_cuda(), #x " must be a CUDA tensor")</span></span>
<span id="cb25-9"></span>
<span id="cb25-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">// Macro to check if a tensor is contiguous in memory</span></span>
<span id="cb25-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">#define CHECK_CONTIGUOUS(x) TORCH_CHECK(x.is_contiguous(), #x " must be contiguous")</span></span>
<span id="cb25-12"></span>
<span id="cb25-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">// Macro to check both CUDA and contiguity requirements</span></span>
<span id="cb25-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">#define CHECK_INPUT(x) CHECK_CUDA(x); CHECK_CONTIGUOUS(x)</span></span>
<span id="cb25-15"></span>
<span id="cb25-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">// Utility function for ceiling division</span></span>
<span id="cb25-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">inline unsigned int cdiv(unsigned int a, unsigned int b) { return (a + b - 1) / b;}</span></span>
<span id="cb25-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div></li>
</ul>
</section>
<section id="writing-and-compiling-cuda-kernels" class="level3">
<h3 class="anchored" data-anchor-id="writing-and-compiling-cuda-kernels">8. Writing and Compiling CUDA Kernels</h3>
<ul>
<li><p><strong>Writing CUDA Kernels:</strong></p>
<ul>
<li>Use ChatGPT to convert Python kernel code to C++ CUDA code (or write it manually if comfortable with C++).</li>
<li>Adapt the code to CUDA syntax (e.g., <code>blockidx.x</code>, <code>blockdim.x</code>, <code>threadidx.x</code>, data types, semicolons).</li>
<li>Use <code>unsigned char*</code> for <code>uint8</code> (byte) data type in C++.</li>
<li><strong><code>__global__</code>:</strong> A CUDA keyword that indicates a kernel function callable from the CPU and executed on the GPU.</li>
</ul></li>
<li><p><strong>Calling CUDA Kernels:</strong></p>
<ul>
<li>Use triple angle brackets (<code>&lt;&lt;&lt;...&gt;&gt;&gt;</code>) to launch a CUDA kernel.</li>
<li>Specify the number of blocks and threads per block within the brackets.</li>
<li>Pass tensor arguments using <code>.data_ptr&lt;data_type&gt;()</code> to get C++ pointers.</li>
<li>Use <code>input.options()</code> to create output tensors with the same data type and device as the input tensor.</li>
<li>Use <code>TORCH_CHECK</code> to check for CUDA errors after kernel execution.</li>
</ul></li>
<li><p><strong>CUDA Source Code:</strong></p>
<div class="sourceCode" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA kernel definition for RGB to grayscale conversion</span></span>
<span id="cb26-2">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb26-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb26-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @brief CUDA kernel for converting RGB image to grayscale.</span></span>
<span id="cb26-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb26-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * This kernel applies the luminance formula to convert RGB values to grayscale:</span></span>
<span id="cb26-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * Gray = 0.2989 * R + 0.5870 * G + 0.1140 * B</span></span>
<span id="cb26-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb26-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param x Pointer to the input RGB image data (interleaved R, G, B channels)</span></span>
<span id="cb26-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param out Pointer to the output grayscale image data</span></span>
<span id="cb26-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param n Total number of pixels in the image</span></span>
<span id="cb26-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb26-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void rgb_to_grayscale_kernel(unsigned char* x, unsigned char* out, int n) {</span></span>
<span id="cb26-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Calculate global thread ID</span></span>
<span id="cb26-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int i = blockIdx.x * blockDim.x + threadIdx.x;</span></span>
<span id="cb26-16"></span>
<span id="cb26-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Ensure we don't process beyond the image bounds</span></span>
<span id="cb26-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if (i &lt; n) {</span></span>
<span id="cb26-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Apply luminance formula. Note: x[i], x[i+n], and x[i+2*n] correspond to R, G, and B channels respectively</span></span>
<span id="cb26-20"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        out[i] = 0.2989 * x[i] + 0.5870 * x[i+n] + 0.1140 * x[i+2*n];</span></span>
<span id="cb26-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb26-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb26-23"></span>
<span id="cb26-24"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb26-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @brief C++ wrapper function to call the CUDA kernel for RGB to grayscale conversion.</span></span>
<span id="cb26-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * </span></span>
<span id="cb26-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * This function prepares the data and launches the CUDA kernel to perform the conversion.</span></span>
<span id="cb26-28"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb26-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param input Input RGB image tensor (expected shape: [3, height, width])</span></span>
<span id="cb26-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @return torch::Tensor Grayscale image tensor (shape: [height, width])</span></span>
<span id="cb26-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb26-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor rgb_to_grayscale(torch::Tensor input) {</span></span>
<span id="cb26-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Verify input tensor properties (shape, type, etc.)</span></span>
<span id="cb26-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(input);</span></span>
<span id="cb26-35"></span>
<span id="cb26-36"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Extract image dimensions</span></span>
<span id="cb26-37"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int h = input.size(1);</span></span>
<span id="cb26-38"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int w = input.size(2);</span></span>
<span id="cb26-39"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    printf("h*w: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">*</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%d</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">\n", h, w);</span></span>
<span id="cb26-40"></span>
<span id="cb26-41"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Create output tensor for grayscale image</span></span>
<span id="cb26-42"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    auto output = torch::empty({h,w}, input.options());</span></span>
<span id="cb26-43"></span>
<span id="cb26-44"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Set number of threads per block</span></span>
<span id="cb26-45"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int threads = 256;</span></span>
<span id="cb26-46"></span>
<span id="cb26-47"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch kernel with calculated grid size</span></span>
<span id="cb26-48"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    rgb_to_grayscale_kernel&lt;&lt;&lt;cdiv(w*h,threads), threads&gt;&gt;&gt;(</span></span>
<span id="cb26-49"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        input.data_ptr&lt;unsigned char&gt;(), output.data_ptr&lt;unsigned char&gt;(), w*h);</span></span>
<span id="cb26-50"></span>
<span id="cb26-51"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Check for any errors in kernel launch or execution</span></span>
<span id="cb26-52"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb26-53"></span>
<span id="cb26-54"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb26-55"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb26-56"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div></li>
<li><p><strong>C++ Source Code:</strong> Define a C++ header that lists the CUDA functions to be made available to Python.</p>
<div class="sourceCode" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ function declaration for the RGB to grayscale conversion</span></span>
<span id="cb27-2">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"torch::Tensor rgb_to_grayscale(torch::Tensor input);"</span></span></code></pre></div></li>
<li><p><strong>Compiling with <code>load_cuda</code>:</strong> Use the <code>load_cuda</code> function to compile the CUDA and C++ code into a Python module.</p>
<div class="sourceCode" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the CUDA module with the defined kernel and C++ function</span></span>
<span id="cb28-2">module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_cuda(cuda_src, cpp_src, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rgb_to_grayscale'</span>], verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<pre class="text"><code>Using /home/innom-dt/.cache/torch_extensions/py311_cu124 as PyTorch extensions root...
Creating extension directory /home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext...
Detected CUDA files, patching ldflags
Emitting ninja build file /home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/build.ninja...
/home/innom-dt/mambaforge/envs/cuda-mode/lib/python3.11/site-packages/torch/utils/cpp_extension.py:1961: UserWarning: TORCH_CUDA_ARCH_LIST is not set, all archs for visible cards are included for compilation. 
If this is not desired, please set os.environ['TORCH_CUDA_ARCH_LIST'].
  warnings.warn(
Building extension module inline_ext...
Allowing ninja to set a default number of workers... (overridable by setting the environment variable MAX_JOBS=N)
Loading extension module inline_ext...</code></pre>
<div class="sourceCode" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print the path to the extension module</span></span>
<span id="cb30-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Module Path: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>module<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__file__</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre class="text"><code>Module Path: /home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/inline_ext.so</code></pre>
<div class="sourceCode" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Import the pandas package</span></span>
<span id="cb32-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb32-3"></span>
<span id="cb32-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Do not truncate the contents of cells and display all rows and columns</span></span>
<span id="cb32-5">pd.set_option(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'max_colwidth'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'display.max_rows'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'display.max_columns'</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb32-6"></span>
<span id="cb32-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print the content of the module folder as a Pandas DataFrame</span></span>
<span id="cb32-8">pd.DataFrame(Path(module.<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__file__</span>).parent.iterdir())</span></code></pre></div>
<div style="overflow-x:auto; max-height:500px">
<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Files
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
/home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/main.o
</td>
</tr>
<tr>
<th>
1
</th>
<td>
/home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/.ninja_deps
</td>
</tr>
<tr>
<th>
2
</th>
<td>
/home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/build.ninja
</td>
</tr>
<tr>
<th>
3
</th>
<td>
/home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/cuda.cuda.o
</td>
</tr>
<tr>
<th>
4
</th>
<td>
/home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/cuda.cu
</td>
</tr>
<tr>
<th>
5
</th>
<td>
/home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/.ninja_log
</td>
</tr>
<tr>
<th>
6
</th>
<td>
/home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/inline_ext.so
</td>
</tr>
<tr>
<th>
7
</th>
<td>
/home/innom-dt/.cache/torch_extensions/py311_cu124/inline_ext/main.cpp
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># List all non-private attributes of the loaded module</span></span>
<span id="cb33-2">[o <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span>(module) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> o[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_'</span>]</span></code></pre></div>
<pre class="text"><code>['rgb_to_grayscale']</code></pre></li>
</ul>
</section>
<section id="running-the-cuda-kernel" class="level3">
<h3 class="anchored" data-anchor-id="running-the-cuda-kernel">9. Running the CUDA Kernel</h3>
<ul>
<li><p><strong>Ensure Contiguity and CUDA Device:</strong> Put the input tensor on the CUDA device and make it contiguous.</p>
<div class="sourceCode" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure the input image is contiguous and move it to CUDA device</span></span>
<span id="cb35-2">imgc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> img.contiguous().cuda()</span></code></pre></div></li>
<li><p><strong>Kernel Execution:</strong> Call the compiled CUDA function from Python, passing the input tensor and other required arguments.</p>
<div class="sourceCode" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb36-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time the execution of the RGB to grayscale conversion</span></span>
<span id="cb36-3">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> module.rgb_to_grayscale(imgc).cpu()</span>
<span id="cb36-4"></span>
<span id="cb36-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract height and width of the resulting grayscale image</span></span>
<span id="cb36-6">h, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res.shape</span>
<span id="cb36-7">h, w, h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display height, width, and total number of pixels</span></span></code></pre></div>
<pre class="text"><code>CPU times: user 740 μs, sys: 0 ns, total: 740 μs
Wall time: 636 μs

(1066, 1600, 1705600)</code></pre>
<div class="sourceCode" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the resulting grayscale image</span></span>
<span id="cb38-2">show_img(res, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-003/images/output_43_0.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ul>
<li><strong>Performance:</strong> The CUDA kernel execution is significantly faster on the full size image than the Python implementation on the smaller image (636 μs vs.&nbsp;726 ms).</li>
</ul></li>
</ul>
</section>
</section>
<section id="exercise-2-matrix-multiplication" class="level2">
<h2 class="anchored" data-anchor-id="exercise-2-matrix-multiplication">Exercise 2: Matrix Multiplication</h2>
<section id="understanding-matrix-multiplication" class="level3">
<h3 class="anchored" data-anchor-id="understanding-matrix-multiplication">1. Understanding Matrix Multiplication</h3>
<ul>
<li><p><strong>Definition:</strong> A fundamental linear algebra operation used extensively in deep learning.</p></li>
<li><p><strong>Process:</strong> Involves calculating the dot product of rows of one matrix with columns of another matrix.</p></li>
<li><p><strong>Example:</strong> Multiplying a 5x784 matrix with a 784x10 matrix results in a 5x10 matrix.</p></li>
</ul>
</section>
<section id="matrix-multiplication-in-python" class="level3">
<h3 class="anchored" data-anchor-id="matrix-multiplication-in-python">2. Matrix Multiplication in Python</h3>
<ul>
<li><p><strong>MNIST Dataset:</strong> Uses the MNIST dataset of handwritten digits (28x28 images) for the example.</p>
<div class="sourceCode" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gzip,pickle</span>
<span id="cb39-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> urllib.request <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> urlretrieve</span>
<span id="cb39-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb39-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tensor</span></code></pre></div>
<div class="sourceCode" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># URL for downloading the MNIST dataset</span></span>
<span id="cb40-2">MNIST_URL <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://github.com/mnielsen/neural-networks-and-deep-learning/blob/master/data/mnist.pkl.gz?raw=true'</span></span>
<span id="cb40-3"></span>
<span id="cb40-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a directory to store the data</span></span>
<span id="cb40-5">path_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data'</span>)</span>
<span id="cb40-6">path_data.mkdir(exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb40-7"></span>
<span id="cb40-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the path for the gzipped MNIST file</span></span>
<span id="cb40-9">path_gz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path_data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'mnist.pkl.gz'</span></span>
<span id="cb40-10"></span>
<span id="cb40-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download the MNIST dataset if it doesn't exist</span></span>
<span id="cb40-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> path_gz.exists():</span>
<span id="cb40-13">    urlretrieve(MNIST_URL, path_gz)</span></code></pre></div>
<div class="sourceCode" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load and extract the MNIST data</span></span>
<span id="cb41-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> gzip.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(path_gz, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rb'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb41-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load training, validation, and test sets (ignoring test set)</span></span>
<span id="cb41-4">    ((x_train, y_train), (x_valid, y_valid), _) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pickle.load(f, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'latin-1'</span>)</span>
<span id="cb41-5"></span>
<span id="cb41-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert data to PyTorch tensors</span></span>
<span id="cb41-7">x_train, y_train, x_valid, y_valid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(tensor, (x_train, y_train, x_valid, y_valid))</span>
<span id="cb41-8"></span>
<span id="cb41-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print shape and data type of training data</span></span>
<span id="cb41-10">x_train.shape, x_train.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>()</span></code></pre></div>
<pre class="text"><code>(torch.Size([50000, 784]), 'torch.FloatTensor')</code></pre>
<div class="sourceCode" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape training images to 2D format (28x28 pixels)</span></span>
<span id="cb43-2">imgs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_train.reshape((<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>))</span>
<span id="cb43-3">imgs.shape</span></code></pre></div>
<pre class="text"><code>torch.Size([50000, 28, 28])</code></pre>
<div class="sourceCode" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the first image in the dataset</span></span>
<span id="cb45-2">show_img(imgs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray_r'</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-003/images/output_50_0.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div></li>
<li><p><strong>Weight Matrix:</strong> A randomly initialized weight matrix (784x10) is used.</p>
<div class="sourceCode" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set random seed for reproducibility</span></span>
<span id="cb46-2">torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb46-3"></span>
<span id="cb46-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize random weights for a neural network (784 input features, 10 output classes)</span></span>
<span id="cb46-5">weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">784</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb46-6">weights</span></code></pre></div>
<pre class="text"><code>tensor([[-1.5256, -0.7502, -0.6540,  ..., -1.6091, -0.7121,  0.3037],
        [-0.7773, -0.2515, -0.2223,  ..., -1.1608,  0.6995,  0.1991],
        [ 0.8657,  0.2444, -0.6629,  ..., -1.4465,  0.0612, -0.6177],
        ...,
        [ 0.5063,  0.4656, -0.2634,  ...,  0.6452,  0.4298, -1.2936],
        [ 0.5171,  1.0315,  0.8120,  ..., -0.1046,  2.2588, -0.2793],
        [-1.4899,  0.3898, -0.5454,  ..., -0.1923, -0.5076,  0.5439]])</code></pre></li>
<li><p><strong>Base Implementation:</strong></p>
<div class="sourceCode" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example usage and performance measurement</span></span>
<span id="cb48-2">m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_valid[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Select first 5 rows from x_valid</span></span>
<span id="cb48-3">m2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assign weights to m2</span></span>
<span id="cb48-4"></span>
<span id="cb48-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print shapes of input matrices</span></span>
<span id="cb48-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Shape of m1: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>m1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Shape of m2: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>m2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre class="text"><code>Shape of m1: torch.Size([5, 784]), Shape of m2: torch.Size([784, 10])</code></pre>
<div class="sourceCode" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unpack dimensions of input matrices</span></span>
<span id="cb50-2">ar, ac <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m1.shape  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of rows and columns in m1</span></span>
<span id="cb50-3">br, bc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.shape  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of rows and columns in m2</span></span>
<span id="cb50-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Dimensions: (ar=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ar<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, ac=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ac<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">), (br=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>br<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, bc=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>bc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span></code></pre></div>
<pre class="text"><code>Dimensions: (ar=5, ac=784), (br=784, bc=10)</code></pre>
<div class="sourceCode" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize result tensor</span></span>
<span id="cb52-2">t1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(ar, bc)</span>
<span id="cb52-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Shape of result tensor: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre class="text"><code>Shape of result tensor: torch.Size([5, 10])</code></pre>
<div class="sourceCode" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform matrix multiplication using nested loops</span></span>
<span id="cb54-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(ar):         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5 iterations (rows of m1)</span></span>
<span id="cb54-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(bc):     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10 iterations (columns of m2)</span></span>
<span id="cb54-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(ac): <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 784 iterations (columns of m1 / rows of m2)</span></span>
<span id="cb54-5">            t1[i, j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> m1[i, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> m2[k, j]</span>
<span id="cb54-6"></span>
<span id="cb54-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Shape of result after multiplication: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre class="text"><code>Shape of result after multiplication: torch.Size([5, 10])</code></pre>
<div class="sourceCode" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure numpy and torch print options for better readability</span></span>
<span id="cb56-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb56-3">np.set_printoptions(precision<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>)</span>
<span id="cb56-4">torch.set_printoptions(precision<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>, sci_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="sourceCode" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the result</span></span>
<span id="cb57-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Result of matrix multiplication:"</span>)</span>
<span id="cb57-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(t1)</span></code></pre></div>
<pre class="text"><code>Result of matrix multiplication:
tensor([[-10.94,  -0.68,  -7.00,  -4.01,  -2.09,  -3.36,   3.91,  -3.44, -11.47,  -2.12],
        [ 14.54,   6.00,   2.89,  -4.08,   6.59, -14.74,  -9.28,   2.16, -15.28,  -2.68],
        [  2.22,  -3.22,  -4.80,  -6.05,  14.17,  -8.98,  -4.79,  -5.44, -20.68,  13.57],
        [ -6.71,   8.90,  -7.46,  -7.90,   2.70,  -4.73, -11.03, -12.98,  -6.44,   3.64],
        [ -2.44,  -6.40,  -2.40,  -9.04,  11.18,  -5.77,  -8.92,  -3.79,  -8.98,   5.28]])</code></pre>
<div class="sourceCode" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix multiplication implementation</span></span>
<span id="cb59-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul(a, b):</span>
<span id="cb59-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb59-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform matrix multiplication of two 2D tensors.</span></span>
<span id="cb59-5"></span>
<span id="cb59-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb59-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    a (torch.Tensor): First input tensor with shape (ar, ac)</span></span>
<span id="cb59-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    b (torch.Tensor): Second input tensor with shape (br, bc)</span></span>
<span id="cb59-9"></span>
<span id="cb59-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb59-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    torch.Tensor: Resulting tensor after matrix multiplication with shape (ar, bc)</span></span>
<span id="cb59-12"></span>
<span id="cb59-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Note: This function assumes that the number of columns in 'a' equals the number of rows in 'b'.</span></span>
<span id="cb59-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb59-15">    (ar, ac), (br, bc) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a.shape, b.shape</span>
<span id="cb59-16">    c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(ar, bc)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize result tensor with zeros</span></span>
<span id="cb59-17"></span>
<span id="cb59-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform matrix multiplication using nested loops</span></span>
<span id="cb59-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(ar):</span>
<span id="cb59-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(bc):</span>
<span id="cb59-21">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> k <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(ac):</span>
<span id="cb59-22">                c[i, j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> a[i, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b[k, j]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Accumulate the product of corresponding elements</span></span>
<span id="cb59-23"></span>
<span id="cb59-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> c</span></code></pre></div>
<div class="sourceCode" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure execution time of matmul function</span></span>
<span id="cb60-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>time _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matmul(m1, m2)</span></code></pre></div>
<pre class="text"><code>CPU times: user 443 ms, sys: 0 ns, total: 443 ms
Wall time: 443 ms</code></pre>
<div class="sourceCode" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate total number of operations</span></span>
<span id="cb62-2">total_ops <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ac</span>
<span id="cb62-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Total number of operations: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>total_ops<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<pre class="text"><code>Total number of operations: 39200</code></pre>
<ul>
<li>Uses nested loops to iterate through rows of the first matrix and columns of the second matrix.</li>
<li>Calculates the dot product for each element in the output matrix.</li>
<li><strong>Performance:</strong> Slow for large matrices (around 1 second for 39,200 innermost operations).</li>
</ul></li>
</ul>
</section>
<section id="matrix-multiplication-with-a-cuda-kernel" class="level3">
<h3 class="anchored" data-anchor-id="matrix-multiplication-with-a-cuda-kernel">3. Matrix Multiplication with a CUDA Kernel</h3>
<ul>
<li><p><strong>Kernel Design:</strong></p>
<ul>
<li>The innermost loop (dot product calculation) is implemented as a CUDA kernel.</li>
<li>Each CUDA thread will calculate the dot product for one element in the output matrix.</li>
</ul></li>
<li><p><strong>2D Blocks and Threads:</strong></p>
<ul>
<li>CUDA allows for 2D (or even 3D) blocks and threads.</li>
<li>Blocks and threads are indexed using x and y coordinates (e.g., block(3, 4), thread(6, 12)).</li>
</ul></li>
<li><p><strong>Kernel Runner with 2D Blocks and Threads:</strong></p>
<ul>
<li>Uses four nested for loops to iterate through blocks and threads in both x and y dimensions.</li>
<li>Passes block and thread index information to the kernel.</li>
</ul></li>
<li><p><strong>CUDA Kernel Implementation:</strong></p>
<ul>
<li>Uses a guard block to prevent out-of-bounds memory access.</li>
<li>Calculates row and column indices from block and thread indices.</li>
<li>Performs the dot product calculation and stores the result in the output matrix.</li>
</ul></li>
<li><p><strong>2D Python Kernel:</strong></p>
<div class="sourceCode" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> types <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> SimpleNamespace <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> ns</span></code></pre></div>
<div class="sourceCode" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> blk_kernel2d(f, blocks, threads, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args):</span>
<span id="cb65-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb65-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Simulate a 2D block-based kernel execution.</span></span>
<span id="cb65-4"></span>
<span id="cb65-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function emulates the behavior of a GPU kernel by iterating over blocks and threads</span></span>
<span id="cb65-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    in a 2D grid, calling the provided function 'f' for each thread.</span></span>
<span id="cb65-7"></span>
<span id="cb65-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb65-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        f (callable): The function to be executed for each thread.</span></span>
<span id="cb65-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blocks (ns): Namespace object representing the number of blocks in x and y dimensions.</span></span>
<span id="cb65-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threads (ns): Namespace object representing the number of threads per block in x and y dimensions.</span></span>
<span id="cb65-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        *args: Additional arguments to be passed to the function 'f'.</span></span>
<span id="cb65-13"></span>
<span id="cb65-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb65-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        None</span></span>
<span id="cb65-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb65-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i0 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks.y):</span>
<span id="cb65-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(blocks.x):</span>
<span id="cb65-19">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j0 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(threads.y):</span>
<span id="cb65-20">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> j1 <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(threads.x):</span>
<span id="cb65-21">                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Call the function 'f' for each thread, passing block and thread indices</span></span>
<span id="cb65-22">                    f(ns(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>i1, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>i0), ns(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>j1, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>j0), threads, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args)</span></code></pre></div>
<div class="sourceCode" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_bk(blockidx, threadidx, blockdim, m, n, out, h, w, k):</span>
<span id="cb66-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb66-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform matrix multiplication for a single thread in a block.</span></span>
<span id="cb66-4"></span>
<span id="cb66-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function calculates the dot product for a specific element in the output matrix.</span></span>
<span id="cb66-6"></span>
<span id="cb66-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb66-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockidx (ns): Namespace object representing the block index.</span></span>
<span id="cb66-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threadidx (ns): Namespace object representing the thread index within the block.</span></span>
<span id="cb66-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        blockdim (ns): Namespace object representing the block dimensions.</span></span>
<span id="cb66-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (array): Flattened input matrix 1.</span></span>
<span id="cb66-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (array): Flattened input matrix 2.</span></span>
<span id="cb66-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        out (array): Flattened output matrix.</span></span>
<span id="cb66-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        h (int): Height of the output matrix.</span></span>
<span id="cb66-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        w (int): Width of the output matrix.</span></span>
<span id="cb66-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        k (int): Shared dimension of input matrices.</span></span>
<span id="cb66-17"></span>
<span id="cb66-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb66-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        None</span></span>
<span id="cb66-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb66-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate global row and column indices</span></span>
<span id="cb66-22">    r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockidx.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockdim.y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadidx.y</span>
<span id="cb66-23">    c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blockidx.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> blockdim.x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> threadidx.x</span>
<span id="cb66-24"></span>
<span id="cb66-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if the current thread is within the output matrix dimensions</span></span>
<span id="cb66-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> h <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">or</span> c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> w):</span>
<span id="cb66-27">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span></span>
<span id="cb66-28"></span>
<span id="cb66-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform dot product calculation</span></span>
<span id="cb66-30">    o <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.</span></span>
<span id="cb66-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(k):</span>
<span id="cb66-32">        o <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> m[r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> n[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c]</span>
<span id="cb66-33"></span>
<span id="cb66-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store the result in the output matrix</span></span>
<span id="cb66-35">    out[r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>c] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> o</span></code></pre></div>
<div class="sourceCode" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul_2d(m, n):</span>
<span id="cb67-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb67-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform 2D matrix multiplication using a block-based approach.</span></span>
<span id="cb67-4"></span>
<span id="cb67-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    This function implements matrix multiplication by simulating a GPU-like</span></span>
<span id="cb67-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    block and thread structure.</span></span>
<span id="cb67-7"></span>
<span id="cb67-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb67-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        m (torch.Tensor): Input matrix 1.</span></span>
<span id="cb67-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n (torch.Tensor): Input matrix 2.</span></span>
<span id="cb67-11"></span>
<span id="cb67-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb67-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        torch.Tensor: Result of the matrix multiplication.</span></span>
<span id="cb67-14"></span>
<span id="cb67-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Raises:</span></span>
<span id="cb67-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        AssertionError: If the inner dimensions of the input matrices don't match.</span></span>
<span id="cb67-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb67-18">    h, k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m.shape</span>
<span id="cb67-19">    k2, w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n.shape</span>
<span id="cb67-20"></span>
<span id="cb67-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure that the inner dimensions of the matrices match</span></span>
<span id="cb67-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">assert</span> k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> k2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Size mismatch!"</span></span>
<span id="cb67-23"></span>
<span id="cb67-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the output matrix</span></span>
<span id="cb67-25">    output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(h, w, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m.dtype)</span>
<span id="cb67-26"></span>
<span id="cb67-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define thread-per-block dimensions</span></span>
<span id="cb67-28">    tpb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ns(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb67-29"></span>
<span id="cb67-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the number of blocks needed</span></span>
<span id="cb67-31">    blocks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ns(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>math.ceil(w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>tpb.x), y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>math.ceil(h<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>tpb.y))</span>
<span id="cb67-32"></span>
<span id="cb67-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Execute the block kernel</span></span>
<span id="cb67-34">    blk_kernel2d(matmul_bk, blocks, tpb,</span>
<span id="cb67-35">                 m.flatten(), n.flatten(), output.flatten(), h, w, k)</span>
<span id="cb67-36"></span>
<span id="cb67-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> output</span></code></pre></div>
<div class="sourceCode" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform matrix multiplication</span></span>
<span id="cb68-2">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matmul_2d(m1, m2)</span>
<span id="cb68-3"></span>
<span id="cb68-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify the result (assuming 't1' is the expected output)</span></span>
<span id="cb68-5">torch.isclose(t1, res).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True)</code></pre></li>
</ul>
</section>
<section id="matrix-multiplication-in-cuda" class="level3">
<h3 class="anchored" data-anchor-id="matrix-multiplication-in-cuda">4. Matrix Multiplication in CUDA</h3>
<ul>
<li><p><strong>Optimized CPU Approach:</strong> Uses a broadcasting approach in Python for a faster CPU-based matrix multiplication to compare against the CUDA version.</p>
<div class="sourceCode" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> matmul(a, b):</span>
<span id="cb70-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb70-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Perform matrix multiplication of two 2D tensors.</span></span>
<span id="cb70-4"></span>
<span id="cb70-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb70-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        a (torch.Tensor): First input tensor with shape (ar, ac)</span></span>
<span id="cb70-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        b (torch.Tensor): Second input tensor with shape (br, bc)</span></span>
<span id="cb70-8"></span>
<span id="cb70-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb70-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        torch.Tensor: Result of matrix multiplication with shape (ar, bc)</span></span>
<span id="cb70-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb70-12">    (ar, ac), (br, bc) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> a.shape, b.shape</span>
<span id="cb70-13">    c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(ar, bc)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize result tensor with zeros</span></span>
<span id="cb70-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(ar):</span>
<span id="cb70-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply each row of 'a' with all columns of 'b' and sum the results</span></span>
<span id="cb70-16">        c[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (a[i, :, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb70-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> c</span></code></pre></div>
<div class="sourceCode" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if the custom matmul function produces the same result as torch.matmul</span></span>
<span id="cb71-2">torch.isclose(t1, matmul(m1, m2)).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True)</code></pre>
<div class="sourceCode" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure the execution time of the custom matmul function</span></span>
<span id="cb73-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>time _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matmul(m1, m2)</span></code></pre></div>
<pre class="text"><code>CPU times: user 634 μs, sys: 266 μs, total: 900 μs
Wall time: 568 μs</code></pre>
<div class="sourceCode" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use x_train as m1 and perform matrix multiplication</span></span>
<span id="cb75-2">m1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_train</span>
<span id="cb75-3">tr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matmul(m1, m2)</span>
<span id="cb75-4">tr.shape  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the shape of the resulting tensor</span></span></code></pre></div>
<pre class="text"><code>torch.Size([50000, 10])</code></pre>
<div class="sourceCode" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure the execution time with whole input matrices</span></span>
<span id="cb77-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>time _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matmul(m1, m2)</span></code></pre></div>
<pre class="text"><code>CPU times: user 712 ms, sys: 0 ns, total: 712 ms
Wall time: 641 ms</code></pre>
<div class="sourceCode" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the total number of scalar multiplications in the matrix multiplication</span></span>
<span id="cb79-2">ar, ac <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m1.shape</span>
<span id="cb79-3">br, bc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m2.shape</span>
<span id="cb79-4">ar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ac  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of multiplications: (rows of m1) * (cols of m2) * (cols of m1)</span></span></code></pre></div>
<pre class="text"><code>392000000</code></pre></li>
<li><p><strong>CUDA Kernel Conversion:</strong> Convert the Python kernel to C++ CUDA code using ChatGPT (or manually).</p></li>
<li><p><strong>Implementing the CUDA Kernel:</strong></p>
<div class="sourceCode" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CUDA kernel for matrix multiplication</span></span>
<span id="cb81-2">  cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb81-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">  __global__ void matmul_k(float* m, float* n, float* out, int h, int w, int k) {</span></span>
<span id="cb81-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Calculate global thread indices</span></span>
<span id="cb81-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      int r = blockIdx.y * blockDim.y + threadIdx.y;</span></span>
<span id="cb81-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      int c = blockIdx.x * blockDim.x + threadIdx.x;</span></span>
<span id="cb81-7"></span>
<span id="cb81-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Boundary check</span></span>
<span id="cb81-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      if (r &gt;= h || c &gt;= w) return;</span></span>
<span id="cb81-10"></span>
<span id="cb81-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Perform dot product for this element</span></span>
<span id="cb81-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      float o = 0;</span></span>
<span id="cb81-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      for (int i = 0; i &lt; k; ++i) {</span></span>
<span id="cb81-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">          o += m[r*k + i] * n[i*w + c];</span></span>
<span id="cb81-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      }</span></span>
<span id="cb81-16"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      out[r*w + c] = o;</span></span>
<span id="cb81-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb81-18"></span>
<span id="cb81-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">  /**</span></span>
<span id="cb81-20"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">   * Perform matrix multiplication using CUDA.</span></span>
<span id="cb81-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">   *</span></span>
<span id="cb81-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">   * @param m First input tensor</span></span>
<span id="cb81-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">   * @param n Second input tensor</span></span>
<span id="cb81-24"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">   * @return Result of matrix multiplication</span></span>
<span id="cb81-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">   */</span></span>
<span id="cb81-26"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">  torch::Tensor matmul(torch::Tensor m, torch::Tensor n) {</span></span>
<span id="cb81-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      CHECK_INPUT(m); CHECK_INPUT(n);</span></span>
<span id="cb81-28"></span>
<span id="cb81-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Extract dimensions</span></span>
<span id="cb81-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      int h = m.size(0);</span></span>
<span id="cb81-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      int w = n.size(1);</span></span>
<span id="cb81-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      int k = m.size(1);</span></span>
<span id="cb81-33"></span>
<span id="cb81-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Ensure matrices are compatible for multiplication</span></span>
<span id="cb81-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      TORCH_CHECK(k == n.size(0), "Size mismatch!");</span></span>
<span id="cb81-36"></span>
<span id="cb81-37"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Initialize output tensor</span></span>
<span id="cb81-38"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      auto output = torch::zeros({h, w}, m.options());</span></span>
<span id="cb81-39"></span>
<span id="cb81-40"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Define thread block and grid dimensions</span></span>
<span id="cb81-41"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      dim3 tpb(16, 16);</span></span>
<span id="cb81-42"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      dim3 blocks(cdiv(w, tpb.x), cdiv(h, tpb.y));</span></span>
<span id="cb81-43"></span>
<span id="cb81-44"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Launch CUDA kernel</span></span>
<span id="cb81-45"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      matmul_k&lt;&lt;&lt;blocks, tpb&gt;&gt;&gt;(</span></span>
<span id="cb81-46"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">          m.data_ptr&lt;float&gt;(), n.data_ptr&lt;float&gt;(), output.data_ptr&lt;float&gt;(), h, w, k);</span></span>
<span id="cb81-47"></span>
<span id="cb81-48"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      // Check for CUDA errors</span></span>
<span id="cb81-49"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb81-50"></span>
<span id="cb81-51"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">      return output;</span></span>
<span id="cb81-52"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb81-53"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">  '''</span></span></code></pre></div>
<div class="sourceCode" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ function declaration for the CUDA kernel</span></span>
<span id="cb82-2">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"torch::Tensor matmul(torch::Tensor m, torch::Tensor n);"</span></span></code></pre></div>
<ul>
<li>Uses <code>DIM3</code> structures to specify the number of threads per block in x and y dimensions.</li>
<li>Calculates the number of blocks in x and y dimensions using ceiling division.</li>
<li>Launches the CUDA kernel with the calculated block and thread dimensions.</li>
</ul></li>
<li><p><strong>Performance:</strong> The CUDA kernel is significantly faster than both the Python implementation and the optimized CPU approach (1.21 ms vs.&nbsp;641 ms).</p>
<div class="sourceCode" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the CUDA module</span></span>
<span id="cb83-2">module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_cuda(cuda_src, cpp_src, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matmul'</span>])</span></code></pre></div>
<pre class="text"><code>/home/innom-dt/mambaforge/envs/cuda-mode/lib/python3.11/site-packages/torch/utils/cpp_extension.py:1961: UserWarning: TORCH_CUDA_ARCH_LIST is not set, all archs for visible cards are included for compilation. 
If this is not desired, please set os.environ['TORCH_CUDA_ARCH_LIST'].
  warnings.warn(</code></pre>
<div class="sourceCode" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare input tensors for CUDA</span></span>
<span id="cb85-2">m1c, m2c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m1.contiguous().cuda(), m2.contiguous().cuda()</span></code></pre></div>
<div class="sourceCode" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify the result against a reference implementation</span></span>
<span id="cb86-2">torch.isclose(tr, module.matmul(m1c, m2c).cpu(), atol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True)</code></pre>
<div class="sourceCode" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span>time</span>
<span id="cb88-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure execution time of the CUDA matrix multiplication</span></span>
<span id="cb88-3">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> module.matmul(m1c, m2c).cpu()</span>
<span id="cb88-4">res.shape</span></code></pre></div>
<pre class="text"><code>CPU times: user 1.45 ms, sys: 138 μs, total: 1.59 ms
Wall time: 1.21 ms

torch.Size([50000, 10])</code></pre></li>
</ul>
</section>
<section id="comparison-with-pytorchs-operator" class="level3">
<h3 class="anchored" data-anchor-id="comparison-with-pytorchs-operator">5. Comparison with PyTorch’s <code>@</code> Operator</h3>
<ul>
<li><p><strong>PyTorch’s Matrix Multiplication:</strong> PyTorch provides the <code>@</code> operator for efficient matrix multiplication.</p></li>
<li><p><strong>Performance:</strong> PyTorch’s <code>@</code> operator is even faster than the custom CUDA kernel (636 μs vs.&nbsp;1.21 ms).</p>
<div class="sourceCode" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare CUDA matrix multiplication with PyTorch's built-in operation</span></span>
<span id="cb90-2">torch.isclose(tr, (m1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> m2c).cpu(), atol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>()</span></code></pre></div>
<pre class="text"><code>tensor(True)</code></pre>
<div class="sourceCode" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure the execution time of PyTorch's built-in matrix multiplication</span></span>
<span id="cb92-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span>timeit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (m1c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> m2c).cpu()</span></code></pre></div>
<pre class="text"><code>636 μs ± 62.7 μs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre></li>
</ul>
</section>
<section id="optimizing-cuda-kernels-with-shared-memory" class="level3">
<h3 class="anchored" data-anchor-id="optimizing-cuda-kernels-with-shared-memory">6. Optimizing CUDA Kernels with Shared Memory</h3>
<ul>
<li><strong>Shared Memory:</strong> A small, fast memory space shared by threads within a block.</li>
<li><strong>Optimization Potential:</strong> PyTorch’s matrix multiplication likely uses shared memory effectively to achieve higher performance.</li>
<li><strong>Caching:</strong> Shared memory can be used to cache frequently accessed data, reducing reliance on slower global memory.</li>
</ul>
</section>
<section id="d-vs.-2d-blocks-and-threads" class="level3">
<h3 class="anchored" data-anchor-id="d-vs.-2d-blocks-and-threads">7. 1D vs.&nbsp;2D Blocks and Threads</h3>
<ul>
<li><p><strong>Flexibility:</strong> CUDA allows for 1D, 2D, or 3D blocks and threads.</p></li>
<li><p><strong>Simplicity:</strong> In some cases, 1D blocks and threads can lead to simpler code compared to 2D or 3D.</p></li>
<li><p><strong>Choice:</strong> The choice between 1D, 2D, or 3D blocks and threads depends on the specific problem and coding preferences.</p></li>
<li><p><strong>2D Block Implementation:</strong></p>
<div class="sourceCode" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1">cuda_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cuda_begin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r'''</span></span>
<span id="cb94-2"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb94-3"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * CUDA kernel function to convert RGB image to grayscale.</span></span>
<span id="cb94-4"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb94-5"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param x Input RGB image data</span></span>
<span id="cb94-6"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param out Output grayscale image data</span></span>
<span id="cb94-7"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param w Image width</span></span>
<span id="cb94-8"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param h Image height</span></span>
<span id="cb94-9"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb94-10"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * Note: This function is executed on the GPU for each pixel in parallel.</span></span>
<span id="cb94-11"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb94-12"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">__global__ void rgb_to_grayscale_kernel(unsigned char* x, unsigned char* out, int w, int h) {</span></span>
<span id="cb94-13"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Calculate the current pixel coordinates</span></span>
<span id="cb94-14"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int c = blockIdx.x * blockDim.x + threadIdx.x;  // Column index</span></span>
<span id="cb94-15"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r = blockIdx.y * blockDim.y + threadIdx.y;  // Row index</span></span>
<span id="cb94-16"></span>
<span id="cb94-17"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    if (c &lt; w &amp;&amp; r &lt; h) {</span></span>
<span id="cb94-18"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        int i = r * w + c;  // Linear index for the current pixel</span></span>
<span id="cb94-19"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        int n = h * w;      // Total number of pixels in the image</span></span>
<span id="cb94-20"></span>
<span id="cb94-21"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Convert RGB to grayscale using the luminosity method</span></span>
<span id="cb94-22"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        // Weights: 0.2989 (Red), 0.5870 (Green), 0.1140 (Blue)</span></span>
<span id="cb94-23"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        out[i] = 0.2989 * x[i] + 0.5870 * x[i + n] + 0.1140 * x[i + 2 * n];</span></span>
<span id="cb94-24"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb94-25"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb94-26"></span>
<span id="cb94-27"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">/**</span></span>
<span id="cb94-28"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * Convert an RGB image to grayscale using CUDA.</span></span>
<span id="cb94-29"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb94-30"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @param input Input RGB image tensor of shape (3, H, W)</span></span>
<span id="cb94-31"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * @return Grayscale image tensor of shape (H, W)</span></span>
<span id="cb94-32"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> *</span></span>
<span id="cb94-33"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> * Note: This function launches the CUDA kernel to perform the conversion.</span></span>
<span id="cb94-34"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> */</span></span>
<span id="cb94-35"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">torch::Tensor rgb_to_grayscale(torch::Tensor input) {</span></span>
<span id="cb94-36"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    CHECK_INPUT(input);  // Verify input tensor properties</span></span>
<span id="cb94-37"></span>
<span id="cb94-38"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int h = input.size(1);  // Image height</span></span>
<span id="cb94-39"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    int w = input.size(2);  // Image width</span></span>
<span id="cb94-40"></span>
<span id="cb94-41"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Create an empty tensor for the output grayscale image</span></span>
<span id="cb94-42"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    torch::Tensor output = torch::empty({h, w}, input.options());</span></span>
<span id="cb94-43"></span>
<span id="cb94-44"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Define the thread block dimensions</span></span>
<span id="cb94-45"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 tpb(16, 16);</span></span>
<span id="cb94-46"></span>
<span id="cb94-47"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Calculate the number of blocks needed to cover the entire image</span></span>
<span id="cb94-48"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    dim3 blocks(cdiv(w, tpb.x), cdiv(h, tpb.y));</span></span>
<span id="cb94-49"></span>
<span id="cb94-50"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Launch the CUDA kernel</span></span>
<span id="cb94-51"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    rgb_to_grayscale_kernel&lt;&lt;&lt;blocks, tpb&gt;&gt;&gt;(</span></span>
<span id="cb94-52"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        input.data_ptr&lt;unsigned char&gt;(),</span></span>
<span id="cb94-53"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        output.data_ptr&lt;unsigned char&gt;(),</span></span>
<span id="cb94-54"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">        w, h</span></span>
<span id="cb94-55"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    );</span></span>
<span id="cb94-56"></span>
<span id="cb94-57"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Check for any CUDA errors during kernel launch</span></span>
<span id="cb94-58"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    C10_CUDA_KERNEL_LAUNCH_CHECK();</span></span>
<span id="cb94-59"></span>
<span id="cb94-60"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">    return output;</span></span>
<span id="cb94-61"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb94-62"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">'''</span></span></code></pre></div>
<div class="sourceCode" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># C++ function declaration for the RGB to grayscale conversion</span></span>
<span id="cb95-2">cpp_src <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"torch::Tensor rgb_to_grayscale(torch::Tensor input);"</span></span></code></pre></div>
<div class="sourceCode" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the CUDA module</span></span>
<span id="cb96-2">module <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_cuda(cuda_src, cpp_src, [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rgb_to_grayscale'</span>])</span></code></pre></div>
<div class="sourceCode" id="cb97" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the input image to grayscale and move it to CPU</span></span>
<span id="cb97-2">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> module.rgb_to_grayscale(imgc).cpu()</span>
<span id="cb97-3"></span>
<span id="cb97-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the resulting grayscale image</span></span>
<span id="cb97-5">show_img(res, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gray'</span>)</span></code></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/cuda-mode-notes/lecture-003/images/output_89_0.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div></li>
</ul>
</section>
</section>
<section id="conclusion-and-next-steps" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-and-next-steps">Conclusion and Next Steps</h2>
<ul>
<li><strong>CUDA Accessibility:</strong> CUDA programming is becoming increasingly important for implementing advanced deep learning techniques.</li>
<li><strong>Python-based Development:</strong> Writing CUDA kernels can be made easier by starting with Python code and converting it to C++.</li>
<li><strong>Notebook Environment:</strong> CUDA development can be done effectively in Jupyter Notebooks.</li>
<li><strong>Local and Cloud Development:</strong> CUDA code can be run on local machines with GPUs or on cloud instances.</li>
<li><strong>Conda for CUDA Setup:</strong> Conda is a recommended tool for managing CUDA environments.
<ul>
<li><strong>Tutorial:</strong> <a href="../../../posts/cuda-python-setup-tutorial/ubuntu/">Setting Up CUDA for Python on Ubuntu</a></li>
</ul></li>
<li><strong>Further Learning:</strong>
<ul>
<li>Explore other CUDA mode lectures.</li>
<li>Try implementing projects like 4-bit quantization, flash attention, etc.</li>
<li>Read and understand other people’s CUDA code (e.g., flash attention, bits and bytes, GPTQ).</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>notes</category>
  <category>cuda</category>
  <category>pytorch</category>
  <guid>https://christianjmills.com/posts/cuda-mode-notes/lecture-003/</guid>
  <pubDate>Sat, 31 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Livestream: Lessons from a Year of Building with LLMs</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/mastering-llms-course-notes/lessons-from-a-year-of-building-with-llms/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<section id="introduction-and-background" class="level3">
<h3 class="anchored" data-anchor-id="introduction-and-background">Introduction and Background</h3>
<ul>
<li><strong><a href="https://hugobowne.github.io/">Hugo Bowne-Anderson</a></strong>: Host of the <em>Vanishing Gradients</em> podcast and live stream. Has a background in data science, machine learning, and education.</li>
<li><strong>Live Stream Focus</strong>: Discussion of a report co-authored by six AI professionals (Eugene Yan, Shreya Shankar, Hamel Husain, Brian Bischof, Charles Frye, and Jason Liu), focusing on practical lessons learned from building real-world applications with Large Language Models (LLMs) over the past year.</li>
<li><strong>Report Link</strong>: <a href="https://applied-llms.org/">https://applied-llms.org/</a></li>
<li><strong>Recording Link</strong>: <a href="https://www.youtube.com/live/c0gcsprsFig">https://www.youtube.com/live/c0gcsprsFig</a></li>
<li><strong>Key Themes</strong>: The report covers tactical, operational, and strategic aspects of building LLM systems, including:
<ul>
<li><strong>Tactical</strong>: Prompt engineering, data management, evaluation strategies.</li>
<li><strong>Operational</strong>: Building development pipelines, integrating LLMs into existing workflows.</li>
<li><strong>Strategic</strong>: Understanding business use cases, defining success metrics, and building trust with stakeholders.</li>
</ul></li>
</ul>
</section>
<section id="panelist-introductions-and-motivations" class="level3">
<h3 class="anchored" data-anchor-id="panelist-introductions-and-motivations">Panelist Introductions and Motivations</h3>
<ul>
<li><strong>Eugene Yan</strong>:
<ul>
<li>Works at Amazon Books, focusing on recommendation systems and search.</li>
<li>Interested in using LLMs to enhance recommendations and search by improving customer understanding.</li>
<li>Co-authored several key resources on prompt engineering and LLM evaluation.</li>
<li>Blog: <a href="https://eugeneyan.com">https://eugeneyan.com</a></li>
</ul></li>
<li><strong>Shreya Shankar</strong>:
<ul>
<li>Researcher and ML engineer pursuing a PhD focused on data management, UX, and HCI for machine learning.</li>
<li>Interested in building intelligent software with LLMs, particularly for small teams and early-stage products.</li>
<li>Emphasis on developing evaluation methods that are simple and accessible.</li>
<li>Conducts research on evaluating LLM output quality and validating evaluation methods.</li>
</ul></li>
<li><strong>Hamel Husain</strong>:
<ul>
<li>25 years of experience in machine learning, including work on developer tools and ML infrastructure at GitHub.</li>
<li>Led research at GitHub that contributed to Copilot.</li>
<li>Passionate about using LLMs to accelerate software development and launch applications faster.</li>
<li>Strong advocate for prioritizing evaluation (<strong>evals</strong>) as a core part of the AI development process.</li>
<li>Blog post: <a href="https://hamel.dev/blog/posts/evals/">https://hamel.dev/blog/posts/evals/</a></li>
</ul></li>
<li><strong>Brian Bischof</strong>:
<ul>
<li>Head of AI at Hex, leads the team developing Magic (an AI-powered data science tool).</li>
<li>Extensive experience building data teams at Blue Bottle Coffee, Stitch Fix, and Weights &amp; Biases.</li>
<li>Passionate about applying LLMs to answer questions with data, particularly in the context of data science workflows.</li>
<li>Strong advocate for using notebooks for exploring and understanding data.</li>
</ul></li>
<li><strong>Charles Frye</strong>:
<ul>
<li>Works at Modal, focused on teaching people to build AI applications.</li>
<li>Background in psychopharmacology, neurobiology, and neural networks.</li>
<li>Interested in developing intelligent software and using LLMs to democratize cognition.</li>
<li>Key contributor to Modal’s infrastructure and developer tools, including the TensorRT-LLM library.</li>
</ul></li>
</ul>
</section>
<section id="the-genesis-of-the-report" class="level3">
<h3 class="anchored" data-anchor-id="the-genesis-of-the-report">The Genesis of the Report</h3>
<ul>
<li><strong>Origin</strong>: The report originated from discussions within a group chat among the co-authors.</li>
<li><strong>Initial Motivation</strong>:
<ul>
<li><strong>Brian Bischof</strong>: Was considering writing about a year of LLMs.</li>
<li><strong>Eugene Yan</strong>: Had already started drafting similar content.</li>
<li><strong>Charles Frye</strong>: Suggested a collaborative effort.</li>
<li><strong>Hamel Husain and Jason Liu</strong>: Enthusiastically joined the project.</li>
<li><strong>Shreya Shankar</strong>: Was invited for her expertise in evaluation and editing.</li>
</ul></li>
<li><strong>Organization</strong>:
<ul>
<li><strong>Brian Bischof</strong>: Proposed structuring the report into tactical, operational, and strategic levels.</li>
</ul></li>
<li><strong>Collaborative Workflow</strong>:
<ul>
<li>Authors contributed their ideas and experiences.</li>
<li>Content was synthesized and organized collaboratively.</li>
<li>Charles Frye played a key role in editing and consolidating the material.</li>
</ul></li>
</ul>
</section>
<section id="the-importance-of-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="the-importance-of-evaluation">The Importance of Evaluation</h3>
<ul>
<li><strong>Traditional Evals vs.&nbsp;LLM Evals</strong>:
<ul>
<li><strong>Shreya Shankar</strong>:
<ul>
<li>Traditional evaluation methods often fail to uncover issues arising from real-world data idiosyncrasies (e.g., typos, inconsistent casing).</li>
<li>Canonical benchmarks and datasets often rely on clean, pre-processed data, which does not reflect real-world data challenges.</li>
<li><strong>Example</strong>: Mistral struggles to retrieve names from documents if the name is in lowercase.</li>
<li>Traditional evals often lack methods for validating the evaluation methods themselves.</li>
<li>LLM-based evals can make evaluation more accessible to smaller teams who lack resources for traditional methods.</li>
<li><strong><a href="https://arxiv.org/abs/2404.12272">EvalGen Paper</a></strong>: Discusses a flow-based approach to validating evaluation methods and constructing appropriate evals for deployment.</li>
</ul></li>
</ul></li>
<li><strong>Overcoming Barriers to Evaluation</strong>:
<ul>
<li>Developers often struggle with the concept of evals and how to get started.</li>
<li>Shreya Shankar’s research tools provide a visual, intuitive approach to building and understanding evals, similar to Scratch for programming.</li>
<li>This “Scratch for evals” approach makes evals more accessible and understandable.</li>
</ul></li>
<li><strong>Evaluation as an Integral Part of AI Development</strong>:
<ul>
<li>Evaluation is not optional, it’s an essential part of the AI development process.</li>
<li>Evals are not separate from building AI, they are how you build AI.</li>
<li>Measuring progress and having a systematic approach to improvement are critical.</li>
<li>Focus on making evals frictionless and integrated into the workflow to enable continuous improvement.</li>
</ul></li>
<li><strong>Shifting the Focus from Tools to Process</strong>:
<ul>
<li>Developers often focus on tools (e.g., vector databases, embeddings) rather than understanding the underlying process of building and improving AI applications.</li>
<li>It’s essential to shift the focus from tools to the process of evaluation and data understanding.</li>
</ul></li>
<li><strong>Evaluation as a Proxy for Loss Functions</strong>:
<ul>
<li>Traditional machine learning relies on explicit loss functions for optimization.</li>
<li>In generative AI, the loss functions are less defined, and evals act as a proxy for measuring progress and alignment with desired outcomes.</li>
</ul></li>
</ul>
</section>
<section id="underappreciated-aspects-of-llm-development" class="level3">
<h3 class="anchored" data-anchor-id="underappreciated-aspects-of-llm-development">Underappreciated Aspects of LLM Development</h3>
<ul>
<li><strong>Equipping Engineers with LLM Skills</strong>:
<ul>
<li>Organizations need to focus on training existing software engineers to understand and effectively use LLMs.</li>
<li>Key areas for training:
<ul>
<li>Basic evaluation methods (e.g., using synthetic data, Kaggle datasets).</li>
<li>Understanding the autoregressive nature of LLM generation and its impact on latency.</li>
<li>Understanding context as conditioning.</li>
</ul></li>
</ul></li>
<li><strong>Moving from Prototype to Production</strong>:
<ul>
<li>The industry has focused heavily on demos and prototypes, and the bar for “production” has been lowered with generative AI.</li>
<li><strong>Prototype++</strong>: Products are being launched without rigorous evaluation or clear methods for quantifying improvements.</li>
<li>The definition of “production” should include systematic improvement processes and clear evidence of progress for stakeholders.</li>
<li><strong>Challenge</strong>: Moving from prototype++ to true production-ready LLM applications with robust evals and improvement processes.</li>
</ul></li>
<li><strong>The Importance of Data Literacy</strong>:
<ul>
<li>Data literacy is essential for working with LLMs, even if you are not training models from scratch.</li>
<li>Data literacy enables developers to:
<ul>
<li><strong>Analyze and debug systems</strong>: By examining data, developers can identify issues and understand system behavior.</li>
<li><strong>Develop domain-specific evals</strong>: Understanding the data is crucial for creating meaningful and effective evaluation methods.</li>
</ul></li>
<li><strong>Challenge</strong>: Overcoming the misconception that AI automates everything and realizing the ongoing need to look at and understand data.</li>
</ul></li>
<li><strong>Specific Data Literacy Skills</strong>:
<ul>
<li><strong>Assessing Output Quality</strong>:
<ul>
<li>Develop methods for determining whether an output is good or bad.</li>
<li>Use a combination of binary indicators (e.g., conciseness, tone, presence of specific phrases) to simplify evaluation.</li>
</ul></li>
<li><strong>Pairwise Comparisons</strong>: Compare two models or pipelines directly instead of relying on individual ratings.</li>
<li><strong>Understanding Implicit Constraints</strong>: Define criteria for “good” that align with user expectations.</li>
<li><strong>Simplifying Evaluation</strong>: Break down complex evaluation tasks into smaller, more manageable binary assessments.</li>
</ul></li>
<li><strong>The Role of Human-in-the-Loop Evaluation</strong>:
<ul>
<li>Importance of manual data labeling and review, especially in the early stages of development.</li>
<li>“Homework” approach at Hex: Team members use interactive Hex applications to provide feedback on model outputs and assist with data labeling.</li>
<li>This process helps to bootstrap data sets and align LLM evaluations with human judgment.</li>
</ul></li>
</ul>
</section>
<section id="misconceptions-and-knowledge-gaps-in-organizations" class="level3">
<h3 class="anchored" data-anchor-id="misconceptions-and-knowledge-gaps-in-organizations">Misconceptions and Knowledge Gaps in Organizations</h3>
<ul>
<li><strong>The “AI Engineer” Narrative and Its Limitations</strong>:
<ul>
<li><strong>Popular Characterization</strong>:
<ul>
<li>AI engineers are portrayed as primarily focused on tools, infrastructure, chains, and agents, with limited involvement in training, evals, inference, and data.</li>
</ul></li>
<li><strong>Skills Gaps</strong>:
<ul>
<li>Neglecting data literacy and evaluation skills creates significant challenges beyond the MVP stage.</li>
<li>AI engineers may find themselves unable to systematically improve their applications due to a lack of understanding of data and evaluation.</li>
</ul></li>
<li><strong>Title Issues</strong>:
<ul>
<li>The “AI engineer” title sets unrealistic expectations and places undue pressure on individuals when projects face challenges.</li>
</ul></li>
</ul></li>
<li><strong>Addressing the Talent Gap</strong>:
<ul>
<li>The most significant impact on AI product development is the talent and skills of the team.</li>
<li>Organizations need to hire for data literacy and evaluation expertise, not just tooling and infrastructure skills.</li>
<li><strong>Consulting Work</strong>: A significant portion of Hamel’s consulting work arises from addressing this talent gap and helping organizations build effective AI teams.</li>
</ul></li>
<li><strong>Real-World Example of Successful “AI Engineer” Hiring</strong>:
<ul>
<li>Successfully hired “AI engineers” by focusing on core data science skills.</li>
<li>Take-home exam focused on data cleaning, demonstrating the importance of data literacy in his definition of the role.</li>
</ul></li>
<li><strong>The Importance of Data Literacy in AI Engineering</strong>:
<ul>
<li>Data literacy is essential for AI engineers to analyze outputs, understand failure modes, and develop effective evaluation strategies.</li>
<li>It’s crucial for AI engineers to be able to examine data and draw conclusions about system performance without relying solely on AI tools.</li>
</ul></li>
</ul>
</section>
<section id="promising-opportunities-and-future-challenges" class="level3">
<h3 class="anchored" data-anchor-id="promising-opportunities-and-future-challenges">Promising Opportunities and Future Challenges</h3>
<ul>
<li><strong>Focusing on Unsexy, Expensive, and Slow Tasks</strong>:
<ul>
<li>LLMs offer the potential to automate tasks that are currently time-consuming and costly for humans.</li>
<li><strong>Examples</strong>:
<ul>
<li>Classification.</li>
<li>Information Extraction.</li>
<li>Quiz Generation from Textbooks.</li>
</ul></li>
<li><strong>Focus</strong>: Identify tasks that are currently unsexy but can be effectively delegated to LLMs, leading to cost savings and increased efficiency.</li>
</ul></li>
<li><strong>Developing More Thoughtful UX</strong>:
<ul>
<li>LLMs should not be seen as one-shot wonders with perfect UX.</li>
<li>Graceful failure modes and user-friendly interfaces are essential.</li>
<li><strong>Co-pilot Mentality</strong>: Design systems that allow users to edit and interact with LLM outputs, turning failures into learning opportunities.</li>
</ul></li>
<li><strong>Empowering End Users as Programmers</strong>:
<ul>
<li>AI will not be able to read minds, so empowering users to interact and refine LLM outputs is crucial.</li>
<li><strong>ChatGPT Example</strong>: Users act as programmers by refining their prompts and editing previous messages to achieve their desired outcomes.</li>
<li><strong>Notebook Interfaces</strong>: Offer a flexible workspace for both technical and non-technical users to interact with and programmatically control LLMs.</li>
</ul></li>
</ul>
</section>
<section id="key-insights-from-collaboration" class="level3">
<h3 class="anchored" data-anchor-id="key-insights-from-collaboration">Key Insights from Collaboration</h3>
<ul>
<li><strong>Value of Community and Alignment</strong>:
<ul>
<li>The most valuable aspect of the collaboration was the opportunity to connect with other experts, discuss ideas, and learn from each other’s experiences.</li>
<li>Having a network of trusted peers to consult with and debate challenging questions is essential.</li>
</ul></li>
<li><strong>Surprising Alignment Despite Diverse Perspectives</strong>:
<ul>
<li>The authors, despite working in different parts of the LLM stack (research, infrastructure, product development, etc.), found a remarkable degree of alignment in their key insights.</li>
<li>They had “grabbed different parts of the elephant” but had all come to similar conclusions about the core principles of building with LLMs.</li>
</ul></li>
<li><strong>The Collaborative Process as a “Raid Boss”</strong>:
<ul>
<li>The collaborative effort was akin to battling a raid boss in an MMORPG, requiring a skilled and coordinated team effort.</li>
<li>Charles Frye played a critical role in editing and consolidating the vast amount of material.</li>
<li>Hamel Husain demonstrated high agency by quickly setting up a website for the report.</li>
<li>The collaborative process was enjoyable, inspiring, and ultimately led to a highly impactful resource for the community.</li>
</ul></li>
<li><strong>Impact Beyond Industry</strong>:
<ul>
<li>The report’s impact has extended beyond industry, reaching academics and researchers who traditionally do not engage with industry blogs.</li>
<li>The report’s timing was critical, capturing the widespread interest in LLMs and their potential to transform computing.</li>
</ul></li>
</ul>
</section>
<section id="the-importance-of-data-centric-ai-development" class="level3">
<h3 class="anchored" data-anchor-id="the-importance-of-data-centric-ai-development">The Importance of Data-Centric AI Development</h3>
<ul>
<li><strong>Data Literacy as a Core Skill</strong>:
<ul>
<li>The ability to understand and work with data is essential for success with LLMs.</li>
<li>Traditional software engineering often focuses on the syntactic correctness of code, while data science emphasizes the semantic meaning of data.</li>
<li><strong>Challenge</strong>: Bridging this gap in perspective and helping software engineers develop data literacy skills.</li>
</ul></li>
<li><strong>Developing Intuition for Data Distributions</strong>:
<ul>
<li>Experience with data analysis and visualization leads to an intuitive understanding of data distributions.</li>
<li>This intuition allows for quickly identifying issues in data or model outputs, even without specific theoretical knowledge.</li>
</ul></li>
</ul>
</section>
<section id="building-trust-with-stakeholders-and-users" class="level3">
<h3 class="anchored" data-anchor-id="building-trust-with-stakeholders-and-users">Building Trust with Stakeholders and Users</h3>
<ul>
<li><strong>Collaborative Design</strong>:
<ul>
<li>Involve designers, UX professionals, and domain experts early in the process to understand user needs and build trust.</li>
<li>Co-designing with stakeholders helps identify potential pitfalls and ensure the application aligns with user expectations.</li>
</ul></li>
<li><strong>Slow Rollout and Iterative Feedback</strong>:
<ul>
<li>Slowly roll out LLM applications to small groups of users to gather feedback and identify issues before wider deployment.</li>
<li>Repeated interactions with small groups provide more valuable insights than initial interactions with larger groups.</li>
</ul></li>
<li><strong>User Feedback as the Antidote to Demoitis</strong>:
<ul>
<li>Gathering user feedback through beta programs and interactions at meetups is crucial for moving beyond the hype of demos.</li>
<li>Directly observing user reactions provides valuable insights into usability and helps identify areas for improvement.</li>
</ul></li>
</ul>
</section>
<section id="systems-thinking-vs.-model-focus" class="level3">
<h3 class="anchored" data-anchor-id="systems-thinking-vs.-model-focus">Systems Thinking vs.&nbsp;Model Focus</h3>
<ul>
<li><strong>The Importance of Systems-Level Design</strong>:
<ul>
<li>Building successful LLM applications requires a systems-level perspective, not just a focus on the model itself.</li>
<li><strong>Example</strong>: At Hex, the team started by designing the overall system architecture, including prompt templating, evaluation frameworks, and context construction (RAG).</li>
<li>These architectural decisions have proven durable and have guided the project’s development.</li>
</ul></li>
<li><strong>Key System Design Considerations</strong>:
<ul>
<li><strong>Evals</strong>: Prioritize building robust evaluation frameworks from the outset.</li>
<li><strong>Composability</strong>: Design systems with composability in mind, especially for context construction and prompt generation.</li>
<li><strong>Meta-Programming</strong>: Think of prompt construction as a form of meta-programming, allowing for flexible and adaptable system behavior.</li>
</ul></li>
<li><strong>Leveraging Prior Experience from ML</strong>:
<ul>
<li>Much of the knowledge and best practices from traditional machine learning apply to building LLM systems.</li>
<li><strong>Example</strong>: The principles outlined in the book <em>Machine Learning Design Patterns</em> are directly relevant to LLM application development.</li>
</ul></li>
</ul>
</section>
<section id="final-advice-and-future-directions" class="level3">
<h3 class="anchored" data-anchor-id="final-advice-and-future-directions">Final Advice and Future Directions</h3>
<ul>
<li><strong>Prioritize Evaluation</strong>:
<ul>
<li>Start by creating sample inputs and ideal outputs, then build evaluation methods to measure progress and identify issues.</li>
<li>Focus on creating a gold standard dataset, even if it’s small, to guide evaluation and refinement.</li>
</ul></li>
<li><strong>Read, Build, and Share</strong>:
<ul>
<li><strong>Read</strong>: Engage with high-quality resources and articles that distill key concepts and best practices.</li>
<li><strong>Build</strong>: Get hands-on experience by building demos and experimenting with LLMs to understand their capabilities and limitations.</li>
<li><strong>Share</strong>: Contribute to the community by sharing your experiences, insights, and code to accelerate learning and adoption.</li>
</ul></li>
<li><strong>Focus on Iterative Improvement</strong>:
<ul>
<li>Embrace a process of validated iterative improvement, similar to gradient descent in optimization.</li>
<li>LLMs introduce complexity and uncertainty, but the fundamental principles of building complex systems remain the same: make small, validated steps toward improvement.</li>
<li><strong>Key Elements</strong>: Data, experimentation, operationalization, and rapid deployment to production.</li>
<li>Focus on iterative experimentation and building evaluation frameworks to guide development toward user-centric solutions.
<ul>
<li><strong>Zero-to-One Mentality</strong>: Break down the problem into smaller, manageable chunks and iteratively improve each component.</li>
</ul></li>
</ul></li>
<li><strong>The Future of Knowledge Access</strong>:
<ul>
<li>LLMs have the potential to make knowledge more accessible, personalized, and useful.</li>
<li><strong>Example</strong>: Memory extenders and personal Memex systems.</li>
<li>LLMs will transform how we interact with information, socialize, and carry out our daily lives.</li>
</ul></li>
</ul>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<ul>
<li>The report and this discussion highlight the essential lessons learned from a year of building with LLMs.</li>
<li><strong>Key Takeaways</strong>:
<ul>
<li><strong>Data Literacy</strong>: Prioritize understanding and working with data as a foundational skill.</li>
<li><strong>Evaluation</strong>: Make evaluation a core part of the development process, focusing on human-in-the-loop methods and iterative refinement.</li>
<li><strong>Systems Thinking</strong>: Build end-to-end systems that go beyond model focus, considering aspects like prompt design, context construction, and evaluation frameworks.</li>
<li><strong>Process over Tools</strong>: Focus on developing robust processes and methodologies rather than relying solely on tools.</li>
<li><strong>User-Centricity</strong>: Design applications with user needs in mind, prioritizing trust, feedback, and iterative improvement.</li>
</ul></li>
<li>The future of LLMs is bright, with the potential to transform how we interact with information and build intelligent software.</li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>notes</category>
  <category>llms</category>
  <guid>https://christianjmills.com/posts/mastering-llms-course-notes/lessons-from-a-year-of-building-with-llms/</guid>
  <pubDate>Fri, 30 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Conference Talk 20: Back to Basics for RAG</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-020/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Presentation Resources:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Presentation Resources:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Slides:</strong> <a href="https://docs.google.com/presentation/d/19L2j2-fBC_iPGswwER3Cfsy7N3HSqUrVfxh2xvcBU2Y/edit#slide=id.p">Back to basics?</a></li>
</ul>
</div>
</div>
<section id="about-jo-kristian-bergum" class="level3">
<h3 class="anchored" data-anchor-id="about-jo-kristian-bergum">About Jo Kristian Bergum</h3>
<ul>
<li><strong>Distinguished Engineer</strong> at Vespa.ai</li>
<li>18 years at Vespa.ai, 20 years in search and recommendation.</li>
<li><strong><a href="https://vespa.ai/">Vespa.ai</a>:</strong>
<ul>
<li>Serving platform spun out of Yahoo.</li>
<li>Open source since 2017.</li>
<li><strong>Blog:</strong> <a href="https://blog.vespa.ai/">https://blog.vespa.ai/</a></li>
</ul></li>
<li>Active on Twitter (<a href="https://x.com/jobergum"><span class="citation" data-cites="jobergum">@jobergum</span></a>), enjoys posting memes.</li>
</ul>
</section>
<section id="talk-overview" class="level3">
<h3 class="anchored" data-anchor-id="talk-overview">Talk Overview</h3>
<ul>
<li><strong>Stuffing Text into Language Model Prompts:</strong> Using RAG beyond question answering, e.g., for classification by retrieving relevant training examples.</li>
<li><strong>Information Retrieval (The R in RAG):</strong> Exploring the core concepts of retrieval and its importance in RAG pipelines.</li>
<li><strong>Evaluation of IR Systems:</strong>
<ul>
<li>Building your own evaluation systems to measure and improve search performance.</li>
<li>Demonstrating the impact of changes to your CTO.</li>
</ul></li>
<li><strong>Representational Approaches for IR:</strong>
<ul>
<li>Discussing <strong>sparse</strong> and <strong>dense</strong> representations (BM25, vectors, embeddings).</li>
<li>Examining baselines for comparison.</li>
</ul></li>
</ul>
</section>
<section id="demystifying-rag" class="level3">
<h3 class="anchored" data-anchor-id="demystifying-rag">Demystifying RAG</h3>
<ul>
<li><strong>RAG (Retrieval Augmented Generation):</strong> A technique for enhancing language model outputs by retrieving relevant context from external knowledge sources.</li>
<li><strong>Common Use Cases:</strong> Question answering, chatbots, generating grounded responses.
<ul>
<li><div class="callout callout-style-default callout-note callout-titled" title="Example:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example:
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Current date is {date}, Don’t be rude. I’ll tip $5. Think step-by-step.</strong></p>
<p>I want you to classify the text input as positive, negative or neutral. Examples:</p>
<p><strong>Input:</strong> I’m very happy today<br>
<strong>Output:</strong> positive</p>
<p><strong>Input:</strong> I’m sad today<br>
<strong>Output:</strong> negative</p>
<p><strong>Input:</strong> I don’t know what to feel today<br>
<strong>Output:</strong> neutral</p>
<p>✨ <strong>{many_retrieved_context_sensitive_examples}</strong> ✨</p>
<p><strong>Input:</strong> {input}<br>
<strong>Output:</strong></p>
</div>
</div></li>
<li><div class="callout callout-style-default callout-note callout-titled" title="Example:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Example:
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Current date is {date}, Don’t be rude. I’ll tip $5. Think step-by-step.</strong></p>
<p>I want you to summarize and answer the question using context retrieved by a search engine.<br>
<strong>Context:</strong> [1] BERT: Pre-training of deep bidirectional transformers for language understanding…<br>
<strong>Question:</strong> What is a bidirectional transformer model?<br>
<strong>Helpful answer:</strong> bidirectional means that tokens attend to all other tokens in the input sequence [1].</p>
<p>✨ <strong>{retrieved_context_sensitive_examples}</strong> ✨</p>
<p><strong>Context:</strong> {retrieved_context_question}<br>
<strong>Question:</strong> {question}<br>
<strong>Helpful answer:</strong></p>
</div>
</div></li>
</ul></li>
<li><strong>Basic Architecture:</strong>
<ul>
<li><strong>Orchestration Component:</strong> Manages the flow of data and interactions between components.</li>
<li><strong>Input:</strong> User queries or prompts.</li>
<li><strong>Output:</strong> Generated responses.</li>
<li><strong>Evaluation:</strong> Measures the quality of the output.</li>
<li><strong>Prompting:</strong> Techniques for interacting with language models.</li>
<li><strong>Language Models:</strong> The core component for generating text.</li>
<li><strong>State:</strong> Data storage, including files, search engines, vector databases, and databases.</li>
</ul></li>
</ul>
</section>
<section id="cutting-through-the-hype" class="level3">
<h3 class="anchored" data-anchor-id="cutting-through-the-hype">Cutting Through the Hype</h3>
<ul>
<li><strong>Challenges in the RAG Landscape:</strong>
<ul>
<li>Constant stream of new models, components, and tricks.</li>
<li>Oversimplification of RAG as just vector embeddings and language models.</li>
<li>Lack of focus on evaluating performance on specific data.</li>
</ul></li>
<li><strong>Importance of Information Retrieval:</strong>
<ul>
<li>Retrieval is a deep and well-studied field, crucial for many applications.</li>
<li>It’s more complex than simply encoding text into a single vector representation.</li>
<li>Building effective RAG solutions requires understanding and leveraging existing retrieval techniques.</li>
</ul></li>
</ul>
</section>
<section id="evaluating-information-retrieval-systems" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-information-retrieval-systems">Evaluating Information Retrieval Systems</h3>
<ul>
<li><strong>Information Retrieval System as a Black Box:</strong>
<ul>
<li>Input: Query</li>
<li>Output: Ranked list of documents</li>
</ul></li>
<li><strong>Evaluation Based on Relevance:</strong>
<ul>
<li>Human annotators judge the relevance of retrieved documents to the query.</li>
<li><strong>Binary Judgment:</strong> Relevant or not relevant.</li>
<li><strong>Graded Judgment:</strong> Levels of relevance (e.g., 0 - irrelevant, 1 - slightly relevant, 2 - highly relevant).</li>
</ul></li>
<li><strong>Established IR Research and Benchmarks:</strong>
<ul>
<li><strong><a href="https://trec.nist.gov/">TREC (Text Retrieval Conference)</a>:</strong> Evaluates various retrieval tasks, including news retrieval.</li>
<li><strong><a href="https://microsoft.github.io/msmarco/">MS MARCO</a>:</strong> Large-scale dataset from Bing with real-world annotated data used for training embedding models.
<ul>
<li><strong>HuggingFace Hub:</strong> <a href="https://huggingface.co/datasets/microsoft/ms_marco">microsoft/ms_marco</a></li>
</ul></li>
<li><strong><a href="https://github.com/beir-cellar/beir">BEIR</a>:</strong> Evaluates models in a zero-shot setting without training data.</li>
</ul></li>
<li><strong>Common IR Metrics:</strong>
<ul>
<li><strong>Recall@K:</strong> Measures the proportion of relevant documents retrieved within the top K positions.</li>
<li><strong>Precision@K:</strong> Measures the proportion of relevant documents among the top K retrieved documents.</li>
<li><strong>nDCG (Normalized Discounted Cumulative Gain):</strong> Rank-aware metric that considers graded relevance judgments.</li>
<li><strong>Reciprocal Rank:</strong> Measures the position of the first relevant hit.</li>
<li><strong>LGTM (Looks Good To Me):</strong> Informal but common metric in industry.</li>
</ul></li>
<li><strong>Production System Metrics:</strong> Engagement (clicks, dwell time), add-to-cart rate, revenue.</li>
<li><strong>Benchmark Limitations:</strong>
<ul>
<li>Often compare flat lists, not personalized results.</li>
<li>Don’t always transfer well to specific domains or use cases.</li>
</ul></li>
</ul>
</section>
<section id="building-your-own-relevancy-dataset" class="level3">
<h3 class="anchored" data-anchor-id="building-your-own-relevancy-dataset">Building Your Own Relevancy Dataset</h3>
<ul>
<li><p><strong>The Importance of Measuring:</strong> To improve RAG performance, measure relevance on your specific data.</p></li>
<li><p><strong>Creating a Relevancy Dataset:</strong></p>
<ul>
<li><strong>Leverage Existing Traffic:</strong> Log user searches and judge the relevance of results.</li>
<li><strong>Bootstrap with Language Models:</strong> Use LLMs to generate questions based on your content and judge the relevance of retrieved passages.</li>
</ul></li>
<li><p><strong>Dataset Format:</strong></p>
<ul>
<li><p>Simple TSV file is sufficient.</p></li>
<li><p><strong>Query ID, Document ID, Relevance Label</strong></p>
<ul>
<li><table class="caption-top table">
<thead>
<tr class="header">
<th>qid</th>
<th>docid</th>
<th>relevance label</th>
<th>comment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>3 (how to ..)</td>
<td>4</td>
<td>2</td>
<td></td>
</tr>
<tr class="even">
<td>3 (where ..)</td>
<td>2</td>
<td>0</td>
<td></td>
</tr>
</tbody>
</table></li>
</ul></li>
</ul></li>
<li><p><strong>Static vs.&nbsp;Dynamic Collections:</strong></p>
<ul>
<li>Static collections are preferred for consistent evaluation.</li>
<li>Dynamic collections can introduce noise when evaluating metrics.</li>
</ul></li>
<li><p><strong>Using Language Models for Relevance Judgments:</strong></p>
<ul>
<li><p><strong>Paper:</strong> <a href="https://arxiv.org/abs/2309.10621">Large language models can accurately predict searcher preferences</a></p></li>
<li><p>LLMs can be prompted to assess the relevance of queries and passages.</p></li>
<li><p>Find a prompt that correlates well with your golden dataset.</p></li>
<li><p>Enables cheaper and larger-scale evaluation.</p></li>
<li><p><strong>Example:</strong> Microsoft research demonstrating LLM effectiveness in judging relevance.</p>
<ul>
<li><p><strong>Paper:</strong> <a href="https://arxiv.org/abs/2406.06519">UMBRELA: UMbrela is the (Open-Source Reproduction of the) Bing RELevance Assessor</a></p></li>
<li><div class="callout callout-style-default callout-note callout-titled" title="Figure 1: Prompt used for relevance assessment.">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Figure 1: Prompt used for relevance assessment.
</div>
</div>
<div class="callout-body-container callout-body">
<pre class="text"><code>Given a query and a passage, you must provide a score on an
integer scale of 0 to 3 with the following meanings:
0 = represent that the passage has nothing to do with the query,
1 = represents that the passage seems related to the query but
does not answer it,
2 = represents that the passage has some answer for the query,
but the answer may be a bit unclear, or hidden amongst extraneous
information and
3 = represents that the passage is dedicated to the query and
contains the exact answer.

Important Instruction: Assign category 1 if the passage is
somewhat related to the topic but not completely, category 2 if
passage presents something very important related to the entire
topic but also has some extra information and category 3 if the
passage only and entirely refers to the topic. If none of the
above satisfies give it category 0.

Query: {query}
Passage: {passage}

Split this problem into steps:
Consider the underlying intent of the search.
Measure how well the content matches a likely intent of the query
(M).
Measure how trustworthy the passage is (T).
Consider the aspects above and the relative importance of each,
and decide on a final score (O). Final score must be an integer
value only.
Do not provide any code in result. Provide each score in the
format of: ##final score: score without providing any reasoning.</code></pre>
</div>
</div></li>
</ul></li>
</ul></li>
<li><p><strong>Benefits of Custom Relevancy Datasets:</strong></p>
<ul>
<li>Iterate and measure the impact of changes to your retrieval system.</li>
<li>Track improvements in metrics like nDCG.</li>
<li><strong>Example:</strong> Vespa documentation search showing improvement in nDCG with hybrid retrieval methods.</li>
</ul></li>
</ul>
</section>
<section id="representational-approaches-and-scoring-functions" class="level3">
<h3 class="anchored" data-anchor-id="representational-approaches-and-scoring-functions">Representational Approaches and Scoring Functions</h3>
<ul>
<li><strong>Motivation for Efficient Retrieval:</strong> Avoid scoring all documents in the collection for each query.</li>
<li><strong>Sparse Representations:</strong>
<ul>
<li><strong>Term-based:</strong> Documents and queries are represented by the presence and weight of terms.</li>
<li><strong>Efficient Retrieval:</strong> Inverted indexes, algorithms like WAND and MaxScore.</li>
<li><strong>Example:</strong> Keyword search technologies like Elasticsearch and Vespa.</li>
</ul></li>
<li><strong>Dense Representations:</strong>
<ul>
<li><strong>Embedding-based:</strong> Documents and queries are represented by vectors in a latent space.</li>
<li><strong>Neural/Sparse Embedding Models:</strong> Learn term weights using transformer models.</li>
<li><strong>Efficient Retrieval:</strong> Approximate Nearest Neighbor search, vector databases.</li>
<li><strong>Example:</strong> Text embedding models, semantic search.</li>
</ul></li>
<li><strong>Advantages of Dense Representations:</strong>
<ul>
<li>Capture semantic relationships between words and concepts.</li>
<li>Enable search based on meaning rather than exact keyword matches.</li>
</ul></li>
<li><strong>Challenges of Dense Representations:</strong>
<ul>
<li><strong>Transfer Learning:</strong> Off-the-shelf models may not perform well on specific data.</li>
<li><strong>Diluted Representations:</strong> Averaging token embeddings into a single vector can lose information.</li>
<li><strong>Fixed Vocabulary:</strong> Out-of-vocabulary words can be mapped to incorrect concepts.</li>
<li><strong>Chunking:</strong> Long documents need to be chunked to maintain precision.</li>
</ul></li>
<li><strong>Baselines for Comparison:</strong>
<ul>
<li><strong>BM25:</strong>
<ul>
<li><strong>Term-based scoring function.</strong></li>
<li><strong>Unsupervised, based on corpus statistics.</strong></li>
<li><strong>Cheap, small index footprint.</strong></li>
<li><strong>Strong baseline for many tasks.</strong></li>
<li><strong>Limitations:</strong> Requires language-specific tokenization, struggles with long context.</li>
</ul></li>
<li><strong>Example:</strong> BM25 outperforming embedding models on long context documents in ColBERT evaluation.
<ul>
<li><strong>Blog Post:</strong> <a href="https://blog.vespa.ai/announcing-long-context-ColBERT-in-vespa/">Announcing Vespa Long-Context ColBERT</a></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="hybrid-approaches" class="level3">
<h3 class="anchored" data-anchor-id="hybrid-approaches">Hybrid Approaches</h3>
<ul>
<li><strong>Combining Sparse and Dense Representations:</strong>
<ul>
<li>Can overcome limitations of individual approaches.</li>
<li>Example: Combining keyword search with embedding retrieval.</li>
</ul></li>
<li><strong>Challenges of Hybrid Approaches:</strong>
<ul>
<li>Calibration of different scoring functions.</li>
<li>Determining when to ignore embedding results.</li>
<li>Requires careful tuning and evaluation.</li>
</ul></li>
</ul>
</section>
<section id="long-context-and-chunking" class="level3">
<h3 class="anchored" data-anchor-id="long-context-and-chunking">Long Context and Chunking</h3>
<ul>
<li><strong>Desire for Long Context Models:</strong> Eliminate the need for chunking.</li>
<li><strong>Reality of Chunking:</strong>
<ul>
<li>Necessary for meaningful representations in high-precision search.
<ul>
<li>Dense representation beyond 256 tokens are bad for high-precision search.</li>
</ul></li>
<li><strong>Pooling operations dilute representations in long contexts.</strong></li>
<li><strong>Limited training data for long context models.</strong></li>
</ul></li>
<li><strong>Chunking Strategies:</strong>
<ul>
<li>Split long documents into smaller segments.</li>
<li>Index multiple vectors per row in a database.</li>
</ul></li>
</ul>
</section>
<section id="real-world-rag-considerations" class="level3">
<h3 class="anchored" data-anchor-id="real-world-rag-considerations">Real-World RAG Considerations</h3>
<ul>
<li><strong>Google Search Signals:</strong>
<ul>
<li><strong>Text Similarity:</strong> BM25, vector cosine similarity.</li>
<li><strong>Freshness:</strong> Recency of content.</li>
<li><strong>Authority:</strong> Trustworthiness of the source.</li>
<li><strong>Quality:</strong> Overall content quality.</li>
<li><strong>PageRank:</strong> Link analysis algorithm.</li>
<li><strong>Revenue:</strong> In advertising-based search.</li>
</ul></li>
<li><strong>GBDT (Gradient Boosted Decision Trees):</strong>
<ul>
<li>Effective for combining tabular features.</li>
<li>Still relevant for real-world search.</li>
</ul></li>
</ul>
</section>
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">Summary</h3>
<ul>
<li><strong>Information retrieval is more than just vector representations.</strong></li>
<li><strong>Build your own evaluations to improve retrieval.</strong></li>
<li><strong>Don’t ignore the BM25 baseline.</strong></li>
<li><strong>Choose technologies with hybrid capabilities.</strong></li>
<li><strong>Real-world search involves more than just text similarity.</strong></li>
</ul>
</section>
<section id="qa-session" class="level3">
<h3 class="anchored" data-anchor-id="qa-session">Q&amp;A Session</h3>
<section id="q1-metadata-for-vector-db-in-rag" class="level4">
<h4 class="anchored" data-anchor-id="q1-metadata-for-vector-db-in-rag">Q1: Metadata for Vector DB in RAG</h4>
<ul>
<li><strong>Question:</strong> What kind of metadata is most valuable to put into a vector DB for doing RAG?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Context-Dependent:</strong> The most valuable metadata depends on the specific use case and domain.</li>
<li><strong>Text-Only Use Cases:</strong>
<ul>
<li><strong>Authority/Source Filtering:</strong> Important in domains like healthcare where trustworthiness of sources is crucial (e.g., filter out Reddit posts in favor of medical journals).</li>
<li><strong>Title and other basic metadata:</strong> Can provide additional context for retrieval.</li>
</ul></li>
<li><strong>Real-World Use Cases:</strong>
<ul>
<li>Consider factors beyond text, such as freshness, authority, quality, and even revenue.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="q2-calibration-of-different-indices" class="level4">
<h4 class="anchored" data-anchor-id="q2-calibration-of-different-indices">Q2: Calibration of Different Indices</h4>
<ul>
<li><strong>Question:</strong> Do you have any thoughts on calibration of different indices? How can we obtain confidence scores for recommendations?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Challenge:</strong> Different scoring functions (e.g., BM25, cosine similarity) have different distributions and ranges, making calibration difficult. Scores are not probabilities.</li>
<li><strong>Learning Task:</strong> Combining scores effectively is a learning problem.</li>
<li><strong>GBDT’s Strength:</strong> Gradient Boosted Decision Trees (GBDT) can learn non-linear combinations of features, including different scoring functions.</li>
<li><strong>Need for Training Data:</strong> Calibration and learning require training data.</li>
<li><strong>Options for Training Data:</strong>
<ul>
<li><strong>Evaluation Data:</strong> The evaluation datasets described earlier can be used to generate training data.</li>
<li><strong>Real User Interactions:</strong> Gather data from user searches and clicks (like Google).</li>
<li><strong>Synthetic Data:</strong> Use large language models to generate synthetic training data.</li>
</ul></li>
<li><strong>No Easy Tricks:</strong> There’s no universal solution for calibration without training data and evaluation.</li>
</ul></li>
</ul>
</section>
<section id="q3-efficacy-of-re-rankers" class="level4">
<h4 class="anchored" data-anchor-id="q3-efficacy-of-re-rankers">Q3: Efficacy of Re-rankers</h4>
<ul>
<li><strong>Question:</strong> What are your observations on the efficacy of re-rankers? Do you recommend using them?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Phased Retrieval and Ranking:</strong> Re-rankers are valuable in multi-stage pipelines. They allow you to invest more compute into fewer, more promising hits retrieved in earlier stages.</li>
<li><strong>Benefits of Re-rankers:</strong>
<ul>
<li><strong>Token-Level Interaction:</strong> Re-rankers like Cohere or cross-encoders enable deeper interaction between the query and document at the token level, improving accuracy.</li>
<li><strong>Latency Management:</strong> By focusing on a smaller set of candidates, re-rankers can help meet latency requirements.</li>
</ul></li>
<li><strong>Trade-offs:</strong> Re-rankers add computational cost and latency.</li>
<li><strong>Recommendation:</strong> If accuracy is a priority and the cost is acceptable, re-rankers are recommended.</li>
</ul></li>
</ul>
</section>
<section id="q4-combining-usage-data-and-semantic-similarity" class="level4">
<h4 class="anchored" data-anchor-id="q4-combining-usage-data-and-semantic-similarity">Q4: Combining Usage Data and Semantic Similarity</h4>
<ul>
<li><strong>Question:</strong> Do you have advice on combining usage data (e.g., number of views) with semantic similarity?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Learning to Rank Problem:</strong> Integrating usage data turns it into a learning to rank problem.</li>
<li><strong>Label Generation:</strong> Convert interaction data into labeled training data. Different interactions (e.g., views, clicks, add-to-cart) may have different weights in the label generation process.</li>
<li><strong>Model Training:</strong> Train a ranking model (e.g., GBDT) using the labeled data, including semantic similarity scores and usage data as features.</li>
</ul></li>
</ul>
</section>
<section id="q5-jason-lius-post-on-structured-summaries" class="level4">
<h4 class="anchored" data-anchor-id="q5-jason-lius-post-on-structured-summaries">Q5: Jason Liu’s Post on Structured Summaries</h4>
<ul>
<li><strong>Question:</strong> What are your thoughts on Jason Liu’s post about the value of generating structured summaries and reports for decision makers instead of doing RAG as commonly done today?</li>
<li><strong>Answer:</strong> Jo was not familiar with the specific post.</li>
</ul>
</section>
<section id="q6-recent-advancements-in-text-embedding-models" class="level4">
<h4 class="anchored" data-anchor-id="q6-recent-advancements-in-text-embedding-models">Q6: Recent Advancements in Text Embedding Models</h4>
<ul>
<li><strong>Question:</strong> What are some of your favorite advancements recently in text embedding models or other search technologies?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Larger Vocabularies:</strong> Jo hopes for embedding models with larger vocabularies to better handle out-of-vocabulary words, especially in specialized domains. BERT’s vocabulary is outdated.</li>
<li><strong>Improved Pre-trained Models:</strong> Better pre-training techniques and data can lead to more robust and generalizable embedding models.</li>
<li><strong>Caution on Long Context:</strong> Jo is not overly enthusiastic about increasing context length for embedding models. Research suggests diminishing returns for high-precision search with very long contexts.</li>
</ul></li>
</ul>
</section>
<section id="q7-query-expansion-with-bm25" class="level4">
<h4 class="anchored" data-anchor-id="q7-query-expansion-with-bm25">Q7: Query Expansion with BM25</h4>
<ul>
<li><strong>Question:</strong> Does query expansion of out-of-vocabulary words with BM25 work better at search? Are people utilizing classical search techniques like query expansion enough?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>BM25 and Re-ranking:</strong> Combining BM25 with a re-ranker can yield excellent results. While BM25 may struggle with single-word queries that are out-of-vocabulary, it avoids the severe failure modes of relying solely on embedding-based search.</li>
<li><strong>Query Expansion’s Potential:</strong> Query expansion and understanding are powerful techniques. Language models can be used for query expansion, and tools for prompting LLMs for this purpose are improving.</li>
<li><strong>Importance of Evaluation:</strong> Building your own evaluation setup allows you to systematically test different techniques like query expansion on your specific data and determine their effectiveness.</li>
</ul></li>
</ul>
</section>
<section id="q8-handling-jargon-and-tokenization-issues" class="level4">
<h4 class="anchored" data-anchor-id="q8-handling-jargon-and-tokenization-issues">Q8: Handling Jargon and Tokenization Issues</h4>
<ul>
<li><strong>Question:</strong> How do you overcome limitations in fixed vocabulary and poor tokenization in domains with a lot of jargon, when using an out-of-the-box model?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Hybrid Approach:</strong> Combine keyword search with embedding retrieval to mitigate vocabulary limitations.</li>
<li><strong>Challenge of Ignoring Embedding Results:</strong> Embedding retrieval always returns results, even if they are not semantically relevant. It’s crucial to identify and filter out these irrelevant results.</li>
<li><strong>Fine-tuning:</strong> Fine-tuning your own embedding model on domain-specific data can help, but vocabulary limitations may persist.</li>
<li><strong>Pre-training from Scratch:</strong> Training a BERT-like model from scratch with a custom vocabulary tailored to the domain is becoming more feasible.
<ul>
<li>This is a common practice in e-commerce.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="q9-colbert-and-tokenizer-problems" class="level4">
<h4 class="anchored" data-anchor-id="q9-colbert-and-tokenizer-problems">Q9: ColBERT and Tokenizer Problems</h4>
<ul>
<li><strong>Question:</strong> Would ColBERT-based methods improve retrieval when we are concerned with tokenizer problems?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>ColBERT’s Approach:</strong> ColBERT learns token-level vector representations instead of a single vector for the whole passage or query. It offers high accuracy while being computationally less expensive than cross-encoders.</li>
<li><strong>Vocabulary Limitations:</strong> ColBERT still relies on the same vocabulary as other BERT-based models, so it’s not a complete solution to tokenizer problems.</li>
<li><strong>Future Direction:</strong> Better pre-trained models with larger vocabularies would benefit ColBERT and other embedding models.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>notes</category>
  <category>llms</category>
  <guid>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-020/</guid>
  <pubDate>Fri, 30 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Conference Talk 19: Fine Tuning LLMs for Function Calling</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-019/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<ul>
<li><strong>Pawell</strong>, from <strong><a href="https://fireworks.ai/">Fireworks AI</a></strong>, discusses fine-tuning LLMs for function calling, covering key decisions, challenges, and solutions.</li>
<li><strong>Documentation:</strong> <a href="https://docs.fireworks.ai/guides/function-calling">Using function-calling</a></li>
<li><strong>Documentation:</strong> <a href="https://docs.fireworks.ai/fine-tuning/fine-tuning-models">Fine-tuning models</a></li>
<li><strong>Documentation:</strong> <a href="https://docs.fireworks.ai/structured-responses/structured-output-grammar-based">Using grammar mode</a></li>
</ul>
</section>
<section id="understanding-functiontool-calling" class="level3">
<h3 class="anchored" data-anchor-id="understanding-functiontool-calling">Understanding Function/Tool Calling</h3>
<ul>
<li><strong>Definition:</strong> Giving LLMs the ability to interact with the external world.</li>
<li><strong>Use Cases:</strong>
<ul>
<li><strong>Accessing real-time or unavailable information:</strong> E.g., retrieving current stock prices.</li>
<li><strong>Orchestrating multi-agent systems:</strong> LLMs can access and utilize multiple tools to assist users.</li>
</ul></li>
</ul>
</section>
<section id="key-decisions-in-fine-tuning-for-function-calling" class="level3">
<h3 class="anchored" data-anchor-id="key-decisions-in-fine-tuning-for-function-calling">Key Decisions in Fine-Tuning for Function Calling</h3>
<section id="objective-selection" class="level4">
<h4 class="anchored" data-anchor-id="objective-selection">1. Objective Selection:</h4>
<ul>
<li><strong>Impact:</strong> The objective significantly impacts data preparation, training data volume, fine-tuning complexity, and model usage.</li>
<li><strong>Recommendation:</strong> Choose the simplest objective that meets the use case requirements.</li>
<li><strong>Common Objectives:</strong>
<ul>
<li><strong>Single-Turn Forced Call (Routing Use Case):</strong>
<ul>
<li>User provides a single instruction.</li>
<li>Model maps the instruction to one of several pre-defined functions and its parameters.</li>
<li><strong>Forced Call:</strong> The model is constrained to respond with a function call, not natural language.</li>
<li><strong>Example:</strong> User requests the current stock price of Nvidia, the model identifies the appropriate function and its parameters.
<ul>
<li><pre class="text"><code>User: What is the stock price of Nvidia?

Assistant: {
  "name": "get_stock_price",
  "arguments": {"ticker": "NVDA"}
}</code></pre></li>
</ul></li>
</ul></li>
<li><strong>Parallel Function Calling:</strong>
<ul>
<li>Similar to single-turn forced call, but the model can call multiple independent functions in parallel.</li>
<li><strong>Example:</strong> Retrieving stock prices for multiple companies simultaneously.
<ul>
<li><pre class="text"><code>User: What is the stock price of Nvidia and Apple?

Assistant: [
  {
    "name": "get_stock_price",
    "arguments": {"ticker": "NVDA"}
  },
  {
    "name": "get_stock_price",
    "arguments": {"ticker": "AAPL"}
  }
]</code></pre></li>
</ul></li>
</ul></li>
<li><strong>Nested Function Calls:</strong>
<ul>
<li>Model calls functions sequentially, with the output of one function feeding into the next.</li>
<li><strong>Example:</strong> Retrieving stock prices and then using those prices to generate a plot.
<ul>
<li><pre class="text"><code>User: Plot the stock price of Nvidia and Apple over the last two weeks

Assistant: [
  {
    "name": "get_stock_price",
    "arguments": {"ticker": "NVDA", "start_time": "2 weeks ago"}
  },
  {
    "name": "get_stock_price",
    "arguments": {"ticker": "AAPL", "start_time": "2 weeks ago"}
  }
]

Tool: {"NVDA": [120, 121, …],"AAPL": [192, 190, …]}

Assistant: {
  "name": "plot",
  "arguments": {"NVDA": [120, 121, …],"AAPL": [192, 190, …]}
}</code></pre></li>
</ul></li>
<li><strong>Implementation:</strong>
<ul>
<li><strong>User Role:</strong> Client interacting with the model.</li>
<li><strong>Assistant Role:</strong> The LLM generating function calls.</li>
<li><strong>Tool Role:</strong> Client-side component that executes function calls and returns results to the model.</li>
</ul></li>
</ul></li>
<li><strong>Multi-Turn Chat with Optional Function Calling:</strong>
<ul>
<li>Most complex objective, combining natural language conversation with optional function calls.</li>
<li><strong>Example:</strong> User asks for news, model fetches trending news, summarizes them, and engages in further conversation.
<ul>
<li><pre class="text"><code>User: What's in the news today?

Assistant: {"name": "trending_news"}

Tool: {
  "headlines": [
    "Nvidia market cap surpasses Apple", …
  ]
}

Assistant: Nvidia is now more valuable than Apple

User: What is Nvidia stock price?

Assistant: {
  "name": "get_stock_price",
  "arguments": {"ticker": "NVDA"}
}</code></pre></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="function-call-token" class="level4">
<h4 class="anchored" data-anchor-id="function-call-token">2. Function Call Token:</h4>
<ul>
<li><strong>Purpose:</strong>
<ul>
<li>Indicate to the client when the model is switching to function call mode.</li>
<li>Enable efficient parsing of model responses, especially in mixed natural language and function call outputs.</li>
</ul></li>
<li><strong>Implementation:</strong> Introduce a special token to prefix function calls.
<ul>
<li><pre class="text"><code>  Assistant: &lt;function_call_token&gt;{
    "name": "get_stock_price",
    "arguments": {"ticker": "NVDA"}
  }</code></pre></li>
</ul></li>
<li><strong>Benefits:</strong>
<ul>
<li>Easier parsing of model responses.</li>
<li>Improved <strong>streaming generation</strong> by enabling the client to wait for the entire function call signature before processing.</li>
<li>Facilitates <strong>constraint generation</strong>, ensuring the model adheres to predefined function schemas.</li>
</ul></li>
</ul>
</section>
<section id="syntax-for-function-calling" class="level4">
<h4 class="anchored" data-anchor-id="syntax-for-function-calling">3. Syntax for Function Calling:</h4>
<ul>
<li><strong>Options:</strong>
<ul>
<li><strong>Python Syntax:</strong> Generate function calls using Python function call signature syntax.</li>
<li><strong>JSON Schema:</strong> Generate JSON structures describing the function name and parameters.</li>
</ul></li>
<li><strong>Trade-offs:</strong>
<ul>
<li><strong>Python Syntax:</strong>
<ul>
<li><strong>Advantages:</strong> Easier for LLMs to generate due to extensive training on Python code.</li>
<li><strong>Disadvantages:</strong> Less natural for representing complex, nested parameter structures within a single-line invocation.</li>
</ul></li>
<li><strong>JSON Schema:</strong>
<ul>
<li><strong>Advantages:</strong> Better suited for complex, nested parameter types; easier to enforce schema with constraint generation; compatible with OpenAI APIs.</li>
<li><strong>Disadvantages:</strong> Potentially more challenging for LLMs to generate compared to Python syntax.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="preserving-existing-model-capabilities" class="level4">
<h4 class="anchored" data-anchor-id="preserving-existing-model-capabilities">4. Preserving Existing Model Capabilities:</h4>
<ul>
<li><strong>Challenge:</strong> Fine-tuning for function calling can inadvertently degrade pre-existing instruction following and general language capabilities.</li>
<li><strong>Recommendations:</strong>
<ul>
<li><strong>Fine-tune on Instruction-Tuned Models:</strong> Use the “Instruct” version of the base model instead of the “Base” version when mixing general chat with function calling.
<ul>
<li>Using the “Base” version is fine for forced function calling.</li>
</ul></li>
<li><strong>Reduce Training Data:</strong> Minimize the amount of training data to reduce the risk of overwriting existing capabilities.</li>
<li><strong>High-Quality Data:</strong> Use a smaller volume of carefully curated, high-quality training data.</li>
</ul></li>
</ul>
</section>
<section id="full-weight-tuning-vs.-lora-tuning" class="level4">
<h4 class="anchored" data-anchor-id="full-weight-tuning-vs.-lora-tuning">5. Full-Weight Tuning vs.&nbsp;LoRA Tuning:</h4>
<ul>
<li><strong>Recommendation:</strong> LoRA tuning is generally sufficient and preferable for function calling, particularly in low-data regimes.</li>
<li><strong>Advantages of LoRA:</strong>
<ul>
<li>Fewer parameters to converge, leading to faster training and better results with limited data.</li>
<li>Faster iteration cycles, enabling more experimentation.</li>
<li>Lower hosting and experimentation costs, especially with efficient LoRA serving solutions like Fireworks AI’s platform.</li>
</ul></li>
</ul>
</section>
<section id="constraint-generation" class="level4">
<h4 class="anchored" data-anchor-id="constraint-generation">6. Constraint Generation:</h4>
<ul>
<li><strong>Purpose:</strong> Reduce hallucinations in model-generated function calls by leveraging the known schema of available functions.</li>
<li><strong>Implementation:</strong>
<ul>
<li>Provide the model with the schema of the functions (e.g., function name, parameter names and types).</li>
<li>Use a constraint generation mechanism (like a <a href="https://web.stanford.edu/class/archive/cs/cs103/cs103.1164/lectures/18/Small18.pdf">context-free grammar</a>) to guide the model’s output and enforce adherence to the schema.</li>
</ul></li>
<li><strong>Benefits:</strong>
<ul>
<li><strong>Reduced Hallucinations:</strong> Significantly minimizes or even eliminates hallucinations in function call outputs.</li>
<li><strong>Faster Generation:</strong> Enables short-circuiting generation by autocompleting predictable tokens based on the grammar, improving inference speed.</li>
</ul></li>
<li><strong>Fireworks AI:</strong> Offers constraint generation support for function calling, requiring users to provide the function schemas.</li>
</ul>
</section>
</section>
<section id="general-recommendations-and-considerations" class="level3">
<h3 class="anchored" data-anchor-id="general-recommendations-and-considerations">General Recommendations and Considerations</h3>
<ul>
<li><strong>Work Smart:</strong> Utilize existing open-source function-calling models whenever possible, as they are often sufficient for many use cases.</li>
<li><strong>Fine-Tuning Effort:</strong> Be prepared for an iterative and potentially time-consuming process when fine-tuning for complex function-calling objectives.</li>
</ul>
</section>
<section id="fireworks-ais-fire-function-models" class="level3">
<h3 class="anchored" data-anchor-id="fireworks-ais-fire-function-models">Fireworks AI’s Fire Function Models</h3>
<ul>
<li><p><strong>Playground:</strong> <a href="https://fireworks.ai/models/fireworks/firefunction-v2">Firefunction V2</a></p></li>
<li><p><strong>Blog Post:</strong> <a href="https://fireworks.ai/blog/firefunction-v2-launch-post">Firefunction-v2: Function calling capability on par with GPT4o at 2.5x the speed and 10% of the cost</a></p></li>
<li><p><strong>Fire Function V2:</strong></p>
<ul>
<li>Based on LLaMa 3 70B (Instruct variant).</li>
<li>Outperforms GPT-4 on the Gorilla benchmark.</li>
<li>Designed to approximate GPT-4’s conversational capabilities mixed with function calling.</li>
<li>Addresses limitations of existing datasets by leveraging:
<ul>
<li>Naturally occurring function-calling conversations.</li>
<li>Open-source multi-agent system data (e.g., AutoGPT).</li>
<li>Synthetic datasets with complex instructions and system prompts.</li>
</ul></li>
</ul></li>
<li><p><strong>Benchmark Comparison:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th></th>
<th>Firefunction v2</th>
<th>Gpt-4o</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Gorilla simple</td>
<td><strong>0.94</strong></td>
<td>0.88</td>
</tr>
<tr class="even">
<td>Gorilla multiple_function</td>
<td>0.91</td>
<td>0.91</td>
</tr>
<tr class="odd">
<td>Gorilla parallel_function</td>
<td>0.89</td>
<td>0.89</td>
</tr>
<tr class="even">
<td>Gorilla parallel_multiple_function</td>
<td>0.79</td>
<td>0.72</td>
</tr>
<tr class="odd">
<td>Nexus parallel</td>
<td>0.53</td>
<td>0.47</td>
</tr>
<tr class="even">
<td>Mtbench</td>
<td>0.84</td>
<td><strong>0.93</strong></td>
</tr>
</tbody>
</table></li>
</ul>
</section>
<section id="challenges-in-fine-tuning-for-function-calling" class="level3">
<h3 class="anchored" data-anchor-id="challenges-in-fine-tuning-for-function-calling">Challenges in Fine-tuning for Function Calling</h3>
<ul>
<li><strong>Data Scarcity:</strong> Unlike general language modeling, readily available datasets for function calling are limited.
<ul>
<li>Existing datasets often focus on specific use cases (e.g., GPT-4 conversations or a limited number of functions).</li>
<li><strong>Solution:</strong> Invest in building custom datasets.</li>
</ul></li>
<li><strong>Data Set Design:</strong>
<ul>
<li><strong>Define Data Categories:</strong> Consider types of function calls (parallel, nested), number of turns, and number of functions supported.
<ul>
<li><strong>Parallel function calling:</strong> Multiple functions are called simultaneously.</li>
<li><strong>Nested function calling:</strong> Functions are called within other functions.</li>
<li><strong>Turn-based conversations:</strong> Single-turn or multi-turn interactions (e.g., exceeding 10 turns).</li>
<li><strong>Number of functions supported:</strong> Fine-tuning for a small set of functions (e.g., 5) is different from tuning for a larger set (e.g., 50).</li>
</ul></li>
<li><strong>Objective Alignment:</strong> Ensure the dataset represents the model’s intended use cases and boundary conditions.</li>
<li><strong>Leverage Existing Resources:</strong> Explore open-source datasets (e.g., Glaive) and multi-agent systems (e.g., Autogen) for inspiration and data.
<ul>
<li><a href="https://github.com/microsoft/autogen"><strong>Autogen</strong></a>, a multi-agent system, can be a good data source, especially for scenarios with multiple agents and complex prompts.</li>
</ul></li>
</ul></li>
<li><strong>Complex System Prompts:</strong> Real-world applications often require intricate instructions for function selection, which are difficult to find in existing datasets.
<ul>
<li><strong>Solution:</strong> Invest in generating synthetic datasets with complex instructions.</li>
</ul></li>
<li><strong>Security Concerns:</strong> Allowing arbitrary function calls raises security risks, especially with functions that modify data.
<ul>
<li><strong>Mitigation:</strong>
<ul>
<li>Focus on read-only functions.</li>
<li>Include precise instructions in system prompts.</li>
</ul></li>
<li><strong>Ongoing Research:</strong> This area requires further exploration as function calling and multi-agent systems become more prevalent.</li>
</ul></li>
</ul>
</section>
<section id="prompt-templates-for-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="prompt-templates-for-fine-tuning">Prompt Templates for Fine-tuning</h3>
<ul>
<li><strong>System prompts</strong> provide context and instructions to the model.</li>
<li><strong>General Guidelines:</strong>
<ul>
<li><strong>Preserve Instruct Model Capabilities:</strong> When fine-tuning on top of existing instruct models, maintain the prompt format to retain existing capabilities.</li>
<li><strong>Clear Role Prefixes:</strong> Use distinct prefixes for different roles (e.g., system, user, assistant, tool) in multi-turn conversations.</li>
</ul></li>
<li><strong>Message Format:</strong>
<ul>
<li><strong>Parsability:</strong> Ensure the format allows easy parsing of function calls by the client.</li>
<li><strong>Mixed Output Handling:</strong> Use special tokens to delineate between natural language and function call sections in assistant responses.</li>
</ul></li>
</ul>
</section>
<section id="successful-fine-tuning-examples" class="level3">
<h3 class="anchored" data-anchor-id="successful-fine-tuning-examples">Successful Fine-tuning Examples</h3>
<ul>
<li><strong>GPT-4 Limitations:</strong> Fine-tuning can overcome limitations in existing models, such as character limits in function descriptions.</li>
<li><strong>Complex Instructions:</strong> Fine-tuning is particularly effective for scenarios with complex instructions on when to call specific functions, even with relatively simple functions.</li>
</ul>
</section>
<section id="function-calling-data-sets-and-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="function-calling-data-sets-and-evaluation">Function Calling Data Sets and Evaluation</h3>
<ul>
<li><strong>Datasets:</strong>
<ul>
<li><a href="https://huggingface.co/datasets/glaiveai/glaive-function-calling-v2"><strong>Glaive</strong></a><strong>:</strong> High-quality but limited coverage of use cases.</li>
<li><a href="https://gorilla.cs.berkeley.edu/blogs/7_open_functions_v2.html"><strong>Gorilla</strong></a><strong>:</strong> Simple functions, Python syntax focus.</li>
<li><a href="https://github.com/nexusflowai/NexusRaven-V2"><strong>Nexus Raven</strong></a><strong>:</strong> More complex parameters, Python focus.</li>
</ul></li>
<li><strong>Evaluation:</strong>
<ul>
<li><strong><a href="https://gorilla.cs.berkeley.edu/leaderboard.html">Gorilla Leaderboard</a>:</strong> Useful for initial assessment, but consider its limitations (e.g., focus on Python syntax).</li>
<li><strong><a href="https://huggingface.co/Nexusflow">Nexus Benchmarks</a>:</strong> More challenging than Gorilla.</li>
<li><strong>Empty Bench:</strong> Evaluates general instruction following without function calling.</li>
<li><strong>Evaluation Challenges:</strong>
<ul>
<li><strong>Real-World Use Case Mismatch:</strong> Benchmarks may not fully capture the complexities of real-world scenarios, such as those requiring precise system prompting and multi-turn conversations.</li>
</ul></li>
</ul></li>
<li><strong>Recommendations:</strong>
<ul>
<li><strong>Benchmark Selection:</strong> Start with publicly available benchmarks to get a general idea of the model’s capabilities.</li>
<li><strong>Real-World Testing:</strong> It’s essential to test and evaluate models on the specific use cases they are intended for.</li>
<li><strong>Model Selection:</strong> Don’t rely solely on benchmark scores; try out the top-performing models on your own data and use case to determine the best fit.</li>
</ul></li>
</ul>
</section>
<section id="base-models-for-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="base-models-for-fine-tuning">Base Models for Fine-tuning</h3>
<ul>
<li><strong>Llama 3 &amp; Llama 3.1:</strong> Strong general-purpose models.
<ul>
<li><strong>FireFunction V1:</strong> Based on Mistral.</li>
<li><strong>FireFunction V2:</strong> Based on Llama, showed significant improvement.</li>
</ul></li>
<li><strong>Coding Models:</strong> Consider coding-focused models (e.g., Llama 2 Python code generation model) for single-turn, Python-based function calling.</li>
<li><strong><a href="https://huggingface.co/Qwen">Qwen Models</a>:</strong> Show promise but require further exploration.</li>
<li><strong>Phi (Microsoft):</strong> Smaller models that perform well for their size and can potentially run without a GPU.</li>
<li><strong>Model Selection:</strong> Consider the specific objective (e.g., forced function calling, Python syntax) when choosing a base model.</li>
</ul>
</section>
<section id="memory-retention-in-long-chains-of-calls" class="level3">
<h3 class="anchored" data-anchor-id="memory-retention-in-long-chains-of-calls">Memory Retention in Long Chains of Calls</h3>
<ul>
<li><strong>Longer Context Models:</strong> Opt for models with larger context windows (e.g., beyond Llama 3’s 8K context) for extended conversations.
<ul>
<li><a href="https://llama.meta.com/">Llama 3.1</a> has 128K content window</li>
</ul></li>
<li><strong>Dataset Representation:</strong> Include sufficient long conversation examples in the training data.</li>
<li><strong>Intelligent Conversation Pruning:</strong>
<ul>
<li>Develop algorithms to selectively retain the most relevant messages from previous turns when the conversation exceeds the context window.</li>
<li>Explore semantic matching techniques to identify relevant past messages.</li>
</ul></li>
<li><strong>Whiteboard Approach:</strong>
<ul>
<li>Have the model summarize the key aspects of the conversation at the end of each turn.</li>
<li>Pass only the summary to the model in subsequent turns, effectively resetting the context while retaining essential information.</li>
</ul></li>
</ul>
</section>
<section id="multi-agent-systems-and-function-calling" class="level3">
<h3 class="anchored" data-anchor-id="multi-agent-systems-and-function-calling">Multi-Agent Systems and Function Calling</h3>
<ul>
<li><p><strong>Function as Agent:</strong> A function can be considered an agent within a multi-agent system, interacting with other agents (potentially other functions or models) to complete tasks.</p></li>
<li><p><strong>Orchestration:</strong> Multi-agent frameworks like Autogen provide tools for defining agents, extracting function schemas, routing messages, and executing function calls based on model responses.</p></li>
<li><p><strong>Agent Team Creation:</strong></p>
<ul>
<li><strong>Identify Strengths and Weaknesses:</strong> Analyze individual models to understand their capabilities and limitations.</li>
<li><strong>Define Agent Roles:</strong> Assign roles and responsibilities to each agent based on their strengths.</li>
<li><strong>Routing Layer:</strong> Design a system for efficiently routing messages and tasks to the appropriate agents.</li>
<li><strong>Context Management:</strong> Implement mechanisms for sharing and summarizing context between agents, especially in long conversations.</li>
</ul></li>
<li><p><strong>Merging Models:</strong> Explore techniques like <strong><a href="https://github.com/arcee-ai/mergekit">MergeKit</a></strong> to combine layers from multiple models, potentially creating more capable composite models.</p></li>
<li><p><strong>Cost and Latency Optimization:</strong> Consider using smaller, specialized models for specific tasks to reduce cost and latency.</p></li>
</ul>
</section>
<section id="comparison-with-gorilla-project" class="level3">
<h3 class="anchored" data-anchor-id="comparison-with-gorilla-project">Comparison with Gorilla Project</h3>
<ul>
<li><strong>Gorilla:</strong>
<ul>
<li>Focuses on single-turn, forced function calling with Python signature generation.</li>
<li>Supports various function calling scenarios (single, parallel, nested).</li>
<li>Primarily designed for functions with simple parameters.</li>
</ul></li>
<li><strong>FireFunction:</strong>
<ul>
<li>Addresses real-world use cases involving complex system prompts and mixed conversations with function calling.</li>
<li>Handles functions with more complex parameters and instructions.</li>
</ul></li>
<li><strong>Benchmarks:</strong> Gorilla leaderboard lacks tasks for complex system prompts and mixed conversation scenarios.</li>
</ul>
</section>
<section id="smallest-model-for-local-smart-home-assistant" class="level3">
<h3 class="anchored" data-anchor-id="smallest-model-for-local-smart-home-assistant">Smallest Model for Local Smart Home Assistant</h3>
<ul>
<li><strong>Challenges:</strong> Running a model locally with hundreds of functions on a resource-constrained device.</li>
<li><strong>Potential Solutions:</strong>
<ul>
<li><strong>Pre-populate KV Cache:</strong> Pre-load function definitions into the model’s KV cache to reduce inference time.</li>
<li><strong>Function Retrieval with RAG:</strong> Use retrieval augmented generation (RAG) to dynamically select relevant functions based on user input, reducing the number of functions in the prompt.</li>
<li><strong>Smaller Models:</strong> Explore smaller models like Phi or Qwen2 (2 billion parameters) that can potentially run without a GPU.</li>
</ul></li>
</ul>
</section>
<section id="function-calling-with-graphql" class="level3">
<h3 class="anchored" data-anchor-id="function-calling-with-graphql">Function Calling with GraphQL</h3>
<ul>
<li><strong>GraphQL as Structured Data:</strong> GraphQL can be treated as a structured data format similar to function call schemas.</li>
<li><strong>Leveraging Function Calling Models:</strong> Explore using existing function calling models to generate or complete GraphQL queries by defining GraphQL operations as functions.</li>
<li><strong><a href="https://docs.fireworks.ai/structured-responses/structured-output-grammar-based">Grammar Mode</a>:</strong> Leverage the grammar enforcement capabilities of function calling models to ensure syntactically correct GraphQL queries.</li>
</ul>
</section>
<section id="handling-api-changes" class="level3">
<h3 class="anchored" data-anchor-id="handling-api-changes">Handling API Changes</h3>
<ul>
<li><strong>Canonical Data Format:</strong> Store data in a format that can be easily translated to different API syntaxes.</li>
<li><strong>Client-Side Translation:</strong> Implement a wrapper around the API to handle syntax conversions, allowing the model to remain agnostic to specific API changes.</li>
<li><strong>Prompt-Based Function Definitions:</strong> Consider defining functions within the prompt itself. This approach allows for easier updates when APIs change, eliminating the need for retraining.</li>
</ul>
</section>
<section id="synthetic-data-generation-best-practices" class="level3">
<h3 class="anchored" data-anchor-id="synthetic-data-generation-best-practices">Synthetic Data Generation Best Practices</h3>
<ul>
<li><strong>High-Quality Prompt and Seed Data:</strong> Start with well-crafted prompts and a small, high-quality seed dataset.</li>
<li><strong>Good Generation Model:</strong> Utilize a capable language model for generation, balancing the legal constraints of using closed-source models with the effort required for filtering outputs from open-source models.</li>
<li><strong>Data Variety over Quantity:</strong> Prioritize diverse use cases and scenarios over a large number of examples for a single case.</li>
<li><strong>Few-Shot Examples in Prompts:</strong> Include examples of desired outputs in the prompts to guide the generation process.</li>
<li><strong>Temperature Variation:</strong> Experiment with different temperature settings to encourage creativity and diversity in generated samples.</li>
<li><strong>Post-Filtering:</strong> Implement filtering mechanisms to remove low-quality or incorrect samples.</li>
<li><strong>DPO Alignment (Optional):</strong> Use DPO to refine the model’s behavior, especially for complex system prompts, by providing examples of both desired and undesired outputs.</li>
</ul>
</section>
<section id="importance-of-data-vs.-hyperparameters-vs.-base-model" class="level3">
<h3 class="anchored" data-anchor-id="importance-of-data-vs.-hyperparameters-vs.-base-model">Importance of Data vs.&nbsp;Hyperparameters vs.&nbsp;Base Model</h3>
<ul>
<li><strong>Data Quality:</strong> As models become more intelligent and training data becomes smaller, the quality of the data becomes increasingly crucial.</li>
<li><strong>Hyperparameter Sensitivity:</strong> Smaller datasets often lead to increased sensitivity to hyperparameters, requiring careful tuning.</li>
<li><strong>Base Model:</strong> The choice of base model significantly impacts performance, especially for specialized tasks like Python code generation.</li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>notes</category>
  <category>llms</category>
  <guid>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-019/</guid>
  <pubDate>Fri, 30 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Office Hours 8: Predibase</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/mastering-llms-course-notes/office-hours-008/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<section id="lorax-benefits-over-vllm-and-other-libraries" class="level3">
<h3 class="anchored" data-anchor-id="lorax-benefits-over-vllm-and-other-libraries">Lorax Benefits over vLLM and Other Libraries</h3>
<ul>
<li><strong><a href="https://github.com/predibase/lorax">lorax</a>:</strong> Multi-LoRA inference server that scales to 1000s of fine-tuned LLMs</li>
</ul>
<section id="performance-optimization" class="level4">
<h4 class="anchored" data-anchor-id="performance-optimization">Performance Optimization</h4>
<ul>
<li><p>Lorax uses <a href="https://github.com/punica-ai/punica/tree/master/csrc/sgmv"><strong>SGMV (segmented gathered matrix vector multiplication)</strong> kernel</a> for pre-fill (compute-bound) operations, while vLLM uses <a href="https://github.com/punica-ai/punica/tree/master/csrc/bgmv"><strong>BGMV</strong> kernel</a>.</p>
<ul>
<li><p>SGMV is optimized for pre-fill computation profiles.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://christianjmills.com/posts/mastering-llms-course-notes/office-hours-008/images/sgmv.png" class="img-fluid figure-img"></p>
<figcaption>Punica: Multi-Tenant LoRA Serving - Figure 3</figcaption>
</figure>
</div></li>
<li><p><strong>Paper:</strong> <a href="https://arxiv.org/abs/2310.18547">Punica: Multi-Tenant LoRA Serving</a></p></li>
</ul></li>
<li><p>Lorax uses both kernels (SGMV for pre-fill, BGMV for decode) depending on the generation process stage, while vLLM uses only BGMV.</p></li>
</ul>
</section>
<section id="dynamic-adapter-loading" class="level4">
<h4 class="anchored" data-anchor-id="dynamic-adapter-loading">Dynamic Adapter Loading</h4>
<ul>
<li>Lorax is currently the only library offering <strong>dynamic adapter loading</strong>, eliminating the need to pre-specify adapters and simplifying memory management.</li>
</ul>
</section>
<section id="scheduler-component" class="level4">
<h4 class="anchored" data-anchor-id="scheduler-component">Scheduler Component</h4>
<ul>
<li>Lorax’s scheduler intelligently manages:
<ul>
<li>Adapter residency on GPU and host memory.</li>
<li>Batching of requests.</li>
<li>Trade-off between latency and throughput for optimal processing.</li>
</ul></li>
</ul>
</section>
<section id="support-for-various-adapters" class="level4">
<h4 class="anchored" data-anchor-id="support-for-various-adapters">Support for Various Adapters</h4>
<ul>
<li>Supports <strong>LoRa switching</strong> (most popular) and other adapter types.
<ul>
<li><strong>Speculative decoding</strong>, allowing combination with LoRa, is unique to Lorax.</li>
<li>Exploration of other adapter types like <a href="https://arxiv.org/abs/2404.03592">ReFT</a> (representation fine-tuning) and <a href="https://arxiv.org/abs/2402.09353">DoRA</a>.</li>
</ul></li>
</ul>
</section>
<section id="additional-features" class="level4">
<h4 class="anchored" data-anchor-id="additional-features">Additional Features</h4>
<ul>
<li>Adding support for:
<ul>
<li>Embedding models.</li>
<li>Training adapters specifically for embedding models.</li>
</ul></li>
</ul>
</section>
</section>
<section id="data-requirements-and-sourcing-for-quality-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="data-requirements-and-sourcing-for-quality-fine-tuning">Data Requirements and Sourcing for Quality Fine-Tuning</h3>
<section id="data-volume-vs.-quality" class="level4">
<h4 class="anchored" data-anchor-id="data-volume-vs.-quality">Data Volume vs.&nbsp;Quality</h4>
<ul>
<li><strong>High-quality data is more important than high volume.</strong>
<ul>
<li>Large datasets often contain irrelevant information, hindering effective learning.</li>
</ul></li>
<li>Start with a <strong>smaller dataset (hundreds of examples) and a larger base model (e.g., Llama 3 70B).</strong>
<ul>
<li>Larger models perform better with smaller datasets but are more expensive to train and use for inference.</li>
</ul></li>
<li>As the dataset grows, transition to smaller models for cost efficiency.</li>
</ul>
</section>
<section id="synthetic-data-generation" class="level4">
<h4 class="anchored" data-anchor-id="synthetic-data-generation">Synthetic Data Generation</h4>
<ul>
<li><strong>Significantly increases performance</strong>, especially for smaller datasets (hundreds to low thousands of examples).</li>
<li>Gains decrease with larger datasets (hundreds of thousands).</li>
</ul>
</section>
<section id="case-study-metas-less-is-more-for-alignment" class="level4">
<h4 class="anchored" data-anchor-id="case-study-metas-less-is-more-for-alignment">Case Study: Meta’s “Less is More for Alignment”</h4>
<ul>
<li>Demonstrated strong performance using only <strong>2,000 samples</strong> for training Llama 2 70B (older generation).</li>
</ul>
</section>
<section id="dataset-creation-challenges" class="level4">
<h4 class="anchored" data-anchor-id="dataset-creation-challenges">Dataset Creation Challenges</h4>
<ul>
<li>Users often expect to directly transfer knowledge from closed-source APIs (e.g., OpenAI) to open-source models, leading to ineffective QA pairs.</li>
<li>Solution: Reformulate tasks as RAG problems or use embedding/generator models with appropriate data corpus indexing and training.</li>
</ul>
</section>
<section id="dataset-preparation-support" class="level4">
<h4 class="anchored" data-anchor-id="dataset-preparation-support">Dataset Preparation Support</h4>
<ul>
<li>Predibase provides guidance on dataset creation but does not offer specific data preparation tools.</li>
<li>Consulting companies can assist with data preparation and synthetic data generation.</li>
<li>Collaboration with companies like <a href="https://gretel.ai/">Gretel</a> for synthetic data as a service is being explored.</li>
</ul>
</section>
<section id="dataset-complexity" class="level4">
<h4 class="anchored" data-anchor-id="dataset-complexity">Dataset Complexity</h4>
<ul>
<li>Simpler for traditional supervised ML tasks (e.g., classification, NER, summarization) due to straightforward input-output relationships.</li>
</ul>
</section>
</section>
<section id="platform-choice-predibase-vs.-self-hosting-lorax" class="level3">
<h3 class="anchored" data-anchor-id="platform-choice-predibase-vs.-self-hosting-lorax">Platform Choice: Predibase vs.&nbsp;Self-Hosting Lorax</h3>
<section id="considerations-for-self-hosting" class="level4">
<h4 class="anchored" data-anchor-id="considerations-for-self-hosting">Considerations for Self-Hosting</h4>
<ul>
<li>Suitable for companies where ML infrastructure is a core competency or differentiator.</li>
<li>Requires a dedicated team for platform development, maintenance, and updates.</li>
</ul>
</section>
<section id="cost-benefit-analysis" class="level4">
<h4 class="anchored" data-anchor-id="cost-benefit-analysis">Cost-Benefit Analysis</h4>
<ul>
<li><strong>Self-hosting:</strong> High upfront and ongoing costs.</li>
<li><strong>Predibase:</strong> Predictable subscription fee, freeing up resources for other priorities.</li>
</ul>
</section>
<section id="recommendation" class="level4">
<h4 class="anchored" data-anchor-id="recommendation">Recommendation</h4>
<ul>
<li>Predibase is generally more cost-effective for companies whose core competencies lie elsewhere, allowing them to focus on product development or model creation.</li>
</ul>
</section>
</section>
<section id="lorax-adoption-and-engagement-expectations" class="level3">
<h3 class="anchored" data-anchor-id="lorax-adoption-and-engagement-expectations">Lorax Adoption and Engagement Expectations</h3>
<section id="comparison-to-previous-open-source-projects" class="level4">
<h4 class="anchored" data-anchor-id="comparison-to-previous-open-source-projects">Comparison to Previous Open-Source Projects</h4>
<ul>
<li><strong><a href="https://github.com/horovod/horovod">Horovod</a> (distributed training framework):</strong> Significant buy-in from large companies building ML platforms.</li>
<li><strong><a href="https://github.com/ludwig-ai/ludwig">Ludwig</a> (low-code ML framework):</strong> High user adoption but limited contributions due to its abstract nature.</li>
</ul>
</section>
<section id="lorax-adoption-pattern" class="level4">
<h4 class="anchored" data-anchor-id="lorax-adoption-pattern">Lorax Adoption Pattern</h4>
<ul>
<li>Similar to Horovod, attracting technical users building internal ML infrastructure.</li>
<li>Active contributions from self-hosting users, indicating strong engagement and “dogfooding.”</li>
</ul>
</section>
</section>
<section id="future-plans-for-the-fine-tuning-index" class="level3">
<h3 class="anchored" data-anchor-id="future-plans-for-the-fine-tuning-index">Future Plans for the Fine-Tuning Index</h3>
<ul>
<li><strong>Homepage:</strong> <a href="https://predibase.com/fine-tuning-index">The Fine-tuning Index</a></li>
</ul>
<section id="current-state" class="level4">
<h4 class="anchored" data-anchor-id="current-state">Current State</h4>
<ul>
<li>Static artifact averaging performance over 31 diverse tasks.</li>
</ul>
</section>
<section id="short-term-goals" class="level4">
<h4 class="anchored" data-anchor-id="short-term-goals">Short-Term Goals</h4>
<ul>
<li>Transition to a <strong>living artifact</strong> with regular updates as new models are released.</li>
<li>Implement tooling for <strong>easier model addition and UI integration with a database.</strong></li>
</ul>
</section>
<section id="long-term-vision" class="level4">
<h4 class="anchored" data-anchor-id="long-term-vision">Long-Term Vision</h4>
<ul>
<li>Achieve the <strong>freshness and openness of platforms like LMSYS Leaderboard and Hugging Face Leaderboards.</strong></li>
</ul>
</section>
<section id="additional-improvements" class="level4">
<h4 class="anchored" data-anchor-id="additional-improvements">Additional Improvements</h4>
<ul>
<li>Introduce <strong>Elo scores</strong> for more accurate model ranking.</li>
</ul>
</section>
</section>
<section id="handling-large-scale-text-classification-with-sensitive-data" class="level3">
<h3 class="anchored" data-anchor-id="handling-large-scale-text-classification-with-sensitive-data">Handling Large-Scale Text Classification with Sensitive Data</h3>
<section id="scenario" class="level4">
<h4 class="anchored" data-anchor-id="scenario">Scenario</h4>
<ul>
<li>1-2 million free-form text snippets per month requiring 5-10 binary (yes/no) questions.</li>
<li>GPT-4 performance is desired but cost-prohibitive.</li>
<li>Data is sensitive and based in the EU.</li>
</ul>
</section>
<section id="solution" class="level4">
<h4 class="anchored" data-anchor-id="solution">Solution</h4>
<ul>
<li><strong>GPT-4 Distillation:</strong>
<ul>
<li>Use GPT-4 to generate label data for a smaller, more cost-effective model.</li>
<li>Consider OpenAI’s terms of service when using GPT-4 for data generation.</li>
</ul></li>
<li><strong>Adapter Structure:</strong>
<ul>
<li><strong>Multiple Adapters:</strong> Suitable if the specific adapter to use for each request is unknown beforehand.</li>
<li><strong>One Adapter with Multiple Label Outputs:</strong> Preferable if the adapter selection can be determined based on request information.</li>
<li><strong>Routing Architectures:</strong> Explore if dynamically determining the appropriate adapter is necessary.</li>
</ul></li>
<li><strong>GDPR Compliance:</strong>
<ul>
<li>Predibase is working with EU-based, GDPR-compliant cloud providers.</li>
<li>Contact Predibase for options and discussions on EU data center deployments.</li>
</ul></li>
</ul>
</section>
</section>
<section id="on-device-lorax-and-lookahead-loras" class="level3">
<h3 class="anchored" data-anchor-id="on-device-lorax-and-lookahead-loras">On-Device Lorax and Lookahead LoRAs</h3>
<section id="on-device-potential" class="level4">
<h4 class="anchored" data-anchor-id="on-device-potential">On-Device Potential</h4>
<ul>
<li>Highly appealing for running smaller language models on edge devices (e.g., phones) with task-specific LoRAs.</li>
<li>Aligned with the trend of sparse activation for efficient model execution.</li>
</ul>
</section>
<section id="challenges" class="level4">
<h4 class="anchored" data-anchor-id="challenges">Challenges</h4>
<ul>
<li><strong>Hardware Compatibility:</strong> Lorax is currently optimized for NVIDIA GPUs, which are not common on edge devices.
<ul>
<li>Optimizations like flash attention, page attention, and SG&amp;B kernels are CUDA-based.</li>
<li>Porting to different hardware architectures (e.g., Qualcomm’s AI chips) would require significant code rewriting.</li>
<li>Optimization techniques might not translate well to specialized ASICs used in edge devices.</li>
</ul></li>
</ul>
</section>
<section id="lookahead-loras-and-speculative-decoding" class="level4">
<h4 class="anchored" data-anchor-id="lookahead-loras-and-speculative-decoding">Lookahead LoRAs and Speculative Decoding</h4>
<ul>
<li><strong>Lookahead LoRAs:</strong> Fine-tuned for both performance and inference speed (low-rank acceleration).</li>
<li><strong>Speculative Decoding:</strong> Works best for narrow tasks (e.g., summarization, structured generation) where predictions can be made based on limited context.
<ul>
<li>Effectiveness increases with narrower task definitions.</li>
<li>Aligns with the trend of using LLMs for specialized tasks with task-specific LoRAs.</li>
</ul></li>
<li><strong>Hardware Trends:</strong> NVIDIA’s newer GPUs (e.g., L40S) prioritize increased FLOPs over memory bandwidth, favoring compute-intensive techniques like speculative decoding.</li>
</ul>
</section>
<section id="speculative-decoding-in-practice" class="level4">
<h4 class="anchored" data-anchor-id="speculative-decoding-in-practice">Speculative Decoding in Practice</h4>
<ul>
<li><strong>Performance:</strong> Expected to work well in practice due to its suitability for narrow tasks.</li>
<li><strong>High QPS:</strong> Ensuring efficient operation at high query per second (QPS) is a current challenge being addressed.</li>
<li><strong>Fine-Tuning:</strong> Speculative decoding components should be fine-tuned alongside the LoRA for seamless integration.</li>
</ul>
</section>
</section>
<section id="synthetic-data-generation-for-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="synthetic-data-generation-for-fine-tuning">Synthetic Data Generation for Fine-Tuning</h3>
<section id="process" class="level4">
<h4 class="anchored" data-anchor-id="process">Process</h4>
<ul>
<li>Use a large language model (e.g., Llama 3 70B) with a small dataset for initial fine-tuning.</li>
<li>Generate synthetic data using the fine-tuned model.</li>
<li>Fine-tune a smaller model using the generated synthetic data.</li>
</ul>
</section>
<section id="effectiveness" class="level4">
<h4 class="anchored" data-anchor-id="effectiveness">Effectiveness</h4>
<ul>
<li>Significant performance improvements observed.</li>
<li>Each 2x increase in data leads to approximately a 5% performance lift.</li>
</ul>
</section>
<section id="model-family-considerations" class="level4">
<h4 class="anchored" data-anchor-id="model-family-considerations">Model Family Considerations</h4>
<ul>
<li>Use the same model family for both the initial large model and the final smaller model (e.g., Llama) for optimal distillation.</li>
<li>Cross-family distillation might not be as effective due to differences in data distributions.</li>
</ul>
</section>
<section id="alternative-approach" class="level4">
<h4 class="anchored" data-anchor-id="alternative-approach">Alternative Approach</h4>
<ul>
<li>Use GPT-3.5 or GPT-4 to generate synthetic data based on the small input dataset.</li>
<li>Fine-tune a smaller model using the GPT-generated synthetic data.</li>
</ul>
</section>
<section id="ensemble-techniques-for-synthetic-data-generation" class="level4">
<h4 class="anchored" data-anchor-id="ensemble-techniques-for-synthetic-data-generation">Ensemble Techniques for Synthetic Data Generation</h4>
<ul>
<li>Explore generating synthetic data using multiple model families to enhance diversity and capture different data aspects.</li>
<li>Fine-tune the final model on the ensemble of predictions from different models, similar to ensembling techniques in traditional ML.</li>
<li>This approach could potentially outperform fine-tuning on synthetic data generated from a single model family.</li>
</ul>
</section>
<section id="data-programming-and-weak-labeling" class="level4">
<h4 class="anchored" data-anchor-id="data-programming-and-weak-labeling">Data Programming and Weak Labeling</h4>
<ul>
<li>Data programming techniques (e.g., <a href="https://www.snorkel.org/">Snorkel</a>) can be used to combine predictions from multiple “weak” experts (models) to generate more accurate labels.</li>
<li>Distilling on the logits or probabilities, rather than the final labels, captures the uncertainty and agreement levels among different models, improving label quality.</li>
<li><strong>Paper:</strong> <a href="https://arxiv.org/abs/1605.07723">Data Programming: Creating Large Training Sets, Quickly</a></li>
</ul>
</section>
</section>
<section id="fine-tuning-adapters-vs.-gpt-4-for-qa-over-internal-documentation" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning-adapters-vs.-gpt-4-for-qa-over-internal-documentation">Fine-Tuning Adapters vs.&nbsp;GPT-4 for Q&amp;A over Internal Documentation</h3>
<section id="long-term-vision-1" class="level4">
<h4 class="anchored" data-anchor-id="long-term-vision-1">Long-Term Vision</h4>
<ul>
<li>Fine-tuning could potentially replace RAG entirely for domain adaptation, allowing models to directly answer questions based on internal data.</li>
</ul>
</section>
<section id="current-state-1" class="level4">
<h4 class="anchored" data-anchor-id="current-state-1">Current State</h4>
<ul>
<li>Fine-tuning is not yet a complete replacement for RAG.</li>
</ul>
</section>
<section id="fine-tuning-applications-within-rag" class="level4">
<h4 class="anchored" data-anchor-id="fine-tuning-applications-within-rag">Fine-Tuning Applications within RAG</h4>
<ul>
<li>Improve individual RAG components:
<ul>
<li><strong>Embedder:</strong> Enhance document retrieval accuracy.</li>
<li><strong>Re-ranker:</strong> Improve relevance ranking of retrieved documents.</li>
<li><strong>Generator:</strong> Enhance answer generation quality.</li>
</ul></li>
<li>Jointly fine-tune multiple components for optimal performance.</li>
<li><strong>Paper:</strong> <a href="https://arxiv.org/abs/2403.18295">Dual Instruction Tuning with Large Language Models for Mathematical Reasoning</a></li>
</ul>
</section>
<section id="benefits-of-fine-tuning-for-rag" class="level4">
<h4 class="anchored" data-anchor-id="benefits-of-fine-tuning-for-rag">Benefits of Fine-Tuning for RAG</h4>
<ul>
<li>Addresses limitations of pre-trained models by tailoring them to specific domains and tasks.</li>
<li>Improves accuracy, relevance, and quality of RAG system outputs.</li>
</ul>
</section>
<section id="considerations" class="level4">
<h4 class="anchored" data-anchor-id="considerations">Considerations</h4>
<ul>
<li><strong>Freshness:</strong> Keeping fine-tuned models up-to-date with changing data can be challenging.</li>
<li><strong>Metadata Filtering:</strong> RAG allows for flexible filtering based on document metadata, which might not be easily replicated with fine-tuning alone.</li>
</ul>
</section>
<section id="recommendations" class="level4">
<h4 class="anchored" data-anchor-id="recommendations">Recommendations</h4>
<ul>
<li>Start with a baseline RAG system using pre-trained models.</li>
<li>Identify performance bottlenecks and target fine-tuning efforts accordingly.</li>
<li>Consider joint fine-tuning of multiple components for optimal results.</li>
</ul>
</section>
</section>
<section id="catastrophic-forgetting-with-lora-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="catastrophic-forgetting-with-lora-fine-tuning">Catastrophic Forgetting with LoRA Fine-Tuning</h3>
<ul>
<li>Still possible, even with LoRA, if the LoRA’s output leads to model collapse (e.g., producing NaNs or zeros).</li>
<li>Less prevalent with LoRA compared to full fine-tuning.
<ul>
<li>Learns less, forgets less</li>
</ul></li>
<li>LoRA is better suited for structuring outputs and narrow tasks, where catastrophic forgetting is less likely.</li>
</ul>
<section id="lora-fine-tuning-benefits" class="level4">
<h4 class="anchored" data-anchor-id="lora-fine-tuning-benefits">LoRA Fine-Tuning Benefits</h4>
<ul>
<li>Consistent performance improvements observed for suitable tasks.</li>
<li>Reduced risk of catastrophic forgetting compared to full fine-tuning.</li>
</ul>
</section>
</section>
<section id="multiple-loras-and-parameter-updates" class="level3">
<h3 class="anchored" data-anchor-id="multiple-loras-and-parameter-updates">Multiple LoRAs and Parameter Updates</h3>
<ul>
<li>Multiple LoRAs can update different subsets of model parameters</li>
<li>Punica project kernels modified to allow sparse segmented matrix multiplication</li>
<li>Heterogeneous setups (LoRAs targeting different layers) can be batched together</li>
</ul>
</section>
<section id="lora-rank-and-parameter-count" class="level3">
<h3 class="anchored" data-anchor-id="lora-rank-and-parameter-count">LoRA Rank and Parameter Count</h3>
<section id="rank-selection" class="level4">
<h4 class="anchored" data-anchor-id="rank-selection">Rank Selection</h4>
<ul>
<li>Experimentation with ranks from 8 to 128.</li>
<li><strong>8:</strong> Good starting point, default in some libraries.</li>
<li><strong>16:</strong> Generally provides strong performance and is widely used in the industry.</li>
<li><strong>64:</strong> Performance tends to plateau or decline beyond this rank.</li>
<li><strong>LoRA Alpha:</strong> Consider adjusting this parameter, which controls the contribution of base model weights, when using higher ranks.</li>
</ul>
</section>
<section id="parameter-scaling" class="level4">
<h4 class="anchored" data-anchor-id="parameter-scaling">Parameter Scaling</h4>
<ul>
<li>Primarily scales with the LoRA rank, not the training data size.</li>
<li>2x increase in rank results in a 2x increase in trainable parameters.</li>
<li>Increasing rank beyond a certain point leads to diminishing returns and increased training costs.</li>
</ul>
</section>
<section id="layer-targeting" class="level4">
<h4 class="anchored" data-anchor-id="layer-targeting">Layer Targeting</h4>
<ul>
<li>Explore targeting specific layers for LoRA application beyond the default QKV or QV layers.</li>
<li><strong>Generative Use Cases:</strong> Targeting all linear layers, embedding, and LM head can be beneficial.</li>
</ul>
</section>
</section>
<section id="fine-tuning-for-question-answering-and-verbatim-quoting" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning-for-question-answering-and-verbatim-quoting">Fine-Tuning for Question Answering and Verbatim Quoting</h3>
<section id="scenario-1" class="level4">
<h4 class="anchored" data-anchor-id="scenario-1">Scenario</h4>
<ul>
<li>Fine-tuning a model on a corpus of books for question answering and verbatim quoting.</li>
</ul>
</section>
<section id="recommendations-1" class="level4">
<h4 class="anchored" data-anchor-id="recommendations-1">Recommendations</h4>
<ul>
<li><strong>RAG for Verbatim Quoting:</strong> Use RAG to retrieve and cite specific passages from the books verbatim.</li>
<li><strong>Fine-Tuning for Question Answering:</strong> Fine-tune the model to improve its ability to answer questions based on the corpus.</li>
<li><strong>Hybrid Approach:</strong> Combine RAG and fine-tuning to leverage the strengths of both approaches.</li>
</ul>
</section>
</section>
<section id="fine-tuning-for-function-calling-lora-per-function-type-vs.-multi-skill-lora" class="level3">
<h3 class="anchored" data-anchor-id="fine-tuning-for-function-calling-lora-per-function-type-vs.-multi-skill-lora">Fine-Tuning for Function Calling: LoRA per Function Type vs.&nbsp;Multi-Skill LoRA</h3>
<section id="recommendation-1" class="level4">
<h4 class="anchored" data-anchor-id="recommendation-1">Recommendation</h4>
<ul>
<li>Use a LoRA per function type if the function type can be determined at request time.
<ul>
<li>Leverages the principle of narrower tasks leading to better fine-tuning performance.</li>
</ul></li>
<li>If function type is unknown beforehand, consider a multi-skill LoRA or explore alternative approaches.</li>
</ul>
</section>
<section id="granularity" class="level4">
<h4 class="anchored" data-anchor-id="granularity">Granularity</h4>
<ul>
<li>Determine the appropriate level of granularity for LoRA specialization based on available request metadata.</li>
</ul>
</section>
<section id="further-exploration" class="level4">
<h4 class="anchored" data-anchor-id="further-exploration">Further Exploration</h4>
<ul>
<li>Attend the upcoming session on fine-tuning for function calling for more in-depth insights and recommendations.</li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>notes</category>
  <category>llms</category>
  <guid>https://christianjmills.com/posts/mastering-llms-course-notes/office-hours-008/</guid>
  <pubDate>Thu, 29 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Conference Talk 18: Fine-Tuning OpenAI Models - Best Practices</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-018/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<section id="what-is-fine-tuning-when-to-use-it" class="level3">
<h3 class="anchored" data-anchor-id="what-is-fine-tuning-when-to-use-it">What is fine-tuning? When to use it?</h3>
<ul>
<li><strong>What is fine-tuning?</strong>
<ul>
<li>Training a model to follow a set of input-output examples.</li>
<li>Teaching the model to output specific responses for given inputs.</li>
</ul></li>
<li><strong>When to use fine-tuning?</strong>
<ul>
<li><strong>Following a specific format or tone:</strong> e.g., writing in a consistent style.</li>
<li><strong>Processing input in a particular way:</strong> e.g., extracting specific information from text.</li>
<li><strong>Following complex instructions:</strong> When the base model struggles with specific instructions.</li>
<li><strong>Improving latency (speed) and reducing token usage (cost):</strong> Compared to multi-shot prompting, fine-tuning can be faster and cheaper.</li>
</ul></li>
<li><strong>When NOT to use fine-tuning?</strong>
<ul>
<li><strong>Teaching the model new knowledge:</strong> Fine-tuning is not effective for adding new information to the model’s knowledge base. Use RAG (Retrieval Augmented Generation) or custom models for this purpose.</li>
<li><strong>Performing multiple, unrelated tasks:</strong> A single fine-tuned model is best suited for one task. Create separate models for different tasks or use prompt engineering.</li>
<li><strong>Including up-to-date information:</strong> Fine-tuning is not suitable for incorporating real-time or constantly changing data.</li>
</ul></li>
</ul>
</section>
<section id="custom-models-and-real-world-fine-tuning-examples" class="level3">
<h3 class="anchored" data-anchor-id="custom-models-and-real-world-fine-tuning-examples">Custom Models and Real-World Fine-tuning Examples</h3>
<ul>
<li><strong>Question:</strong> What are “custom models”?
<ul>
<li><strong>Answer:</strong>
<ul>
<li><strong>Custom models</strong> involve a deeper level of collaboration with OpenAI.</li>
<li>OpenAI works with select partners to train and refine models using large datasets over several months.</li>
<li><strong>Example:</strong> OpenAI collaborated with Harvey, a legal tech company, to create a model trained on case law. This model excels in legal tasks and significantly reduces hallucinations compared to the base GPT model.
<ul>
<li><strong>Blog Post:</strong> <a href="https://openai.com/index/harvey/">Harvey</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Question:</strong> Are there detailed examples of fine-tuning for real-world use cases, including training data and prompts?
<ul>
<li><strong>Answer:</strong>
<ul>
<li>OpenAI’s cookbook (<a href="https://cookbook.openai.com/">cookbook.openai.com</a>) offers a Q&amp;A model example.
<ul>
<li>The model is trained to respond with “I don’t know” when it lacks relevant knowledge.</li>
<li>This example demonstrates how fine-tuning can improve a model’s ability to recognize its limitations.</li>
<li><strong>GitHub Repository:</strong> <a href="examples/fine-tuned_qa">examples/fine-tuned_qa</a></li>
<li><strong>Notebook 1:</strong> <a href="https://cookbook.openai.com/examples/fine-tuned_qa/olympics-1-collect-data">Fine-Tuned Q&amp;A - collect data</a></li>
<li><strong>Notebook 2:</strong> <a href="https://cookbook.openai.com/examples/fine-tuned_qa/olympics-2-create-qa">Fine-Tuned Q&amp;A - create Q&amp;A</a></li>
<li><strong>Notebook 3:</strong> <a href="https://cookbook.openai.com/examples/fine-tuned_qa/olympics-3-train-qa">Fine-Tuned Q&amp;A - train</a></li>
</ul></li>
<li>The “<a href="https://platform.openai.com/docs/guides/optimizing-llm-accuracy">Optimizing LLMs for Accuracy</a>” guide on the OpenAI developer site provides a helpful framework for deciding when to use fine-tuning, RAG, or both.
<ul>
<li>The guide includes a chart illustrating different approaches based on the need for adding context versus optimizing responses.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="a-combined-approach" class="level3">
<h3 class="anchored" data-anchor-id="a-combined-approach">A Combined Approach</h3>
<ul>
<li><strong>Question:</strong> What does it mean to combine fine-tuning and RAG, as shown in the upper-right quadrant of the “Optimizing LLMs” chart?
<ul>
<li><strong>Answer:</strong>
<ul>
<li>The chart depicts a general progression, but specific applications may not require all steps.</li>
<li>Combining fine-tuning and RAG involves:
<ul>
<li>Using RAG to introduce new knowledge or context.</li>
<li>Using fine-tuning to modify the model’s response style or instruction-following capabilities.</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="importance-of-evals-evaluation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="importance-of-evals-evaluation-metrics">Importance of Evals (Evaluation Metrics)</h3>
<ul>
<li><strong>Key Takeaway:</strong> Define your own set of <strong>evals</strong> (evaluation metrics) tailored to your application’s specific needs.</li>
<li><strong>Why not use standard benchmarks?</strong>
<ul>
<li>Standard benchmarks might not accurately reflect your application’s requirements.</li>
</ul></li>
<li><strong>Best Practice:</strong> Create evals based on real prompts and desired responses from your application.</li>
</ul>
</section>
<section id="a-cautionary-tale-when-fine-tuning-goes-wrong" class="level3">
<h3 class="anchored" data-anchor-id="a-cautionary-tale-when-fine-tuning-goes-wrong">A Cautionary Tale: When Fine-tuning Goes Wrong</h3>
<ul>
<li><strong>Example:</strong> A company tried to create a Slack bot using fine-tuning on their entire Slack corpus.
<ul>
<li><strong>Goal:</strong> The bot was intended to answer onboarding questions from new employees.</li>
<li><strong>Problem:</strong> The model learned the format of Slack responses but not the underlying information.
<ul>
<li>It often responded with deferrals like “I’ll do that tomorrow” or “Okay.”</li>
</ul></li>
<li><strong>Reason for Failure:</strong>
<ul>
<li>The model focused on replicating common responses instead of understanding the content.</li>
<li>This approach violated the principle of not using fine-tuning to add new knowledge.</li>
</ul></li>
<li><strong>Better Approach:</strong> Using RAG on the Slack data to provide the model with relevant information.</li>
</ul></li>
</ul>
</section>
<section id="preparing-data-for-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="preparing-data-for-fine-tuning">Preparing Data for Fine-tuning</h3>
<ul>
<li><strong>Data Format:</strong>
<ul>
<li>Similar to the chat completions API, using system, user, and assistant messages.</li>
<li>Include the desired assistant response for each user message.</li>
<li><strong>Documentation:</strong> <a href="https://platform.openai.com/docs/api-reference/fine-tuning/chat-input">Training format for chat models</a></li>
<li><strong>Documentation:</strong> <a href="https://platform.openai.com/docs/api-reference/fine-tuning/completions-input">Training format for completion models</a></li>
</ul></li>
<li><strong>Recommendations:</strong>
<ul>
<li><strong>Number of Examples:</strong> 50-100 examples per task.</li>
<li><strong>Focus on a Single Task:</strong> Use a single fine-tuned model for one specific task.</li>
<li><strong>Consistency in Prompt Structure:</strong> Maintain consistency between the prompt structure used in fine-tuning and in actual application calls.</li>
</ul></li>
</ul>
</section>
<section id="handling-multi-turn-conversations-and-internal-thoughts" class="level3">
<h3 class="anchored" data-anchor-id="handling-multi-turn-conversations-and-internal-thoughts">Handling Multi-Turn Conversations and Internal Thoughts</h3>
<ul>
<li><strong>Question:</strong> How to handle multi-turn conversations with RAG, function calling, and internal thoughts (generated by tools like Langchain) during fine-tuning data preparation? Should all internal thoughts be included, even if they are not always present in production?
<ul>
<li><strong>Answer:</strong>
<ul>
<li>Experiment with the <strong>weight parameter</strong> to control which parts of the conversation the model should focus on learning.</li>
<li>The weight parameter allows you to assign different levels of importance to different messages in the training data.</li>
<li><strong>General Advice:</strong>
<ul>
<li>Avoid excessive complexity in fine-tuning. If multi-turn conversations prove too complex, consider simplifying or using alternative approaches.</li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Follow-up Question:</strong> Is a weight parameter of 0 equivalent to setting the label of those tokens to -100 (effectively ignoring them)?
<ul>
<li><strong>Answer:</strong>
<ul>
<li>A weight of 0 means the model won’t learn how to generate those specific messages (e.g., user and system messages).</li>
<li>However, it will still use them as context when learning how to generate other messages.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="evolution-of-the-weight-parameter-and-openais-development-process" class="level3">
<h3 class="anchored" data-anchor-id="evolution-of-the-weight-parameter-and-openais-development-process">Evolution of the Weight Parameter and OpenAI’s Development Process</h3>
<ul>
<li><strong>Observation:</strong> The introduction of the weight parameter was a significant development. However, its rollout wasn’t widely publicized.</li>
<li><strong>Question:</strong> How does OpenAI decide on new features and gather feedback? Could this process be more transparent?
<ul>
<li><strong>Answer:</strong>
<ul>
<li>OpenAI gathers feedback from various sources:
<ul>
<li>OpenAI Developer Forum</li>
<li>Direct customer interactions</li>
<li>Account managers</li>
<li>Events, conferences, and talks</li>
</ul></li>
<li>The weight parameter was a direct result of this feedback process.</li>
<li>OpenAI acknowledges the importance of a more prominent announcement for such features.</li>
<li><strong>Future Direction:</strong> OpenAI plans to continue adding models, methods, and customization options to its fine-tuning platform.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="openais-fine-tuning-best-practices-and-hyperparameters" class="level3">
<h3 class="anchored" data-anchor-id="openais-fine-tuning-best-practices-and-hyperparameters">OpenAI’s Fine-tuning Best Practices and Hyperparameters</h3>
<section id="curate-examples-carefully" class="level4">
<h4 class="anchored" data-anchor-id="curate-examples-carefully">Curate examples carefully</h4>
<ul>
<li>Datasets can be difficult to build, start small and invest intentionally. Optimize for fewer high-quality training examples.
<ul>
<li>Consider “prompt baking”, or using a basic prompt to generate your initial examples</li>
<li>If your conversations are multi-turn, ensure your examples are representative</li>
<li>Collect examples to target issues detected in evaluation</li>
<li>Consider the balance &amp; diversity of data</li>
<li>Make sure your examples contain all the information needed in the response</li>
</ul></li>
</ul>
</section>
<section id="iterate-on-hyperparameters" class="level4">
<h4 class="anchored" data-anchor-id="iterate-on-hyperparameters">Iterate on hyperparameters</h4>
<ul>
<li>Start with the defaults and adjust based on performance.
<ul>
<li>If the model does not appear to converge, increase the learning rate multiplier</li>
<li>If the model does not follow the training data as much as expected, increase the number of epochs</li>
<li>If the model becomes less diverse than expected, decrease the number of epochs by 1-2</li>
</ul></li>
</ul>
</section>
<section id="establish-a-baseline" class="level4">
<h4 class="anchored" data-anchor-id="establish-a-baseline">Establish a baseline</h4>
<ul>
<li>Often users start with a zero-shot or few-shot prompt to build a baseline evaluation before graduating to fine-tuning.</li>
</ul>
</section>
<section id="optimize-for-latency-and-token-efficiency" class="level4">
<h4 class="anchored" data-anchor-id="optimize-for-latency-and-token-efficiency">Optimize for latency and token efficiency</h4>
<ul>
<li>When using GPT-4, once you have a baseline evaluation and training examples, consider fine-tuning 3.5 to get similar performance for less cost and latency.
<ul>
<li>Experiment with reducing or removing system instructions with subsequent fine-tuned model versions.</li>
</ul></li>
</ul>
</section>
<section id="automate-your-feedback-pipeline" class="level4">
<h4 class="anchored" data-anchor-id="automate-your-feedback-pipeline">Automate your feedback pipeline</h4>
<ul>
<li>Introduce automated evaluations to highlight potential problem cases to clean up and use as training data.
<ul>
<li>Consider the G-Eval approach of using GPT-4 to perform automated testing using a scorecard.</li>
</ul></li>
</ul>
</section>
<section id="hyperparameters" class="level4">
<h4 class="anchored" data-anchor-id="hyperparameters">Hyperparameters</h4>
<ul>
<li><strong>Epochs:</strong> The number of times the training data is iterated over.
<ul>
<li>Impacts training the most.</li>
<li>Higher epochs risk overfitting, lower epochs might lead to underfitting.</li>
<li>OpenAI automatically chooses a default based on dataset size.</li>
</ul></li>
<li><strong>Batch Size and Learning Rate Multiplier:</strong> Have less impact but can be adjusted for optimization.
<ul>
<li>Larger batch sizes tend to work better for larger datasets.</li>
<li>Experiment with learning rates between <code>0.02-0.2</code>.</li>
<li>Larger learning rates often perform better with larger batch sizes</li>
</ul></li>
<li><strong>Recommendation:</strong> Start with defaults and adjust based on eval results.</li>
</ul>
</section>
</section>
<section id="success-stories-and-performance-improvements" class="level3">
<h3 class="anchored" data-anchor-id="success-stories-and-performance-improvements">Success Stories and Performance Improvements</h3>
<ul>
<li><strong>Case Study 1:</strong> Fine-tuning a larger model (GPT-4) for an Icelandic government project resulted in significant improvements in grammar correction compared to the base model and other approaches.</li>
<li><strong>Case Study 2:</strong> Fine-tuning GPT-3.5 outperformed GPT-4 with few-shot prompting in a specific task, highlighting potential cost and latency benefits.</li>
</ul>
</section>
<section id="function-calling-and-fine-tuning-considerations" class="level3">
<h3 class="anchored" data-anchor-id="function-calling-and-fine-tuning-considerations">Function Calling and Fine-tuning Considerations</h3>
<ul>
<li><strong>Use Case:</strong> Fine-tuning can improve the model’s ability to select and call the correct functions.</li>
<li><strong>Caution:</strong> When working with complex or lengthy function definitions, it might be necessary to include them in the prompt even after fine-tuning.
<ul>
<li>Unlike scenarios where fine-tuning can replace lengthy prompts, function calling might require those definitions to be present during runtime.</li>
</ul></li>
</ul>
</section>
<section id="reducing-hallucinations" class="level3">
<h3 class="anchored" data-anchor-id="reducing-hallucinations">Reducing Hallucinations</h3>
<ul>
<li><strong>Example:</strong> The Q&amp;A model in OpenAI’s cookbook demonstrates how to reduce hallucinations.
<ul>
<li><strong>Approach:</strong> The model is trained on Olympic-related questions. If the question falls outside this domain, it’s designed to respond with “I don’t know.”</li>
<li><strong>Result:</strong> Fine-tuning effectively minimizes false positives (incorrect answers) in this scenario.</li>
</ul></li>
</ul>
</section>
<section id="adoption-rate-of-fine-tuning-and-open-source-alternatives" class="level3">
<h3 class="anchored" data-anchor-id="adoption-rate-of-fine-tuning-and-open-source-alternatives">Adoption Rate of Fine-tuning and Open Source Alternatives</h3>
<ul>
<li><strong>Observation:</strong> Less than 1% of OpenAI API users utilize fine-tuning.
<ul>
<li><strong>Reason:</strong>
<ul>
<li>Fine-tuning is a more advanced technique used for optimization or when other methods are insufficient.</li>
<li>Many users find success with base models and simpler approaches.</li>
</ul></li>
</ul></li>
<li><strong>Question:</strong> What are the advantages of fine-tuning OpenAI models compared to open-source models?
<ul>
<li><strong>Answer:</strong>
<ul>
<li><strong>Advantages of OpenAI models:</strong>
<ul>
<li>Access to state-of-the-art models like GPT-4 (for select partners).</li>
<li>Advanced features like tool calling, function calling, and the assistance API.</li>
<li>Simplified deployment and infrastructure management.</li>
</ul></li>
<li><strong>Consider Open Source When:</strong>
<ul>
<li>OpenAI’s offerings don’t meet specific needs or violate terms of service.</li>
</ul></li>
</ul></li>
</ul></li>
<li><strong>Additional Insights:</strong>
<ul>
<li>OpenAI’s models, even GPT-3.5, often outperform open-source alternatives, especially for complex tasks and at scale.</li>
<li>OpenAI’s platform offers greater ease of use, especially with features like tool calling and handling API rate limits.</li>
</ul></li>
</ul>
</section>
<section id="moving-from-fine-tuning-to-newer-models" class="level3">
<h3 class="anchored" data-anchor-id="moving-from-fine-tuning-to-newer-models">Moving from Fine-tuning to Newer Models</h3>
<ul>
<li><strong>Observation:</strong> The release of more powerful base models sometimes leads users to abandon fine-tuning in favor of the improved base models.</li>
<li><strong>Factors Influencing the Decision:</strong>
<ul>
<li><strong>Performance Difference:</strong> If the new base model offers substantial improvement, switching might be preferable.</li>
<li><strong>Cost and Latency:</strong> If the performance difference is minimal, sticking with a fine-tuned 3.5 model might be more cost-effective and faster.</li>
</ul></li>
</ul>
</section>
<section id="sustainability-and-future-of-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="sustainability-and-future-of-fine-tuning">Sustainability and Future of Fine-tuning</h3>
<ul>
<li><strong>Concern:</strong> Given Google’s history of discontinuing products, is there a risk of OpenAI doing the same with fine-tuning?</li>
<li><strong>Reassurance:</strong>
<ul>
<li>OpenAI is committed to supporting applications that are successful with fine-tuning.</li>
<li>The company recognizes the investment users make in data preparation and training, and aims to avoid disruption.</li>
<li><strong>Key Takeaway:</strong> OpenAI understands the higher switching cost associated with fine-tuning and aims to provide continued support.</li>
</ul></li>
</ul>
</section>
<section id="data-ownership-and-licensing-for-fine-tuning" class="level3">
<h3 class="anchored" data-anchor-id="data-ownership-and-licensing-for-fine-tuning">Data Ownership and Licensing for Fine-tuning</h3>
<ul>
<li><strong>Question:</strong> What happens to the data used for fine-tuning in terms of IP and licensing?</li>
<li><strong>Answer:</strong>
<ul>
<li><strong>Data Privacy:</strong> OpenAI never uses customer data for training its foundation models. This is explicitly stated in their privacy policy and terms of service.</li>
<li><strong>Data Control:</strong> Users have complete control over their data’s lifecycle. They can delete it after fine-tuning or retain it for future models.</li>
</ul></li>
</ul>
</section>
<section id="language-model-agents-and-function-calling-internals" class="level3">
<h3 class="anchored" data-anchor-id="language-model-agents-and-function-calling-internals">Language Model Agents and Function Calling Internals</h3>
<ul>
<li><strong>Question:</strong> Are there any impressive examples of OpenAI being used to create successful language model agents?</li>
<li><strong>Answer:</strong>
<ul>
<li>Steven defers to another team specializing in agents and tool calling.</li>
<li><strong>Personal Interest:</strong> Steven finds the GitHub AI workspaces and their agent-like capabilities for coding tasks promising.</li>
</ul></li>
<li><strong>Question:</strong> Is there tension between the abstraction provided by higher-level services (like the assistance API) and fine-tuning, especially regarding data access and transparency?
<ul>
<li><strong>Answer:</strong>
<ul>
<li>Fine-tuned models can be used within the assistance API.</li>
<li>The assistance API primarily aids in context management and tool access, not necessarily replacing fine-tuning.</li>
</ul></li>
</ul></li>
<li><strong>Follow-up Question:</strong> If the assistance API modifies or truncates context, wouldn’t that impact fine-tuning?
<ul>
<li><strong>Answer:</strong>
<ul>
<li>Steven acknowledges the potential issue but lacks specific details about the assistance API’s internal context handling.</li>
</ul></li>
</ul></li>
<li><strong>Question:</strong> Regarding function calling, is it true that JSON schema definitions are translated into a Hyperscript-like format before processing? Can users leverage this for simpler function definitions?
<ul>
<li><strong>Answer:</strong>
<ul>
<li>Steven confirms that all inputs, including JSON schemas, are converted into OpenAI’s internal token format.</li>
<li>He can’t share specifics about the internal representation or translation process.</li>
<li><strong>General Direction:</strong> OpenAI aims to make the default function calling experience (using JSON schemas) the most effective, without requiring users to rely on workarounds or internal knowledge.</li>
</ul></li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>

 ]]></description>
  <category>notes</category>
  <category>llms</category>
  <guid>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-018/</guid>
  <pubDate>Thu, 29 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Conference Talk 17: Language Models on the Command-Line</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-017/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Presentation Resources">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Presentation Resources
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Talk Recording:</strong> <a href="https://www.youtube.com/watch?v=QUXQNi6jQ30">Language models on the command-line w/ Simon Willison</a></li>
<li><strong>Handout:</strong> <a href="https://github.com/simonw/language-models-on-the-command-line/blob/main/README.md">Language models on the command-line</a></li>
</ul>
</div>
</div>
<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<ul>
<li><strong><a href="https://simonwillison.net/">Simon Willison</a></strong>, creator of <a href="https://datasette.io/">Datasette</a>, Django co-creator, and PSF board member, presents a case for using Unix command line with LLMs.</li>
</ul>
</section>
<section id="unix-command-line-a-perfect-llm-playground" class="level3">
<h3 class="anchored" data-anchor-id="unix-command-line-a-perfect-llm-playground">Unix Command Line: A Perfect LLM Playground</h3>
<ul>
<li><strong>Unix Philosophy</strong>: Tools output information that gets piped into other tools as input.</li>
<li>LLMs function similarly: Prompt input generates responses that can be further processed.</li>
<li><strong>LLM Tool</strong>: A Python command line tool for interacting with LLMs.
<ul>
<li><strong>GitHub Repository:</strong> <a href="https://github.com/simonw/llm">https://github.com/simonw/llm</a></li>
<li><strong>Documentation:</strong> <a href="https://llm.datasette.io/en/stable/">https://llm.datasette.io/en/stable/</a></li>
</ul></li>
</ul>
</section>
<section id="installing-llm" class="level3">
<h3 class="anchored" data-anchor-id="installing-llm">Installing LLM</h3>
<ul>
<li><strong>Python Users</strong>: <code>pip install llm</code> (recommended: <code>pipx install llm</code>).</li>
<li><strong>Homebrew Users</strong>: <code>brew install llm</code>.</li>
</ul>
</section>
<section id="using-llm-with-openai" class="level3">
<h3 class="anchored" data-anchor-id="using-llm-with-openai">Using LLM with OpenAI</h3>
<ul>
<li><strong>Setting API Key</strong>:
<ul>
<li><code>llm keys set openAI &lt;your_api_key&gt;</code></li>
</ul></li>
<li><strong>Running Prompts</strong>:
<ul>
<li><code>llm "five great names for a pet pelican"</code></li>
</ul></li>
<li><strong>Saving Output</strong>:
<ul>
<li><code>llm "five great names for a pet pelican" &gt; pelicans.txt</code></li>
</ul></li>
<li><strong>Continuing Conversation</strong>:
<ul>
<li><code>llm -c "now do walruses"</code></li>
</ul></li>
<li><strong>Accessing Logs</strong>:
<ul>
<li><code>llm logs -c &lt;conversation_id&gt;</code> (e.g., to retrieve past responses)</li>
</ul></li>
<li><strong>Viewing Logs in <a href="https://datasette.io/">Datasette</a></strong>:
<ul>
<li><div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pipx</span> install datasette</span></code></pre></div></li>
<li><code>llm logs path</code> (provides path to SQLite database)</li>
<li><code>datasette "&lt;path_to_database&gt;"</code> (opens a web interface for browsing conversations).</li>
</ul></li>
<li><strong>Changing Default Model</strong>:
<ul>
<li><code>llm models default</code> (shows the current default model)</li>
<li><code>llm models default -m &lt;model_name&gt;</code> (sets a new default model, e.g., <code>chatGPT</code>).</li>
</ul></li>
</ul>
</section>
<section id="llm-plugins" class="level3">
<h3 class="anchored" data-anchor-id="llm-plugins">LLM Plugins</h3>
<ul>
<li><strong>Plugin Directory</strong>: <a href="https://llm.datasette.io/en/stable/plugins/directory.html">https://llm.datasette.io/en/stable/plugins/directory.html</a></li>
<li><strong>Plugin Types</strong>:
<ul>
<li><strong>Remote API Plugins</strong>: Connect to various LLM providers like Claude, Rekha, Perplexity, AnyScale.</li>
<li><strong>Local Model Plugins</strong>: Enable running models locally on your computer.</li>
</ul></li>
<li><strong>Installing Plugins</strong>:
<ul>
<li><code>llm install &lt;plugin_name&gt;</code> (e.g., <code>llm install llm-claude-3</code>)</li>
</ul></li>
<li><strong>Viewing Installed Plugins</strong>:
<ul>
<li><code>llm plugins</code></li>
</ul></li>
<li><strong>Using Plugin Aliases</strong>:
<ul>
<li><code>llm -m &lt;plugin_alias&gt;</code> (e.g., <code>llm -m haiku</code> to use <code>llm-claude-3-haiku</code>).</li>
</ul></li>
</ul>
</section>
<section id="llm-and-local-models" class="level3">
<h3 class="anchored" data-anchor-id="llm-and-local-models">LLM and Local Models</h3>
<ul>
<li><p><strong>Local Models</strong>: Increasingly effective and accessible through LLM plugins.</p></li>
<li><p><strong>LLM-GPT4all Plugin</strong>: Wrapper around nomic’s <a href="https://github.com/nomic-ai/gpt4all">gpt4all library</a>.</p>
<ul>
<li>Install: <code>llm install llm-gpt4all</code>.</li>
<li>List Models: <code>llm models</code> (includes installed local models).</li>
</ul></li>
<li><p><strong>Example</strong>: Running a local Mistral model:</p>
<ul>
<li><div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">llm</span> chat <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> mistral-7b-instruct-v0 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"five great names for a pet seagull, explanations"</span></span></code></pre></div></li>
</ul></li>
<li><p><strong>LLM Chat</strong>: A command for persistent chat sessions with local models, avoids repeated loading.</p>
<ul>
<li><code>llm chat -m &lt;model_name&gt;</code> (e.g., <code>llm chat -m "mistral-7b"</code>)</li>
</ul></li>
<li><p><strong>Ollama Integration</strong>:</p>
<ul>
<li><strong><a href="https://ollama.com/">Ollama</a></strong>: A desktop app for managing and running local models.</li>
<li><strong>LLM-Olama Plugin</strong>: Allows using Ollama models within LLM.
<ul>
<li>Install: <code>llm install llm-olama</code>.</li>
<li>Access Ollama models: <code>llm models</code>.</li>
</ul></li>
<li>Example: Using Mixtral through Ollama:
<ul>
<li><code>llm chat -m "mixtral-latest" "Hola en español"</code></li>
</ul></li>
</ul></li>
<li><p><strong><a href="https://github.com/Mozilla-Ocho/llamafile">LlamaFile</a></strong>:</p>
<ul>
<li><strong>Functionality</strong>: A single binary containing both the LLM and the software to run it, compatible across multiple operating systems.</li>
<li><strong>Advantages</strong>: Downloadable, self-contained, acts as an offline backup.</li>
<li><strong>Example</strong>: Running Llama-370b:
<ul>
<li>Download the LlamaFile binary.</li>
<li>Make it executable: <code>chmod +x &lt;llamafile_binary&gt;</code>.</li>
<li>Run: <code>./&lt;llamafile_binary&gt;</code> (starts a web server for interaction).</li>
</ul></li>
<li><strong>LLM-LamaFile Plugin</strong>: Allows using LlamaFile models within LLM.
<ul>
<li>Install: <code>llm install llm-llamafile</code>.</li>
<li>Access LlamaFile models: <code>llm models</code>.</li>
</ul></li>
<li><strong>Lava Model</strong>: A notable LlamaFile model, recommended for its multi-modal capabilities.</li>
</ul></li>
</ul>
</section>
<section id="command-line-scripts-with-llm" class="level3">
<h3 class="anchored" data-anchor-id="command-line-scripts-with-llm">Command Line Scripts with LLM</h3>
<ul>
<li><strong><a href="https://til.simonwillison.net/llms/claude-hacker-news-themes">HN-Summary Script</a></strong>: Summarizes Hacker News posts and conversations using a combination of:
<ul>
<li><code>curl</code> to fetch data from the Hacker News API.</li>
<li><code>jq</code> to process the JSON output.</li>
<li><code>llm</code> with a system prompt to summarize the extracted text.</li>
</ul></li>
<li><strong><a href="https://simonwillison.net/2024/Apr/8/files-to-prompt/">Files-to-Prompt Command</a></strong>: Converts multiple files into a single prompt, including filenames and content.
<ul>
<li>Example: Using LLM to suggest tests for a project:
<ul>
<li><div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">files-to-prompt</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>project_directory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">llm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"suggest tests to add to this project"</span></span></code></pre></div></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="llm-and-shotscraper-for-rag" class="level3">
<h3 class="anchored" data-anchor-id="llm-and-shotscraper-for-rag">LLM and ShotScraper for RAG</h3>
<ul>
<li><strong><a href="https://github.com/simonw/shot-scraper">ShotScraper Tool</a></strong>: A browser automation tool for taking screenshots and executing JavaScript from the command line.</li>
<li><strong>Scraping Google Search Results</strong>:
<ul>
<li>Example: Using ShotScraper and LLM to answer a question using Google search results:
<ul>
<li><div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">shot-scraper</span> javascript <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://www.google.com/search?q=nytimes+slop'</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb4-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  Array.from(</span></span>
<span id="cb4-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    document.querySelectorAll("h3"),</span></span>
<span id="cb4-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    el =&gt; ({href: el.parentNode.href, title: el.innerText})</span></span>
<span id="cb4-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  )'</span></span></code></pre></div></li>
<li><div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">shot-scraper</span> javascript <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://www.google.com/search?q=nytimes+slop'</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb5-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  () =&gt; {</span></span>
<span id="cb5-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      function findParentWithHveid(element) {</span></span>
<span id="cb5-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">          while (element &amp;&amp; !element.hasAttribute("data-hveid")) {</span></span>
<span id="cb5-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">              element = element.parentElement;</span></span>
<span id="cb5-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">          }</span></span>
<span id="cb5-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">          return element;</span></span>
<span id="cb5-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      }</span></span>
<span id="cb5-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      return Array.from(</span></span>
<span id="cb5-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">          document.querySelectorAll("h3"),</span></span>
<span id="cb5-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">          el =&gt; findParentWithHveid(el).innerText</span></span>
<span id="cb5-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      );</span></span>
<span id="cb5-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">llm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'describe slop'</span></span></code></pre></div></li>
<li>This script scrapes Google search results for “NY Times slop”, extracts relevant information using JavaScript, and pipes the results to LLM to answer the question “describe slop”.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="llm-and-embeddings" class="level3">
<h3 class="anchored" data-anchor-id="llm-and-embeddings">LLM and Embeddings</h3>
<ul>
<li><p><strong>Embeddings</strong>: Supported through plugins, both API-based and local.</p></li>
<li><p><strong>Viewing Available Embedding Models</strong>:</p>
<ul>
<li><code>llm embed models</code>.</li>
</ul></li>
<li><p><strong>Creating Embeddings</strong>:</p>
<ul>
<li><code>llm embed -m &lt;model_name&gt; "&lt;text_to_embed&gt;"</code>.</li>
</ul></li>
<li><p><strong>Storing Embeddings in SQLite</strong>:</p>
<ul>
<li><strong><code>llm embed multi</code> Command</strong>: Creates a collection of embeddings and stores them in a SQLite database.</li>
<li>Example: Creating embeddings for bookmarks in a blog database:
<ul>
<li><div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">curl</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-O</span> https://datasette.simonwillison.net/simonwillisonblog.db</span>
<span id="cb6-2">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">llm</span> embed-multi links <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> simonwillisonblog.db <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--sql</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'select id, link_url, link_title, commentary from blog_blogmark'</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb6-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> 3-small <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--store</span></span></code></pre></div></li>
<li>This command creates a collection called “links”, embeds bookmarks from the specified database, uses the “text-embedding-ada-002” model, and stores both text and embeddings in the database.</li>
</ul></li>
</ul></li>
<li><p><strong>Searching with Embeddings</strong>:</p>
<ul>
<li><strong><code>llm similar</code> Command</strong>: Finds similar items in a collection based on embedding similarity.</li>
<li>Example: Searching for bookmarks related to “things that make me angry”:
<ul>
<li><div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">llm</span> similar links <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb7-2">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> simonwillisonblog.db <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb7-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'things that make me angry'</span></span></code></pre></div></li>
</ul></li>
</ul></li>
<li><p><strong>Combining Embeddings and RAG</strong>:</p>
<ul>
<li>Example: Searching for data set plugins and summarizing the most interesting ones:
<ul>
<li><div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1">  <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">llm</span> similar <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-c</span> links <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-d</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>database_path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"datasette plugins"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">llm</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-s</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"most interesting plugins"</span></span></code></pre></div></li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="building-a-rag-system-with-llm" class="level3">
<h3 class="anchored" data-anchor-id="building-a-rag-system-with-llm">Building a RAG System with LLM</h3>
<ul>
<li><strong><code>blog-answer</code> Script</strong>: A bash script demonstrating a full RAG Q&amp;A workflow using:
<ul>
<li>Embedding search against paragraphs in a blog.</li>
<li>JQ for data processing.</li>
<li>A local LlamaFile model (or other models) for question answering.</li>
</ul></li>
<li><strong>Limitations of SQLite for Large Datasets</strong>:
<ul>
<li>Brute force search becomes inefficient for very large datasets.</li>
<li>Consider specialized vector indexes (SQLite-based or external like Pinecone) for better performance.</li>
</ul></li>
<li><strong>Future Goals</strong>:
<ul>
<li>Integrating support for external vector indexes within LLM.</li>
</ul></li>
<li><strong>Python API</strong>:
<ul>
<li><code>pip install llm</code> provides a Python API for accessing LLM functionalities.</li>
</ul></li>
</ul>
</section>
<section id="qa-highlights" class="level2">
<h2 class="anchored" data-anchor-id="qa-highlights">Q&amp;A Highlights</h2>
<section id="hugging-face-hub-models" class="level3">
<h3 class="anchored" data-anchor-id="hugging-face-hub-models">Hugging Face Hub Models</h3>
<ul>
<li><strong>No plugins currently exist for Hugging Face Hub models</strong> in LLM due to Simon’s lack of an NVIDIA GPU (required for most Hugging Face models).</li>
<li><strong>Opportunity for contribution</strong>: Anyone with an NVIDIA GPU is encouraged to write an LLM plugin for Hugging Face models.</li>
<li>Other serving technologies for Hugging Face models (e.g., vLLM) are also worth exploring.</li>
</ul>
</section>
<section id="serverless-inference" class="level3">
<h3 class="anchored" data-anchor-id="serverless-inference">Serverless Inference</h3>
<ul>
<li>LLM supports various <strong>API-based models</strong> through plugins (e.g., AnyScale, Fireworks, Open Router).</li>
<li><strong>OpenAI compatible models</strong> can be configured directly within LLM without writing plugins.</li>
<li><strong>Hugging Face Inference API</strong>: Potentially exciting opportunity for a new LLM plugin.</li>
</ul>
</section>
<section id="agentic-workflows" class="level3">
<h3 class="anchored" data-anchor-id="agentic-workflows">Agentic Workflows</h3>
<ul>
<li><strong>Not yet supported</strong> in LLM due to the lack of function calling functionality.</li>
<li><strong>Future plans</strong>: Function calling support and potential LLM agents plugin.</li>
<li><strong>Python API</strong>: Offers a way to access LLM functionalities from Python code, but the interface is still under development.</li>
</ul>
</section>
<section id="productivity-tips-from-simon-willison" class="level3">
<h3 class="anchored" data-anchor-id="productivity-tips-from-simon-willison">Productivity Tips from Simon Willison</h3>
<ul>
<li><strong>Blog Post:</strong> <a href="https://simonwillison.net/2022/Nov/26/productivity/">Coping strategies for the serial project hoarder</a></li>
<li><strong>Importance of Unit Tests and Documentation</strong>: Enables revisiting and continuing projects easily.</li>
<li><strong>Focus on Quick Projects</strong>: Leverage existing expertise to build cool things rapidly.</li>
<li><strong>GitHub Issues for Comprehensive Note-Taking</strong>: Use GitHub issues to document every step of a project, facilitating TIL writing and future reference.
<ul>
<li><strong>Example:</strong> <a href="https://github.com/simonw/public-notes/issues/1">Figure out how to serve an AWS Lambda function with a Function URL from a custom subdomain</a></li>
</ul></li>
</ul>
</section>
<section id="hardware-and-local-model-performance" class="level3">
<h3 class="anchored" data-anchor-id="hardware-and-local-model-performance">Hardware and Local Model Performance</h3>
<ul>
<li><strong>Simon’s Hardware</strong>: M2 Max with 64 GB RAM.</li>
<li><strong>Local Model Performance</strong>: Runs Mistral and other small models flawlessly, Llama-370b requires 40 GB RAM.</li>
<li><strong>Apple Silicon’s future</strong>: Potentially a powerful platform for running local models with the development of Apple’s MLX library.</li>
</ul>
</section>
<section id="running-llm-on-iphones" class="level3">
<h3 class="anchored" data-anchor-id="running-llm-on-iphones">Running LLM on iPhones</h3>
<ul>
<li><strong><a href="https://apps.apple.com/us/app/mlc-chat/id6448482937">MLC Chat App</a></strong>: Allows running Mistral directly on iPhones, enabling offline LLM access.</li>
</ul>
</section>
<section id="apples-approach-to-llms" class="level3">
<h3 class="anchored" data-anchor-id="apples-approach-to-llms">Apple’s Approach to LLMs</h3>
<ul>
<li><strong>Focused on specific features</strong>: Emphasizes using LLMs for functionalities like summarization and copy editing, avoiding the complexities of general chatbots.</li>
</ul>
</section>
<section id="value-of-running-local-llms" class="level3">
<h3 class="anchored" data-anchor-id="value-of-running-local-llms">Value of Running Local LLMs</h3>
<ul>
<li><strong>Exploration and Learning</strong>: Provides hands-on experience with different models, including less performant ones, which helps understand their strengths and weaknesses.</li>
<li><strong>Privacy</strong>: Keeps sensitive data on your local machine.</li>
<li><strong>Offline Access</strong>: Essential for situations without internet connectivity (e.g., flights, post-apocalyptic scenarios).</li>
</ul>
</section>
<section id="llm-evaluation-tool-in-development" class="level3">
<h3 class="anchored" data-anchor-id="llm-evaluation-tool-in-development">LLM Evaluation Tool (In Development)</h3>
<ul>
<li><strong>Goals</strong>:
<ul>
<li>Record evaluation results in SQLite.</li>
<li>Build an interface for comparing model responses and collecting human feedback (similar to <a href="https://lmarena.ai/">LM Arena</a>).</li>
</ul></li>
<li><strong>Advantages of SQLite</strong>:
<ul>
<li>Fast, free, universally available.</li>
<li>Works as a portable file format for sharing evaluation data.</li>
</ul></li>
</ul>
</section>
<section id="benchmarking-and-logging" class="level3">
<h3 class="anchored" data-anchor-id="benchmarking-and-logging">Benchmarking and Logging</h3>
<ul>
<li><strong>Planned Feature</strong>: Log latency, token count, and duration of LLM operations in the SQLite database.</li>
<li><strong>Challenges</strong>: Determining token counts for models that don’t provide this information.</li>
</ul>
</section>
<section id="running-llm-on-multiple-machines" class="level3">
<h3 class="anchored" data-anchor-id="running-llm-on-multiple-machines">Running LLM on Multiple Machines</h3>
<ul>
<li><strong>Solution</strong>: Leverage existing tools like <a href="https://www.ansible.com/">Ansible</a> to run LLM commands in parallel on different machines within a LAN.</li>
<li><strong>Unix Flexibility</strong>: Highlights the ability to combine LLM with other Unix tools for customized workflows and automation.</li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>notes</category>
  <category>llms</category>
  <guid>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-017/</guid>
  <pubDate>Thu, 29 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Conference Talk 16: A Deep Dive on LLM Evaluation</title>
  <dc:creator>Christian Mills</dc:creator>
  <link>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-016/</link>
  <description><![CDATA[ 




<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
This post is part of the following series:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><a href="../../../series/notes/mastering-llms-course-notes.html"><strong>Mastering LLMs Course Notes</strong></a>: My notes from the course <strong>Mastering LLMs: A Conference For Developers &amp; Data Scientists</strong> by <strong>Hamel Husain</strong> and <strong>Dan Becker</strong>.</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="Presentation Slides">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Presentation Slides
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Slides:</strong> <a href="https://docs.google.com/presentation/d/1qTaDYqLCgxkUaTfxQkN1it4tx6_jixwv9ZtsbqQgE4U/">A Deep Dive on LM Evaluation</a></li>
</ul>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li><strong>Speaker:</strong> Hailey Schoelkopf, Research Scientist at Eleuther AI</li>
<li><strong>Topic:</strong> Deep dive into the challenges and best practices of Large Language Model (LLM) evaluation.</li>
</ul>
<section id="about-the-speaker" class="level3">
<h3 class="anchored" data-anchor-id="about-the-speaker">About the Speaker</h3>
<ul>
<li><strong>Hailey Schoelkopf:</strong>
<ul>
<li>Research Scientist at Eleuther AI.</li>
<li>Maintainer of the <strong>LM Evaluation Harness</strong>, a widely used open-source library for evaluating LLMs.</li>
</ul></li>
</ul>
</section>
<section id="about-eleuther-ai" class="level3">
<h3 class="anchored" data-anchor-id="about-eleuther-ai">About Eleuther AI:</h3>
<ul>
<li><strong>Website:</strong> <a href="https://eleuther.ai/">https://eleuther.ai/</a></li>
<li><strong>Project Page:</strong> <a href="https://www.eleuther.ai/projects/large-language-model-evaluation">Evaluating LLMs</a></li>
<li><strong>Non-profit research lab</strong> known for:
<ul>
<li>Releasing open-source LLMs like GPT-J and GPT-NeoX-20B.</li>
<li>Research on:
<ul>
<li>Model Interpretability</li>
<li>Datasets</li>
<li>Distributed Training</li>
<li>LLM Evaluation</li>
</ul></li>
<li>Building and maintaining tools for the open-source AI ecosystem.</li>
</ul></li>
</ul>
</section>
<section id="lm-evaluation-harness" class="level3">
<h3 class="anchored" data-anchor-id="lm-evaluation-harness">LM Evaluation Harness</h3>
<ul>
<li><strong>GitHub Repository:</strong> <a href="https://github.com/EleutherAI/lm-evaluation-harness">https://github.com/EleutherAI/lm-evaluation-harness</a></li>
<li><strong>Purpose:</strong>
<ul>
<li>Originally created to reproduce and track the evaluations from the GPT-3 paper.</li>
<li>Evolved into a comprehensive library for evaluating LLMs.</li>
</ul></li>
<li><strong>Usage:</strong>
<ul>
<li>Widely used by researchers and practitioners.</li>
<li>Powers the backend for the OpenLLM Leaderboard.</li>
</ul></li>
</ul>
</section>
</section>
<section id="challenges-in-llm-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="challenges-in-llm-evaluation">Challenges in LLM Evaluation</h2>
<section id="scoring-difficulties" class="level4">
<h4 class="anchored" data-anchor-id="scoring-difficulties">1. Scoring Difficulties</h4>
<ul>
<li><strong>Core Issue:</strong> Reliably evaluating the correctness of LLM responses in natural language.</li>
<li><strong>Challenges:</strong>
<ul>
<li><strong>Subjectivity of Language:</strong> What constitutes a “correct” response can be subjective and context-dependent.</li>
<li><strong>Hallucination:</strong> LLMs can generate plausible-sounding but incorrect information, making it challenging to determine accuracy based on surface-level analysis.</li>
<li><strong>Lack of Standardized Metrics:</strong> Absence of universally agreed-upon metrics for evaluating LLM performance across different tasks and domains.</li>
</ul></li>
</ul>
</section>
<section id="reproducibility-issues" class="level4">
<h4 class="anchored" data-anchor-id="reproducibility-issues">2. Reproducibility Issues</h4>
<ul>
<li><strong>Importance:</strong> Ensuring that evaluation results are consistent and replicable.</li>
<li><strong>Challenges:</strong>
<ul>
<li><strong>Sensitivity to Implementation Details:</strong> LLM performance can vary significantly based on seemingly minor differences in implementation, such as tokenization, prompt formatting, and hyperparameters.</li>
<li><strong>Lack of Transparency:</strong> Limited sharing of evaluation code and detailed methodologies makes it difficult for others to reproduce results.</li>
<li><strong>Data Set Variability:</strong> Differences in data set composition and quality can lead to inconsistent evaluations.</li>
</ul></li>
</ul>
</section>
</section>
<section id="common-llm-evaluation-methods" class="level2">
<h2 class="anchored" data-anchor-id="common-llm-evaluation-methods">Common LLM Evaluation Methods</h2>
<section id="log-likelihoods-assessing-the-probability-of-expected-outputs" class="level4">
<h4 class="anchored" data-anchor-id="log-likelihoods-assessing-the-probability-of-expected-outputs">1. Log Likelihoods: Assessing the Probability of Expected Outputs</h4>
<ul>
<li><p><strong>Background:</strong></p>
<ul>
<li>LLMs output a probability distribution over vocabulary for each possible next token.</li>
<li>This distribution represents the model’s confidence in different words following the given input.</li>
</ul></li>
<li><p><strong>How It Works:</strong></p>
<ul>
<li><p><strong>Input:</strong> A prompt (X) and a potential output (Y).</p></li>
<li><p><strong>Process:</strong> Calculate the probability of the model generating Y given X. This involves summing the log probabilities of each token in Y, conditioned on the preceding tokens in X and Y.</p>
<ul>
<li><p><img src="https://latex.codecogs.com/png.latex?%0A%5Clog%20P(y%7Cx)%20=%20%5Csum_%7Bi=0%7D%5E%7Bm-1%7D%20%5Clog%20p(y_i%20%7C%20x,%20y_0,%20%5Cldots,%20y_%7Bi-1%7D)%20=%20%5Csum_%7Bi=0%7D%5E%7Bm-1%7D%20l(n+i,%20y_%7Bi%7D)%0A"></p></li>
<li><p>where <img src="https://latex.codecogs.com/png.latex?%5Clog%20p(y_i%20%7C%20x,%20y_0,%20%5Cldots,%20y_%7Bi-1%7D)"> is the log probability of the <img src="https://latex.codecogs.com/png.latex?i">-th target token conditioned on the full input <img src="https://latex.codecogs.com/png.latex?x"> and the preceding target tokens. (and where <img src="https://latex.codecogs.com/png.latex?x,%20y_0,%20%5Cldots,%20y_%7Bi-1%7D"> denotes conditioning on only <img src="https://latex.codecogs.com/png.latex?x">.).</p></li>
</ul></li>
<li><p><strong>Example:</strong> For the prompt “The cow jumped over the,” calculate the probability of the model generating “moon” versus other words.</p></li>
</ul></li>
<li><p><strong>Use Case: Multiple Choice Question Answering</strong></p>
<ul>
<li><strong>Advantages:</strong>
<ul>
<li>Computationally cheaper than generation-based evaluation.</li>
<li>Avoids issues with parsing errors in generated text.</li>
<li>Suitable for evaluating smaller LLMs or those in early training stages.</li>
</ul></li>
<li><strong>Disadvantages:</strong>
<ul>
<li>Limited real-world applicability compared to open-ended generation.</li>
<li>Doesn’t assess a model’s ability to formulate its own answers.</li>
<li>Cannot evaluate chain-of-thought reasoning.</li>
</ul></li>
</ul></li>
<li><p><strong>Challenges with Log Likelihoods and Perplexity:</strong></p>
<ul>
<li><strong>Tokenizer Sensitivity:</strong> Metrics are affected by the specific tokenizer used, making comparisons between models with different tokenizers difficult.
<ul>
<li><strong>Solution:</strong> Implement normalization techniques to account for tokenizer variations.</li>
</ul></li>
<li><strong>Limited Information:</strong> Log likelihoods only consider the probability of a given output, not its overall quality, coherence, or factual accuracy.</li>
</ul></li>
</ul>
</section>
<section id="perplexity-measuring-how-well-a-model-fits-a-data-distribution" class="level4">
<h4 class="anchored" data-anchor-id="perplexity-measuring-how-well-a-model-fits-a-data-distribution">2. Perplexity: Measuring How Well a Model Fits a Data Distribution</h4>
<ul>
<li><p><strong>Concept:</strong> Quantifies how well a language model predicts a given text, indicating its familiarity with the data distribution.</p></li>
<li><p><strong>Calculation:</strong> Based on the average per-token log probability of the text, with lower perplexity indicating a better fit to the data.</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BPPL%7D%20=%20%5Cexp%20%5Cleft(%20-%5Cfrac%7B1%7D%7B%5Csum_%7Bj=1%7D%5E%7B%7CD%7C%7D%20N_j%7D%20%5Csum_%7Bj=1%7D%5E%7B%7CD%7C%7D%20%5Csum_%7Bi=1%7D%5E%7BN_j%7D%20%5Clog%20P(y_%7Bji%7D%20%7C%20y_%7Bj1%7D,%20%5Cldots,%20y_%7Bji-1%7D)%20%5Cright)%0A"></li>
</ul></li>
<li><p><strong>Use Case:</strong> Evaluating a model’s understanding of a specific text corpus (e.g., Wikipedia).</p></li>
<li><p><strong>Limitations:</strong></p>
<ul>
<li><strong>Domain Specificity:</strong> Perplexity on one dataset (e.g., Wikipedia) may not generalize to other domains or tasks.</li>
<li><strong>Limited Insight into Downstream Performance:</strong> A low perplexity doesn’t guarantee good performance in real-world applications like chatbots or question answering.</li>
</ul></li>
</ul>
</section>
<section id="text-generation-evaluating-real-world-output-but-facing-scoring-challenges" class="level4">
<h4 class="anchored" data-anchor-id="text-generation-evaluating-real-world-output-but-facing-scoring-challenges">3. Text Generation: Evaluating Real-World Output but Facing Scoring Challenges</h4>
<ul>
<li><strong>Importance:</strong> Crucial for assessing LLMs in tasks involving text generation (e.g., chatbots, story writing).</li>
<li><strong>Challenges:</strong>
<ul>
<li><strong>Scoring Free-Form Text:</strong> Determining the correctness and quality of generated text is difficult.
<ul>
<li>Simple heuristics (e.g., keyword matching) are unreliable and prone to gaming.</li>
<li>Human evaluation is expensive and time-consuming.</li>
<li>LLM-based judges introduce their own biases and limitations.</li>
</ul></li>
<li><strong>Sensitivity to Prompt Details:</strong> Minor variations in prompts (e.g., trailing whitespace) can drastically impact results, hindering reproducibility.
<ul>
<li><strong>Example:</strong> In code generation, a trailing tab in the prompt can create syntax errors for models that generate code with specific formatting, leading to artificially lower performance scores.</li>
</ul></li>
</ul></li>
</ul>
</section>
</section>
<section id="the-need-for-reproducibility-and-best-practices" class="level2">
<h2 class="anchored" data-anchor-id="the-need-for-reproducibility-and-best-practices">The Need for Reproducibility and Best Practices</h2>
<ul>
<li><strong>Reproducibility is Crucial:</strong> Ensuring that evaluation results can be independently verified is essential for:
<ul>
<li><strong>Fair Model Comparisons:</strong> Accurately assessing the relative performance of different LLMs.</li>
<li><strong>Meaningful Progress Tracking:</strong> Tracking improvements in model development and evaluation methods.</li>
</ul></li>
<li><strong>Challenges to Reproducibility:</strong>
<ul>
<li>Lack of standardized evaluation practices and metrics.</li>
<li>Incomplete reporting of evaluation details (e.g., prompts, code, evaluation settings).</li>
</ul></li>
<li><strong>Best Practices for Reproducible LLM Evaluation:</strong>
<ul>
<li><strong>Share Evaluation Code:</strong> Publicly release code used for evaluation to allow for scrutiny and replication of results.</li>
<li><strong>Detailed Reporting:</strong> Provide comprehensive information about evaluation procedures, including:
<ul>
<li>Specific prompts and instructions given to models.</li>
<li>Data preprocessing steps and evaluation datasets used.</li>
<li>Evaluation metrics and their calculation.</li>
</ul></li>
<li><strong>Use Standardized Evaluation Frameworks:</strong> Leverage libraries like the <code>lm-evaluation-harness</code> or other tools (Helm, OpenCompass) to promote consistency and reduce implementation discrepancies.
<ul>
<li><strong><code>lm-evaluation-harness</code>:</strong> <a href="https://github.com/EleutherAI/lm-evaluation-harness">GitHub Repository</a></li>
<li><strong><code>helm</code>:</strong> <a href="https://github.com/stanford-crfm/helm">GitHub Repository</a></li>
<li><strong><code>opencompass</code>:</strong> <a href="https://github.com/open-compass/opencompass">GitHub Repository</a></li>
</ul></li>
</ul></li>
<li><strong>Distinction Between Model Evals and Downstream Evals:</strong>
<ul>
<li><strong>Model Evals (e.g., MMLU benchmark):</strong> Measure general language understanding and capabilities across diverse tasks.</li>
<li><strong>Downstream Evals:</strong> Focus on performance in a specific application or domain (e.g., chatbot for customer support).</li>
<li>Prioritize Downstream Evals whenever possible for production settings, as they directly reflect real-world performance needs.</li>
<li><strong>OpenLLM Leaderboard:</strong> <a href="https://huggingface.co/spaces/HuggingFaceH4/open_llm_leaderboard">https://huggingface.co/spaces/HuggingFaceH4/open_llm_leaderboard</a></li>
<li><strong>MMLU Benchmark:</strong> <a href="https://paperswithcode.com/dataset/mmlu">https://paperswithcode.com/dataset/mmlu</a></li>
<li><strong>HellaSwag Benchmark:</strong> <a href="https://paperswithcode.com/dataset/hellaswag">https://paperswithcode.com/dataset/hellaswag</a></li>
<li><strong>ARC Benchmark:</strong> <a href="https://paperswithcode.com/dataset/arc">https://paperswithcode.com/dataset/arc</a>
<ul>
<li>ARC focuses on generalization and multi-step reasoning, making it more challenging than benchmarks that rely heavily on memorization.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<ul>
<li><strong>Implementation Details Matter:</strong> LLMs are highly sensitive to minor variations in evaluation procedures.</li>
<li><strong>Transparency and Standardization are Key:</strong> Sharing code, detailed reporting, and using standardized frameworks are crucial for reproducible LLM evaluation.</li>
<li><strong>Prioritize Downstream Evaluations:</strong> Focus on evaluations that directly measure performance in your specific application context.</li>
<li><strong>For Further Exploration:</strong>
<ul>
<li><strong>Paper:</strong> <a href="https://arxiv.org/abs/2405.14782"><em>Lessons from the Trenches on Reproducible Evaluation of Language Models</em></a> (Eleuther AI)</li>
<li><strong>Library:</strong> <a href="https://github.com/EleutherAI/lm-evaluation-harness"><code>lm-evaluation-harness</code></a> (Eleuther AI)</li>
</ul></li>
</ul>
<section id="qa-highlights" class="level3">
<h3 class="anchored" data-anchor-id="qa-highlights">Q&amp;A Highlights:</h3>
<ul>
<li><strong>Dataset Quality:</strong> Errors or biases in benchmark datasets can significantly affect evaluation results and limit the usefulness of benchmarks.</li>
<li><strong>Overfitting to Evaluations:</strong> Repeatedly optimizing for a specific benchmark can lead to overfitting, where models excel on the benchmark but fail to generalize to other tasks or data.</li>
<li><strong>Measurement Validity:</strong> It’s essential to ensure that evaluation metrics accurately measure the desired aspects of LLM performance (e.g., factual accuracy, reasoning, coherence).</li>
<li><strong>LLMs as Judges:</strong>
<ul>
<li><strong>Benefits:</strong> LLMs can potentially automate the evaluation of tasks requiring nuanced understanding and reasoning, which are difficult to assess with simple heuristics.</li>
<li><strong>Considerations:</strong>
<ul>
<li><strong>Judge Model Selection:</strong> Carefully choose an LLM judge that possesses the necessary capabilities for the task being evaluated.</li>
<li><strong>Judge Model Limitations:</strong> Be aware of the judge model’s own biases and limitations, as these can influence the evaluation outcomes.</li>
</ul></li>
</ul></li>
<li><strong>Reliable Multiple-Choice Answers Without Additional Text:</strong>
<ul>
<li><strong>Structured Generation:</strong> Use techniques that constrain the model’s output to specific formats.</li>
<li><strong>System Prompts:</strong> Provide clear instructions to the model to only output the answer.</li>
<li><strong>Log Likelihoods:</strong> Rely on log likelihood-based multiple-choice evaluations if structured generation isn’t possible.</li>
</ul></li>
</ul>
<hr>
<div class="callout callout-style-default callout-tip callout-titled" title="About Me:">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Me:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>I’m Christian Mills, a deep learning consultant specializing in computer vision and practical AI implementations.</li>
<li>I help clients leverage cutting-edge AI technologies to solve real-world problems.</li>
<li>Learn more <a href="../../../about.html">about me</a> or reach out via email at <a href="mailto:christian@christianjmills.com">christian@christianjmills.com</a> to discuss your project.</li>
</ul>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>notes</category>
  <category>llms</category>
  <guid>https://christianjmills.com/posts/mastering-llms-course-notes/conference-talk-016/</guid>
  <pubDate>Thu, 29 Aug 2024 07:00:00 GMT</pubDate>
  <media:content url="https://christianjmills.com/images/empty.gif" medium="image" type="image/gif"/>
</item>
</channel>
</rss>
